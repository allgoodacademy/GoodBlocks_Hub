<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoodBlock: Digital Decisions Challenge</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Font Awesome for universal icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* Allgood Academy Brand Colors and Typography */
        :root {
            --brand-primary: #D34716; /* Burnt Orange (Buttons/Progress) */
            --brand-secondary: #357889; /* Deep Cyan (Header BG) */
            --text-primary: #4C4C4C; /* Dark Gray */
            --text-secondary: #757575; /* Medium Gray */
            --bg-light: #F7F7F7; /* Very Light Gray (Outer Background) */
            --brand-hover-light: #EB8D69;
        }

        /* Base Typography */
        h1, h2, h3 { font-family: Georgia, ui-serif, Cambria, "Times New Roman", Times, serif; }
        body, p, li, a, button { font-family: Verdana, Geneva, Tahoma, sans-serif; }
        
        body {
            background-color: var(--bg-light); /* Outer background */
            color: var(--text-primary);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
            overflow-x: hidden;
            overflow-y: auto;
            /* ADDED: Force sharper font rendering */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }

        /* --- MOBILE PHONE FRAME STYLES (PORTRAIT MODE DEFAULT) --- */
        #mobile-frame {
            /* Fixed dimensions to simulate a phone */
            max-width: 400px; 
            width: 100%; 
            height: 95vh; /* CHANGED: Was 700px. Now responsive to viewport height. */
            max-height: 700px; /* ADDED: But never taller than 700px. */
            /* Styling for the phone "bezel" */
            background-color: #000000;
            border: 10px solid #222; 
            border-radius: 40px; 
            box-shadow: 
                0 20px 50px rgba(0, 0, 0, 0.5),
                0 0 16px 4px rgba(211, 71, 22, 0.45); /* Subtle brand glow on frame */
            position: relative;
            overflow: hidden;
            transition: all 0.6s ease; /* Transition time for width/height swap */
            perspective: 1000px; /* Crucial for 3D effect */
        }

        /* --- LANDSCAPE MODE STYLES: Swap dimensions and change inner layout --- */
        @media (min-width: 768px) {
             #mobile-frame.landscape-mode {
                width: 700px; /* New width is old height */
                height: 400px; /* New height is old width */
                max-width: none;
            }
        }
        
        /* --- 3D FLIPPER STYLES --- */
        #phone-flipper {
            width: 100%;
            height: 100%;
            position: relative;
            transition: transform 0.6s; /* Rotation speed */
            transform-style: preserve-3d; /* Key for children to exist in 3D space */
        }
        /* FIX 3: ADDED - Necessary for children of the tile to exist in 3D space for the flip */
        .preserve-3d { 
            transform-style: preserve-3d;
        }

        /* Rotation class to be applied by JS */
        #phone-flipper.rotated {
            transform: rotateY(180deg);
        }

        /* Front and Back faces styles - MUST be absolute and hide backface */
        #phone-screen, #back-plate {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden; /* Hide the back of the element when facing away */
            border-radius: 30px; /* Inherit border-radius from #phone-screen */
        }

        /* Front Face (The App Screen) */
        #phone-screen {
            background-color: white; /* Inner screen background */
            display: flex;
            flex-direction: column; /* Default: Portrait Stack */
            overflow-y: auto;
            overflow-x: hidden;
            transform: rotateY(0deg); /* Default facing forward */
        }
        
        #phone-screen.landscape-mode {
            flex-direction: row; /* Switch to horizontal flow */
        }

        /* Back Plate (The Metallic Logo) */
        #back-plate {
            /* Metallic/Dark Aesthetic */
            background-color: #222; 
            background: linear-gradient(135deg, #444, #222, #444);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            transform: rotateY(180deg); /* Initial state is flipped away */
            
            /* Ensure inner content scrolls when dimensions are swapped */
            overflow-y: auto; 
            overflow-x: hidden;
        }
        #back-plate h2 {
            font-size: 3rem; 
            font-weight: bold;
            letter-spacing: 0.5rem;
            color: var(--brand-primary); /* Burnt Orange for the logo */
            text-shadow: 0 0 10px rgba(211, 71, 22, 0.5); /* Subtle glow */
        }
        
        /* --- LANDSCAPE SIDEBAR STYLING --- */
        /* Hide landscape sidebar by default */
        #landscape-sidebar { display: none; }

        /* Show sidebar in landscape mode and define its look */
        #phone-screen.landscape-mode #landscape-sidebar {
            display: flex !important; /* Override hidden */
            height: 100%;
            width: 80px; /* Fixed width for the sidebar */
            flex-shrink: 0;
            background-color: var(--brand-secondary); /* Deep Cyan */
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }

        #landscape-sidebar-progress {
            height: 70%; 
            width: 8px; 
            background-color: #5d92a1; /* Lighter Deep Cyan for track */
            border-radius: 4px;
            position: relative;
            margin-top: 1rem;
            margin-bottom: 1rem;
        }

        #landscape-sidebar-fill {
            width: 100%;
            background-color: var(--brand-primary); /* Burnt Orange fill */
            position: absolute;
            bottom: 0; /* Fills from the bottom */
            transition: height 0.3s ease;
            border-radius: 4px;
        }

        .sidebar-nav-btn {
            background-color: rgba(255, 255, 255, 0.2); /* Semi-transparent white on Deep Cyan */
            color: white;
            transition: background-color 0.2s;
        }
        .sidebar-nav-btn:hover {
            background-color: rgba(255, 255, 255, 0.4);
        }


        /* --- ELEMENT VISIBILITY CONTROL --- */

        /* Hide portrait elements when in landscape mode */
        #phone-screen.landscape-mode header,
        #phone-screen.landscape-mode .p-3.border-b, /* Progress bar container */
        #phone-screen.landscape-mode #navigation-strip,
        #phone-screen.landscape-mode footer {
            display: none !important;
        }

        /* Adjust main content in landscape mode */
        #phone-screen.landscape-mode main {
             /* Remove vertical padding, keep horizontal for scrollable content */
            padding: 0.5rem 1rem 0.5rem 1rem; 
            width: 100%;
            height: 100%;
        }


        /* --- ALLGOOD ACADEMY BRAND STYLES (Inner App) --- */
        /* Georgia for authority and professionalism (Headlines) */
        .font-georgia {
            font-family: Georgia, ui-serif, Cambria, "Times New Roman", Times, serif;
        }
        
        .btn-primary {
            background-color: var(--brand-primary);
            color: white;
            transition: all 0.2s ease-in-out;
            opacity: 1; /* Reset for non-disabled state */
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #A03810; /* Darker Orange */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-primary:disabled {
            background-color: #F2DDCB; /* Disabled brand color */
            cursor: not-allowed;
            opacity: 0.6;
        }
        .btn-secondary {
            background-color: white;
            color: var(--text-primary);
            border: 1px solid var(--brand-primary);
            transition: all 0.2s ease-in-out;
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: #f3f4f6;
        }
        .btn-secondary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        #progress-bar {
            height: 8px; /* Slightly smaller for mobile */
            background-color: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }
        #progress-bar-fill {
            height: 100%;
            background-color: var(--brand-primary);
            transition: width 0.3s ease;
        }
        
        /* Custom card styling for content highlights */
        .goodblock-card {
            background-color: #ffffff;
            border-left: 5px solid var(--brand-secondary);
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); 
            cursor: default; 
        }
        .goodblock-card.primary {
            border-left: 5px solid var(--brand-primary); 
        }
        
        /* Style for header icons (White on Deep Cyan BG) */
        .header-icon-btn {
            background-color: transparent;
            border: 1px solid #ffffff;
            transition: all 0.2s ease;
        }
        .header-icon-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        .header-icon-btn i {
            color: #ffffff;
        }

        /* --- CHALLENGE SPECIFIC STYLES --- */

        .challenge-choice-btn {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            transition: all 0.15s ease;
        }
        .challenge-choice-btn:hover:not(:disabled) {
            background-color: #f3f4f6;
            border-color: var(--brand-secondary);
        }

        .choice-most-effective {
            background-color: #d1fae5 !important; /* Light Green */
            border-color: #10b981 !important;
            font-weight: bold;
        }
        .choice-less-effective {
            background-color: #fff9e6 !important; /* Light Yellow */
            border-color: #f59e0b !important;
            font-weight: 500;
        }
        .choice-least-effective {
            background-color: #fee2e2 !important; /* Light Red */
            border-color: #f87171 !important;
            opacity: 0.6;
            font-weight: 500;
        }
        .feedback-most-effective { color: #10b981; }
        .feedback-less-effective { color: #f59e0b; }
        .feedback-least-effective { color: #f87171; }

        /* Responsive Fallback (for very small screens, make it full-width/height) */
        @media (max-width: 420px) {
            #mobile-frame {
                width: 100%;
                height: 100vh;
                border-radius: 0;
                border: none;
                box-shadow: none;
            }
            #phone-screen {
                border-radius: 0;
            }
        }

        /* Details/Summary styling for the collapsible rules */
        details summary {
            cursor: pointer;
            padding: 0.75rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
            border-bottom: 1px solid #e5e7eb;
            font-weight: bold;
            color: var(--brand-primary);
        }
        details summary:hover {
            background-color: #fef3f2; /* Light hover effect */
        }
        details[open] summary {
            background-color: #ffeae6; /* Slightly darker when open */
            border-bottom: none;
        }
        details div {
            padding: 0.75rem;
            background-color: #fcfcfc;
            border-bottom-left-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
        }
    </style>
</head>
<body>

    <div id="mobile-frame">
        <!-- The Flipper Wrapper (Handles 3D Rotation) -->
        <div id="phone-flipper"> 
            
            <!-- FRONT FACE: The App Screen (#phone-screen) -->
            <div id="phone-screen">
                <!-- 
                    ==========================================================
                    NESTED MOBILE GOODBLOCK APPLICATION START
                    ========================================================== 
                -->
                <div id="course-app" class="w-full h-full flex bg-white"> 
                    
                    <!-- LANDSCAPE MODE SIDEBAR (Hidden by default) -->
                    <div id="landscape-sidebar" class="hidden flex-col items-center justify-between py-6" style="background-color: var(--brand-secondary);">
                        
                        <!-- TOP CONTROLS -->
                        <div class="flex flex-col items-center space-y-3">
                            <!-- Orientation Toggle Button (Icon Only) -->
                            <button id="landscape-sidebar-orientation" class="p-3 rounded-xl transition-colors sidebar-nav-btn" onclick="toggleOrientation()" aria-label="Toggle Landscape/Portrait" title="Switch to Landscape">
                                <i id="landscape-orientation-icon" class="fas fa-mobile-screen-button"></i>
                            </button>
                            
                            <!-- Menu Button (Icon Only) -->
                            <button id="landscape-sidebar-menu" class="p-3 rounded-xl transition-colors sidebar-nav-btn" onclick="toggleNavigationMenu()" aria-label="Open Navigation Menu">
                                <i class="fas fa-bars"></i>
                            </button>

                            <!-- Restart Button (Icon Only) -->
                            <button id="landscape-sidebar-restart" class="p-3 rounded-xl transition-colors sidebar-nav-btn hidden" onclick="restartLearnable()" aria-label="Restart GoodBlock">
                                <i class="fas fa-home"></i>
                            </button>
                        </div>

                        <!-- MIDDLE PROGRESS BAR (Vertical) -->
                        <div id="landscape-sidebar-progress" class="rounded-full overflow-hidden">
                            <div id="landscape-sidebar-fill" class="w-full" style="height: 0%;"></div>
                        </div>

                        <!-- BOTTOM NAVIGATION -->
                        <div class="flex flex-col items-center space-y-3">
                            <!-- Back Button (Icon Only) -->
                            <button id="landscape-sidebar-back" class="p-3 rounded-xl transition-colors sidebar-nav-btn opacity-0 pointer-events-none" onclick="navigate(-1)" title="Back">
                                <i class="fas fa-arrow-left"></i>
                            </button>
                            
                            <!-- Next/Start Button (Icon Only) -->
                            <button id="landscape-sidebar-next" class="p-3 rounded-xl transition-colors sidebar-nav-btn" onclick="navigate(1)" title="Start">
                                <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                    <!-- END LANDSCAPE MODE SIDEBAR -->

                    
                    <!-- Header: Uses Deep Cyan #357889 (var(--brand-secondary)) and Georgia font (PORTRAIT ONLY) -->
                    <header class="p-4 flex-shrink-0 text-white flex justify-between items-center" style="background-color: var(--brand-secondary);">
                        <!-- Skill Name Placeholder -->
                        <h1 class="text-xl font-bold tracking-tight font-georgia"><span id="header-skill-name">[Skill Name Placeholder]</span></h1>
                        
                        <!-- Global Icons (Navigation Menu, Orientation, and Restart) -->
                        <div class="flex items-center space-x-2">
                            <!-- New: Orientation Toggle Button (PORTRAIT) -->
                            <button id="orientation-button" class="p-1.5 rounded-full transition-colors header-icon-btn" onclick="toggleOrientation()" aria-label="Toggle Landscape/Portrait" title="Switch to Landscape">
                                <i id="orientation-icon" class="fas fa-mobile-screen-button fa-sm"></i>
                            </button>
                            
                            <!-- Global Navigation Menu Button (Icon) -->
                            <button id="menu-button" class="p-1.5 rounded-full transition-colors header-icon-btn" onclick="toggleNavigationMenu()" aria-label="Open Navigation Menu">
                                <i class="fas fa-bars fa-sm"></i>
                            </button>

                            <!-- Global Restart Button (Icon) -->
                            <button id="restart-button" class="p-1.5 rounded-full transition-colors hidden header-icon-btn" onclick="restartLearnable()" aria-label="Restart GoodBlock">
                                <i class="fas fa-home fa-sm"></i>
                            </button>
                        </div>
                    </header>

                    <!-- Progress Bar (PORTRAIT ONLY) -->
                    <div id="portrait-progress-bar-container" class="p-3 border-b border-gray-200 bg-gray-100 flex-shrink-0">
                        <div id="progress-bar">
                            <div id="progress-bar-fill" style="width: 0%;"></div>
                        </div>
                    </div>

                    <!-- Main Content Area: Now the scrollable area -->
                    <main class="flex-grow p-4 overflow-y-auto">
                        
                        <!-- Content Container - Dynamically updated by JS -->
                        <div id="content-container" class="transition-opacity duration-300">
                            <!-- Content will be injected here -->
                        </div>
                        
                    </main>
                    
                    <!-- NAVIGATION STRIP (Footer Buttons) (PORTRAIT ONLY) -->
                    <div id="navigation-strip" class="p-3 bg-gray-100 border-t border-gray-200 flex-shrink-0">
                        <div id="navigation-bar" class="flex justify-between">
                            <button id="back-button" class="text-sm px-4 py-2 rounded-lg font-semibold btn-secondary" onclick="navigate(-1)">Back</button>
                            <button id="next-button" class="text-sm px-4 py-2 rounded-lg font-semibold btn-primary" onclick="navigate(1)">Start</button>
                        </div>
                    </div>
                    
                    <!-- Footer: Uses Deep Cyan background, White text (PORTRAIT ONLY) -->
                    <footer class="p-2 text-center text-xs text-white flex-shrink-0" style="background-color: var(--brand-secondary);">
                        <strong class="text-white">GoodBlock</strong>. Powered by 
                        <a href="https://www.allgoodacademy.com" target="_blank" class="font-semibold transition-colors text-white hover:underline">
                            Allgood <span>Academy</span>
                        </a>.
                    </footer>

                </div>
                <!-- 
                    ==========================================================
                    NESTED MOBILE GOODBLOCK APPLICATION END
                    ========================================================== 
                -->

                <!-- Modal for general messages (Replacing alert/confirm) -->
                <div id="message-modal-overlay" class="fixed inset-0 bg-black bg-opacity-60 z-40 flex justify-center items-center hidden transition-opacity duration-300" onclick="closeMessageModal()">
                    <div id="message-modal-card" class="bg-white rounded-xl shadow-2xl p-6 m-4 max-w-xs w-full transform transition-transform duration-300 scale-90 opacity-0" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-start mb-2">
                            <h4 id="message-modal-title" class="text-lg font-bold font-georgia" style="color: var(--brand-primary);">Notification</h4>
                            <button class="text-2xl font-light text-gray-500 hover:text-red-500 transition-colors ml-4" onclick="closeMessageModal()">&times;</button>
                        </div>
                        <p id="message-modal-body" class="text-sm text-gray-700">Message content.</p>
                        <button id="message-modal-confirm" class="mt-4 w-full py-2 rounded-lg font-semibold btn-primary" onclick="closeMessageModal()">Okay</button>
                    </div>
                </div>

                <!-- Navigation Slide-in Panel/Modal -->
                <div id="navigation-modal" class="fixed inset-0 bg-black bg-opacity-70 z-40 flex justify-end items-start hidden transition-opacity duration-300" onclick="toggleNavigationMenu()">
                    <div class="w-3/4 max-w-[280px] h-full bg-white shadow-2xl p-4 overflow-y-auto transform transition-transform duration-300 translate-x-full" id="navigation-panel" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center pb-3 border-b border-gray-200" style="color: var(--text-primary);">
                            <h3 class="text-lg font-bold">Jump To Topic</h3>
                            <button class="text-3xl font-light text-gray-500 hover:text-red-500 transition-colors ml-4" onclick="toggleNavigationMenu()">&times;</button>
                        </div>
                        <div id="topic-list" class="mt-3 space-y-1">
                            <!-- Topics will be dynamically inserted here by renderNavigationMenu() -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- NEW: BACK FACE (The metallic GoodBlock Plate) -->
            <div id="back-plate">
                <h2 class="font-georgia">GoodBlock</h2>
                <p class="text-xs mt-2 text-gray-400">Powered by Allgood Academy</p>
            </div>
            
        </div>
    </div>

    <script>
        // --- 1. GLOBAL VARIABLES AND ELEMENTS ---

        let currentStep = 0;
        // CORRECTED: Total steps is 32 (0-31): 1 Intro + 30 UNIQUE Scenarios + 1 Conclusion
        const totalContentSteps = 32; 
        const totalScenarios = 30;
        const maxChallengeScore = 90; // 30 scenarios * 3 points max
        let totalChallengeScore = 0;
        let answeredScenarioIndices = {}; // To track which scenarios (1-30) have been answered

        // NEW: Badge Threshold Constant
        const badgeThreshold = 80; // Minimum score required for the badge

        const contentContainer = document.getElementById('content-container');
        
        // Portrait elements
        const backButton = document.getElementById('back-button');
        const nextButton = document.getElementById('next-button');
        const progressBarFill = document.getElementById('progress-bar-fill');
        const restartButton = document.getElementById('restart-button');
        const orientationIcon = document.getElementById('orientation-icon');
        const orientationButton = document.getElementById('orientation-button');
        
        // Landscape sidebar elements
        const mobileFrame = document.getElementById('mobile-frame');
        const phoneFlipper = document.getElementById('phone-flipper');
        const lSidebarOrientationButton = document.getElementById('landscape-sidebar-orientation');
        const lSidebarOrientationIcon = document.getElementById('landscape-orientation-icon');
        const lSidebarRestartButton = document.getElementById('landscape-sidebar-restart');
        const lSidebarProgressBarFill = document.getElementById('landscape-sidebar-fill');
        const lSidebarBackButton = document.getElementById('landscape-sidebar-back');
        const lSidebarNextButton = document.getElementById('landscape-sidebar-next');
        const courseApp = document.getElementById('course-app'); 

        // UPDATED CONFIGURATION (Digital Decisions Challenge)
        const goodBlockConfig = {
            topicName: "Digital Decisions Challenge",
            skillName: "The Digital Decisions Challenge",
            objectives: "Apply the Publisher Mindset to 30 real-world scenarios.",
        };
        
        // --- 2. INTERACTIVE LOGIC AND HELPERS ---
        
        // General Message Modal functions (Replaces alert/confirm)
        function openMessageModal(title, body) {
            const modal = document.getElementById('message-modal-overlay');
            const titleEl = document.getElementById('message-modal-title');
            const bodyEl = document.getElementById('message-modal-body');
            const card = document.getElementById('message-modal-card');

            titleEl.textContent = title;
            bodyEl.innerHTML = body;
            
            modal.classList.remove('hidden');

            setTimeout(() => {
                card.classList.remove('scale-90', 'opacity-0');
            }, 10);
        }
        function closeMessageModal() {
            const modal = document.getElementById('message-modal-overlay');
            const card = document.getElementById('message-modal-card');
            
            card.classList.add('scale-90', 'opacity-0');

            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }
        window.closeMessageModal = closeMessageModal;

        /**
         * Replaces markdown italics (*...*) with HTML <em> tags and inserts a line break
         * before the example statement to ensure proper formatting and spacing.
         * @param {string} feedbackText The raw feedback text containing markdown asterisks.
         * @returns {string} Formatted HTML string.
         */
        function formatFeedback(feedbackText) {
            // Find the markdown italic pattern: *text*
            const formattedText = feedbackText.replace(/\*(.*?)\*/g, (match, p1) => {
                // p1 is the content inside the asterisks
                // Add two line breaks before the italicized example statement
                return '<br><br><em>' + p1 + '</em>';
            });
            return formattedText;
        }

        // --- CHALLENGE SCENARIO LOGIC (NEW CORE FUNCTIONALITY) ---
        
        function selectScenarioChoice(scenarioIndex, choiceIndex) {
            const stepData = courseSteps[currentStep];
            const choices = stepData.scenarios;
            const chosen = choices[choiceIndex];
            
            // Exit if already answered
            if (answeredScenarioIndices[scenarioIndex]) return;

            // 1. Determine Score and Feedback Styling
            let score = 0;
            let effectivenessClass = 'choice-least-effective';
            let feedbackClass = 'feedback-least-effective';
            
            if (chosen.effectiveness === 'most-effective') {
                score = 3;
                effectivenessClass = 'choice-most-effective';
                feedbackClass = 'feedback-most-effective';
            } else if (chosen.effectiveness === 'less-effective') {
                score = 1;
                effectivenessClass = 'choice-less-effective';
                feedbackClass = 'feedback-less-effective';
            }

            // 2. Update Global Score and Mark as Answered
            totalChallengeScore += score;
            answeredScenarioIndices[scenarioIndex] = true;

            // 3. Update UI
            const choiceButtons = document.querySelectorAll(`#scenario-${scenarioIndex} .challenge-choice-btn`);
            
            // Disable all buttons and dim unchosen
            choiceButtons.forEach((btn, index) => {
                btn.disabled = true;
                if (index !== choiceIndex) {
                    btn.classList.add('opacity-50');
                }
            });

            // Highlight the chosen button
            const chosenButton = document.getElementById(`choice-${scenarioIndex}-${choiceIndex}`);
            chosenButton.classList.add(effectivenessClass, 'shadow-lg');
            chosenButton.classList.remove('hover:bg-gray-50');

            // Apply the new formatting function here
            const formattedFeedback = formatFeedback(chosen.feedback);

            // Show Feedback and Score
            const feedbackContainer = document.getElementById(`feedback-container-${scenarioIndex}`);
            feedbackContainer.classList.remove('hidden');
            feedbackContainer.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <p class="font-bold text-sm ${feedbackClass}">
                        <i class="fas fa-check-circle mr-2"></i> Your choice was: ${chosen.effectiveness.toUpperCase()} (${score} pts)
                    </p>
                    <p class="font-bold text-xs">Total Score: ${totalChallengeScore}/${maxChallengeScore}</p>
                </div>
                <p class="text-xs text-gray-700">${formattedFeedback}</p>
            `;

            // 4. Update Navigation
            if (Object.keys(answeredScenarioIndices).length === totalScenarios) {
                // All 30 scenarios answered, enable NEXT button
                nextButton.disabled = false;
                lSidebarNextButton.disabled = false;
                // Show a brief message
                openMessageModal(
                    "Challenge Complete!",
                    `You've answered all 30 scenarios! Your current score is <strong>${totalChallengeScore} / ${maxChallengeScore}</strong>. Click 'Next' to view your final ranking.`
                );
            } else {
                // Advance the button text to Next Scenario
                const currentNextButton = mobileFrame.classList.contains('landscape-mode') ? lSidebarNextButton : nextButton;
                currentNextButton.textContent = 'Next Scenario';
                currentNextButton.title = `Next Scenario (${Object.keys(answeredScenarioIndices).length} / ${totalScenarios})`;
                currentNextButton.disabled = false;
                lSidebarNextButton.textContent = 'Next Scenario';
                lSidebarNextButton.title = `Next Scenario (${Object.keys(answeredScenarioIndices).length} / ${totalScenarios})`;
            }
            
            // Scroll to the bottom to see the feedback
            document.querySelector('main').scrollTop = document.querySelector('main').scrollHeight;
        }
        window.selectScenarioChoice = selectScenarioChoice;
        
        // --- 3. STEP RENDERER FUNCTIONS ---

        function renderIntroStep(stepData) {
            const stepContentBody = contentContainer;
            let stepBody = stepData.body;
            stepBody = stepBody.replace('{{topic}}', goodBlockConfig.topicName);
            stepBody = stepBody.replace('{{objectives}}', goodBlockConfig.objectives);
            
            // Dynamic text for the intro
            stepBody = stepBody.replace('{{totalScenarios}}', totalScenarios);
            stepBody = stepBody.replace('{{maxScore}}', maxChallengeScore);
            stepBody = stepBody.replace('{{badgeThreshold}}', badgeThreshold);
            
            stepContentBody.innerHTML = stepBody;
        }

        // NEW: Renders a single Digital Decisions Challenge Scenario
        function renderChallengeScenario(stepData) {
            const scenarioIndex = currentStep; // Step 1 corresponds to Scenario 1, etc.
            
            // Check if scenario has already been answered
            const isAnswered = answeredScenarioIndices[scenarioIndex];
            
            // 1. Build Choices
            const choicesHtml = stepData.scenarios.map((choice, choiceIndex) => {
                const buttonId = `choice-${scenarioIndex}-${choiceIndex}`;
                
                // Determine styling if already answered
                let buttonClass = 'challenge-choice-btn';
                let isDisabled = '';
                
                if (isAnswered) {
                    isDisabled = 'disabled';
                    // Find the originally chosen index (we don't store it, but we can highlight the correct one)
                    const isCorrectChoice = choice.effectiveness === 'most-effective';

                    if (isCorrectChoice) {
                        buttonClass += ' choice-most-effective';
                    } else if (choice.effectiveness === 'less-effective') {
                        buttonClass += ' choice-less-effective';
                    } else if (choice.effectiveness === 'least-effective') {
                        buttonClass += ' choice-least-effective';
                    }
                }
                
                return `
                    <button 
                        id="${buttonId}"
                        class="w-full text-left p-3 rounded-lg text-sm font-medium transition-colors ${buttonClass}"
                        onclick="selectScenarioChoice(${scenarioIndex}, ${choiceIndex})"
                        ${isDisabled}
                    >
                        ${String.fromCharCode(65 + choiceIndex)}. ${choice.choice}
                    </button>
                `;
            }).join('');
            
            // 2. Build Feedback Area (Hidden initially, or populated if already answered)
            let feedbackContent = '';
            let feedbackHidden = 'hidden';
            
            if (isAnswered) {
                feedbackHidden = '';
                // Need to find the originally chosen choice to display the feedback again
                // (Since we only store totalScore, we display the best feedback for review)
                const bestChoice = stepData.scenarios.find(c => c.effectiveness === 'most-effective');
                const score = (bestChoice.effectiveness === 'most-effective' ? 3 : (bestChoice.effectiveness === 'less-effective' ? 1 : 0));
                
                // Re-calculate the score for display (This is purely for visual review if they navigated back)
                // Note: The actual totalChallengeScore is maintained globally.
                feedbackContent = `
                    <div class="flex justify-between items-center mb-2">
                        <p class="font-bold text-sm feedback-most-effective">
                            <i class="fas fa-check-circle mr-2"></i> The BEST choice was: MOST-EFFECTIVE (3 pts)
                        </p>
                        <p class="font-bold text-xs">Score for reference: 3/3 pts</p>
                    </div>
                    <p class="text-xs text-gray-700">${formatFeedback(bestChoice.feedback)}</p>
                `;
            }
            
            // 3. Final Render
            // Note: The parent container (contentContainer) already has the <h2> wrapper.
            // We only need to inject the scenario content and choices here.
            const stepContentBody = document.getElementById('step-content-body');
            stepContentBody.innerHTML = `
                <p class="text-base text-gray-700 mb-4 font-georgia font-semibold">${stepData.title}</p>
                
                <div class="space-y-3 mb-5" id="scenario-${scenarioIndex}">
                    <p class="text-xs font-bold text-gray-500 mb-1">Select the MOST Effective response:</p>
                    ${choicesHtml}
                </div>
                
                <div id="feedback-container-${scenarioIndex}" class="p-4 rounded-lg shadow-md border mt-5 transition-all duration-300 ${feedbackHidden}">
                    ${feedbackContent}
                </div>
            `;
        }


        function renderConclusionStep(stepData) {
            const stepContentBody = document.getElementById('step-content-body');
            
            const percentage = Math.round((totalChallengeScore / maxChallengeScore) * 100);
            
            // Determine ranking and color
            let rank = "";
            let color = "";
            let message = "";

            if (percentage >= 85) {
                rank = "Digital Architect";
                color = "text-green-600";
                message = "Exceptional! You consistently demonstrated the Publisher Mindset and a deep understanding of pragmatic digital action. Your digital future is secure.";
            } else if (percentage >= 70) {
                rank = "Digital Manager";
                color = "text-yellow-600";
                message = "Solid performance. You show strong awareness but missed a few key decisions. Reviewing those 'less-effective' choices will move you to the next level.";
            } else {
                rank = "Digital Learner";
                color = "text-red-600";
                message = "Good start. You're aware of the challenges but your decision-making needs fine-tuning. Reread the feedback and try again to build a safer footprint.";
            }

            // CONDITIONAL BADGE BUTTON
            let badgeButtonHtml = '';
            if (totalChallengeScore >= badgeThreshold) {
                // CORRECTED LINK: Use the provided Google Form URL
                badgeButtonHtml = `
                    <button 
                        onclick="window.open('https://forms.gle/HLGwBEVDaJa9PzxF8', '_blank')"
                        class="mt-4 w-full py-3 rounded-xl font-bold text-lg btn-primary shadow-lg hover:shadow-xl transition-all inline-flex items-center justify-center bg-green-500 hover:bg-green-600"
                        style="background-color: #10B981; color: white;"
                    >
                        <i class="fas fa-medal mr-2"></i> Get Your Digital Decisions Badge!
                    </button>
                `;
            }

            const conclusionHtml = `
                <div class="text-center py-8">
                    <h2 class="text-xl font-bold font-georgia mb-4" style="color: var(--brand-secondary);">Challenge Complete!</h2>
                    
                    <div class="p-4 rounded-xl shadow-lg border-t-4 mb-6" style="border-color: var(--brand-primary); background-color: #fefcfb;">
                        <p class="text-sm font-semibold text-gray-700 mb-1">Your Final Decision Score:</p>
                        <p class="text-4xl font-extrabold ${color} font-georgia">${totalChallengeScore} / ${maxChallengeScore}</p>
                        <p class="text-xs text-gray-600">(${percentage}% Effectiveness)</p>
                    </div>
                    
                    <h3 class="text-lg font-bold font-georgia mb-2" style="color: var(--text-primary);">Your Ranking: <span class="${color}">${rank}</span></h3>
                    <p class="text-sm text-gray-700">${message}</p>
                    
                    ${badgeButtonHtml} 

                    <p class="mt-6 text-gray-600 font-semibold text-sm">Now, put the 4-step checklist to work in the real world.</p>
                    
                    <button 
                        onclick="restartLearnable()"
                        class="mt-6 w-full py-3 rounded-xl font-bold text-lg btn-primary shadow-lg hover:shadow-xl transition-all inline-flex items-center justify-center"
                    >
                        <i class="fas fa-redo mr-2"></i> Retake Challenge
                    </button>
                </div>
            `;
            stepContentBody.innerHTML = conclusionHtml;
        }
        window.renderConclusionStep = renderConclusionStep; // Expose for review

        // --- 4. CORE NAVIGATION FUNCTIONS (RELY ON RENDERERS ABOVE) ---

        function restartLearnable() {
            currentStep = 0;
            totalChallengeScore = 0;
            answeredScenarioIndices = {};
            renderStep();
            renderNavigationMenu();
        }
        window.restartLearnable = restartLearnable;

        function renderStep() {
            const maxSteps = courseSteps.length; 
            const lastStepIndex = maxSteps - 1; 
            const stepData = courseSteps[currentStep];
            
            const phoneScreen = document.getElementById('phone-screen');
            const isLandscape = mobileFrame.classList.contains('landscape-mode'); 
            const currentBackButton = isLandscape ? lSidebarBackButton : backButton;
            const currentNextButton = isLandscape ? lSidebarNextButton : nextButton;
            const currentNavBar = document.getElementById('navigation-bar'); 
            
            lSidebarRestartButton.classList.toggle('hidden', currentStep === 0);
            restartButton.classList.toggle('hidden', currentStep === 0);
            document.getElementById('header-skill-name').textContent = goodBlockConfig.skillName; 

            contentContainer.innerHTML = '';
            
            // CONDITIONAL WRAPPER for SCENARIOS
            if (stepData.type === 'challenge-scenario') {
                 // Use a clean step counter and inject scenario title directly inside the body.
                 contentContainer.innerHTML = `<h2 class="text-xl font-bold text-gray-800 mb-4 font-georgia">Scenario ${currentStep} of ${totalScenarios}</h2><div id="step-content-body"></div>`;
            } else if (stepData.type === 'conclusion') {
                 // Conclusion step doesn't need the step counter
                 contentContainer.innerHTML = `<div id="step-content-body"></div>`;
            }

            const stepContentBody = document.getElementById('step-content-body') || contentContainer;

            // 1. Dispatch content render based on type
            switch (stepData.type) {
                case 'intro':
                    renderIntroStep(stepData);
                    break;
                case 'challenge-scenario':
                    // Note: renderChallengeScenario now handles injecting the full prompt (stepData.title)
                    renderChallengeScenario(stepData);
                    break;
                case 'conclusion':
                    renderConclusionStep(stepData);
                    break;
                default: 
                    // Fallback for unexpected types (should not happen in this version)
                    stepContentBody.innerHTML = `<p class="text-red-600">Error: Unknown step type.</p>`;
                    break;
            }


            // 2. Update Progress Bar
            let progress = 0;
            if (currentStep > 0 && currentStep <= totalScenarios) {
                // Progress is based on the 30 scenarios (steps 1-30)
                progress = ((currentStep) / totalScenarios) * 100; 
            } else if (currentStep === lastStepIndex) {
                // Conclusion step
                progress = 100;
            }

            progressBarFill.style.width = `${progress}%`;
            lSidebarProgressBarFill.style.height = `${progress}%`;

            // 3. Update Navigation Buttons
            const updateButtonState = (button, text, title) => {
                if (!isLandscape) { button.textContent = text; }
                button.title = title;
            };

            // Common navigation cleanup
            currentBackButton.classList.remove('hidden', 'opacity-0', 'pointer-events-none');
            
            // Navigation state check
            const isScenario = stepData.type === 'challenge-scenario';
            
            if (currentStep === 0) {
                // Intro screen
                currentBackButton.classList.add('hidden');
                updateButtonState(currentNextButton, "Start Challenge", "Start Module");
                if (!isLandscape) { 
                    currentNavBar.classList.remove('justify-between');
                    currentNavBar.classList.add('justify-center'); 
                }
                currentNextButton.disabled = false;
                lSidebarNextButton.disabled = false;
            } else if (currentStep === lastStepIndex) { 
                // Conclusion screen
                updateButtonState(currentNextButton, "Restart Challenge", "Restart Module");
                updateButtonState(currentBackButton, "Review Decisions", "Back to last Scenario");
                currentNextButton.disabled = false;
                lSidebarNextButton.disabled = false;
            } else if (isScenario) {
                // Scenario screen
                const scenariosAnswered = Object.keys(answeredScenarioIndices).length;
                const isCurrentAnswered = answeredScenarioIndices[currentStep];

                if (isCurrentAnswered) {
                    // Scenario answered, ready to go to the next one
                    const nextText = scenariosAnswered === totalScenarios ? 'View Final Score' : 'Next Scenario';
                    updateButtonState(currentNextButton, nextText, nextText);
                    currentNextButton.disabled = false;
                    lSidebarNextButton.disabled = false;
                } else {
                    // Scenario not answered, disable next until choice is made
                    updateButtonState(currentNextButton, "Select an Option", "Select an Option");
                    currentNextButton.disabled = true;
                    lSidebarNextButton.disabled = true;
                }
                updateButtonState(currentBackButton, "Back", "Back");
            } else {
                // Should not hit this case, but for safety
                 updateButtonState(currentNextButton, "Next", "Next Step");
                 updateButtonState(currentBackButton, "Back", "Back");
                 currentNextButton.disabled = false;
                 lSidebarNextButton.disabled = false;
            }

            if (!isLandscape) {
                currentNavBar.classList.toggle('justify-center', currentStep === 0);
                currentNavBar.classList.toggle('justify-between', currentStep !== 0);
            }

            document.querySelector('main').scrollTop = 0; 
        }
        window.renderStep = renderStep;

        function navigate(direction) {
            const lastStepIndex = courseSteps.length - 1;

            if (currentStep === lastStepIndex && direction === 1) {
                restartLearnable();
                return;
            }
            
            const newStep = currentStep + direction;

            // Prevent skipping the last scenario
            if (newStep === lastStepIndex && Object.keys(answeredScenarioIndices).length < totalScenarios) {
                // If trying to jump to conclusion before all 30 are done, show an error.
                openMessageModal(
                    "Challenge Incomplete", 
                    `You must answer all ${totalScenarios} scenarios before viewing your final score.`
                );
                return;
            }

            if (newStep >= 0 && newStep <= lastStepIndex) {
                currentStep = newStep;
            }
            
            renderStep();
        }
        window.navigate = navigate;

        // --- 5. DATA STRUCTURES (DIGITAL DECISIONS CHALLENGE) ---
        
        // Data is restructured into a single array for the challenge
        const courseSteps = [
            // STEP 0: Welcome Screen (Type: intro)
            { 
                type: 'intro',
                title: "", 
                body: `<div class="flex flex-col items-center justify-center text-center h-full min-h-[400px]">
                        <img src="https://i.ibb.co/3yvdN59b/Horizontal-Logo.png" alt="Allgood Academy Logo" class="w-3/4 max-w-xs mb-4 mx-auto">
                        <h2 class="text-2xl font-bold font-georgia text-gray-800">
                            <span style="color: var(--brand-secondary);">Welcome to the</span> <span style="color: var(--brand-primary);">{{topic}}</span>
                        </h2>
                        <p class="mt-2 text-base text-gray-600">A challenge that helps you practice making smart, real-world choices to build a positive and powerful online presence. Learn how every click and post shapes your future.
                        
                        </p>
                        
                        <details class="mt-6 rounded-xl shadow-lg border-t-4 border-gray-200 text-left w-full max-w-sm">
                            <summary>
                                <i class="fas fa-list-check mr-2"></i> Challenge Rules & Badge Requirements
                            </summary>
                            <div class="p-4">
                                <ul class="text-sm text-gray-700 space-y-1 list-disc list-inside">
                                    <li>The challenge has <strong>{{totalScenarios}}</strong> real-world scenarios.</li>
                                    <li>Each scenario requires you to select the <strong>MOST Effective</strong> choice.</li>
                                    <li>You earn <strong>3 points</strong> for 'most-effective,' <strong>1 point</strong> for 'less-effective,' and <strong>0 points</strong> for 'least-effective.'</li>
                                    <li>Maximum possible score is <strong>{{maxScore}}</strong> points.</li>
                                    <li><strong class="text-green-600">To Earn the Badge:</strong> You must score <strong>{{badgeThreshold}} points or higher</strong>, then click the 'Earn Your Badge' button on the final screen to complete the certification form.</li>
                                </ul>
                            </div>
                        </details>
                       </div>`,
            },
            
            // --- SCENARIOS 1 - 10 ---
            { type: 'challenge-scenario', title: "Your classmate posts a picture of your group project online without getting your permission. Question: What do you do?", scenarios: [
                { choice: "Say nothing and ignore the post, hoping it will go away.", effectiveness: "less-effective", feedback: "While you're respecting their privacy, this isn't the most effective choice. A more principled person would not ignore a problem. You are missing an opportunity to help your friend who might be struggling." },
                { choice: "Post a mean comment on their picture telling them to take it down immediately.", effectiveness: "least-effective", feedback: "While you're trying to resolve the situation, this is the least-effective choice. Reacting with aggression is not respectful or effective. It damages your relationship and shows poor communication skills." },
                { choice: "Politely message them to ask them to take it down, explaining why you're uncomfortable.", effectiveness: "most-effective", feedback: "This is the most effective choice. You handled the situation with integrity and respect for your own feelings. It also demonstrates great social skills by managing the conflict directly and politely. *You could say something like: 'Hey, I saw the picture of our project that you posted, and I'm a little uncomfortable with my work being online without my permission. Could you please take it down for me?'*" }
            ]},
            { type: 'challenge-scenario', title: "You get into a heated debate with a stranger in the comments section of a social media post. Question: What do you do?", scenarios: [
                { choice: "Use an 'I' statement to express your point of view calmly and then disengage from the conversation.", effectiveness: "most-effective", feedback: "This is the most effective choice. You act as a thoughtful communicator by expressing your ideas clearly and with self-control. It shows you know when to stop and maintain your online well-being. *You could say something like: 'I can see that we have very different opinions on this topic, and I'm going to disengage from this conversation now.'*" },
                { choice: "Use personal attacks to try and win the argument.", effectiveness: "least-effective", feedback: "Using personal attacks is a sign of a poor communicator. This is the least-effective choice because it damages your online reputation and shows a lack of self-management skills." },
                { choice: "Say nothing and leave the conversation.", effectiveness: "less-effective", feedback: "While this may seem like the best option, this isn't the most effective choice. You are not being a good communicator. You should always try to express your point of view calmly and with respect, which is a key trait of a good communicator." }
            ]},
            { type: 'challenge-scenario', title: "You are applying for a job, and the company asks for your social media handles. Question: What do you do?", scenarios: [
                { choice: "You curate your social media to reflect your professional goals and then share it.", effectiveness: "most-effective", feedback: "This is the most effective choice. A curated digital footprint is a powerful professional asset, not a liability. You've thought about your personal brand and how it aligns with your career goals, showing great thinking skills." },
                { choice: "You delete all your social media accounts before giving them your handles.", effectiveness: "less-effective", feedback: "Deleting accounts can sometimes look suspicious. This isn't the most effective choice. While it's a way to avoid problems, it doesn't show that you have the thinking skills to manage your online presence responsibly." },
                { choice: "You give them all your social media handles without reviewing them.", effectiveness: "least-effective", feedback: "Giving a company access to all of your social media, including potentially inappropriate content, is risky. This is the least-effective choice because it shows a lack of awareness about how your online identity can impact your professional life." }
            ]},
            { type: 'challenge-scenario', title: "Your friend sends you a link to a 'free gift card' survey. It asks for your personal information, including your full name and address. Question: What do you do?", scenarios: [
                { choice: "Fill out the survey with your real information to get the reward.", effectiveness: "least-effective", feedback: "You gave in to a promise of a reward without considering the risks. This is the least-effective choice because a thinker would question the motives behind the offer and recognize that your personal data is more valuable than a free gift card." },
                { choice: "Delete the message and warn your friend that it might be a scam.", effectiveness: "most-effective", feedback: "This is the most effective choice. A true thinker analyzes information and recognizes potential risks. You were skeptical and used your reasoning skills to protect both yourself and your friend from a potential phishing scam. *You could say something like: 'Hey, I think that gift card link is a scam. It's asking for personal information, so you should probably delete the message.'*" },
                { choice: "Ask your friend if they have used it successfully and if it's safe.", effectiveness: "less-effective", feedback: "While you're seeking more information, this is a less-effective choice. You are trusting a single source who might not be knowledgeable. A better thinker would verify the information from a more reliable source before acting." }
            ]},
            { type: 'challenge-scenario', title: "You want to use a picture you found on Google for your school presentation. The picture is not labeled for reuse. Question: What do you do?", scenarios: [
                { choice: "Search for the original creator and ask for permission.", effectiveness: "most-effective", feedback: "This is the most effective choice. Acting with integrity means respecting intellectual property. You showed that you value the work of others by seeking proper authorization and demonstrating good research skills. *You could say something like: 'Hello, I'm working on a school presentation and would love to use your photo. Would that be okay with you? I'll be sure to give you full credit.'*" },
                { choice: "Use the image anyway since it's on the internet and easy to find.", effectiveness: "least-effective", feedback: "Just because something is online doesn't mean it is free to use without permission. This is the least-effective choice because it shows a lack of respect for the creator and their work." },
                { choice: "Use the image anyway and give credit to 'Google Images.'", effectiveness: "less-effective", feedback: "While you are attempting to give credit, this is a less-effective choice. A more principled person would put in the effort to find the true source rather than using a generic phrase. It's a key part of good digital citizenship." }
            ]},
            { type: 'challenge-scenario', title: "You see a post from your classmate making fun of another student. The comments are full of hateful remarks. Question: What do you do?", scenarios: [
                { choice: "Report the post and privately message the person being bullied to offer support.", effectiveness: "most-effective", feedback: "This is the most effective choice. You acted with empathy by not only reporting the harmful content but also reaching out to offer support. You put the well-being of your peer first and showed a commitment to a positive digital community. *You could say something like: 'Hey, I saw what happened online, and I'm really sorry. I wanted to let you know that I'm here for you if you need to talk or just get your mind off of it.'*" },
                { choice: "Like the post to fit in with your friends.", effectiveness: "least-effective", feedback: "By liking the post, you are actively supporting bullying. This is the least-effective choice because a caring person acts with integrity and stands up for others, even when it is difficult." },
                { choice: "Comment on the post, telling everyone to stop being so mean.", effectiveness: "less-effective", feedback: "While your intentions are good, this is a less-effective choice. Engaging in the comments can sometimes make the situation worse by giving the post more attention. A more caring response would address the situation privately or through official channels." }
            ]},
            { type: 'challenge-scenario', title: "You're taking an online class and your classmate posts something with a clear mistake. Question: What do you do?", scenarios: [
                { choice: "Privately message your classmate with constructive feedback and offer to help.", effectiveness: "most-effective", feedback: "This is the most effective choice. By using a private message, you act as a thoughtful communicator who is empathetic to your peer's feelings. This shows you value their learning while protecting them from public embarrassment. *You could say something like: 'Hey, I was reading your post, and I think there might be a small mistake. The date for the event was actually in 1956, not in 1965. No worries, I make mistakes all the time, but I just wanted to let you know.'*" },
                { choice: "Post a public comment correcting their mistake so everyone can learn.", effectiveness: "less-effective", feedback: "While you might want to help others, publicly correcting someone can be embarrassing and make them feel defensive. This is a less-effective choice because a better communicator would consider the social impact of their actions before posting." },
                { choice: "Say nothing and ignore the mistake.", effectiveness: "least-effective", feedback: "By saying nothing, you miss an opportunity to collaborate and help your classmate learn. This is the least-effective choice because effective communicators offer support and guidance when it is needed." }
            ]},
            { type: 'challenge-scenario', title: "You receive a friend request on social media from a person you don't know. Question: What do you do?", scenarios: [
                { choice: "Ignore the request and review your privacy settings to make sure your profile is private.", effectiveness: "most-effective", feedback: "This is the most effective choice. A responsible risk-taker is not reckless. You took a proactive step to protect your digital identity by being cautious about who you connect with and checking your security settings." },
                { choice: "Accept the request and then immediately send them a message asking who they are.", effectiveness: "least-effective", feedback: "You've already granted them access to your information, which puts you at risk. This is the least-effective choice because a risk-taker would not rush into a situation without understanding the risks first." },
                { choice: "Accept the request; the more friends you have, the more popular you seem.", effectiveness: "less-effective", feedback: "You are taking a risk with your personal information without thinking through the consequences. This is a less-effective choice because a wiser risk-taker would consider the potential negative outcomes before accepting a request from a stranger." }
            ]},
            { type: 'challenge-scenario', title: "You're scrolling through social media, and a pop-up appears, claiming your phone has a virus and you need to download a special app to fix it. Question: What do you do?", scenarios: [
                { choice: "Show it to your parents or a trusted adult to get their opinion.", effectiveness: "less-effective", feedback: "While it's good to ask for help, this is a less-effective choice. You should first try to use your own thinking and problem-solving skills. A more effective approach would be to close the pop-up and analyze the situation on your own." },
                { choice: "Close the pop-up and run a scan with your phone's built-in security software.", effectiveness: "most-effective", feedback: "This is the most effective choice. A thinker is critical of what they see online. You avoided a scam and took a logical, proactive step to ensure your device's security, showing great problem-solving skills." },
                { choice: "Immediately tap the pop-up and follow the instructions to get rid of the virus.", effectiveness: "least-effective", feedback: "You acted impulsively without analyzing the situation. This is a less-effective choice because a thinker would question an unexpected and urgent pop-up and look for other solutions." }
            ]},
            { type: 'challenge-scenario', title: "Your teacher has asked you to use a specific website for research, but you've found a different website that seems to have more information. You have never heard of this new website before. Question: What do you do?", scenarios: [
                { choice: "Use both websites and check to see if the information is the same.", effectiveness: "less-effective", feedback: "While you're attempting to verify the information, this is a less-effective choice. It's a risk to spend time on an unknown source. A more knowledgeable person would prioritize using proven, reliable sources first." },
                { choice: "Use the new website because it has more information.", effectiveness: "least-effective", feedback: "The amount of information on a website does not guarantee its quality. This is the least-effective choice because a knowledgeable person would not use an unknown source that could contain false or misleading information." },
                { choice: "Stick to the website your teacher has provided because it is a reliable source.", effectiveness: "most-effective", feedback: "This is the most effective choice. A knowledgeable person understands that reliable sources are essential. You showed you can identify a trustworthy resource, ensuring the accuracy and integrity of your work." }
            ]},
            
            // --- SCENARIOS 11 - 20 ---
            { type: 'challenge-scenario', title: "You are creating a new account and are asked to create a new password. You're eager to start using the app. Question: What do you do?", scenarios: [
                { choice: "Use the same password you use for everything else because it's easy to remember.", effectiveness: "less-effective", feedback: "While using the same password is easy, this is a less-effective choice. If one of your accounts is compromised, all of your accounts could be at risk. A more balanced person would consider the long-term risks over short-term convenience." },
                { choice: "Create a complex password with a mix of letters, numbers, and symbols that is unique to this account.", effectiveness: "most-effective", feedback: "This is the most effective choice. A balanced person understands the importance of protecting their personal information. You prioritized security over convenience, which is a key part of maintaining a healthy digital life." },
                { choice: "Use your birthdate or a simple name because it is easy to remember.", effectiveness: "least-effective", feedback: "Using easily guessable information makes you vulnerable to hackers. This is the least-effective choice because a balanced person would never use such simple information because it puts their security and privacy at great risk." }
            ]},
            { type: 'challenge-scenario', title: "You notice your friend is constantly online and seems to be neglecting their schoolwork and other responsibilities. Question: What do you do?", scenarios: [
                { choice: "Make a public post about how your friend needs to get off their phone.", effectiveness: "least-effective", feedback: "You are not showing that you are a caring person. Publicly shaming your friend can cause them to feel embarrassed and hurt. You are also not helping them with their problem. This is the least-effective choice." },
                { choice: "Use an 'I' statement to express your concern to your friend privately.", effectiveness: "most-effective", feedback: "This is the most effective choice. You are showing that you are a caring friend who is concerned about their well-being. By using a private message, you are not embarrassing them. This demonstrates empathy and good social skills. *You could say something like: 'Hey, I've noticed you've been on your phone a lot lately, and I'm a little worried about you. Is everything okay?'*" },
                { choice: "Do nothing because it's their life and their choices.", effectiveness: "less-effective", feedback: "While you are respecting their privacy, this is a less-effective choice. A caring person would not ignore the problem. You are missing an opportunity to help your friend who might be struggling." }
            ]},
            { type: 'challenge-scenario', title: "You want to share a funny meme online. You found the meme on a popular page, but you don't know who created it. Question: What do you do?", scenarios: [
                { choice: "Share the meme without a second thought.", effectiveness: "least-effective", feedback: "Sharing content without giving credit is not respectful to the creator's work. This is the least-effective choice because it shows a lack of integrity and respect for others' work. A principled person would not do this." },
                { choice: "Try to find the original creator and tag them in your post.", effectiveness: "most-effective", feedback: "This is the most effective choice. A principled person shows integrity by respecting intellectual property. By trying to find the original creator, you are giving credit where it's due, which is an important part of digital citizenship." },
                { choice: "Add 'Credit to the creator' to your post.", effectiveness: "less-effective", feedback: "While you are attempting to give credit, this is a less-effective choice. A more principled person would put in the effort to find the true source rather than using a generic phrase. It's a key part of good digital citizenship." }
            ]},
            { type: 'challenge-scenario', title: "You see a post online with a picture of a friend looking sad and a caption that says, 'Don't talk to me today.' Question: What do you do?", scenarios: [
                { choice: "Privately message them to ask if they're okay and offer to listen.", effectiveness: "most-effective", feedback: "This is the most effective choice. A caring person shows empathy and a desire to help their friends. By reaching out privately, you are respecting their feelings while showing you are there for them. *You could say something like: 'Hey, I saw your post. I'm sorry you're having a tough day. I'm here to listen if you need anything, no pressure to respond.'*" },
                { choice: "Do nothing. You don't want to bother them since they asked not to be talked to.", effectiveness: "less-effective", feedback: "While you are respecting their privacy, this is a less-effective choice. A caring person would recognize a cry for help and would not ignore a friend who might be struggling. It's important to reach out and offer support." },
                { choice: "Leave a public comment asking if they're okay and what's wrong.", effectiveness: "least-effective", feedback: "Publicly asking someone what's wrong can be embarrassing and disrespectful to their feelings. This is the least-effective choice because it shows a lack of empathy and social awareness. A more caring person would not do this." }
            ]},
            { type: 'challenge-scenario', title: "Two of your classmates in a group chat for a project start arguing about who should do what part of the project. Question: What do you do?", scenarios: [
                { choice: "Try to mediate the conflict by suggesting a compromise or a new way of dividing the work.", effectiveness: "most-effective", feedback: "This is the most effective choice. A thoughtful communicator can help resolve conflicts by suggesting a compromise or a new way of working. You used your communication skills to bring people together and find a solution. *You could say something like: 'Hey guys, let's all calm down. Why don't we try a different approach? How about we split the research first, and then we can work together on the presentation slides?'*" },
                { choice: "Say nothing and let them work it out on their own.", effectiveness: "less-effective", feedback: "Ignoring the problem can make the situation worse and could cause the project to suffer. This is a less-effective choice because it shows a lack of collaboration and effective communication. A better communicator would get involved to help." },
                { choice: "Take a side and start arguing with one of them to help your friend win.", effectiveness: "least-effective", feedback: "Taking a side and arguing with a teammate will only make the situation worse and cause more conflict. This is the least-effective choice because it shows a lack of communicator skills and is not helpful for your project." }
            ]},
            { type: 'challenge-scenario', title: "You're doing research for a history project and find a blog post with great information, but the author isn't a historian. Question: What do you do?", scenarios: [
                { choice: "Use the information anyway because it's a good source.", effectiveness: "least-effective", feedback: "You are not being a reflective person. You are using information without verifying it. This is the least-effective choice because a reflective person would always check to see if their source is reliable." },
                { choice: "Use the information but cite it as a blog post.", effectiveness: "less-effective", feedback: "While you are attempting to give credit, you are still using an untrustworthy source. This is a less-effective choice because a more reflective person would try to find a better source." },
                { choice: "Cross-reference the information with at least two other, more reliable sources (like a university website or a verified encyclopedia).", effectiveness: "most-effective", feedback: "This is the most effective choice. A reflective person is a great researcher who knows how to verify their information. You are showing that you value the accuracy of your work." }
            ]},
            { type: 'challenge-scenario', title: "You are asked to review a new learning app for school and find a minor bug. Question: What do you do?", scenarios: [
                { choice: "Privately message the developers with a detailed, constructive report of the bug.", effectiveness: "most-effective", feedback: "This is the most effective choice. You act as a thoughtful communicator who is empathetic to the developers' feelings. By providing constructive feedback, you are helping them improve their app. *You could say something like: 'I'm really enjoying the new app! I noticed a small bug: when I click on the 'Assignments' tab, it sometimes freezes. I'm using an Android phone with version 13.'*" },
                { choice: "Say nothing and hope the developers find the bug themselves.", effectiveness: "less-effective", feedback: "By saying nothing, you miss an opportunity to collaborate and help the developers. This is a less-effective choice because an effective communicator offers support and guidance when it is needed." },
                { choice: "Leave a scathing review online, detailing all the bugs you found and how terrible the app is.", effectiveness: "least-effective", feedback: "You are not being a communicator who is empathetic to the developers' feelings. Leaving a scathing review online can damage their reputation and is not constructive. This is the least-effective choice." }
            ]},
            { type: 'challenge-scenario', title: "You see a post from your classmate that makes a joke about a sensitive topic, and some people in the comments are hurt by it. Question: What do you do?", scenarios: [
                { choice: "Privately message your classmate, explaining why the post was hurtful and suggesting they take it down.", effectiveness: "most-effective", feedback: "This is the most effective choice. You are showing that you are a caring person by protecting your classmate and helping them to become a better digital citizen. This demonstrates empathy and good social skills. *You could say something like: 'Hey, I saw your post. I know you were just joking, but some people in the comments are hurt by it. Maybe it's better to take it down? I just wanted to give you a heads-up.'*" },
                { choice: "Do nothing because it's not your problem.", effectiveness: "less-effective", feedback: "By saying nothing, you are not showing that you are a caring person. You are missing an opportunity to help your classmate who might be struggling. This is a less-effective choice." },
                { choice: "Leave a comment to tell the person who made the post that they should apologize.", effectiveness: "least-effective", feedback: "While you're attempting to stand up for what is right, this is a less-effective choice. Publicly confronting them can make the situation worse. This is the least-effective choice." }
            ]},
            { type: 'challenge-scenario', title: "You are creating a profile for a new app. It asks for your real name, birthdate, and where you live. Question: What do you do?", scenarios: [
                { choice: "Provide all the requested information because it's required to create an account.", effectiveness: "least-effective", feedback: "This is the least-effective choice. Providing too much personal information can compromise your privacy and security. A thinker would be cautious with their personal data." },
                { choice: "Close the app and don't create an account.", effectiveness: "less-effective", feedback: "While it's good to be concerned about privacy, this is a less-effective choice. A more reflective person would analyze the situation and decide if they should create an account." },
                { choice: "Create an account with a fake name and birthdate to protect your privacy.", effectiveness: "most-effective", feedback: "This is the most effective choice. A thinker recognizes that some apps ask for unnecessary information and takes action to protect their identity. This shows you are a thoughtful and responsible person." }
            ]},
            { type: 'challenge-scenario', title: "You are working on a group project with a classmate. You notice they are not doing their part and are just copying and pasting from Wikipedia. Question: What do you do?", scenarios: [
                { choice: "Privately message your classmate with a constructive message to tell them that you are worried about their work and offer to help.", effectiveness: "most-effective", feedback: "This is the most effective choice. A thoughtful communicator can help resolve conflicts by suggesting a compromise or a new way of working. You used your communication skills to bring people together and find a solution. *You could say something like: 'Hey, I noticed that we're both doing a lot of the same research. Maybe we should try to divide it differently so we can work more efficiently? I'm happy to help you with the rest of your section.'*" },
                { choice: "Call them out in the group chat for being lazy and not doing their part.", effectiveness: "least-effective", feedback: "Publicly calling someone out can be embarrassing and disrespectful. This is the least-effective choice because it shows a lack of empathy and social awareness. A more effective communicator would not do this." },
                { choice: "Just do their work for them so you get a good grade.", effectiveness: "less-effective", feedback: "While you are ensuring a good grade, this is a less-effective choice. You are not being a communicator who is empathetic to your peer's feelings. You are missing an opportunity to collaborate and help your classmate learn." }
            ]},
            
            // --- SCENARIOS 21 - 30 (CORRECTED UNIQUE DATA) ---
            { type: 'challenge-scenario', title: "You are asked to create a new password for a new social media account. You are asked to create a strong password, but you just want to get to the app. Question: What do you do?", scenarios: [
                { choice: "Use a simple password that is easy to remember, like 'password123.'", effectiveness: "least-effective", feedback: "Using a simple password that is easy to remember is a risk. This is the least-effective choice because it shows a lack of self-management skills. A more balanced person would consider the risks over convenience." },
                { choice: "Use your school email as your password.", effectiveness: "less-effective", feedback: "Using your school email as a password is a risk. This is a less-effective choice because it shows a lack of thinking skills. A more balanced person would consider the risks over convenience." },
                { choice: "Create a password that is complex and unique to this account.", effectiveness: "most-effective", feedback: "This is the most effective choice. A balanced person understands the importance of protecting their personal information. You prioritized security over convenience, which is a key part of maintaining a healthy digital life." }
            ]},
            { type: 'challenge-scenario', title: "You're in a group chat for a class project, and one of your classmates posts a private message that you sent them to the group chat. Question: What do you do?", scenarios: [
                { choice: "Take a screenshot of the message and post it to social media to call out your classmate.", effectiveness: "least-effective", feedback: "Publicly shaming your classmate can cause them to feel embarrassed and hurt. This is the least-effective choice because it shows a lack of integrity. A principled person would not do this." },
                { choice: "Ask the person to delete the message and explain to them why it was wrong.", effectiveness: "most-effective", feedback: "This is the most effective choice. You acted as a thoughtful principled person who is empathetic to your own feelings. By taking a proactive step, you are protecting yourself and showing that you value your own privacy. *You could say something like: 'Hey, I'm not comfortable with my private messages being shared in the group chat. Could you please take that down?'*" },
                { choice: "Tell the teacher and ask them to remove the classmate from the group.", effectiveness: "less-effective", feedback: "While it's good to seek help, a better first step would be to try to handle the situation on your own. This is a less-effective choice because a more principled person would try to resolve the problem directly with the person who caused it." }
            ]},
            { type: 'challenge-scenario', title: "You are scrolling through social media, and a post from a friend promotes a fake charity. Question: What do you do?", scenarios: [
                { choice: "Leave a comment on the post saying that the charity is fake.", effectiveness: "less-effective", feedback: "While you're attempting to stand up for what is right, this is a less-effective choice. A more caring person would not publicly embarrass their friend. You could have helped people privately." },
                { choice: "Do nothing and ignore the post, so you don't hurt your friend's feelings.", effectiveness: "least-effective", feedback: "You are not showing that you are a caring person. By saying nothing, you are missing an opportunity to help your friend who might be struggling. This is the least-effective choice." },
                { choice: "Privately message your friend and explain to them why the charity is fake and why they should take the post down.", effectiveness: "most-effective", feedback: "This is the most effective choice. A caring person shows empathy and a desire to help their friends. By reaching out privately, you are protecting your friend and the people who might donate to the fake charity. *You could say something like: 'Hey, I saw your post about the charity, and I think it might be a scam. I found a few articles online that say it's fake, so you should probably take the post down.'*" }
            ]},
            { type: 'challenge-scenario', title: "You are completing an online survey for a product you like. It asks for your parents' names, phone numbers, and income. Question: What do you do?", scenarios: [
                { choice: "Fill out the survey with your real information to get the reward.", effectiveness: "least-effective", feedback: "You gave in to a promise of a reward without considering the risks. This is the least-effective choice because a thinker would question the motives behind the offer and recognize that your personal data is more valuable than a free gift card." },
                { choice: "Close the survey immediately and do not provide the information.", effectiveness: "most-effective", feedback: "This is the most effective choice. A thinker is critical of what they see online. You avoided a scam and took a logical, proactive step to ensure your device's security, showing great problem-solving skills." },
                { choice: "Fill out the survey with fake information.", effectiveness: "less-effective", feedback: "While you're attempting to be safe, this is a less-effective choice. You are still engaging with a potentially malicious source. A more effective thinker would simply close the survey and not engage." }
            ]},
            { type: 'challenge-scenario', title: "You're playing a multiplayer video game and another player is being very aggressive and using offensive language in the chat. Question: What do you do?", scenarios: [
                { choice: "Report the player's behavior to the platform's moderators and mute/block them.", effectiveness: "most-effective", feedback: "This is the most effective choice. A principled person acts with integrity by not supporting bullying. You are showing that you value a positive digital community and that you will not tolerate harassment. *You could say something like: 'I'm reporting this user for harassment.'*" },
                { choice: "Argue back with them and use your own insults to defend yourself.", effectiveness: "least-effective", feedback: "Engaging in a flame war will only escalate the situation. This is the least-effective choice because it shows a lack of self-control. A principled person would not do this." },
                { choice: "Say nothing and leave the game immediately.", effectiveness: "less-effective", feedback: "While leaving the game is an option, it doesn't help solve the problem for other players. This is a less-effective choice because a more principled person would try to help solve the problem." }
            ]},
            { type: 'challenge-scenario', title: "A friend posts a picture of you online that you think is unflattering. Question: What do you do?", scenarios: [
                { choice: "Politely message your friend and ask them to remove the picture, explaining how you feel.", effectiveness: "most-effective", feedback: "This is the most effective choice. You acted as a thoughtful communicator who is empathetic to your own feelings. By taking a proactive step, you are protecting yourself and showing that you value your own privacy. *You could say something like: 'Hey, could you please take down that picture of me? I'm just not a fan of how I look in it. Thanks!'*" },
                { choice: "Post a mean comment on their picture, telling them to take it down.", effectiveness: "least-effective", feedback: "You let your emotions get the best of you, which is a key trait of a poor communicator. This is the least-effective choice because it shows a lack of self-control and good social skills." },
                { choice: "Ignore it and do nothing. You don't want to make things awkward.", effectiveness: "less-effective", feedback: "By saying nothing, you miss an opportunity to collaborate and help your friend. This is a less-effective choice because a more effective communicator would offer support and guidance when it is needed." }
            ]},
            { type: 'challenge-scenario', title: "You receive a message from an unknown number. It says, 'Hey, I think I have the wrong number, but you seem cool. What's your name?' Question: What do you do?", scenarios: [
                { choice: "Block the number and don't respond.", effectiveness: "most-effective", feedback: "This is the most effective choice. A responsible risk-taker is not reckless. You took a proactive step to protect your digital identity by being cautious about who you connect with and checking your security settings." },
                { choice: "Reply and give them your name and a brief description of yourself.", effectiveness: "least-effective", feedback: "You are taking a risk with your personal information without thinking through the consequences. This is the least-effective choice because a wiser risk-taker would consider the potential negative outcomes before giving out personal information." },
                { choice: "Reply and say, 'I think you have the wrong number.'", effectiveness: "less-effective", feedback: "While you are respecting their privacy, this is a less-effective choice. A more reflective person would simply block the number and not engage." }
            ]},
            { type: 'challenge-scenario', title: "You're in a video meeting for an online class, and you see a classmate live-tweeting the lecture, making fun of the professor. Question: What do you do?", scenarios: [
                { choice: "Do nothing; it's not your business.", effectiveness: "least-effective", feedback: "By saying nothing, you miss an opportunity to help your classmate and your professor. This is the least-effective choice because a thinker would analyze the situation and try to find a solution." },
                { choice: "Screenshot the tweets and send them to the professor to get your classmate in trouble.", effectiveness: "less-effective", feedback: "While you're trying to help, this is a less-effective choice. A thinker would try to solve the problem directly with their classmate. You are also not being a good teammate." },
                { choice: "Privately message your classmate and explain why what they are doing could be disrespectful and have serious consequences.", effectiveness: "most-effective", feedback: "This is the most effective choice. A thinker understands the importance of protecting their digital identity and brand. You took a proactive step to ensure your classmate's privacy and brand. *You could say something like: 'Hey, I saw your live tweets of the lecture. I'm worried that they could be seen by the professor or the school, and I don't want you to get in trouble.'*" },
                
            ]},
            { type: 'challenge-scenario', title: "You discover someone has created a fake social media profile using a friend's name and photos to post mean things about other students. Question: What do you do?", scenarios: [
                { choice: "Report the fake account to the social media platform and then block it.", effectiveness: "less-effective", feedback: "While reporting the account is a good step, this is a less-effective choice. A more caring person would do more. You are not helping your friend who might be struggling. You are missing an opportunity to help your friend who might be struggling." },
                { choice: "Privately message your friend and offer to help them report the account and alert others.", effectiveness: "most-effective", feedback: "This is the most effective choice. A caring person shows empathy and a desire to help their friends. By reaching out privately, you are respecting their feelings while showing you are there for them. *You could say something like: 'Hey, I just saw a fake account using your name. I'm so sorry that's happening. I can help you report it and let other people know it's not you if you want.'*" },
                { choice: "Create a public post to warn everyone about the fake account and call out the person who created it.", effectiveness: "least-effective", feedback: "You are not being a caring person. Publicly calling out the person who created the account can cause more conflict and make the situation worse. A more caring person would not do this." }
            ]},
            { type: 'challenge-scenario', title: "You see a post from a friend that is promoting a charity. The post looks legitimate, but you have never heard of the charity before. Question: What do you do?", scenarios: [
                { choice: "Donate to the charity and share the post, assuming it's a good cause.", effectiveness: "least-effective", feedback: "You are not being a inquiring person. You are giving your money to a potentially malicious source. This is the least-effective choice because a inquiring person would always question the source of information." },
                { choice: "Do nothing and ignore the post.", effectiveness: "less-effective", feedback: "While you are respecting their privacy, this is a less-effective choice. You are missing an opportunity to help your friend who might be struggling. A more inquiring person would not engage with a suspicious offer." },
                { choice: "Research the charity to see if it's legitimate before donating or sharing the post.", effectiveness: "most-effective", feedback: "This is the most effective choice. A true inquirer is a great researcher who knows how to verify their information. You are showing that you value the accuracy of your work." }
            ]},

            // STEP 31: Conclusion (Type: conclusion)
            { 
                type: 'conclusion',
                title: "Challenge Complete: Your Digital Ranking", 
                scenarios: [] // Empty, as it's a custom renderer
            },
        ];


        // --- 6. ORIENTATION & INITIALIZATION ---

        function toggleOrientation() {
            const phoneScreen = document.getElementById('phone-screen');
            const mainContent = document.querySelector('main');
            
            const isCurrentlyLandscape = mobileFrame.classList.contains('landscape-mode');
            
            phoneFlipper.classList.add('rotated');
            
            const pauseDuration = 500; 
            const flipDuration = 600; 
            
            setTimeout(() => {
                mobileFrame.classList.toggle('landscape-mode', !isCurrentlyLandscape);
                
                phoneFlipper.classList.remove('rotated'); 
                
                setTimeout(() => {
                    const isNowLandscape = mobileFrame.classList.contains('landscape-mode');
                    
                    phoneScreen.classList.toggle('landscape-mode', isNowLandscape);

                    courseApp.classList.toggle('flex-col', !isNowLandscape); 
                    courseApp.classList.toggle('flex-row', isNowLandscape);  

                    const newIcon = isNowLandscape ? 'fa-mobile-screen' : 'fa-mobile-screen-button';
                    const newTitle = isNowLandscape ? 'Switch to Portrait' : 'Switch to Landscape';

                    orientationIcon.classList.remove('fa-mobile-screen', 'fa-mobile-screen-button');
                    orientationIcon.classList.add(newIcon);
                    orientationButton.title = newTitle;

                    lSidebarOrientationIcon.classList.remove('fa-mobile-screen', 'fa-mobile-screen-button');
                    lSidebarOrientationIcon.classList.add(newIcon);
                    lSidebarOrientationButton.title = newTitle;

                    mainContent.classList.toggle('h-full', isNowLandscape);
                    
                    renderStep();
                    
                }, flipDuration); 

            }, flipDuration + pauseDuration); 

        }
        window.toggleOrientation = toggleOrientation; 

        // Navigation Menu Functions
        
        function toggleNavigationMenu() {
            const modal = document.getElementById('navigation-modal');
            const panel = document.getElementById('navigation-panel');
            
            if (modal.classList.contains('hidden')) {
                renderNavigationMenu();
                modal.classList.remove('hidden');

                setTimeout(() => {
                    panel.classList.remove('translate-x-full');
                }, 10);
            } else {
                panel.classList.add('translate-x-full');
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            }
        }
        window.toggleNavigationMenu = toggleNavigationMenu;
        
        function goToStep(index) {
            // No custom gate needed since scenarios can be reviewed
            currentStep = index;
            renderStep();
            toggleNavigationMenu();
        }
        window.goToStep = goToStep;

        function renderNavigationMenu() {
            const topicList = document.getElementById('topic-list');
            topicList.innerHTML = '';
            
            courseSteps.forEach((step, index) => {
                let menuTitle;
                if (index === 0) {
                    menuTitle = "Welcome & Start";
                } else if (index === courseSteps.length - 1) {
                    menuTitle = `Conclusion (Score: ${totalChallengeScore}/${maxChallengeScore})`;
                } else {
                    menuTitle = `Scenario ${index}: ${step.title.split('. ')[0]}`;
                }

                const answered = answeredScenarioIndices[index] ? '<i class="fas fa-check-circle text-green-500 mr-2"></i>' : '<i class="fas fa-circle text-gray-400 mr-2"></i>';
                const style = (index === 0 || index === courseSteps.length - 1) ? 'font-bold text-sm' : 'text-sm';
                const color = currentStep === index ? 'var(--brand-primary)' : 'var(--text-primary)';
                const weight = currentStep === index ? 'font-extrabold' : 'font-semibold';

                const listItem = document.createElement('button');
                listItem.className = `w-full text-left p-2 rounded-lg hover:bg-gray-100 transition-colors ${style}`;
                
                listItem.innerHTML = `<span class="${weight}" style="color: ${color}">${index > 0 && index < courseSteps.length - 1 ? answered : ''}${menuTitle}</span>`;
                listItem.onclick = () => goToStep(index);

                topicList.appendChild(listItem);
            });
        }
        
        // Initial setup execution
        document.addEventListener('DOMContentLoaded', () => {
            courseApp.classList.add('flex-col');
            renderStep();
        });
    </script>
</body>
</html>

