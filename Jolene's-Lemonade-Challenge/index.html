<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Jolene's Lemonade Challenge - GoodBlock V3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <!-- FIREBASE SETUP -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, GoogleAuthProvider, signInWithPopup, updateProfile, signOut } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, addDoc, collection, serverTimestamp, getDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
        
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "AIzaSyAf2SO8xovrApl52udUUoR1n9WBnERr_ko", authDomain: "allgood-academy.firebaseapp.com", projectId: "allgood-academy" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'allgood-academy';
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Expose for Global Access (Needed for Logout)
        window.auth = auth;
        window.db = db;
        window.authSignOut = () => signOut(auth);

        window.currentUser = null;
        window.currentUserName = "Learner";
        window.sessionId = "session_" + Date.now() + "_" + Math.floor(Math.random() * 1000);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                window.currentUser = user;
                let finalName = user.displayName || localStorage.getItem('aa_username') || "Learner";
                
                if (finalName === "Learner" || finalName === "Agent") {
                    try {
                        const userDoc = await getDoc(doc(db, 'artifacts', appId, 'users', user.uid));
                        if (userDoc.exists() && userDoc.data().displayName) finalName = userDoc.data().displayName;
                    } catch(e) { console.log("Profile fetch skipped", e); }
                }

                window.currentUserName = finalName;
                // REVERTED TO MASTER TEMPLATE STANDARD:
                document.getElementById('header-welcome-text').textContent = `Welcome: ${finalName}`;
                
                const loginModal = document.getElementById('login-modal');
                if (loginModal && !loginModal.classList.contains('hidden-modal')) {
                    loginModal.classList.add('hidden-modal');
                    loginModal.classList.remove('visible-modal');
                    if(window.logFinalScoreToFirestore) window.logFinalScoreToFirestore({ rank: "Session Resumed", sessionId: window.sessionId });
                }
            } else {
                window.currentUser = null;
            }
        });

        window.ensureUserContainer = async (user, name, email) => {
             const userRef = doc(db, 'artifacts', appId, 'users', user.uid);
             try {
                 await setDoc(userRef, { displayName: name, email: email || null, lastLogin: serverTimestamp(), lastActiveModule: "Jolenes Lemonade Challenge" }, { merge: true });
             } catch (e) { console.error("[Identity] Error:", e); }
        }

        window.logScenarioAttempt = async (data) => {
            const user = auth.currentUser;
            if (!user) return;
            const attemptRef = doc(db, 'artifacts', appId, 'users', user.uid, 'game_scores', window.sessionId, 'scenario_attempts', `scenario_${data.scenarioIndex}`);
            try { await setDoc(attemptRef, { ...data, timestamp: serverTimestamp() }); } catch (e) {}
        };

        window.logFinalScoreToFirestore = async (scoreData) => {
            const user = auth.currentUser;
            if (!user) return;
            const sessionRef = doc(db, 'artifacts', appId, 'users', user.uid, 'game_scores', window.sessionId);
            try { await setDoc(sessionRef, { gameName: "Jolenes Lemonade Challenge", ...scoreData, lastUpdated: serverTimestamp(), user: { uid: user.uid, displayName: window.currentUserName } }, { merge: true }); } catch (e) {}
        }

        window.handleGuestLogin = async () => {
            const nameInput = document.getElementById('user-name-input').value.trim();
            const emailInput = document.getElementById('user-email-input').value.trim();
            const btn = document.getElementById('btn-guest-login');
            btn.innerText = "Connecting..."; btn.disabled = true;

            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) { await signInWithCustomToken(auth, __initial_auth_token); } 
                else if (!auth.currentUser) { await signInAnonymously(auth); }

                const user = auth.currentUser;
                const displayName = nameInput || "Learner";
                
                if (user) {
                    await updateProfile(user, { displayName: displayName });
                    await window.ensureUserContainer(user, displayName, emailInput);
                    window.currentUserName = displayName;
                    localStorage.setItem('aa_username', displayName);
                    window.logFinalScoreToFirestore({ rank: "Session Started", sessionId: window.sessionId });
                    document.getElementById('login-modal').classList.add('hidden-modal');
                    document.getElementById('login-modal').classList.remove('visible-modal');
                    if(window.showPage) window.showPage(0);
                    if(window.sfx) window.sfx.nav();
                }
            } catch (error) { alert("Connection failed. Please try again."); } finally { btn.innerText = "Start Challenge"; btn.disabled = false; }
        };

        window.handleGoogleLogin = async () => {
            const provider = new GoogleAuthProvider();
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                const finalName = user.displayName || "Learner";
                await window.ensureUserContainer(user, finalName, user.email);
                window.currentUserName = finalName;
                localStorage.setItem('aa_username', finalName);
                document.getElementById('login-modal').classList.add('hidden-modal');
                document.getElementById('login-modal').classList.remove('visible-modal');
                if(window.showPage) window.showPage(0);
                if(window.sfx) window.sfx.nav();
            } catch (error) { alert("Google Sign-In failed."); }
        };
    </script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 'allgood-primary': '#D34716', 'allgood-secondary': '#357889', 'allgood-dark': '#4C4C4C', 'allgood-light': '#F7F7F7', 'allgood-hover': '#EB8D69', 'allgood-accent': '#2D6473' },
                    fontFamily: { 'heading': ['Georgia', 'serif'], 'body': ['Verdana', 'sans-serif'] },
                },
            },
        }
    </script>

    <style>
        /* FIXED CHASSIS: V3 MASTER BACKGROUND */
        body {
            font-family: Verdana, sans-serif;
            background-color: #1a1a1a;
            background-image: linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
            background-attachment: fixed;
            min-height: 100vh;
            margin: 0; padding: 0;
            -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; -webkit-tap-highlight-color: transparent;
        }

        h1, h2, h3, h4 { font-family: Georgia, serif; }

        .tablet-frame {
            height: 80vh; width: auto; aspect-ratio: 16/10; max-width: 1100px; max-height: 95vh;
            background-image: radial-gradient(circle at 0% 0%, rgba(211, 71, 22, 0.35) 0%, transparent 30%), linear-gradient(135deg, #5c5c5c 0%, #d6d6d6 25%, #8a8a8a 50%, #e0e0e0 75%, #5c5c5c 100%);
            border-radius: 12px; padding: 12px; border: 1px solid #333; position: relative; margin: 20px auto;
            box-shadow: inset 1px 1px 2px rgba(255,255,255,0.6), 0 30px 60px -12px rgba(0,0,0,0.8);
            transition: width 0.3s, height 0.3s;
        }
        .tablet-frame::before { content: ''; position: absolute; top: 10px; left: 10px; right: 10px; bottom: 10px; border-radius: 6px; background: #111; z-index: 0; }
        
        .screen-container {
            width: 100%; height: 100%; background-color: #F7F7F7; position: relative; z-index: 1;
            overflow: hidden; display: flex; flex-direction: column; border-radius: 4px; box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }

        /* Modals & Scrollbars */
        .modal-transition { transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out; }
        .hidden-modal { opacity: 0; pointer-events: none; transform: translateY(-10px); }
        .visible-modal { opacity: 1; pointer-events: auto; transform: translateY(0); }
        .page::-webkit-scrollbar { width: 14px; }
        .page::-webkit-scrollbar-track { background: #e5e5e5; border-left: 1px solid #d1d5db; }
        .page::-webkit-scrollbar-thumb { background-color: #D34716; border-radius: 7px; border: 3px solid #e5e5e5; }
        
        #flex-progress-bar { height: 4px; width: 100%; background-color: #eee; position: absolute; top: 0; left: 0; }
        #flex-progress-fill { height: 100%; background-color: #D34716; width: 0%; transition: width 0.3s ease; }

        /* JLC Specific Styles */
        .choice-btn { background-color: #FFFFFF; border: 2px solid #E5E7EB; transition: all 0.2s ease; }
        .choice-btn:hover:not(:disabled) { border-color: #357889; background-color: #F9FAFB; }
        .choice-correct { background-color: #D1FAE5 !important; border-color: #10B981 !important; font-weight: bold; }
        .choice-less-effective { background-color: #FFFBEB !important; border-color: #FBBF24 !important; font-weight: 600; }
        .choice-least-effective { background-color: #FEE2E2 !important; border-color: #F87171 !important; font-weight: 500; opacity: 0.7; }
        .feedback-box { background-color: #F9FAFB; border-left: 5px solid #357889; }
        
        /* Blueprint Mode */
        .blueprint-mode { background-color: #0f172a !important; color: #94a3b8 !important; }
        .blueprint-mode .page { background-color: #0f172a !important; }
        .blueprint-mode .bg-white { background-color: #1e293b !important; border-color: #334155 !important; color: #cbd5e1 !important; }
        .blueprint-mode .text-allgood-dark { color: #e2e8f0 !important; }
        .blueprint-mode .choice-btn { background-color: #1e293b !important; border-color: #334155 !important; }

        /* V3 Mobile Overrides */
        @media (max-width: 768px) {
            html, body { position: fixed; width: 100%; height: 100dvh; overflow: hidden; margin: 0; padding: 0; background-color: #F7F7F7; }
            main { padding: 0 !important; height: 100dvh !important; width: 100% !important; display: block; position: fixed; top: 0; left: 0; }
            .tablet-frame {
                position: absolute !important; top: 0; left: 0; right: 0; bottom: 0;
                width: 100% !important; height: 100% !important; max-width: none !important; max-height: none !important;
                margin: 0 !important; padding: 0 !important; border: none !important; border-radius: 0 !important;
                box-shadow: none !important; background: #F7F7F7 !important; aspect-ratio: unset !important;
            }
            .tablet-frame::before { display: none !important; }
            .screen-container { border-radius: 0 !important; box-shadow: none !important; }
            header.navbar-content { padding-top: max(env(safe-area-inset-top), 12px); height: auto; min-height: 60px; padding-bottom: 12px; }
            footer.footer-content {
                position: absolute; bottom: 0; left: 0; width: 100%;
                padding-bottom: max(env(safe-area-inset-bottom), 20px); padding-top: 12px; height: auto; min-height: 80px;
                z-index: 100; background-color: white; border-top: 1px solid #e5e7eb;
            }
            .page { padding-bottom: 120px !important; }
        }

        .tablet-frame.focus-mode { 
            position: fixed !important; top: 0 !important; left: 0 !important; width: 100vw !important; height: 100vh !important;
            max-width: none !important; max-height: none !important; aspect-ratio: unset !important;
            margin: 0 !important; padding: 0 !important; z-index: 99999 !important;
            border-radius: 0 !important; background: #F7F7F7 !important;
        }
        .tablet-frame.focus-mode::before { display: none; }
        
        .navbar-content { flex: 0 0 60px; z-index: 50; }
        .page { flex: 1 1 auto; overflow-y: auto; padding: 20px; position: relative; display: none; width: 100%; }
        .page.active { display: block; }
        .footer-content { flex: 0 0 60px; z-index: 50; background-color: white; border-top: 1px solid #e5e7eb; position: relative; }
    </style>
</head>
<body class="flex flex-col min-h-screen text-allgood-dark font-body overflow-y-auto">

    <main class="flex-grow flex items-center justify-center py-8">
        <div class="tablet-frame">
            <div class="screen-container" id="screen">

                <!-- 1. STARTUP SCREEN -->
                <div id="startup-screen" class="absolute inset-0 z-[300] flex flex-col items-center justify-center cursor-pointer transition-opacity duration-700 ease-in-out bg-slate-900">
                    <div class="group flex flex-col items-center justify-center text-center h-full w-full relative">
                        <div class="flex-grow flex flex-col items-center justify-center px-4">
                            <h2 class="text-xl md:text-3xl font-heading font-bold text-white mb-1 relative z-10">Allgood Academy</h2>
                            <h1 class="text-4xl md:text-6xl font-heading font-bold text-allgood-primary tracking-tighter relative z-10 drop-shadow-md">GoodBlock</h1>
                            <p class="mt-2 text-white/80 relative z-10 font-body text-sm font-semibold">Jolene's Lemonade Challenge</p>
                            <p class="mt-12 text-white/80 text-xs tracking-[0.3em] uppercase font-medium group-hover:text-white transition-colors animate-pulse font-body">Click to Power Up</p>
                        </div>
                    </div>
                </div>

                <!-- 2. SYSTEM MENU (NEW V3 FEATURE) -->
                <div id="system-menu-modal" class="hidden-modal absolute inset-0 z-[250] bg-black/80 flex items-center justify-center p-6 modal-transition backdrop-blur-sm">
                    <div class="bg-white rounded-lg shadow-2xl p-8 max-w-sm w-full text-center border-t-4 border-gray-500">
                        <div class="mb-4"><i data-lucide="settings" class="w-12 h-12 mx-auto text-gray-400"></i></div>
                        <h2 class="text-xl font-heading font-bold text-allgood-dark mb-2">System Menu</h2>
                        <p class="text-sm text-gray-500 mb-6 font-body">Select an option to proceed.</p>
                        <div class="space-y-3">
                            <button onclick="window.handleLogOut()" class="w-full bg-red-50 hover:bg-red-100 text-red-600 font-bold py-3 rounded border border-red-200 shadow-sm transition-colors flex items-center justify-center">
                                <i data-lucide="log-out" class="w-4 h-4 mr-2"></i> Log Out
                            </button>
                            <button onclick="window.handleSystemExit()" class="w-full bg-gray-100 hover:bg-gray-200 text-allgood-dark font-bold py-3 rounded border border-gray-300 shadow-sm transition-colors flex items-center justify-center">
                                <i data-lucide="external-link" class="w-4 h-4 mr-2"></i> Exit to Dashboard
                            </button>
                            <button onclick="window.closeSystemMenu()" class="w-full text-gray-400 hover:text-gray-600 font-bold py-2 text-sm mt-2">Cancel</button>
                        </div>
                    </div>
                </div>

                <!-- 3. HEADER (V3 ALIGNMENT) -->
                <header class="bg-allgood-secondary shadow-md navbar-content flex items-center">
                    <div class="w-full px-4 flex items-center justify-between h-full pt-[env(safe-area-inset-top)]">
                        <div class="flex items-center overflow-hidden">
                            <!-- REVERTED TO MASTER TEMPLATE STANDARD -->
                            <div id="header-welcome-text" class="flex-shrink-0 text-white font-heading font-bold text-lg tracking-tight truncate mr-2 select-none">Welcome: Learner</div>
                            <div class="hidden sm:flex items-center bg-black/20 rounded-full px-3 py-1 border border-white/10 shadow-inner backdrop-blur-sm mr-2">
                                <span id="header-page-indicator" class="text-xs font-bold text-white font-body tabular-nums">1 / 19</span>
                            </div>
                            <div id="bank-display" class="hidden sm:flex items-center bg-green-900/40 rounded-full px-3 py-1 border border-green-400/30">
                                <i data-lucide="dollar-sign" class="w-3 h-3 text-green-400 mr-1"></i>
                                <span id="bank-balance" class="text-xs font-bold text-green-100 font-body tabular-nums">$200</span>
                            </div>
                        </div>
                        
                        <!-- CONTROL CLUSTER (UPDATED) -->
                        <div class="flex items-center space-x-1 shrink-0 relative">
                            <button id="home-button" class="text-gray-200 hover:text-white transition-colors p-2 rounded-full hover:bg-white/10" title="Home (Hold for Menu)">
                                <i data-lucide="home" class="w-6 h-6"></i>
                            </button>
                            <div class="h-6 w-px bg-white/20 mx-1"></div>
                            <button id="blueprint-toggle" class="text-gray-200 hover:text-cyan-300 transition-colors p-2 rounded-full hover:bg-white/10" title="Blueprint Mode">
                                <i data-lucide="moon" class="w-5 h-5"></i>
                            </button>
                            <button id="fullscreen-toggle" class="hidden md:block text-gray-200 hover:text-green-300 transition-colors p-2 rounded-full hover:bg-white/10" title="Focus Mode">
                                <i data-lucide="maximize" class="w-5 h-5"></i>
                            </button>
                            <button id="menu-toggle" class="text-gray-200 hover:text-white transition-colors p-2 rounded-full hover:bg-white/10" title="Menu">
                                <i data-lucide="menu" class="w-7 h-7"></i>
                            </button>
                        </div>
                    </div>
                </header>

                <!-- LOGIN MODAL -->
                <div id="login-modal" class="absolute inset-0 z-[200] bg-allgood-dark/95 flex items-center justify-center p-6 hidden-modal modal-transition backdrop-blur-sm">
                    <div class="bg-white rounded-lg shadow-2xl p-8 max-w-sm w-full text-center border-t-4 border-allgood-primary">
                        <div class="mb-6"><h2 class="text-3xl font-heading font-bold text-allgood-dark">Allgood<span class="text-allgood-primary">Academy</span></h2></div>
                        <h2 class="text-xl font-bold text-allgood-dark mb-2 font-heading">Welcome</h2>
                        <input type="text" id="user-name-input" placeholder="Your Name (Optional)" class="w-full border border-gray-300 rounded p-3 mb-3 focus:ring-2 focus:ring-allgood-primary outline-none transition-all font-body">
                        <input type="email" id="user-email-input" placeholder="Your Email (Optional)" class="w-full border border-gray-300 rounded p-3 mb-6 focus:ring-2 focus:ring-allgood-primary outline-none transition-all font-body">
                        <button id="btn-guest-login" onclick="window.handleGuestLogin()" class="w-full bg-allgood-primary hover:bg-allgood-hover text-white font-bold py-3 rounded shadow-md transition-transform transform hover:scale-[1.02] font-body uppercase">Start Challenge</button>
                        <div class="mt-4 flex items-center justify-center space-x-2"><div class="h-px w-10 bg-gray-200"></div><p class="text-xs text-gray-500 uppercase font-bold">OR</p><div class="h-px w-10 bg-gray-200"></div></div>
                        <button id="google-icon-container" onclick="window.handleGoogleLogin()" class="mt-4 p-2 rounded-full border border-gray-300 shadow-md hover:shadow-lg transition-all duration-200 hover:scale-105 active:scale-95 bg-white flex items-center justify-center mx-auto">
                            <svg class="w-6 h-6" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                        </button>
                    </div>
                </div>
                
                <!-- SCENARIO FEEDBACK MODAL -->
                <div id="scenario-modal" class="hidden-modal absolute inset-0 z-[260] bg-allgood-dark/90 flex items-center justify-center p-4 modal-transition" onclick="window.closeScenarioModal(false)">
                    <div class="bg-white rounded-lg shadow-2xl p-6 max-w-sm w-full text-center relative border-t-4 border-allgood-secondary" onclick="event.stopPropagation()">
                        <div id="scenario-icon" class="mx-auto w-16 h-16 rounded-full flex items-center justify-center mb-4 text-3xl transition-colors"></div>
                        <h3 id="scenario-title" class="text-xl font-heading font-bold text-allgood-dark mb-2"></h3>
                        <div id="scenario-feedback" class="text-sm text-gray-600 font-body mb-6 leading-relaxed text-left"></div>
                        <button id="scenario-modal-next-btn" class="bg-allgood-dark text-white px-6 py-2 rounded-full font-bold text-xs uppercase tracking-wider hover:bg-allgood-primary transition-colors shadow-md">Next Scenario</button>
                    </div>
                </div>

                <!-- NAV MENU MODAL -->
                <div id="menu-modal" class="hidden-modal absolute inset-0 z-[100] bg-black/60 flex justify-end modal-transition">
                    <div class="w-72 h-full bg-white shadow-xl flex flex-col border-l border-gray-200">
                        <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                            <span class="font-bold text-allgood-dark font-heading">Table of Contents</span>
                            <button id="close-menu" class="text-gray-500 hover:text-allgood-primary"><i data-lucide="x" class="w-6 h-6"></i></button>
                        </div>
                        <div class="p-2 overflow-y-auto flex-grow space-y-1 text-sm font-body" id="toc-list"></div>
                    </div>
                </div>

                <!-- PAGES (CONTENT PRESERVED) -->
                <div class="page active" id="page-1">
                    <div class="flex flex-col items-center justify-start min-h-full text-center px-2 pt-12 pb-24">
                        <div class="mb-2"><h2 class="text-2xl font-heading font-bold text-allgood-dark">Allgood<span class="text-allgood-primary">Academy</span></h2></div>
                        <h1 class="text-3xl sm:text-4xl font-heading font-bold text-allgood-dark mb-6 leading-tight tracking-tight">Jolene's <span class="text-allgood-primary">Lemonade</span> Challenge</h1>
                        <p class="text-lg text-gray-600 mb-8 max-w-md mx-auto">Navigate tough decisions and master the art of turning a challenge into an opportunity.</p>
                        <div class="w-full max-w-lg text-left mx-auto">
                            <button class="accordion-toggle w-full bg-white border border-gray-200 p-4 rounded-lg shadow-md flex justify-between items-center hover:bg-gray-50 hover:border-allgood-primary transition-all group">
                                <span class="font-bold text-allgood-dark text-base group-hover:text-allgood-primary transition-colors font-heading">How to use this GoodBlock</span>
                                <i data-lucide="chevron-down" class="accordion-icon w-5 h-5 text-gray-400 transform transition-transform duration-300 group-hover:text-allgood-primary"></i>
                            </button>
                            <div class="accordion-content hidden bg-gray-50 border-x border-b border-gray-200 rounded-b-lg p-5 text-gray-600 shadow-inner text-xs font-body">
                                <p class="mb-4 text-sm text-allgood-dark">Use the **Control Cluster** in the top right to customize your environment.</p>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div class="flex items-start"><div class="p-1.5 bg-white rounded border border-gray-300 mr-3 text-allgood-primary shrink-0"><i data-lucide="home" class="w-4 h-4"></i></div><div><strong class="text-allgood-dark block mb-0.5">Reset</strong><span class="text-gray-500 leading-snug">Click for cover. <strong>Hold 2s</strong> for System Menu.</span></div></div>
                                    <div class="flex items-start"><div class="p-1.5 bg-white rounded border border-gray-300 mr-3 text-cyan-600 shrink-0"><i data-lucide="moon" class="w-4 h-4"></i></div><div><strong class="text-allgood-dark block mb-0.5">Blueprint</strong><span class="text-gray-500 leading-snug">Toggle high-contrast Dark Mode.</span></div></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="page" id="page-2">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark mb-2">From Stand to Empire</h2></section>
                    <div class="bg-white p-6 rounded border border-gray-200 shadow-sm leading-relaxed text-gray-700 text-lg">
                        <p class="mb-6"><strong>A lesson in grit.</strong> The journey to empire is full of setbacks. This game is your chance to learn from them.</p>
                        <div class="bg-gray-100 p-4 rounded border-l-4 border-allgood-primary shadow-sm mb-6">
                            <h3 class="font-bold text-allgood-dark text-lg mb-2">The Goal</h3>
                            <p class="text-sm">Grow your startup capital of <strong>$200</strong> into a thriving business. Earn a profit on every decision.</p>
                            <p class="text-sm mt-2"><strong>Target:</strong> Reach <strong>$800</strong> to earn the "Certified Entrepreneur" badge.</p>
                        </div>
                    </div>
                </div>

                <!-- SCENARIO PLACEHOLDERS -->
                <div class="page" id="page-3" data-scenario-index="1"></div>
                <div class="page" id="page-4" data-scenario-index="2"></div>
                <div class="page" id="page-5" data-scenario-index="3"></div>
                <div class="page" id="page-6" data-scenario-index="4"></div>
                <div class="page" id="page-7" data-scenario-index="5"></div>
                <div class="page" id="page-8" data-scenario-index="6"></div>
                <div class="page" id="page-9" data-scenario-index="7"></div>
                <div class="page" id="page-10" data-scenario-index="8"></div>
                <div class="page" id="page-11" data-scenario-index="9"></div>
                <div class="page" id="page-12" data-scenario-index="10"></div>
                <div class="page" id="page-13" data-scenario-index="11"></div>
                <div class="page" id="page-14" data-scenario-index="12"></div>
                <div class="page" id="page-15" data-scenario-index="13"></div>
                <div class="page" id="page-16" data-scenario-index="14"></div>
                <div class="page" id="page-17" data-scenario-index="15"></div>

                <!-- FINAL SCORE -->
                <div class="page" id="page-18">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark mb-2">Final Readiness Assessment</h2><p class="text-xs font-bold text-allgood-primary uppercase tracking-widest">Entrepreneurial Scorecard</p></section>
                    <div id="final-score-content">
                        <div class="text-center py-8">
                            <div class="w-full max-w-sm mx-auto bg-gray-50 p-6 rounded-lg shadow-inner border border-gray-200 mb-8">
                                <p class="text-sm font-semibold text-gray-500 mb-1">Final Bank Balance</p>
                                <p id="final-score-value" class="text-5xl font-extrabold text-allgood-dark font-heading">$200</p>
                                <p id="final-score-percent" class="text-xs text-gray-400 mt-1">(Target: $800)</p>
                            </div>
                            <h3 id="final-rank-heading" class="text-xl font-heading font-bold text-allgood-dark mb-2">Aspiring Entrepreneur</h3>
                            <p id="final-rank-message" class="text-sm text-gray-600 max-w-md mx-auto">Good start. Reread the feedback and try again.</p>
                            <div id="certification-section" class="w-full max-w-md mx-auto bg-gradient-to-br from-allgood-secondary to-allgood-accent p-1 rounded-lg shadow-xl mt-12 transform transition-all duration-700">
                                <div class="bg-white p-6 rounded-md text-center">
                                    <div class="mb-4 relative inline-block"><i id="badge-icon" data-lucide="award" class="relative w-16 h-16 text-allgood-primary mx-auto"></i></div>
                                    <h3 class="font-heading font-bold text-xl text-allgood-dark mb-2">Entrepreneur Certification</h3>
                                    <p id="cert-req-text" class="text-sm text-gray-600 mb-6">You need <strong>$800</strong> to achieve this certification.</p>
                                    <button id="download-badge-btn" onclick="window.downloadBadge()" disabled class="w-full bg-gray-300 text-white font-bold py-3 rounded shadow-none cursor-not-allowed flex items-center justify-center transition-all duration-300">
                                        <i data-lucide="lock" class="w-4 h-4 mr-2"></i><span id="btn-text">Certification Locked</span>
                                    </button>
                                    <button id="retake-challenge-btn" onclick="window.performHardReset()" class="w-full bg-gray-100 text-allgood-dark font-bold py-2 rounded shadow-sm mt-4 hover:bg-gray-200 transition-colors">Retake Challenge</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CREDITS / FEEDBACK -->
                <div class="page" id="page-19">
                    <div class="flex flex-col items-center justify-start h-full text-center px-2 pt-8">
                        <div class="mb-8"><h2 class="text-2xl font-heading font-bold text-allgood-dark">Allgood<span class="text-allgood-primary">Academy</span></h2><p class="text-xs text-gray-400 font-bold tracking-widest uppercase mt-2">Pragmatic Action</p></div>
                        <div id="feedback-container" class="w-full max-w-md bg-white p-6 rounded-lg shadow-md border border-gray-200 mb-8 text-left relative">
                            <h3 class="font-bold text-allgood-dark text-sm uppercase tracking-wide mb-4 text-center">Rate this Challenge</h3>
                            <div class="flex justify-center space-x-2 mb-4" id="star-wrapper">
                                <button onclick="window.setRating(1)" class="star-btn focus:outline-none transition-transform hover:scale-110" data-val="1"><i id="star-1" class="fas fa-star text-2xl text-gray-300"></i></button>
                                <button onclick="window.setRating(2)" class="star-btn focus:outline-none transition-transform hover:scale-110" data-val="2"><i id="star-2" class="fas fa-star text-2xl text-gray-300"></i></button>
                                <button onclick="window.setRating(3)" class="star-btn focus:outline-none transition-transform hover:scale-110" data-val="3"><i id="star-3" class="fas fa-star text-2xl text-gray-300"></i></button>
                                <button onclick="window.setRating(4)" class="star-btn focus:outline-none transition-transform hover:scale-110" data-val="4"><i id="star-4" class="fas fa-star text-2xl text-gray-300"></i></button>
                                <button onclick="window.setRating(5)" class="star-btn focus:outline-none transition-transform hover:scale-110" data-val="5"><i id="star-5" class="fas fa-star text-2xl text-gray-300"></i></button>
                            </div>
                            <textarea id="feedback-text" rows="3" class="w-full border border-gray-300 rounded p-3 text-sm focus:ring-1 focus:ring-allgood-primary outline-none resize-none bg-gray-50" placeholder="Share your thoughts..."></textarea>
                            <button onclick="window.submitFeedback()" class="w-full mt-4 bg-allgood-dark hover:bg-allgood-primary text-white font-bold py-2 rounded transition-colors text-sm">Send Feedback</button>
                        </div>
                        <div id="feedback-success" class="hidden w-full max-w-md bg-green-50 p-6 rounded-lg shadow-inner border border-green-200 mb-8 text-center">
                            <i data-lucide="check-circle" class="w-12 h-12 text-green-600 mx-auto mb-2"></i>
                            <h3 class="font-bold text-green-800">Feedback Received.</h3>
                        </div>
                    </div>
                </div>

                <footer class="footer-content flex items-center justify-between px-6">
                    <div id="flex-progress-bar"><div id="flex-progress-fill"></div></div>
                    <button id="back-button" class="text-allgood-primary hover:text-allgood-dark font-bold text-sm flex items-center transition-colors disabled:opacity-30 disabled:cursor-not-allowed font-body"><i data-lucide="chevron-left" class="w-4 h-4 mr-1"></i>Back</button>
                    <p class="text-gray-400 text-[10px] hidden sm:block font-body">&copy; Allgood Academy</p>
                    <button id="next-button" class="bg-allgood-primary hover:bg-allgood-hover text-white px-6 py-2 rounded-full text-sm font-bold shadow-md transition-transform transform hover:scale-105 flex items-center disabled:opacity-50 disabled:cursor-not-allowed font-body"><span>Next</span><i data-lucide="chevron-right" class="w-4 h-4 ml-1"></i></button>
                </footer>

            </div>
        </div>
    </main>

    <script>
        // --- AUDIO ENGINE ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx;
        function initAudio() { if (!audioCtx) audioCtx = new AudioContext(); if (audioCtx.state === 'suspended') audioCtx.resume().catch(e => console.error(e)); }
        function playTone(freq, type, duration, vol = 0.1) { initAudio(); const now = audioCtx.currentTime; const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = type; osc.frequency.setValueAtTime(freq, now); osc.connect(gain); gain.connect(audioCtx.destination); gain.gain.setValueAtTime(0, now); gain.gain.linearRampToValueAtTime(vol, now + 0.01); gain.gain.exponentialRampToValueAtTime(0.001, now + duration); osc.start(now); osc.stop(now + duration); }
        const sfx = {
            powerOn: () => { initAudio(); const now = audioCtx.currentTime; const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.connect(gain); gain.connect(audioCtx.destination); osc.type = 'triangle'; osc.frequency.setValueAtTime(110, now); osc.frequency.exponentialRampToValueAtTime(220, now + 0.4); gain.gain.setValueAtTime(0, now); gain.gain.linearRampToValueAtTime(0.4, now + 0.1); gain.gain.linearRampToValueAtTime(0, now + 0.4); osc.start(now); osc.stop(now + 0.4); },
            nav: () => playTone(150, 'sine', 0.1),
            tick: () => playTone(1000, 'sine', 0.01),
            success: () => playTone(600, 'sine', 0.2),
            error: () => playTone(100, 'sawtooth', 0.2)
        };
        window.sfx = sfx;

        // --- GLOBAL VARIABLES ---
        let currentPageIndex = 0; 
        const TOTAL_PAGES = 19; 
        const TOTAL_SCENARIOS = 15;
        const BADGE_THRESHOLD = 800;
        let totalChallengeScore = 200;
        let answeredScenarioScores = {};

        // --- JOLENE DATA ---
        const SCENARIO_DATA = [
            { image: "https://i.ibb.co/fzj1FLhq/jolene1.png", title: "Feedback on the first batch.", icon: "message-circle", choices: [ { text: "Ignore the negative feedback.", score: 0, effectiveness: "least-effective", feedback: "Ignoring customers is the fastest way to fail." }, { text: "Ask for specific preferences.", score: 50, effectiveness: "most-effective", feedback: "Active listening allows you to craft the perfect product." }, { text: "Offer refunds blindly.", score: 20, effectiveness: "less-effective", feedback: "Nice gesture, but it doesn't solve the root problem." } ] },
            { image: "https://i.ibb.co/C3znrFw9/jolene2.png", title: "Running in the Red.", icon: "trending-down", choices: [ { text: "Ignore finances.", score: 0, effectiveness: "least-effective", feedback: "You ran out of cash quickly." }, { text: "Create a budget and track expenses.", score: 50, effectiveness: "most-effective", feedback: "You found the leak and plugged it." }, { text: "Ask for a loan without a plan.", score: 20, effectiveness: "less-effective", feedback: "Temporary fix for a permanent problem." } ] },
            { image: "https://i.ibb.co/WvYh4375/jolene3.png", title: "Supply Shortage.", icon: "sun", choices: [ { text: "Close for the day.", score: 0, effectiveness: "least-effective", feedback: "You missed the heatwave sales." }, { text: "Collaborate with a local bakery.", score: 50, effectiveness: "most-effective", feedback: "Creative sourcing saved the day." }, { text: "Buy expensive retail supplies.", score: 20, effectiveness: "less-effective", feedback: "You got supplies, but margins were destroyed." } ] },
            { image: "https://i.ibb.co/93sqcdN3/Jolene4.png", title: "Pricing Strategy.", icon: "tag", choices: [ { text: "Match the highest competitor blindly.", score: 0, effectiveness: "least-effective", feedback: "Customers walked away." }, { text: "Calculate costs + margin.", score: 50, effectiveness: "most-effective", feedback: "Profitability secured." }, { text: "Keep prices low hoping for volume.", score: 20, effectiveness: "less-effective", feedback: "Busy work with no profit." } ] },
            { image: "https://i.ibb.co/rf1pR6Dr/jolene5-2.png", title: "Marketing Push.", icon: "megaphone", choices: [ { text: "Expensive print ads.", score: 0, effectiveness: "least-effective", feedback: "ROI was negative." }, { text: "Community social media offer.", score: 50, effectiveness: "most-effective", feedback: "Viral growth achieved." }, { text: "Flyers on cars.", score: 20, effectiveness: "less-effective", feedback: "Most ended up as litter." } ] },
            { image: "https://i.ibb.co/HfVRHWcb/jolene6.png", title: "Competition Arrives.", icon: "users", choices: [ { text: "Price war.", score: 0, effectiveness: "least-effective", feedback: "Race to the bottom." }, { text: "Loyalty program & differentiation.", score: 50, effectiveness: "most-effective", feedback: "Loyal customers stayed." }, { text: "Complain.", score: 20, effectiveness: "less-effective", feedback: "Wasted energy." } ] },
            { image: "https://i.ibb.co/QvP46Qm1/jolene7.png", title: "New Flavor Launch.", icon: "flask-conical", choices: [ { text: "Guess.", score: 0, effectiveness: "least-effective", feedback: "Flop." }, { text: "Sample testing.", score: 50, effectiveness: "most-effective", feedback: "Hit product." }, { text: "Copy competitor.", score: 20, effectiveness: "less-effective", feedback: "Late to market." } ] },
            { image: "https://i.ibb.co/RkT7R0Ld/jolene8.png", title: "Hiring Help.", icon: "user-plus", choices: [ { text: "Hire best friend.", score: 0, effectiveness: "least-effective", feedback: "Conflict of interest." }, { text: "Hire based on skills.", score: 50, effectiveness: "most-effective", feedback: "Efficiency up." }, { text: "Do it all yourself.", score: 20, effectiveness: "less-effective", feedback: "Burnout." } ] },
            { image: "https://i.ibb.co/wZqRj7W9/jolene9.png", title: "Expansion Opportunity.", icon: "map-pin", choices: [ { text: "Expand too fast.", score: 0, effectiveness: "least-effective", feedback: "Cash flow crunch." }, { text: "Strategic second location.", score: 50, effectiveness: "most-effective", feedback: "Steady growth." }, { text: "Stay small forever.", score: 20, effectiveness: "less-effective", feedback: "Missed potential." } ] },
            { image: "https://i.ibb.co/0yXw3ZqL/jolene10.png", title: "Regulatory Hurdle.", icon: "file-text", choices: [ { text: "Ignore permit.", score: 0, effectiveness: "least-effective", feedback: "Shut down." }, { text: "Get compliant.", score: 50, effectiveness: "most-effective", feedback: "Business safe." }, { text: "Argue with inspector.", score: 20, effectiveness: "less-effective", feedback: "Fines doubled." } ] },
            { image: "https://i.ibb.co/jv5ZqRj/jolene11.png", title: "Tech Upgrade.", icon: "smartphone", choices: [ { text: "Cash only.", score: 0, effectiveness: "least-effective", feedback: "Lost sales." }, { text: "Mobile payments.", score: 50, effectiveness: "most-effective", feedback: "Sales up 30%." }, { text: "IOU system.", score: 20, effectiveness: "less-effective", feedback: "Bad debt." } ] },
            { image: "https://i.ibb.co/5XqRj7W/jolene12.png", title: "Winter Season.", icon: "snowflake", choices: [ { text: "Keep selling cold lemonade.", score: 0, effectiveness: "least-effective", feedback: "Zero sales." }, { text: "Pivot to hot cider.", score: 50, effectiveness: "most-effective", feedback: "Year-round profit." }, { text: "Close for winter.", score: 20, effectiveness: "less-effective", feedback: "Lost momentum." } ] },
            { image: "https://i.ibb.co/7XqRj7W/jolene13.png", title: "Partnership Offer.", icon: "handshake", choices: [ { text: "Sign without reading.", score: 0, effectiveness: "least-effective", feedback: "Bad deal." }, { text: "Negotiate terms.", score: 50, effectiveness: "most-effective", feedback: "Win-win." }, { text: "Reject immediately.", score: 20, effectiveness: "less-effective", feedback: "Missed network." } ] },
            { image: "https://i.ibb.co/9XqRj7W/jolene14.png", title: "Crisis Management.", icon: "alert-triangle", choices: [ { text: "Hide mistake.", score: 0, effectiveness: "least-effective", feedback: "Trust lost." }, { text: "Own it and fix it.", score: 50, effectiveness: "most-effective", feedback: "Reputation enhanced." }, { text: "Blame employee.", score: 20, effectiveness: "less-effective", feedback: "Morale tanked." } ] },
            { image: "https://i.ibb.co/1XqRj7W/jolene15.png", title: "Exit Strategy.", icon: "log-out", choices: [ { text: "Walk away.", score: 0, effectiveness: "least-effective", feedback: "Zero equity." }, { text: "Sell for profit.", score: 50, effectiveness: "most-effective", feedback: "Wealth realized." }, { text: "Pass to family unprepared.", score: 20, effectiveness: "less-effective", feedback: "Business failed later." } ] }
        ];

        // --- RENDER ENGINE ---
        function renderScenarios() {
            SCENARIO_DATA.forEach((data, index) => {
                const page = document.querySelector(`.page[data-scenario-index="${index + 1}"]`);
                if (!page) return;
                
                page.innerHTML = `
                    <div class="flex flex-col h-full">
                        <div class="flex items-center justify-between mb-4 border-b border-gray-200 pb-2">
                            <h2 class="text-xl font-heading font-bold text-allgood-dark">Scenario ${index + 1}</h2>
                            <i data-lucide="${data.icon}" class="w-6 h-6 text-allgood-secondary"></i>
                        </div>
                        <div class="flex-grow overflow-y-auto pr-2">
                            <div class="flex flex-col sm:flex-row gap-4 mb-4">
                                <img src="${data.image}" class="w-full sm:w-1/3 rounded-lg object-cover shadow-sm h-48 border border-gray-200" alt="Scenario Image">
                                <div class="bg-white p-4 rounded border border-gray-200 shadow-sm flex-1">
                                    <h3 class="font-bold text-allgood-dark mb-2 font-heading">${data.title}</h3>
                                    <p class="text-sm text-gray-600">What is the most effective action?</p>
                                </div>
                            </div>
                            <div class="space-y-3">
                                ${data.choices.map((choice, i) => `
                                    <button class="choice-btn w-full text-left p-4 rounded-lg shadow-sm flex items-start group" onclick="handleChoice(${index}, ${i})">
                                        <div class="mt-0.5 mr-3 w-5 h-5 rounded-full border border-gray-300 flex items-center justify-center group-hover:border-allgood-primary"><div class="w-2.5 h-2.5 rounded-full bg-allgood-primary opacity-0 group-hover:opacity-100 transition-opacity"></div></div>
                                        <span class="text-sm text-gray-700 font-body">${choice.text}</span>
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            });
            lucide.createIcons();
        }

        window.handleChoice = (scenarioIndex, choiceIndex) => {
            if (answeredScenarioScores[scenarioIndex] !== undefined) return;
            
            const data = SCENARIO_DATA[scenarioIndex];
            const choice = data.choices[choiceIndex];
            answeredScenarioScores[scenarioIndex] = choice.score;
            totalChallengeScore += choice.score;
            document.getElementById('bank-balance').textContent = `$${totalChallengeScore}`;
            
            // Log Attempt
            window.logScenarioAttempt({
                scenarioIndex: scenarioIndex + 1,
                choiceText: choice.text,
                score: choice.score,
                effectiveness: choice.effectiveness
            });

            // Feedback Modal
            const modal = document.getElementById('scenario-modal');
            const iconContainer = document.getElementById('scenario-icon');
            const title = document.getElementById('scenario-title');
            const feedback = document.getElementById('scenario-feedback');
            
            modal.classList.remove('hidden-modal'); modal.classList.add('visible-modal');
            
            title.textContent = choice.score === 50 ? "Excellent Choice" : choice.score === 20 ? "Good Attempt" : "Missed Opportunity";
            feedback.textContent = choice.feedback;
            
            iconContainer.innerHTML = '';
            if(choice.score === 50) { 
                iconContainer.className = "mx-auto w-16 h-16 rounded-full flex items-center justify-center mb-4 text-3xl transition-colors bg-green-100 text-green-600";
                iconContainer.innerHTML = '<i data-lucide="check" class="w-8 h-8"></i>';
                sfx.success();
            } else if (choice.score === 20) {
                iconContainer.className = "mx-auto w-16 h-16 rounded-full flex items-center justify-center mb-4 text-3xl transition-colors bg-yellow-100 text-yellow-600";
                iconContainer.innerHTML = '<i data-lucide="minus" class="w-8 h-8"></i>';
                sfx.tick();
            } else {
                iconContainer.className = "mx-auto w-16 h-16 rounded-full flex items-center justify-center mb-4 text-3xl transition-colors bg-red-100 text-red-600";
                iconContainer.innerHTML = '<i data-lucide="x" class="w-8 h-8"></i>';
                sfx.error();
            }
            lucide.createIcons();
        }

        window.closeScenarioModal = () => {
            document.getElementById('scenario-modal').classList.add('hidden-modal');
            document.getElementById('scenario-modal').classList.remove('visible-modal');
            window.showPage(currentPageIndex + 1);
        }
        document.getElementById('scenario-modal-next-btn').addEventListener('click', window.closeScenarioModal);

        // --- NAVIGATION ---
        const pages = document.querySelectorAll('.page');
        const nextBtn = document.getElementById('next-button');
        const backBtn = document.getElementById('back-button');
        const progressBar = document.getElementById('flex-progress-fill');

        window.showPage = (index) => {
            if (index < 0 || index >= TOTAL_PAGES) return;
            
            pages.forEach(p => p.classList.remove('active'));
            pages[index].classList.add('active');
            currentPageIndex = index;
            
            progressBar.style.width = `${((index + 1) / TOTAL_PAGES) * 100}%`;
            document.getElementById('header-page-indicator').textContent = `${index + 1} / ${TOTAL_PAGES}`;
            
            backBtn.disabled = index === 0;
            backBtn.classList.toggle('opacity-30', index === 0);
            nextBtn.style.display = index === TOTAL_PAGES - 1 ? 'none' : 'flex';
            
            if(index === 17) calculateFinalScore();
            if(index === 0) { document.getElementById('bank-display').classList.add('hidden'); }
            else { document.getElementById('bank-display').classList.remove('hidden'); document.getElementById('bank-display').classList.add('flex'); }

            sfx.nav();
        }

        nextBtn.addEventListener('click', () => showPage(currentPageIndex + 1));
        backBtn.addEventListener('click', () => showPage(currentPageIndex - 1));

        // --- FINAL LOGIC ---
        function calculateFinalScore() {
            document.getElementById('final-score-value').textContent = `$${totalChallengeScore}`;
            const rankHeading = document.getElementById('final-rank-heading');
            const rankMessage = document.getElementById('final-rank-message');
            const btn = document.getElementById('download-badge-btn');
            
            if (totalChallengeScore >= BADGE_THRESHOLD) {
                rankHeading.textContent = "Certified Entrepreneur";
                rankHeading.className = "text-xl font-heading font-bold text-green-600 mb-2";
                rankMessage.textContent = "Outstanding. You have demonstrated the grit and strategic thinking required to build an empire.";
                document.getElementById('badge-icon').classList.replace('text-allgood-primary', 'text-green-500');
                btn.disabled = false;
                btn.classList.remove('bg-gray-300', 'cursor-not-allowed');
                btn.classList.add('bg-allgood-primary', 'hover:bg-allgood-hover', 'shadow-md');
                document.getElementById('btn-text').textContent = "Download Certification";
                window.logFinalScoreToFirestore({ finalScore: totalChallengeScore, rank: "Certified", sessionId: window.sessionId });
            } else {
                rankHeading.textContent = "Aspiring Entrepreneur";
                rankHeading.className = "text-xl font-heading font-bold text-gray-500 mb-2";
                rankMessage.textContent = `You reached $${totalChallengeScore}, but you need $${BADGE_THRESHOLD} to certify. Review your choices and try again.`;
                btn.disabled = true;
                window.logFinalScoreToFirestore({ finalScore: totalChallengeScore, rank: "Failed", sessionId: window.sessionId });
            }
            lucide.createIcons();
        }

        window.performHardReset = () => {
            totalChallengeScore = 200;
            answeredScenarioScores = {};
            document.getElementById('bank-balance').textContent = "$200";
            window.showPage(0);
        }

        window.downloadBadge = () => {
            const canvas = document.createElement('canvas'); canvas.width = 500; canvas.height = 500; const ctx = canvas.getContext('2d');
            ctx.fillStyle = "#357889"; ctx.beginPath(); ctx.arc(250, 250, 240, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = "#FFFFFF"; ctx.font = "bold 40px Arial"; ctx.textAlign = "center";
            ctx.fillText("ALLGOOD ACADEMY", 250, 150);
            ctx.fillText("CERTIFIED", 250, 250);
            ctx.fillText("ENTREPRENEUR", 250, 310);
            ctx.font = "20px Arial"; ctx.fillText(window.currentUserName.toUpperCase(), 250, 400);
            const link = document.createElement('a'); link.download = 'Jolene_Certificate.png'; link.href = canvas.toDataURL(); link.click();
        }

        // --- SYSTEM MENU LOGIC (V3 STANDARD) ---
        window.closeSystemMenu = () => { 
            const m = document.getElementById('system-menu-modal'); 
            m.classList.remove('visible-modal'); m.classList.add('hidden-modal'); 
        }
        
        window.handleSystemExit = () => { 
            window.location.href = "https://www.allgoodacademy.com"; 
        }
        
        window.handleLogOut = async () => {
             if (window.authSignOut) await window.authSignOut();
             localStorage.clear();
             window.currentUserName = "Learner";
             window.closeSystemMenu();
             window.showPage(0);
             // Return to Start Screen
             const startup = document.getElementById('startup-screen');
             startup.style.display = 'flex';
             setTimeout(() => startup.style.opacity = '1', 10);
             // Show login modal for next user
             const login = document.getElementById('login-modal');
             login.classList.remove('hidden-modal'); login.classList.add('visible-modal');
        }

        // --- FEEDBACK LOGIC ---
        window.setRating = function(n) {
            for (let i = 1; i <= 5; i++) {
                const star = document.getElementById(`star-${i}`);
                if (i <= n) { star.classList.remove('text-gray-300'); star.classList.add('text-yellow-400'); } 
                else { star.classList.add('text-gray-300'); star.classList.remove('text-yellow-400'); }
            }
            sfx.tick();
        }
        window.submitFeedback = function() {
            const feedbackText = document.getElementById('feedback-text').value;
            window.logFinalScoreToFirestore({ feedback: feedbackText, rank: "Feedback", sessionId: window.sessionId });
            document.getElementById('feedback-container').classList.add('hidden');
            document.getElementById('feedback-success').classList.remove('hidden');
            sfx.nav(); 
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            renderScenarios();
            
            // Startup
            const startup = document.getElementById('startup-screen');
            startup.addEventListener('click', () => {
                sfx.powerOn(); startup.style.opacity = '0';
                setTimeout(() => { startup.style.display = 'none'; }, 700);
                if(!window.currentUser) {
                    document.getElementById('login-modal').classList.remove('hidden-modal');
                    document.getElementById('login-modal').classList.add('visible-modal');
                }
            });

            // Home Button Long Press Logic (V3 Standard)
            const homeBtn = document.getElementById('home-button');
            let pressTimer;
            const startPress = () => { 
                pressTimer = setTimeout(() => { 
                    document.getElementById('system-menu-modal').classList.remove('hidden-modal'); 
                    document.getElementById('system-menu-modal').classList.add('visible-modal'); 
                    sfx.nav(); 
                }, 2000); 
            };
            const endPress = (e) => { 
                clearTimeout(pressTimer); 
                // If it was a short click (not hold), just go to page 0
                if(e.type === 'mouseup' || e.type === 'touchend') {
                    // Check if modal is visible to prevent click-through
                    if(document.getElementById('system-menu-modal').classList.contains('hidden-modal')) {
                        // Only nav home if we didn't just trigger the menu
                    }
                }
            };
            // Simple Click for Home
            homeBtn.addEventListener('click', () => {
                // If the modal isn't open, go home
                if(document.getElementById('system-menu-modal').classList.contains('hidden-modal')) {
                    window.showPage(0);
                }
            });

            homeBtn.addEventListener('mousedown', startPress);
            homeBtn.addEventListener('touchstart', (e) => { startPress(); }, {passive: true});
            homeBtn.addEventListener('mouseup', endPress);
            homeBtn.addEventListener('mouseleave', endPress);
            homeBtn.addEventListener('touchend', endPress);

            // Toggles
            document.getElementById('blueprint-toggle').addEventListener('click', (e) => {
                document.getElementById('screen').classList.toggle('blueprint-mode');
                e.currentTarget.classList.toggle('text-cyan-300');
                sfx.tick();
            });
            
            document.getElementById('fullscreen-toggle').addEventListener('click', (e) => {
                document.querySelector('.tablet-frame').classList.toggle('focus-mode');
                e.currentTarget.classList.toggle('text-green-300');
                sfx.tick();
            });

            document.getElementById('menu-toggle').addEventListener('click', () => {
                document.getElementById('menu-modal').classList.remove('hidden-modal');
                document.getElementById('menu-modal').classList.add('visible-modal');
                const list = document.getElementById('toc-list'); list.innerHTML = '';
                const titles = ["Cover", "Mission", ...Array.from({length:15},(_,i)=>`Scenario ${i+1}`), "Score", "Feedback"];
                titles.forEach((t, i) => {
                    list.innerHTML += `<button class="w-full text-left px-4 py-2 hover:bg-gray-100 text-gray-700 rounded text-sm" onclick="showPage(${i});document.getElementById('menu-modal').classList.add('hidden-modal');document.getElementById('menu-modal').classList.remove('visible-modal');">${i+1}. ${t}</button>`;
                });
            });
            document.getElementById('close-menu').addEventListener('click', () => { document.getElementById('menu-modal').classList.add('hidden-modal'); document.getElementById('menu-modal').classList.remove('visible-modal'); });

            // Accordion
            document.body.addEventListener('click', (e) => {
                const acc = e.target.closest('.accordion-toggle');
                if(acc) {
                    const c = acc.nextElementSibling;
                    const i = acc.querySelector('.accordion-icon');
                    c.classList.toggle('hidden');
                    if(i) i.classList.toggle('rotate-180');
                    sfx.tick();
                }
            });
        });
    </script>
</body>
</html>
