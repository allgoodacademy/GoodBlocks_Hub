<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Allgood Academy: The Closing Countdown</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Font Awesome (Legacy Support) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'allgood-primary': '#D34716',   // Burnt Orange
                        'allgood-secondary': '#357889', // Deep Cyan
                        'allgood-dark': '#4C4C4C',      // Dark Gray
                        'allgood-light': '#F7F7F7',     // Light Gray
                        'allgood-hover': '#EB8D69',     // Light Orange
                        'allgood-accent': '#2D6473',    // Darker Cyan
                    },
                    fontFamily: {
                        'heading': ['Georgia', 'serif'],
                        'body': ['Verdana', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    
    <style>
        /* --- CORE STYLES (RESTORED FROM TEMPLATE) --- */
        body {
            font-family: Verdana, sans-serif;
            background-color: #1a1a1a;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
            background-attachment: fixed;
            min-height: 100vh;
            position: relative;
            margin: 0;
            padding: 0;
        }

        h1, h2, h3, h4, h5, h6 { font-family: Georgia, serif; }

        /* --- ANIMATIONS --- */
        @keyframes pulse-glow {
            0%, 100% { 
                text-shadow: 0 0 10px rgba(211, 71, 22, 0.4); 
                transform: scale(1);
            }
            50% { 
                text-shadow: 0 0 30px rgba(211, 71, 22, 0.9), 0 0 15px rgba(211, 71, 22, 0.6); 
                transform: scale(1.02);
            }
        }
        
        .animate-pulse-glow {
            animation: pulse-glow 2.5s infinite ease-in-out;
            will-change: transform, text-shadow;
        }

        /* --- TABLET FRAME (SKEUOMORPHIC) --- */
        .tablet-frame {
            height: 80vh;
            width: auto;
            aspect-ratio: 16/10; 
            max-width: 1100px;
            max-height: 95vh;
            min-height: 0;
            min-width: 0;
            background-image: 
                radial-gradient(circle at 0% 0%, rgba(211, 71, 22, 0.35) 0%, transparent 30%),
                radial-gradient(circle at 100% 100%, rgba(211, 71, 22, 0.35) 0%, transparent 30%),
                linear-gradient(135deg, #5c5c5c 0%, #d6d6d6 25%, #8a8a8a 50%, #e0e0e0 75%, #5c5c5c 100%);
            border-radius: 12px;
            padding: 12px; 
            box-shadow: 
                inset 1px 1px 2px rgba(255,255,255, 0.6), 
                inset -1px -1px 2px rgba(0,0,0, 0.8), 
                0 30px 60px -12px rgba(0, 0, 0, 0.8), 
                0 0 0 1px #111;
            border: 1px solid #333;
            position: relative;
            margin: 20px auto;
            transition: width 0.3s, height 0.3s, padding 0.3s;
        }

        .tablet-frame::before {
            content: ''; position: absolute; top: 10px; left: 10px; right: 10px; bottom: 10px;
            border-radius: 6px; background: #111; z-index: 0;
        }

        .screen-container {
            width: 100%; height: 100%; background-color: #F7F7F7;
            position: relative; z-index: 1; overflow: hidden;
            display: flex; flex-direction: column; 
            border-radius: 4px; box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }

        /* --- SCROLLBARS --- */
        .page::-webkit-scrollbar { width: 14px; }
        .page::-webkit-scrollbar-track { background: #e5e5e5; border-left: 1px solid #d1d5db; }
        .page::-webkit-scrollbar-thumb { background-color: #D34716; border-radius: 7px; border: 3px solid #e5e5e5; }
        .page::-webkit-scrollbar-thumb:hover { background-color: #EB8D69; }

        /* --- MODALS --- */
        .modal-transition { transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out; }
        .hidden-modal { opacity: 0; pointer-events: none; transform: translateY(-10px); }
        .visible-modal { opacity: 1; pointer-events: auto; transform: translateY(0); }

        /* --- PROGRESS BAR --- */
        #flex-progress-bar { height: 4px; width: 100%; background-color: #eee; position: absolute; top: 0; left: 0; }
        #flex-progress-fill { height: 100%; background-color: #D34716; width: 0%; transition: width 0.3s ease; }

        /* --- BLUEPRINT MODE --- */
        .blueprint-mode { background-color: #0f172a !important; color: #94a3b8 !important; }
        .blueprint-mode .page { background-color: #0f172a !important; }
        .blueprint-mode h1, .blueprint-mode h2, .blueprint-mode h3, .blueprint-mode strong { color: #38bdf8 !important; }
        .blueprint-mode .bg-white { background-color: #1e293b !important; border-color: #334155 !important; color: #cbd5e1 !important; }
        .blueprint-mode .text-allgood-dark { color: #e2e8f0 !important; }
        .blueprint-mode .bg-gray-100, .blueprint-mode .bg-gray-50, .blueprint-mode .bg-gray-50 { background-color: #0f172a !important; border-color: #1e293b !important; }
        .blueprint-mode .accordion-content { background-color: #0f172a !important; border-color: #334155 !important; color: #94a3b8 !important; }
        .blueprint-mode .footer-content { background-color: #1e293b !important; border-top-color: #334155 !important; color: #94a3b8 !important; }
        .blueprint-mode .footer-content a { color: #38bdf8 !important; }
        .blueprint-mode .footer-content #back-button { color: #94a3b8 !important; }
        .blueprint-mode .footer-content #back-button:not(:disabled):hover { color: #38bdf8 !important; }

        /* --- FOCUS MODE --- */
        .tablet-frame.focus-mode { 
            position: absolute !important; top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important; 
            width: 100% !important; height: 100% !important;
            aspect-ratio: auto !important; max-width: none !important; max-height: none !important; 
            min-height: 0 !important;
            margin: 0 !important; padding: 0 !important; 
            background: #F7F7F7 !important; border: none !important; border-radius: 0 !important; 
            box-shadow: none !important; z-index: 99999 !important;
            background-image: none !important;
        }
        .tablet-frame.focus-mode::before { display: none; }
        .tablet-frame.focus-mode .screen-container { border-radius: 0; box-shadow: none; height: 100%; }
        .tablet-frame.focus-mode .footer-content { padding-bottom: 0; }
        body.is-focused main { padding: 0 !important; }

        @media (max-width: 768px) {
            body { padding: 0 !important; overflow: hidden; }
            main { padding: 0 !important; height: 100vh; }
            .tablet-frame {
                position: absolute !important; inset: 0 !important;
                width: 100% !important; height: 100% !important;
                max-width: none !important; max-height: none !important;
                min-height: 0 !important; aspect-ratio: auto !important;
                margin: 0 !important; padding: 0 !important;
                border: none !important; border-radius: 0 !important;
                background-image: none !important; box-shadow: none !important;
            }
            .tablet-frame::before { display: none; }
            .screen-container { border-radius: 0 !important; box-shadow: none !important; }
            .footer-content { padding-bottom: max(env(safe-area-inset-bottom), 20px); height: auto; }
        }

        /* --- LAYOUT --- */
        .navbar-content { flex: 0 0 60px; z-index: 20; }
        .page { flex: 1 1 auto; overflow-y: auto; padding: 20px; position: relative; display: none; width: 100%; }
        .page.active { display: block; }
        .footer-content { flex: 0 0 60px; z-index: 20; background-color: white; border-top: 1px solid #e5e7eb; position: relative; }
        
        /* --- INTERACTIVE ELEMENTS (Custom) --- */
        .flip-card { background-color: transparent; width: 100%; height: 200px; perspective: 1000px; cursor: pointer; }
        .flip-card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; }
        .flip-card.flipped .flip-card-inner { transform: rotateY(180deg); }
        .flip-card-front, .flip-card-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .flip-card-front { background-color: white; border: 1px solid #e5e7eb; }
        .flip-card-back { background-color: #357889; color: white; transform: rotateY(180deg); }

        .profile-card { transition: all 0.3s; cursor: pointer; border: 2px solid transparent; }
        .profile-card.selected { border-color: #D34716; background-color: #fff7ed; transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }

        /* Range Slider Customization */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: #D34716; cursor: pointer; margin-top: -10px; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #cbd5e1; border-radius: 2px; }
        
        /* Room Hotspot Game */
        .room-container { position: relative; width: 100%; aspect-ratio: 4/3; background-color: #f1f5f9; border: 2px solid #cbd5e1; border-radius: 8px; overflow: hidden; }
        .hotspot { position: absolute; width: 40px; height: 40px; border-radius: 50%; background: rgba(211, 71, 22, 0.2); border: 2px solid #D34716; cursor: pointer; animation: pulse 2s infinite; display: flex; items-center; justify-content: center; z-index: 10; opacity: 0.6; transition: opacity 0.2s;}
        .hotspot:hover { opacity: 1; background: rgba(211, 71, 22, 0.5); }
        .hotspot.found { background: #10b981; border-color: #059669; opacity: 1; animation: none; pointer-events: none; }
        .hotspot.found::after { content: '✓'; color: white; font-weight: bold; }

        /* Bucket Allocator */
        .cash-pile { transition: transform 0.2s; cursor: pointer; }
        .cash-pile:active { transform: scale(0.95); }
        .bucket { transition: all 0.3s; border: 2px dashed #94a3b8; }
        .bucket.filled { border-style: solid; border-color: #357889; background-color: #f0f9ff; }

    </style>
</head>
<body class="flex flex-col min-h-screen text-allgood-dark font-body overflow-y-auto">

    <main class="flex-grow flex items-center justify-center py-8">
        <div class="tablet-frame">
            <div class="screen-container" id="screen">

                <!-- 1. STARTUP SCREEN -->
                <div id="startup-screen" class="absolute inset-0 z-[300] flex flex-col items-center justify-center cursor-pointer transition-opacity duration-700 ease-in-out bg-gradient-to-br from-allgood-secondary to-allgood-accent">
                    <div class="group flex flex-col items-center justify-center text-center h-full w-full relative">
                        <div class="flex-grow flex flex-col items-center justify-center px-4">
                            <div class="relative">
                                <div class="absolute inset-0 bg-white/10 blur-2xl rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                                <h2 class="text-xl md:text-3xl font-heading font-bold text-white mb-1 relative z-10">The Closing Countdown</h2>
                                <h1 class="text-4xl md:text-6xl font-heading font-bold text-allgood-primary tracking-tighter relative z-10 drop-shadow-md animate-pulse-glow">GoodBlock</h1>
                            </div>
                            <p class="mt-12 text-white/80 text-xs tracking-[0.3em] uppercase font-medium group-hover:text-white transition-colors animate-pulse font-body">Click to Power Up</p>
                        </div>
                        <div class="absolute bottom-10 w-full text-center">
                            <p class="text-white/40 text-xs font-body tracking-wide">Powered by the <span class="text-white/60 font-bold">Allgood Academy</span></p>
                        </div>
                    </div>
                </div>

                <!-- 2. Header -->
                <header class="bg-allgood-secondary shadow-md navbar-content flex items-center">
                    <div class="w-full px-4 flex items-center justify-between h-full">
                        <div class="flex items-center overflow-hidden">
                            <div id="header-welcome-text" class="flex-shrink-0 text-white font-heading font-bold text-lg tracking-tight truncate mr-4 select-none">Welcome: Learner</div>
                            <!-- RESTORED: Page Counter from Template -->
                            <div class="hidden sm:flex items-center bg-black/20 rounded-full px-3 py-1 border border-white/10 shadow-inner backdrop-blur-sm">
                                <span class="text-[10px] uppercase tracking-wider text-white/60 mr-2 font-heading font-bold">Page</span>
                                <span id="header-page-indicator" class="text-xs font-bold text-white font-body tabular-nums">1 / 21</span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-1 shrink-0 relative">
                            <!-- Controls (Template SVGs) -->
                            <button id="home-button" class="text-gray-200 hover:text-white transition-colors p-2 rounded-full hover:bg-white/10 mr-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg></button>
                            <div class="h-6 w-px bg-white/20 mx-1"></div>
                            <button id="blueprint-toggle" class="text-gray-200 hover:text-cyan-300 transition-colors p-2 rounded-full hover:bg-white/10"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg></button>
                            <button id="fullscreen-toggle" class="text-gray-200 hover:text-green-300 transition-colors p-2 rounded-full hover:bg-white/10"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" /></svg></button>
                            <button id="menu-toggle" class="text-gray-200 hover:text-white transition-colors p-2 rounded-full hover:bg-white/10"><svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg></button>
                        </div>
                    </div>
                </header>

                <!-- 3. Login Modal -->
                <div id="login-modal" class="absolute inset-0 z-[200] bg-allgood-dark/95 flex items-center justify-center p-6 visible-modal modal-transition">
                    <div class="bg-white rounded-lg shadow-2xl p-8 max-w-sm w-full text-center border-t-4 border-allgood-primary">
                        <div class="mb-6"><h2 class="text-3xl font-heading font-bold text-allgood-dark">Allgood<span class="text-allgood-primary">Academy</span></h2></div>
                        <h2 class="text-xl font-bold text-allgood-dark mb-2 font-heading">Welcome</h2>
                        <div class="flex items-center justify-center gap-2 mb-6 relative">
                            <p class="text-gray-500 text-sm font-body">Please sign in to start.</p>
                            <button id="policy-trigger" class="group relative flex items-center text-allgood-primary hover:text-allgood-hover transition-colors focus:outline-none">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                                <span class="text-xs font-bold underline decoration-dotted underline-offset-2">Why?</span>
                                <div class="absolute top-full left-1/2 transform -translate-x-1/2 mt-3 w-64 p-3 bg-gray-800 text-white text-xs text-left rounded shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible group-focus:opacity-100 group-focus:visible transition-all duration-200 z-50 font-body leading-relaxed border border-gray-700 pointer-events-none">
                                    <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-b-gray-800"></div>
                                    <strong class="block text-allgood-primary mb-1 uppercase tracking-wide text-[10px]">Why do we ask?</strong>
                                    <p class="mb-2 text-gray-300">We use your name to personalize your badge. Performance data is logged in real-time to improve the GoodBlock experience. All personal data is kept confidential and never sold.</p>
                                    <div class="border-t border-gray-700 my-1 pt-1"></div>
                                    <p class="text-gray-300"><strong>Email (Optional):</strong> Enter to join the Allgood Academy community.</p>
                                </div>
                            </button>
                        </div>
                        <input type="text" id="user-name-input" placeholder="Your Name (Optional)" class="w-full border border-gray-300 rounded p-3 mb-3 focus:ring-2 focus:ring-allgood-primary focus:border-transparent outline-none transition-all font-body">
                        <input type="email" id="user-email-input" placeholder="Your Email (Optional)" class="w-full border border-gray-300 rounded p-3 mb-6 focus:ring-2 focus:ring-allgood-primary focus:border-transparent outline-none transition-all font-body">
                        <button id="start-session-btn" class="w-full bg-allgood-primary hover:bg-allgood-hover text-white font-bold py-3 rounded shadow-md transition-transform transform hover:scale-[1.02] active:scale-[0.98] font-body">Start GoodBlock</button>
                    </div>
                </div>

                <!-- 5. Menu Modal -->
                <div id="menu-modal" class="hidden-modal absolute inset-0 z-[100] bg-black/60 flex justify-end modal-transition">
                    <div class="w-72 h-full bg-white shadow-xl flex flex-col border-l border-gray-200">
                        <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                            <span class="font-bold text-allgood-dark font-heading">Project Phases</span>
                            <button id="close-menu" class="text-gray-500 hover:text-allgood-primary"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
                        </div>
                        <div class="p-2 overflow-y-auto flex-grow space-y-1 text-sm font-body" id="toc-list">
                            <!-- Injected via JS -->
                        </div>
                    </div>
                </div>

                <!-- --- PAGES START --- -->

                <!-- Page 1: Cover -->
                <div class="page active" id="page-1">
                    <div class="flex flex-col items-center justify-center h-full text-center px-6">
                        <div class="mb-6"><h2 class="text-2xl font-heading font-bold text-allgood-dark">Allgood<span class="text-allgood-primary">Academy</span></h2></div>
                        <h1 class="text-4xl sm:text-5xl font-heading font-bold text-allgood-dark mb-4 leading-tight">The Closing<br><span class="text-allgood-primary">Countdown</span></h1>
                        
                        <!-- MOVED: Day Counter (Context) -->
                        <div class="inline-block bg-allgood-secondary text-white px-4 py-1 rounded-full text-xs font-bold uppercase tracking-widest mb-4 shadow-sm">
                            Day 100: Project Kickoff
                        </div>

                        <p class="text-lg text-gray-600 mb-8 max-w-md">100 Days. One Goal. The Keys.</p>
                        <p class="text-sm text-allgood-primary font-bold mb-12 animate-pulse">Initialize the simulation to begin your timeline.</p>

                        <!-- How To Use Accordion -->
                        <div class="w-full max-w-lg text-left mx-auto">
                            <button class="accordion-toggle w-full bg-white border border-gray-200 p-4 rounded-lg shadow-md flex justify-between items-center hover:bg-gray-50 hover:border-allgood-primary transition-all group">
                                <span class="font-bold text-allgood-dark text-base group-hover:text-allgood-primary transition-colors font-heading">How to use this GoodBlock</span>
                                <svg class="accordion-icon h-5 w-5 text-gray-400 transform transition-transform duration-300 group-hover:text-allgood-primary" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            </button>
                            <div class="accordion-content hidden bg-gray-50 border-x border-b border-gray-200 rounded-b-lg p-5 text-gray-600 shadow-inner text-xs font-body">
                                <p class="mb-4 text-sm text-allgood-dark">This GoodBlock is your interactive workspace. Use the <strong>Control Cluster</strong> in the top right to customize your environment.</p>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div class="flex items-start"><div class="p-1.5 bg-white rounded border border-gray-300 mr-3 text-allgood-primary"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg></div><div><strong class="text-allgood-dark block mb-0.5">Home & Reset</strong><span class="text-gray-500 leading-snug">Click to return to cover. <strong>Hold for 2s</strong> to hard reset & sign out.</span></div></div>
                                    <div class="flex items-start"><div class="p-1.5 bg-white rounded border border-gray-300 mr-3 text-cyan-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg></div><div><strong class="text-allgood-dark block mb-0.5">Blueprint Mode</strong><span class="text-gray-500 leading-snug">Toggle high-contrast Dark Mode for low-light environments.</span></div></div>
                                    <div class="flex items-start"><div class="p-1.5 bg-white rounded border border-gray-300 mr-3 text-green-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" /></svg></div><div><strong class="text-allgood-dark block mb-0.5">Focus Mode</strong><span class="text-gray-500 leading-snug">Maximize workspace. Removes the frame for mobile devices.</span></div></div>
                                    <div class="flex items-start"><div class="p-1.5 bg-white rounded border border-gray-300 mr-3 text-allgood-dark"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg></div><div><strong class="text-allgood-dark block mb-0.5">Table of Contents</strong><span class="text-gray-500 leading-snug">Jump directly to any section without losing progress.</span></div></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Page 2: Scope (3-Column Flip Tiles) -->
                <div class="page" id="page-2">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark">The Briefing</h2></section>
                    
                    <p class="mb-6 text-sm text-gray-600"><strong>Narrative:</strong> You are the Project Manager of your own financial future. The market is volatile. The seller is impatient. The bank is strict.</p>
                    <p class="mb-4 text-sm font-bold text-allgood-primary"><strong>Instruction:</strong> Review your three operational fronts. Click each file to unlock the mission details.</p>

                    <!-- 3-Column Mission Tiles -->
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <!-- Card 1 -->
                        <div class="flip-card" onclick="this.classList.toggle('flipped')">
                            <div class="flip-card-inner">
                                <div class="flip-card-front">
                                    <i data-lucide="file-text" class="w-8 h-8 text-allgood-secondary mb-2"></i>
                                    <h3 class="font-bold text-sm uppercase tracking-wide">The Paper Chase</h3>
                                    <p class="text-xs text-gray-400 mt-1">Phase I: Days 90–60</p>
                                </div>
                                <div class="flip-card-back bg-allgood-secondary text-white">
                                    <h3 class="font-bold text-sm mb-2">The Financial War</h3>
                                    <ul class="text-xs text-left list-disc pl-4 space-y-1">
                                        <li>Secure Loan Approval</li>
                                        <li>Battle Rising Rates</li>
                                        <li>Pass DTI Stress Test</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Card 2 -->
                        <div class="flip-card" onclick="this.classList.toggle('flipped')">
                            <div class="flip-card-inner">
                                <div class="flip-card-front">
                                    <i data-lucide="search" class="w-8 h-8 text-allgood-primary mb-2"></i>
                                    <h3 class="font-bold text-sm uppercase tracking-wide">The Field Op</h3>
                                    <p class="text-xs text-gray-400 mt-1">Phase II: Days 60–30</p>
                                </div>
                                <div class="flip-card-back bg-allgood-primary text-white">
                                    <h3 class="font-bold text-sm mb-2">The Physical Exam</h3>
                                    <ul class="text-xs text-left list-disc pl-4 space-y-1">
                                        <li>Audit the Property</li>
                                        <li>Expose Hidden Rot</li>
                                        <li>Win the Bidding War</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Card 3 -->
                        <div class="flip-card" onclick="this.classList.toggle('flipped')">
                            <div class="flip-card-inner">
                                <div class="flip-card-front">
                                    <i data-lucide="droplet" class="w-8 h-8 text-green-600 mb-2"></i>
                                    <h3 class="font-bold text-sm uppercase tracking-wide">The Cash Crunch</h3>
                                    <p class="text-xs text-gray-400 mt-1">Phase III: Days 30–0</p>
                                </div>
                                <div class="flip-card-back bg-green-600 text-white">
                                    <h3 class="font-bold text-sm mb-2">The Final Mile</h3>
                                    <ul class="text-xs text-left list-disc pl-4 space-y-1">
                                        <li>Allocate Liquid Cash</li>
                                        <li>Cover Closing Costs</li>
                                        <li>Survive Day 1 Repairs</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <p class="text-center text-xs text-gray-400 mt-6 italic">Before we look at houses, we must look at <em>you</em>.</p>
                </div>

                <!-- Page 3: Risk Profile -->
                <div class="page" id="page-3">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark">Set Your Strategy</h2></section>
                    <div class="mb-6">
                        <p class="text-sm text-gray-600 mb-2"><strong>Narrative:</strong> How will you fund this operation? Cash is safety, but leverage is power. Your choice here determines how fragile your deal will be later.</p>
                        <p class="text-sm text-allgood-primary font-bold"><strong>Instruction:</strong> Select your financial personality. This sets your baseline for stress.</p>
                    </div>
                    <div class="grid grid-cols-1 gap-4">
                        <div class="profile-card bg-white p-4 rounded shadow-sm border border-gray-200 flex items-center justify-between" onclick="selectProfile('Conservative')">
                            <div>
                                <h3 class="font-bold text-allgood-secondary">The Saver (Conservative)</h3>
                                <p class="text-xs text-gray-500">20% Down Payment. Low monthly cost. High initial cash need.</p>
                            </div>
                            <i data-lucide="shield" class="w-6 h-6 text-gray-400"></i>
                        </div>
                        <div class="profile-card bg-white p-4 rounded shadow-sm border border-gray-200 flex items-center justify-between" onclick="selectProfile('Realistic')">
                            <div>
                                <h3 class="font-bold text-allgood-secondary">The Balancer (Realistic)</h3>
                                <p class="text-xs text-gray-500">10% Down Payment. Moderate PMI. Flexible cash.</p>
                            </div>
                            <i data-lucide="scale" class="w-6 h-6 text-gray-400"></i>
                        </div>
                        <div class="profile-card bg-white p-4 rounded shadow-sm border border-gray-200 flex items-center justify-between" onclick="selectProfile('Aggressive')">
                            <div>
                                <h3 class="font-bold text-allgood-secondary">The Sprinter (Aggressive)</h3>
                                <p class="text-xs text-gray-500">3.5% Down (FHA). Keep cash liquid. Higher monthly payment.</p>
                            </div>
                            <i data-lucide="zap" class="w-6 h-6 text-gray-400"></i>
                        </div>
                    </div>
                    <p id="profile-feedback" class="text-center text-sm font-bold text-allgood-primary mt-6 h-6"></p>
                    <p class="text-center text-xs text-gray-400 mt-2 italic hidden" id="bridge-p3">Strategy set. Now, let's see if the market agrees with your budget.</p>
                </div>

                <!-- NEW: Phase I Video Intro -->
                <div class="page" id="page-video-1">
                    <section class="mb-6 border-b border-gray-200 pb-4">
                        <h2 class="text-2xl font-heading font-bold text-allgood-dark">Phase I: The Paper Chase</h2>
                        <div class="text-xs font-bold text-white bg-allgood-secondary px-2 py-0.5 rounded inline-block mt-1">Day 90: Briefing</div>
                    </section>
                    
                    <p class="text-sm text-gray-600 mb-6"><strong>Intel:</strong> Before you can buy, you must prove you can pay. This phase is about securing your capital against market volatility.</p>

                    <!-- Video Placeholder -->
                    <div class="aspect-w-16 aspect-h-9 bg-black rounded-lg mb-6 flex items-center justify-center shadow-lg border border-gray-700 relative overflow-hidden group cursor-pointer">
                        <div class="absolute inset-0 bg-gradient-to-tr from-black/80 to-transparent"></div>
                        <div class="text-center relative z-10">
                            <i data-lucide="play-circle" class="w-16 h-16 text-allgood-primary opacity-80 mx-auto mb-2 group-hover:scale-110 transition-transform"></i>
                            <p class="text-white/80 text-xs uppercase tracking-widest font-bold">Watch Mission Briefing</p>
                        </div>
                    </div>

                    <p class="text-center text-xs text-gray-400 italic">Proceed when ready to engage the market.</p>
                </div>

                <!-- Page 4: Rate Shock -->
                <div class="page" id="page-4">
                    <section class="mb-4 border-b border-gray-200 pb-2">
                        <h2 class="text-2xl font-heading font-bold text-allgood-dark">The External Threat</h2>
                        <div class="text-xs font-bold text-white bg-allgood-secondary px-2 py-0.5 rounded inline-block mt-1">Day 90: Funding Phase</div>
                    </section>
                    
                    <!-- Narrative Block -->
                    <div class="bg-blue-50 p-4 rounded border-l-4 border-allgood-secondary mb-6 shadow-sm">
                        <p class="text-sm text-gray-700 mb-2"><strong>Context:</strong> You found the perfect home listed at $350k. But the Fed just met, and rates are moving.</p>
                        <p class="text-sm text-allgood-primary font-bold"><strong>Instruction:</strong> Slide the rate to see how a 1% hike impacts your buying power. Find the 'Breaking Point' where you pay more in interest than equity.</p>
                    </div>

                    <div class="bg-white p-6 rounded shadow-sm border border-gray-200 text-center">
                        <p class="text-xs text-gray-500 mb-1">Loan Amount</p>
                        <div class="text-2xl font-bold text-gray-800 mb-6">$350,000</div>
                        
                        <label class="block text-sm font-bold text-allgood-dark mb-4">Interest Rate: <span id="rate-display" class="text-allgood-primary text-xl">5.0%</span></label>
                        <input type="range" min="30" max="85" value="50" id="rate-slider" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer mb-8">
                        
                        <div class="bg-gray-100 p-4 rounded-lg">
                            <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Monthly Principal & Interest</p>
                            <div id="payment-display" class="text-4xl font-bold text-allgood-dark">$1,879</div>
                        </div>
                        
                        <!-- Dynamic Narrative Feedback -->
                        <div id="rate-narrative" class="mt-4 text-sm font-medium min-h-[40px] flex items-center justify-center">
                            <span class="text-green-600">Standard market rate. Buying power is stable.</span>
                        </div>
                    </div>
                    <p class="text-center text-xs text-gray-400 mt-4 italic">The monthly payment is only half the battle. The bank isn't just looking at the house; they are looking at <em>your</em> other debts.</p>
                </div>

                <!-- Page 5: DTI Input -->
                <div class="page" id="page-5">
                    <section class="mb-4 border-b border-gray-200 pb-2">
                        <h2 class="text-2xl font-heading font-bold text-allgood-dark">The Internal Threat</h2>
                        <div class="text-xs font-bold text-white bg-allgood-secondary px-2 py-0.5 rounded inline-block mt-1">Day 85: Qualification</div>
                    </section>
                    
                    <!-- Narrative Block -->
                    <div class="bg-blue-50 p-4 rounded border-l-4 border-allgood-secondary mb-6 shadow-sm">
                        <p class="text-sm text-gray-700 mb-2"><strong>Context:</strong> The Underwriter paused your file. That $600 car lease you signed last month? It might kill the deal.</p>
                        <p class="text-sm text-allgood-primary font-bold"><strong>Instruction:</strong> Input your Income vs. Debts. The bank adds a stress-test mortgage payment of <strong>$2,500</strong> to see if you break.</p>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1">Gross Monthly Income (Pre-Tax)</label>
                            <div class="relative">
                                <span class="absolute left-3 top-2.5 text-gray-400">$</span>
                                <input type="number" id="income-input" class="w-full pl-8 p-2 border border-gray-300 rounded focus:border-allgood-primary outline-none" placeholder="e.g. 6000">
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1">Monthly Debt Payments (Cars, Cards, Loans)</label>
                            <div class="relative">
                                <span class="absolute left-3 top-2.5 text-gray-400">$</span>
                                <input type="number" id="debt-input" class="w-full pl-8 p-2 border border-gray-300 rounded focus:border-allgood-primary outline-none" placeholder="e.g. 500">
                            </div>
                        </div>
                         <!-- Added Visualization of the Hidden Mortgage -->
                        <div class="p-3 bg-gray-100 rounded border border-gray-200 text-center">
                            <p class="text-xs text-gray-500 uppercase tracking-wide">Bank's Stress Test Mortgage</p>
                            <p class="text-lg font-bold text-gray-800">+ $2,500 / month</p>
                        </div>

                        <button onclick="calculateDTI()" class="w-full bg-allgood-secondary hover:bg-allgood-accent text-white font-bold py-3 rounded shadow mt-4">Run Qualification Check</button>
                    </div>
                </div>

                <!-- Page 6: Approval Letter -->
                <div class="page" id="page-6">
                    <div class="flex flex-col items-center justify-center h-full">
                        <div id="dti-result-card" class="bg-white p-8 rounded-xl shadow-lg border text-center w-full max-w-md">
                            <div id="dti-icon" class="mb-4"></div>
                            <h2 id="dti-status" class="text-2xl font-bold mb-2 font-heading"></h2>
                            
                            <!-- Detailed Breakdown Added Here -->
                            <div class="bg-gray-50 p-3 rounded mb-4 text-left space-y-1 text-xs text-gray-600 border border-gray-200">
                                <div class="flex justify-between"><span>Your Debt (Car/Cards):</span><span id="res-user-debt" class="font-bold">$0</span></div>
                                <div class="flex justify-between text-allgood-primary"><span>+ Stress Mortgage Est.:</span><span class="font-bold">$2,500</span></div>
                                <div class="border-t border-gray-300 my-1"></div>
                                <div class="flex justify-between font-bold text-gray-800"><span>Total Monthly Liability:</span><span id="res-total-debt">$2,500</span></div>
                                <div class="flex justify-between"><span>Income:</span><span id="res-income">$0</span></div>
                            </div>

                            <p class="text-sm text-gray-600 mb-4">Your Debt-to-Income Ratio is <span id="dti-value" class="font-bold"></span>%</p>
                            <div class="w-full bg-gray-200 rounded-full h-4 mb-6 overflow-hidden">
                                <div id="dti-bar" class="h-4 rounded-full transition-all duration-1000 ease-out" style="width: 0%"></div>
                            </div>
                            <p id="dti-message" class="text-xs leading-relaxed mb-4"></p>
                            <div class="border-t border-gray-200 pt-4">
                                <p class="text-xs text-gray-500 italic">"You passed the math test. Now you get the 'Golden Ticket'. But just because the bank <em>gives</em> you $500k, doesn't mean you should <em>spend</em> it."</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Page 7: Budget Quiz -->
                <div class="page" id="page-7">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark">Budget Discipline</h2></section>
                    
                    <!-- Narrative Block -->
                    <div class="bg-white p-6 rounded shadow-sm border border-gray-200 mb-6">
                        <p class="text-sm text-gray-700 mb-2"><strong>Context (Day 70):</strong> You find a stunning home at the absolute top of your approval limit ($490k). The agent says, 'It's a forever home!'</p>
                        <p class="text-sm text-allgood-primary font-bold mb-4"><strong>Instruction:</strong> Decide: Stretch the budget (and live on ramen) or stay conservative to keep cash for repairs?</p>
                        
                        <div class="space-y-3">
                            <button class="w-full text-left p-3 border border-gray-200 rounded hover:bg-gray-50 text-sm" onclick="budgetCheck(false)">Stretch the budget. It's a forever home.</button>
                            <button class="w-full text-left p-3 border border-gray-200 rounded hover:bg-gray-50 text-sm" onclick="budgetCheck(true)">Stick to the $400k limit. Being "house poor" is risky.</button>
                        </div>
                        <p id="budget-feedback" class="mt-4 text-xs font-bold"></p>
                    </div>
                    <p class="text-center text-xs text-gray-400 italic">Budget locked. Now we go into the field. It looks pretty on the surface, but what's underneath?</p>
                </div>

                <!-- NEW: Phase II Video Intro -->
                <div class="page" id="page-video-2">
                    <section class="mb-6 border-b border-gray-200 pb-4">
                        <h2 class="text-2xl font-heading font-bold text-allgood-dark">Phase II: The Field Op</h2>
                        <div class="text-xs font-bold text-white bg-allgood-primary px-2 py-0.5 rounded inline-block mt-1">Day 60: Briefing</div>
                    </section>
                    
                    <p class="text-sm text-gray-600 mb-6"><strong>Intel:</strong> Paperwork is done. Now we hit the ground. Your objective is to validate the asset and win the contract without overpaying.</p>

                    <!-- Video Placeholder -->
                    <div class="aspect-w-16 aspect-h-9 bg-black rounded-lg mb-6 flex items-center justify-center shadow-lg border border-gray-700 relative overflow-hidden group cursor-pointer">
                        <div class="absolute inset-0 bg-gradient-to-tr from-black/80 to-transparent"></div>
                        <div class="text-center relative z-10">
                            <i data-lucide="play-circle" class="w-16 h-16 text-allgood-primary opacity-80 mx-auto mb-2 group-hover:scale-110 transition-transform"></i>
                            <p class="text-white/80 text-xs uppercase tracking-widest font-bold">Watch Mission Briefing</p>
                        </div>
                    </div>

                    <p class="text-center text-xs text-gray-400 italic">Boots on the ground.</p>
                </div>

                <!-- Page 8: Property Audit -->
                <div class="page" id="page-8">
                    <section class="mb-4 border-b border-gray-200 pb-2 flex justify-between items-center">
                        <div>
                            <h2 class="text-2xl font-heading font-bold text-allgood-dark">The Inspection</h2>
                            <div class="text-xs font-bold text-white bg-allgood-secondary px-2 py-0.5 rounded inline-block mt-1">Day 60: Field Op</div>
                        </div>
                        <span class="text-xs bg-gray-200 px-2 py-1 rounded">Found: <span id="audit-count">0</span>/5</span>
                    </section>
                    
                    <!-- Context Header -->
                    <div class="bg-blue-50 p-3 rounded border-l-4 border-allgood-secondary mb-4 shadow-sm">
                        <p class="text-sm text-gray-700 mb-1"><strong>Context:</strong> Open House. The staging furniture is beautiful. It's a trap.</p>
                        <p class="text-sm text-allgood-primary font-bold"><strong>Instruction:</strong> Ignore the sofa. Tap the 5 structural red flags that cost real money. If you miss them now, you pay for them later.</p>
                    </div>

                    <!-- CSS Room - No Images -->
                    <div class="room-container shadow-inner">
                        <!-- Wall -->
                        <div class="absolute inset-x-0 top-0 h-2/3 bg-slate-100 border-b border-slate-300"></div>
                        <!-- Floor -->
                        <div class="absolute inset-x-0 bottom-0 h-1/3 bg-[#e2e8f0] bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDQwIDQwIiBmaWxsPSJub25lIiBzdHJva2U9IiNjYmQ1ZTEiPjxwYXRoIGQ9Ik0wIDIwaDQwTTIwIDB2NDAiLz48L3N2Zz4=')]"></div>
                        
                        <!-- Elements -->
                        <div class="absolute top-10 left-10 w-20 h-32 bg-white border-4 border-gray-300 rounded shadow-sm flex items-center justify-center">
                            <div class="w-full h-full bg-blue-50 opacity-30"></div> <!-- Window -->
                        </div>
                        
                        <!-- Hotspots -->
                        <div class="hotspot" style="top: 15%; left: 15%;" onclick="foundFlag(this, 'Water Stain')"><i data-lucide="droplets" class="w-5 h-5 text-allgood-primary"></i></div>
                        <div class="hotspot" style="bottom: 25%; right: 20%;" onclick="foundFlag(this, 'Uneven Floor')"><i data-lucide="move-vertical" class="w-5 h-5 text-allgood-primary"></i></div>
                        <div class="hotspot" style="top: 40%; right: 40%;" onclick="foundFlag(this, 'Old Outlet')"><i data-lucide="plug" class="w-5 h-5 text-allgood-primary"></i></div>
                        <div class="hotspot" style="top: 5%; right: 5%;" onclick="foundFlag(this, 'Crack')"><i data-lucide="activity" class="w-5 h-5 text-allgood-primary"></i></div>
                        <div class="hotspot" style="bottom: 10%; left: 40%;" onclick="foundFlag(this, 'HVAC Noise')"><i data-lucide="wind" class="w-5 h-5 text-allgood-primary"></i></div>
                    </div>
                    <p id="audit-msg" class="text-center text-xs font-bold text-green-600 mt-2 min-h-[20px]"></p>
                    <p id="audit-bridge" class="text-center text-xs text-gray-400 mt-2 italic hidden">You spotted the flaws. Now, we need to put a price tag on them.</p>
                </div>

                <!-- Page 9: Cost vs Value -->
                <div class="page" id="page-9">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark">Surface vs. Structure</h2></section>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div class="flip-card" onclick="this.classList.toggle('flipped')">
                            <div class="flip-card-inner">
                                <div class="flip-card-front">
                                    <i data-lucide="paint-bucket" class="w-8 h-8 text-blue-500 mb-2"></i>
                                    <h3 class="font-bold text-sm">Fresh Paint</h3>
                                    <p class="text-xs text-gray-400">Cost: $500</p>
                                </div>
                                <div class="flip-card-back bg-red-500">
                                    <h3 class="font-bold text-sm">Hides Mold</h3>
                                    <p class="text-xs mt-2">Risk: $5,000 Remediation</p>
                                </div>
                            </div>
                        </div>
                        <div class="flip-card" onclick="this.classList.toggle('flipped')">
                            <div class="flip-card-inner">
                                <div class="flip-card-front">
                                    <i data-lucide="flower" class="w-8 h-8 text-green-500 mb-2"></i>
                                    <h3 class="font-bold text-sm">New Landscaping</h3>
                                    <p class="text-xs text-gray-400">Cost: $200</p>
                                </div>
                                <div class="flip-card-back bg-red-500">
                                    <h3 class="font-bold text-sm">Poor Grading</h3>
                                    <p class="text-xs mt-2">Risk: Flooded Basement ($10k+)</p>
                                </div>
                            </div>
                        </div>
                        <div class="flip-card" onclick="this.classList.toggle('flipped')">
                            <div class="flip-card-inner">
                                <div class="flip-card-front">
                                    <i data-lucide="sofa" class="w-8 h-8 text-purple-500 mb-2"></i>
                                    <h3 class="font-bold text-sm">Modern Staging</h3>
                                    <p class="text-xs text-gray-400">Cost: $0 (Rental)</p>
                                </div>
                                <div class="flip-card-back bg-red-500">
                                    <h3 class="font-bold text-sm">Distraction</h3>
                                    <p class="text-xs mt-2">Makes small rooms look big.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <p class="text-center text-xs text-gray-400 mt-6 italic">The repair list is long. You want to negotiate repairs, but there's a problem: Competition.</p>
                </div>

                <!-- Page 10: Contingency Kill -->
                <div class="page" id="page-10">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark">The Bidding War</h2></section>
                    <div class="bg-white p-6 rounded shadow-sm border-l-4 border-yellow-500">
                        <p class="text-sm text-gray-700 mb-2"><strong>Context:</strong> There are 5 other offers. The seller says: 'Waive the inspection, and the house is yours right now.'</p>
                        <p class="text-sm text-allgood-primary font-bold mb-6"><strong>Instruction:</strong> Do you sign the waiver to win, or walk away to stay safe? This is the moment most buyers panic.</p>

                        <div class="space-y-3">
                            <button class="w-full bg-gray-50 hover:bg-red-50 border border-gray-200 p-3 rounded text-left text-sm transition-colors" onclick="contingencyResult('waive')">
                                <span class="font-bold block text-gray-800">Sign the Waiver</span>
                                <span class="text-xs text-gray-500">Win the house, take the risk.</span>
                            </button>
                            <button class="w-full bg-gray-50 hover:bg-green-50 border border-gray-200 p-3 rounded text-left text-sm transition-colors" onclick="contingencyResult('keep')">
                                <span class="font-bold block text-gray-800">Keep Inspection</span>
                                <span class="text-xs text-gray-500">Risk losing the house, protect the wallet.</span>
                            </button>
                        </div>
                        <p id="contingency-feedback" class="mt-4 text-xs font-bold"></p>
                    </div>
                    <p class="text-center text-xs text-gray-400 mt-6 italic hidden" id="contingency-bridge">Offer Accepted. The contract is signed. But the hardest part isn't finding the house... it's paying for it.</p>
                </div>

                <!-- NEW: Phase III Video Intro -->
                <div class="page" id="page-video-3">
                    <section class="mb-6 border-b border-gray-200 pb-4">
                        <h2 class="text-2xl font-heading font-bold text-allgood-dark">Phase III: The Cash Crunch</h2>
                        <div class="text-xs font-bold text-white bg-green-600 px-2 py-0.5 rounded inline-block mt-1">Day 30: Briefing</div>
                    </section>
                    
                    <p class="text-sm text-gray-600 mb-6"><strong>Intel:</strong> The contract is signed, but the deal isn't closed. Liquidity is now your primary constraint.</p>

                    <!-- Video Placeholder -->
                    <div class="aspect-w-16 aspect-h-9 bg-black rounded-lg mb-6 flex items-center justify-center shadow-lg border border-gray-700 relative overflow-hidden group cursor-pointer">
                        <div class="absolute inset-0 bg-gradient-to-tr from-black/80 to-transparent"></div>
                        <div class="text-center relative z-10">
                            <i data-lucide="play-circle" class="w-16 h-16 text-allgood-primary opacity-80 mx-auto mb-2 group-hover:scale-110 transition-transform"></i>
                            <p class="text-white/80 text-xs uppercase tracking-widest font-bold">Watch Mission Briefing</p>
                        </div>
                    </div>

                    <p class="text-center text-xs text-gray-400 italic">Check your balances.</p>
                </div>

                <!-- Page 11: The Pivot (Phase III Intro) -->
                <div class="page" id="page-11">
                    <div class="flex flex-col items-center justify-center h-full px-6 text-center">
                        <div class="bg-allgood-secondary text-white p-6 rounded-full w-32 h-32 flex items-center justify-center shadow-lg mb-6">
                            <i data-lucide="dollar-sign" class="w-16 h-16"></i>
                        </div>
                        <h2 class="text-2xl font-heading font-bold text-allgood-dark mb-4">Phase III: The Cash Crunch</h2>
                        <p class="text-gray-600 mb-6">The loan is approved. The inspection is done. Now comes the <strong>"Cash to Close"</strong>.</p>
                        <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-lg">
                            <p class="text-sm text-yellow-800 italic">"Most first-time buyers think the Down Payment is the only check they write. They are wrong."</p>
                        </div>
                        <p class="text-xs text-gray-400 mt-8 italic">Let's look at your actual bank account versus the bill.</p>
                    </div>
                </div>

                <!-- Page 12: The Final Tally (Bucket Allocator) -->
                <div class="page" id="page-12">
                    <section class="mb-4 border-b border-gray-200 pb-2">
                        <h2 class="text-2xl font-heading font-bold text-allgood-dark">The Reality Check</h2>
                        <div class="text-xs font-bold text-white bg-allgood-secondary px-2 py-0.5 rounded inline-block mt-1">Day 10: Cash to Close</div>
                    </section>
                    
                    <!-- Context Header -->
                    <div class="bg-blue-50 p-3 rounded border-l-4 border-allgood-secondary mb-4 shadow-sm">
                         <p class="text-sm text-gray-700 mb-1"><strong>Context:</strong> The Closing Disclosure (CD) arrived. You have $50,000 in the bank.</p>
                        <p class="text-sm text-allgood-primary font-bold"><strong>Instruction:</strong> Fill the buckets. You must pay the Down Payment ($35k) AND the Closing Costs ($12k). Do not run out of cash.</p>
                    </div>

                    <div class="flex justify-center mb-6">
                        <div class="cash-pile bg-green-100 border-2 border-green-500 rounded-lg p-4 text-center w-32" onclick="fillBucket()">
                            <i data-lucide="banknote" class="w-8 h-8 text-green-600 mx-auto mb-1"></i>
                            <div class="text-xs font-bold text-green-800">Savings</div>
                            <div id="cash-display" class="text-sm font-bold">$50,000</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div id="bucket-down" class="bucket bg-white p-3 rounded text-center">
                            <div class="text-xs font-bold text-gray-500">Down Payment</div>
                            <div class="text-sm text-allgood-primary font-bold mt-1" id="val-down">$0</div>
                            <div class="text-[10px] text-gray-400">Target: $30k</div>
                        </div>
                        <div id="bucket-closing" class="bucket bg-white p-3 rounded text-center">
                            <div class="text-xs font-bold text-gray-500">Closing Costs</div>
                            <div class="text-sm text-allgood-primary font-bold mt-1" id="val-closing">$0</div>
                            <div class="text-[10px] text-gray-400">Target: $10k</div>
                        </div>
                        <div id="bucket-reserves" class="bucket bg-white p-3 rounded text-center">
                            <div class="text-xs font-bold text-gray-500">Reserves</div>
                            <div class="text-sm text-allgood-primary font-bold mt-1" id="val-reserves">$0</div>
                            <div class="text-[10px] text-gray-400">Target: $5k</div>
                        </div>
                        <div id="bucket-moving" class="bucket bg-white p-3 rounded text-center">
                            <div class="text-xs font-bold text-gray-500">Moving/Pizza</div>
                            <div class="text-sm text-allgood-primary font-bold mt-1" id="val-moving">$0</div>
                            <div class="text-[10px] text-gray-400">Target: $2k</div>
                        </div>
                    </div>
                    <p id="bucket-bridge" class="text-center text-xs text-gray-400 mt-4 italic hidden">You barely scraped by. But did you leave anything for <em>after</em> you move in?</p>
                </div>

                <!-- Page 13: The Shortfall -->
                <div class="page" id="page-13">
                    <section class="mb-4 border-b border-gray-200 pb-2">
                        <h2 class="text-2xl font-heading font-bold text-allgood-dark">The Lesson</h2>
                        <div class="text-xs font-bold text-white bg-allgood-secondary px-2 py-0.5 rounded inline-block mt-1">Day 5: Review</div>
                    </section>
                    <div class="bg-red-50 border-l-4 border-red-500 p-6 rounded shadow-sm my-8">
                         <p class="text-sm text-gray-700 mb-2"><strong>Context:</strong> Reviewing the numbers. You have $0 left for moving trucks or pizza.</p>
                        <p class="text-sm text-red-800 font-bold"><strong>Instruction:</strong> Acknowledge the liquidity risk. Being 'House Rich and Cash Poor' is a dangerous place to be.</p>
                    </div>
                     <p class="text-center text-xs text-gray-400 mt-8 italic">Living with $0 in the bank is fine... until Day 1.</p>
                </div>

                <!-- Page 14: Emergency Lockbox -->
                <div class="page" id="page-14">
                    <section class="mb-6 border-b border-gray-200 pb-4">
                        <h2 class="text-2xl font-heading font-bold text-allgood-dark">The Safety Net</h2>
                        <div class="text-xs font-bold text-white bg-allgood-secondary px-2 py-0.5 rounded inline-block mt-1">Day 1: Move-In</div>
                    </section>
                    
                    <!-- Context Header -->
                    <div class="bg-blue-50 p-3 rounded border-l-4 border-allgood-secondary mb-4 shadow-sm">
                        <p class="text-sm text-gray-700 mb-1"><strong>Context:</strong> Move-in day! ...Snap. The key breaks in the lock. The locksmith costs $200.</p>
                        <p class="text-sm text-allgood-primary font-bold"><strong>Instruction:</strong> Unlock your Reserve Fund. If you spent it all on the down payment, you're in debt on Day 1.</p>
                    </div>

                    <div class="bg-white p-6 rounded border border-gray-200 shadow-sm text-center">
                        <i data-lucide="lock" class="w-12 h-12 text-allgood-secondary mx-auto mb-4"></i>
                        
                        <button id="lockbox-btn" class="bg-gray-200 text-gray-500 font-bold py-3 px-6 rounded-full shadow-inner transition-all" onclick="toggleLockbox()">
                            <span id="lockbox-text">Unlock Reserve Fund</span>
                        </button>
                    </div>
                     <p id="lockbox-bridge" class="text-center text-xs text-gray-400 mt-6 italic hidden">Crisis averted. You protected your liquidity. You are ready to sign.</p>
                </div>

                <!-- NEW: Phase IV Video Intro -->
                <div class="page" id="page-video-4">
                    <section class="mb-6 border-b border-gray-200 pb-4">
                        <h2 class="text-2xl font-heading font-bold text-allgood-dark">Phase IV: Mission Complete</h2>
                        <div class="text-xs font-bold text-white bg-allgood-dark px-2 py-0.5 rounded inline-block mt-1">Day 0: Closing</div>
                    </section>
                    
                    <p class="text-sm text-gray-600 mb-6"><strong>Intel:</strong> You have navigated the gauntlet. It's time to review your performance and receive your credentials.</p>

                    <!-- Video Placeholder -->
                    <div class="aspect-w-16 aspect-h-9 bg-black rounded-lg mb-6 flex items-center justify-center shadow-lg border border-gray-700 relative overflow-hidden group cursor-pointer">
                        <div class="absolute inset-0 bg-gradient-to-tr from-black/80 to-transparent"></div>
                        <div class="text-center relative z-10">
                            <i data-lucide="play-circle" class="w-16 h-16 text-allgood-primary opacity-80 mx-auto mb-2 group-hover:scale-110 transition-transform"></i>
                            <p class="text-white/80 text-xs uppercase tracking-widest font-bold">Watch Debrief</p>
                        </div>
                    </div>

                    <p class="text-center text-xs text-gray-400 italic">Final Status Check.</p>
                </div>

                <!-- Page 15: Readiness -->
                <div class="page" id="page-15">
                    <div class="flex flex-col items-center justify-center h-full text-center px-4">
                        <h2 class="text-3xl font-heading font-bold text-allgood-dark mb-2">Mission Complete</h2>
                        <p class="text-sm text-gray-600 mb-6">Final Systems Check.</p>
                        
                        <div class="w-full max-w-md bg-white p-6 rounded-lg shadow-lg border border-gray-200 text-left space-y-4">
                             <div class="flex items-center justify-between">
                                <span class="font-bold text-gray-700">Credit Verified</span>
                                <i data-lucide="check-circle" class="w-6 h-6 text-green-500"></i>
                            </div>
                             <div class="flex items-center justify-between">
                                <span class="font-bold text-gray-700">Property Inspected</span>
                                <i data-lucide="check-circle" class="w-6 h-6 text-green-500"></i>
                            </div>
                             <div class="flex items-center justify-between">
                                <span class="font-bold text-gray-700">Cash Wired</span>
                                <i data-lucide="check-circle" class="w-6 h-6 text-green-500"></i>
                            </div>
                        </div>
                         <p class="text-xs text-gray-400 mt-8 italic">One final look back at what you learned.</p>
                    </div>
                </div>

                <!-- Page 16: Mission Debrief -->
                <div class="page" id="page-16">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark">Mission Debrief</h2></section>
                    <div class="space-y-6 text-sm text-gray-700">
                        <p>You survived the 100-Day Gauntlet. You learned that:</p>
                        <ul class="space-y-3">
                            <li class="flex items-start"><i data-lucide="check" class="w-5 h-5 text-allgood-primary mr-2"></i><strong>Rates dictate power.</strong> A small hike changes everything.</li>
                            <li class="flex items-start"><i data-lucide="check" class="w-5 h-5 text-allgood-primary mr-2"></i><strong>Inspections are leverage.</strong> Never buy a problem you didn't price in.</li>
                            <li class="flex items-start"><i data-lucide="check" class="w-5 h-5 text-allgood-primary mr-2"></i><strong>Cash is king.</strong> Liquidity saves you when the house breaks (and it will).</li>
                        </ul>
                        <p class="mt-8 font-bold text-allgood-primary text-center text-lg">You are no longer a lead. You are a Project-Ready Buyer.</p>
                    </div>
                </div>

                <!-- Page 17: Agent Handoff & About Us -->
                <div class="page" id="page-17">
                    <div class="flex flex-col items-center justify-center h-full text-center">
                        <div id="badge-container" class="mb-8 transform scale-90 sm:scale-100 transition-transform">
                            <!-- SVG Badge injected here -->
                        </div>
                        <h2 class="text-2xl font-heading font-bold text-allgood-dark mb-2">Congratulations!</h2>
                        <p class="text-sm text-gray-600 mb-8 max-w-xs mx-auto">You have the mindset to close. Let's find your property.</p>
                        
                        <a href="https://calendly.com/" target="_blank" class="bg-allgood-primary hover:bg-allgood-hover text-white font-bold py-4 px-8 rounded shadow-lg transition-transform hover:scale-105 flex items-center mb-12">
                            <i data-lucide="calendar" class="w-5 h-5 mr-2"></i>
                            Schedule Priority Consultation
                        </a>

                        <!-- About Us Accordion -->
                        <div class="w-full max-w-lg text-left mx-auto">
                            <button class="accordion-toggle w-full bg-white border border-gray-200 p-4 rounded-lg shadow-md flex justify-between items-center hover:bg-gray-50 hover:border-allgood-primary transition-all group">
                                <span class="font-bold text-allgood-dark text-base group-hover:text-allgood-primary transition-colors font-heading">About Us</span>
                                <svg class="accordion-icon h-5 w-5 text-gray-400 transform transition-transform duration-300 group-hover:text-allgood-primary" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            </button>
                            <div class="accordion-content hidden bg-gray-50 border-x border-b border-gray-200 rounded-b-lg p-5 text-gray-600 shadow-inner text-xs font-body">
                                <p class="mb-4 text-sm text-allgood-dark">The Allgood Academy is a learning lab focused on Pragmatic Action. We apply the advanced instructional design used by top tech companies to guarantee one result: a mindset shift that converts passive learning into tangible, real-world execution.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <footer class="footer-content flex items-center justify-between px-6">
                    <div id="flex-progress-bar"><div id="flex-progress-fill"></div></div>
                    
                    <!-- Back Button -->
                    <button id="back-button" class="text-allgood-primary hover:text-allgood-dark font-bold text-sm flex items-center transition-colors disabled:opacity-30 disabled:cursor-not-allowed font-body">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>Back
                    </button>
                    
                    <!-- Center Footer Content -->
                    <div class="text-center hidden sm:block">
                        <p class="text-gray-400 text-[10px] font-body">
                            <a href="https://www.allgoodacademy.com/goodblocks" target="_blank" class="font-bold hover:text-allgood-primary transition-colors">GoodBlock&trade;</a> 
                            powered by the 
                            <a href="https://www.allgoodacademy.com" target="_blank" class="font-bold hover:text-allgood-primary transition-colors">Allgood Academy</a>
                        </p>
                    </div>

                    <!-- Next Button -->
                    <button id="next-button" class="bg-allgood-primary hover:bg-allgood-hover text-white px-6 py-2 rounded-full text-sm font-bold shadow-md transition-transform transform hover:scale-105 flex items-center disabled:opacity-50 disabled:cursor-not-allowed font-body"><span>Next</span><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button>
                </footer>

            </div>
        </div>
    </main>

    <!-- Logic -->
    <script>
        // --- Global State ---
        const totalPages = 21; // UPDATED: 17 original + 4 videos
        let currentPage = 0;
        let userName = "Buyer";
        let userProfile = "Realistic";
        let currentRate = 5.0;
        let loanAmount = 350000;
        let auditFound = 0;
        let cashAvailable = 50000;
        let bucketStatus = { down: 0, closing: 0, reserves: 0, moving: 0 };
        let lockboxSecured = false;

        // --- Audio Engine (Standard) ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx;
        function initAudio() { if (!audioCtx) { audioCtx = new AudioContext(); } if (audioCtx.state === 'suspended') { audioCtx.resume(); } }
        
        // RESTORED: Exact playTone signature from Template (includes volume/attack/decay)
        function playTone(freq, type, duration, vol=0.1, attack=0.01, decay=0.001) {
            try {
                initAudio(); 
                const now = audioCtx.currentTime; 
                const osc = audioCtx.createOscillator(); 
                const gain = audioCtx.createGain();
                osc.type = type; 
                osc.frequency.setValueAtTime(freq, now); 
                osc.connect(gain); 
                gain.connect(audioCtx.destination);
                
                // Template Envelope Logic
                gain.gain.setValueAtTime(0, now); 
                gain.gain.linearRampToValueAtTime(vol, now + attack); 
                gain.gain.exponentialRampToValueAtTime(decay, now + duration);
                
                osc.start(now); 
                osc.stop(now + duration);
            } catch(e) { console.warn("Audio error", e); }
        }

        // UPDATED: SFX Objects with Themed Sounds
        const sfx = {
            powerOn: () => { 
                try {
                    initAudio(); 
                    const now = audioCtx.currentTime; 
                    const osc = audioCtx.createOscillator(); 
                    const gain = audioCtx.createGain(); 
                    osc.connect(gain); 
                    gain.connect(audioCtx.destination); 
                    osc.type = 'triangle'; 
                    // Template values: 110Hz -> 220Hz over 0.4s
                    osc.frequency.setValueAtTime(110, now); 
                    osc.frequency.exponentialRampToValueAtTime(220, now + 0.4); 
                    gain.gain.setValueAtTime(0, now); 
                    gain.gain.linearRampToValueAtTime(0.4, now + 0.1); 
                    gain.gain.linearRampToValueAtTime(0, now + 0.4); 
                    osc.start(now); 
                    osc.stop(now + 0.4); 
                } catch(e) { console.warn("Audio error", e); }
            },
            powerOff: () => { try { initAudio(); playTone(80, 'triangle', 0.2, 0.5, 0.01, 0.001); } catch(e){} },
            nav: () => { try { initAudio(); playTone(150, 'sine', 0.1, 0.1, 0.01, 0.01); } catch(e){} },
            tick: () => { try { initAudio(); playTone(1000, 'sine', 0.01, 0.01); } catch(e){} },
            
            // THEMED SUCCESS: "Ka-ching" (Cash Register/Keys)
            success: () => { 
                try { 
                    // High pitch coin sound
                    playTone(1200, 'sine', 0.1, 0.1, 0.01, 0.1); 
                    setTimeout(()=>playTone(1800, 'sine', 0.2, 0.1, 0.01, 0.2), 50); 
                } catch(e){} 
            },
            
            // THEMED ERROR: "Construction Thud" / "Locked Door"
            error: () => { 
                try { 
                    // Low frequency abrupt thud
                    playTone(100, 'sawtooth', 0.15, 0.2, 0.01, 0.05); 
                } catch(e){} 
            },
            
            // Standard Click
            click: () => { try { initAudio(); playTone(1000, 'sine', 0.01, 0.01); } catch(e){} }
        };

        // --- Navigation ---
        const pages = document.querySelectorAll('.page');
        const progressBar = document.getElementById('flex-progress-fill');
        const nextBtn = document.getElementById('next-button');
        const backBtn = document.getElementById('back-button');
        // UPDATED: Target the page indicator instead of day countdown
        const pageIndicator = document.getElementById('header-page-indicator');

        function showPage(idx) {
            if (idx < 0 || idx >= totalPages) return;
            pages.forEach(p => p.classList.remove('active'));
            pages[idx].classList.add('active');
            currentPage = idx;
            progressBar.style.width = `${((idx + 1) / totalPages) * 100}%`;
            
            // UPDATED: Update Page Counter
            if (pageIndicator) pageIndicator.textContent = `${idx + 1} / ${totalPages}`;

            // Badge Gen on Last Page
            if (idx === 20) generateBadge();

            // Nav Button State
            backBtn.disabled = idx === 0;
            backBtn.classList.toggle('opacity-0', idx === 0);
            
            if (idx === totalPages - 1) {
                nextBtn.style.display = 'none';
            } else {
                nextBtn.style.display = 'flex';
                nextBtn.querySelector('span').textContent = 'Next';
            }
            
            sfx.nav();
        }

        nextBtn.addEventListener('click', () => showPage(currentPage + 1));
        backBtn.addEventListener('click', () => showPage(currentPage - 1));
        document.getElementById('home-button').addEventListener('click', () => showPage(0));

        // --- Page 3: Profile Selection ---
        window.selectProfile = function(profile) {
            userProfile = profile;
            document.querySelectorAll('.profile-card').forEach(c => c.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            document.getElementById('profile-feedback').textContent = `Strategy Set: ${profile}`;
            document.getElementById('bridge-p3').classList.remove('hidden');
            sfx.click();
        }

        // --- Page 4: Rate Shock ---
        const rateSlider = document.getElementById('rate-slider');
        if(rateSlider) {
            rateSlider.addEventListener('input', (e) => {
                currentRate = e.target.value / 10;
                document.getElementById('rate-display').textContent = currentRate.toFixed(1) + "%";
                
                // Calc P&I: P = L[c(1 + c)^n]/[(1 + c)^n - 1]
                const r = currentRate / 100 / 12;
                const n = 360; // 30 years
                const payment = loanAmount * (r * Math.pow(1 + r, n)) / (Math.pow(1 + r, n) - 1);
                
                document.getElementById('payment-display').textContent = "$" + Math.floor(payment).toLocaleString();
                
                // Dynamic Narrative Feedback Logic
                const narrative = document.getElementById('rate-narrative');
                if(currentRate < 4.5) {
                    narrative.innerHTML = `<span class="text-green-600 font-bold">Optimistic Scenario:</span> Low rates boost your buying power. You can afford more square footage.`;
                } else if (currentRate < 6.5) {
                    narrative.innerHTML = `<span class="text-yellow-600 font-bold">Realistic Market:</span> Standard conditions. Every dollar counts.`;
                } else {
                    narrative.innerHTML = `<span class="text-red-600 font-bold">CRITICAL WARNING:</span> High rates crush affordability. You are now paying more to the bank than to your own equity.`;
                }
            });
        }

        // --- Page 5 & 6: DTI Logic ---
        window.calculateDTI = function() {
            const income = parseFloat(document.getElementById('income-input').value) || 0;
            const debt = parseFloat(document.getElementById('debt-input').value) || 0;
            
            if(income === 0) return;

            // Assume mortgage is roughly $2500 for this scenario
            const estMortgage = 2500;
            const dti = ((debt + estMortgage) / income) * 100;
            const totalDebt = debt + estMortgage;
            
            // Move to results page (Index 6 is now the Approval Page because VID1 is Index 3)
            showPage(6);
            
            // Animate Results
            const bar = document.getElementById('dti-bar');
            const val = document.getElementById('dti-value');
            const status = document.getElementById('dti-status');
            const icon = document.getElementById('dti-icon');
            const msg = document.getElementById('dti-message');

            // --- Update Detailed Breakdown (Page 6) ---
            const resUserDebt = document.getElementById('res-user-debt');
            const resTotalDebt = document.getElementById('res-total-debt');
            const resIncome = document.getElementById('res-income');
            
            // Format numbers to USD strings for display
            const formatUSD = (n) => "$" + n.toLocaleString('en-US');

            if (resUserDebt) resUserDebt.textContent = formatUSD(debt);
            if (resTotalDebt) resTotalDebt.textContent = formatUSD(totalDebt);
            if (resIncome) resIncome.textContent = formatUSD(income);

            val.textContent = dti.toFixed(1);
            
            setTimeout(() => {
                bar.style.width = Math.min(dti, 100) + "%";
                if (dti <= 43) {
                    bar.className = "h-4 rounded-full bg-green-500 transition-all duration-1000 ease-out";
                    status.textContent = "PRE-QUALIFIED";
                    status.className = "text-2xl font-bold mb-2 font-heading text-green-600";
                    icon.innerHTML = `<i data-lucide="check-circle" class="w-16 h-16 text-green-500 mx-auto"></i>`;
                    msg.textContent = "You are within safe lending limits. Proceed to Phase II.";
                    sfx.success();
                } else {
                    bar.className = "h-4 rounded-full bg-red-500 transition-all duration-1000 ease-out";
                    status.textContent = "HIGH RISK";
                    status.className = "text-2xl font-bold mb-2 font-heading text-red-600";
                    icon.innerHTML = `<i data-lucide="alert-circle" class="w-16 h-16 text-red-500 mx-auto"></i>`;
                    msg.textContent = "Bank Rejection Likely. You are 'House Poor'. To fix this, you must eliminate the car payment or lower the purchase price.";
                    sfx.error();
                }
                lucide.createIcons();
            }, 300);
        }

        // --- Page 7: Budget Quiz ---
        window.budgetCheck = function(isPrudent) {
            const fb = document.getElementById('budget-feedback');
            if(isPrudent) {
                fb.textContent = "Wise Choice. 'House Poor' leads to foreclosure risk.";
                fb.className = "mt-4 text-xs font-bold text-green-600";
                sfx.success();
            } else {
                fb.textContent = "Risky. Maxing out your approval leaves no room for repairs.";
                fb.className = "mt-4 text-xs font-bold text-red-500";
                sfx.error();
            }
        }

        // --- Page 8: Property Audit ---
        window.foundFlag = function(el, name) {
            if(el.classList.contains('found')) return;
            el.classList.add('found');
            auditFound++;
            document.getElementById('audit-count').textContent = auditFound;
            document.getElementById('audit-msg').textContent = `Spotted: ${name}`;
            sfx.click();
            if(auditFound === 5) {
                document.getElementById('audit-msg').textContent = "Audit Complete! You have leverage.";
                document.getElementById('audit-msg').className = "text-center text-xs font-bold text-allgood-primary mt-2 min-h-[20px]";
                document.getElementById('audit-bridge').classList.remove('hidden');
                sfx.success();
            }
        }

        // --- Page 10: Contingency ---
        window.contingencyResult = function(choice) {
            const fb = document.getElementById('contingency-feedback');
            if(choice === 'waive') {
                fb.textContent = "Offer Accepted! But you just bought a house with a cracked foundation. Cost: $30k.";
                fb.className = "mt-4 text-xs font-bold text-red-500";
                sfx.error();
            } else {
                fb.textContent = "Offer Rejected. But you saved yourself financial ruin. The right house is out there.";
                fb.className = "mt-4 text-xs font-bold text-green-600";
                document.getElementById('contingency-bridge').classList.remove('hidden');
                sfx.success();
            }
        }

        // --- Page 12: Bucket Allocator ---
        window.fillBucket = function() {
            const buckets = ['down', 'closing', 'reserves', 'moving'];
            // Simple sequential fill logic for demo
            if (bucketStatus.down < 30000) { addCash('down', 10000); }
            else if (bucketStatus.closing < 10000) { addCash('closing', 5000); }
            else if (bucketStatus.reserves < 5000) { addCash('reserves', 2500); }
            else if (bucketStatus.moving < 2000) { addCash('moving', 1000); }
            else { 
                // All full
                document.getElementById('cash-display').textContent = "Fully Allocated";
            }
        }

        function addCash(id, amt) {
            if (cashAvailable >= amt) {
                cashAvailable -= amt;
                bucketStatus[id] += amt;
                document.getElementById(`val-${id}`).textContent = "$" + bucketStatus[id].toLocaleString();
                document.getElementById('cash-display').textContent = "$" + cashAvailable.toLocaleString();
                
                // Visuals
                if ((id === 'down' && bucketStatus[id] >= 30000) ||
                    (id === 'closing' && bucketStatus[id] >= 10000) ||
                    (id === 'reserves' && bucketStatus[id] >= 5000) ||
                    (id === 'moving' && bucketStatus[id] >= 2000)) {
                        document.getElementById(`bucket-${id}`).classList.add('filled');
                }
                sfx.click();
            }
             if (cashAvailable <= 0) {
                 document.getElementById('bucket-bridge').classList.remove('hidden');
            }
        }

        // --- Page 14: Lockbox ---
        window.toggleLockbox = function() {
            const btn = document.getElementById('lockbox-btn');
            const txt = document.getElementById('lockbox-text');
            lockboxSecured = !lockboxSecured;
            
            if(lockboxSecured) {
                btn.className = "bg-green-500 text-white font-bold py-3 px-6 rounded-full shadow-lg transition-all transform scale-105";
                txt.textContent = "FUNDS SECURED";
                document.getElementById('lockbox-bridge').classList.remove('hidden');
                sfx.success();
            } else {
                btn.className = "bg-gray-200 text-gray-500 font-bold py-3 px-6 rounded-full shadow-inner transition-all";
                txt.textContent = "Unlock Reserve Fund";
            }
        }

        // --- Page 17: Badge Generator ---
        function generateBadge() {
            const container = document.getElementById('badge-container');
            // Simple SVG Badge
            const badge = `
            <svg width="280" height="180" viewBox="0 0 280 180" xmlns="http://www.w3.org/2000/svg">
                <rect width="280" height="180" rx="15" fill="#357889"/>
                <rect x="10" y="10" width="260" height="160" rx="10" fill="white"/>
                <circle cx="140" cy="50" r="30" fill="#fef3c7" stroke="#D34716" stroke-width="2"/>
                <text x="140" y="58" font-family="Georgia, serif" font-size="24" text-anchor="middle" fill="#D34716">★</text>
                <text x="140" y="100" font-family="Verdana, sans-serif" font-weight="bold" font-size="16" text-anchor="middle" fill="#4C4C4C">${userName.toUpperCase()}</text>
                <text x="140" y="120" font-family="Verdana, sans-serif" font-size="10" text-anchor="middle" fill="#757575">READY BUYER</text>
                <rect x="70" y="135" width="140" height="20" rx="10" fill="#D34716"/>
                <text x="140" y="148" font-family="Verdana, sans-serif" font-weight="bold" font-size="10" text-anchor="middle" fill="white">ALLGOOD ACADEMY</text>
            </svg>
            `;
            container.innerHTML = badge;
        }

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            // Removed dynamic date setter to respect the hardcoded 2025 request
            // document.getElementById('current-year').textContent = new Date().getFullYear();
            lucide.createIcons();
            
            // --- GLOBAL UI HANDLERS (Accordion, Blueprint) ---
            document.body.addEventListener('click', (e) => {
                const target = e.target;

                // Accordion
                const accBtn = target.closest('.accordion-toggle');
                if (accBtn) {
                    const content = accBtn.nextElementSibling;
                    const icon = accBtn.querySelector('.accordion-icon');
                    const isOpen = !content.classList.contains('hidden');
                    document.querySelectorAll('.accordion-content').forEach(c => c.classList.add('hidden'));
                    document.querySelectorAll('.accordion-icon').forEach(i => i.classList.remove('rotate-180'));
                    if (!isOpen) { 
                        content.classList.remove('hidden'); 
                        if(icon) icon.classList.add('rotate-180'); 
                        sfx.tick(); 
                    }
                    return;
                }

                // Blueprint Toggle
                if (target.closest('#blueprint-toggle')) {
                    document.getElementById('screen').classList.toggle('blueprint-mode');
                    const btn = document.getElementById('blueprint-toggle');
                    if (document.getElementById('screen').classList.contains('blueprint-mode')) { 
                        btn.classList.add('text-cyan-300', 'bg-white/10'); 
                    } else { 
                        btn.classList.remove('text-cyan-300', 'bg-white/10'); 
                    }
                    sfx.tick();
                    return;
                }
            });

            // Startup Screen Click Handler
            const startupScreen = document.getElementById('startup-screen');
            if (startupScreen) {
                startupScreen.addEventListener('click', () => {
                    try {
                        sfx.powerOn();
                    } catch(e) {
                        console.warn("Audio initialization failed but proceeding:", e);
                    }
                    startupScreen.style.opacity = '0';
                    setTimeout(() => { startupScreen.style.display = 'none'; }, 700);
                });
            }
            
            // Start Button Logic
            document.getElementById('start-session-btn').addEventListener('click', () => {
                const nameInput = document.getElementById('user-name-input').value;
                if(nameInput.trim()) {
                    userName = nameInput;
                    document.getElementById('header-welcome-text').textContent = `Welcome: ${userName}`;
                } else {
                    userName = "Learner";
                    document.getElementById('header-welcome-text').textContent = "Welcome: Learner";
                }
                document.getElementById('login-modal').classList.add('hidden-modal');
                document.getElementById('login-modal').classList.remove('visible-modal');
                
                // UPDATED: Use Nav Sound for Sign In
                sfx.nav(); 
                showPage(0);
            });

            // Menu Toggle Logic
            document.getElementById('menu-toggle').addEventListener('click', () => {
                const modal = document.getElementById('menu-modal');
                modal.classList.remove('hidden-modal');
                modal.classList.add('visible-modal');
                
                // Build Table of Contents dynamic
                const toc = document.getElementById('toc-list');
                toc.innerHTML = '';
                const pageTitles = [
                    "Cover", "Scope", "Strategy", 
                    "Video: Phase I", "Rate Shock", "DTI Test", "Approval", "Budget Quiz", 
                    "Video: Phase II", "Property Audit", "Cost vs Value", "Bidding War", 
                    "Video: Phase III", "The Pivot", "Bucket Allocator", "The Shortfall", "Lockbox", 
                    "Video: Phase IV", "Readiness", "Debrief", "Agent Handoff"
                ];
                
                pageTitles.forEach((t, i) => {
                    const btn = document.createElement('button');
                    btn.className = "w-full text-left px-4 py-2 hover:bg-gray-100 text-gray-700 rounded";
                    btn.textContent = `${i+1}. ${t}`;
                    btn.onclick = () => { 
                        showPage(i); 
                        modal.classList.add('hidden-modal');
                        modal.classList.remove('visible-modal');
                    };
                    toc.appendChild(btn);
                });
            });

            document.getElementById('close-menu').addEventListener('click', () => {
                const modal = document.getElementById('menu-modal');
                modal.classList.add('hidden-modal');
                modal.classList.remove('visible-modal');
            });
            
            // Fullscreen Logic (Robustified)
            const fullscreenBtn = document.getElementById('fullscreen-toggle');
            
            function toggleFullScreen() {
                // Toggle visual class regardless of native support success
                const frame = document.querySelector('.tablet-frame');
                const isFocus = frame.classList.contains('focus-mode');

                if (!isFocus) {
                    // Enter Fullscreen/Focus Mode
                    const target = document.documentElement; 
                    
                    // Try native fullscreen, catch errors if blocked by iframe policy
                    if (target.requestFullscreen) {
                        target.requestFullscreen().catch(e => console.warn("Native fullscreen blocked by permissions:", e));
                    } else if (target.msRequestFullscreen) {
                        try { target.msRequestFullscreen(); } catch(e) {}
                    } else if (target.mozRequestFullScreen) {
                        try { target.mozRequestFullScreen(); } catch(e) {}
                    } else if (target.webkitRequestFullscreen) {
                        try { target.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT); } catch(e) {}
                    }
                    
                    // Apply visual changes immediately (Fallback logic)
                    frame.classList.add('focus-mode');
                    fullscreenBtn.classList.add('text-green-300', 'bg-white/10');

                } else {
                    // Exit Fullscreen/Focus Mode
                    if (document.exitFullscreen) {
                        document.exitFullscreen().catch(e => {});
                    } else if (document.msExitFullscreen) {
                        try { document.msExitFullscreen(); } catch(e) {}
                    } else if (document.mozCancelFullScreen) {
                        try { document.mozCancelFullScreen(); } catch(e) {}
                    } else if (document.webkitExitFullscreen) {
                        try { document.webkitExitFullscreen(); } catch(e) {}
                    }
                    
                    // Remove visual changes
                    frame.classList.remove('focus-mode');
                    fullscreenBtn.classList.remove('text-green-300', 'bg-white/10');
                }
                sfx.tick();
            }

            fullscreenBtn.addEventListener('click', toggleFullScreen);

            // Listener to sync button state if user presses ESC
            document.addEventListener('fullscreenchange', () => {
                 if (!document.fullscreenElement) {
                    // Only remove if we are actually out of fullscreen and the class is still there
                    // This check handles the case where we used CSS-only focus mode
                    // document.querySelector('.tablet-frame').classList.remove('focus-mode');
                    // fullscreenBtn.classList.remove('text-green-300', 'bg-white/10');
                 }
            });


            // --- HOME BUTTON HOLD LOGIC ---
            const homeBtn = document.getElementById('home-button');
            let pressTimer;

            const performReset = () => {
                sfx.powerOff();
                userName = "Buyer";
                document.getElementById('user-name-input').value = "";
                document.getElementById('header-welcome-text').textContent = "Welcome: Learner";
                const startup = document.getElementById('startup-screen');
                startup.style.display = 'flex';
                void startup.offsetWidth; // reflow
                startup.style.opacity = '1';
                document.getElementById('login-modal').classList.remove('hidden-modal');
                document.getElementById('login-modal').classList.add('visible-modal');
                showPage(0);
            };

            homeBtn.addEventListener('mousedown', () => { pressTimer = setTimeout(performReset, 2000); });
            homeBtn.addEventListener('touchstart', (e) => { e.preventDefault(); pressTimer = setTimeout(performReset, 2000); });
            homeBtn.addEventListener('mouseup', () => clearTimeout(pressTimer));
            homeBtn.addEventListener('mouseleave', () => clearTimeout(pressTimer));
            homeBtn.addEventListener('touchend', () => { 
                clearTimeout(pressTimer); 
                // Fallback for click behavior on touch devices since preventDefault kills the click event
                if (pressTimer) showPage(0); 
            });
            homeBtn.addEventListener('click', () => showPage(0));
        });

    </script>
</body>
</html>
