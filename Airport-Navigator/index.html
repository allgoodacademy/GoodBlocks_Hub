<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Airport Navigator GoodBlock</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons for interactions -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Font Awesome for quiz icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <!-- FIREBASE AND AUTHENTICATION SETUP -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, GoogleAuthProvider, signInWithPopup, updateProfile } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, addDoc, collection, serverTimestamp, getDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
        
        // 1. CONFIGURATION
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyAf2SO8xovrApl52udUUoR1n9WBnERr_ko",
            authDomain: "allgood-academy.firebaseapp.com",
            projectId: "allgood-academy",
            storageBucket: "allgood-academy.firebasestorage.app",
            messagingSenderId: "978829044870",
            appId: "1:978829044870:web:6c780f64230a77ad0ab507",
            measurementId: "G-EN4M7T3BLQ"
        };
        
        const appId = 'allgood-academy'; 
        
        // 2. INITIALIZE SERVICES
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // 3. GLOBAL STATE
        window.currentUser = null;
        window.currentUserName = "Anonymous";
        window.currentUserEmail = "";
        window.isAuthReady = false;
        
        // Define Session ID here to ensure it exists before any logging logic runs
        window.sessionId = "session_" + Date.now() + "_" + Math.floor(Math.random() * 1000);
        console.log("[System] Session ID generated:", window.sessionId);

        // 4. AUTH HANDLER
        onAuthStateChanged(auth, async (user) => {
            window.isAuthReady = true;
            if (user) {
                console.log("[Auth] User detected:", user.uid);
                window.currentUser = user;
                
                // Retrieve or Set Display Name
                let finalName = user.displayName || localStorage.getItem('aa_username') || "Agent Learner";
                
                // Attempt to fetch from DB for consistency if missing
                if (finalName === "Agent Learner") {
                    try {
                        const userDoc = await getDoc(doc(db, 'artifacts', appId, 'users', user.uid));
                        if (userDoc.exists()) {
                            finalName = userDoc.data().displayName || finalName;
                        }
                    } catch(e) { console.log("Profile fetch skipped", e); }
                }

                window.currentUserName = finalName;
                window.currentUserEmail = user.email;
                
                // Update UI
                const welcomeText = document.getElementById('header-welcome-text');
                if(welcomeText) welcomeText.textContent = `Welcome, ${finalName}`;
                
                // Hide login modal if present (this handles the SSO case)
                const loginModal = document.getElementById('login-modal');
                if (loginModal && !loginModal.classList.contains('hidden-modal')) {
                    loginModal.classList.add('hidden-modal');
                    loginModal.classList.remove('visible-modal');
                    // Auto-start session log if we just auto-logged in via SSO
                    if(window.SessionManager) window.SessionManager.start(finalName, user.email);
                }
            } else {
                console.log("[Auth] No user signed in.");
                window.currentUser = null;
            }
        });

        // 5. IDENTITY ENGINE
        async function ensureUserContainer(user, name, email, isGuest) {
             const userRef = doc(db, 'artifacts', appId, 'users', user.uid);
             try {
                 await setDoc(userRef, {
                     displayName: name,
                     email: email || (isGuest ? null : user.email || null),
                     isGuest: isGuest,
                     lastLogin: serverTimestamp(),
                     lastActiveModule: "Airport Navigator"
                 }, { merge: true });
                 console.log("[Identity] User container verified/created.");
             } catch (e) {
                 console.error("[Identity] Failed to create user container:", e);
             }
        }

        // 6. DATABASE LOGGING ENGINE
        window.logToFirestore = async (action, detail, payload = {}) => {
            const user = auth.currentUser;
            if (!user) {
                console.warn("[DB] Skipping write - No User");
                return;
            }
            
            console.log(`[DB] Writing event: ${action} - ${detail}`);

            // Path: artifacts/allgood-academy/users/{uid}/game_scores/{sessionId}
            const sessionRef = doc(db, 'artifacts', appId, 'users', user.uid, 'game_scores', window.sessionId);
            
            const sessionData = {
                gameName: "Airport Navigator", 
                lastUpdated: serverTimestamp(),
                user: {
                    uid: user.uid,
                    displayName: window.currentUserName,
                    email: window.currentUserEmail
                }
            };

            // Merge High-Level Metrics from payload if present
            if (payload.score) sessionData.finalScore = payload.score; 
            if (payload.rating) sessionData.rating = payload.rating;

            try {
                await setDoc(sessionRef, sessionData, { merge: true });
                
                const logsRef = collection(db, 'artifacts', appId, 'users', user.uid, 'game_scores', window.sessionId, 'logs');
                await addDoc(logsRef, {
                    action: action,
                    detail: detail,
                    payload: payload,
                    timestamp: serverTimestamp()
                });
                console.log("[DB] Write Success.");
            } catch (e) {
                console.error("[DB] Write FAILED:", e);
            }
        };

        // NEW: Function to signal module completion (for the Dashboard to track)
        // UPDATED: Now accepts the SVG artifact to store permanently
        window.logModuleCompletion = async (badgeSVGString) => {
            const user = auth.currentUser;
            if (!user) return;
            
            console.log("[DB] Writing Airport Navigator Completion Status & Artifact...");
            // Use the established session ID for the status update
            const sessionRef = doc(db, 'artifacts', appId, 'users', user.uid, 'game_scores', window.sessionId);
            
            try {
                // IMPORTANT: This document must contain the gameName and completed: true flag
                await setDoc(sessionRef, {
                    gameName: "Airport Navigator",
                    completed: true,
                    finalScore: 100, // Mark as successful pass
                    rank: "Certified Navigator",
                    lastUpdated: serverTimestamp(),
                    // NEW: Store the visual proof (The Badge)
                    badgeArtifact: badgeSVGString,
                    user: {
                        uid: user.uid,
                        displayName: window.currentUserName
                    }
                }, { merge: true });
                console.log("[DB] Completion Status & Badge Artifact Write Success.");
            } catch (e) { console.error("[DB] Completion Status Write FAILED:", e); }
        };

        // 7. LOGIN FUNCTIONS
        window.handleGuestLogin = async () => {
            const nameInput = document.getElementById('user-name-input').value.trim();
            const emailInput = document.getElementById('user-email-input').value.trim();
            const btn = document.getElementById('btn-guest-login');
            
            const originalText = btn.innerText;
            btn.innerText = "Connecting...";
            btn.disabled = true;

            try {
                let user;
                if (auth.currentUser && auth.currentUser.isAnonymous) {
                    user = auth.currentUser;
                } else {
                    const result = await signInAnonymously(auth);
                    user = result.user;
                }
                
                const displayName = nameInput || "Agent Learner";
                await updateProfile(user, { displayName: displayName });
                
                // Establish Identity
                await ensureUserContainer(user, displayName, emailInput, true);

                window.currentUserName = displayName;
                window.currentUserEmail = emailInput;
                
                localStorage.setItem('aa_username', displayName);
                localStorage.setItem('aa_uid', user.uid);
                localStorage.setItem('aa_is_guest', 'true');
                
                console.log("[Auth] Guest login successful. UID:", user.uid);
                if(window.SessionManager) window.SessionManager.start(displayName, emailInput);
                
                document.getElementById('header-welcome-text').textContent = `Welcome, ${displayName}`;
                document.getElementById('login-modal').classList.add('hidden-modal');
                document.getElementById('login-modal').classList.remove('visible-modal');
                
                // FIX: Calls global showPage to ensure we land on Cover
                if(window.showPage) window.showPage(0);
                if(window.sfx) window.sfx.nav();

            } catch (error) {
                console.error("Login Failed", error);
                alert("Connection failed. Please try again.");
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        };

        window.handleGoogleLogin = async () => {
            const provider = new GoogleAuthProvider();
            const btnContainer = document.getElementById('google-icon-container');
            if(btnContainer) btnContainer.classList.add('opacity-50', 'pointer-events-none');
            
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user; 
                
                const finalName = user.displayName || "Agent";
                
                // Establish Identity
                await ensureUserContainer(user, finalName, user.email, false);

                window.currentUserName = finalName;
                window.currentUserEmail = user.email;
                
                localStorage.setItem('aa_username', finalName);
                localStorage.setItem('aa_email', user.email);
                localStorage.setItem('aa_uid', user.uid);
                localStorage.setItem('aa_is_guest', 'false');

                console.log("[Auth] Google login successful. UID:", user.uid);
                if(window.SessionManager) window.SessionManager.start(finalName, user.email);

                document.getElementById('header-welcome-text').textContent = `Welcome, ${finalName}`;
                document.getElementById('login-modal').classList.add('hidden-modal');
                document.getElementById('login-modal').classList.remove('visible-modal');
                
                // FIX: Calls global showPage to ensure we land on Cover
                if(window.showPage) window.showPage(0);
                if(window.sfx) window.sfx.nav();
            } catch (error) {
                console.error("Google Sign-In Error", error);
                alert("Google Sign-In failed. Please try again.");
            } finally {
                 if(btnContainer) btnContainer.classList.remove('opacity-50', 'pointer-events-none');
            }
        };
        
        // Handle initial custom token from environment
        (async function initAuth() {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                try {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } catch (e) {
                    console.warn("Auth token failed, falling back", e);
                }
            }
        })();

        // Expose for Debugging
        window.auth = auth;
        window.db = db;
    </script>

    <!-- Tailwind Config with Allgood Brand Colors -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'allgood-primary': '#D34716', // Burnt Orange (Action)
                        'allgood-secondary': '#357889', // Deep Cyan (Brand/Header)
                        'allgood-dark': '#4C4C4C', // Dark Gray (Text/BG)
                        'allgood-light': '#F7F7F7', // Light Gray (Backgrounds)
                        'allgood-hover': '#EB8D69', // Light Orange (Hover)
                        'allgood-accent': '#2D6473', // Darker Cyan (Hover)
                    },
                    fontFamily: {
                        'heading': ['Georgia', 'serif'],
                        'body': ['Verdana', 'sans-serif'],
                    },
                },
            },
        }
    </script>

    <style>
        /* Set the base font and background pattern */
        body {
            font-family: Verdana, sans-serif;
            background-color: #1a1a1a;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
            background-attachment: fixed;
            min-height: 100vh;
            position: relative; /* Needed for absolute positioning of full-screen mode */
        }

        /* Apply Georgia font to headings */
        h1, h2, h3, h4, h5, h6 {
            font-family: Georgia, serif;
        }

        /* --- TABLET FRAME STYLING --- */
        .tablet-frame {
            height: 80vh;
            width: auto;
            aspect-ratio: 16/10; 
            max-width: 1100px;
            max-height: 95vh;
            /* UPDATED: Removed rigid constraints for better mobile fluidity */
            min-height: 0; 
            min-width: 0;
            /* Gradient border effect */
            background-image: 
                radial-gradient(circle at 0% 0%, rgba(211, 71, 22, 0.35) 0%, transparent 30%),
                radial-gradient(circle at 100% 100%, rgba(211, 71, 22, 0.35) 0%, transparent 30%),
                linear-gradient(135deg, #5c5c5c 0%, #d6d6d6 25%, #8a8a8a 50%, #e0e0e0 75%, #5c5c5c 100%);
            border-radius: 12px;
            padding: 12px; 
            box-shadow: 
                inset 1px 1px 2px rgba(255,255,255, 0.6), 
                inset -1px -1px 2px rgba(0,0,0, 0.8), 
                0 30px 60px -12px rgba(0, 0, 0, 0.8), 
                0 0 0 1px #111;
            border: 1px solid #333;
            position: relative;
            margin: 20px auto;
            transition: width 0.3s, height 0.3s, padding 0.3s;
        }

        /* Inner screen bezel */
        .tablet-frame::before {
            content: '';
            position: absolute;
            top: 10px; left: 10px; right: 10px; bottom: 10px;
            border-radius: 6px;
            background: #111;
            z-index: 0;
        }

        /* Main content display area */
        .screen-container {
            width: 100%;
            height: 100%;
            background-color: #F7F7F7;
            position: relative;
            z-index: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column; 
            border-radius: 4px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }

        /* --- CUSTOM SCROLLBAR STYLES (for page content) --- */
        .page::-webkit-scrollbar { width: 14px; }
        .page::-webkit-scrollbar-track { background: #e5e5e5; border-left: 1px solid #d1d5db; }
        .page::-webkit-scrollbar-thumb { background-color: #D34716; border-radius: 7px; border: 3px solid #e5e5e5; }
        .page::-webkit-scrollbar-thumb:hover { background-color: #EB8D69; }
        .page::-webkit-scrollbar-button:single-button { background-color: #e5e5e5; display: block; border-style: solid; height: 14px; width: 14px; }
        .page::-webkit-scrollbar-button:single-button:vertical:decrement { border-width: 0 7px 10px 7px; border-color: transparent transparent #D34716 transparent; }
        .page::-webkit-scrollbar-button:single-button:vertical:increment { border-width: 10px 7px 0 7px; border-color: #D34716 transparent transparent transparent; }

        /* --- MODAL TRANSITION CLASSES --- */
        .modal-transition { transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out; }
        .hidden-modal { opacity: 0; pointer-events: none; transform: translateY(-10px); }
        .visible-modal { opacity: 1; pointer-events: auto; transform: translateY(0); }

        /* Progress bar within the footer */
        #flex-progress-bar { height: 4px; width: 100%; background-color: #eee; position: absolute; top: 0; left: 0; }
        #flex-progress-fill { height: 100%; background-color: #D34716; width: 0%; transition: width 0.3s ease; }

        /* --- BLUEPRINT MODE (Dark Mode for App Content) --- */
        .blueprint-mode { background-color: #0f172a !important; color: #94a3b8 !important; }
        .blueprint-mode .page { background-color: #0f172a !important; }
        .blueprint-mode h1, .blueprint-mode h2, .blueprint-mode h3, .blueprint-mode strong { color: #38bdf8 !important; }
        .blueprint-mode .bg-white { background-color: #1e293b !important; border-color: #334155 !important; color: #cbd5e1 !important; }
        .blueprint-mode .text-allgood-dark { color: #e2e8f0 !important; }
        .blueprint-mode .bg-gray-100, .blueprint-mode .bg-gray-50 { background-color: #0f172a !important; border-color: #1e293b !important; }
        .blueprint-mode .accordion-content { background-color: #0f172a !important; border-color: #334155 !important; color: #94a3b8 !important; }
        .blueprint-mode .footer-content { background-color: #1e293b !important; border-top-color: #334155 !important; color: #94a3b8 !important; }
        .blueprint-mode .footer-content a { color: #38bdf8 !important; }
        .blueprint-mode .footer-content #back-button { color: #94a3b8 !important; }
        .blueprint-mode .footer-content #back-button:not(:disabled):hover { color: #38bdf8 !important; }

        /* --- FOCUS MODE (Full Screen for Mobile/Maximized View) --- */
        .tablet-frame.focus-mode { 
            position: absolute !important; top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important; 
            width: 100% !important; height: 100% !important;
            aspect-ratio: auto !important; max-width: none !important; max-height: none !important; 
            min-height: 0 !important;
            margin: 0 !important; padding: 0 !important; 
            background: #F7F7F7 !important; border: none !important; border-radius: 0 !important; 
            box-shadow: none !important; z-index: 99999 !important; 
            background-image: none !important;
        }
        .tablet-frame.focus-mode::before { display: none; }
        .tablet-frame.focus-mode .screen-container { border-radius: 0; box-shadow: none; height: 100%; }
        /* Account for mobile safe area in the footer */
        .tablet-frame.focus-mode .footer-content { padding-bottom: 0; }
        
        /* Ensure parent container padding doesn't interfere in focus mode */
        body.is-focused main { padding: 0 !important; }

        /* --- MOBILE LAYOUT LOCK (RIGOROUS FLEX SANDWICH) --- */
        @media (max-width: 768px) {
            html, body {
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0 !important;
                overflow: hidden !important; /* Stop document scroll */
                position: fixed; /* Pin document */
                inset: 0;
                overscroll-behavior: none;
            }
            
            main { 
                width: 100vw; 
                height: 100dvh; /* Dynamic Height */
                height: -webkit-fill-available; 
                position: fixed;
                inset: 0;
                padding: 0 !important; 
                display: flex;
                flex-direction: column;
                z-index: 0;
            }
            
            .tablet-frame {
                position: relative !important; 
                width: 100% !important; 
                height: 100% !important;
                max-width: none !important; max-height: none !important;
                min-height: 0 !important; aspect-ratio: auto !important;
                margin: 0 !important; padding: 0 !important;
                border: none !important; border-radius: 0 !important;
                background-image: none !important; box-shadow: none !important;
                display: flex;
                flex-direction: column;
            }
            
            .tablet-frame::before { display: none; }
            
            .screen-container { 
                flex: 1; 
                width: 100%;
                height: 100%;
                display: flex;
                flex-direction: column;
                border-radius: 0 !important; 
                box-shadow: none !important; 
                overflow: hidden; 
            }
            
            .navbar-content, .footer-content {
                flex: 0 0 auto; /* Rigid Buns */
                width: 100%;
                z-index: 50;
            }

            .navbar-content { padding-top: max(env(safe-area-inset-top), 5px); }
            
            .footer-content { 
                z-index: 100;
                padding-bottom: max(env(safe-area-inset-bottom), 15px); 
                background-color: white;
                border-top: 1px solid #e5e7eb;
                position: relative;
                height: auto;
            }

            .page {
                flex: 1 1 auto; /* Scrollable Meat */
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                height: 100%; 
                min-height: 0;
                padding-bottom: 40px;
            }
        }

        /* Layout structure */
        .navbar-content { flex: 0 0 60px; z-index: 20; }
        .page { flex: 1 1 auto; overflow-y: auto; padding: 20px; position: relative; display: none; width: 100%; }
        .page.active { display: block; }
        .footer-content { flex: 0 0 60px; z-index: 20; background-color: white; border-top: 1px solid #e5e7eb; position: relative; }

        /* --- INTERACTIVE STYLES --- */
        /* Flip Card for quick checks (Page 18) */
        .flip-card { background-color: transparent; width: 100%; height: 200px; perspective: 1000px; cursor: pointer; }
        .flip-card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; }
        .flip-card.flipped .flip-card-inner { transform: rotateY(180deg); }
        .flip-card-front, .flip-card-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .flip-card-front { background-color: white; border: 1px solid #e5e7eb; }
        .flip-card-back { background-color: #357889; color: white; transform: rotateY(180deg); }

        /* Drag and Drop styles (Page 8) */
        .draggable-item { cursor: grab; transition: all 0.2s ease; }
        .draggable-item.dragging { opacity: 0.5; transform: scale(1.02); }
        .drop-zone { transition: background-color 0.2s, border-color 0.2s; }
        .drop-zone.drag-over { background-color: #eff6ff; border-color: #357889; }
        .drop-zone.active-zone { background-color: #fff7ed; border-color: #D34716; border-style: dashed; }
        
        /* Toggle Switch (Page 20) */
        .tech-toggle input:checked + div { background-color: #D34716; border-color: #D34716; color: white; }
        
        /* Flowchart (Page 28) */
        .flow-node { transition: all 0.3s ease; }
        .flow-node.active { background-color: #357889; color: white; border-color: #357889; transform: scale(1.05); }

        /* Terminology Tooltip (Glossary) */
        .term { text-decoration: underline; text-decoration-style: dotted; text-decoration-color: #D34716; text-underline-offset: 4px; cursor: help; position: relative; display: inline-block; font-weight: bold; color: #D34716; }
        .term .term-def { visibility: hidden; opacity: 0; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background-color: #1f2937; color: #fff; padding: 10px; border-radius: 6px; font-size: 11px; width: 220px; z-index: 60; margin-bottom: 10px; text-align: left; line-height: 1.4; transition: all 0.2s ease; pointer-events: none; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3); font-family: Verdana, sans-serif; font-weight: normal; border: 1px solid #374151; }
        .term:hover .term-def, .term:focus .term-def, .term:focus-within .term-def { visibility: visible; opacity: 1; transform: translateX(-50%) translateY(-5px); }
        .term .term-def::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -6px; border-width: 6px; border-style: solid; border-color: #1f2937 transparent transparent transparent; }

        /* Map Card Hover Effect (Page 3) */
        .map-card { transition: all 0.3s ease; cursor: pointer; }
        .map-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); border-color: #D34716; }

        /* --- VISUAL ARTIFACTS STYLING --- */
        /* Digital Scale (Page 9) */
        .digital-scale {
            background-color: #222;
            color: #f00;
            font-family: 'Courier New', monospace;
            border: 4px solid #444;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.8);
            text-shadow: 0 0 5px #f00;
        }

        /* Paper Ticket (Page 25) */
        .paper-ticket {
            background-color: #fff;
            color: #555;
            border: 1px solid #ddd;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
            position: relative;
            /* Simple perforation edge effect */
            border-left: 4px dotted #ccc;
        }

        /* Digital Screen (Page 25) */
        .digital-screen {
            background-color: #000;
            color: #0f0;
            font-family: 'Courier New', monospace;
            border: 4px solid #333;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.2);
            text-shadow: 0 0 2px #0f0;
        }

        /* Ziploc Bag (Page 17) */
        .ziploc-bag {
            background-color: rgba(220, 240, 255, 0.4); 
            border-left: 1px solid #BFDBFE;
            border-right: 1px solid #BFDBFE;
            border-bottom: 1px solid #BFDBFE;
            
            /* The visual seal mechanism */
            border-top: 4px double #3B82F6; 
            
            border-radius: 4px 4px 12px 12px; 
            box-shadow: 
                inset 0 0 20px rgba(255,255,255,0.8), 
                5px 5px 15px rgba(0,0,0,0.05); 
            position: relative;
        }

        /* The Zipper Slider Artifact */
        .ziploc-bag::before {
            content: '';
            position: absolute;
            top: -8px; 
            right: 10%; 
            width: 16px;
            height: 12px;
            background: linear-gradient(to bottom, #2563EB, #1D4ED8);
            border-radius: 2px;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.2);
            z-index: 20;
        }
        
        /* Plastic Sheen/Highlight */
        .ziploc-bag::after {
            content: '';
            position: absolute;
            top: 10px;
            right: 10px;
            width: 20px;
            height: 40px;
            background: linear-gradient(135deg, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 100%);
            border-radius: 50%;
            transform: rotate(-15deg);
            opacity: 0.6;
            pointer-events: none;
        }

        /* Vertical Timeline Line (Page 21) */
        .timeline-line {
            position: absolute;
            left: 24px;
            top: 20px;
            bottom: 20px;
            width: 2px;
            background-color: #e5e7eb;
            z-index: 0;
        }
        
        /* --- NEW: FLIGHT TYPE SWITCH STYLES (Page 6) --- */
        .flight-type-switch-container {
            position: relative;
            height: 48px;
            border-radius: 8px;
            background-color: #E5E7EB;
            padding: 4px;
            display: flex;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .flight-type-option {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            user-select: none;
            transition: color 0.2s, background-color 0.2s;
            z-index: 10;
            font-weight: bold;
            color: #4C4C4C; /* allgood-dark */
        }
        .flight-type-option.active {
            color: white;
        }
        #switch-indicator {
            position: absolute;
            top: 4px;
            bottom: 4px;
            width: calc(50% - 4px);
            background-color: white;
            border-radius: 6px;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            z-index: 5;
        }
        .flight-type-switch-container[data-state="international"] #switch-indicator {
            transform: translateX(100%);
            background-color: #D34716; /* allgood-primary */
        }
        .flight-type-switch-container[data-state="domestic"] #switch-indicator {
            transform: translateX(0);
            background-color: #357889; /* allgood-secondary */
        }

        /* --- COMMITMENT CARDS (Page 30) --- */
        .commitment-card { background-color: transparent; width: 100%; height: 280px; perspective: 1000px; cursor: pointer; }
        .commitment-card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.8s; transform-style: preserve-3d; }
        .commitment-card.flipped .commitment-card-inner { transform: rotateY(180deg); }
        .commitment-card-front, .commitment-card-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 1.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .commitment-card-front { background-color: white; border: 2px solid #357889; color: #357889; }
        .commitment-card-back { background-color: #357889; color: white; transform: rotateY(180deg); border: 2px solid #357889; }
    </style>
</head>
<body class="flex flex-col min-h-screen text-allgood-dark font-body overflow-y-auto">

    <main class="flex-grow flex items-center justify-center py-8">
        <div class="tablet-frame">
            <div class="screen-container" id="screen">

                <!-- 1. STARTUP SCREEN -->
                <!-- FIX: Replaced static gray with Allgood Brand Gradient (Deep Cyan -> Dark Accent) -->
                <div id="startup-screen" class="absolute inset-0 z-[300] flex flex-col items-center justify-center cursor-pointer transition-opacity duration-700 ease-in-out bg-gradient-to-br from-allgood-secondary to-allgood-accent">
                    <div class="group flex flex-col items-center justify-center text-center h-full w-full relative">
                        <div class="flex-grow flex flex-col items-center justify-center px-4">
                            <div class="relative">
                                <!-- Adjusted glow effect to be white/cyan based instead of primary/orange for better harmony, or kept subtle -->
                                <div class="absolute inset-0 bg-white/10 blur-2xl rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                                <h2 class="text-xl md:text-3xl font-heading font-bold text-white mb-1 relative z-10">Airport Navigator</h2>
                                <h1 class="text-4xl md:text-6xl font-heading font-bold text-allgood-primary tracking-tighter relative z-10 drop-shadow-md">GoodBlock</h1>
                            </div>
                            <p class="mt-12 text-white/80 text-xs tracking-[0.3em] uppercase font-medium group-hover:text-white transition-colors animate-pulse font-body">Click to Power Up</p>
                        </div>
                        <div class="absolute bottom-10 w-full text-center">
                            <p class="text-white/40 text-xs font-body tracking-wide">Powered by the <span class="text-white/60 font-bold">Allgood Academy</span></p>
                        </div>
                    </div>
                </div>

                <!-- 2. Header (Navigation & Controls) -->
                <header class="bg-allgood-secondary shadow-md navbar-content flex items-center">
                    <div class="w-full px-4 flex items-center justify-between h-full">
                        <div class="flex items-center overflow-hidden">
                            <!-- FIX: Removed flex-shrink-0 so title truncates instead of pushing counter off -->
                            <div id="header-welcome-text" class="text-white font-heading font-bold text-lg tracking-tight truncate mr-4 select-none">Airport Navigator</div>
                            
                            <!-- FIX: Added shrink-0 so counter stays visible -->
                            <div class="flex shrink-0 items-center bg-black/20 rounded-full px-3 py-1 border border-white/10 shadow-inner backdrop-blur-sm">
                                <span class="text-[10px] uppercase tracking-wider text-white/60 mr-2 font-heading font-bold">Page</span>
                                <span id="header-page-indicator" class="text-xs font-bold text-white font-body tabular-nums">1 / 31</span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-1 shrink-0 relative">
                            <!-- Home / Reset Button -->
                            <button id="home-button" class="text-gray-200 hover:text-white transition-colors p-2 rounded-full hover:bg-white/10 mr-2" title="Go to Cover (Long-Press to Reset)"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg></button>
                            <div class="h-6 w-px bg-white/20 mx-1"></div>
                            <!-- Blueprint Mode Toggle -->
                            <button id="blueprint-toggle" class="text-gray-200 hover:text-cyan-300 transition-colors p-2 rounded-full hover:bg-white/10" title="Blueprint Mode"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg></button>
                            <!-- Fullscreen Toggle -->
                            <button id="fullscreen-toggle" class="text-gray-200 hover:text-green-300 transition-colors p-2 rounded-full hover:bg-white/10" title="Focus Mode"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" /></svg></button>
                            <!-- Menu/TOC Toggle -->
                            <button id="menu-toggle" class="text-gray-200 hover:text-white transition-colors p-2 rounded-full hover:bg-white/10" title="Jump to Page"><svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg></button>
                        </div>
                    </div>
                </header>

                <!-- 3. Login Modal (UPDATED: Google Sign-In) -->
                <div id="login-modal" class="absolute inset-0 z-[200] bg-allgood-dark/95 flex items-center justify-center p-6 visible-modal modal-transition">
                    <div class="bg-white rounded-lg shadow-2xl p-8 max-w-sm w-full text-center border-t-4 border-allgood-primary">
                        <div class="mb-6">
                            <h2 class="text-3xl font-heading font-bold text-allgood-dark">Allgood<span class="text-allgood-primary">Academy</span></h2>
                        </div>
                        <h2 class="text-xl font-bold text-allgood-dark mb-2 font-heading">Welcome</h2>
                        <div class="flex items-center justify-center gap-2 mb-6 relative">
                            <p class="text-gray-500 text-sm font-body">Please sign in to start.</p>
                            <button id="policy-trigger" class="group relative flex items-center text-allgood-primary hover:text-allgood-hover transition-colors focus:outline-none">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                                <span class="text-xs font-bold underline decoration-dotted underline-offset-2">Why?</span>
                                <div class="absolute top-full left-1/2 transform -translate-x-1/2 mt-3 w-64 p-3 bg-gray-800 text-white text-xs text-left rounded shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible group-focus:opacity-100 group-focus:visible transition-all duration-200 z-50 font-body leading-relaxed border border-gray-700 pointer-events-none">
                                    <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-b-gray-800"></div>
                                    <strong class="block text-allgood-primary mb-1 uppercase tracking-wide text-[10px]">Why do we ask?</strong>
                                    <p class="mb-2 text-gray-300">We use your name to personalize your badge. <strong>Performance data is logged in real-time</strong> to improve the GoodBlock experience. All personal data is <strong>kept confidential</strong> and <strong>never sold.</strong></p>
                                    <div class="border-t border-gray-700 my-1 pt-1"></div>
                                    <p class="text-gray-300"><strong>Email (Optional):</strong> Enter to join the Allgood Academy community.</p>
                                </div>
                            </button>
                        </div>
                        <input type="text" id="user-name-input" placeholder="Your Name (Optional)" class="w-full border border-gray-300 rounded p-3 mb-3 focus:ring-2 focus:ring-allgood-primary focus:border-transparent outline-none transition-all font-body">
                        <input type="email" id="user-email-input" placeholder="Your Email (Optional)" class="w-full border border-gray-300 rounded p-3 mb-6 focus:ring-2 focus:ring-allgood-primary focus:border-transparent outline-none transition-all font-body">
                        
                        <button id="btn-guest-login" onclick="window.handleGuestLogin()" class="w-full bg-allgood-primary hover:bg-allgood-hover text-white font-bold py-3 rounded shadow-md transition-transform transform hover:scale-[1.02] active:scale-[0.98] font-body uppercase">
                            Start Mission
                        </button>

                        <div class="mt-4 flex items-center justify-center space-x-2">
                             <div class="h-px w-10 bg-gray-200"></div>
                             <p class="text-xs text-gray-500 uppercase font-bold">OR</p>
                             <div class="h-px w-10 bg-gray-200"></div>
                        </div>

                        <button id="google-icon-container" onclick="window.handleGoogleLogin()" 
                                class="mt-4 p-2 rounded-full border border-gray-300 shadow-md hover:shadow-lg transition-all duration-200 hover:scale-105 active:scale-95 bg-white flex items-center justify-center mx-auto">
                            <svg class="w-6 h-6" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                                <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                                <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                                <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- 4. Image Modal (Unused in current content, but kept for future expansion) -->
                <div id="image-modal" class="hidden-modal absolute inset-0 z-[250] bg-black/90 flex items-center justify-center p-4 modal-transition" onclick="closeImageModal()">
                    <img id="expanded-image" src="" class="max-w-full max-h-full rounded shadow-2xl cursor-pointer" alt="Expanded View">
                    <div class="absolute bottom-4 text-white/70 text-xs font-body">Click anywhere to close</div>
                </div>

                <!-- 4b. Scenario Outcome Modal (New for Page 10 & 13) -->
                <div id="scenario-modal" class="hidden-modal absolute inset-0 z-[260] bg-allgood-dark/90 flex items-center justify-center p-4 modal-transition" onclick="closeScenarioModal()">
                    <div class="bg-white rounded-lg shadow-2xl p-6 max-w-sm w-full text-center relative border-t-4 border-allgood-secondary" onclick="event.stopPropagation()">
                        <div id="scenario-icon" class="mx-auto w-16 h-16 rounded-full flex items-center justify-center mb-4 text-3xl transition-colors"></div>
                        <h3 id="scenario-title" class="text-xl font-heading font-bold text-allgood-dark mb-2"></h3>
                        <p id="scenario-feedback" class="text-sm text-gray-600 font-body mb-6 leading-relaxed"></p>
                        <button onclick="closeScenarioModal()" class="bg-allgood-dark text-white px-6 py-2 rounded-full font-bold text-xs uppercase tracking-wider hover:bg-allgood-primary transition-colors shadow-md">Continue</button>
                    </div>
                </div>

                <!-- 5. Navigation Menu (TOC) -->
                <div id="menu-modal" class="hidden-modal absolute inset-0 z-[100] bg-black/60 flex justify-end modal-transition">
                    <div class="w-72 h-full bg-white shadow-xl flex flex-col border-l border-gray-200">
                        <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                            <span class="font-bold text-allgood-dark font-heading">Table of Contents</span>
                            <button id="close-menu" class="text-gray-500 hover:text-allgood-primary"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
                        </div>
                        <div class="p-2 overflow-y-auto flex-grow space-y-1 text-sm font-body">
                            <button class="menu-link w-full text-left px-4 py-1.5 hover:bg-gray-100 text-gray-600 font-bold" data-page="0">1. Cover Page</button>
                            <button class="menu-link w-full text-left px-4 py-1.5 hover:bg-gray-100 text-gray-600" data-page="1">2. Introduction</button>
                            <button class="menu-link w-full text-left px-4 py-1.5 hover:bg-gray-100 text-gray-600 font-bold" data-page="2">3. Operational Overview</button>
                            
                            <div class="px-4 py-1 text-xs font-bold text-gray-400 uppercase tracking-wider mt-2">PHASE I: Pre-Flight</div>
                            <button class="menu-link w-full text-left px-4 py-1.5 hover:bg-gray-100 text-gray-600 font-bold text-allgood-primary" data-page="3">4. Phase I Header</button>
                            <button class="menu-link w-full text-left px-4 py-1.5 hover:bg-gray-100 text-gray-600" data-page="4">5. The 3-Hour Rule</button>
                            <button class="menu-link w-full text-left px-4 py-1.5 hover:bg-gray-100 text-gray-600" data-page="5">6. Timing Calculator</button>
                            <button class="menu-link w-full text-left px-4 py-1.5 hover:bg-gray-100 text-gray-600" data-page="6">7. Baggage Logic</button>
                            <button class="menu-link w-full text-left px-4 py-1.5 hover:bg-gray-100 text-gray-600" data-page="7">8. Baggage Sort</button>
                            <button class="menu-link w-full text-left px-4 py-1.5 hover:bg-gray-100 text-gray-600" data-page="8">9. Heavy Fees</button>
                            <button class="menu-link w-full text-left px-4 py-1.5 hover:bg-gray-100 text-gray-600" data-page="9">10. Fee Quiz</button>
                            
                            <div class="px-4 py-1 text-xs font-bold text-gray-400 uppercase tracking-wider mt-2">PHASE II: Check-In</div>
                            <button class="menu-link w-full text-left px-4 py-1.5 hover:bg-gray-100 text-gray-600 font-bold text-allgood-primary" data-page="10">11. Phase II Header</button>
                            <button class="menu-link w-full text-left px-4 py-1.5 hover:bg-gray-100 text-gray-600" data-page="11">12. Strategy</button>
                            <button class="menu-link w-full text-left px-4 py-1.5 hover:bg-gray-100 text-gray-600" data-page="12">13. Decision</button>
                            <button class="menu-link w-full text-left px-4 py-1.5 hover:bg-gray-100 text-gray-600" data-page="13">14. Tag Audit Info</button>
                            <button class="menu-link w-full text-left px-4 py-1.5 hover:bg-gray-100 text-gray-600" data-page="14">15. Visual Audit</button>
                            
                            <div class="px-4 py-1 text-xs font-bold text-gray-400 uppercase tracking-wider mt-2">PHASE III: Security</div>
                            <button class="menu-link w-full text-left px-4 py-1.5 hover:bg-gray-100 text-gray-600 font-bold text-allgood-primary" data-page="15">16. Phase III Header</button>
                            <button class="menu-link w-full text-left px-4 py-1.5 hover:bg-gray-100 text-gray-600" data-page="16">17. Liquids Rule</button>
                            <button class="menu-link w-full text-left px-4 py-1.5 hover:bg-gray-100 text-gray-600" data-page="17">18. Liquid Audit</button>
                            <button class="menu-link w-full text-left px-4 py-1.5 hover:bg-gray-100 text-gray-600" data-page="18">19. Tech Prep</button>
                            <button class="menu-link w-full text-left px-4 py-1.5 hover:bg-gray-100 text-gray-600" data-page="19">20. Tech Toggle</button>
                            <button class="menu-link w-full text-left px-4 py-1.5 hover:bg-gray-100 text-gray-600" data-page="20">21. Line Flow</button>
                            <button class="menu-link w-full text-left px-4 py-1.5 hover:bg-gray-100 text-gray-600" data-page="21">22. Sequence Line</button>
                            
                            <div class="px-4 py-1 text-xs font-bold text-gray-400 uppercase tracking-wider mt-2">PHASE IV: Boarding</div>
                            <button class="menu-link w-full text-left px-4 py-1.5 hover:bg-gray-100 text-gray-600 font-bold text-allgood-primary" data-page="22">23. Phase IV Header</button>
                            <button class="menu-link w-full text-left px-4 py-1.5 hover:bg-gray-100 text-gray-600" data-page="23">24. Finding Gate</button>
                            <button class="menu-link w-full text-left px-4 py-1.5 hover:bg-gray-100 text-gray-600" data-page="24">25. Source of Truth</button>
                            <button class="menu-link w-full text-left px-4 py-1.5 hover:bg-gray-100 text-gray-600" data-page="25">26. Boarding Strategy</button>
                            <button class="menu-link w-full text-left px-4 py-1.5 hover:bg-gray-100 text-gray-600" data-page="26">27. Boarding Quiz</button>
                            <button class="menu-link w-full text-left px-4 py-1.5 hover:bg-gray-100 text-gray-600" data-page="27">28. Arrival Flow</button>
                            <!-- FIX: Inserted new Final Quiz entry -->
                            <button class="menu-link w-full text-left px-4 py-1.5 hover:bg-gray-100 text-gray-600 font-bold text-allgood-primary" data-page="28">29. Flight Readiness Check</button>
                            <button class="menu-link w-full text-left px-4 py-1.5 hover:bg-gray-100 text-gray-600 font-bold text-allgood-secondary" data-page="29">30. The Principled Traveler</button>
                            <!-- FIX: Shifted Credits to end -->
                            <button class="menu-link w-full text-left px-4 py-1.5 hover:bg-gray-100 text-gray-600" data-page="30">31. Credits</button>
                        </div>
                    </div>
                </div>

                <!-- --- PAGES --- -->

                <!-- Page 1: Cover -->
                <div class="page active" id="page-1">
                    <div class="flex flex-col items-center justify-start h-full text-center px-2 pt-12">
                        <div class="mb-6"><h2 class="text-2xl font-heading font-bold text-allgood-dark">Allgood<span class="text-allgood-primary">Academy</span></h2></div>
                        <h1 class="text-3xl sm:text-4xl font-heading font-bold text-allgood-dark mb-8 leading-tight tracking-tight">Airport Navigator:<br><span class="text-allgood-primary">GoodBlock</span></h1>
                        <div class="w-full max-w-lg text-left mx-auto">
                            <button class="accordion-toggle w-full bg-white border border-gray-200 p-4 rounded-lg shadow-md flex justify-between items-center hover:bg-gray-50 hover:border-allgood-primary transition-all group">
                                <span class="font-bold text-allgood-dark text-base group-hover:text-allgood-primary transition-colors font-heading">How to use this GoodBlock</span>
                                <svg class="accordion-icon h-5 w-5 text-gray-400 transform transition-transform duration-300 group-hover:text-allgood-primary" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            </button>
                            <div class="accordion-content hidden bg-gray-50 border-x border-b border-gray-200 rounded-b-lg p-5 text-gray-600 shadow-inner text-xs font-body">
                                <p class="mb-4 text-sm text-allgood-dark">This GoodBlock is your interactive workspace. Use the <strong>Control Cluster</strong> in the top right to customize your environment.</p>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div class="flex items-start"><div class="p-1.5 bg-white rounded border border-gray-300 mr-3 text-allgood-primary"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg></div><div><strong class="text-allgood-dark block mb-0.5">Home & Reset</strong><span class="text-gray-500 leading-snug">Click to return to cover. <strong>Hold for 2s</strong> to hard reset & sign out.</span></div></div>
                                    <div class="flex items-start"><div class="p-1.5 bg-white rounded border border-gray-300 mr-3 text-cyan-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg></div><div><strong class="text-allgood-dark block mb-0.5">Blueprint Mode</strong><span class="text-gray-500 leading-snug">Toggle high-contrast Dark Mode for low-light environments.</span></div></div>
                                    <div class="flex items-start"><div class="p-1.5 bg-white rounded border border-gray-300 mr-3 text-green-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" /></svg></div><div><strong class="text-allgood-dark block mb-0.5">Focus Mode</strong><span class="text-gray-500 leading-snug">Maximize workspace. Removes the frame for mobile devices.</span></div></div>
                                    <div class="flex items-start"><div class="p-1.5 bg-white rounded border border-gray-300 mr-3 text-allgood-dark"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg></div><div><strong class="text-allgood-dark block mb-0.5">Table of Contents</strong><span class="text-gray-500 leading-snug">Jump directly to any section without losing progress.</span></div></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Page 2: Narrative Hook -->
                <div class="page" id="page-2">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark mb-2">Mission Briefing</h2></section>
                    <div class="bg-white p-6 rounded border border-gray-200 shadow-sm leading-relaxed text-gray-700 text-lg">
                        <p class="mb-6"><strong>Listen closely.</strong> You are about to enter one of the most complex logistical environments on earth: An International Airport.</p>
                        
                        <!-- Visual Readout / Illustration -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 text-center text-sm">
                            <!-- The Loadout -->
                            <div class="group relative p-3 border rounded-lg bg-gray-50 border-gray-200 hover:bg-allgood-primary/10 transition-colors cursor-pointer" onclick="toggleMissionTooltip('loadout')">
                                <i data-lucide="package" class="w-6 h-6 mx-auto text-allgood-secondary mb-2"></i>
                                <strong class="text-allgood-dark">The Loadout</strong>
                                <!-- Tooltip -->
                                <div id="tooltip-mission-loadout" class="mission-tooltip hidden absolute top-full left-1/2 -translate-x-1/2 mt-3 w-64 bg-allgood-dark text-white text-xs p-4 rounded shadow-xl text-center border border-gray-600 z-50">
                                    <strong class="block text-allgood-secondary mb-2 uppercase text-sm">Know Your Limits</strong>
                                    <p class="leading-relaxed text-gray-300">You get one Carry-On (overhead bin) and one Personal Item (under the seat). Anything larger or heavier than 50lbs must be checked for a fee.</p>
                                    <div class="absolute bottom-full left-1/2 -translate-x-1/2 border-4 border-transparent border-b-allgood-dark"></div>
                                </div>
                            </div>

                            <!-- Security Compliance -->
                            <div class="group relative p-3 border rounded-lg bg-gray-50 border-gray-200 hover:bg-allgood-primary/10 transition-colors cursor-pointer" onclick="toggleMissionTooltip('security')">
                                <i data-lucide="shield-alert" class="w-6 h-6 mx-auto text-red-500 mb-2"></i>
                                <strong class="text-allgood-dark">Security Compliance</strong>
                                <!-- Tooltip -->
                                <div id="tooltip-mission-security" class="mission-tooltip hidden absolute top-full left-1/2 -translate-x-1/2 mt-3 w-64 bg-allgood-dark text-white text-xs p-4 rounded shadow-xl text-center border border-gray-600 z-50">
                                    <strong class="block text-red-400 mb-2 uppercase text-sm">The 3-1-1 Rule</strong>
                                    <p class="leading-relaxed text-gray-300">All liquids must be under 3.4oz and fit in one quart-sized bag. Electronics larger than a phone must be removed from your bag at the checkpoint.</p>
                                    <div class="absolute bottom-full left-1/2 -translate-x-1/2 border-4 border-transparent border-b-allgood-dark"></div>
                                </div>
                            </div>

                            <!-- Time Scarcity -->
                            <div class="group relative p-3 border rounded-lg bg-gray-50 border-gray-200 hover:bg-allgood-primary/10 transition-colors cursor-pointer" onclick="toggleMissionTooltip('time')">
                                <i data-lucide="clock" class="w-6 h-6 mx-auto text-allgood-primary mb-2"></i>
                                <strong class="text-allgood-dark">Time Scarcity</strong>
                                <!-- Tooltip -->
                                <div id="tooltip-mission-time" class="mission-tooltip hidden absolute top-full left-1/2 -translate-x-1/2 mt-3 w-64 bg-allgood-dark text-white text-xs p-4 rounded shadow-xl text-center border border-gray-600 z-50">
                                    <strong class="block text-allgood-primary mb-2 uppercase text-sm">The 3-Hour Rule</strong>
                                    <p class="leading-relaxed text-gray-300">International flights have a hard cutoff. You need a buffer for the variables you can't control: traffic, check-in queues, and TSA screening lines.</p>
                                    <div class="absolute bottom-full left-1/2 -translate-x-1/2 border-4 border-transparent border-b-allgood-dark"></div>
                                </div>
                            </div>
                        </div>
                        
                        <p class="mb-6">Schools teach you geometry, but they rarely teach you how to navigate a federal security checkpoint with 500 people behind you. That changes now.</p>
                        
                        <p class="mb-6"><strong>This is not a test. It is a simulation.</strong></p>
                        
                        <p>We are going to walk through the chaos togetherfrom the curb to the gate. You will make the strategic decisions, handle the loadout, and clear security right here. If you fail here, you reset. If you fail there, you miss your flight.</p>

                        <p class="mt-6 font-bold text-allgood-primary">Let's get you ready to deploy.</p>
                    </div>
                </div>

                <!-- Page 3: Operational Overview -->
                <div class="page" id="page-3">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark mb-2">Operational Overview</h2></section>
                    <p class="text-gray-600 mb-12 text-sm">We are breaking the airport mission into four distinct phases, each with its own logistical challenges. <strong>Click each phase below</strong> to preview the obstacles you will face. You will then train specifically for each sector as you move forward.</p>
                    
                    <div class="relative w-full px-4 py-8">
                        <!-- The Track -->
                        <div class="absolute top-1/2 left-8 right-8 h-1 bg-gray-300 -translate-y-1/2 -z-0 rounded"></div>
                        
                        <div class="flex justify-between relative z-10 px-2">
                            <!-- Phase 1 -->
                            <div class="group relative flex flex-col items-center cursor-pointer" onclick="toggleMapTooltip('1')">
                                <div class="w-12 h-12 rounded-full bg-white border-4 border-allgood-primary flex items-center justify-center shadow-md hover:scale-110 transition-transform bg-allgood-light relative z-10">
                                    <i data-lucide="clock" class="w-5 h-5 text-allgood-primary"></i>
                                </div>
                                <div class="mt-4 text-[10px] font-bold text-gray-500 uppercase tracking-widest bg-[#F7F7F7] px-2 rounded relative z-10">Phase I</div>
                                
                                <!-- Tooltip -->
                                <div id="tooltip-1" class="map-tooltip hidden absolute bottom-20 w-48 bg-allgood-dark text-white text-xs p-4 rounded shadow-xl text-center border border-gray-600 z-50">
                                    <strong class="block text-allgood-primary mb-2 uppercase text-sm">Pre-Flight</strong>
                                    <p class="leading-relaxed text-gray-300">Calculate your mandatory arrival buffer (2 vs 3 hours) and verify your ID status. Strategize your baggage loadout now to avoid fees and delays.</p>
                                    <div class="absolute -bottom-2 left-1/2 -translate-x-1/2 w-0 h-0 border-l-8 border-r-8 border-t-8 border-transparent border-t-allgood-dark"></div>
                                </div>
                            </div>

                            <!-- Phase 2 -->
                            <div class="group relative flex flex-col items-center cursor-pointer" onclick="toggleMapTooltip('2')">
                                <div class="w-12 h-12 rounded-full bg-white border-4 border-allgood-secondary flex items-center justify-center shadow-md hover:scale-110 transition-transform relative z-10">
                                    <i data-lucide="ticket" class="w-5 h-5 text-allgood-secondary"></i>
                                </div>
                                <div class="mt-4 text-[10px] font-bold text-gray-500 uppercase tracking-widest bg-[#F7F7F7] px-2 rounded relative z-10">Phase II</div>
                                 <!-- Tooltip -->
                                <div id="tooltip-2" class="map-tooltip hidden absolute bottom-20 w-48 bg-allgood-dark text-white text-xs p-4 rounded shadow-xl text-center border border-gray-600 z-50">
                                    <strong class="block text-allgood-secondary mb-2 uppercase text-sm">Check-In</strong>
                                    <p class="leading-relaxed text-gray-300">Select your check-in vector (Counter vs. Kiosk) and verify your passport. Audit the 3-letter code on your luggage tag immediately to prevent lost cargo.</p>
                                    <div class="absolute -bottom-2 left-1/2 -translate-x-1/2 border-4 border-transparent border-t-8 border-t-allgood-dark"></div>
                                </div>
                            </div>

                            <!-- Phase 3 -->
                            <div class="group relative flex flex-col items-center cursor-pointer" onclick="toggleMapTooltip('3')">
                                <div class="w-12 h-12 rounded-full bg-white border-4 border-red-500 flex items-center justify-center shadow-md hover:scale-110 transition-transform relative z-10">
                                    <i data-lucide="shield-check" class="w-5 h-5 text-red-500"></i>
                                </div>
                                <div class="mt-4 text-[10px] font-bold text-gray-500 uppercase tracking-widest bg-[#F7F7F7] px-2 rounded relative z-10">Phase III</div>
                                 <!-- Tooltip -->
                                <div id="tooltip-3" class="map-tooltip hidden absolute bottom-20 w-48 bg-allgood-dark text-white text-xs p-4 rounded shadow-xl text-center border border-gray-600 z-50">
                                    <strong class="block text-red-400 mb-2 uppercase text-sm">Security</strong>
                                    <p class="leading-relaxed text-gray-300">Master the divestment flow: separate large electronics and 3-1-1 liquids into trays. Remove shoes and outerwear to ensure a clean scan.</p>
                                    <div class="absolute -bottom-2 left-1/2 -translate-x-1/2 border-4 border-transparent border-t-8 border-t-allgood-dark"></div>
                                </div>
                            </div>

                            <!-- Phase 4 -->
                            <div class="group relative flex flex-col items-center cursor-pointer" onclick="toggleMapTooltip('4')">
                                <div class="w-12 h-12 rounded-full bg-white border-4 border-green-500 flex items-center justify-center shadow-md hover:scale-110 transition-transform relative z-10">
                                    <i data-lucide="plane-takeoff" class="w-5 h-5 text-green-500"></i>
                                </div>
                                <div class="mt-4 text-[10px] font-bold text-gray-500 uppercase tracking-widest bg-[#F7F7F7] px-2 rounded relative z-10">Phase IV</div>
                                 <!-- Tooltip -->
                                <div id="tooltip-4" class="map-tooltip hidden absolute bottom-20 -right-4 w-48 bg-allgood-dark text-white text-xs p-4 rounded shadow-xl text-center border border-gray-600 z-50">
                                    <strong class="block text-green-400 mb-2 uppercase text-sm">Boarding</strong>
                                    <p class="leading-relaxed text-gray-300">Confirm your gate on digital screens, not paper tickets. Board immediately when your group is called to secure overhead bin space.</p>
                                    <div class="absolute -bottom-2 right-8 w-0 h-0 border-l-8 border-r-8 border-t-8 border-transparent border-t-allgood-dark"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-100 p-4 rounded border border-gray-200 text-center mt-16 mx-auto max-w-md">
                        <p class="text-xs text-gray-500 italic">"An operation without a map is just a hike."</p>
                    </div>
                </div>

                <!-- Page 4: Phase I Header -->
                <div class="page" id="page-4">
                    <div class="flex flex-col items-center justify-center h-full text-center bg-allgood-secondary text-white rounded -m-5 p-8 shadow-inner">
                        <div class="bg-white/20 p-6 rounded-full mb-6 backdrop-blur-sm">
                            <i data-lucide="clock" class="w-16 h-16 text-white"></i>
                        </div>
                        <h2 class="text-4xl font-heading font-bold mb-2 tracking-tight">PHASE I</h2>
                        <h3 class="text-xl font-body font-bold text-white/80 mb-4">Pre-Flight Protocol</h3>
                        <div class="w-16 h-1 bg-white/40 rounded mb-6"></div>
                        <p class="text-sm max-w-md leading-relaxed text-white/90">Success is determined before you even leave your house. Timing, loadout, and strategy are your primary weapons.</p>
                    </div>
                </div>

                <!-- Page 5: 3-Hour Rule -->
                <div class="page" id="page-5">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark mb-2">The Time Buffer Protocol</h2></section>
                    <div class="flex gap-6 items-start">
                        <div class="bg-blue-50 p-4 rounded-full text-blue-600 flex-shrink-0"><i data-lucide="clock" class="w-8 h-8"></i></div>
                        <div>
                            <h3 class="font-bold text-lg text-allgood-dark mb-3">Why the buffer?</h3>
                            <p class="text-gray-600 mb-4 leading-relaxed">International flights are massive operations. You aren't just boarding a bus; you are clearing federal law enforcement. You must clear <span class="term" tabindex="0">Customs<span class="term-def">Government agency that checks if you (and your stuff) are allowed to leave or enter the country.</span></span> and verify your passport before you even see a security tray.</p>
                            <p class="text-gray-600 mb-4"><strong>The Reality:</strong> If you cut it close, you risk the "closed door" policy. Once the pilot signs the manifest, that door does not open for anyone. Not even you.</p>
                            <div class="bg-gray-100 border-l-4 border-allgood-primary p-4 text-gray-800 font-bold shadow-sm">
                                The Golden Rule: 3 Hours for International. 2 Hours for Domestic. This is your insurance policy.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Page 6: Timing Calculator -->
                <div class="page" id="page-6">
                    <section class="mb-6 border-b border-gray-200 pb-4">
                        <h2 class="text-2xl font-heading font-bold text-allgood-dark mb-2">Mission Briefing: The Timeline</h2>
                        <p class="text-sm text-gray-600 leading-relaxed">Your departure strategy depends entirely on your destination. One wrong calculation here cascades into chaos at the gate. Set your mission parameters below.</p>
                    </section>
                    <div class="bg-white p-6 rounded border border-gray-200 shadow-sm mb-6">
                        <label class="block text-sm font-bold text-allgood-dark mb-4">Select Mission Profile:</label>
                        <!-- START TARGETED FIX: Replace slider with 2-state switch -->
                        <div id="flight-type-switch" class="flight-type-switch-container max-w-md mx-auto" data-state="domestic">
                            <div id="switch-indicator"></div>
                            <div class="flight-type-option text-sm" data-value="0">Domestic Standard</div>
                            <div class="flight-type-option text-sm" data-value="1">International Protocol</div>
                        </div>
                        <!-- END TARGETED FIX -->
                    </div>
                    
                    <div id="flight-result" class="bg-gray-100 p-6 rounded border border-gray-200 transition-all duration-300">
                        <div class="flex items-center mb-4">
                            <div id="time-icon" class="bg-blue-100 text-blue-600 p-2 rounded-full mr-3 transition-colors">
                                <i data-lucide="clock" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg text-allgood-dark">Arrival: <span id="time-val">2 Hours Early</span></h3>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <strong class="block text-xs uppercase tracking-wider text-gray-400 mb-1">The Strategy</strong>
                            <p id="why-val" class="text-sm text-gray-600 leading-relaxed">The variable here is the TSA checkpoint. Lines fluctuate wildly. A 2-hour buffer transforms a frantic run into a calm walk.</p>
                        </div>

                        <div class="p-4 bg-white rounded border border-l-4 border-gray-300 shadow-sm transition-colors" id="action-box">
                            <strong class="block text-xs uppercase tracking-wider text-gray-400 mb-1">Immediate Action</strong>
                            <div class="flex items-start">
                                <i data-lucide="check-circle" class="w-4 h-4 mr-2 mt-0.5 text-allgood-primary flex-shrink-0"></i>
                                <p id="action-val" class="text-sm font-bold text-allgood-dark">Pull out your Wallet. Confirm you have your Real ID or Driver's License right now.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Page 7: Baggage Logic (ARTIFACT UPGRADE) -->
                <div class="page" id="page-7">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark mb-2">Loadout Blueprint</h2></section>
                    <p class="text-gray-600 mb-6 text-lg">Know your cargo constraints. Visualize the space you actually have.</p>
                    
                    <div class="grid grid-cols-1 gap-4">
                        <!-- Personal Item: Dashed Box -->
                        <div class="p-4 border-2 border-dashed border-gray-400 rounded bg-gray-50 flex items-center relative">
                            <div class="absolute -top-3 left-4 bg-gray-200 text-gray-600 text-[10px] font-bold px-2 py-1 uppercase tracking-wide">Under Seat</div>
                            <i data-lucide="backpack" class="w-10 h-10 text-gray-500 mr-4"></i>
                            <div>
                                <h3 class="font-bold text-sm text-allgood-dark">Personal Item</h3>
                                <p class="text-xs text-gray-500">Survival Kit. Passport, meds, charger. Never leaves your sight.</p>
                            </div>
                        </div>

                        <!-- Carry-On: Hard Shell -->
                        <div class="p-4 border-4 border-gray-300 rounded-lg bg-white shadow-sm flex items-center relative">
                            <div class="absolute -top-3 left-4 bg-allgood-secondary text-white text-[10px] font-bold px-2 py-1 uppercase tracking-wide">Overhead Bin</div>
                            <i data-lucide="briefcase" class="w-10 h-10 text-allgood-secondary mr-4"></i>
                            <div>
                                <h3 class="font-bold text-sm text-allgood-dark">Carry-On</h3>
                                <p class="text-xs text-gray-500">9 x 14 x 22 inches. If it bulges, it checks.</p>
                            </div>
                        </div>

                        <!-- Checked Bag: Heavy -->
                        <div class="p-4 bg-gray-800 rounded-lg shadow-lg flex items-center text-white relative border border-gray-900">
                            <div class="absolute -top-3 left-4 bg-allgood-primary text-white text-[10px] font-bold px-2 py-1 uppercase tracking-wide">Cargo Hold</div>
                            <i data-lucide="luggage" class="w-10 h-10 text-gray-400 mr-4"></i>
                            <div>
                                <h3 class="font-bold text-sm text-white">Checked Bag</h3>
                                <p class="text-xs text-gray-400">Heavy Cargo. 50lbs Max. Kiss it goodbye at the counter.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Page 8: Baggage Sort -->
                <div class="page" id="page-8">
                    <section class="mb-4 border-b border-gray-200 pb-2"><h2 class="text-xl font-heading font-bold text-allgood-dark">Sort Rules, Not Just Bags</h2></section>
                    <p class="text-sm text-gray-600 mb-4">Mastering these rules prevents unexpected fees and forced gate-checking. <strong>Drag each constraint</strong> to its correct storage location to verify you know exactly where your gear belongs.</p>
                    <div class="grid grid-cols-3 gap-2 mb-4">
                        <div class="drop-zone p-2 bg-gray-50 border-2 border-dashed border-gray-300 rounded min-h-[120px] flex flex-col items-center justify-center" data-cat="personal"><span class="text-xs font-bold text-gray-400 uppercase text-center">Personal Item</span></div>
                        <div class="drop-zone p-2 bg-gray-50 border-2 border-dashed border-gray-300 rounded min-h-[120px] flex flex-col items-center justify-center" data-cat="carryon"><span class="text-xs font-bold text-gray-400 uppercase text-center">Carry-On</span></div>
                        <div class="drop-zone p-2 bg-gray-50 border-2 border-dashed border-gray-300 rounded min-h-[120px] flex flex-col items-center justify-center" data-cat="checked"><span class="text-xs font-bold text-gray-400 uppercase text-center">Checked Bag</span></div>
                    </div>
                    <div id="draggables" class="flex flex-wrap gap-2 justify-center">
                        <div class="draggable-item bg-white border border-gray-300 px-3 py-2 rounded text-xs cursor-grab shadow-sm" draggable="true" data-target="personal">Fits under seat</div>
                        <div class="draggable-item bg-white border border-gray-300 px-3 py-2 rounded text-xs cursor-grab shadow-sm" draggable="true" data-target="carryon">9 x 14 x 22 in.</div>
                        <div class="draggable-item bg-white border border-gray-300 px-3 py-2 rounded text-xs cursor-grab shadow-sm" draggable="true" data-target="checked">50 lb Weight Limit</div>
                        <div class="draggable-item bg-white border border-gray-300 px-3 py-2 rounded text-xs cursor-grab shadow-sm" draggable="true" data-target="carryon">Overhead Bin</div>
                        <div class="draggable-item bg-white border border-gray-300 px-3 py-2 rounded text-xs cursor-grab shadow-sm" draggable="true" data-target="checked">Cargo Hold</div>
                    </div>
                    <div class="bg-blue-50 p-3 rounded border border-blue-200 mt-4 text-xs text-blue-800 flex items-start">
                        <i data-lucide="info" class="w-4 h-4 mr-2 flex-shrink-0"></i>
                        <span><strong>Note:</strong> Laptops must be removed from ANY bag (personal or carry-on) at security.</span>
                    </div>
                    <p id="bag-feedback" class="text-center text-sm font-bold mt-2 text-allgood-primary hidden">Correct! Rules mastered.</p>
                </div>

                <!-- Page 9: Heavy Fees (ARTIFACT UPGRADE) -->
                <div class="page" id="page-9">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark mb-2">The Cost of Overload</h2></section>
                    <p class="text-gray-600 mb-6 text-lg">50 LBS is a hard limit. 51 lbs triggers a $100 penalty.</p>
                    
                    <div class="flex flex-col items-center justify-center mb-8">
                        <div class="digital-scale p-6 rounded-lg mb-4">
                            <span class="text-4xl font-bold tracking-widest">55.0</span>
                            <span class="text-xl ml-2">LBS</span>
                        </div>
                        <p class="text-xs text-red-600 font-bold uppercase tracking-widest animate-pulse">OVERWEIGHT WARNING</p>
                    </div>

                    <div class="bg-gray-100 p-4 rounded border border-gray-200">
                        <h3 class="font-bold text-sm text-allgood-dark mb-2">Strategic Pivot</h3>
                        <p class="text-xs text-gray-600">Airlines rarely weigh carry-ons. If you are over the limit, open your bag and move heavy, dense items (shoes, books) to your roller board.</p>
                    </div>
                </div>

                <!-- Page 10: Fee Quiz -->
                <div class="page" id="page-10">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark mb-2">Crisis: The Weigh-In</h2></section>
                    <div class="bg-white p-6 rounded border border-gray-200 shadow-sm">
                        <div class="flex items-center mb-4 border-b pb-3 border-gray-100">
                            <div class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center text-red-600 mr-3 text-xl"><i class="fas fa-weight-hanging"></i></div>
                            <div>
                                <h4 class="font-bold text-lg text-allgood-dark">Scenario: Overweight Bag</h4>
                                <p class="text-sm text-gray-500">You hoist your bag onto the scale. The display blinks: <strong>55.0 LBS</strong>. The limit is 50 LBS. The agent is waiting. What do you do?</p>
                                <p class="text-xs font-bold text-allgood-secondary mt-2 uppercase tracking-wide animate-pulse">Click each option to simulate the outcome.</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <!-- Option A -->
                            <div class="group p-4 border border-gray-200 rounded-lg hover:border-allgood-primary hover:bg-orange-50 cursor-pointer transition-all flex flex-col items-center text-center h-full shadow-sm hover:shadow-md" onclick="showScenarioOutcome('A')">
                                <div class="w-12 h-12 bg-white border border-gray-200 rounded-full flex items-center justify-center mb-3 group-hover:scale-110 transition-transform text-green-600">
                                    <i data-lucide="dollar-sign" class="w-6 h-6"></i>
                                </div>
                                <span class="font-bold text-sm text-allgood-dark">Pay the Fee ($100+)</span>
                            </div>
                            <!-- Option B -->
                            <div class="group p-4 border border-gray-200 rounded-lg hover:border-allgood-primary hover:bg-orange-50 cursor-pointer transition-all flex flex-col items-center text-center h-full shadow-sm hover:shadow-md" onclick="showScenarioOutcome('B')">
                                <div class="w-12 h-12 bg-white border border-gray-200 rounded-full flex items-center justify-center mb-3 group-hover:scale-110 transition-transform text-blue-600">
                                    <i data-lucide="shirt" class="w-6 h-6"></i>
                                </div>
                                <span class="font-bold text-sm text-allgood-dark">Wear Heaviest Clothes</span>
                            </div>
                            <!-- Option C -->
                            <div class="group p-4 border border-allgood-secondary border-2 rounded-lg hover:bg-blue-50 cursor-pointer transition-all flex flex-col items-center text-center h-full shadow-md relative" onclick="showScenarioOutcome('C')">
                                <div class="absolute -top-3 bg-allgood-secondary text-white text-[10px] font-bold px-2 py-0.5 rounded uppercase">Recommended</div>
                                <div class="w-12 h-12 bg-white border border-allgood-secondary rounded-full flex items-center justify-center mb-3 group-hover:scale-110 transition-transform text-allgood-secondary">
                                    <i data-lucide="arrow-right-left" class="w-6 h-6"></i>
                                </div>
                                <span class="font-bold text-sm text-allgood-dark">Shift to Carry-On</span>
                            </div>
                            <!-- Option D -->
                            <div class="group p-4 border border-gray-200 rounded-lg hover:border-allgood-primary hover:bg-orange-50 cursor-pointer transition-all flex flex-col items-center text-center h-full shadow-sm hover:shadow-md" onclick="showScenarioOutcome('D')">
                                <div class="w-12 h-12 bg-white border border-gray-200 rounded-full flex items-center justify-center mb-3 group-hover:scale-110 transition-transform text-red-500">
                                    <i data-lucide="message-square-warning" class="w-6 h-6"></i>
                                </div>
                                <span class="font-bold text-sm text-allgood-dark">Argue with Agent</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Page 11: Phase II Header -->
                <div class="page" id="page-11">
                    <div class="flex flex-col items-center justify-center h-full text-center bg-allgood-secondary text-white rounded -m-5 p-8 shadow-inner">
                        <div class="bg-white/20 p-6 rounded-full mb-6 backdrop-blur-sm">
                            <i data-lucide="ticket" class="w-16 h-16 text-white"></i>
                        </div>
                        <h2 class="text-4xl font-heading font-bold mb-2 tracking-tight">PHASE II</h2>
                        <h3 class="text-xl font-body font-bold text-white/80 mb-4">Check-In Protocol</h3>
                        <div class="w-16 h-1 bg-white/40 rounded mb-6"></div>
                        <p class="text-sm max-w-md leading-relaxed text-white/90">Securing your boarding pass and surrendering your cargo.</p>
                    </div>
                </div>

                <!-- Page 12: Check-In Strategy -->
                <div class="page" id="page-12">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark mb-2">Insertion Point: Check-In</h2></section>
                    <p class="text-gray-600 mb-6 text-lg">You've arrived at the perimeter. Now you have to offload your heavy cargo. You have two choices:</p>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-5 border border-gray-200 rounded bg-gray-50">
                            <h3 class="font-bold text-allgood-dark text-lg mb-2">The Kiosk</h3>
                            <p class="text-sm text-gray-600 leading-relaxed"><strong>The Automaton.</strong> Fast and easy if you are a veteran. But if you have a visa issue or a passport flag, the machine cannot help you.</p>
                        </div>
                        <div class="p-5 border border-allgood-primary border-2 rounded bg-white relative shadow-md">
                            <div class="absolute -top-3 right-4 bg-allgood-primary text-white text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide">Beginners Start Here</div>
                            <h3 class="font-bold text-allgood-primary text-lg mb-2">The Counter</h3>
                            <p class="text-sm text-gray-600 leading-relaxed"><strong>The Human Expert.</strong> They verify your passport, weigh your bag, and tag it for you. Since this is your first international mission, <strong>go here.</strong> Let them handle the variables.</p>
                        </div>
                    </div>
                </div>

                <!-- Page 13: Check-In Scenario -->
                <div class="page" id="page-13">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark mb-2">The Kiosk Temptation</h2></section>
                    <div class="bg-white p-6 rounded border border-gray-200 shadow-sm">
                        <div class="flex items-center mb-4 border-b pb-3 border-gray-100">
                            <div class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center text-red-600 mr-3 text-xl"><i class="fas fa-users"></i></div>
                            <div>
                                <h4 class="font-bold text-lg text-allgood-dark">Scenario: Line Check</h4>
                                <p class="text-sm text-gray-500">The Agent line is 45 minutes deep. The Kiosks are completely empty. You have an international visa. What is your move?</p>
                                <p class="text-xs font-bold text-allgood-secondary mt-2 uppercase tracking-wide animate-pulse">Click each option to simulate the outcome.</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <!-- Option A (Kiosk) -->
                            <div class="group p-4 border border-allgood-secondary border-2 rounded-lg hover:bg-blue-50 cursor-pointer transition-all flex flex-col items-center text-center h-full shadow-md relative" onclick="showScenarioOutcome('Kiosk_Try')">
                                <div class="absolute -top-3 bg-allgood-secondary text-white text-[10px] font-bold px-2 py-0.5 rounded uppercase">Smart Gamble</div>
                                <div class="w-12 h-12 bg-white border border-allgood-secondary rounded-full flex items-center justify-center mb-3 group-hover:scale-110 transition-transform text-allgood-secondary">
                                    <i data-lucide="monitor" class="w-6 h-6"></i>
                                </div>
                                <span class="font-bold text-sm text-allgood-dark">Try Kiosk (2 mins)</span>
                            </div>
                            <!-- Option B (Agent) -->
                            <div class="group p-4 border border-gray-200 rounded-lg hover:border-allgood-primary hover:bg-orange-50 cursor-pointer transition-all flex flex-col items-center text-center h-full shadow-sm hover:shadow-md" onclick="showScenarioOutcome('Agent_Wait')">
                                <div class="w-12 h-12 bg-white border border-gray-200 rounded-full flex items-center justify-center mb-3 group-hover:scale-110 transition-transform text-blue-600">
                                    <i data-lucide="user-check" class="w-6 h-6"></i>
                                </div>
                                <span class="font-bold text-sm text-allgood-dark">Join Agent Line</span>
                            </div>
                            <!-- Option C (Bag Drop Cut) -->
                            <div class="group p-4 border border-gray-200 rounded-lg hover:border-allgood-primary hover:bg-orange-50 cursor-pointer transition-all flex flex-col items-center text-center h-full shadow-sm hover:shadow-md" onclick="showScenarioOutcome('Bag_Drop')">
                                <div class="w-12 h-12 bg-white border border-gray-200 rounded-full flex items-center justify-center mb-3 group-hover:scale-110 transition-transform text-red-500">
                                    <i data-lucide="scissors" class="w-6 h-6"></i>
                                </div>
                                <span class="font-bold text-sm text-allgood-dark">Cut to 'Bag Drop'</span>
                            </div>
                            <!-- Option D (Curbside) -->
                            <div class="group p-4 border border-gray-200 rounded-lg hover:border-allgood-primary hover:bg-orange-50 cursor-pointer transition-all flex flex-col items-center text-center h-full shadow-sm hover:shadow-md" onclick="showScenarioOutcome('Curbside')">
                                <div class="w-12 h-12 bg-white border border-gray-200 rounded-full flex items-center justify-center mb-3 group-hover:scale-110 transition-transform text-yellow-600">
                                    <i data-lucide="car" class="w-6 h-6"></i>
                                </div>
                                <span class="font-bold text-sm text-allgood-dark">Curbside Check-In</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Page 14: Tag Audit -->
                <div class="page" id="page-14">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark mb-2">The Tag Audit</h2></section>
                    <div class="flex items-start gap-6">
                        <div class="bg-yellow-50 p-4 rounded-full text-yellow-600 flex-shrink-0"><i data-lucide="tag" class="w-8 h-8"></i></div>
                        <div>
                            <p class="text-gray-600 mb-4 leading-relaxed">The agent is going to put a sticky tag on your bag and send it down a belt. That tag is the <strong>only thing</strong> telling the sorting system where to send your stuff.</p>
                            <p class="text-gray-600 mb-4">Before you let go of that bag, look at the <span class="term" tabindex="0">IATA Code<span class="term-def">The unique 3-letter code assigned to every airport (e.g., ATL, LHR, JFK).</span></span>. Make sure it matches your final destination.</p>
                            <div class="bg-yellow-50 p-3 border-l-4 border-yellow-400 text-sm text-yellow-800 font-bold">
                                If you are going to London, and the tag says "JFK," speak up immediately.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Page 15: Visual Audit -->
                <div class="page" id="page-15">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark mb-2">Verify the Tag</h2></section>
                    <div class="bg-gray-100 p-4 rounded border border-gray-200 text-center">
                        <div class="inline-block bg-white p-4 shadow-md border border-gray-300 relative mb-6">
                            <div class="font-mono text-left text-xs text-gray-500 mb-2">BAGGAGE TAG // 0029384</div>
                            <!-- Intentional Mismatch: SYD (Sydney) when answer expects LHR (London) -->
                            <div class="font-mono text-4xl font-bold text-allgood-dark tracking-widest">SYD</div>
                            <div class="font-mono text-xs text-gray-400 mt-1">SYDNEY KINGSFORD SMITH</div>
                        </div>
                        <div class="quiz-container">
                            <p class="font-bold text-sm mb-3">Your ticket is to London (LHR). Is this tag correct?</p>
                            <div class="flex gap-4 justify-center">
                                <button class="quiz-btn px-6 py-2 bg-white border border-gray-300 rounded hover:bg-gray-50" onclick="checkAnswer(this)" data-correct="false" data-feedback="STOP. The tag says SYD (Sydney). Your bag is going to Australia while you go to London. Always check the 3-letter code.">Yes</button>
                                <button class="quiz-btn px-6 py-2 bg-white border border-gray-300 rounded" onclick="checkAnswer(this)" data-correct="true" data-feedback="GOOD CATCH. The code SYD (Sydney) does not match your destination (LHR). You just saved your vacation. Alert the agent immediately.">No</button>
                            </div>
                            <div class="feedback mt-3 text-sm hidden font-bold font-body"></div>
                        </div>
                    </div>
                </div>

                <!-- Page 16: Phase III Header -->
                <div class="page" id="page-16">
                    <div class="flex flex-col items-center justify-center h-full text-center bg-allgood-secondary text-white rounded -m-5 p-8 shadow-inner">
                        <div class="bg-white/20 p-6 rounded-full mb-6 backdrop-blur-sm">
                            <i data-lucide="shield-check" class="w-16 h-16 text-white"></i>
                        </div>
                        <h2 class="text-4xl font-heading font-bold mb-2 tracking-tight">PHASE III</h2>
                        <h3 class="text-xl font-body font-bold text-white/80 mb-4">Security Screening</h3>
                        <div class="w-16 h-1 bg-white/40 rounded mb-6"></div>
                        <p class="text-sm max-w-md leading-relaxed text-white/90">Divesting metal, removing laptops, and clearing the scanner.</p>
                    </div>
                </div>

                <!-- Page 17: Liquids Rule (ARTIFACT UPGRADE) -->
                <div class="page" id="page-17">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark mb-2">Hazard Control: Liquids</h2></section>
                    
                    <div class="flex justify-center mb-8">
                        <div class="relative">
                            <!-- The Bag (Acceptable items inside) -->
                            <div class="ziploc-bag w-48 h-48 flex flex-wrap content-end p-2 gap-2 justify-center">
                                <i data-lucide="milk" class="w-8 h-8 text-blue-600"></i>
                                <i data-lucide="droplets" class="w-8 h-8 text-blue-600"></i>
                                <i data-lucide="flask-conical" class="w-8 h-8 text-blue-600"></i>
                            </div>
                            <!-- The Rejected Item (Illustration of rejection) -->
                            <div class="absolute -right-12 top-1/2">
                                <i data-lucide="wine" class="w-12 h-12 text-red-400 opacity-50"></i>
                                <i data-lucide="x" class="w-10 h-10 text-red-600 absolute top-0 left-1 font-bold"></i>
                            </div>
                            <div class="absolute -bottom-8 w-full text-center text-xs font-bold text-blue-600">
                                1 Quart. Clear. Sealed.
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded border border-gray-200 shadow-sm">
                        <h3 class="font-bold text-allgood-dark mb-4">The <span class="term" tabindex="0">3-1-1 Rule<span class="term-def">3.4oz bottles, 1 Quart Bag, 1 Bag per person. The TSA standard for carry-on liquids.</span></span></h3>
                        <ul class="space-y-4">
                            <li class="flex items-center">
                                <div class="bg-gray-100 font-bold text-allgood-primary px-3 py-1 rounded mr-3">3</div>
                                <span class="text-sm text-gray-600">Max <strong>3.4 oz</strong> (100ml) per container.</span>
                            </li>
                            <li class="flex items-center">
                                <div class="bg-gray-100 font-bold text-allgood-primary px-3 py-1 rounded mr-3">1</div>
                                <span class="text-sm text-gray-600">All containers must fit in <strong>1</strong> quart bag.</span>
                            </li>
                            <li class="flex items-center">
                                <div class="bg-gray-100 font-bold text-allgood-primary px-3 py-1 rounded mr-3">1</div>
                                <span class="text-sm text-gray-600">Limit <strong>1</strong> bag per traveler.</span>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Page 18: Liquid Audit (Flip Cards) -->
                <div class="page" id="page-18">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark mb-2">Liquid Audit</h2></section>
                    <p class="text-sm text-gray-600 mb-6">Security will confiscate non-compliant liquids immediately. <strong>Tap the items below</strong> to audit them against the 3-1-1 rule and determine what stays and what gets tossed.</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                        <div class="flip-card" onclick="this.classList.toggle('flipped')">
                            <div class="flip-card-inner">
                                <div class="flip-card-front"><i data-lucide="milk" class="w-12 h-12 text-gray-400 mb-3"></i><h3 class="font-bold text-lg">5oz Lotion</h3><p class="text-xs text-gray-500 mt-2">Tap to Check</p></div>
                                <div class="flip-card-back"><h3 class="font-bold text-red-300 mb-2">PROHIBITED</h3><p class="text-xs">Over 3.4oz limit.</p></div>
                            </div>
                        </div>
                        <div class="flip-card" onclick="this.classList.toggle('flipped')">
                            <div class="flip-card-inner">
                                <div class="flip-card-front"><i data-lucide="droplets" class="w-12 h-12 text-gray-400 mb-3"></i><h3 class="font-bold text-lg">3oz Shampoo</h3><p class="text-xs text-gray-500 mt-2">Tap to Check</p></div>
                                <div class="flip-card-back bg-green-600"><h3 class="font-bold text-white mb-2">ALLOWED</h3><p class="text-xs">Under limit.</p></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Page 19: Tech Prep -->
                <div class="page" id="page-19">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark mb-2">Tech Extraction Protocol</h2></section>
                    <p class="text-gray-600 mb-4 leading-relaxed text-lg">Why is the agent yelling about laptops? Because on an X-Ray, a laptop looks like a solid lead brick.	</p>
                    <p class="text-gray-600 mb-6">It hides everything underneath it. That is a security risk. That's why it must be <strong>extracted</strong> and placed in its own <span class="term" tabindex="0">Bin<span class="term-def">The grey plastic tray used to hold your items on the security conveyor belt.</span></span>.</p>

                    <div class="bg-gray-100 p-4 rounded border border-gray-300">
                        <strong class="block text-allgood-dark mb-2">Rule of Thumb:</strong>
                        <p class="text-sm text-gray-600">If it's larger than a cell phone, pull it out.</p>
                    </div>
                </div>

                <!-- Page 20: Tech Toggle (Interaction) -->
                <div class="page" id="page-20">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark mb-2">Rapid Sort Protocol</h2></section>
                    <p class="text-sm text-gray-500 mb-4">Security efficiency relies on speed. <strong>Drag each item</strong> to the correct destination. Does it stay in your bag, or must it be removed for the X-ray?</p>
                    
                    <div class="flex justify-between items-stretch gap-4 h-64 mb-4 relative">
                        <!-- Left Zone: Bag -->
                        <div class="sort-zone flex-1 border-4 border-dashed border-gray-300 rounded-lg bg-gray-50 flex flex-col items-center justify-center transition-colors" data-zone="bag">
                            <i data-lucide="backpack" class="w-12 h-12 text-gray-400 mb-2 pointer-events-none"></i>
                            <span class="font-bold text-gray-500 uppercase text-xs pointer-events-none">Keep in Bag</span>
                        </div>

                        <!-- Center: Item Stream -->
                        <div class="flex-none w-40 flex items-center justify-center relative" id="sort-stream">
                            <!-- FIX: Removed draggable="true" to prevent conflict with custom JS drag logic -->
                            <div id="current-sort-item" class="cursor-grab active:cursor-grabbing bg-white border-2 border-allgood-secondary rounded-lg shadow-lg p-4 w-32 h-32 flex flex-col items-center justify-center text-center z-20 transition-transform hover:scale-105">
                                <i data-lucide="help-circle" class="w-10 h-10 text-allgood-secondary mb-2 pointer-events-none"></i>
                                <span class="font-bold text-sm text-allgood-dark pointer-events-none">Loading...</span>
                            </div>
                            <!-- Placeholder for empty stream -->
                            <div id="sort-complete-msg" class="hidden text-center">
                                <div class="text-4xl mb-2"></div>
                                <p class="font-bold text-allgood-primary text-sm">Sort Complete!</p>
                            </div>
                        </div>

                        <!-- Right Zone: Bin -->
                        <div class="sort-zone flex-1 border-4 border-dashed border-gray-300 rounded-lg bg-gray-50 flex flex-col items-center justify-center transition-colors" data-zone="bin">
                            <i data-lucide="inbox" class="w-12 h-12 text-gray-400 mb-2 pointer-events-none"></i>
                            <span class="font-bold text-gray-500 uppercase text-xs pointer-events-none">Bin (X-Ray)</span>
                        </div>
                    </div>

                    <!-- Feedback Bar -->
                    <div id="sort-feedback-bar" class="min-h-[60px] p-3 rounded border border-gray-200 bg-gray-100 text-center flex items-center justify-center transition-colors">
                        <p class="text-sm text-gray-500 italic">Waiting for item...</p>
                    </div>
                    
                    <div class="text-center mt-4">
                        <span class="text-xs font-bold text-gray-400 uppercase tracking-widest">Items Sorted: <span id="sort-counter">0</span>/7</span>
                    </div>
                </div>

                <!-- Page 21: Line Flow (ARTIFACT UPGRADE) -->
                <div class="page" id="page-21">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark mb-2">The Gauntlet: Master the Sequence</h2></section>
                    <p class="text-gray-600 mb-6 text-lg">Security is a rhythm. If you break the rhythm, you break the line. Review the sequence below to identify exactly where you need to be ready.</p>
                    
                    <div class="relative pl-4 py-4">
                        <!-- Vertical Connector -->
                        <div class="timeline-line"></div>

                        <div class="space-y-8 relative z-10">
                            <!-- Step 1 -->
                            <div class="flex items-start group cursor-pointer" onclick="this.classList.toggle('active')">
                                <div class="w-12 h-12 bg-allgood-primary text-white rounded-full flex items-center justify-center font-bold text-lg flex-shrink-0 mr-4 border-4 border-[#F7F7F7] transition-transform group-hover:scale-110">1</div>
                                <div class="pt-1 w-full">
                                    <p class="text-sm font-bold text-allgood-dark">ID Check: Hands Empty</p>
                                    <p class="text-xs text-gray-600 mt-1">Your hands should hold <strong>only</strong> your ID and Boarding Pass. Everything else goes in your bag.</p>
                                    <!-- Hidden Pro Tip -->
                                    <div class="hidden mt-2 p-2 bg-blue-50 border-l-4 border-blue-400 text-xs text-blue-800 rounded">
                                        <strong>Pro Tip:</strong> Do not be the person digging in their bag at the podium. Have your documents out 5 minutes before you reach the agent.
                                    </div>
                                </div>
                                <i data-lucide="chevron-down" class="w-4 h-4 text-gray-400 ml-2 transition-transform group-[.active]:rotate-180"></i>
                            </div>

                            <!-- Step 2 -->
                            <div class="flex items-start group cursor-pointer" onclick="this.classList.toggle('active')">
                                <div class="w-12 h-12 bg-white border-2 border-allgood-primary text-allgood-primary rounded-full flex items-center justify-center font-bold text-lg flex-shrink-0 mr-4 transition-transform group-hover:scale-110">2</div>
                                <div class="pt-1 w-full">
                                    <p class="text-sm font-bold text-allgood-dark">Divest (The Strip)</p>
                                    <p class="text-xs text-gray-600 mt-1">This is the choke point. Shoes off, jacket off, electronics out.</p>
                                    <div class="flex gap-2 mt-2">
                                        <div class="bg-gray-200 p-2 rounded"><i data-lucide="footprints" class="w-4 h-4 text-gray-600"></i></div>
                                        <div class="bg-gray-200 p-2 rounded"><i data-lucide="laptop" class="w-4 h-4 text-gray-600"></i></div>
                                        <div class="bg-gray-200 p-2 rounded"><i data-lucide="shirt" class="w-4 h-4 text-gray-600"></i></div>
                                    </div>
                                    <!-- Hidden Pro Tip -->
                                    <div class="hidden mt-2 p-2 bg-blue-50 border-l-4 border-blue-400 text-xs text-blue-800 rounded">
                                        <strong>Pro Tip:</strong> Start unbuckling your belt and untying shoes <em>while</em> you wait for a bin, not after you get one. Speed is key.
                                    </div>
                                </div>
                                <i data-lucide="chevron-down" class="w-4 h-4 text-gray-400 ml-2 transition-transform group-[.active]:rotate-180"></i>
                            </div>

                            <!-- Step 3 -->
                            <div class="flex items-start group cursor-pointer" onclick="this.classList.toggle('active')">
                                <div class="w-12 h-12 bg-white border-2 border-allgood-primary text-allgood-primary rounded-full flex items-center justify-center font-bold text-lg flex-shrink-0 mr-4 transition-transform group-hover:scale-110">3</div>
                                <div class="pt-1 w-full">
                                    <p class="text-sm font-bold text-allgood-dark">Scan & Hold</p>
                                    <p class="text-xs text-gray-600 mt-1">Do not cross the threshold until waved forward. Do not retrieve items until cleared.</p>
                                    <!-- Hidden Pro Tip -->
                                    <div class="hidden mt-2 p-2 bg-blue-50 border-l-4 border-blue-400 text-xs text-blue-800 rounded">
                                        <strong>Pro Tip:</strong> Crossing the line early triggers alarms and resets the machine, delaying everyone behind you. Patience saves time.
                                    </div>
                                </div>
                                <i data-lucide="chevron-down" class="w-4 h-4 text-gray-400 ml-2 transition-transform group-[.active]:rotate-180"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Toggle Script for this page only -->
                    <style>
                        .group.active .hidden { display: block; animation: fadeIn 0.3s ease; }
                        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
                    </style>
                </div>

                <!-- Page 22: Sequence Line (Interaction) -->
                <div class="page" id="page-22">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark mb-2">Sequence the Flow</h2></section>
                    <p class="text-sm text-gray-600 mb-4">The security line moves fast, and you don't want to be the bottleneck. <strong>Select the correct action</strong> for the highlighted step to build your efficiency flow.</p>
                    
                    <div class="flex gap-4">
                        <!-- Left Side: The Ladder -->
                        <div class="flex flex-col gap-2 w-1/3" id="sequence-ladder">
                            <div class="seq-step p-2 rounded border border-allgood-primary bg-orange-50 flex items-center justify-center h-12 transition-all shadow-md" data-index="1">
                                <span class="font-bold text-allgood-primary text-lg">1</span>
                            </div>
                            <div class="seq-step p-2 rounded border border-gray-200 bg-gray-50 flex items-center justify-center h-12 transition-all opacity-50" data-index="2">
                                <span class="font-bold text-gray-400 text-lg">2</span>
                            </div>
                            <div class="seq-step p-2 rounded border border-gray-200 bg-gray-50 flex items-center justify-center h-12 transition-all opacity-50" data-index="3">
                                <span class="font-bold text-gray-400 text-lg">3</span>
                            </div>
                            <div class="seq-step p-2 rounded border border-gray-200 bg-gray-50 flex items-center justify-center h-12 transition-all opacity-50" data-index="4">
                                <span class="font-bold text-gray-400 text-lg">4</span>
                            </div>
                            <div class="seq-step p-2 rounded border border-gray-200 bg-gray-50 flex items-center justify-center h-12 transition-all opacity-50" data-index="5">
                                <span class="font-bold text-gray-400 text-lg">5</span>
                            </div>
                        </div>

                        <!-- Right Side: The Options -->
                        <div class="flex flex-col gap-2 w-2/3" id="sequence-options">
                            <!-- Options will be shuffled on init -->
                            <button class="seq-opt w-full text-left p-3 bg-white border border-gray-300 rounded hover:bg-gray-50 shadow-sm text-sm font-body transition-all active:scale-95" onclick="checkSequenceStep(this)" data-step="2" data-feedback="Too early. You haven't even cleared the ID check yet.">Remove shoes / bulky items</button>
                            <button class="seq-opt w-full text-left p-3 bg-white border border-gray-300 rounded hover:bg-gray-50 shadow-sm text-sm font-body transition-all active:scale-95" onclick="checkSequenceStep(this)" data-step="5" data-feedback="You can't retrieve items before you've walked through the scanner.">Retrieve items</button>
                            <button class="seq-opt w-full text-left p-3 bg-white border border-gray-300 rounded hover:bg-gray-50 shadow-sm text-sm font-body transition-all active:scale-95" onclick="checkSequenceStep(this)" data-step="1" data-feedback="Correct. This is always the first barrier.">Present ID to Agent</button>
                            <button class="seq-opt w-full text-left p-3 bg-white border border-gray-300 rounded hover:bg-gray-50 shadow-sm text-sm font-body transition-all active:scale-95" onclick="checkSequenceStep(this)" data-step="4" data-feedback="Not yet. You must divest your items before you scan your body.">Walk through scanner</button>
                            <button class="seq-opt w-full text-left p-3 bg-white border border-gray-300 rounded hover:bg-gray-50 shadow-sm text-sm font-body transition-all active:scale-95" onclick="checkSequenceStep(this)" data-step="3" data-feedback="Wait. Large items/shoes come off first, then the trays follow.">Place electronics / liquids in trays</button>
                        </div>
                    </div>
                    
                    <!-- Feedback Bubble -->
                    <div id="seq-feedback-bubble" class="hidden mt-4 p-3 rounded bg-red-100 border border-red-300 text-red-800 text-sm font-bold text-center transition-opacity"></div>

                    <!-- Reset Button -->
                    <div class="flex justify-center mt-6">
                        <button id="reset-seq" class="flex items-center text-xs font-bold text-gray-400 hover:text-allgood-primary transition-colors" onclick="resetSequence()">
                            <i data-lucide="rotate-ccw" class="w-3 h-3 mr-1"></i> Reset Sequence
                        </button>
                    </div>
                </div>

                <!-- Page 23: Phase IV Header -->
                <div class="page" id="page-23">
                    <div class="flex flex-col items-center justify-center h-full text-center bg-allgood-secondary text-white rounded -m-5 p-8 shadow-inner">
                        <div class="bg-white/20 p-6 rounded-full mb-6 backdrop-blur-sm">
                            <i data-lucide="plane-takeoff" class="w-16 h-16 text-white"></i>
                        </div>
                        <h2 class="text-4xl font-heading font-bold mb-2 tracking-tight">PHASE IV</h2>
                        <h3 class="text-xl font-body font-bold text-white/80 mb-4">Gate & Boarding</h3>
                        <div class="w-16 h-1 bg-white/40 rounded mb-6"></div>
                        <p class="text-sm max-w-md leading-relaxed text-white/90">Locate your target, secure bin space, and execute extraction.</p>
                    </div>
                </div>

                <!-- Page 24: Finding Gate -->
                <div class="page" id="page-24">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark mb-2">Target Acquisition (Gate)</h2></section>
                    <p class="text-gray-600 mb-6 text-lg">You survived The Gauntlet. Now, locate your target. But be carefulintelligence changes rapidly.</p>
                    <p class="text-gray-600 mb-6 text-lg"><strong>Strategic Pause:</strong> Once you clear security, your immediate focus is identifying and walking to your gate. Once you are physically within 5 minutes of your target, you have earned the freedom to shop or eat. 
                    But remember your operational clock: <strong>do not miss your boarding group call.</strong></p>
                    
                    <div class="bg-white p-6 border border-gray-200 rounded shadow-sm">
                        <h3 class="font-bold text-allgood-primary text-lg mb-2">Paper Lies. Screens tell the Truth.</h3>
                        <p class="text-sm text-gray-600 leading-relaxed mb-4">The gate printed on your paper boarding pass is old intel. Gates change constantly due to air traffic control and ground operation variables.</p>
                        <p class="text-sm text-gray-600 leading-relaxed">Always confirm your target on the big TV screens (Flight Listings). <strong>That</strong> is your source of live truth. Cross-reference your ticket against the digital screen.</p>
                    </div>
                </div>

                <!-- Page 25: Source of Truth (ARTIFACT UPGRADE) -->
                <div class="page" id="page-25">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark mb-2">The Conflicting Intel</h2></section>
                    <div class="bg-white p-6 rounded border border-gray-200 shadow-sm">
                        <div class="flex items-center mb-4 border-b pb-3 border-gray-100">
                            <div class="w-12 h-12 rounded-full bg-yellow-100 flex items-center justify-center text-yellow-600 mr-3 text-xl"><i class="fas fa-exclamation-triangle"></i></div>
                            <div>
                                <h4 class="font-bold text-lg text-allgood-dark">Scenario: Crisis Moment</h4>
                                <p class="text-sm text-gray-500">You are buying a coffee. You hear a mumbled announcement. Your paper ticket says <strong>Gate A12</strong>. The TV monitor above you flashes <strong>Gate B40</strong>. Your flight leaves in 40 minutes.</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <!-- Paper Ticket (Static/Old Data) -->
                            <div class="paper-ticket p-4 text-center opacity-70 transform rotate-1">
                                <div class="text-xs font-bold mb-1 text-gray-400 uppercase tracking-widest">Boarding Pass</div>
                                <div class="text-2xl font-serif text-gray-800 mb-1">GATE A12</div>
                                <div class="text-[10px] text-gray-400">Printed: 06:00 AM</div>
                            </div>
                            <!-- Digital Screen (Live Data) -->
                            <div class="digital-screen p-4 text-center transform -rotate-1">
                                <div class="text-xs font-bold mb-1 text-green-600 uppercase tracking-widest animate-pulse"> LIVE FEED</div>
                                <div class="text-2xl font-mono text-green-400 mb-1">GATE B40</div>
                                <div class="text-[10px] text-green-800">Updated: NOW</div>
                            </div>
                        </div>
                        <div class="quiz-container">
                            <p class="font-bold text-sm mb-2">Which intel do you trust?</p>
                            <button class="quiz-btn w-full text-left p-3 bg-gray-50 border border-gray-200 rounded mb-2" onclick="checkAnswer(this)" data-correct="false" data-feedback="CRITICAL ERROR. Paper is static. You walk to Terminal A, find an empty gate, and miss your flight.">Trust the Ticket (A12).</button>
                            <button class="quiz-btn w-full text-left p-3 bg-gray-50 border border-gray-200 rounded" onclick="checkAnswer(this)" data-correct="true" data-feedback="CORRECT. Operations change by the minute. The screen is the live feed. You make it with time to spare.">Trust the Monitor (B40).</button>
                        </div>
                        <div class="feedback mt-3 text-sm hidden font-bold font-body"></div>
                    </div>
                </div>

                <!-- Page 26: Boarding Strategy -->
                <div class="page" id="page-26">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark mb-2">Infiltration Strategy</h2></section>
                    <p class="text-gray-600 mb-4 text-lg">Boarding isn't about finding a seatyou already have an assigned seat. <strong>Boarding is a tactical fight for bin space.</strong></p>
                    
                    <p class="text-gray-600 text-sm mb-6">If you board last, the overhead bins will be full. You will be forced to "Gate Check" your carry-on (surrendering it to the cargo hold). If you want your gear with you, get in line the second your <span class="term" tabindex="0">Group Number
                    <!-- FIX: Removed centering transform and anchored left: -10px. This pushes the box right, into the screen center, preventing left-edge cutoff. -->
                    <span class="term-def" style="left: -10px; right: auto; transform: none;">The zone listed on your ticket (e.g., Group 3) that tells you when you are allowed to board.</span>
                    </span> is called.</p>

                    <div class="bg-gray-100 p-4 border-l-4 border-allgood-dark text-sm text-gray-700 italic">
                        "Gate checking isn't the end of the world, but it adds 20 minutes to your extraction time when you land."
                    </div>
                </div>

                <!-- Page 27: Boarding Quiz -->
                <div class="page" id="page-27">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark mb-2">The Overhead War</h2></section>
                    <div class="bg-white p-6 rounded border border-gray-200 shadow-sm">
                        <div class="flex items-center mb-4 border-b pb-3 border-gray-100">
                            <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 mr-3 text-xl"><i class="fas fa-suitcase"></i></div>
                            <div>
                                <h4 class="font-bold text-lg text-allgood-dark">Scenario: Tactical Decision</h4>
                                <p class="text-sm text-gray-500">Your Group Number is called. You are comfortable in your seat at the gate charging your phone. Do you get up now, or wait for the line to die down?</p>
                            </div>
                        </div>
                        <div class="quiz-container">
                            <p class="font-bold text-sm mb-2">What is your move?</p>
                            <button class="quiz-btn w-full text-left p-3 bg-gray-50 border border-gray-200 rounded mb-2" onclick="checkAnswer(this)" data-correct="true" data-feedback="TACTICAL WIN. You secure bin space directly above your seat. You have access to your gear and can exit quickly.">Get in line immediately.</button>
                            <button class="quiz-btn w-full text-left p-3 bg-gray-50 border border-gray-200 rounded" onclick="checkAnswer(this)" data-correct="false" data-feedback="MISTAKE. Your seat is saved, but the bin space is gone. You are forced to gate-check your bag and wait 30 mins at baggage claim upon arrival.">Wait. I have an assigned seat. I'll board last.</button>
                        </div>
                        <div class="feedback mt-3 text-sm hidden font-bold font-body"></div>
                    </div>
                </div>

                <!-- Page 28: Arrival Flow (Flowchart Interaction) -->
                <div class="page" id="page-28">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark mb-2">Arrival Sequence</h2></section>
                    <p class="text-sm text-gray-600 mb-6 text-center">The mission isn't over until you have your bags. <strong>Follow the extraction flow below</strong> to navigate from your seat to the curb efficiently.</p>
                    <div class="flex flex-col gap-2 items-center">
                        <div class="flow-node w-full p-3 bg-gray-100 border border-gray-300 rounded text-center text-sm font-bold cursor-pointer" onclick="this.classList.add('active'); sfx.nav()">1. Deplane</div>
                        <i data-lucide="arrow-down" class="w-4 h-4 text-gray-400"></i>
                        <div class="flow-node w-full p-3 bg-gray-100 border border-gray-300 rounded text-center text-sm font-bold cursor-pointer" onclick="this.classList.add('active'); sfx.nav()">2. Follow 'Baggage Claim' Signs</div>
                        <i data-lucide="arrow-down" class="w-4 h-4 text-gray-400"></i>
                        <div class="flow-node w-full p-3 bg-gray-100 border border-gray-300 rounded text-center text-sm font-bold cursor-pointer" onclick="this.classList.add('active'); sfx.nav()">3. Check Board for Carousel #</div>
                        <i data-lucide="arrow-down" class="w-4 h-4 text-gray-400"></i>
                        <div class="flow-node w-full p-3 bg-gray-100 border border-gray-300 rounded text-center text-sm font-bold cursor-pointer" onclick="this.classList.add('active'); sfx.nav()">4. Grab Bag & Exit</div>
                    </div>
                </div>

                <!-- Page 29: Flight Readiness Check (NEW) -->
                <div class="page" id="page-29">
                    <section class="mb-6 border-b border-gray-200 pb-4">
                        <h2 class="text-2xl font-heading font-bold text-allgood-dark mb-2">Flight Readiness Check</h2>
                        <p class="text-xs font-bold text-allgood-primary uppercase tracking-widest">Final Go/No-Go Assessment</p>
                    </section>
                    
                    <div class="space-y-6">
                        <!-- Q1: Timing -->
                        <div class="bg-white p-4 rounded border border-gray-200 shadow-sm quiz-container">
                            <div class="flex items-center mb-3">
                                <i data-lucide="clock" class="w-5 h-5 text-allgood-primary mr-2"></i>
                                <strong class="text-sm text-allgood-dark">Q1: International Flight departs at 5:00 PM. When do you walk in the door?</strong>
                            </div>
                            <div class="grid grid-cols-1 gap-2">
                                <button class="quiz-btn w-full text-left p-3 bg-gray-50 border border-gray-200 rounded text-sm" onclick="checkAnswer(this)" data-correct="false" data-feedback="TOO LATE. 3:00 PM is a 2-hour buffer. That's for domestic. You risk missing the bag drop cutoff.">3:00 PM</button>
                                <button class="quiz-btn w-full text-left p-3 bg-gray-50 border border-gray-200 rounded text-sm" onclick="checkAnswer(this)" data-correct="true" data-feedback="CORRECT. 2:00 PM gives you the 3-hour International buffer. You handle customs and security with zero stress.">2:00 PM</button>
                                <button class="quiz-btn w-full text-left p-3 bg-gray-50 border border-gray-200 rounded text-sm" onclick="checkAnswer(this)" data-correct="false" data-feedback="DISASTER. 4:00 PM means you likely miss the flight entirely. Operations close 45-60 mins before departure.">4:00 PM</button>
                            </div>
                            <div class="feedback mt-2 text-xs font-bold hidden"></div>
                        </div>

                        <!-- Q2: Security -->
                        <div class="bg-white p-4 rounded border border-gray-200 shadow-sm quiz-container">
                            <div class="flex items-center mb-3">
                                <i data-lucide="shield-alert" class="w-5 h-5 text-red-500 mr-2"></i>
                                <strong class="text-sm text-allgood-dark">Q2: You have a full water bottle at the checkpoint. Action?</strong>
                            </div>
                            <div class="grid grid-cols-1 gap-2">
                                <button class="quiz-btn w-full text-left p-3 bg-gray-50 border border-gray-200 rounded text-sm" onclick="checkAnswer(this)" data-correct="true" data-feedback="CORRECT. Drink it or dump it. An empty bottle is allowed. A full one is trash.">Drink it or Dump it.</button>
                                <button class="quiz-btn w-full text-left p-3 bg-gray-50 border border-gray-200 rounded text-sm" onclick="checkAnswer(this)" data-correct="false" data-feedback="FAIL. Liquids over 3.4oz are prohibited. The agent will confiscate it and you delay the line.">Put it in the bin.</button>
                            </div>
                            <div class="feedback mt-2 text-xs font-bold hidden"></div>
                        </div>

                        <!-- Q3: Boarding -->
                        <div class="bg-white p-4 rounded border border-gray-200 shadow-sm quiz-container">
                            <div class="flex items-center mb-3">
                                <i data-lucide="plane-takeoff" class="w-5 h-5 text-green-600 mr-2"></i>
                                <strong class="text-sm text-allgood-dark">Q3: They call Group 4. You are Group 3. Action?</strong>
                            </div>
                            <div class="grid grid-cols-1 gap-2">
                                <button class="quiz-btn w-full text-left p-3 bg-gray-50 border border-gray-200 rounded text-sm" onclick="checkAnswer(this)" data-correct="true" data-feedback="CORRECT. You missed your specific call, but you can board ANY time after your group is called. Go now to save bin space.">Board immediately.</button>
                                <button class="quiz-btn w-full text-left p-3 bg-gray-50 border border-gray-200 rounded text-sm" onclick="checkAnswer(this)" data-correct="false" data-feedback="MISTAKE. Waiting longer just means less overhead space. Since your group (3) already passed, you have the right to board now.">Wait for the line to clear.</button>
                            </div>
                            <div class="feedback mt-2 text-xs font-bold hidden"></div>
                        </div>
                    </div>
                </div>

                <!-- Page 30: The Principled Traveler (NEW) -->
                <div class="page" id="page-30">
                    <section class="mb-6 border-b border-gray-200 pb-4">
                        <h2 class="text-2xl font-heading font-bold text-allgood-dark mb-2">The Principled Traveler</h2>
                        <!-- FIX: Replaced IB reference with Allgood Academy specific framing -->
                        <p class="text-xs font-bold text-allgood-secondary uppercase tracking-widest">Allgood Academy Tips for Low-Stress Travel</p>
                    </section>
                    <!-- FIX: Updated intro text to frame mindfulness as a stress-reduction strategy -->
                    <p class="text-gray-600 mb-8 text-sm">An airport is a shared ecosystem. Reducing friction for others actually reduces stress for you. <strong>Tap each card</strong> to learn how a little mindfulness keeps the entire operation running smoothly.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Card 1: Spatial Awareness -->
                        <div class="commitment-card" onclick="this.classList.toggle('flipped'); sfx.tick()">
                            <div class="commitment-card-inner">
                                <div class="commitment-card-front">
                                    <i data-lucide="footprints" class="w-16 h-16 mb-4"></i>
                                    <h3 class="font-heading font-bold text-xl">Spatial Awareness</h3>
                                    <p class="text-xs uppercase tracking-widest mt-4 opacity-60">Tap to Reflect</p>
                                </div>
                                <div class="commitment-card-back">
                                    <i data-lucide="check-circle" class="w-8 h-8 mb-3 text-white/90"></i>
                                    <!-- FIX: Updated text to include the specific "stand to the right" rule -->
                                    <p class="text-sm leading-relaxed font-body">Airports are high-speed zones. Don't stop suddenly in pathways. <strong>Stand to the right</strong> on escalators and moving walkways so others can pass on the left. A little awareness keeps the flow smooth.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Card 2: Share the Seating -->
                        <div class="commitment-card" onclick="this.classList.toggle('flipped'); sfx.tick()">
                            <div class="commitment-card-inner">
                                <div class="commitment-card-front">
                                    <i data-lucide="armchair" class="w-16 h-16 mb-4"></i>
                                    <h3 class="font-heading font-bold text-xl">Share the Seating</h3>
                                    <p class="text-xs uppercase tracking-widest mt-4 opacity-60">Tap to Reflect</p>
                                </div>
                                <div class="commitment-card-back">
                                    <i data-lucide="check-circle" class="w-8 h-8 mb-3 text-white/90"></i>
                                    <p class="text-sm leading-relaxed font-body">Seats are precious resources. Do not use them for luggage. Keep bags close to your body so a fellow traveler can rest.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Card 3: Baggage Claim -->
                        <div class="commitment-card" onclick="this.classList.toggle('flipped'); sfx.tick()">
                            <div class="commitment-card-inner">
                                <div class="commitment-card-front">
                                    <i data-lucide="tag" class="w-16 h-16 mb-4"></i>
                                    <h3 class="font-heading font-bold text-xl">Baggage Claim</h3>
                                    <p class="text-xs uppercase tracking-widest mt-4 opacity-60">Tap to Reflect</p>
                                </div>
                                <div class="commitment-card-back">
                                    <i data-lucide="check-circle" class="w-8 h-8 mb-3 text-white/90"></i>
                                    <p class="text-sm leading-relaxed font-body">Stand 3-5 feet back from the carousel. Only step forward when you clearly see your bag. Give everyone a clean sightline.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Page 31: Credits (Shifted) -->
                <div class="page" id="page-31">
                    <div class="flex flex-col items-center justify-start h-full text-center px-2 pt-8">
                        <div class="mb-8"><h2 class="text-2xl font-heading font-bold text-allgood-dark">Allgood<span class="text-allgood-primary">Academy</span></h2><p class="text-xs text-gray-400 font-bold tracking-widest uppercase mt-2">Pragmatic Action</p></div>
                        
                        <!-- FIX: Added Feedback Card before About Us -->
                        <div id="feedback-container" class="w-full max-w-md bg-white p-6 rounded-lg shadow-md border border-gray-200 mb-8 text-left relative">
                            <h3 class="font-bold text-allgood-dark text-sm uppercase tracking-wide mb-4 text-center">Rate this GoodBlock</h3>
                            
                            <!-- Star Rating -->
                            <div class="flex justify-center space-x-2 mb-4" id="star-wrapper">
                                <button onclick="setRating(1)" class="star-btn focus:outline-none transition-transform hover:scale-110" data-val="1"><i id="star-1" class="fas fa-star text-2xl text-gray-300"></i></button>
                                <button onclick="setRating(2)" class="star-btn focus:outline-none transition-transform hover:scale-110" data-val="2"><i id="star-2" class="fas fa-star text-2xl text-gray-300"></i></button>
                                <button onclick="setRating(3)" class="star-btn focus:outline-none transition-transform hover:scale-110" data-val="3"><i id="star-3" class="fas fa-star text-2xl text-gray-300"></i></button>
                                <button onclick="setRating(4)" class="star-btn focus:outline-none transition-transform hover:scale-110" data-val="4"><i id="star-4" class="fas fa-star text-2xl text-gray-300"></i></button>
                                <button onclick="setRating(5)" class="star-btn focus:outline-none transition-transform hover:scale-110" data-val="5"><i id="star-5" class="fas fa-star text-2xl text-gray-300"></i></button>
                            </div>

                            <!-- Feedback Text -->
                            <label class="block text-xs font-bold text-gray-500 mb-2">Your feedback sharpens our tools. What worked? What didn't?</label>
                            <textarea id="feedback-text" rows="3" class="w-full border border-gray-300 rounded p-3 text-sm focus:ring-1 focus:ring-allgood-primary focus:border-allgood-primary outline-none resize-none bg-gray-50" placeholder="Optional: Share your thoughts..."></textarea>
                            
                            <button onclick="submitFeedback()" class="w-full mt-4 bg-allgood-dark hover:bg-allgood-primary text-white font-bold py-2 rounded transition-colors text-sm">Send Feedback</button>
                        </div>

                        <!-- Success State (Hidden by default) -->
                        <div id="feedback-success" class="hidden w-full max-w-md bg-green-50 p-6 rounded-lg shadow-inner border border-green-200 mb-8 text-center">
                            <i data-lucide="check-circle" class="w-12 h-12 text-green-600 mx-auto mb-2"></i>
                            <h3 class="font-bold text-green-800">Feedback Received.</h3>
                            <p class="text-xs text-green-700 mt-1">Thank you for helping us improve.</p>
                        </div>

                        <!-- FIX: Added Certification Badge Section -->
                        <div id="certification-section" class="w-full max-w-md bg-gradient-to-br from-allgood-secondary to-allgood-accent p-1 rounded-lg shadow-xl mb-8 transform transition-all duration-700 scale-95 opacity-0">
                            <div class="bg-white p-6 rounded-md text-center">
                                <div class="mb-4 relative inline-block">
                                    <div class="absolute inset-0 bg-yellow-100 rounded-full blur-xl opacity-50 animate-pulse"></div>
                                    <i data-lucide="award" class="relative w-16 h-16 text-allgood-primary mx-auto"></i>
                                </div>
                                <h3 class="font-heading font-bold text-2xl text-allgood-dark mb-2">Mission Complete</h3>
                                <p class="text-sm text-gray-600 mb-6">You have navigated the gauntlet. Verify your readiness to deploy.</p>
                                
                                <!-- NEW: Mission Checklist -->
                                <div class="text-left bg-gray-50 p-4 rounded border border-gray-200 mb-6 text-sm">
                                    <h4 class="font-bold text-allgood-dark mb-3 uppercase text-[10px] tracking-widest border-b border-gray-200 pb-2">Certification Requirements</h4>
                                    <ul class="space-y-3">
                                        <li id="req-bag" class="flex items-center text-gray-400 transition-colors">
                                            <i data-lucide="circle" class="w-4 h-4 mr-2"></i> <span>Baggage Sort Protocol (Page 8)</span>
                                        </li>
                                        <li id="req-rapid" class="flex items-center text-gray-400 transition-colors">
                                            <i data-lucide="circle" class="w-4 h-4 mr-2"></i> <span>Rapid Sort Security (Page 20)</span>
                                        </li>
                                        <li id="req-quiz" class="flex items-center text-gray-400 transition-colors">
                                            <i data-lucide="circle" class="w-4 h-4 mr-2"></i> <span>Flight Readiness Check (Page 29)</span>
                                        </li>
                                    </ul>
                                </div>

                                <!-- UPDATED: Locked Button -->
                                <button id="download-badge-btn" onclick="downloadBadge()" disabled class="w-full bg-gray-300 text-white font-bold py-3 rounded shadow-none cursor-not-allowed flex items-center justify-center transition-all duration-300">
                                    <i id="btn-icon" data-lucide="lock" class="w-4 h-4 mr-2"></i>
                                    <span id="btn-text">Certification Locked</span>
                                </button>
                                
                                <!-- REMOVED: Email Dispatch Button -->
                            </div>
                        </div>

                        <div class="w-full max-w-md text-left mx-auto mb-4">
                            <button class="accordion-toggle w-full bg-white border border-gray-200 p-4 rounded-lg shadow-sm flex justify-between items-center hover:bg-gray-50 hover:border-allgood-primary transition-all group">
                                <span class="font-heading font-bold text-allgood-dark text-base group-hover:text-allgood-primary transition-colors">About Us</span>
                                <svg class="accordion-icon h-5 w-5 text-gray-400 transform transition-transform duration-300 group-hover:text-allgood-primary" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            </button>
                            <div class="accordion-content hidden bg-white border-x border-b border-gray-200 rounded-b-lg p-6 text-gray-600 space-y-3 shadow-inner text-sm font-body leading-relaxed">
                                <!-- FIX: Updated Mission Statement to focus on Pragmatic Action -->
                                <p>The Allgood Academy is a learning lab focused on Pragmatic Action. We apply the advanced instructional design used by top tech companies to guarantee one result: a mindset shift that converts passive learning into tangible, real-world execution.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 6. Footer with Nav Buttons -->
                <footer class="footer-content flex items-center justify-between px-6">
                    <div id="flex-progress-bar"><div id="flex-progress-fill"></div></div>
                    <button id="back-button" class="text-allgood-primary hover:text-allgood-dark font-bold text-sm flex items-center transition-colors disabled:opacity-30 disabled:cursor-not-allowed font-body">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>Back
                    </button>
                    <p class="text-gray-400 text-[10px] hidden sm:block font-body">&copy; <a href="https://www.allgoodacademy.com" target="_blank" class="hover:text-allgood-primary transition-colors font-bold">Allgood Academy</a> <span id="current-year"></span></p>
                    <button id="next-button" class="bg-allgood-primary hover:bg-allgood-hover text-white px-6 py-2 rounded-full text-sm font-bold shadow-md transition-transform transform hover:scale-105 flex items-center disabled:opacity-50 disabled:cursor-not-allowed font-body"><span>Next</span><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button>
                </footer>

            </div>
        </div>
    </main>

    <!-- Main Application Logic (JavaScript) -->
    <script>
        // --- GLOBAL VARIABLES ---
        let currentUserName = "Anonymous";
        let currentUserEmail = "";
        let currentPageIndex = 0; 
        
        // --- SESSION MANAGER (REFACTORED FOR FIRESTORE) ---
        // This is the core logic that connects the GoodBlock to the Database
        const SessionManager = {
            // Logs events directly to Firestore via the global window.logToFirestore function
            log: function(action, detail, payload = {}) {
                if (window.logToFirestore) {
                    window.logToFirestore(action, detail, payload);
                } else {
                    console.warn("Firestore Logger not ready:", action);
                }
            },

            // Starts the session (called on Login)
            start: function(name, email) {
                this.log("System", "Session Started", { startTime: new Date().toISOString() });
            },

            // Helper to track local state (optional, but good for debugging)
            track: function(key, value) {
                console.log(`Local Track [${key}]:`, value);
            }
        };
        
        // FIX: Explicitly expose SessionManager to window to prevent startup crash
        window.SessionManager = SessionManager;

        // --- COMPLETION FLAGS ---
        // Tracks engagement for badge eligibility
        const completionFlags = {
            bagSort: false,
            rapidSort: false,
            readinessQuiz: false
        };

        // --- MAP LOGIC (Page 3) ---
        function toggleMapTooltip(phaseId) {
            // Hide all others
            document.querySelectorAll('.map-tooltip').forEach(el => {
                if(el.id !== `tooltip-${phaseId}`) el.classList.add('hidden');
            });
            // Toggle current
            const tooltip = document.getElementById(`tooltip-${phaseId}`);
            if (tooltip) {
                tooltip.classList.toggle('hidden');
                sfx.tick();
            }
        }

        // --- MISSION BRIEFING LOGIC (Page 2) ---
        function toggleMissionTooltip(id) {
            // Hide all others in this group
            document.querySelectorAll('.mission-tooltip').forEach(el => {
                if(el.id !== `tooltip-mission-${id}`) el.classList.add('hidden');
            });
            // Toggle selected
            const tooltip = document.getElementById(`tooltip-mission-${id}`);
            if (tooltip) {
                tooltip.classList.toggle('hidden');
                sfx.tick();
            }
        }

        // --- QUIZ LOGIC (General reusable function for quizzes) ---
        function checkAnswer(btn) {
            const container = btn.closest('.quiz-container');
            const isNeutral = container.getAttribute('data-neutral') === 'true';
            
            if (!isNeutral && container.hasAttribute('data-answered')) return;
            
            const isCorrect = btn.getAttribute('data-correct') === 'true';
            // FIX: Moved feedbackText declaration UP so it can be used in tracking logic if needed
            const feedbackText = btn.getAttribute('data-feedback');
            
            if (!isNeutral) {
                // FIX: Improved Quiz Title Logic for readable data logs
                let quizTitle = "Unknown Quiz";
                const strongTag = container.querySelector('strong');
                
                if (strongTag) {
                    quizTitle = strongTag.textContent;
                } else {
                    // Fallback: Identify quiz by page context if no strong tag found
                    if (container.closest('#page-15')) quizTitle = "Tag Audit Check";
                    else if (container.closest('#page-25')) quizTitle = "Source of Truth Check";
                    else if (container.closest('#page-27')) quizTitle = "Boarding Strategy Check";
                    else if (container.closest('#page-29')) {
                        // For the Final Readiness Check, use Q number
                        const quizContainers = Array.from(document.querySelectorAll('#page-29 .quiz-container'));
                        const quizIndex = quizContainers.indexOf(container);
                        quizTitle = `Readiness Check Q${quizIndex + 1}`;
                    }
                }

                const result = isCorrect ? "PASS" : "FAIL";
                // Log with clear Action Name
                SessionManager.log("Quiz Attempt", quizTitle, { result: result, selectedAnswer: btn.innerText });
                
                // Check for Readiness Quiz Completion (Page 29)
                if (currentPageIndex === 28) { // Page 29 is index 28
                    container.setAttribute('data-answered', 'true');
                    setTimeout(() => {
                        const allAnswered = Array.from(document.querySelectorAll('#page-29 .quiz-container')).every(el => el.hasAttribute('data-answered'));
                        if (allAnswered) completionFlags.readinessQuiz = true;
                    }, 500);
                }
            }

            let feedbackDisplay = container.querySelector('.feedback') || container.nextElementSibling;	
            if (!feedbackDisplay || !feedbackDisplay.classList.contains('feedback')) {
                // Fallback search in parent
                 feedbackDisplay = container.parentElement.querySelector('.feedback');
            }

            const allBtns = container.querySelectorAll('.quiz-btn');

            // Reset buttons styles
            allBtns.forEach(b => {
                b.classList.remove('bg-blue-50', 'border-allgood-secondary', 'text-allgood-secondary', 'ring-1', 'ring-allgood-secondary', 'bg-green-100', 'border-green-500', 'text-green-900', 'bg-red-100', 'border-red-500', 'text-red-900', 'cursor-not-allowed', 'opacity-50', 'rounded-b-none', 'mb-0');
                b.classList.add('bg-gray-50', 'border-gray-200', 'mb-2'); 
                if (!isNeutral) {
                    b.disabled = true; 
                    b.classList.add('cursor-not-allowed');
                    if (b !== btn) b.classList.add('opacity-50');
                }
            });

            if(feedbackDisplay) {
                // Re-insert feedback after the clicked button (or just make it visible)
                if (isNeutral) {
                    btn.insertAdjacentElement('afterend', feedbackDisplay);
                }
                feedbackDisplay.textContent = feedbackText;
                feedbackDisplay.classList.remove('hidden');
                feedbackDisplay.classList.add('mb-4', 'mt-2');	
                
                if (isNeutral) {
                    // Neutral feedback (used for advice/scenario pages)
                    feedbackDisplay.classList.remove('text-red-600', 'text-green-700', 'bg-red-50', 'bg-green-50', 'border-red-200', 'border-green-200');
                    feedbackDisplay.classList.add('text-allgood-secondary', 'bg-blue-50', 'border-blue-200');

                    btn.classList.remove('bg-gray-50', 'border-gray-200', 'mb-2');
                    btn.classList.add('bg-blue-50', 'border-allgood-secondary', 'text-allgood-secondary', 'ring-1', 'ring-allgood-secondary');
                    sfx.nav();	
                } else {
                    // Pass/Fail feedback (used for correct/incorrect answers)
                    if (isCorrect) {
                        btn.classList.remove('bg-gray-50', 'border-gray-200', 'mb-2');
                        btn.classList.add('bg-green-100', 'border-green-500', 'ring-1', 'ring-green-500', 'text-green-900');
                        feedbackDisplay.classList.remove('text-red-600', 'bg-red-50', 'border-red-200');
                        feedbackDisplay.classList.add('text-green-700', 'bg-green-50', 'border-green-200');	
                        sfx.nav();	
                    } else {
                        btn.classList.remove('bg-gray-50', 'border-gray-200', 'mb-2');
                        btn.classList.add('bg-red-100', 'border-red-500', 'text-red-900');
                        feedbackDisplay.classList.remove('text-green-700', 'bg-green-50', 'border-green-200');
                        feedbackDisplay.classList.add('text-red-600', 'bg-red-50', 'border-red-200');
                        sfx.powerOff();	
                    }
                    // Only set data-answered for permanent quizzes (not scenarios like page 10/13)
                    if (currentPageIndex !== 9 && currentPageIndex !== 12) {
                        container.setAttribute('data-answered', 'true');
                    }
                }
            }
        }

        // --- IMAGE EXPANSION (Modal is ready but unused in this version) ---
        function openImageModal(element) {
            const src = element.querySelector('img').src;
            const modal = document.getElementById('image-modal');
            const expandedImg = document.getElementById('expanded-image');
            expandedImg.src = src;
            modal.classList.remove('hidden-modal');
            modal.classList.add('visible-modal');
        }

        function closeImageModal() {
            const modal = document.getElementById('image-modal');
            modal.classList.remove('visible-modal');
            modal.classList.add('hidden-modal');
        }

        // --- SCENARIO MODAL LOGIC (Page 10 & 13) ---
        const scenarioData = {
            // Page 10: Overweight Bag
            'A': {
                title: "Expensive Efficiency",
                text: "FAST BUT EXPENSIVE. You save time and effort, but you just spent your vacation money on 5 lbs of laundry. Valid if you're in a rush, but costly.",
                iconClass: "bg-yellow-100 text-yellow-600",
                iconInner: '<i data-lucide="dollar-sign" class="w-8 h-8"></i>'
            },
            'B': {
                title: "The 'Joey Tribbiani'",
                text: "HIGH DISCOMFORT. You put on 3 coats and a sweater. It works, but you'll be sweating through security. Zero cost, maximum sweat.",
                iconClass: "bg-blue-100 text-blue-600",
                iconInner: '<i data-lucide="shirt" class="w-8 h-8"></i>'
            },
            'C': {
                title: "Strategic Win",
                text: "SMART MOVE. You move dense items (shoes, books) to your roller board. Carry-ons rarely have weight limits. You save the money and the sweat.",
                iconClass: "bg-green-100 text-green-600",
                iconInner: '<i data-lucide="check-circle" class="w-8 h-8"></i>'
            },
            'D': {
                title: "Critical Failure",
                text: "The agent has zero discretion on weight. You hold up the line, annoy the staff, and still have to pay or repack. Never argue with physics.",
                iconClass: "bg-red-100 text-red-600",
                iconInner: '<i data-lucide="x-circle" class="w-8 h-8"></i>'
            },
            
            // Page 13: Line Check
            'Kiosk_Try': {
                title: "Calculated Risk",
                text: "SMART GAMBLE. The kiosk might reject your visa, but since the line was empty, the 'cost' of trying was low. If it fails, you pivot to the agent line having lost only 2 minutes.",
                iconClass: "bg-green-100 text-green-600",
                iconInner: '<i data-lucide="monitor-check" class="w-8 h-8"></i>'
            },
            'Agent_Wait': {
                title: "Safe but Slow",
                text: "GUARANTEED SUCCESS. You accept a 45-minute wait for peace of mind. Best choice if you have zero margin for error, but inefficient if you have time to spare.",
                iconClass: "bg-blue-100 text-blue-600",
                iconInner: '<i data-lucide="clock" class="w-8 h-8"></i>'
            },
            'Bag_Drop': {
                title: "High Risk Failure",
                text: "'Bag Drop' agents often only handle pre-tagged bags. Without a kiosk tag, they will likely send you to the back of the main line. You risk losing 15 minutes.",
                iconClass: "bg-red-100 text-red-600",
                iconInner: '<i data-lucide="alert-triangle" class="w-8 h-8"></i>'
            },
            'Curbside': {
                title: "Costly & Limited",
                text: "Curbside can take domestic bags, but often cannot verify complex international visas. You pay a tip/fee and might still be sent inside to the main counter.",
                iconClass: "bg-yellow-100 text-yellow-600",
                iconInner: '<i data-lucide="wallet" class="w-8 h-8"></i>'
            }
        };

        function showScenarioOutcome(option) {
            const data = scenarioData[option];
            const modal = document.getElementById('scenario-modal');
            const iconContainer = document.getElementById('scenario-icon');
            
            // FIX: Real-time logging for Scenario Choice
            SessionManager.log("Scenario Decision", `${data.title} (${option})`);

            document.getElementById('scenario-title').textContent = data.title;
            document.getElementById('scenario-feedback').textContent = data.text;
            
            // Reset classes
            iconContainer.className = `mx-auto w-16 h-16 rounded-full flex items-center justify-center mb-4 text-3xl ${data.iconClass}`;
            iconContainer.innerHTML = data.iconInner;
            
            modal.classList.remove('hidden-modal');
            modal.classList.add('visible-modal');
            sfx.nav();
            lucide.createIcons();
        }

        function closeScenarioModal() {
            const modal = document.getElementById('scenario-modal');
            modal.classList.remove('visible-modal');
            modal.classList.add('hidden-modal');
        }

        // --- RAPID SORT LOGIC (Page 20) ---
        const sortItems = [
            { id: 'laptop', name: 'Laptop (15")', type: 'bin', icon: 'laptop', reason: "Laptops block X-rays. They must be removed." },
            { id: 'phone', name: 'iPhone', type: 'bag', icon: 'smartphone', reason: "Small electronics stay in. Don't clutter the trays." },
            { id: 'kindle', name: 'Large iPad', type: 'bin', icon: 'tablet', reason: "Larger than a phone? It blocks the scan. Bin it." },
            // UPDATE: Clarified state to (Wearing) to force Bin decision
            { id: 'belt', name: 'Belt (Wearing)', type: 'bin', icon: 'circle-dashed', reason: "Metal buckles trigger the body scanner. It must come off." },
            { id: 'water', name: 'Empty Bottle', type: 'bag', icon: 'flask-conical', reason: "It's empty, so it's safe. Keep it inside." },
            // UPDATE: Clarified state to (Wearing) to force Bin decision
            { id: 'jacket', name: 'Jacket (Wearing)', type: 'bin', icon: 'shirt', reason: "Outerwear hides items from the body scanner. Remove it." },
            // UPDATE: Swapped vague food for a hard rule item (Console)
            { id: 'console', name: 'Game Console', type: 'bin', icon: 'gamepad-2', reason: "Large electronics (bigger than a phone) must be screened separately." }
        ];
        
        // --- FEEDBACK FORM LOGIC ---
        let currentRating = 0;
        
        function setRating(n) {
            currentRating = n;
            for (let i = 1; i <= 5; i++) {
                const star = document.getElementById(`star-${i}`);
                if (i <= n) {
                    star.classList.remove('text-gray-300');
                    star.classList.add('text-yellow-400');
                } else {
                    star.classList.add('text-gray-300');
                    star.classList.remove('text-yellow-400');
                }
            }
            sfx.tick();
        }

        function submitFeedback() {
            const feedbackText = document.getElementById('feedback-text').value;
            
            // FIX: Log Session Completion to Firestore
            const ratingDetail = currentRating > 0 ? `${currentRating}/5 Stars` : "No Rating";
            SessionManager.log("Session Completed", ratingDetail, { feedbackComment: feedbackText, rating: currentRating });

            const container = document.getElementById('feedback-container');
            const success = document.getElementById('feedback-success');
            
            container.classList.add('hidden');
            success.classList.remove('hidden');
            sfx.nav(); // <--- Subtle confirmation
            lucide.createIcons(); // Ensure the checkmark renders
        }

        // Helper for coordinates (Ensure this is accessible)
        const getEventCoords = (e) => {
            if (e.touches && e.touches[0]) return { x: e.touches[0].clientX, y: e.touches[0].clientY };
            return { x: e.clientX, y: e.clientY };
        };

        let currentSortIndex = 0;
        let sortScore = 0;
        let rapidSortMistakes = 0; // New counter
        
        function initRapidSort() {
            currentSortIndex = 0;
            sortScore = 0;
            rapidSortMistakes = 0; // Reset counter
            document.getElementById('sort-counter').textContent = '0';
            document.getElementById('sort-complete-msg').classList.add('hidden');
            document.getElementById('current-sort-item').classList.remove('hidden');
            loadNextSortItem();
        }

        function loadNextSortItem() {
            if (currentSortIndex >= sortItems.length) {
                document.getElementById('current-sort-item').classList.add('hidden');
                document.getElementById('sort-complete-msg').classList.remove('hidden');
                document.getElementById('sort-feedback-bar').innerHTML = `<strong>All Clear! Proceed to Scanner.</strong>`;
                document.getElementById('sort-feedback-bar').className = "min-h-[60px] p-3 rounded border border-green-200 bg-green-50 text-center flex items-center justify-center transition-colors";
                sfx.powerOn();
                
                // FIX: Log Rapid Sort Completion
                const detailText = rapidSortMistakes === 0 ? "Perfect Score" : `Completed with ${rapidSortMistakes} errors`;
                SessionManager.log("Rapid Sort Completed", detailText, { mistakes: rapidSortMistakes });
                completionFlags.rapidSort = true;
                return;
            }

            const item = sortItems[currentSortIndex];
            const el = document.getElementById('current-sort-item');
            el.innerHTML = `<i data-lucide="${item.icon}" class="w-10 h-10 text-allgood-secondary mb-2 pointer-events-none"></i><span class="font-bold text-sm text-allgood-dark pointer-events-none">${item.name}</span>`;
            el.setAttribute('data-correct', item.type);
            
            // Re-init drag events specifically for this element
            el.style.transform = 'none'; // Reset any previous drag transforms
            lucide.createIcons();
            
            // Reset feedback bar for the new item
            document.getElementById('sort-feedback-bar').innerHTML = `<p class="text-sm text-gray-500 italic">Drag item to BAG or BIN...</p>`;
            document.getElementById('sort-feedback-bar').className = "min-h-[60px] p-3 rounded border border-gray-200 bg-gray-100 text-center flex items-center justify-center transition-colors";
        }

        // Specific drag handlers for Sort Game
        let currentSortDrag = null;
        let sortDragOffsetX = 0;
        let sortDragOffsetY = 0;

        function handleSortDragStart(e) {
            const item = e.target.closest('#current-sort-item');
            if (!item || item.classList.contains('hidden')) return;
            if (e.type !== 'touchstart') e.preventDefault(); // Prevent default drag ghost

            currentSortDrag = item;
            sfx.tick();

            const rect = item.getBoundingClientRect();
            const coords = getEventCoords(e);
            sortDragOffsetX = coords.x - rect.left;
            sortDragOffsetY = coords.y - rect.top;

            item.style.width = `${rect.width}px`;
            item.style.height = `${rect.height}px`;
            item.style.position = 'fixed';
            item.style.zIndex = '9999';
            item.style.left = `${rect.left}px`;
            item.style.top = `${rect.top}px`;
            item.classList.add('dragging');
            item.style.pointerEvents = 'none'; // Allow seeing through to drop zones

            // Highlight zones
            document.querySelectorAll('.sort-zone').forEach(z => {
                z.classList.add('bg-blue-50', 'border-allgood-secondary');
                z.classList.remove('bg-gray-50', 'border-gray-300');
            });

            document.addEventListener('mousemove', handleSortDragMove, { passive: false });
            document.addEventListener('touchmove', handleSortDragMove, { passive: false });
            document.addEventListener('mouseup', handleSortDragEnd);
            document.addEventListener('touchend', handleSortDragEnd);
        }

        function handleSortDragMove(e) {
            if (!currentSortDrag) return;
            e.preventDefault();
            const coords = getEventCoords(e);
            currentSortDrag.style.left = `${coords.x - sortDragOffsetX}px`;
            currentSortDrag.style.top = `${coords.y - sortDragOffsetY}px`;
        }

        function handleSortDragEnd(e) {
            if (!currentSortDrag) return;

            const coords = e.changedTouches ? { x: e.changedTouches[0].clientX, y: e.changedTouches[0].clientY } : { x: e.clientX, y: e.clientY };
            const targetUnderneath = document.elementFromPoint(coords.x, coords.y);
            const zone = targetUnderneath ? targetUnderneath.closest('.sort-zone') : null;

            // Reset item styles immediately
            currentSortDrag.style.position = '';
            currentSortDrag.style.zIndex = '';
            currentSortDrag.style.left = '';
            currentSortDrag.style.top = '';
            currentSortDrag.style.width = '';
            currentSortDrag.style.height = '';
            currentSortDrag.classList.remove('dragging');
            currentSortDrag.style.pointerEvents = 'auto';

            // Reset zones
            document.querySelectorAll('.sort-zone').forEach(z => {
                z.classList.remove('bg-blue-50', 'border-allgood-secondary', 'bg-green-100', 'border-green-500', 'bg-red-100', 'border-red-500');
                z.classList.add('bg-gray-50', 'border-gray-300');
            });

            if (zone) {
                const itemData = sortItems[currentSortIndex];
                const droppedZone = zone.getAttribute('data-zone');
                const correctZone = currentSortDrag.getAttribute('data-correct');
                const feedbackBar = document.getElementById('sort-feedback-bar');

                if (droppedZone === correctZone) {
                    // Correct
                    sfx.nav();
                    sortScore++;
                    feedbackBar.innerHTML = `<strong>CORRECT: ${itemData.reason}</strong>`;
                    feedbackBar.className = "min-h-[60px] p-3 rounded border border-green-200 bg-green-50 text-center flex items-center justify-center transition-colors";
                    zone.classList.add('bg-green-100', 'border-green-500'); // Visual flash
                    currentSortIndex++;
                    document.getElementById('sort-counter').textContent = currentSortIndex;
                    setTimeout(() => {
                        zone.classList.remove('bg-green-100', 'border-green-500'); // Clear flash
                        loadNextSortItem();
                    }, 500);
                } else {
                    // Incorrect
                    sfx.powerOff();
                    rapidSortMistakes++; // Increment error
                    feedbackBar.innerHTML = `<strong>MISTAKE. Incorrect placement. Retry this item.</strong><br><span class="text-xs text-red-600">${itemData.reason}</span>`;
                    feedbackBar.className = "min-h-[60px] p-3 rounded border border-red-200 bg-red-50 text-center flex items-center justify-center transition-colors";
                    zone.classList.add('bg-red-100', 'border-red-500'); // Visual flash
                    setTimeout(() => {
                        zone.classList.remove('bg-red-100', 'border-red-500'); // Clear flash
                    }, 500);
                }
            } else {
                // Dropped outside zones
                sfx.powerOff();
                rapidSortMistakes++; // Increment error
                const feedbackBar = document.getElementById('sort-feedback-bar');
                feedbackBar.innerHTML = `<strong>MISSION ABORT.</strong> You must place the item in a zone.`;
                feedbackBar.className = "min-h-[60px] p-3 rounded border border-red-200 bg-red-50 text-center flex items-center justify-center transition-colors";
            }

            // Clean up listeners
            document.removeEventListener('mousemove', handleSortDragMove);
            document.removeEventListener('touchmove', handleSortDragMove);
            document.removeEventListener('mouseup', handleSortDragEnd);
            document.removeEventListener('touchend', handleSortDragEnd);
            currentSortDrag = null;
        } 
        
        // --- SEQUENCER LOGIC (Page 22 - Immediate Feedback) ---
        let currentSeqStep = 1;
        const totalSeqSteps = 5;
        let seqMistakes = 0; // FIX: Track mistakes

        function checkSequenceStep(btn) {
            const stepVal = parseInt(btn.getAttribute('data-step'));
            const feedbackText = btn.getAttribute('data-feedback');
            const feedbackBubble = document.getElementById('seq-feedback-bubble');
            
            if (stepVal === currentSeqStep) {
                // CORRECT
                sfx.nav();
                
                // Update the Ladder (Left Side)
                const currentSlot = document.querySelector(`.seq-step[data-index="${currentSeqStep}"]`);
                currentSlot.classList.remove('bg-orange-50', 'border-allgood-primary', 'scale-105', 'shadow-md');
                currentSlot.classList.add('bg-green-100', 'border-green-500', 'text-green-800', 'shadow-sm');
                currentSlot.innerHTML = `<div class="flex items-center w-full"><span class="font-bold mr-2">${currentSeqStep}.</span><span class="text-xs text-left leading-tight">${btn.innerText}</span><i data-lucide="check" class="w-4 h-4 ml-auto text-green-600"></i></div>`;
                
                // Disable the button
                btn.classList.add('opacity-0', 'pointer-events-none');
                
                // Hide Feedback Bubble
                feedbackBubble.classList.add('hidden');

                // Advance or Finish
                currentSeqStep++;
                if (currentSeqStep <= totalSeqSteps) {
                    // Highlight next step
                    const nextSlot = document.querySelector(`.seq-step[data-index="${currentSeqStep}"]`);
                    if (nextSlot) {
                        nextSlot.classList.remove('opacity-50', 'bg-gray-50', 'border-gray-200');
                        nextSlot.classList.add('bg-orange-50', 'border-allgood-primary', 'shadow-md', 'scale-105');
                        const span = nextSlot.querySelector('span');
                        if (span) {
                            span.classList.remove('text-gray-400');
                            span.classList.add('text-allgood-primary');
                        }
                    }
                } else {
                    // Finished
                    feedbackBubble.textContent = "Sequence Perfected. You are ready for the gauntlet.";
                    feedbackBubble.className = "mt-4 p-3 rounded bg-green-100 border border-green-300 text-green-800 text-sm font-bold text-center";
                    feedbackBubble.classList.remove('hidden');
                    sfx.powerOn(); // Victory sound
                    
                    // FIX: Log Sequence Completion
                    SessionManager.log("Sequence Game Completed", `Mistakes made: ${seqMistakes}`);
                }
                lucide.createIcons(); // Re-render checkmark
            } else {
                // INCORRECT
                sfx.powerOff();
                seqMistakes++; // Track error
                btn.classList.add('bg-red-100', 'border-red-300', 'text-red-800');
                setTimeout(() => {
                    btn.classList.remove('bg-red-100', 'border-red-300', 'text-red-800');
                }, 500);
                
                feedbackBubble.textContent = feedbackText || "Incorrect step order.";
                feedbackBubble.className = "mt-4 p-3 rounded bg-red-100 border border-red-300 text-red-800 text-sm font-bold text-center animate-pulse";
                feedbackBubble.classList.remove('hidden');
            }
        }

        function resetSequence() {
            currentSeqStep = 1;
            seqMistakes = 0; // Reset mistake counter
            
            // Reset Ladder
            document.querySelectorAll('.seq-step').forEach((slot, index) => {
                const stepNum = index + 1;
                // Reset classes
                slot.className = "seq-step p-2 rounded border flex items-center justify-center h-12 transition-all";
                if (stepNum === 1) {
                    slot.classList.add('bg-orange-50', 'border-allgood-primary', 'shadow-md');
                    slot.innerHTML = `<span class="font-bold text-allgood-primary text-lg">1</span>`;
                } else {
                    slot.classList.add('border-gray-200', 'bg-gray-50', 'opacity-50');
                    slot.innerHTML = `<span class="font-bold text-gray-400 text-lg">${stepNum}</span>`;
                }
            });

            // Reset Buttons
            document.querySelectorAll('.seq-opt').forEach(btn => {
                btn.classList.remove('opacity-0', 'pointer-events-none', 'bg-red-100', 'border-red-300', 'text-red-800');
            });
            
            // Hide Feedback
            document.getElementById('seq-feedback-bubble').classList.add('hidden');
        }

        // --- AUDIO ENGINE (Tonal Feedback) ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx;

        function initAudio() {
            // Check if audioCtx is defined and its state, attempt to resume if needed.
            // This is crucial for environments where audio starts muted.
            if (!audioCtx) {	
                audioCtx = new AudioContext();	
            }
            if (audioCtx.state === 'suspended') {	
                audioCtx.resume().catch(e => console.error("Audio resume failed:", e));
            }
        }

        function playTone(freq, type, duration, vol = 0.1, attack = 0.01, decay = 0.001) {
            initAudio();	
            const now = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, now);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(vol, now + attack);	
            gain.gain.exponentialRampToValueAtTime(decay, now + duration);	
            osc.start(now);
            osc.stop(now + duration);
        }

        const sfx = {
            // Success/Completion Sound
            powerOn: () => {
                initAudio();
                const now = audioCtx.currentTime;
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(110, now);
                osc.frequency.exponentialRampToValueAtTime(220, now + 0.4);
                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(0.4, now + 0.1);
                gain.gain.linearRampToValueAtTime(0, now + 0.4);
                osc.start(now); osc.stop(now + 0.4);
            },
            // Error/Fail Sound
            powerOff: () => {	
                initAudio();	
                playTone(80, 'triangle', 0.2, 0.5, 0.01, 0.001);	
            },
            // Page Turn/Correct Nav Sound
            nav: () => {	
                initAudio();	
                playTone(150, 'sine', 0.1, 0.1, 0.01, 0.01);	
            },
            // UI Click/Tap Sound
            tick: () => {	
                initAudio();	
                playTone(1000, 'sine', 0.01, 0.01);	
            }
        };

        // --- CORE APPLICATION LIFECYCLE ---
        
        // Functionality previously handled by slider.value 0 or 1
        function updateFlightDisplay(value) {
            const resultBox = document.getElementById('flight-result');
            const timeIcon = document.getElementById('time-icon');
            const actionBox = document.getElementById('action-box');
            const switchContainer = document.getElementById('flight-type-switch');
            
            const val = String(value);
            
            // Highlight the active option text
            const options = switchContainer.querySelectorAll('.flight-type-option');
            options.forEach(opt => opt.classList.remove('active'));
            const activeOption = switchContainer.querySelector(`.flight-type-option[data-value="${val}"]`);
            if(activeOption) activeOption.classList.add('active');

            if (switchContainer) {
                switchContainer.setAttribute('data-state', val === "1" ? 'international' : 'domestic');
            }
            
            // UI Updates based on selection
            if(val === "1") { // International
                document.getElementById('time-val').textContent = "3 Hours Early";
                document.getElementById('why-val').textContent = "You aren't just fighting traffic; you are navigating a geopolitical border. Customs clearance and long-haul boarding are rigid. 3 Hours is your shield against the unexpected.";
                document.getElementById('action-val').innerHTML = "Go get your Passport. Open it. Does it expire within 6 months? If yes, you may be denied entry.";
                
                resultBox.classList.remove('bg-gray-100', 'border-gray-200');
                resultBox.classList.add('bg-orange-50', 'border-allgood-primary');
                timeIcon.classList.remove('bg-blue-100', 'text-blue-600');
                timeIcon.classList.add('bg-allgood-primary/20', 'text-allgood-primary');
                actionBox.classList.remove('border-gray-300');
                actionBox.classList.add('border-allgood-primary');
            } else { // Domestic (val === "0")
                document.getElementById('time-val').textContent = "2 Hours Early";
                document.getElementById('why-val').textContent = "The variable here is the TSA checkpoint. Lines fluctuate wildly. A 2-hour buffer transforms a frantic run into a calm walk.";
                document.getElementById('action-val').innerHTML = "Pull out your Wallet. Confirm you have your Real ID or Driver's License right now.";
                
                resultBox.classList.add('bg-gray-100', 'border-gray-200');
                resultBox.classList.remove('bg-orange-50', 'border-allgood-primary');
                timeIcon.classList.add('bg-blue-100', 'text-blue-600');
                timeIcon.classList.remove('bg-allgood-primary/20', 'text-allgood-primary');
                actionBox.classList.add('border-gray-300');
                actionBox.classList.remove('border-allgood-primary');
            }
            lucide.createIcons();
        }

        document.addEventListener('DOMContentLoaded', () => {
            
            // 1. Global Click Delegation for SFX
            document.body.addEventListener('click', (e) => {
                // Suppress clicks on the startup screen, or if it's a dedicated navigation/interactive element
                if (e.target.closest('#startup-screen')) return;
                if (e.target.closest('#next-button') || e.target.closest('#back-button')) return;
                if (e.target.closest('.quiz-btn') || e.target.closest('.tech-toggle input') || e.target.closest('.seq-btn')) return;
                
                // Handle new flight switch clicks explicitly below, but keep generic button clicks
                if (e.target.tagName === 'BUTTON' || e.target.tagName === 'A' || e.target.tagName === 'INPUT' || e.target.closest('button')) {
                    sfx.tick();
                }
            });

            // 2. Navigation Elements
            const pages = document.querySelectorAll('.page');
            const homeButton = document.getElementById('home-button');
            const nextButton = document.getElementById('next-button');
            const backButton = document.getElementById('back-button');
            const menuToggle = document.getElementById('menu-toggle');
            const menuModal = document.getElementById('menu-modal');
            const closeMenu = document.getElementById('close-menu');
            const menuLinks = document.querySelectorAll('.menu-link');
            const progressBar = document.getElementById('flex-progress-fill');	
            const headerPageIndicator = document.getElementById('header-page-indicator');
            const totalPages = pages.length;
            
            // 3. Page Control Functions
            function updateProgress() {
                const progress = ((currentPageIndex + 1) / totalPages);	
                if (progressBar) progressBar.style.width = `${progress * 100}%`;
                const indicator = document.getElementById('header-page-indicator');
                // Page numbers are 1-based, so current is +1
                if (indicator) indicator.textContent = `${currentPageIndex + 1} / ${totalPages}`;
            }

            function showPage(index) {
                if (index < 0 || index >= totalPages) return;
                
                // Handle logic when leaving page 20 (Rapid Sort)
                if (currentPageIndex === 19 && index !== 19) {
                    // Check if sort is completed before allowing navigation away
                    const isCompleted = completionFlags.rapidSort;
                    if (!isCompleted) {
                        const feedbackBar = document.getElementById('sort-feedback-bar');
                        feedbackBar.innerHTML = `<strong>FINISH SORT FIRST.</strong> Complete the rapid sort before moving on.`;
                        feedbackBar.className = "min-h-[60px] p-3 rounded border border-red-200 bg-red-50 text-center flex items-center justify-center transition-colors";
                        sfx.powerOff();
                        return;
                    }
                }
                
                // Handle logic when leaving page 8 (Bag Sort)
                if (currentPageIndex === 7 && index !== 7) {
                    const totalDraggables = 5;
                    const itemsSortedCheck = document.getElementById('draggables').parentElement.querySelectorAll('.drop-zone .draggable-item').length;
                    if (itemsSortedCheck < totalDraggables) {
                        document.getElementById('bag-feedback').classList.remove('text-allgood-primary', 'bg-green-100', 'border-green-500');
                        document.getElementById('bag-feedback').classList.add('text-red-600', 'bg-red-50', 'border-red-200');
                        document.getElementById('bag-feedback').textContent = "ERROR: You must sort all items before proceeding.";
                        document.getElementById('bag-feedback').classList.remove('hidden');
                        sfx.powerOff();
                        return;
                    }
                }
                
                // Successful navigation
                pages.forEach(page => { page.classList.remove('active'); });
                pages[index].classList.add('active');
                currentPageIndex = index;
                pages[index].scrollTop = 0; // Scroll to top on page change

                // Back Button State
                if (currentPageIndex === 0) {
                    backButton.disabled = true;
                    backButton.classList.add('opacity-0');	
                } else {
                    backButton.disabled = false;
                    backButton.classList.remove('opacity-0');
                }

                // Next Button Text / Visibility
                const nextSpan = nextButton.querySelector('span');
            if (nextSpan) {
                if (currentPageIndex === totalPages - 2) {	
                    nextSpan.textContent = 'Finish';
                    nextButton.style.display = 'flex';
                } else if (currentPageIndex === totalPages - 1) {	
                    nextButton.style.display = 'none';
                    // FIX: Trigger Badge Animation when reaching the final page
                    setTimeout(() => {
                        updateCertificationState(); // <--- Update UI based on flags
                        const certSection = document.getElementById('certification-section');
                        if(certSection) {
                            certSection.classList.remove('scale-95', 'opacity-0');
                            certSection.classList.add('scale-100', 'opacity-100');
                            // Silenced sfx.powerOn() here
                        }
                    }, 500);
                } else {
                    nextSpan.textContent = 'Next';
                    nextButton.style.display = 'flex';
                }
            }
            updateProgress();
            closeMenuModal();
            // Render Lucide icons on the new page content
            lucide.createIcons();
        }

        // FIX: Expose showPage globally so login handlers can access it
        window.showPage = showPage;

        function openMenuModal() { menuModal.classList.remove('hidden-modal'); menuModal.classList.add('visible-modal'); }
        function closeMenuModal() { menuModal.classList.remove('visible-modal'); menuModal.classList.add('hidden-modal'); }

        // --- BADGE DOWNLOAD LOGIC ---
        // New Function: Updates the lock state based on flags
        function updateCertificationState() {
            const btn = document.getElementById('download-badge-btn');
            
            // Helper to update list items
            const updateItem = (id, isComplete) => {
                const el = document.getElementById(id);
                if(!el) return;
                if (isComplete) {
                    el.classList.remove('text-gray-400');
                    el.classList.add('text-green-700', 'font-bold');
                    // Replace icon and text cleanly
                    el.innerHTML = `<i data-lucide="check-circle-2" class="w-4 h-4 mr-2 text-green-600"></i><span>${el.innerText}</span>`; 
                }
            };

            // Update List
            updateItem('req-bag', completionFlags.bagSort);
            updateItem('req-rapid', completionFlags.rapidSort);
            updateItem('req-quiz', completionFlags.readinessQuiz);

            // Check if All Complete
            if (completionFlags.bagSort && completionFlags.rapidSort && completionFlags.readinessQuiz) {
                // Unlock Button
                btn.disabled = false;
                btn.classList.remove('bg-gray-300', 'cursor-not-allowed', 'shadow-none');
                btn.classList.add('bg-allgood-primary', 'hover:bg-allgood-hover', 'shadow-lg', 'transform', 'hover:scale-105');
                btn.innerHTML = `<i data-lucide="download" class="w-4 h-4 mr-2"></i>Download Your Badge`;
            } else {
                // Keep Locked (Reset if needed)
                btn.disabled = true;
                btn.classList.add('bg-gray-300', 'cursor-not-allowed', 'shadow-none');
                btn.classList.remove('bg-allgood-primary', 'hover:bg-allgood-hover', 'shadow-lg', 'transform', 'hover:scale-105');
                btn.innerHTML = `<i data-lucide="lock" class="w-4 h-4 mr-2"></i>Certification Locked`;
            }
            lucide.createIcons();
        }

        // FIX: Ensure this function is globally defined to prevent ReferenceError
        window.downloadBadge = function() {
            // Validation Gate: Check completion flags
            if (!completionFlags.bagSort || !completionFlags.rapidSort || !completionFlags.readinessQuiz) {
                let missing = [];
                if(!completionFlags.bagSort) missing.push("Baggage Sort (Page 8)");
                if(!completionFlags.rapidSort) missing.push("Rapid Sort Protocol (Page 20)");
                if(!completionFlags.readinessQuiz) missing.push("Flight Readiness Check (Page 29)");
                
                // Use alert() as the original code was not using a custom modal
                alert(`Certification Incomplete.\n\nYou must achieve all core proficiencies to earn the badge.\nMissing:\n- ${missing.join('\n- ')}`);
                return;
            }

            // NEW: 1. Write Completion Signal to Firestore
            window.logModuleCompletion();

            // FIX: Log Badge Download
            SessionManager.log("Badge Downloaded", "Certification Earned");

            // Inject user name dynamically into the SVG
            // TARGETED FIX: Use the global currentUserName directly, fallback to AGENT if absolutely necessary
            const rawName = window.currentUserName || "Agent";
            const nameText = rawName.toUpperCase();
            const dateText = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }).toUpperCase();

            // REPLACED: Old badge with new Certificate Layout (1200x800)
            const badgeSVG = `
            <svg width="1200" height="800" viewBox="0 0 1200 800" xmlns="http://www.w3.org/2000/svg">
                
                <!-- Center Group: Translated to (300, 280) -->
                <g transform="translate(300, 280)">
                    
                    <defs>
                        <linearGradient id="gradBrand" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:#357889;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#2D6473;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    
                    <!-- Main Card Body -->
                    <rect x="10" y="10" width="580" height="220" rx="16" fill="white" stroke="#D1D5DB" stroke-width="1" />
                    
                    <!-- Header Strip -->
                    <path d="M 10 26 A 16 16 0 0 1 26 10 L 574 10 A 16 16 0 0 1 590 26 L 590 60 L 10 60 Z" fill="url(#gradBrand)" />
                    
                    <!-- Brand Name -->
                    <text x="30" y="42" font-family="Georgia, serif" font-weight="bold" font-size="18" fill="white" letter-spacing="1">ALLGOOD ACADEMY</text>
                    <text x="570" y="42" font-family="Verdana, sans-serif" font-size="12" fill="white" opacity="0.8" text-anchor="end">PRAGMATIC ACTION CERTIFIED</text>

                    <!-- Perforation Line -->
                    <path d="M 430 10 L 430 230" stroke="white" stroke-width="2" stroke-dasharray="6,6" opacity="0.4" />
                    <path d="M 430 60 L 430 230" stroke="#D1D5DB" stroke-width="2" stroke-dasharray="6,6" />

                    <!-- LEFT SECTION: Data & Skills -->
                    
                    <!-- Product Name -->
                    <text x="30" y="90" font-family="Verdana, sans-serif" font-size="10" fill="#757575" uppercase="true">GOODBLOCK MODULE</text>
                    <text x="30" y="110" font-family="Georgia, serif" font-weight="bold" font-size="18" fill="#D34716">AIRPORT NAVIGATOR</text>

                    <!-- Learner Name -->
                    <text x="30" y="140" font-family="Verdana, sans-serif" font-size="10" fill="#757575">CERTIFIED AGENT</text>
                    <!-- UPDATED: Font size reduced from 16 to 12 (25% reduction) -->
                    <text x="30" y="160" font-family="Verdana, sans-serif" font-weight="bold" font-size="12" fill="#4C4C4C">${nameText}</text>

                    <!-- Skills List -->
                    <g transform="translate(290, 90)">
                        <text x="0" y="0" font-family="Verdana, sans-serif" font-size="10" fill="#757575" font-weight="bold">PROTOCOLS CLEARED:</text>
                        
                        <rect x="0" y="10" width="12" height="12" rx="2" fill="#D34716" />
                        <text x="18" y="20" font-family="Verdana, sans-serif" font-size="10" fill="#4C4C4C">Baggage Logic</text>
                        
                        <rect x="0" y="30" width="12" height="12" rx="2" fill="#D34716" />
                        <text x="18" y="40" font-family="Verdana, sans-serif" font-size="10" fill="#4C4C4C">Security Divestment</text>
                        
                        <rect x="0" y="50" width="12" height="12" rx="2" fill="#D34716" />
                        <text x="18" y="60" font-family="Verdana, sans-serif" font-size="10" fill="#4C4C4C">Gate Strategy</text>
                    </g>

                    <!-- Date Stamp -->
                    <text x="30" y="205" font-family="Courier New, monospace" font-size="12" fill="#357889">ISSUED: ${dateText}</text>

                    <!-- RIGHT SECTION: Stub / Verification -->
                    <g transform="translate(450, 80)">
                        <rect x="20" y="0" width="80" height="80" fill="#F7F7F7" stroke="#D1D5DB" />
                        <path d="M 30 10 L 90 10 L 90 70 L 30 70 Z" fill="none" stroke="#357889" stroke-width="2" />
                        <rect x="45" y="25" width="30" height="30" fill="#357889" />
                        
                        <text x="60" y="100" font-family="Verdana, sans-serif" font-size="10" fill="#D34716" font-weight="bold" text-anchor="middle">VERIFIED</text>
                        <text x="60" y="120" font-family="Verdana, sans-serif" font-size="24" fill="#4C4C4C" font-weight="bold" text-anchor="middle">A+</text>
                    </g>
                </g>
            </svg>`;
            
            // NEW: 2. Write Completion Signal AND Artifact to Firestore
            window.logModuleCompletion(badgeSVG);

            const blob = new Blob([badgeSVG], {type: 'image/svg+xml'});
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Allgood-Badge-${nameText}.svg`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            sfx.nav();

            // UPDATE: Change download button style to indicate success
            const downloadBtn = document.getElementById('download-badge-btn');
            if(downloadBtn) {
                downloadBtn.classList.remove('bg-allgood-primary', 'hover:bg-allgood-hover');
                downloadBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                downloadBtn.innerHTML = `<i data-lucide="check" class="w-4 h-4 mr-2"></i>Badge Saved`;
            }
            lucide.createIcons();
        }

        // 4. Reset Logic
        function performHardReset() {
                sfx.powerOff();
                currentUserName = "Anonymous";
                currentUserEmail = "";
                sessionId = "session_" + Date.now() + "_" + Math.floor(Math.random() * 1000); // New Session ID
                
                // Reset Completion Flags
                completionFlags.bagSort = false;
                completionFlags.rapidSort = false;
                completionFlags.readinessQuiz = false;

                document.getElementById('user-name-input').value = "";
                document.getElementById('user-email-input').value = "";
                const headerText = document.getElementById('header-welcome-text');
                if (headerText) headerText.textContent = "Airport Navigator";
                
                // Reset all Quizzes/Interactions
                document.querySelectorAll('.quiz-container').forEach(container => {
                    container.removeAttribute('data-answered');
                    const feedback = container.nextElementSibling || container.parentElement.querySelector('.feedback');
                    if(feedback && feedback.classList.contains('feedback')) feedback.classList.add('hidden');
                    container.querySelectorAll('button').forEach(btn => {
                        btn.disabled = false;
                        btn.classList.remove('cursor-not-allowed', 'opacity-50', 'bg-green-100', 'bg-red-100', 'border-green-500', 'border-red-500', 'ring-1', 'bg-blue-50', 'border-allgood-secondary', 'text-allgood-secondary');
                        btn.classList.add('hover:bg-gray-50', 'bg-white', 'border-gray-300'); 
                        btn.classList.remove('text-green-900', 'text-red-900');
                    });
                });
                
                // Reset Rapid Sort (Page 20)
                initRapidSort();

                // Reset Flip Cards
                document.querySelectorAll('.flip-card').forEach(card => card.classList.remove('flipped'));

                // Reset Drag & Drop (Page 8)
                const draggablesContainer = document.getElementById('draggables');
                const dropZones = document.querySelectorAll('.drop-zone');
                const allDraggableItems = document.querySelectorAll('.draggable-item');
                
                let itemsSorted = 0; // Re-declare locally for function scope
                allDraggableItems.forEach(item => {
                    // Reset styling and move back to source container
                    item.classList.remove('bg-green-100', 'border-green-500', 'cursor-default', 'shadow-md', 'mb-2', 'p-2', 'text-sm');
                    item.classList.add('bg-white', 'border-gray-300', 'px-3', 'py-2', 'rounded', 'text-xs', 'cursor-grab', 'shadow-sm');
                    item.setAttribute('draggable', 'true');
                    draggablesContainer.appendChild(item); 
                });
                dropZones.forEach(zone => {
                    // Clear any lingering items if they weren't in the main draggable container
                    Array.from(zone.children).forEach(child => {
                        // Ensure only the header span remains
                        if (child.tagName !== 'SPAN') child.remove(); 
                    });
                });

                // Reset Bag Sort feedback
                document.getElementById('bag-feedback').classList.remove('text-red-600', 'bg-red-50', 'border-red-200', 'p-3', 'rounded');
                document.getElementById('bag-feedback').classList.add('text-allgood-primary');
                document.getElementById('bag-feedback').textContent = "Correct! Rules mastered.";
                document.getElementById('bag-feedback').classList.add('hidden');
                
                // Reset Flowchart (Page 28)
                document.querySelectorAll('.flow-node').forEach(node => node.classList.remove('active'));

                // Reset Sequencer (Page 22)
                resetSequence();
                
                // Reset Flight Switch (Page 6)
                const switchElement = document.getElementById('flight-type-switch');
                if (switchElement) {
                    // Manually trigger update logic to reflect domestic on reset
                    updateFlightDisplay(0); 
                }
                
                // Reset Feedback/Badge Page
                document.getElementById('feedback-container').classList.remove('hidden');
                document.getElementById('feedback-success').classList.add('hidden');
                document.getElementById('certification-section').classList.add('scale-95', 'opacity-0');
                document.getElementById('certification-section').classList.remove('scale-100', 'opacity-100');
                setRating(0); // Reset stars

                // Reset Startup UI
                const startup = document.getElementById('startup-screen');
                startup.style.display = 'flex';
                void startup.offsetWidth;	
                startup.style.opacity = '1';
                const loginModal = document.getElementById('login-modal');
                loginModal.classList.remove('hidden-modal');
                loginModal.classList.add('visible-modal');
                
                showPage(0);
            }

            // 5. Event Listeners
            if(menuToggle) menuToggle.addEventListener('click', openMenuModal);
            if(closeMenu) closeMenu.addEventListener('click', closeMenuModal);
            menuModal.addEventListener('click', (e) => { if (e.target === menuModal) closeMenuModal(); });

            menuLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    const pageIndex = parseInt(e.currentTarget.dataset.page);
                    showPage(pageIndex);
                });
            });

            // Fix for navigation logic on Finish button on page 28
            if(nextButton) nextButton.addEventListener('click', () => { 
                if (currentPageIndex < totalPages - 1) {
                    showPage(currentPageIndex + 1); 
                    sfx.nav();
                }
            });
            if(backButton) backButton.addEventListener('click', () => { 
                if (currentPageIndex > 0) {
                    showPage(currentPageIndex - 1); 
                    sfx.nav();
                }
            });


            // Startup & Login (Page 1 -> Login)
            const startupScreen = document.getElementById('startup-screen');
            if (startupScreen) {
                // FIX: Warm up audio context on mousedown/touch to reduce playback latency
                const warmUp = () => initAudio();
                startupScreen.addEventListener('mousedown', warmUp, { once: true });
                startupScreen.addEventListener('touchstart', warmUp, { once: true });

                startupScreen.addEventListener('click', () => {
                    sfx.powerOn();
                    
                    if (window.currentUser) {
                        // User exists (SSO/Auth)?
                        // Log Session Start immediately
                        window.SessionManager.start(window.currentUserName, window.currentUserEmail);
                        
                        // Reveal Page 1 immediately
                        window.showPage(0);
                        // Fade out Startup Screen
                        startupScreen.style.opacity = '0';
                        setTimeout(() => { startupScreen.style.display = 'none'; }, 700);
                    } else {
                        // No user (Direct Link)?
                        // Show Modal *over* current view
                        const loginModal = document.getElementById('login-modal');
                        if (loginModal) {
                            loginModal.classList.remove('hidden-modal');
                            loginModal.classList.add('visible-modal');
                        }
                        // Fade out Startup Screen (revealing modal + obscured page 1)
                        startupScreen.style.opacity = '0';
                        setTimeout(() => { startupScreen.style.display = 'none'; }, 700);
                    }
                });
            }

            // Accordions
            document.querySelectorAll('.accordion-toggle').forEach(acc => {
                acc.addEventListener('click', function() {
                    const content = this.nextElementSibling;
                    const icon = this.querySelector('.accordion-icon');
                    const isOpen = !content.classList.contains('hidden');
                    
                    // Collapse all others
                    document.querySelectorAll('.accordion-content').forEach(c => { c.classList.add('hidden'); });
                    document.querySelectorAll('.accordion-icon').forEach(i => { i.classList.remove('rotate-180'); });
                    
                    // Open the one that was clicked, if it was closed
                    if (!isOpen) {
                        content.classList.remove('hidden');
                        if(icon) icon.classList.add('rotate-180');
                        sfx.tick();
                    }
                });
            });

            // Flight Type Switch Logic (Page 6)
            const switchElement = document.getElementById('flight-type-switch');
            if(switchElement) {
                const options = switchElement.querySelectorAll('.flight-type-option');
                options.forEach(option => {
                    option.addEventListener('click', () => {
                        const selectedValue = option.getAttribute('data-value');
                        
                        // Update the state attribute on the container
                        switchElement.setAttribute('data-state', selectedValue === "1" ? 'international' : 'domestic');
                        
                        // FIX: Log Flight Type Selection to Firestore
                        SessionManager.log("Flight Type Selected", selectedValue === "1" ? 'International' : 'Domestic');

                        updateFlightDisplay(selectedValue);
                        sfx.nav();
                    });
                });
                // Initial call to set UI state
                updateFlightDisplay(0);
            }

            // Blueprint & Fullscreen Toggles
            const blueprintToggle = document.getElementById('blueprint-toggle');
            if(blueprintToggle) {
                blueprintToggle.addEventListener('click', () => {
                    document.getElementById('screen').classList.toggle('blueprint-mode');
                    if (document.getElementById('screen').classList.contains('blueprint-mode')) {
                        blueprintToggle.classList.add('text-cyan-300', 'bg-white/10');
                    } else {
                        blueprintToggle.classList.remove('text-cyan-300', 'bg-white/10');
                    }
                });
            }
            
            const fullscreenToggle = document.getElementById('fullscreen-toggle');
            if(fullscreenToggle) {
                fullscreenToggle.addEventListener('click', () => {
                    const frame = document.querySelector('.tablet-frame');
                    frame.classList.toggle('focus-mode');
                    const isFocus = frame.classList.contains('focus-mode');
                    
                    if (isFocus) {
                        // Apply focus mode class to body to remove padding/margins
                        document.body.classList.add('is-focused');
                        // Attempt to go fullscreen on main document element
                        if (document.documentElement.requestFullscreen) {
                            document.documentElement.requestFullscreen().catch(err => console.log("Fullscreen blocked."));
                        }
                        fullscreenToggle.classList.add('text-green-300', 'bg-white/10');
                    } else {
                        // Remove focus mode class from body
                        document.body.classList.remove('is-focused');
                        // Exit fullscreen
                        if (document.fullscreenElement) {
                            if (document.exitFullscreen) document.exitFullscreen().catch(err => {});
                        }
                        fullscreenToggle.classList.remove('text-green-300', 'bg-white/10');
                    }
                });
            }

            // Long Press Home Button (for Hard Reset)
            if(homeButton) {
                let pressTimer = null;
                function startLongPress(e) {
                    // Prevent default action (like context menu) on touch/mouse down
                    e.preventDefault();	
                    // Only start timer on left click (e.button === 0) or touch
                    if (e.button === 0 || e.type === 'touchstart') {
                        pressTimer = setTimeout(() => { 
                            performHardReset(); 
                            pressTimer = null; // Mark as handled
                        }, 2000);
                    }
                }
                function cancelLongPress() {	
                    if (pressTimer) {
                        clearTimeout(pressTimer);	
                        pressTimer = null; // Mark as canceled/short
                    }
                }
                
                homeButton.addEventListener('mousedown', startLongPress);
                homeButton.addEventListener('mouseleave', cancelLongPress);
                homeButton.addEventListener('mouseup', (e) => {	
                    if (pressTimer !== null) { // If timer was running (not yet fired)
                        cancelLongPress();
                        // Short click, navigate home (if not already there)
                        if (currentPageIndex !== 0) {
                            showPage(0);
                            sfx.nav();
                        }
                    }
                    // If pressTimer was null, the long press already triggered or it was a non-left-click
                });
                homeButton.addEventListener('touchstart', startLongPress, { passive: false });
                homeButton.addEventListener('touchend', cancelLongPress);
            }

            // Initialize Drag & Drop Logic (Page 8)
            let currentDragItem = null;
            let dragOffsetX = 0;
            let dragOffsetY = 0;
            let itemsSorted = 0;
            // FIX: Added counter for bag sort mistakes
            let bagSortMistakes = 0;

            const handleDragStart = (e) => {
                const item = e.target.closest('.draggable-item');
                if (!item || item.classList.contains('cursor-default')) return;
                if (e.type !== 'touchstart') e.preventDefault();	

                currentDragItem = item;
                sfx.tick();

                const rect = item.getBoundingClientRect();
                const coords = getEventCoords(e);
                dragOffsetX = coords.x - rect.left;
                dragOffsetY = coords.y - rect.top;

                // Prepare item for fixed positioning drag
                item.style.width = `${rect.width}px`;
                item.style.height = `${rect.height}px`;
                item.style.position = 'fixed';
                item.style.zIndex = '9999';
                item.style.left = `${rect.left}px`;
                item.style.top = `${rect.top}px`;
                item.classList.add('dragging');
                item.style.pointerEvents = 'none';	// Allows elementFromPoint to find the drop zone underneath

                document.querySelectorAll('.drop-zone').forEach(z => z.classList.add('active-zone'));

                document.addEventListener('mousemove', handleDragMove, { passive: false });
                document.addEventListener('touchmove', handleDragMove, { passive: false });
                document.addEventListener('mouseup', handleDragEnd);
                document.addEventListener('touchend', handleDragEnd);
            };

            const handleDragMove = (e) => {
                if (!currentDragItem) return;
                e.preventDefault();	
                const coords = getEventCoords(e);
                currentDragItem.style.left = `${coords.x - dragOffsetX}px`;
                currentDragItem.style.top = `${coords.y - dragOffsetY}px`;
            };

            const handleDragEnd = (e) => {
                if (!currentDragItem) return;

                const coords = e.changedTouches ? { x: e.changedTouches[0].clientX, y: e.changedTouches[0].clientY } : { x: e.clientX, y: e.clientY };
                const targetUnderneath = document.elementFromPoint(coords.x, coords.y);
                const zone = targetUnderneath ? targetUnderneath.closest('.drop-zone') : null;
                
                // Keep track of the original item reference
                const droppedItem = currentDragItem;

                // Reset item styles immediately (snap back, will be repositioned if successful)
                droppedItem.style.position = '';
                droppedItem.style.zIndex = '';
                droppedItem.style.left = '';
                droppedItem.style.top = '';
                droppedItem.style.width = '';
                droppedItem.style.height = '';
                droppedItem.classList.remove('dragging');	
                droppedItem.style.pointerEvents = 'auto';	

                // Check for correct drop
                if (zone && droppedItem.dataset.target === zone.dataset.cat) {
                    // Correct: Snap item to the drop zone
                    zone.appendChild(droppedItem);
                    
                    droppedItem.classList.remove('cursor-grab', 'shadow-sm', 'bg-white', 'border-gray-300', 'px-3', 'py-2', 'text-xs', 'rounded');
                    droppedItem.classList.add('bg-green-100', 'border-green-500', 'cursor-default', 'shadow-md', 'mb-2', 'p-2', 'text-sm');
                    droppedItem.removeAttribute('draggable'); // Prevent future dragging
                    sfx.nav();
                    
                    itemsSorted++;
                    if (itemsSorted >= 5) {
                        document.getElementById('bag-feedback').classList.remove('hidden');
                        document.getElementById('bag-feedback').classList.add('bg-green-100', 'border-green-500', 'text-green-800', 'p-3', 'rounded');
                        document.getElementById('bag-feedback').textContent = "Excellent! All cargo is sorted and compliant. Proceed to check-in.";
                        
                        // FIX: Mark Bag Sort as Complete & Log to Firestore
                        completionFlags.bagSort = true;
                        const detailText = bagSortMistakes === 0 ? "Perfect Score" : `Completed with ${bagSortMistakes} errors`;
                        SessionManager.log("Bag Sort Completed", detailText, { mistakes: bagSortMistakes });
                    }
                } else {
                    // Incorrect or Dropped outside: Increment mistake count and let it snap back visually
                    sfx.powerOff();	
                    bagSortMistakes++;
                    
                    // Show immediate feedback for an incorrect drop
                    const feedbackEl = document.getElementById('bag-feedback');
                    feedbackEl.classList.remove('hidden', 'bg-green-100', 'border-green-500', 'text-green-800');
                    feedbackEl.classList.add('bg-red-50', 'border-red-300', 'text-red-800', 'p-3', 'rounded');
                    feedbackEl.textContent = `MISTAKE: That item does not belong there. Check the rules and try again. Mistakes: ${bagSortMistakes}`;

                }
                
                // Clean up drag state
                document.querySelectorAll('.drop-zone').forEach(z => z.classList.remove('active-zone'));
                document.removeEventListener('mousemove', handleDragMove);
                document.removeEventListener('touchmove', handleDragMove);
                document.removeEventListener('mouseup', handleDragEnd);
                document.removeEventListener('touchend', handleDragEnd);
                currentDragItem = null;
            };

            // Initial drag event setup (General Draggables)
            document.querySelectorAll('#draggables').forEach(container => {
                container.addEventListener('mousedown', handleDragStart);
                container.addEventListener('touchstart', handleDragStart, { passive: false });
            });

            // Rapid Sort Event Setup (Page 20)
            const sortItem = document.getElementById('current-sort-item');
            if(sortItem) {
                sortItem.addEventListener('mousedown', handleSortDragStart);
                sortItem.addEventListener('touchstart', handleSortDragStart, { passive: false });
                initRapidSort(); // Initialize on load
            }
            
            // Final initialization: set year, apply icons, and show first page
            document.getElementById('current-year').textContent = new Date().getFullYear();
            lucide.createIcons(); // Initialize all Lucide icons
            // Page logic handled by Auth Logic/DOM Ready listeners now
        });
    </script>
</body>
</html>
