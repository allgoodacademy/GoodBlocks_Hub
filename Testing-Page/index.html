<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Jodi's Schoolhouse: Rage Revenue</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons for interactions -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Font Awesome for stars/icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <!-- FIREBASE AND AUTHENTICATION SETUP -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, GoogleAuthProvider, signInWithPopup, updateProfile, signOut, setPersistence, browserLocalPersistence } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, addDoc, collection, serverTimestamp, getDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
        
        // 1. CONFIGURATION
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "", // Injected by env
            authDomain: "allgood-academy.firebaseapp.com",
            projectId: "allgood-academy",
            storageBucket: "allgood-academy.firebasestorage.app",
            messagingSenderId: "978829044870",
            appId: "1:978829044870:web:6c780f64230a77ad0ab507"
        };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'allgood-academy'; 
        
        // 2. INITIALIZE SERVICES
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        setPersistence(auth, browserLocalPersistence).catch(console.error);
        window.authSignOut = () => signOut(auth);

        // 3. GLOBAL STATE
        window.currentUser = null;
        window.currentUserName = "Learner";
        window.sessionId = "session_" + Date.now() + "_" + Math.floor(Math.random() * 1000);

        // 4. AUTH HANDLER
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                window.currentUser = user;
                let finalName = user.displayName || "Learner";
                if (finalName === "Learner") {
                    try {
                        const userDoc = await getDoc(doc(db, 'artifacts', appId, 'users', user.uid));
                        if (userDoc.exists() && userDoc.data().displayName) finalName = userDoc.data().displayName;
                    } catch(e) {}
                }
                window.currentUserName = finalName;
                document.getElementById('header-welcome-text').textContent = `Welcome, ${finalName}`;
                document.getElementById('login-modal').classList.add('hidden-modal');
                document.getElementById('login-modal').classList.remove('visible-modal');
                if(window.SessionManager) window.SessionManager.start(finalName, user.email);
            }
        });

        // 5. LOGGING
        window.logToFirestore = async (action, detail, payload = {}) => {
            const user = auth.currentUser;
            if (!user) return;
            const sessionRef = doc(db, 'artifacts', appId, 'users', user.uid, 'game_scores', window.sessionId);
            try {
                await setDoc(sessionRef, {
                    gameName: "Rage Revenue", 
                    lastUpdated: serverTimestamp(),
                    user: { uid: user.uid, displayName: window.currentUserName }
                }, { merge: true });
            } catch (e) { console.error("DB Error", e); }
        };

        window.logModuleCompletion = async (badgeSVGString) => {
            const user = auth.currentUser;
            if (!user) return;
            const sessionRef = doc(db, 'artifacts', appId, 'users', user.uid, 'game_scores', window.sessionId);
            await setDoc(sessionRef, {
                gameName: "Rage Revenue", completed: true, finalScore: 100, badgeArtifact: badgeSVGString, lastUpdated: serverTimestamp()
            }, { merge: true });
        };

        // 6. LOGIN FUNCTIONS
        window.handleGuestLogin = async () => {
            const name = document.getElementById('user-name-input').value.trim() || "Learner";
            try {
                const result = await signInAnonymously(auth);
                await updateProfile(result.user, { displayName: name });
            } catch (e) { alert("Login failed"); }
        };

        window.handleGoogleLogin = async () => {
            try { await signInWithPopup(auth, new GoogleAuthProvider()); } catch (e) { alert("Google Login failed"); }
        };

        (async function initAuth() {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token).catch(e => console.warn(e));
            }
        })();
    </script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'allgood-primary': '#D34716', 
                        'allgood-secondary': '#357889', 
                        'allgood-dark': '#4C4C4C', 
                        'allgood-light': '#F7F7F7', 
                        'allgood-hover': '#EB8D69', 
                        'school-wood': '#8B5A2B',
                        'school-desk': '#E3C195',
                    },
                    fontFamily: {
                        'heading': ['Georgia', 'serif'],
                        'body': ['Verdana', 'sans-serif'],
                    },
                },
            },
        }
    </script>

    <style>
        /* Base styles from Template */
        body {
            font-family: Verdana, sans-serif;
            background-color: #1a1a1a;
            /* Schoolhouse Mode: Wood Desk Texture */
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.5' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100' height='100' fill='%235D4037'/%3E%3Crect width='100' height='100' filter='url(%23noise)' opacity='0.15'/%3E%3C/svg%3E");
            min-height: 100vh;
            position: relative;
        }

        h1, h2, h3, h4, h5, h6 { font-family: Georgia, serif; }

        .tablet-frame {
            height: 80vh;
            width: auto;
            aspect-ratio: 16/10; 
            max-width: 1100px;
            max-height: 95vh;
            min-height: 0; min-width: 0;
            background-image: 
                radial-gradient(circle at 0% 0%, rgba(211, 71, 22, 0.35) 0%, transparent 30%),
                radial-gradient(circle at 100% 100%, rgba(211, 71, 22, 0.35) 0%, transparent 30%),
                linear-gradient(135deg, #5c5c5c 0%, #d6d6d6 25%, #8a8a8a 50%, #e0e0e0 75%, #5c5c5c 100%);
            border-radius: 12px;
            padding: 12px; 
            box-shadow: inset 1px 1px 2px rgba(255,255,255, 0.6), inset -1px -1px 2px rgba(0,0,0, 0.8), 0 30px 60px -12px rgba(0, 0, 0, 0.8), 0 0 0 1px #111;
            border: 1px solid #333;
            position: relative;
            margin: 20px auto;
            transition: width 0.3s, height 0.3s, padding 0.3s;
        }

        .tablet-frame::before {
            content: '';
            position: absolute;
            top: 10px; left: 10px; right: 10px; bottom: 10px;
            border-radius: 6px;
            background: #111;
            z-index: 0;
        }

        .screen-container {
            width: 100%;
            height: 100%;
            background-color: #FFF8F0; /* Warm paper tone */
            position: relative;
            z-index: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column; 
            border-radius: 4px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }

        /* SCROLLBAR */
        #content-column::-webkit-scrollbar { width: 10px; }
        #content-column::-webkit-scrollbar-track { background: #e5e5e5; border-left: 1px solid #d1d5db; }
        #content-column::-webkit-scrollbar-thumb { background-color: #D34716; border-radius: 5px; border: 2px solid #e5e5e5; }
        #content-column::-webkit-scrollbar-thumb:hover { background-color: #EB8D69; }

        /* Modal Styles */
        .modal-transition { transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out; }
        .hidden-modal { opacity: 0; pointer-events: none; transform: translateY(-10px); }
        .visible-modal { opacity: 1; pointer-events: auto; transform: translateY(0); }

        /* Layout Structure */
        .navbar-content { flex: 0 0 60px; z-index: 20; }
        .footer-content { flex: 0 0 60px; z-index: 20; background-color: white; border-top: 1px solid #e5e7eb; position: relative; }
        
        #flex-progress-bar { height: 4px; width: 100%; background-color: #eee; position: absolute; top: 0; left: 0; }
        #flex-progress-fill { height: 100%; background-color: #D34716; width: 0%; transition: width 0.3s ease; }

        /* SPLIT LAYOUT STYLES */
        .split-layout { display: flex; flex-direction: column; height: 100%; width: 100%; overflow: hidden; }
        
        /* Left Column (Jodi) */
        .sidebar-jodi {
            width: 100%;
            height: auto;
            min-height: 140px;
            background-color: #5D4037; /* Desk Color */
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.5' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23noise)' opacity='0.1'/%3E%3C/svg%3E");
            border-bottom: 2px solid #3E2723;
            display: flex;
            align-items: flex-end;
            padding: 10px;
            position: relative;
            z-index: 10;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
        }

        /* Right Column (Content) */
        .content-column {
            flex: 1;
            overflow-y: auto;
            position: relative;
            background-color: #FFF8F0;
            padding-bottom: 20px;
        }

        .page { width: 100%; height: auto; padding: 20px; position: relative; display: none; }
        .page.active { display: block; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* JODI COMPONENT (Sidebar Version) */
        .jodi-wrapper {
            display: flex;
            flex-direction: row;
            align-items: center;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .jodi-avatar {
            width: 80px;
            height: 80px;
            flex-shrink: 0;
            margin-right: 15px;
            filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.3));
        }

        .jodi-bubble {
            background: white;
            border: 2px solid #357889;
            border-radius: 12px;
            border-bottom-left-radius: 0; /* Tail points to Jodi */
            padding: 12px;
            font-size: 0.85rem;
            color: #444;
            line-height: 1.4;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
            flex: 1;
            transform-origin: bottom left;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

        /* Blueprint Mode */
        .blueprint-mode { background-color: #0f172a !important; color: #94a3b8 !important; }
        .blueprint-mode .page, .blueprint-mode .content-column { background-color: #0f172a !important; }
        .blueprint-mode h1, .blueprint-mode h2, .blueprint-mode h3, .blueprint-mode strong { color: #38bdf8 !important; }
        .blueprint-mode .bg-white { background-color: #1e293b !important; border-color: #334155 !important; color: #cbd5e1 !important; }
        .blueprint-mode .text-allgood-dark { color: #e2e8f0 !important; }
        .blueprint-mode .bg-gray-100, .blueprint-mode .bg-gray-50 { background-color: #0f172a !important; border-color: #1e293b !important; }
        .blueprint-mode .footer-content { background-color: #1e293b !important; border-top-color: #334155 !important; color: #94a3b8 !important; }
        .blueprint-mode .footer-content a { color: #38bdf8 !important; }

        /* Focus Mode */
        .tablet-frame.focus-mode { 
            position: absolute !important; top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important; 
            width: 100% !important; height: 100% !important;
            aspect-ratio: auto !important; max-width: none !important; max-height: none !important; 
            min-height: 0 !important;
            margin: 0 !important; padding: 0 !important; 
            background: #F7F7F7 !important; border: none !important; border-radius: 0 !important; 
            box-shadow: none !important; z-index: 99999 !important; 
            background-image: none !important;
        }
        .tablet-frame.focus-mode::before { display: none; }
        .tablet-frame.focus-mode .screen-container { border-radius: 0; box-shadow: none; height: 100%; }
        .tablet-frame.focus-mode .footer-content { padding-bottom: 0; }

        /* Desktop Breakpoint */
        @media (min-width: 768px) {
            .split-layout { flex-direction: row; }
            
            .sidebar-jodi {
                width: 25%;
                height: 100%;
                border-bottom: none;
                border-right: 2px solid #3E2723;
                flex-direction: column;
                justify-content: flex-end; /* Jodi sits at bottom */
                padding: 20px;
            }

            .content-column { width: 75%; }

            .jodi-wrapper {
                flex-direction: column-reverse; /* Avatar at bottom, Bubble above */
                align-items: center;
                width: 100%;
            }

            .jodi-avatar {
                width: 140px;
                height: 140px;
                margin-right: 0;
                margin-top: 15px;
            }

            .jodi-bubble {
                border-radius: 12px;
                border-bottom-left-radius: 12px;
                border-bottom-right-radius: 0; /* Tail points down-right to Jodi if desired, or simpler tooltip style */
                margin-bottom: 10px;
                text-align: center;
            }
            .jodi-bubble::after {
                content: ''; position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%);
                width: 0; height: 0; border-left: 8px solid transparent;
                border-right: 8px solid transparent; border-top: 8px solid #357889;
            }
        }

        /* Feed Simulator Styles */
        .feed-scroll { 
            height: 300px; overflow-y: scroll; border: 1px solid #e5e7eb; 
            border-radius: 8px; background: #fff; scroll-behavior: smooth;
        }
        .feed-item { 
            padding: 12px; border-bottom: 1px solid #f0f0f0; transition: background 0.2s; cursor: pointer; 
        }
        .feed-item:hover { background-color: #f9fafb; }
        .feed-item.bait { border-left: 4px solid #D34716; }
        .feed-item.safe { border-left: 4px solid #357889; }

        /* Mobile Layout Overrides */
        @media (max-width: 768px) {
            html, body { width: 100%; height: 100%; margin: 0; padding: 0 !important; overflow: hidden !important; position: fixed; inset: 0; overscroll-behavior: none; }
            main { width: 100vw; height: 100dvh; position: fixed; inset: 0; padding: 0 !important; display: flex; flex-direction: column; z-index: 0; }
            .tablet-frame { position: relative !important; width: 100% !important; height: 100% !important; max-width: none !important; max-height: none !important; min-height: 0 !important; aspect-ratio: auto !important; margin: 0 !important; padding: 0 !important; border: none !important; border-radius: 0 !important; background-image: none !important; box-shadow: none !important; display: flex; flex-direction: column; }
            .tablet-frame::before { display: none; }
            .screen-container { flex: 1; width: 100%; height: 100%; display: flex; flex-direction: column; border-radius: 0 !important; box-shadow: none !important; overflow: hidden; }
            .navbar-content { padding-top: max(env(safe-area-inset-top), 5px); }
            .footer-content { z-index: 100; padding-bottom: max(env(safe-area-inset-bottom), 15px); height: auto; }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen text-allgood-dark font-body overflow-y-auto">

    <main class="flex-grow flex items-center justify-center py-8">
        <div class="tablet-frame">
            <div class="screen-container" id="screen">

                <!-- 1. STARTUP SCREEN -->
                <div id="startup-screen" class="absolute inset-0 z-[300] flex flex-col items-center justify-center cursor-pointer transition-opacity duration-700 ease-in-out bg-gradient-to-br from-allgood-secondary to-gray-900">
                    <div class="group flex flex-col items-center justify-center text-center h-full w-full relative">
                        <div class="flex-grow flex flex-col items-center justify-center px-4">
                            <div class="relative">
                                <div class="absolute inset-0 bg-white/10 blur-3xl rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-700"></div>
                                <i data-lucide="school" class="w-24 h-24 text-white mb-6 relative z-10 drop-shadow-[0_0_15px_rgba(255,255,255,0.5)]"></i>
                                <h2 class="text-xl md:text-2xl font-heading font-bold text-gray-300 mb-1 relative z-10 tracking-widest uppercase">Allgood Academy</h2>
                                <h1 class="text-5xl md:text-7xl font-heading font-bold text-transparent bg-clip-text bg-gradient-to-r from-white to-gray-400 tracking-tighter relative z-10 drop-shadow-sm">Jodi's Schoolhouse</h1>
                                <p class="mt-4 text-allgood-primary font-bold text-lg relative z-10 bg-white/10 px-4 py-1 rounded-full backdrop-blur-sm border border-white/10">Module: Rage Revenue</p>
                            </div>
                            <p class="mt-16 text-white/60 text-xs tracking-[0.4em] uppercase font-bold group-hover:text-white transition-colors animate-pulse">CLICK TO POWER UP</p>
                        </div>
                    </div>
                </div>

                <!-- 2. Header -->
                <header class="bg-allgood-secondary shadow-md navbar-content flex items-center shrink-0">
                    <div class="w-full px-4 flex items-center justify-between h-full">
                        <div class="flex items-center overflow-hidden">
                            <div id="header-welcome-text" class="text-white font-heading font-bold text-lg tracking-tight truncate mr-4 select-none">Welcome, Learner</div>
                            <div class="flex shrink-0 items-center bg-black/20 rounded-full px-3 py-1 border border-white/10 shadow-inner backdrop-blur-sm">
                                <span class="text-[10px] uppercase tracking-wider text-white/60 mr-2 font-heading font-bold">Page</span>
                                <span id="header-page-indicator" class="text-xs font-bold text-white font-body tabular-nums">1 / 15</span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-1 shrink-0 relative">
                            <button id="home-button" class="text-gray-200 hover:text-white transition-colors p-2 rounded-full hover:bg-white/10 mr-2" title="Go Home"><i data-lucide="home" class="w-6 h-6"></i></button>
                            <div class="h-6 w-px bg-white/20 mx-1"></div>
                            <button id="blueprint-toggle" class="text-gray-200 hover:text-cyan-300 transition-colors p-2 rounded-full hover:bg-white/10"><i data-lucide="moon" class="w-5 h-5"></i></button>
                            <button id="fullscreen-toggle" class="text-gray-200 hover:text-green-300 transition-colors p-2 rounded-full hover:bg-white/10"><i data-lucide="maximize" class="w-5 h-5"></i></button>
                            <button id="menu-toggle" class="text-gray-200 hover:text-white transition-colors p-2 rounded-full hover:bg-white/10"><i data-lucide="menu" class="w-7 h-7"></i></button>
                        </div>
                    </div>
                </header>

                <!-- MAIN SPLIT VIEW (New Wrapper) -->
                <div class="flex-1 min-h-0 relative split-layout">
                    
                    <!-- LEFT COLUMN: MENTOR SIDEBAR -->
                    <div class="sidebar-jodi shrink-0">
                        <div class="jodi-wrapper">
                            <div id="jodi-avatar-svg" class="jodi-avatar"></div>
                            <div id="jodi-bubble" class="jodi-bubble">
                                Welcome to the Schoolhouse. I'm Jodi.
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT COLUMN: CONTENT SCROLL AREA -->
                    <div class="content-column" id="content-column">
                        
                        <!-- PAGES (1-15) -->
                        
                        <!-- Page 1: Hook -->
                        <div class="page active" id="page-1">
                            <div class="h-full flex flex-col items-center justify-center text-center max-w-2xl mx-auto pt-10 px-6">
                                <div class="mb-4 text-allgood-secondary font-bold tracking-widest uppercase text-xs">Applied Media Literacy</div>
                                <h1 class="text-4xl md:text-5xl font-heading font-bold text-allgood-dark mb-4 text-shadow">The Rage Revenue Model</h1>
                                <div class="w-24 h-1 bg-allgood-primary mb-6"></div>
                                <p class="text-lg text-gray-600 mb-8 font-body leading-relaxed">
                                    If you aren't paying for the product, <strong>you</strong> are the product.
                                    <br>Today, we audit the algorithm.
                                </p>
                                <button onclick="window.nextPage()" class="bg-allgood-primary text-white px-8 py-3 rounded-lg font-bold shadow-lg hover:bg-allgood-hover transition transform hover:scale-105 flex items-center">
                                    Boot Up Algorithm <i data-lucide="power" class="ml-2 w-4 h-4"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Page 2: Mission Briefing -->
                        <div class="page" id="page-2">
                            <div class="max-w-3xl mx-auto pt-4 px-6">
                                <h2 class="text-2xl font-heading font-bold text-allgood-dark mb-2">Mission Briefing</h2>
                                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                                    <div class="flex justify-between items-end mb-4 border-b pb-2">
                                        <div><p class="text-xs text-gray-500 uppercase">Role</p><p class="font-bold text-lg">Algorithm Engineer</p></div>
                                        <div class="text-right"><p class="text-xs text-gray-500 uppercase">Target Metric</p><p class="font-bold text-lg text-allgood-primary">Time On Site</p></div>
                                    </div>
                                    <div class="bg-gray-100 rounded p-4 mb-4">
                                        <p class="font-body text-sm text-gray-700 mb-2"><strong>The Boss:</strong> "Numbers are down. We need a 12% lift in engagement by Q4. I don't care how you do itâ€”tweak the ranking weights. Just keep them scrolling."</p>
                                    </div>
                                    <div class="relative pt-6">
                                        <div class="flex justify-between text-xs font-bold mb-1"><span>Current: 42 mins/day</span><span class="text-allgood-primary">Target: 47 mins/day</span></div>
                                        <div class="h-4 bg-gray-200 rounded-full overflow-hidden"><div class="h-full bg-allgood-secondary w-3/4"></div></div>
                                        <div class="absolute top-4 right-[10%] w-0.5 h-8 bg-red-500"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Page 3: Rage Math -->
                        <div class="page" id="page-3">
                            <div class="max-w-3xl mx-auto pt-4 px-6">
                                <h2 class="text-2xl font-heading font-bold text-allgood-dark mb-4">The Engagement Multiplier</h2>
                                <div class="grid md:grid-cols-2 gap-8">
                                    <div class="space-y-6 slider-group bg-white p-6 rounded-lg shadow-sm">
                                        <div><label class="flex justify-between text-sm font-bold mb-2"><span>Agreement / Peace</span> <span id="val-peace">1</span></label><input type="range" class="w-full" min="1" max="10" value="1" oninput="updateRageMath()" id="input-peace"></div>
                                        <div><label class="flex justify-between text-sm font-bold mb-2"><span>Novelty / Humor</span> <span id="val-novelty">1</span></label><input type="range" class="w-full" min="1" max="10" value="1" oninput="updateRageMath()" id="input-novelty"></div>
                                        <div><label class="flex justify-between text-sm font-bold text-allgood-primary mb-2"><span>Fear / Anxiety</span> <span id="val-fear">1</span></label><input type="range" class="w-full" min="1" max="10" value="1" oninput="updateRageMath()" id="input-fear"></div>
                                        <div><label class="flex justify-between text-sm font-bold text-allgood-primary mb-2"><span>Anger / Outrage</span> <span id="val-anger">1</span></label><input type="range" class="w-full" min="1" max="10" value="1" oninput="updateRageMath()" id="input-anger"></div>
                                    </div>
                                    <div class="flex flex-col justify-center bg-gray-900 text-white p-6 rounded-lg shadow-inner">
                                        <h3 class="text-sm uppercase tracking-widest text-gray-400 mb-4">Live Projection</h3>
                                        <div class="mb-6"><div class="text-4xl font-bold mb-1" id="score-engagement">1.0x</div><div class="text-xs text-gray-400">Viral Velocity</div></div>
                                        <div class="mb-2"><div class="text-2xl font-bold mb-1" id="score-friction" style="color: #4ade80;">Low</div><div class="text-xs text-gray-400">Social Friction (Harm)</div></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Page 4: Fork -->
                        <div class="page" id="page-4">
                            <div class="max-w-3xl mx-auto pt-4 text-center px-6">
                                <h2 class="text-2xl font-heading font-bold text-allgood-dark mb-6">Choose Your Code Path</h2>
                                <div class="grid md:grid-cols-3 gap-4">
                                    <button onclick="selectPath('profit')" class="p-6 bg-white border-2 border-transparent hover:border-allgood-primary rounded-lg shadow-sm hover:shadow-md transition group">
                                        <i data-lucide="trending-up" class="w-10 h-10 text-allgood-primary mx-auto mb-4"></i><h3 class="font-bold mb-2">Maximize KPI</h3><p class="text-xs text-gray-500">Prioritize growth. Boost whatever keeps them clicking.</p>
                                    </button>
                                    <button onclick="selectPath('balance')" class="p-6 bg-white border-2 border-transparent hover:border-allgood-secondary rounded-lg shadow-sm hover:shadow-md transition group">
                                        <i data-lucide="scale" class="w-10 h-10 text-allgood-secondary mx-auto mb-4"></i><h3 class="font-bold mb-2">Balanced Mix</h3><p class="text-xs text-gray-500">Mix healthy content with some viral spikes.</p>
                                    </button>
                                    <button onclick="selectPath('ethics')" class="p-6 bg-white border-2 border-transparent hover:border-green-600 rounded-lg shadow-sm hover:shadow-md transition group">
                                        <i data-lucide="shield-check" class="w-10 h-10 text-green-600 mx-auto mb-4"></i><h3 class="font-bold mb-2">Well-being Bias</h3><p class="text-xs text-gray-500">Suppress rage bait. Accept that metrics might drop.</p>
                                    </button>
                                </div>
                                <div id="path-feedback" class="mt-8 text-sm font-bold text-gray-700 min-h-[40px]"></div>
                            </div>
                        </div>

                        <!-- Page 5: Feed 1 -->
                        <div class="page" id="page-5">
                            <div class="max-w-xl mx-auto pt-2 px-4">
                                <h2 class="text-xl font-heading font-bold text-allgood-dark mb-2">Drill: Spot the Bait</h2>
                                <div class="bg-gray-100 p-3 rounded-t-lg border-b flex justify-between items-center"><span class="text-xs font-bold text-gray-500">FEED PREVIEW</span><span class="text-xs bg-white px-2 py-1 rounded border">Filter: OFF</span></div>
                                <div id="feed-1" class="feed-scroll shadow-inner"></div>
                                <div class="mt-2 text-center text-xs text-gray-500">Click a post to "Stop the Scroll"</div>
                            </div>
                        </div>

                        <!-- Page 6: Trade Off -->
                        <div class="page" id="page-6">
                            <div class="max-w-3xl mx-auto pt-6 text-center px-6">
                                <h2 class="text-2xl font-heading font-bold text-allgood-dark mb-6">The Trade-Off</h2>
                                <div class="flex justify-center items-end gap-8 h-64 mb-6">
                                    <div class="w-24 bg-allgood-primary rounded-t-lg relative group h-3/4"><div class="absolute -top-8 w-full text-center font-bold text-allgood-primary">+14%</div><div class="absolute bottom-4 w-full text-center text-white text-sm font-bold">Revenue</div></div>
                                    <div class="w-24 bg-gray-400 rounded-t-lg relative group h-1/4"><div class="absolute -top-8 w-full text-center font-bold text-gray-600">-30%</div><div class="absolute bottom-4 w-full text-center text-white text-sm font-bold">Trust</div></div>
                                </div>
                                <p class="max-w-md mx-auto text-gray-600 font-body">Outrage is a short-term rocket fuel. It burns bright and fast, but it destroys the engine (community trust) over time.</p>
                            </div>
                        </div>

                        <!-- Page 7: Feed 2 -->
                        <div class="page" id="page-7">
                            <div class="max-w-xl mx-auto pt-2 px-4">
                                <h2 class="text-xl font-heading font-bold text-allgood-dark mb-2">Drill: Subtle Triggers</h2>
                                <div class="bg-gray-100 p-3 rounded-t-lg border-b flex justify-between items-center"><span class="text-xs font-bold text-gray-500">FEED PREVIEW</span><span class="text-xs bg-white px-2 py-1 rounded border">Difficulty: HARD</span></div>
                                <div id="feed-2" class="feed-scroll shadow-inner"></div>
                            </div>
                        </div>

                        <!-- Page 8: Guardrails -->
                        <div class="page" id="page-8">
                            <div class="max-w-3xl mx-auto pt-4 px-6">
                                <h2 class="text-2xl font-heading font-bold text-allgood-dark mb-6">System Guardrails</h2>
                                <div class="space-y-4">
                                    <div class="flex items-center justify-between bg-white p-4 rounded shadow-sm border">
                                        <div><h4 class="font-bold">Friction Delay</h4><p class="text-xs text-gray-500">Ask "Are you sure?" before sharing angry content.</p></div>
                                        <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" class="sr-only peer" onchange="toggleGuardrail(this)"><div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-allgood-secondary"></div></label>
                                    </div>
                                    <div class="flex items-center justify-between bg-white p-4 rounded shadow-sm border">
                                        <div><h4 class="font-bold">Diversify Feed</h4><p class="text-xs text-gray-500">Force mix of sources outside user's echo bubble.</p></div>
                                        <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" class="sr-only peer" onchange="toggleGuardrail(this)"><div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-allgood-secondary"></div></label>
                                    </div>
                                </div>
                                <div id="guardrail-feedback" class="mt-6 text-center text-sm text-allgood-primary font-bold opacity-0 transition">Guardrails Active. Engagement slowing, health rising.</div>
                            </div>
                        </div>

                        <!-- Page 9: Heuristic -->
                        <div class="page" id="page-9">
                            <div class="max-w-3xl mx-auto pt-4 px-6">
                                <h2 class="text-2xl font-heading font-bold text-allgood-dark mb-4">Build Your Filter</h2>
                                <div class="grid grid-cols-2 gap-3 mb-6">
                                    <button onclick="toggleHeuristic(this)" class="heuristic-btn p-3 border rounded text-sm hover:bg-gray-50 text-left">ðŸš© "You won't believe..."</button>
                                    <button onclick="toggleHeuristic(this)" class="heuristic-btn p-3 border rounded text-sm hover:bg-gray-50 text-left">ðŸš© ALL CAPS HEADLINES</button>
                                    <button onclick="toggleHeuristic(this)" class="heuristic-btn p-3 border rounded text-sm hover:bg-gray-50 text-left">ðŸš© "They" want to destroy...</button>
                                    <button onclick="toggleHeuristic(this)" class="heuristic-btn p-3 border rounded text-sm hover:bg-gray-50 text-left">ðŸš© Immediate fear response</button>
                                </div>
                                <div class="bg-allgood-secondary text-white p-4 rounded-lg shadow-md">
                                    <h4 class="font-bold border-b border-white/30 pb-2 mb-2">My Rule:</h4>
                                    <p class="font-heading italic">"If I see [ <span id="heuristic-display">...</span> ], I will pause and disengage."</p>
                                </div>
                            </div>
                        </div>

                        <!-- Page 10: Calculator -->
                        <div class="page" id="page-10">
                            <div class="max-w-lg mx-auto pt-6 text-center px-6">
                                <h2 class="text-2xl font-heading font-bold text-allgood-dark mb-6">The Cost of Scrolling</h2>
                                <div class="bg-white p-8 rounded-xl shadow-lg border border-gray-200">
                                    <label class="block text-gray-600 text-sm font-bold mb-2">Minutes spent scrolling per day?</label>
                                    <input type="number" id="scroll-mins" class="w-full text-center text-3xl font-bold border-b-2 border-allgood-primary outline-none py-2 mb-6" placeholder="0" oninput="calcCost()">
                                    <div class="grid grid-cols-2 gap-4 text-left">
                                        <div class="bg-gray-50 p-3 rounded"><div class="text-xs text-gray-500 uppercase">Hours / Year</div><div class="text-xl font-bold text-allgood-dark" id="res-hours">0</div></div>
                                        <div class="bg-gray-50 p-3 rounded"><div class="text-xs text-gray-500 uppercase">Days / Year</div><div class="text-xl font-bold text-allgood-primary" id="res-days">0</div></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Page 11: Stance -->
                        <div class="page" id="page-11">
                            <div class="max-w-3xl mx-auto pt-6 text-center px-6">
                                <h2 class="text-2xl font-heading font-bold text-allgood-dark mb-4">The Engineer's Dilemma</h2>
                                <div class="flex flex-col gap-4">
                                    <button onclick="finalDecision(1)" class="w-full p-4 bg-white border hover:border-allgood-primary rounded shadow-sm text-left flex items-center transition">
                                        <div class="bg-gray-100 p-2 rounded mr-4"><i data-lucide="zap" class="w-5 h-5 text-gray-600"></i></div><div><span class="font-bold block">Keep the Rage Loop</span><span class="text-xs text-gray-500">Maximize revenue. Ignore the social cost.</span></div>
                                    </button>
                                    <button onclick="finalDecision(2)" class="w-full p-4 bg-white border hover:border-allgood-primary rounded shadow-sm text-left flex items-center transition">
                                        <div class="bg-gray-100 p-2 rounded mr-4"><i data-lucide="git-merge" class="w-5 h-5 text-gray-600"></i></div><div><span class="font-bold block">Transparent Trade-offs</span><span class="text-xs text-gray-500">Admit growth will slow, but retention will stabilize.</span></div>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Page 12: Feed 3 -->
                        <div class="page" id="page-12">
                            <div class="max-w-xl mx-auto pt-2 px-4">
                                <h2 class="text-xl font-heading font-bold text-allgood-dark mb-2">Final Exam</h2>
                                <div class="bg-gray-100 p-3 rounded-t-lg border-b flex justify-between items-center"><span class="text-xs font-bold text-gray-500">LIVE FEED</span><span class="text-xs bg-allgood-primary text-white px-2 py-1 rounded font-bold">Apply Heuristic</span></div>
                                <div id="feed-3" class="feed-scroll shadow-inner"></div>
                            </div>
                        </div>

                        <!-- Page 13: Reflection -->
                        <div class="page" id="page-13">
                            <div class="max-w-2xl mx-auto pt-8 px-6">
                                <h2 class="text-2xl font-heading font-bold text-allgood-dark mb-4">Real World Spotting</h2>
                                <div class="bg-white p-6 rounded-lg shadow-lg">
                                    <p class="font-body text-gray-700 mb-4">Think about your actual social feeds (TikTok, Instagram, YouTube). Can you name one specific type of post that always tries to make you angry?</p>
                                    <textarea class="w-full h-32 p-3 border border-gray-300 rounded focus:border-allgood-primary outline-none resize-none bg-gray-50" placeholder="e.g., Political memes, comments on sports videos..."></textarea>
                                    <div class="mt-4 flex justify-end">
                                        <span class="text-xs text-green-600 font-bold flex items-center opacity-0 transition" id="reflect-saved"><i data-lucide="check" class="w-3 h-3 mr-1"></i> Saved</span>
                                        <button onclick="document.getElementById('reflect-saved').classList.remove('opacity-0')" class="bg-allgood-secondary text-white px-4 py-2 rounded text-sm font-bold ml-4">Save Reflection</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Page 14: Quiz -->
                        <div class="page" id="page-14">
                            <div class="max-w-2xl mx-auto pt-6 px-6">
                                <h2 class="text-2xl font-heading font-bold text-allgood-dark mb-6 text-center">Certification Check</h2>
                                <div class="space-y-4">
                                    <div class="bg-white p-4 rounded border cursor-pointer hover:bg-blue-50" onclick="checkQuiz(this, false)"><p class="font-bold text-sm">1. Platforms maximize "Truth" above all else.</p></div>
                                    <div class="bg-white p-4 rounded border cursor-pointer hover:bg-blue-50" onclick="checkQuiz(this, true)"><p class="font-bold text-sm">2. Anger generates more engagement than agreement.</p></div>
                                    <div class="bg-white p-4 rounded border cursor-pointer hover:bg-blue-50" onclick="checkQuiz(this, false)"><p class="font-bold text-sm">3. The algorithm is neutral and has no bias.</p></div>
                                </div>
                                <div id="quiz-feedback" class="text-center mt-6 font-bold h-6"></div>
                            </div>
                        </div>

                        <!-- Page 15: Badge -->
                        <div class="page" id="page-15">
                            <div class="flex flex-col items-center justify-center h-full text-center px-6">
                                <div id="badge-display" class="w-64 h-64 mb-6 transition-transform hover:scale-105 cursor-pointer"></div>
                                <h2 class="text-3xl font-heading font-bold text-allgood-dark mb-2">Pattern Recognized</h2>
                                <p class="text-gray-600 mb-8">You have successfully audited the Rage Revenue Model.</p>
                                <button class="bg-allgood-primary text-white px-8 py-3 rounded-full font-bold shadow-lg flex items-center hover:bg-allgood-hover transition">
                                    <i data-lucide="download" class="mr-2 w-4 h-4"></i> Download Badge
                                </button>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Footer -->
                <footer class="footer-content flex items-center justify-between px-6 border-t border-gray-200 bg-white z-20 relative shrink-0">
                    <div id="flex-progress-bar" class="absolute top-0 left-0 h-1 bg-gray-200 w-full"><div id="flex-progress-fill" class="h-full bg-allgood-primary w-0 transition-all duration-300"></div></div>
                    <button id="prev-btn" class="text-allgood-primary hover:text-allgood-dark font-bold text-sm flex items-center transition-colors disabled:opacity-30 disabled:cursor-not-allowed font-body" disabled>
                        <i data-lucide="chevron-left" class="w-4 h-4 mr-1"></i>Back
                    </button>
                    <p class="text-gray-400 text-[10px] hidden sm:block font-body">&copy; <a href="https://www.allgoodacademy.com" target="_blank" class="hover:text-allgood-primary transition-colors font-bold">Allgood Academy</a> <span id="current-year"></span></p>
                    <button id="next-btn" class="bg-allgood-primary hover:bg-allgood-hover text-white px-6 py-2 rounded-full text-sm font-bold shadow-md transition-transform transform hover:scale-105 flex items-center disabled:opacity-50 disabled:cursor-not-allowed font-body">
                        <span>Next</span><i data-lucide="chevron-right" class="w-4 h-4 ml-1"></i>
                    </button>
                </footer>

                <!-- Login Modal -->
                <div id="login-modal" class="absolute inset-0 z-[200] bg-allgood-dark/95 flex items-center justify-center p-6 hidden-modal modal-transition">
                    <div class="bg-white rounded-lg shadow-2xl p-8 max-w-sm w-full text-center border-t-4 border-allgood-primary">
                        <div class="mb-6"><h2 class="text-3xl font-heading font-bold text-allgood-dark">Allgood<span class="text-allgood-primary">Academy</span></h2></div>
                        <h2 class="text-xl font-bold text-allgood-dark mb-2 font-heading">Welcome</h2>
                        <div class="flex items-center justify-center gap-2 mb-6 relative">
                            <p class="text-gray-500 text-sm font-body">Please sign in to start.</p>
                            <button id="policy-trigger" class="group relative flex items-center text-allgood-primary hover:text-allgood-hover transition-colors focus:outline-none">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                                <span class="text-xs font-bold underline decoration-dotted underline-offset-2">Why?</span>
                                <div class="absolute top-full left-1/2 transform -translate-x-1/2 mt-3 w-64 p-3 bg-gray-800 text-white text-xs text-left rounded shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible group-focus:opacity-100 group-focus:visible transition-all duration-200 z-50 font-body leading-relaxed border border-gray-700 pointer-events-none">
                                    <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-b-gray-800"></div>
                                    <strong class="block text-allgood-primary mb-1 uppercase tracking-wide text-[10px]">Why do we ask?</strong>
                                    <p class="mb-2 text-gray-300">We use your name to personalize your badge. Performance data is logged in real-time to improve the GoodBlock experience. All personal data is kept confidential and never sold.</p>
                                    <div class="border-t border-gray-700 my-1 pt-1"></div>
                                    <p class="text-gray-300"><strong>Email (Optional):</strong> Enter to join the Allgood Academy community.</p>
                                </div>
                            </button>
                        </div>
                        <input type="text" id="user-name-input" placeholder="Your Name (Optional)" class="w-full border border-gray-300 rounded p-3 mb-3 focus:ring-2 focus:ring-allgood-primary focus:border-transparent outline-none transition-all font-body">
                        <input type="email" id="user-email-input" placeholder="Your Email (Optional)" class="w-full border border-gray-300 rounded p-3 mb-6 focus:ring-2 focus:ring-allgood-primary focus:border-transparent outline-none transition-all font-body">
                        <button id="btn-guest-login" onclick="window.handleGuestLogin()" class="w-full bg-allgood-primary hover:bg-allgood-hover text-white font-bold py-3 rounded shadow-md transition-transform transform hover:scale-[1.02] active:scale-[0.98] font-body uppercase">Start Mission</button>
                        <div class="mt-4 flex items-center justify-center space-x-2"><div class="h-px w-10 bg-gray-200"></div><p class="text-xs text-gray-500 uppercase font-bold">OR</p><div class="h-px w-10 bg-gray-200"></div></div>
                        <button id="google-icon-container" onclick="window.handleGoogleLogin()" class="mt-4 p-2 rounded-full border border-gray-300 shadow-md hover:shadow-lg transition-all duration-200 hover:scale-105 active:scale-95 bg-white flex items-center justify-center mx-auto">
                            <svg class="w-6 h-6" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                        </button>
                    </div>
                </div>

                <!-- 4. Menu Modal (Added for Menu Button) -->
                <div id="menu-modal" class="hidden-modal absolute inset-0 z-[100] bg-black/60 flex justify-end modal-transition">
                    <div class="w-72 h-full bg-white shadow-xl flex flex-col border-l border-gray-200">
                        <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                            <span class="font-bold text-allgood-dark font-heading">Mission Log</span>
                            <button id="close-menu" class="text-gray-500"><i data-lucide="x" class="w-6 h-6"></i></button>
                        </div>
                        <div class="p-2 overflow-y-auto flex-grow space-y-1 text-sm font-body">
                            <button class="menu-link w-full text-left px-4 py-2 hover:bg-gray-100 text-gray-600 font-bold" onclick="window.goToPage(0)">1. Cover</button>
                            <button class="menu-link w-full text-left px-4 py-2 hover:bg-gray-100 text-gray-600" onclick="window.goToPage(1)">2. Mission Briefing</button>
                            <button class="menu-link w-full text-left px-4 py-2 hover:bg-gray-100 text-gray-600" onclick="window.goToPage(2)">3. The Engagement Multiplier</button>
                            <button class="menu-link w-full text-left px-4 py-2 hover:bg-gray-100 text-gray-600" onclick="window.goToPage(3)">4. Choose Your Code Path</button>
                            <button class="menu-link w-full text-left px-4 py-2 hover:bg-gray-100 text-gray-600" onclick="window.goToPage(4)">5. Drill: Spot the Bait</button>
                            <button class="menu-link w-full text-left px-4 py-2 hover:bg-gray-100 text-gray-600" onclick="window.goToPage(5)">6. The Trade-Off</button>
                            <button class="menu-link w-full text-left px-4 py-2 hover:bg-gray-100 text-gray-600" onclick="window.goToPage(6)">7. Drill: Subtle Triggers</button>
                            <button class="menu-link w-full text-left px-4 py-2 hover:bg-gray-100 text-gray-600" onclick="window.goToPage(7)">8. System Guardrails</button>
                            <button class="menu-link w-full text-left px-4 py-2 hover:bg-gray-100 text-gray-600" onclick="window.goToPage(8)">9. Build Your Filter</button>
                            <button class="menu-link w-full text-left px-4 py-2 hover:bg-gray-100 text-gray-600" onclick="window.goToPage(9)">10. The Cost of Scrolling</button>
                            <button class="menu-link w-full text-left px-4 py-2 hover:bg-gray-100 text-gray-600" onclick="window.goToPage(10)">11. The Engineer's Dilemma</button>
                            <button class="menu-link w-full text-left px-4 py-2 hover:bg-gray-100 text-gray-600" onclick="window.goToPage(11)">12. Final Exam</button>
                            <button class="menu-link w-full text-left px-4 py-2 hover:bg-gray-100 text-gray-600" onclick="window.goToPage(12)">13. Real World Spotting</button>
                            <button class="menu-link w-full text-left px-4 py-2 hover:bg-gray-100 text-gray-600" onclick="window.goToPage(13)">14. Certification Check</button>
                            <button class="menu-link w-full text-left px-4 py-2 hover:bg-gray-100 text-gray-600 font-bold text-allgood-secondary" onclick="window.goToPage(14)">15. Pattern Recognized</button>
                        </div>
                    </div>
                </div>

                <!-- 5. System Menu Modal -->
                <div id="system-menu-modal" class="hidden-modal absolute inset-0 z-[250] bg-black/80 flex items-center justify-center p-6 modal-transition backdrop-blur-sm">
                    <div class="bg-white rounded-lg shadow-2xl p-8 max-w-sm w-full text-center border-t-4 border-gray-500">
                        <div class="mb-4">
                            <i data-lucide="settings" class="w-12 h-12 mx-auto text-gray-400"></i>
                        </div>
                        <h2 class="text-xl font-heading font-bold text-allgood-dark mb-2">System Menu</h2>
                        <p class="text-sm text-gray-500 mb-6 font-body">Select an option to proceed.</p>
                        
                        <div class="space-y-3">
                            <!-- UPDATED: Changed Reset to Log Out -->
                            <button onclick="window.handleLogOut()" class="w-full bg-red-50 hover:bg-red-100 text-red-600 font-bold py-3 rounded border border-red-200 shadow-sm transition-colors flex items-center justify-center">
                                <i data-lucide="log-out" class="w-4 h-4 mr-2"></i> Log Out
                            </button>
                            <button onclick="window.handleSystemExit()" class="w-full bg-gray-100 hover:bg-gray-200 text-allgood-dark font-bold py-3 rounded border border-gray-300 shadow-sm transition-colors flex items-center justify-center">
                                <i data-lucide="external-link" class="w-4 h-4 mr-2"></i> Exit to Dashboard
                            </button>
                            <button onclick="window.closeSystemMenu()" class="w-full text-gray-400 hover:text-gray-600 font-bold py-2 text-sm mt-2">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <script>
        // --- LOGIC ---
        const totalPages = 15;
        let currentPage = 0;

        // --- AUDIO ENGINE (RESTORED FROM TEMPLATE) ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx;

        function initAudio() {
            if (!audioCtx) audioCtx = new AudioContext();
            if (audioCtx.state === 'suspended') audioCtx.resume().catch(e => console.error("Audio resume failed:", e));
        }

        function playTone(freq, type, duration, vol = 0.1, attack = 0.01, decay = 0.001) {
            initAudio();    
            const now = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, now);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(vol, now + attack);   
            gain.gain.exponentialRampToValueAtTime(decay, now + duration);  
            osc.start(now);
            osc.stop(now + duration);
        }

        const sfx = {
            powerOn: () => {
                initAudio();
                const now = audioCtx.currentTime;
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(110, now);
                osc.frequency.exponentialRampToValueAtTime(220, now + 0.4);
                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(0.4, now + 0.1);
                gain.gain.linearRampToValueAtTime(0, now + 0.4);
                osc.start(now); osc.stop(now + 0.4);
            },
            powerOff: () => { initAudio(); playTone(80, 'triangle', 0.2, 0.5, 0.01, 0.001); },
            nav: () => { initAudio(); playTone(150, 'sine', 0.1, 0.1, 0.01, 0.01); },
            tick: () => { initAudio(); playTone(1000, 'sine', 0.01, 0.01); },
            success: () => { playTone(400, 'sine', 0.1); setTimeout(() => playTone(600, 'sine', 0.2), 100); },
            error: () => playTone(150, 'sawtooth', 0.3)
        };
        window.sfx = sfx;
        window.initAudio = initAudio;

        // JODI ENGINE
        const jodiStates = {
            neutral: { eye: 'ry="3"', mouth: 'd="M35 55 Q50 60 65 55"' },
            happy: { eye: 'ry="5"', mouth: 'd="M35 55 Q50 65 65 55"' },
            concerned: { eye: 'ry="2"', mouth: 'd="M35 60 Q50 55 65 60"' },
            thinking: { eye: 'ry="3"', mouth: 'd="M40 60 L60 60"' }
        };
        const jodiScript = [
            { text: "Welcome to the Schoolhouse. Today weâ€™ll uncover how platforms profit from outrage.", mood: 'neutral' }, 
            { text: "Your mission is simple: Increase 'Time on Site'. Your job depends on it.", mood: 'concerned' }, 
            { text: "Try sliding 'Anger' up. Notice how engagement spikes? That is the hidden math.", mood: 'thinking' }, 
            { text: "What would you do? Chase the growth, or protect the user?", mood: 'concerned' }, 
            { text: "Scroll the feed. Click any post that feels like 'Bait' to stop the scroll.", mood: 'neutral' }, 
            { text: "Profits rise, but trust falls. It's a dangerous game.", mood: 'concerned' }, 
            { text: "Triggers can be subtle. Look for 'Us vs Them' language.", mood: 'thinking' }, 
            { text: "Guardrails slow down the rage, but they build long-term trust.", mood: 'happy' }, 
            { text: "Build your personal rule. What signals will make YOU pause?", mood: 'neutral' }, 
            { text: "Look at those hours. Imagine what else you could build with that time.", mood: 'concerned' }, 
            { text: "Integrity under pressure matters. Good choice.", mood: 'happy' }, 
            { text: "Final drill. Apply your new filter. You've got this.", mood: 'happy' }, 
            { text: "Awareness is the first step. Once you see the pattern, you can break it.", mood: 'happy' }, 
            { text: "Let's prove what you know.", mood: 'neutral' }, 
            { text: "You've earned this. Carry this skill into your real digital life.", mood: 'happy' }
        ];

        function renderJodi(stateKey) {
            const st = jodiStates[stateKey] || jodiStates.neutral;
            document.getElementById('jodi-avatar-svg').innerHTML = `
            <svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-lg">
                <circle cx="50" cy="50" r="45" fill="#fff" stroke="#357889" stroke-width="3"/>
                <path d="M20 50 Q50 90 80 50" fill="#f0f0f0" opacity="0.2"/>
                <path d="M15 40 Q50 -10 85 40" fill="#357889" />
                <ellipse cx="35" cy="45" rx="5" ${st.eye} fill="#333"/>
                <ellipse cx="65" cy="45" rx="5" ${st.eye} fill="#333"/>
                <path ${st.mouth} fill="none" stroke="#333" stroke-width="3" stroke-linecap="round"/>
                <circle cx="35" cy="45" r="12" fill="none" stroke="#D34716" stroke-width="2"/>
                <circle cx="65" cy="45" r="12" fill="none" stroke="#D34716" stroke-width="2"/>
                <line x1="47" y1="45" x2="53" y2="45" stroke="#D34716" stroke-width="2"/>
            </svg>`;
        }

        // NAV
        window.updatePage = function() {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(`page-${currentPage + 1}`).classList.add('active');
            document.getElementById('header-page-indicator').textContent = `${currentPage + 1} / ${totalPages}`;
            document.getElementById('flex-progress-fill').style.width = `${((currentPage + 1) / totalPages) * 100}%`;
            
            // RESET SCROLL on content column
            const scroller = document.getElementById('content-column');
            if(scroller) scroller.scrollTop = 0;

            document.getElementById('prev-btn').disabled = currentPage === 0;
            if(currentPage === totalPages - 1) document.getElementById('next-btn').style.display = 'none';
            else document.getElementById('next-btn').style.display = 'flex';

            const script = jodiScript[currentPage];
            if(script) {
                const bubble = document.getElementById('jodi-bubble');
                bubble.classList.remove('visible');
                setTimeout(() => {
                    bubble.textContent = script.text;
                    bubble.classList.add('visible');
                    renderJodi(script.mood);
                }, 300);
            }

            if(currentPage === 4) renderFeed(1);
            if(currentPage === 6) renderFeed(2);
            if(currentPage === 11) renderFeed(3);
            if(currentPage === 14) generateBadge();
            
            if(window.lucide) window.lucide.createIcons();
        }

        window.nextPage = () => { if(currentPage < totalPages - 1) { currentPage++; updatePage(); if(window.sfx && window.sfx.nav) window.sfx.nav(); } };
        document.getElementById('next-btn').addEventListener('click', window.nextPage);
        document.getElementById('prev-btn').addEventListener('click', () => { if(currentPage > 0) { currentPage--; updatePage(); if(window.sfx && window.sfx.nav) window.sfx.nav(); } });

        // Go To Page (For Menu)
        window.goToPage = function(index) {
            currentPage = index;
            window.updatePage();
            document.getElementById('menu-modal').classList.add('hidden-modal');
            document.getElementById('menu-modal').classList.remove('visible-modal');
            if(window.sfx) window.sfx.nav();
        }

        // RAGE MATH
        window.updateRageMath = () => {
            const p = parseInt(document.getElementById('input-peace').value), n = parseInt(document.getElementById('input-novelty').value);
            const f = parseInt(document.getElementById('input-fear').value), a = parseInt(document.getElementById('input-anger').value);
            const score = ((p * 0.5) + (n * 1.2) + (f * 2.5) + (a * 3.0)) / 10;
            const friction = (f + a);
            document.getElementById('score-engagement').textContent = score.toFixed(1) + "x";
            const fel = document.getElementById('score-friction');
            if (friction < 8) { fel.textContent = "Low"; fel.style.color = "#4ade80"; }
            else if (friction < 14) { fel.textContent = "Moderate"; fel.style.color = "#facc15"; }
            else { fel.textContent = "CRITICAL"; fel.style.color = "#ef4444"; }
        }

        // FEED
        const feedData = {
            1: [{t:"10 Reasons to Hate Your Neighbor!",type:'bait'},{t:"Local cat rescued.",type:'safe'},{t:"They are stealing your lawnmower!",type:'bait'},{t:"Apple pie recipe.",type:'safe'}],
            2: [{t:"Why the other side hates freedom.",type:'bait'},{t:"Bridge project analysis.",type:'safe'},{t:"If you don't share, you are the problem.",type:'bait'},{t:"Charity sale.",type:'safe'}],
            3: [{t:"URGENT: Democracy ending.",type:'bait'},{t:"New park opening.",type:'safe'},{t:"Look at this idiot in traffic...",type:'bait'}]
        };
        window.renderFeed = (level) => {
            const c = document.getElementById(level === 1 ? 'feed-1' : level === 2 ? 'feed-2' : 'feed-3');
            c.innerHTML = '';
            feedData[level].forEach(p => {
                const d = document.createElement('div');
                d.className = `feed-item ${p.type}`;
                d.innerHTML = `<div class="font-bold text-sm text-gray-800 mb-1">User123</div><div class="text-sm text-gray-600">${p.t}</div>`;
                d.onclick = function() {
                    if(p.type === 'bait') { this.style.backgroundColor = '#ffe4e6'; this.innerHTML += '<div class="text-xs font-bold text-red-600 mt-2">ðŸš« SCROLL STOPPED</div>'; renderJodi('encouraging'); window.sfx.success(); }
                    else { this.style.backgroundColor = '#dcfce7'; this.innerHTML += '<div class="text-xs font-bold text-green-600 mt-2">âœ… Safe.</div>'; renderJodi('neutral'); }
                };
                c.appendChild(d);
            });
        }

        window.selectPath = (p) => {
            const el = document.getElementById('path-feedback');
            if(p==='profit'){el.textContent="Engagement +20%, Trust -10%. Toxic comments."; el.className="mt-8 text-sm font-bold text-red-600"; renderJodi('concerned');}
            else if(p==='ethics'){el.textContent="Engagement -5%. Community calm."; el.className="mt-8 text-sm font-bold text-green-600"; renderJodi('happy');}
            else {el.textContent="Engagement +5%. Safe middle ground."; el.className="mt-8 text-sm font-bold text-allgood-secondary"; renderJodi('neutral');}
        }

        window.toggleHeuristic = (b) => { b.classList.toggle('bg-blue-50'); b.classList.toggle('border-allgood-primary'); document.getElementById('heuristic-display').textContent="BAIT / FEAR"; renderJodi('happy'); }
        
        window.calcCost = () => {
            const m = document.getElementById('scroll-mins').value;
            document.getElementById('res-hours').textContent = Math.round((m*365)/60);
            document.getElementById('res-days').textContent = ((m*365)/60/24).toFixed(1);
        }

        window.finalDecision = () => { renderJodi('encouraging'); document.getElementById('page-11').querySelector('h2').textContent="Decision Recorded."; window.sfx.success(); }

        window.checkQuiz = (el, c) => {
            if(c) { el.classList.add('bg-green-100'); document.getElementById('quiz-feedback').textContent="Correct."; document.getElementById('quiz-feedback').className="text-center mt-6 font-bold h-6 text-green-600"; renderJodi('happy'); window.sfx.success(); }
            else { el.classList.add('bg-red-50'); document.getElementById('quiz-feedback').textContent="Incorrect."; document.getElementById('quiz-feedback').className="text-center mt-6 font-bold h-6 text-red-500"; }
        }

        window.generateBadge = () => {
            const svg = `<svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg"><circle cx="100" cy="100" r="90" fill="#357889" stroke="#D34716" stroke-width="5"/><path d="M70 100 L90 120 L130 80" fill="none" stroke="#fff" stroke-width="12" stroke-linecap="round"/><text x="100" y="150" font-family="Verdana" font-weight="bold" font-size="14" fill="#fff" text-anchor="middle">INTERCEPTOR</text></svg>`;
            document.getElementById('badge-display').innerHTML = svg;
            window.logModuleCompletion(svg);
        }

        window.toggleGuardrail = (el) => {
            if(el.checked) document.getElementById('guardrail-feedback').classList.remove('opacity-0');
        }

        // --- SYSTEM MENU FUNCTIONS ---
        window.closeSystemMenu = () => {
             document.getElementById('system-menu-modal').classList.add('hidden-modal');
             document.getElementById('system-menu-modal').classList.remove('visible-modal');
        };

        window.handleLogOut = async () => {
            if (window.authSignOut) await window.authSignOut();
            window.currentUser = null;
            window.currentUserName = "Learner";
            window.closeSystemMenu();
            const startup = document.getElementById('startup-screen');
            startup.style.display = 'flex';
            setTimeout(() => startup.style.opacity = '1', 10);
            currentPage = 0;
            window.updatePage();
            window.sfx.powerOff();
        };

        window.handleSystemExit = () => {
            window.location.href = "https://www.allgoodacademy.com";
        };

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            if(window.lucide) window.lucide.createIcons();
            const startup = document.getElementById('startup-screen');
            const loginModal = document.getElementById('login-modal');

            if(startup) {
                const warmUp = () => window.initAudio();
                startup.addEventListener('mousedown', warmUp, { once: true });
                startup.addEventListener('touchstart', warmUp, { once: true });
                
                startup.addEventListener('click', () => {
                    window.sfx.powerOn();
                    startup.style.opacity = '0';
                    startup.style.pointerEvents = 'none';
                    
                    setTimeout(() => {
                        if(window.currentUser) {
                            // Already logged in
                        } else {
                            loginModal.classList.remove('hidden-modal');
                            loginModal.classList.add('visible-modal');
                        }
                    }, 800);
                });
            }
            
            // --- CONTROL CLUSTER LOGIC (RESTORED) ---
            
            // Blueprint Toggle
            const blueprintToggle = document.getElementById('blueprint-toggle');
            if(blueprintToggle) blueprintToggle.addEventListener('click', () => {
                document.body.classList.toggle('blueprint-mode');
                // Toggle icon color for feedback
                blueprintToggle.classList.toggle('text-cyan-300');
                if(window.sfx) window.sfx.tick();
            });

            // Fullscreen Toggle
            const fullscreenToggle = document.getElementById('fullscreen-toggle');
            if(fullscreenToggle) fullscreenToggle.addEventListener('click', () => {
                document.querySelector('.tablet-frame').classList.toggle('focus-mode');
                // Toggle icon color for feedback
                fullscreenToggle.classList.toggle('text-green-300');
                if(window.sfx) window.sfx.tick();
            });

            // Menu Toggle
            const menuToggle = document.getElementById('menu-toggle');
            if(menuToggle) menuToggle.addEventListener('click', () => {
                 document.getElementById('menu-modal').classList.remove('hidden-modal');
                 document.getElementById('menu-modal').classList.add('visible-modal');
                 if(window.sfx) window.sfx.tick();
            });

            const closeMenu = document.getElementById('close-menu');
            if(closeMenu) closeMenu.addEventListener('click', () => {
                 document.getElementById('menu-modal').classList.add('hidden-modal');
                 document.getElementById('menu-modal').classList.remove('visible-modal');
                 if(window.sfx) window.sfx.tick();
            });

            // Home Button Logic (Long Press)
            const homeBtn = document.getElementById('home-button');
            let pressTimer;
            let isLongPress = false;

            if(homeBtn) {
                const startPress = () => {
                    isLongPress = false;
                    pressTimer = setTimeout(() => {
                        isLongPress = true; 
                        document.getElementById('system-menu-modal').classList.remove('hidden-modal');
                        document.getElementById('system-menu-modal').classList.add('visible-modal');
                        if(window.sfx) window.sfx.nav();
                    }, 800);
                };

                const endPress = () => { clearTimeout(pressTimer); };

                homeBtn.addEventListener('mousedown', startPress);
                homeBtn.addEventListener('mouseup', endPress);
                homeBtn.addEventListener('mouseleave', endPress);
                homeBtn.addEventListener('touchstart', (e) => { startPress(); }, { passive: true });
                homeBtn.addEventListener('touchend', endPress);
                homeBtn.addEventListener('touchcancel', endPress);
                homeBtn.addEventListener('contextmenu', (e) => { e.preventDefault(); return false; });

                homeBtn.addEventListener('click', (e) => {
                    if(isLongPress) {
                        e.preventDefault(); e.stopPropagation(); isLongPress = false;
                    } else {
                        currentPage = 0; window.updatePage(); window.sfx.nav();
                    }
                });
            }
            
            // Accordion Logic (For About/How-To)
            document.querySelectorAll('.accordion-toggle').forEach(button => {
                button.addEventListener('click', () => {
                    const content = button.nextElementSibling;
                    const icon = button.querySelector('.accordion-icon');
                    content.classList.toggle('hidden');
                    if (icon) icon.style.transform = content.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
                    if(window.sfx) window.sfx.tick();
                });
            });

            document.getElementById('current-year').innerText = new Date().getFullYear();
        });
    </script>
</body>
</html>
