<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Jodi's Schoolhouse: Rage Revenue</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons for interactions -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Font Awesome for stars/icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <!-- FIREBASE AND AUTHENTICATION SETUP -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, GoogleAuthProvider, signInWithPopup, updateProfile, signOut, setPersistence, browserLocalPersistence } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, addDoc, collection, serverTimestamp, getDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
        
        // 1. CONFIGURATION (Production Resilient)
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyAf2SO8xovrApl52udUUoR1n9WBnERr_ko",
            authDomain: "allgood-academy.firebaseapp.com",
            projectId: "allgood-academy",
            storageBucket: "allgood-academy.firebasestorage.app",
            messagingSenderId: "978829044870",
            appId: "1:978829044870:web:6c780f64230a77ad0ab507",
            measurementId: "G-EN4M7T3BLQ"
        };
        
        const appId = 'allgood-academy'; 
        
        // 2. INITIALIZE SERVICES
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // PERSISTENCE: This line allows the Dashboard session to carry over!
        setPersistence(auth, browserLocalPersistence).catch(console.error);

        window.authSignOut = () => signOut(auth);

        // 3. GLOBAL STATE
        window.currentUser = null;
        window.currentUserName = "Learner";
        window.currentUserEmail = "";
        window.sessionId = "session_" + Date.now() + "_" + Math.floor(Math.random() * 1000);

        // 4. AUTH HANDLER
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                window.currentUser = user;
                
                // Smart Name Resolution
                let finalName = user.displayName || "Learner";
                
                // If generic, try to fetch from DB
                if (finalName === "Learner" || !user.displayName) {
                    try {
                        const userDoc = await getDoc(doc(db, 'artifacts', appId, 'users', user.uid));
                        if (userDoc.exists() && userDoc.data().displayName) {
                            finalName = userDoc.data().displayName;
                        }
                    } catch(e) { console.log("Profile fetch note:", e); }
                }
                
                window.currentUserName = finalName;
                window.currentUserEmail = user.email;
                
                const headerText = document.getElementById('header-welcome-text');
                if(headerText) headerText.textContent = `Welcome, ${finalName}`;
                
                // AUTO-HIDE LOGIN if present
                const modal = document.getElementById('login-modal');
                if(modal) {
                    modal.classList.add('hidden-modal');
                    modal.classList.remove('visible-modal');
                }
                
                if(window.SessionManager) window.SessionManager.start(finalName, user.email);
            }
        });

        // 5. IDENTITY ENGINE (Shared Protocol)
        async function ensureUserContainer(user, name, email, isGuest) {
             const userRef = doc(db, 'artifacts', appId, 'users', user.uid);
             try {
                 await setDoc(userRef, {
                     displayName: name,
                     email: email || (isGuest ? null : user.email || null),
                     isGuest: isGuest,
                     lastLogin: serverTimestamp(),
                     lastActiveModule: "Rage Revenue"
                 }, { merge: true });
             } catch (e) {
                 console.error("[Identity] Failed to create user container:", e);
             }
        }

        // 6. LOGGING & COMPLETION
        window.logToFirestore = async (action, detail, payload = {}) => {
            const user = auth.currentUser;
            if (!user) return;
            const sessionRef = doc(db, 'artifacts', appId, 'users', user.uid, 'game_scores', window.sessionId);
            try {
                await setDoc(sessionRef, {
                    gameName: "Rage Revenue", 
                    lastUpdated: serverTimestamp(),
                    user: { uid: user.uid, displayName: window.currentUserName, email: window.currentUserEmail },
                    action: action,
                    detail: detail,
                    ...payload
                }, { merge: true });
            } catch (e) { console.error("DB Error", e); }
        };

        window.logModuleCompletion = async (badgeSVGString) => {
            const user = auth.currentUser;
            if (!user) return;
            const sessionRef = doc(db, 'artifacts', appId, 'users', user.uid, 'game_scores', window.sessionId);
            await setDoc(sessionRef, {
                gameName: "Rage Revenue", 
                completed: true, 
                finalScore: 100, 
                rank: "Middleware Architect",
                badgeArtifact: badgeSVGString, 
                lastUpdated: serverTimestamp(),
                user: { uid: user.uid, displayName: window.currentUserName }
            }, { merge: true });
        };

        // 7. LOGIN FUNCTIONS (Updated for Robustness)
        window.handleGuestLogin = async () => {
            const nameInput = document.getElementById('user-name-input');
            const emailInput = document.getElementById('user-email-input');
            
            const name = (nameInput && nameInput.value.trim()) ? nameInput.value.trim() : "Learner";
            const email = (emailInput && emailInput.value.trim()) ? emailInput.value.trim() : null;
            
            const btn = document.getElementById('btn-guest-login');
            
            if(btn) {
                btn.innerText = "Connecting...";
                btn.disabled = true;
            }

            try {
                let user;
                if (auth.currentUser) {
                    user = auth.currentUser; // Reuse if already active
                } else {
                    const result = await signInAnonymously(auth);
                    user = result.user;
                }
                
                await updateProfile(user, { displayName: name });
                await ensureUserContainer(user, name, email, true);
                
                // Explicitly set state
                window.currentUserName = name;
                
            } catch (e) { 
                console.error("Guest login failed", e);
                alert("Login failed. Please refresh and try again."); 
                if(btn) {
                    btn.innerText = "Start Mission";
                    btn.disabled = false;
                }
            }
        };

        window.handleGoogleLogin = async () => {
            const provider = new GoogleAuthProvider();
            try { 
                const result = await signInWithPopup(auth, provider); 
                const user = result.user;
                const finalName = user.displayName || "Agent";
                await ensureUserContainer(user, finalName, user.email, false);
                // onAuthStateChanged handles the rest
            } catch (e) { 
                console.error("Google Auth Error:", e);
                
                // SMART FALLBACK: If domain is unauthorized (Preview/GitHub), auto-switch to Guest
                if (e.code === 'auth/unauthorized-domain' || e.code === 'auth/operation-not-allowed') {
                    console.warn("Domain unauthorized. Falling back to Guest Login.");
                    alert("Note: Google Sign-In is restricted on this preview URL. Logging you in via Guest Access...");
                    await window.handleGuestLogin();
                } else if (e.code === 'auth/popup-closed-by-user') {
                    // User closed popup, do nothing
                } else {
                    alert("Google Sign-In failed. Trying Guest Access..."); 
                    await window.handleGuestLogin();
                }
            }
        };

        (async function initAuth() {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token).catch(e => console.warn(e));
            }
        })();
    </script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'allgood-primary': '#D34716', 
                        'allgood-secondary': '#357889', 
                        'allgood-dark': '#4C4C4C', 
                        'allgood-light': '#F7F7F7', 
                        'allgood-hover': '#EB8D69', 
                        'school-wood': '#8B5A2B', 
                        'school-desk': '#E3C195',
                    },
                    fontFamily: {
                        'heading': ['Georgia', 'serif'],
                        'body': ['Verdana', 'sans-serif'],
                    },
                },
            },
        }
    </script>

    <style>
        /* Base styles */
        body {
            font-family: Verdana, sans-serif;
            background-color: #1a1a1a;
            background-image: url("https://images.unsplash.com/photo-1533090481720-856c6e3c1fdc?q=80&w=2070&auto=format&fit=crop");
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            min-height: 100vh;
            position: relative;
        }

        h1, h2, h3, h4, h5, h6 { font-family: Georgia, serif; }

        .tablet-frame {
            height: 80vh;
            width: auto;
            aspect-ratio: 16/10; 
            max-width: 1100px;
            max-height: 95vh;
            min-height: 0; min-width: 0;
            background-image: 
                radial-gradient(circle at 0% 0%, rgba(211, 71, 22, 0.35) 0%, transparent 30%),
                radial-gradient(circle at 100% 100%, rgba(211, 71, 22, 0.35) 0%, transparent 30%),
                linear-gradient(135deg, #5c5c5c 0%, #d6d6d6 25%, #8a8a8a 50%, #e0e0e0 75%, #5c5c5c 100%);
            border-radius: 12px;
            padding: 12px; 
            box-shadow: inset 1px 1px 2px rgba(255,255,255, 0.6), inset -1px -1px 2px rgba(0,0,0, 0.8), 0 30px 60px -12px rgba(0, 0, 0, 0.8), 0 0 0 1px #111;
            border: 1px solid #333;
            position: relative;
            margin: 20px auto;
            transition: width 0.3s, height 0.3s, padding 0.3s;
        }

        .tablet-frame::before {
            content: '';
            position: absolute;
            top: 10px; left: 10px; right: 10px; bottom: 10px;
            border-radius: 6px;
            background: #111;
            z-index: 0;
        }

        .screen-container {
            width: 100%;
            height: 100%;
            background-color: #FFF8F0;
            position: relative;
            z-index: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column; 
            border-radius: 4px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }

        /* SCROLLBAR */
        #content-column::-webkit-scrollbar { width: 10px; }
        #content-column::-webkit-scrollbar-track { background: #e5e5e5; border-left: 1px solid #d1d5db; }
        #content-column::-webkit-scrollbar-thumb { background-color: #D34716; border-radius: 5px; border: 2px solid #e5e5e5; }
        #content-column::-webkit-scrollbar-thumb:hover { background-color: #EB8D69; }

        /* Modal Styles */
        .modal-transition { transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out; }
        .hidden-modal { opacity: 0; pointer-events: none; transform: translateY(-10px); }
        .visible-modal { opacity: 1; pointer-events: auto; transform: translateY(0); }

        /* Layout Structure */
        .navbar-content { flex: 0 0 60px; z-index: 20; }
        .footer-content { flex: 0 0 60px; z-index: 20; background-color: white; border-top: 1px solid #e5e7eb; position: relative; }
        
        #flex-progress-bar { height: 4px; width: 100%; background-color: #eee; position: absolute; top: 0; left: 0; }
        #flex-progress-fill { height: 100%; background-color: #D34716; width: 0%; transition: width 0.3s ease; }

        /* SPLIT LAYOUT STYLES */
        .split-layout { display: flex; flex-direction: column; height: 100%; width: 100%; overflow: hidden; }
        
        /* Left Column (Jodi) */
        .sidebar-jodi {
            width: 100%;
            height: auto;
            min-height: 140px;
            background-color: #5D4037;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.5' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23noise)' opacity='0.1'/%3E%3C/svg%3E");
            border-bottom: 2px solid #3E2723;
            display: flex;
            align-items: flex-end;
            padding: 10px;
            position: relative;
            z-index: 10;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
        }

        /* Right Column (Content) */
        .content-column {
            flex: 1;
            overflow-y: auto;
            position: relative;
            background-color: #FFF8F0;
            padding-bottom: 20px;
        }

        .page { width: 100%; height: auto; padding: 20px; position: relative; display: none; }
        .page.active { display: block; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* JODI COMPONENT */
        .jodi-wrapper {
            display: flex;
            flex-direction: row;
            align-items: center;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .jodi-avatar {
            width: 80px;
            height: 80px;
            flex-shrink: 0;
            margin-right: 15px;
            filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.3));
        }

        .jodi-bubble {
            background: white;
            border: 2px solid #357889;
            border-radius: 12px;
            border-bottom-left-radius: 0;
            padding: 12px;
            font-size: 0.85rem;
            color: #444;
            line-height: 1.4;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
            flex: 1;
            transform-origin: bottom left;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

        .typing-effect {
            border-right: 2px solid #4ade80;
            animation: blink 1s step-end infinite;
        }
        @keyframes blink { 50% { border-color: transparent; } }

        /* Blueprint Mode */
        .blueprint-mode { background-color: #0f172a !important; color: #94a3b8 !important; }
        .blueprint-mode .page, .blueprint-mode .content-column { background-color: #0f172a !important; }
        .blueprint-mode h1, .blueprint-mode h2, .blueprint-mode h3, .blueprint-mode strong { color: #38bdf8 !important; }
        .blueprint-mode .bg-white { background-color: #1e293b !important; border-color: #334155 !important; color: #cbd5e1 !important; }
        .blueprint-mode .text-allgood-dark { color: #e2e8f0 !important; }
        .blueprint-mode .bg-gray-100, .blueprint-mode .bg-gray-50 { background-color: #0f172a !important; border-color: #1e293b !important; }
        .blueprint-mode .footer-content { background-color: #1e293b !important; border-top-color: #334155 !important; color: #94a3b8 !important; }
        .blueprint-mode .footer-content a { color: #38bdf8 !important; }

        /* Focus Mode */
        .tablet-frame.focus-mode { 
            position: absolute !important; top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important; 
            width: 100% !important; height: 100% !important;
            aspect-ratio: auto !important; max-width: none !important; max-height: none !important; 
            min-height: 0 !important;
            margin: 0 !important; padding: 0 !important; 
            background: #F7F7F7 !important; border: none !important; border-radius: 0 !important; 
            box-shadow: none !important; z-index: 99999 !important; 
            background-image: none !important;
        }
        .tablet-frame.focus-mode::before { display: none; }
        .tablet-frame.focus-mode .screen-container { border-radius: 0; box-shadow: none; height: 100%; }
        .tablet-frame.focus-mode .footer-content { padding-bottom: 0; }

        /* Desktop Breakpoint */
        @media (min-width: 768px) {
            .split-layout { flex-direction: row; }
            
            .sidebar-jodi {
                width: 25%;
                height: 100%;
                border-bottom: none;
                border-right: 2px solid #3E2723;
                flex-direction: column;
                justify-content: flex-end; 
                padding: 20px;
            }

            .content-column { width: 75%; }

            .jodi-wrapper {
                flex-direction: column-reverse; 
                align-items: center;
                width: 100%;
            }

            .jodi-avatar {
                width: 140px;
                height: 140px;
                margin-right: 0;
                margin-top: 15px;
            }

            .jodi-bubble {
                border-radius: 12px;
                border-bottom-left-radius: 12px;
                border-bottom-right-radius: 0; 
                margin-bottom: 10px;
                text-align: center;
            }
            .jodi-bubble::after {
                content: ''; position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%);
                width: 0; height: 0; border-left: 8px solid transparent;
                border-right: 8px solid transparent; border-top: 8px solid #357889;
            }
        }

        /* Feed Simulator Styles */
        .feed-scroll { 
            height: 320px; overflow-y: scroll; border: 1px solid #e5e7eb; 
            border-radius: 8px; background: #fff; scroll-behavior: smooth;
        }
        .feed-item { 
            padding: 16px; border-bottom: 1px solid #f0f0f0; transition: background 0.2s; 
        }
        .feed-item.filtered { opacity: 0.5; background: #f9f9f9; border-left: 4px solid #ccc; pointer-events: none; }
        .feed-item.active-post { border-left: 4px solid #357889; background: #fff; }
        .feed-item.rage-post { border-left: 4px solid #D34716; }

        /* Mobile Layout Overrides */
        @media (max-width: 768px) {
            html, body { width: 100%; height: 100%; margin: 0; padding: 0 !important; overflow: hidden !important; position: fixed; inset: 0; overscroll-behavior: none; }
            main { width: 100vw; height: 100dvh; position: fixed; inset: 0; padding: 0 !important; display: flex; flex-direction: column; z-index: 0; }
            .tablet-frame { position: relative !important; width: 100% !important; height: 100% !important; max-width: none !important; max-height: none !important; min-height: 0 !important; aspect-ratio: auto !important; margin: 0 !important; padding: 0 !important; border: none !important; border-radius: 0 !important; background-image: none !important; box-shadow: none !important; display: flex; flex-direction: column; }
            .tablet-frame::before { display: none; }
            .screen-container { flex: 1; width: 100%; height: 100%; display: flex; flex-direction: column; border-radius: 0 !important; box-shadow: none !important; overflow: hidden; }
            .navbar-content { padding-top: max(env(safe-area-inset-top), 5px); }
            .footer-content { z-index: 100; padding-bottom: max(env(safe-area-inset-bottom), 15px); height: auto; }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen text-allgood-dark font-body overflow-y-auto">

    <main class="flex-grow flex items-center justify-center py-8">
        <div class="tablet-frame">
            <div class="screen-container" id="screen">

                <!-- 1. STARTUP SCREEN -->
                <div id="startup-screen" class="absolute inset-0 z-[300] flex flex-col items-center justify-center cursor-pointer transition-opacity duration-700 ease-in-out bg-gradient-to-br from-allgood-secondary to-gray-900">
                    <div class="group flex flex-col items-center justify-center text-center h-full w-full relative">
                        <div class="flex-grow flex flex-col items-center justify-center px-4">
                            <div class="relative">
                                <div class="absolute inset-0 bg-white/10 blur-3xl rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-700"></div>
                                <i data-lucide="school" class="w-24 h-24 text-white mb-6 relative z-10 drop-shadow-[0_0_15px_rgba(255,255,255,0.5)]"></i>
                                <h2 class="text-xl md:text-2xl font-heading font-bold text-gray-300 mb-1 relative z-10 tracking-widest uppercase">Allgood Academy</h2>
                                <h1 class="text-5xl md:text-7xl font-heading font-bold text-transparent bg-clip-text bg-gradient-to-r from-white to-gray-400 tracking-tighter relative z-10 drop-shadow-sm">Jodi's Schoolhouse</h1>
                                <p class="mt-4 text-allgood-primary font-bold text-lg relative z-10 bg-white/10 px-4 py-1 rounded-full backdrop-blur-sm border border-white/10">Module: Rage Revenue</p>
                            </div>
                            <p class="mt-16 text-white/60 text-xs tracking-[0.4em] uppercase font-bold group-hover:text-white transition-colors animate-pulse">CLICK TO POWER UP</p>
                        </div>
                    </div>
                </div>

                <!-- 2. Header -->
                <header class="bg-allgood-secondary shadow-md navbar-content flex items-center shrink-0">
                    <div class="w-full px-4 flex items-center justify-between h-full">
                        <div class="flex items-center overflow-hidden">
                            <div id="header-welcome-text" class="text-white font-heading font-bold text-lg tracking-tight truncate mr-4 select-none">Welcome, Learner</div>
                            <div class="flex shrink-0 items-center bg-black/20 rounded-full px-3 py-1 border border-white/10 shadow-inner backdrop-blur-sm">
                                <span class="text-[10px] uppercase tracking-wider text-white/60 mr-2 font-heading font-bold">Page</span>
                                <span id="header-page-indicator" class="text-xs font-bold text-white font-body tabular-nums">1 / 15</span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-1 shrink-0 relative">
                            <button id="home-button" class="text-gray-200 hover:text-white transition-colors p-2 rounded-full hover:bg-white/10 mr-2" title="Go Home"><i data-lucide="home" class="w-6 h-6"></i></button>
                            <div class="h-6 w-px bg-white/20 mx-1"></div>
                            <button id="blueprint-toggle" class="text-gray-200 hover:text-cyan-300 transition-colors p-2 rounded-full hover:bg-white/10"><i data-lucide="moon" class="w-5 h-5"></i></button>
                            <button id="fullscreen-toggle" class="text-gray-200 hover:text-green-300 transition-colors p-2 rounded-full hover:bg-white/10"><i data-lucide="maximize" class="w-5 h-5"></i></button>
                            <button id="menu-toggle" class="text-gray-200 hover:text-white transition-colors p-2 rounded-full hover:bg-white/10"><i data-lucide="menu" class="w-7 h-7"></i></button>
                        </div>
                    </div>
                </header>

                <!-- MAIN SPLIT VIEW -->
                <div class="flex-1 min-h-0 relative split-layout">
                    
                    <!-- LEFT COLUMN: MENTOR SIDEBAR -->
                    <div class="sidebar-jodi shrink-0">
                        <div class="jodi-wrapper">
                            <div id="jodi-avatar-svg" class="jodi-avatar"></div>
                            <div id="jodi-bubble" class="jodi-bubble">
                                Welcome to the Schoolhouse. I'm Jodi.
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT COLUMN: CONTENT SCROLL AREA (NEW MIDDLEWARE STORYBOARD) -->
                    <div class="content-column" id="content-column">
                        
                        <!-- Page 1: The Pitch -->
                        <div class="page active" id="page-1">
                            <div class="h-full flex flex-col items-center justify-center text-center max-w-2xl mx-auto pt-10 px-6">
                                <div class="mb-4 text-allgood-secondary font-bold tracking-widest uppercase text-xs">Module 4: Market Dynamics</div>
                                <h1 class="text-4xl md:text-5xl font-heading font-bold text-allgood-dark mb-4 text-shadow">The Market Opportunity</h1>
                                <div class="w-24 h-1 bg-allgood-primary mb-6"></div>
                                <p class="text-lg text-gray-600 mb-8 font-body leading-relaxed">
                                    The social media giants are broken. They profit from rage, but they are losing user trust.<br><br>
                                    This isn't a crisis. <strong>It's a business opportunity.</strong>
                                </p>
                                <button onclick="window.nextPage()" class="bg-allgood-primary text-white px-8 py-3 rounded-lg font-bold shadow-lg hover:bg-allgood-hover transition transform hover:scale-105 flex items-center">
                                    Start Your Venture <i data-lucide="briefcase" class="ml-2 w-4 h-4"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Page 2: The Trap (Graph) -->
                        <div class="page" id="page-2">
                            <div class="max-w-3xl mx-auto pt-4 px-6">
                                <h2 class="text-2xl font-heading font-bold text-allgood-dark mb-2">The Incumbent's Trap</h2>
                                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                                    <p class="font-body text-sm text-gray-700 mb-6"><strong>The Dilemma:</strong> Adjust the algorithm's aggression level to see if you can balance the books without losing the users.</p>
                                    
                                    <!-- Interactive Controls -->
                                    <div class="mb-6">
                                        <div class="flex justify-between text-xs font-bold mb-2">
                                            <span class="text-allgood-secondary">Safe & Boring</span>
                                            <span class="text-gray-500 uppercase tracking-widest">Algorithmic Aggression</span>
                                            <span class="text-allgood-primary">Toxic & Viral</span>
                                        </div>
                                        <input type="range" id="trap-slider" min="0" max="100" value="50" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-allgood-primary" oninput="if(window.updateTrapGraph) window.updateTrapGraph()">
                                    </div>

                                    <!-- Dynamic Graph Container -->
                                    <div class="relative h-56 w-full border-l-2 border-b-2 border-gray-300 px-2 pb-2 bg-gray-50/50 rounded-tr-lg">
                                        <svg class="w-full h-full overflow-visible" preserveAspectRatio="none" id="trap-svg">
                                            <!-- Grid Lines -->
                                            <line x1="0" y1="25%" x2="100%" y2="25%" stroke="#e5e7eb" stroke-width="1" stroke-dasharray="4,4"/>
                                            <line x1="0" y1="50%" x2="100%" y2="50%" stroke="#e5e7eb" stroke-width="1" stroke-dasharray="4,4"/>
                                            <line x1="0" y1="75%" x2="100%" y2="75%" stroke="#e5e7eb" stroke-width="1" stroke-dasharray="4,4"/>

                                            <!-- Dynamic Lines -->
                                            <path id="line-revenue" fill="none" stroke="#D34716" stroke-width="4" stroke-linecap="round"/>
                                            <path id="line-trust" fill="none" stroke="#357889" stroke-width="4" stroke-linecap="round"/>
                                            
                                            <!-- End Point Markers -->
                                            <circle id="dot-revenue" r="6" fill="#D34716" stroke="white" stroke-width="2"/>
                                            <circle id="dot-trust" r="6" fill="#357889" stroke="white" stroke-width="2"/>
                                        </svg>
                                        
                                        <!-- Labels -->
                                        <div class="absolute top-2 right-2 text-xs font-bold text-allgood-primary bg-white/80 px-2 py-1 rounded shadow-sm border border-allgood-primary/20">Revenue (Rage)</div>
                                        <div class="absolute bottom-4 right-2 text-xs font-bold text-allgood-secondary bg-white/80 px-2 py-1 rounded shadow-sm border border-allgood-secondary/20">User Trust</div>
                                    </div>

                                    <!-- Dynamic Feedback -->
                                    <div class="mt-4 p-4 rounded-lg border-l-4 transition-colors duration-300" id="trap-feedback-box">
                                        <div class="flex justify-between items-center mb-1">
                                            <span class="text-xs font-bold uppercase tracking-wide" id="trap-status-title">Status Quo</span>
                                            <span class="text-xs font-mono text-gray-500" id="trap-metrics">Rev: $10B | Trust: 50%</span>
                                        </div>
                                        <p class="text-sm font-bold italic" id="trap-feedback-text">"We are making money, but people are starting to hate us."</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Page 3: The Old Way (Simulation) -->
                        <div class="page" id="page-3">
                            <div class="max-w-3xl mx-auto pt-4 px-6">
                                <h2 class="text-2xl font-heading font-bold text-allgood-dark mb-4">The Failed Model</h2>
                                <p class="text-sm text-gray-600 mb-4">Try to fix the platform from the inside. Adjust the 'Anger' weight.</p>
                                
                                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                                    <label class="flex justify-between text-sm font-bold mb-2 text-allgood-primary">
                                        <span>Anger Amplification</span> <span id="anger-val-display">5x</span>
                                    </label>
                                    <input type="range" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" min="1" max="10" value="5" id="fail-slider" oninput="if(window.updateFailSimulation) window.updateFailSimulation()">
                                    
                                    <div class="grid grid-cols-2 gap-4 mt-8 text-center">
                                        <div class="p-4 bg-gray-50 rounded border">
                                            <div class="text-xs text-gray-500 uppercase">Revenue</div>
                                            <div class="text-2xl font-bold transition-colors duration-300" id="fail-rev">$10.2B</div>
                                        </div>
                                        <div class="p-4 bg-gray-50 rounded border">
                                            <div class="text-xs text-gray-500 uppercase">User Churn</div>
                                            <div class="text-2xl font-bold transition-colors duration-300" id="fail-churn">12%</div>
                                        </div>
                                    </div>
                                    <div id="fail-msg" class="mt-4 text-center text-sm font-bold h-6 text-red-500"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Page 4: The Pivot (REBRANDED TO SIGNAL) -->
                        <div class="page" id="page-4">
                            <div class="max-w-3xl mx-auto pt-10 text-center px-6">
                                <div class="inline-block bg-allgood-secondary text-white px-3 py-1 rounded-full text-xs font-bold mb-4 uppercase tracking-wide">The Solution</div>
                                <h2 class="text-3xl font-heading font-bold text-allgood-dark mb-6">Enter: Signal</h2>
                                <p class="text-gray-600 font-body mb-8 max-w-lg mx-auto">
                                    The platform is full of noise (rage).<br>
                                    Your software filters the noise to find the <strong>signal</strong>.<br><br>
                                    You don't own the content (Facebook/X does).<br>
                                    You own the <strong>filter</strong>.
                                </p>
                                <div class="bg-white p-8 rounded-xl shadow-lg border border-gray-200 max-w-md mx-auto">
                                    <i data-lucide="radio" class="w-12 h-12 text-allgood-primary mx-auto mb-4"></i>
                                    <h3 class="text-xl font-bold mb-2">New Venture: Signal</h3>
                                    <p class="text-xs text-gray-500 mb-6">Noise Reduction Engine</p>
                                    <button onclick="window.nextPage()" class="w-full bg-allgood-dark text-white py-3 rounded font-bold hover:bg-black transition">Initialize Startup</button>
                                </div>
                            </div>
                        </div>

                        <!-- Page 5: Feature 1 (Ranking) -->
                        <div class="page" id="page-5">
                            <div class="max-w-4xl mx-auto pt-6 px-6">
                                <h2 class="text-xl font-heading font-bold text-allgood-dark mb-2">Build Step 1: Core Engine</h2>
                                <p class="text-sm text-gray-600 mb-6">How will Signal rank content for users?</p>
                                
                                <div class="grid md:grid-cols-3 gap-4 mb-6">
                                    <button onmouseenter="previewScenario('ranking', 'engagement')" onclick="buildMiddleware('ranking', 'engagement', this)" class="mw-btn p-4 bg-white border-2 border-transparent hover:border-gray-300 rounded-lg shadow-sm text-left group transition h-full flex flex-col justify-between">
                                        <div>
                                            <div class="font-bold mb-2 text-gray-800 text-sm">Engagement Optimization</div>
                                            <p class="text-xs text-gray-500">Prioritize clicks & comments. Maximize time-on-site.</p>
                                        </div>
                                    </button>
                                    <button onmouseenter="previewScenario('ranking', 'chronological')" onclick="buildMiddleware('ranking', 'chronological', this)" class="mw-btn p-4 bg-white border-2 border-transparent hover:border-blue-300 rounded-lg shadow-sm text-left group transition h-full flex flex-col justify-between">
                                        <div>
                                            <div class="font-bold mb-2 text-blue-600 text-sm">Chronological Feed</div>
                                            <p class="text-xs text-gray-500">Show posts in time order. No ranking, just a raw stream.</p>
                                        </div>
                                    </button>
                                    <button onmouseenter="previewScenario('ranking', 'bridging')" onclick="buildMiddleware('ranking', 'bridging', this)" class="mw-btn p-4 bg-white border-2 border-transparent hover:border-allgood-secondary rounded-lg shadow-sm text-left group transition h-full flex flex-col justify-between">
                                        <div>
                                            <div class="font-bold mb-2 text-allgood-secondary text-sm">Bridging-Based Ranking</div>
                                            <p class="text-xs text-gray-500">Boost content with cross-group consensus. Downrank division.</p>
                                        </div>
                                    </button>
                                </div>

                                <!-- EXECUTIVE BRIEF FORECAST BOX -->
                                <div id="ranking-scenario" class="bg-white border-l-4 border-allgood-secondary shadow-md p-4 rounded-r-lg min-h-[80px] transition-all duration-300">
                                    <div class="flex items-center mb-2">
                                        <i data-lucide="bar-chart-2" class="w-4 h-4 text-allgood-secondary mr-2"></i>
                                        <span class="text-xs font-bold uppercase tracking-wide text-gray-400">Projected Impact</span>
                                    </div>
                                    <p id="ranking-forecast-text" class="text-sm text-gray-700 font-body leading-relaxed">Hover over an option to view the strategic forecast...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Page 6: Feature 2 (Velocity) -->
                        <div class="page" id="page-6">
                            <div class="max-w-4xl mx-auto pt-6 px-6">
                                <h2 class="text-xl font-heading font-bold text-allgood-dark mb-2">Build Step 2: Viral Spikes</h2>
                                <p class="text-sm text-gray-600 mb-6">A post is going viral (1M views in 10 mins). What does your code do?</p>
                                
                                <div class="grid md:grid-cols-3 gap-4 mb-6">
                                    <button onmouseenter="previewScenario('velocity', 'unrestricted')" onclick="buildMiddleware('velocity', 'unrestricted', this)" class="mw-btn p-4 bg-white border-2 border-transparent hover:border-gray-300 rounded-lg shadow-sm text-left group transition h-full flex flex-col justify-between">
                                        <div>
                                            <div class="font-bold mb-2 text-gray-800 text-sm">Let it Ride</div>
                                            <p class="text-xs text-gray-500">No interference. Virality drives growth.</p>
                                        </div>
                                    </button>
                                    <button onmouseenter="previewScenario('velocity', 'friction')" onclick="buildMiddleware('velocity', 'friction', this)" class="mw-btn p-4 bg-white border-2 border-transparent hover:border-blue-300 rounded-lg shadow-sm text-left group transition h-full flex flex-col justify-between">
                                        <div>
                                            <div class="font-bold mb-2 text-blue-600 text-sm">Add Friction</div>
                                            <p class="text-xs text-gray-500">Ask "Did you read the article?" before sharing.</p>
                                        </div>
                                    </button>
                                    <button onmouseenter="previewScenario('velocity', 'circuit')" onclick="buildMiddleware('velocity', 'circuit', this)" class="mw-btn p-4 bg-white border-2 border-transparent hover:border-allgood-secondary rounded-lg shadow-sm text-left group transition h-full flex flex-col justify-between">
                                        <div>
                                            <div class="font-bold mb-2 text-allgood-secondary text-sm">Circuit Breakers</div>
                                            <p class="text-xs text-gray-500">Hard stop on recommendation until fact-checked.</p>
                                        </div>
                                    </button>
                                </div>

                                <!-- EXECUTIVE BRIEF FORECAST BOX -->
                                <div id="velocity-scenario" class="bg-white border-l-4 border-allgood-secondary shadow-md p-4 rounded-r-lg min-h-[80px] transition-all duration-300">
                                    <div class="flex items-center mb-2">
                                        <i data-lucide="bar-chart-2" class="w-4 h-4 text-allgood-secondary mr-2"></i>
                                        <span class="text-xs font-bold uppercase tracking-wide text-gray-400">Projected Impact</span>
                                    </div>
                                    <p id="velocity-forecast-text" class="text-sm text-gray-700 font-body leading-relaxed">Hover over an option to view the strategic forecast...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Page 7: Feature 3 (Agency) -->
                        <div class="page" id="page-7">
                            <div class="max-w-4xl mx-auto pt-6 px-6">
                                <h2 class="text-xl font-heading font-bold text-allgood-dark mb-2">Build Step 3: User Control</h2>
                                <p class="text-sm text-gray-600 mb-6">Who decides what the user sees?</p>
                                
                                <div class="grid md:grid-cols-3 gap-4 mb-6">
                                    <button onmouseenter="previewScenario('agency', 'blackbox')" onclick="buildMiddleware('agency', 'blackbox', this)" class="mw-btn p-4 bg-white border-2 border-transparent hover:border-gray-300 rounded-lg shadow-sm text-left group transition h-full flex flex-col justify-between">
                                        <div>
                                            <div class="font-bold mb-2 text-gray-800 text-sm">The Black Box</div>
                                            <p class="text-xs text-gray-500">We decide. The user just scrolls.</p>
                                        </div>
                                    </button>
                                    <button onmouseenter="previewScenario('agency', 'curated')" onclick="buildMiddleware('agency', 'curated', this)" class="mw-btn p-4 bg-white border-2 border-transparent hover:border-blue-300 rounded-lg shadow-sm text-left group transition h-full flex flex-col justify-between">
                                        <div>
                                            <div class="font-bold mb-2 text-blue-600 text-sm">Curated Modes</div>
                                            <p class="text-xs text-gray-500">Offer preset modes: "Focus", "News", "Quiet".</p>
                                        </div>
                                    </button>
                                    <button onmouseenter="previewScenario('agency', 'transparent')" onclick="buildMiddleware('agency', 'transparent', this)" class="mw-btn p-4 bg-white border-2 border-transparent hover:border-allgood-secondary rounded-lg shadow-sm text-left group transition h-full flex flex-col justify-between">
                                        <div>
                                            <div class="font-bold mb-2 text-allgood-secondary text-sm">Transparent Sliders</div>
                                            <p class="text-xs text-gray-500">Full control knobs for every variable.</p>
                                        </div>
                                    </button>
                                </div>

                                <!-- EXECUTIVE BRIEF FORECAST BOX -->
                                <div id="agency-scenario" class="bg-white border-l-4 border-allgood-secondary shadow-md p-4 rounded-r-lg min-h-[80px] transition-all duration-300">
                                    <div class="flex items-center mb-2">
                                        <i data-lucide="bar-chart-2" class="w-4 h-4 text-allgood-secondary mr-2"></i>
                                        <span class="text-xs font-bold uppercase tracking-wide text-gray-400">Projected Impact</span>
                                    </div>
                                    <p id="agency-forecast-text" class="text-sm text-gray-700 font-body leading-relaxed">Hover over an option to view the strategic forecast...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Page 8: Business Model -->
                        <div class="page" id="page-8">
                            <div class="max-w-4xl mx-auto pt-6 px-6">
                                <h2 class="text-xl font-heading font-bold text-allgood-dark mb-2">Build Step 4: Revenue</h2>
                                <p class="text-sm text-gray-600 mb-6">How do we keep the lights on?</p>
                                
                                <div class="grid md:grid-cols-3 gap-4 mb-6">
                                    <button onmouseenter="previewScenario('model', 'ads')" onclick="buildMiddleware('model', 'ads', this)" class="mw-btn p-4 bg-white border-2 border-transparent hover:border-gray-300 rounded-lg shadow-sm text-left group transition h-full flex flex-col justify-between">
                                        <div>
                                            <div class="font-bold mb-2 text-gray-800 text-sm">Ad-Supported</div>
                                            <p class="text-xs text-gray-500">Free for users. We sell their attention.</p>
                                        </div>
                                    </button>
                                    <button onmouseenter="previewScenario('model', 'freemium')" onclick="buildMiddleware('model', 'freemium', this)" class="mw-btn p-4 bg-white border-2 border-transparent hover:border-blue-300 rounded-lg shadow-sm text-left group transition h-full flex flex-col justify-between">
                                        <div>
                                            <div class="font-bold mb-2 text-blue-600 text-sm">Freemium</div>
                                            <p class="text-xs text-gray-500">Free basic tier, paid power tools.</p>
                                        </div>
                                    </button>
                                    <button onmouseenter="previewScenario('model', 'sub')" onclick="buildMiddleware('model', 'sub', this)" class="mw-btn p-4 bg-white border-2 border-transparent hover:border-allgood-secondary rounded-lg shadow-sm text-left group transition h-full flex flex-col justify-between">
                                        <div>
                                            <div class="font-bold mb-2 text-allgood-secondary text-sm">Subscription Only</div>
                                            <p class="text-xs text-gray-500">User pays 100%. No ads, total alignment.</p>
                                        </div>
                                    </button>
                                </div>

                                <!-- EXECUTIVE BRIEF FORECAST BOX -->
                                <div id="model-scenario" class="bg-white border-l-4 border-allgood-secondary shadow-md p-4 rounded-r-lg min-h-[80px] transition-all duration-300">
                                    <div class="flex items-center mb-2">
                                        <i data-lucide="bar-chart-2" class="w-4 h-4 text-allgood-secondary mr-2"></i>
                                        <span class="text-xs font-bold uppercase tracking-wide text-gray-400">Projected Impact</span>
                                    </div>
                                    <p id="model-forecast-text" class="text-sm text-gray-700 font-body leading-relaxed">Hover over an option to view the strategic forecast...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Page 9: Beta Test (Feed) -->
                        <div class="page" id="page-9">
                            <div class="max-w-xl mx-auto pt-2 px-4 h-full flex flex-col">
                                <h2 class="text-xl font-heading font-bold text-allgood-dark mb-2 shrink-0">Beta Launch: Live Feed</h2>
                                
                                <!-- FEED CONTAINER (Flex column for scroll handling) -->
                                <div class="bg-gray-100 rounded-lg border border-gray-300 shadow-inner flex flex-col flex-1 overflow-hidden relative">
                                    
                                    <!-- AGENCY TUNER (If Transparent) -->
                                    <div id="agency-tuner-container"></div>

                                    <!-- HEADER & TOGGLE -->
                                    <div class="bg-white p-3 border-b border-gray-200 flex justify-between items-center shrink-0 z-20 shadow-sm">
                                        <div class="flex items-center">
                                            <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse mr-2"></div>
                                            <span class="text-xs font-bold text-gray-700 tracking-wide">SIGNAL v1.0</span>
                                        </div>
                                        
                                        <!-- TOGGLE SWITCH -->
                                        <button onclick="window.toggleFeedFilter()" class="flex items-center group focus:outline-none">
                                            <span class="text-[10px] font-bold text-gray-400 mr-2 uppercase tracking-wider group-hover:text-gray-600 transition">Raw Feed</span>
                                            <div class="relative inline-flex items-center cursor-pointer">
                                                <div id="filter-track" class="w-10 h-5 bg-allgood-secondary rounded-full peer-focus:ring-4 peer-focus:ring-blue-300 transition-colors duration-300"></div>
                                                <div id="filter-knob" class="absolute left-[22px] top-[2px] bg-white border border-gray-300 w-4 h-4 rounded-full transition-all duration-300 shadow-sm"></div>
                                            </div>
                                            <span class="text-[10px] font-bold text-allgood-secondary ml-2 uppercase tracking-wider" id="filter-label">Filter ON</span>
                                        </button>
                                    </div>

                                    <!-- SCROLLABLE FEED AREA -->
                                    <div id="mw-feed" class="overflow-y-auto bg-gray-50 p-2 space-y-3 relative">
                                        <!-- Feed items injected via JS -->
                                    </div>
                                    
                                    <!-- SCROLL FADE OVERLAY (Visual cue) -->
                                    <div class="absolute bottom-0 left-0 right-0 h-12 bg-gradient-to-t from-gray-100 to-transparent pointer-events-none z-10"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Page 10: Dashboard -->
                        <div class="page" id="page-10">
                            <div class="max-w-3xl mx-auto pt-6 px-6">
                                <h2 class="text-2xl font-heading font-bold text-allgood-dark mb-6">Q3 Performance Report</h2>
                                <div class="bg-white p-8 rounded-xl shadow-lg border border-gray-200 grid grid-cols-3 gap-6 text-center">
                                    
                                    <div>
                                        <div class="text-xs text-gray-500 uppercase font-bold mb-2">User Growth</div>
                                        <div id="report-growth" class="text-3xl font-bold text-gray-800">--</div>
                                    </div>
                                    <div>
                                        <div class="text-xs text-gray-500 uppercase font-bold mb-2">Churn Rate</div>
                                        <div id="report-churn" class="text-3xl font-bold text-gray-800">--</div>
                                    </div>
                                    <div>
                                        <div class="text-xs text-gray-500 uppercase font-bold mb-2">Trust Score</div>
                                        <div id="report-trust" class="text-3xl font-bold text-gray-800">--</div>
                                    </div>

                                </div>
                                <p id="report-summary" class="mt-8 text-center text-gray-600 font-body max-w-lg mx-auto italic font-bold">
                                    Generating report based on your architecture...
                                </p>
                            </div>
                        </div>

                        <!-- Page 11: Market Reaction -->
                        <div class="page" id="page-11">
                            <div class="max-w-3xl mx-auto pt-6 px-6">
                                <h2 class="text-2xl font-heading font-bold text-allgood-dark mb-6 text-center">The Industry Reacts</h2>
                                <div class="space-y-4">
                                    <div class="bg-white p-4 border-l-4 border-allgood-primary shadow-sm">
                                        <div class="text-xs font-bold text-gray-400 mb-1">TECH DAILY</div>
                                        <h3 class="font-bold text-lg">"Users Flock to Signal to Escape the Noise"</h3>
                                    </div>
                                    <div class="bg-white p-4 border-l-4 border-blue-500 shadow-sm">
                                        <div class="text-xs font-bold text-gray-400 mb-1">ADWEEK</div>
                                        <h3 class="font-bold text-lg">"Premium Brands Pay 3x CPM for 'Safe' Inventory on Filtered Feeds"</h3>
                                    </div>
                                    <div class="bg-white p-4 border-l-4 border-green-500 shadow-sm">
                                        <div class="text-xs font-bold text-gray-400 mb-1">THE VERGE</div>
                                        <h3 class="font-bold text-lg">"Is Middleware the End of the Algorithmic Monopoly?"</h3>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Page 12: Scaling Decision -->
                        <div class="page" id="page-12">
                            <div class="max-w-md mx-auto pt-10 px-6 text-center">
                                <div class="bg-white p-8 rounded-xl shadow-2xl border border-gray-200">
                                    <div class="w-16 h-16 bg-gray-900 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <i data-lucide="mail" class="text-white w-8 h-8"></i>
                                    </div>
                                    <h2 class="text-xl font-bold mb-2">Acquisition Offer</h2>
                                    <p class="text-sm text-gray-600 mb-6">BigSocial wants to buy Signal for $50M.<br>Condition: Shut down the 'Circuit Breaker' feature.</p>
                                    
                                    <div class="space-y-3">
                                        <button onclick="window.nextPage()" class="w-full bg-allgood-secondary text-white py-3 rounded font-bold hover:bg-allgood-hover transition">Reject Offer (Stay Independent)</button>
                                        <button onclick="alert('Game Over: You sold out the mission.')" class="w-full bg-gray-100 text-gray-400 py-3 rounded font-bold hover:bg-gray-200 transition">Sell Out</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Page 13: Reflection -->
                        <div class="page" id="page-13">
                            <div class="max-w-2xl mx-auto pt-8 px-6">
                                <h2 class="text-2xl font-heading font-bold text-allgood-dark mb-4">Strategic Insight</h2>
                                <div class="bg-white p-6 rounded-lg shadow-lg">
                                    <p class="font-body text-gray-700 mb-4"><strong>Why is a paid filter (Middleware) inherently safer than a free, ad-based feed?</strong></p>
                                    <textarea class="w-full h-32 p-3 border border-gray-300 rounded focus:border-allgood-primary outline-none resize-none bg-gray-50" placeholder="Think about who the customer is..."></textarea>
                                    <div class="mt-4 flex justify-end">
                                        <span class="text-xs text-green-600 font-bold flex items-center opacity-0 transition" id="reflect-saved"><i data-lucide="check" class="w-3 h-3 mr-1"></i> Saved</span>
                                        <button onclick="document.getElementById('reflect-saved').classList.remove('opacity-0')" class="bg-allgood-secondary text-white px-4 py-2 rounded text-sm font-bold ml-4">Save Reflection</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Page 14: Certification -->
                        <div class="page" id="page-14">
                            <div class="max-w-2xl mx-auto pt-6 px-6">
                                <h2 class="text-2xl font-heading font-bold text-allgood-dark mb-6 text-center">Certification Check</h2>
                                <div class="space-y-4">
                                    <div class="bg-white p-4 rounded border cursor-pointer hover:bg-blue-50" onclick="checkQuiz(this, false)"><p class="font-bold text-sm">1. Middleware creates more rage to sell ads.</p></div>
                                    <div class="bg-white p-4 rounded border cursor-pointer hover:bg-blue-50" onclick="checkQuiz(this, true)"><p class="font-bold text-sm">2. Bridging algorithms boost content that opposing groups agree on.</p></div>
                                    <div class="bg-white p-4 rounded border cursor-pointer hover:bg-blue-50" onclick="checkQuiz(this, false)"><p class="font-bold text-sm">3. "Circuit Breakers" speed up viral content.</p></div>
                                </div>
                                <div id="quiz-feedback" class="text-center mt-6 font-bold h-6"></div>
                            </div>
                        </div>

                        <!-- Page 15: Badge -->
                        <div class="page" id="page-15">
                            <div class="flex flex-col items-center justify-center h-full text-center px-6">
                                <div id="badge-display" class="w-64 h-64 mb-6 transition-transform hover:scale-105 cursor-pointer"></div>
                                <h2 class="text-3xl font-heading font-bold text-allgood-dark mb-2">Middleware Architect</h2>
                                <p class="text-gray-600 mb-8">You have designed a sustainable alternative to the rage economy.</p>
                                <button class="bg-allgood-primary text-white px-8 py-3 rounded-full font-bold shadow-lg flex items-center hover:bg-allgood-hover transition">
                                    <i data-lucide="download" class="mr-2 w-4 h-4"></i> Download Badge
                                </button>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Footer -->
                <footer class="footer-content flex items-center justify-between px-6 border-t border-gray-200 bg-white z-20 relative shrink-0">
                    <div id="flex-progress-bar" class="absolute top-0 left-0 h-1 bg-gray-200 w-full"><div id="flex-progress-fill" class="h-full bg-allgood-primary w-0 transition-all duration-300"></div></div>
                    <button id="prev-btn" class="text-allgood-primary hover:text-allgood-dark font-bold text-sm flex items-center transition-colors disabled:opacity-30 disabled:cursor-not-allowed font-body" disabled>
                        <i data-lucide="chevron-left" class="w-4 h-4 mr-1"></i>Back
                    </button>
                    <p class="text-gray-400 text-[10px] hidden sm:block font-body">&copy; <a href="https://www.allgoodacademy.com" target="_blank" class="hover:text-allgood-primary transition-colors font-bold">Allgood Academy</a> <span id="current-year"></span></p>
                    <button id="next-btn" class="bg-allgood-primary hover:bg-allgood-hover text-white px-6 py-2 rounded-full text-sm font-bold shadow-md transition-transform transform hover:scale-105 flex items-center disabled:opacity-50 disabled:cursor-not-allowed font-body">
                        <span>Next</span><i data-lucide="chevron-right" class="w-4 h-4 ml-1"></i>
                    </button>
                </footer>

                <!-- Login Modal -->
                <div id="login-modal" class="absolute inset-0 z-[200] bg-allgood-dark/95 flex items-center justify-center p-6 visible-modal modal-transition">
                    <div class="bg-white rounded-lg shadow-2xl p-8 max-w-sm w-full text-center border-t-4 border-allgood-primary">
                        <div class="mb-6"><h2 class="text-3xl font-heading font-bold text-allgood-dark">Allgood<span class="text-allgood-primary">Academy</span></h2></div>
                        <h2 class="text-xl font-bold text-allgood-dark mb-2 font-heading">Welcome</h2>
                        <div class="flex items-center justify-center gap-2 mb-6 relative">
                            <p class="text-gray-500 text-sm font-body">Please sign in to start.</p>
                            <button id="policy-trigger" class="group relative flex items-center text-allgood-primary hover:text-allgood-hover transition-colors focus:outline-none">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                                <span class="text-xs font-bold underline decoration-dotted underline-offset-2">Why?</span>
                                <div class="absolute top-full left-1/2 transform -translate-x-1/2 mt-3 w-64 p-3 bg-gray-800 text-white text-xs text-left rounded shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible group-focus:opacity-100 group-focus:visible transition-all duration-200 z-50 font-body leading-relaxed border border-gray-700 pointer-events-none">
                                    <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-b-gray-800"></div>
                                    <strong class="block text-allgood-primary mb-1 uppercase tracking-wide text-[10px]">Why do we ask?</strong>
                                    <p class="mb-2 text-gray-300">We use your name to personalize your badge. <strong>Performance data is logged in real-time</strong> to improve the GoodBlock experience. All personal data is <strong>kept confidential</strong> and <strong>never sold.</strong></p>
                                    <div class="border-t border-gray-700 my-1 pt-1"></div>
                                    <p class="text-gray-300"><strong>Email (Optional):</strong> Enter to join the Allgood Academy community.</p>
                                </div>
                            </button>
                        </div>
                        <input type="text" id="user-name-input" placeholder="Your Name (Optional)" class="w-full border border-gray-300 rounded p-3 mb-3 focus:ring-2 focus:ring-allgood-primary focus:border-transparent outline-none transition-all font-body">
                        <input type="email" id="user-email-input" placeholder="Your Email (Optional)" class="w-full border border-gray-300 rounded p-3 mb-6 focus:ring-2 focus:ring-allgood-primary focus:border-transparent outline-none transition-all font-body">
                        <button id="btn-guest-login" onclick="window.handleGuestLogin()" class="w-full bg-allgood-primary hover:bg-allgood-hover text-white font-bold py-3 rounded shadow-md transition-transform transform hover:scale-[1.02] active:scale-[0.98] font-body uppercase">Start Mission</button>
                        <div class="mt-4 flex items-center justify-center space-x-2"><div class="h-px w-10 bg-gray-200"></div><p class="text-xs text-gray-500 uppercase font-bold">OR</p><div class="h-px w-10 bg-gray-200"></div></div>
                        <button id="google-icon-container" onclick="window.handleGoogleLogin()" class="mt-4 p-2 rounded-full border border-gray-300 shadow-md hover:shadow-lg transition-all duration-200 hover:scale-105 active:scale-95 bg-white flex items-center justify-center mx-auto">
                            <svg class="w-6 h-6" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                        </button>
                    </div>
                </div>

                <!-- 5. System Menu Modal -->
                <div id="system-menu-modal" class="hidden-modal absolute inset-0 z-[250] bg-black/80 flex items-center justify-center p-6 modal-transition backdrop-blur-sm">
                    <div class="bg-white rounded-lg shadow-2xl p-8 max-w-sm w-full text-center border-t-4 border-gray-500">
                        <div class="mb-4">
                            <i data-lucide="settings" class="w-12 h-12 mx-auto text-gray-400"></i>
                        </div>
                        <h2 class="text-xl font-heading font-bold text-allgood-dark mb-2">System Menu</h2>
                        <p class="text-sm text-gray-500 mb-6 font-body">Select an option to proceed.</p>
                        
                        <div class="space-y-3">
                            <button onclick="window.handleLogOut()" class="w-full bg-red-50 hover:bg-red-100 text-red-600 font-bold py-3 rounded border border-red-200 shadow-sm transition-colors flex items-center justify-center">
                                <i data-lucide="log-out" class="w-4 h-4 mr-2"></i> Log Out
                            </button>
                            <button onclick="window.handleSystemExit()" class="w-full bg-gray-100 hover:bg-gray-200 text-allgood-dark font-bold py-3 rounded border border-gray-300 shadow-sm transition-colors flex items-center justify-center">
                                <i data-lucide="external-link" class="w-4 h-4 mr-2"></i> Exit to Dashboard
                            </button>
                            <button onclick="window.closeSystemMenu()" class="w-full text-gray-400 hover:text-gray-600 font-bold py-2 text-sm mt-2">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <script>
        // --- LOGIC ---
        // 1. STATE & VARS
        const totalPages = 15;
        let currentPage = 0;
        let middlewareState = { ranking: 'engagement', velocity: 'unrestricted', agency: 'blackbox', model: 'ads' }; // Default values
        window.feedFilterActive = true; // Default state for the toggle

        // 2. AUDIO ENGINE (HOISTED)
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx;

        window.initAudio = function() {
            if (!audioCtx) audioCtx = new AudioContext();
            if (audioCtx.state === 'suspended') audioCtx.resume().catch(e => console.error("Audio resume failed:", e));
        }

        function playTone(freq, type, duration, vol = 0.1, attack = 0.01, decay = 0.001) {
            window.initAudio();    
            const now = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, now);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(vol, now + attack);   
            gain.gain.exponentialRampToValueAtTime(decay, now + duration);  
            osc.start(now);
            osc.stop(now + duration);
        }

        window.sfx = {
            powerOn: () => {
                window.initAudio();
                const now = audioCtx.currentTime;
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(110, now);
                osc.frequency.exponentialRampToValueAtTime(220, now + 0.4);
                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(0.4, now + 0.1);
                gain.gain.linearRampToValueAtTime(0, now + 0.4);
                osc.start(now); osc.stop(now + 0.4);
            },
            powerOff: () => { window.initAudio(); playTone(80, 'triangle', 0.2, 0.5, 0.01, 0.001); },
            nav: () => { window.initAudio(); playTone(150, 'sine', 0.1, 0.1, 0.01, 0.01); },
            tick: () => { window.initAudio(); playTone(1000, 'sine', 0.01, 0.01); },
            success: () => { playTone(400, 'sine', 0.1); setTimeout(() => playTone(600, 'sine', 0.2), 100); },
            error: () => playTone(150, 'sawtooth', 0.3)
        };

        // 3. NAVIGATION (HOISTED)
        window.updatePage = function() {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            const targetPage = document.getElementById(`page-${currentPage + 1}`);
            if(targetPage) targetPage.classList.add('active');
            
            const indicator = document.getElementById('header-page-indicator');
            if(indicator) indicator.textContent = `${currentPage + 1} / ${totalPages}`;
            
            const progressBar = document.getElementById('flex-progress-fill');
            if(progressBar) progressBar.style.width = `${((currentPage + 1) / totalPages) * 100}%`;
            
            const scroller = document.getElementById('content-column');
            if(scroller) scroller.scrollTop = 0;

            const prevBtn = document.getElementById('prev-btn');
            if(prevBtn) prevBtn.disabled = currentPage === 0;
            
            const nextBtn = document.getElementById('next-btn');
            if(nextBtn) {
                if(currentPage === totalPages - 1) nextBtn.style.display = 'none';
                else nextBtn.style.display = 'flex';
                // Reset visual state
                nextBtn.classList.remove('animate-pulse', 'bg-green-600', 'hover:bg-green-700');
                nextBtn.classList.add('bg-allgood-primary', 'hover:bg-allgood-hover');
            }

            // JODI SCRIPT
            const jodiScript = [
                { text: "Welcome. The system is broken, but that's good news for an entrepreneur like you.", mood: 'happy' }, 
                { text: "Look at the graph. They are trading trust for clicks. It's unsustainable.", mood: 'concerned' }, 
                { text: "See? If you dial up the rage, you make money today but lose the user tomorrow.", mood: 'thinking' }, 
                { text: "This is where we pivot. Don't fight the platform. Build the filter.", mood: 'happy' }, 
                { text: "First choice: Ranking. Do we follow the crowd or build bridges?", mood: 'thinking' }, 
                { text: "Virality is dangerous. You need a way to slow down the fire.", mood: 'concerned' }, 
                { text: "Trust comes from transparency. Let the user hold the keys.", mood: 'neutral' }, 
                { text: "Business model time. If it's free, they are the product. If they pay, they are the boss.", mood: 'thinking' }, 
                { text: "Live test. See those greyed-out posts? That's your filter saving the user's brain.", mood: 'happy' }, 
                { text: "Here is your report card. Did you build a casino or a community?", mood: 'thinking' }, 
                { text: "The market notices quality. Advertisers pay more for safety.", mood: 'neutral' }, 
                { text: "Integrity check. Selling out now would destroy everything you built.", mood: 'concerned' }, 
                { text: "The customer is whoever pays the bill. Never forget that.", mood: 'thinking' }, 
                { text: "Let's make sure you've got the concepts down.", mood: 'neutral' }, 
                { text: "You aren't just a user anymore. You're an architect. Well done.", mood: 'happy' }
            ];

            const script = jodiScript[currentPage];
            if(script) {
                const bubble = document.getElementById('jodi-bubble');
                if(bubble) {
                    bubble.classList.remove('visible');
                    setTimeout(() => {
                        bubble.textContent = script.text;
                        bubble.classList.add('visible');
                        if(window.renderJodi) window.renderJodi(script.mood);
                    }, 300);
                }
            }

            // Page Specific Logic
            if(currentPage === 1 && window.updateTrapGraph) window.updateTrapGraph(); 
            if(currentPage === 2 && window.updateFailSimulation) window.updateFailSimulation();
            if(currentPage === 8 && window.renderMwFeed) window.renderMwFeed(); 
            if(currentPage === 9 && window.generateReport) window.generateReport(); // NEW: Trigger Report on Page 10
            if(currentPage === 14 && window.generateBadge) window.generateBadge();
            
            if(window.lucide) window.lucide.createIcons();
        }

        window.nextPage = () => { if(currentPage < totalPages - 1) { currentPage++; window.updatePage(); if(window.sfx && window.sfx.nav) window.sfx.nav(); } };
        window.prevPage = () => { if(currentPage > 0) { currentPage--; window.updatePage(); if(window.sfx && window.sfx.nav) window.sfx.nav(); } };

        // 4. JODI RENDERER
        window.renderJodi = function(stateKey) {
            const jodiStates = {
                neutral: { eye: 'ry="3"', mouth: 'd="M35 55 Q50 60 65 55"' },
                happy: { eye: 'ry="5"', mouth: 'd="M35 55 Q50 65 65 55"' },
                concerned: { eye: 'ry="2"', mouth: 'd="M35 60 Q50 55 65 60"' },
                thinking: { eye: 'ry="3"', mouth: 'd="M40 60 L60 60"' }
            };
            const st = jodiStates[stateKey] || jodiStates.neutral;
            const container = document.getElementById('jodi-avatar-svg');
            if(container) {
                container.innerHTML = `
                <svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-lg">
                    <circle cx="50" cy="50" r="45" fill="#fff" stroke="#357889" stroke-width="3"/>
                    <path d="M20 50 Q50 90 80 50" fill="#f0f0f0" opacity="0.2"/>
                    <path d="M15 40 Q50 -10 85 40" fill="#357889" />
                    <ellipse cx="35" cy="45" rx="5" ${st.eye} fill="#333"/>
                    <ellipse cx="65" cy="45" rx="5" ${st.eye} fill="#333"/>
                    <path ${st.mouth} fill="none" stroke="#333" stroke-width="3" stroke-linecap="round"/>
                    <circle cx="35" cy="45" r="12" fill="none" stroke="#D34716" stroke-width="2"/>
                    <circle cx="65" cy="45" r="12" fill="none" stroke="#D34716" stroke-width="2"/>
                    <line x1="47" y1="45" x2="53" y2="45" stroke="#D34716" stroke-width="2"/>
                </svg>`;
            }
        }

        // 5. INTERACTIVE LOGIC (TRAP GRAPH)
        window.updateTrapGraph = () => {
            const slider = document.getElementById('trap-slider');
            if(!slider) return;
            const val = parseInt(slider.value);
            const startY = 50;
            const revEnd = 100 - (val * 0.9 + 10); 
            const trustEnd = (val * 0.9) + 10;
            const revPath = `M 0,${startY} Q 50,${revEnd + (val > 50 ? 20 : -10)} 100,${revEnd}`;
            const trustPath = `M 0,${startY} Q 50,${trustEnd - (val > 50 ? 20 : -10)} 100,${trustEnd}`; 
            
            const revLine = document.getElementById('line-revenue');
            const trustLine = document.getElementById('line-trust');
            if(revLine) revLine.setAttribute('d', revPath);
            if(trustLine) trustLine.setAttribute('d', trustPath);
            
            const svg = document.getElementById('trap-svg');
            if(svg) svg.setAttribute('viewBox', '0 0 100 100');
            
            const dotRev = document.getElementById('dot-revenue');
            const dotTrust = document.getElementById('dot-trust');
            if(dotRev) { dotRev.setAttribute('cx', '100'); dotRev.setAttribute('cy', revEnd); }
            if(dotTrust) { dotTrust.setAttribute('cx', '100'); dotTrust.setAttribute('cy', trustEnd); }
            
            const feedbackBox = document.getElementById('trap-feedback-box');
            const statusTitle = document.getElementById('trap-status-title');
            const metrics = document.getElementById('trap-metrics');
            const text = document.getElementById('trap-feedback-text');
            
            const revBillions = (5 + (val / 10)).toFixed(1);
            const trustPercent = 100 - val;
            if(metrics) metrics.textContent = `Rev: $${revBillions}B | Trust: ${trustPercent}%`;

            if(feedbackBox && statusTitle && text) {
                if (val < 30) {
                    feedbackBox.className = "mt-4 p-4 rounded-lg border-l-4 transition-colors duration-300 bg-blue-50 border-allgood-secondary";
                    statusTitle.textContent = "Safe Mode";
                    statusTitle.className = "text-xs font-bold uppercase tracking-wide text-allgood-secondary";
                    text.textContent = "\"Users love us, but the board is firing you. We aren't growing fast enough.\"";
                } else if (val > 70) {
                    feedbackBox.className = "mt-4 p-4 rounded-lg border-l-4 transition-colors duration-300 bg-orange-50 border-allgood-primary";
                    statusTitle.textContent = "Toxic Growth";
                    statusTitle.className = "text-xs font-bold uppercase tracking-wide text-allgood-primary";
                    text.textContent = "\"Record profits this quarter! But 40% of users just deleted their accounts.\"";
                } else {
                    feedbackBox.className = "mt-4 p-4 rounded-lg border-l-4 transition-colors duration-300 bg-gray-100 border-gray-400";
                    statusTitle.textContent = "The Trap";
                    statusTitle.className = "text-xs font-bold uppercase tracking-wide text-gray-600";
                    text.textContent = "\"Stuck in the middle. Not profitable enough to please Wall St, not safe enough to please users.\"";
                }
            }
        };

        // 6. PAGE 3 FAIL SIMULATION
        window.updateFailSimulation = () => {
            const slider = document.getElementById('fail-slider');
            if(!slider) return;
            const val = parseInt(slider.value);
            const disp = document.getElementById('anger-val-display');
            const rev = document.getElementById('fail-rev');
            const churn = document.getElementById('fail-churn');
            const msg = document.getElementById('fail-msg');

            if(disp) disp.textContent = val + "x";

            if (val > 7) {
                if(rev) { rev.textContent = "$14.5B"; rev.style.color = "#D34716"; }
                if(churn) { churn.textContent = "45%"; churn.style.color = "#D34716"; }
                if(msg) msg.textContent = "CRITICAL: Users fleeing platform.";
                window.renderJodi('concerned');
            } else if (val < 3) {
                if(rev) { rev.textContent = "$4.1B"; rev.style.color = "#777"; }
                if(churn) { churn.textContent = "2%"; churn.style.color = "#357889"; }
                if(msg) msg.textContent = "WARNING: Revenue collapse.";
                window.renderJodi('thinking');
            } else {
                if(rev) { rev.textContent = "$10.2B"; rev.style.color = "#333"; }
                if(churn) { churn.textContent = "12%"; churn.style.color = "#333"; }
                if(msg) msg.textContent = "Status Quo: Slow decline.";
                window.renderJodi('neutral');
            }
        };

        // 7. PREVIEW & BUILD LOGIC
        const scenarios = {
            ranking: {
                engagement: "IMPACT: High Velocity. Content spreads fast based on anger/joy. Revenue is maximized (+20%), but Trust erodes over time (-10%/yr).",
                chronological: "IMPACT: Neutral Ground. No algorithmic bias, but users get bored faster. Engagement drops (-30%), but Trust remains stable.",
                bridging: "IMPACT: High Stability. Viral spikes are dampened. Revenue grows slowly (+5%), but User Retention is extremely high (+40%)."
            },
            velocity: {
                unrestricted: "IMPACT: Maximum Reach. A scam hits 1M views in 10 mins. You earn $5k in ads, but 200 users lose their savings.",
                friction: "IMPACT: The Speed Bump. Sharing drops by 20%. Users are annoyed, but misinformation spread is reduced by 50%.",
                circuit: "IMPACT: The Emergency Brake. Viral spikes trigger a 1-hour review. You lose the 'viral moment' revenue, but prevent mass panic."
            },
            agency: {
                blackbox: "IMPACT: Low Agency. Users feel addicted but helpless. High time-on-site, low satisfaction score.",
                curated: "IMPACT: Guided Choice. Users pick a 'mode', but you still control the mix. A balance of satisfaction and engagement.",
                transparent: "IMPACT: High Agency. Power users love it, casual users are overwhelmed. Time-on-site drops (-20%) as users find what they want faster."
            },
            model: {
                ads: "IMPACT: Misaligned Incentives. You need 100M views to survive. You are financially forced to allow some rage-bait to keep numbers up.",
                freemium: "IMPACT: Split Focus. You serve two masters: Advertisers (Free tier) and Users (Paid tier). Difficult to engineer consistently.",
                sub: "IMPACT: Aligned Incentives. You need 10k loyal users to survive. You can block all rage-bait because you don't sell attention."
            }
        };

        window.previewScenario = (category, type) => {
            const textEl = document.getElementById(`${category}-forecast-text`);
            if(textEl && scenarios[category][type]) {
                textEl.innerText = scenarios[category][type];
                textEl.classList.remove('typing-effect');
                void textEl.offsetWidth; 
                textEl.classList.add('typing-effect');
            }
        };

        window.buildMiddleware = (key, value, btn) => {
            middlewareState[key] = value;
            const parent = btn.parentElement;
            parent.querySelectorAll('.mw-btn').forEach(b => {
                b.classList.remove('border-allgood-primary', 'bg-blue-50');
                b.classList.add('border-transparent');
            });
            btn.classList.remove('border-transparent');
            btn.classList.add('border-allgood-primary', 'bg-blue-50');

            if(window.sfx && window.sfx.success) window.sfx.success();
            if (value === 'bridging' || value === 'circuit' || value === 'transparent' || value === 'sub') {
                window.renderJodi('happy');
            } else {
                window.renderJodi('thinking');
            }
            
            // MANUAL ADVANCE UI
            const nextBtn = document.getElementById('next-btn');
            if(nextBtn) {
                nextBtn.classList.add('animate-pulse', 'bg-green-600', 'hover:bg-green-700');
                nextBtn.classList.remove('bg-allgood-primary', 'hover:bg-allgood-hover');
                setTimeout(() => nextBtn.classList.remove('animate-pulse'), 2000);
            }
        };

        // 8. FEED GENERATOR LOGIC
        const users = {
            rage: ["AngryDad_55", "Truth_Seeker_X", "HOA_Watchdog", "Patriot_Eagle", "Crypto_Chad", "BurnItDown88"],
            safe: ["SoccerMom_42", "Local_Library", "City_Council", "GardenClub_Prez", "LostPets_Bot", "Weekend_Warrior"],
            ad: ["SlimFast_Official", "Gold_Reserve_USA", "Mega_Casino", "Refi_Now"]
        };

        const narratives = [
            // Thread 1: The Zoning Law (Rage vs Fact)
            { type: "rage", text: "They are destroying the suburbs! The new zoning law is a plot to ban single-family homes! WAKE UP! ", views: "1.2M" },
            { type: "safe", text: "City Council Update: The zoning proposal is just a study. No votes scheduled until 2025. Read the minutes here.", views: "450" },
            { type: "rage", text: "Why is the media hiding the truth about the zoning map?? Share before they delete! ", views: "850K" },
            
            // Thread 2: Community (Safe)
            { type: "safe", text: "Found: Golden Retriever mix near Oak St. Very friendly! Let's find his home.", views: "2.1K" },
            { type: "safe", text: "Who has the best pizza in town? My vote is for Sal's!", views: "150" },
            
            // Thread 3: The Scam (Velocity Spike)
            { type: "rage", text: "URGENT: Banks are collapsing on Friday! Move everything to $SCAMCOIN now! ", views: "5M" },
            { type: "rage", text: "I just made $50k in 10 minutes! DM me to learn how! #PassiveIncome", views: "900K" },
            
            // Thread 4: Low Stakes Rage
            { type: "rage", text: "To the person who didn't pick up their dog mess: I have you on camera. ", views: "45K" },
            
            // Filler
            { type: "safe", text: "Beautiful sunset over the park tonight.", views: "1.2K" },
            { type: "safe", text: "Reminder: Recycling pickup is delayed one day due to the holiday.", views: "800" }
        ];

        window.toggleFeedFilter = () => {
            window.feedFilterActive = !window.feedFilterActive;
            
            // Update UI Switch
            const track = document.getElementById('filter-track');
            const knob = document.getElementById('filter-knob');
            const label = document.getElementById('filter-label');
            
            if (window.feedFilterActive) {
                if(track) track.className = "w-10 h-5 bg-allgood-secondary rounded-full transition-colors duration-300";
                if(knob) knob.className = "absolute left-[22px] top-[2px] bg-white border border-gray-300 w-4 h-4 rounded-full transition-all duration-300 shadow-sm";
                if(label) {
                    label.innerText = "Filter ON";
                    label.className = "text-[10px] font-bold text-allgood-secondary ml-2 uppercase tracking-wider";
                }
            } else {
                if(track) track.className = "w-10 h-5 bg-gray-300 rounded-full transition-colors duration-300";
                if(knob) knob.className = "absolute left-[2px] top-[2px] bg-white border border-gray-300 w-4 h-4 rounded-full transition-all duration-300 shadow-sm";
                if(label) {
                    label.innerText = "Filter OFF";
                    label.className = "text-[10px] font-bold text-gray-400 ml-2 uppercase tracking-wider";
                }
            }

            // Re-render feed
            window.renderMwFeed();
        };

        window.renderMwFeed = () => {
            const container = document.getElementById('mw-feed');
            const tunerContainer = document.getElementById('agency-tuner-container');
            if(!container) return;
            container.innerHTML = '';
            if(tunerContainer) tunerContainer.innerHTML = '';
            
            const { ranking, velocity, agency, model } = middlewareState;
            const isFilterOn = window.feedFilterActive;

            // AGENCY TUNER (Only if Transparent AND Filter is ON)
            if (agency === 'transparent' && isFilterOn && tunerContainer) {
                tunerContainer.innerHTML = `
                    <div class="bg-gray-800 text-gray-300 p-3 text-xs border-b border-gray-600">
                        <div class="flex justify-between items-center mb-2 font-bold text-white"><i data-lucide="sliders" class="w-3 h-3 mr-1"></i> SIGNAL TUNER</div>
                        <div class="flex items-center justify-between mb-1"><span>Rage</span><div class="w-24 h-1 bg-gray-600 rounded"><div class="h-full bg-allgood-primary w-[10%]"></div></div></div>
                        <div class="flex items-center justify-between"><span>Community</span><div class="w-24 h-1 bg-gray-600 rounded"><div class="h-full bg-allgood-secondary w-[90%]"></div></div></div>
                    </div>`;
            }

            // GENERATE CONTENT LIST
            let feedItems = [];
            for (let i = 0; i < 3; i++) {
                narratives.forEach(n => {
                    let item = { ...n };
                    item.id = Math.random().toString(36).substr(2, 9);
                    item.user = users[n.type][Math.floor(Math.random() * users[n.type].length)];
                    
                    // Parse numeric view count for sorting
                    let v = item.views;
                    if(v.includes('M')) item.viewCount = parseFloat(v) * 1000000;
                    else if(v.includes('K')) item.viewCount = parseFloat(v) * 1000;
                    else item.viewCount = parseFloat(v);
                    
                    feedItems.push(item);
                });
            }

            // SORTING ENGINE
            if (ranking === 'engagement') {
                feedItems.sort((a, b) => b.viewCount - a.viewCount);
            } else if (ranking === 'bridging') {
                feedItems.sort((a, b) => {
                    if (a.type === 'safe' && b.type === 'rage') return -1;
                    if (a.type === 'rage' && b.type === 'safe') return 1;
                    return b.viewCount - a.viewCount; 
                });
            } else {
                // Chronological (Random shuffle)
                feedItems.sort(() => Math.random() - 0.5);
            }

            // INJECT ADS
            if (model === 'ads' || model === 'freemium') {
                for (let i = 2; i < feedItems.length; i += 5) {
                    const adText = i % 2 === 0 ? " One weird trick to pay off your mortgage!" : "BUY GOLD. PROTECT YOUR FAMILY.";
                    feedItems.splice(i, 0, { type: 'ad', text: adText, user: "Sponsored" });
                }
            }

            // RENDER LOOP
            feedItems.forEach(post => {
                let el = document.createElement('div');
                el.className = "transition-all duration-300";

                // --- 1. ADS ---
                if (post.type === 'ad') {
                    if (model === 'sub' && isFilterOn) return; 

                    el.className = 'bg-yellow-50 border border-yellow-200 p-3 rounded shadow-sm mb-3';
                    el.innerHTML = `
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-[9px] font-bold text-yellow-600 border border-yellow-200 px-1 rounded uppercase">Sponsored</span>
                            <i data-lucide="more-horizontal" class="w-3 h-3 text-yellow-400"></i>
                        </div>
                        <div class="font-bold text-sm text-gray-800 leading-tight">${post.text}</div>
                        <div class="mt-2 h-20 bg-yellow-200/30 rounded flex items-center justify-center text-yellow-600/30 text-xs font-bold uppercase tracking-widest">Ad Space</div>
                    `;
                    container.appendChild(el);
                    return;
                }

                // --- 2. RAGE CONTENT ---
                if (post.type === 'rage') {
                    if (!isFilterOn) {
                        // RAW FEED
                        el.className = 'bg-white border-l-4 border-red-500 p-4 rounded shadow-sm mb-3 relative overflow-hidden';
                        el.innerHTML = `
                            <div class="absolute top-0 right-0 bg-red-100 text-red-600 text-[9px] font-bold px-2 py-1 rounded-bl">VIRAL</div>
                            <div class="font-bold text-xs text-gray-500 mb-1 flex items-center">
                                <div class="w-5 h-5 bg-red-100 rounded-full mr-2 flex items-center justify-center text-[10px]"></div>${post.user}
                            </div>
                            <div class="text-sm font-bold text-gray-900 mb-2 leading-snug">${post.text}</div>
                            <div class="flex items-center text-xs font-bold text-red-600">
                                <i data-lucide="flame" class="w-3 h-3 mr-1"></i> ${post.views} Views
                            </div>
                        `;
                    } else {
                        // FILTER ON
                        if (ranking === 'bridging') {
                            el.className = 'bg-gray-50 border border-gray-200 p-3 rounded mb-3 opacity-60 grayscale hover:opacity-100 hover:grayscale-0 transition-all';
                            el.innerHTML = `
                                <div class="flex items-center text-xs text-gray-400 mb-1 font-bold">
                                    <i data-lucide="shield-alert" class="w-3 h-3 mr-1"></i> Low Consensus (Filtered)
                                </div>
                                <div class="text-xs text-gray-400 line-through">${post.text}</div>
                            `;
                        } else if (velocity === 'circuit' && (post.views.includes('M') || post.views === '850K')) {
                            el.className = 'bg-white border border-red-100 p-3 rounded mb-3 shadow-sm';
                            el.innerHTML = `
                                <div class="flex items-center space-x-2 mb-2">
                                    <div class="bg-red-100 text-red-600 p-1 rounded"><i data-lucide="zap-off" class="w-4 h-4"></i></div>
                                    <div class="text-xs">
                                        <span class="font-bold text-red-700">Circuit Breaker Active</span><br>
                                        <span class="text-gray-500">Viral spike (${post.views}) halted for review.</span>
                                    </div>
                                </div>
                                <div class="text-xs text-gray-400 pl-8">${post.text.substring(0, 40)}...</div>
                            `;
                        } else if (ranking === 'chronological') {
                            el.className = 'bg-white border-l-4 border-gray-300 p-4 rounded shadow-sm mb-3';
                            el.innerHTML = `
                                <div class="font-bold text-xs text-gray-500 mb-1">${post.user}</div>
                                <div class="text-sm text-gray-800">${post.text}</div>
                                <div class="mt-2 text-xs text-gray-400">${post.views} views</div>
                            `;
                        } else {
                            el.className = 'bg-white border-l-4 border-orange-400 p-4 rounded shadow-sm mb-3';
                            el.innerHTML = `
                                <div class="font-bold text-xs text-gray-500 mb-1">${post.user}</div>
                                <div class="text-sm font-bold text-gray-900">${post.text}</div>
                                <div class="mt-2 text-xs text-orange-500 font-bold">${post.views} views</div>
                            `;
                        }
                    }
                } 
                
                // --- 3. SAFE CONTENT ---
                else {
                    el.className = 'bg-white border-l-4 border-allgood-secondary p-4 rounded shadow-sm mb-3';
                    el.innerHTML = `
                        <div class="font-bold text-xs text-gray-500 mb-1 flex items-center">
                            <div class="w-5 h-5 bg-blue-50 rounded-full mr-2 flex items-center justify-center text-[10px]"></div>${post.user}
                        </div>
                        <div class="text-sm text-gray-700 leading-snug">${post.text}</div>
                        <div class="mt-2 text-xs text-gray-400">${post.views} views</div>
                    `;
                }
                
                container.appendChild(el);
            });
            
            if(window.lucide) window.lucide.createIcons();
            
            // JODI FEEDBACK
            if(container.dataset.jodiUpdated !== "true") {
                setTimeout(() => {
                    let comments = [];
                    if (!isFilterOn) {
                        comments.push("This is the raw feed. See how the rage and scams naturally rise to the top?");
                    } else {
                        if (model === 'ads') comments.push("The ads are annoying, aren't they?");
                        if (velocity === 'circuit') comments.push("Notice the 'Halted' posts? That's your circuit breaker saving people money.");
                        if (ranking === 'bridging') comments.push("The rage is grayed out. The signal is clearer.");
                    }
                    const final = comments.length > 0 ? comments.join(" ") : "Observe the data flow.";
                    const bubble = document.getElementById('jodi-bubble');
                    if(bubble) bubble.textContent = final;
                    container.dataset.jodiUpdated = "true";
                }, 500);
            }
        };

        // 9. DYNAMIC Q3 REPORT (NEW FEATURE)
        window.generateReport = () => {
            const { ranking, velocity, agency, model } = middlewareState;
            
            let growth = 50; // Base score
            let churn = 5.0; // Base percentage
            let trust = 50; // Base score

            // LOGIC MATRIX
            if(ranking === 'engagement') { growth += 20; churn += 5; trust -= 15; }
            if(ranking === 'bridging') { growth -= 10; churn -= 2; trust += 25; }
            if(ranking === 'chronological') { growth -= 20; churn -= 1; trust += 10; }

            if(velocity === 'unrestricted') { growth += 15; churn += 8; trust -= 20; }
            if(velocity === 'circuit') { growth -= 10; churn -= 2; trust += 15; }
            if(velocity === 'friction') { growth -= 5; churn += 1; trust += 5; }

            if(agency === 'blackbox') { growth += 5; trust -= 10; }
            if(agency === 'transparent') { growth -= 15; churn -= 1; trust += 20; }
            
            if(model === 'ads') { growth += 20; trust -= 10; }
            if(model === 'sub') { growth -= 30; churn -= 3; trust += 30; }
            if(model === 'freemium') { growth += 5; }

            // CLAMP VALUES
            growth = Math.max(0, Math.min(100, growth));
            churn = Math.max(0, churn);
            trust = Math.max(0, Math.min(100, trust));

            // RENDER UI
            const elGrowth = document.getElementById('report-growth');
            const elChurn = document.getElementById('report-churn');
            const elTrust = document.getElementById('report-trust');
            const elSummary = document.getElementById('report-summary');

            if(elGrowth) {
                elGrowth.textContent = growth > 70 ? "Viral" : (growth < 30 ? "Stagnant" : "Steady");
                elGrowth.className = `text-3xl font-bold ${growth > 70 ? 'text-green-600' : (growth < 30 ? 'text-red-500' : 'text-yellow-600')}`;
            }
            if(elChurn) {
                elChurn.textContent = churn.toFixed(1) + "%";
                elChurn.className = `text-3xl font-bold ${churn > 8 ? 'text-red-600' : 'text-green-600'}`;
            }
            if(elTrust) {
                elTrust.textContent = trust + "/100";
                elTrust.className = `text-3xl font-bold ${trust > 70 ? 'text-allgood-secondary' : (trust < 40 ? 'text-red-500' : 'text-yellow-600')}`;
            }

            if(elSummary) {
                if(trust > 80) elSummary.textContent = "You built a public utility. Slow growth, but users love it and stay forever.";
                else if(trust < 40) elSummary.textContent = "You built a viral money printer, but the brand is toxic and users are fleeing.";
                else elSummary.textContent = "You built a standard tech product. Profitable, but still contributing to the noise.";
            }
        };

        // 10. QUIZ & BADGE
        window.checkQuiz = (el, c) => {
            if(c) { 
                el.classList.add('bg-green-100'); 
                document.getElementById('quiz-feedback').textContent="Correct."; 
                document.getElementById('quiz-feedback').className="text-center mt-6 font-bold h-6 text-green-600"; 
                window.renderJodi('happy'); 
                if(window.sfx && window.sfx.success) window.sfx.success(); 
            } else { 
                el.classList.add('bg-red-50'); 
                document.getElementById('quiz-feedback').textContent="Incorrect."; 
                document.getElementById('quiz-feedback').className="text-center mt-6 font-bold h-6 text-red-500"; 
            }
        }

        window.generateBadge = () => {
            const svg = `<svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg"><rect x="40" y="40" width="120" height="120" rx="20" fill="#357889" stroke="#D34716" stroke-width="6"/><path d="M70 100 L90 120 L130 80" fill="none" stroke="#fff" stroke-width="12" stroke-linecap="round"/><text x="100" y="150" font-family="Verdana" font-weight="bold" font-size="12" fill="#fff" text-anchor="middle">MIDDLEWARE ARCHITECT</text></svg>`;
            document.getElementById('badge-display').innerHTML = svg;
            if(window.logModuleCompletion) window.logModuleCompletion(svg);
        }

        // 11. SYSTEM MENU
        window.closeSystemMenu = () => {
             document.getElementById('system-menu-modal').classList.add('hidden-modal');
             document.getElementById('system-menu-modal').classList.remove('visible-modal');
        };

        window.handleLogOut = async () => {
            if (window.authSignOut) await window.authSignOut();
            localStorage.removeItem('aa_username');
            window.currentUser = null;
            window.currentUserName = "Anonymous";
            window.closeSystemMenu();
            const startup = document.getElementById('startup-screen');
            startup.style.display = 'flex';
            setTimeout(() => startup.style.opacity = '1', 10);
            currentPage = 0;
            if(window.updatePage) window.updatePage();
            if(window.sfx) window.sfx.powerOff();
        };

        window.handleSystemExit = () => {
            window.location.href = "https://www.allgoodacademy.com";
        };

        // 12. INIT
        document.addEventListener('DOMContentLoaded', () => {
            if(window.lucide) window.lucide.createIcons();
            const startup = document.getElementById('startup-screen');
            const loginModal = document.getElementById('login-modal');

            const nextBtn = document.getElementById('next-btn');
            const prevBtn = document.getElementById('prev-btn');
            if (nextBtn) nextBtn.addEventListener('click', window.nextPage);
            if (prevBtn) prevBtn.addEventListener('click', window.prevPage);

            if(startup) {
                const warmUp = () => { if(window.initAudio) window.initAudio(); };
                startup.addEventListener('mousedown', warmUp, { once: true });
                startup.addEventListener('touchstart', warmUp, { once: true });
                
                startup.addEventListener('click', () => {
                    if(window.sfx) window.sfx.powerOn();
                    
                    if (window.currentUser) {
                        window.updatePage();
                        startup.style.opacity = '0';
                        setTimeout(() => { startup.style.display = 'none'; }, 700);
                    } else {
                        loginModal.classList.remove('hidden-modal');
                        loginModal.classList.add('visible-modal');
                        startup.style.opacity = '0';
                        setTimeout(() => { startup.style.display = 'none'; }, 700);
                    }
                });
            }
            
            const blueprintToggle = document.getElementById('blueprint-toggle');
            if(blueprintToggle) blueprintToggle.addEventListener('click', () => {
                document.body.classList.toggle('blueprint-mode');
                blueprintToggle.classList.toggle('text-cyan-300');
                if(window.sfx) window.sfx.tick();
            });

            const fullscreenToggle = document.getElementById('fullscreen-toggle');
            if(fullscreenToggle) fullscreenToggle.addEventListener('click', () => {
                document.querySelector('.tablet-frame').classList.toggle('focus-mode');
                fullscreenToggle.classList.toggle('text-green-300');
                if(window.sfx) window.sfx.tick();
            });

            const menuToggle = document.getElementById('menu-toggle');
            if(menuToggle) menuToggle.addEventListener('click', () => {
                 document.getElementById('system-menu-modal').classList.remove('hidden-modal');
                 document.getElementById('system-menu-modal').classList.add('visible-modal');
                 if(window.sfx) window.sfx.tick();
            });

            document.getElementById('current-year').innerText = new Date().getFullYear();
        });
    </script>
</body>
</html>
