<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Fear Setting: The Antidote</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <!-- FIREBASE SETUP -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, updateProfile, signOut, GoogleAuthProvider, signInWithPopup, setPersistence, browserLocalPersistence } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, serverTimestamp, getDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "AIzaSyAf2SO8xovrApl52udUUoR1n9WBnERr_ko", authDomain: "allgood-academy.firebaseapp.com", projectId: "allgood-academy" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'allgood-academy';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // PERSISTENCE FIX
        setPersistence(auth, browserLocalPersistence).catch(console.error);

        window.auth = auth;
        window.db = db;
        window.authSignOut = () => signOut(auth);

        window.currentUser = null;
        window.currentUserName = "Learner";
        window.sessionId = "session_" + Date.now() + "_" + Math.floor(Math.random() * 1000);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                window.currentUser = user;
                let finalName = user.displayName || localStorage.getItem('aa_username') || "Learner";
                if (finalName === "Learner") {
                    try {
                        const userDoc = await getDoc(doc(db, 'artifacts', appId, 'users', user.uid));
                        if (userDoc.exists() && userDoc.data().displayName) finalName = userDoc.data().displayName;
                    } catch(e) {}
                }
                window.currentUserName = finalName;
                document.getElementById('header-welcome-text').textContent = `Welcome: ${finalName}`;
                
                const loginModal = document.getElementById('login-modal');
                if (loginModal && !loginModal.classList.contains('hidden-modal')) {
                    loginModal.classList.add('hidden-modal');
                    loginModal.classList.remove('visible-modal');
                    window.logFinalScoreToFirestore({ rank: "Session Resumed", sessionId: window.sessionId });
                    if(window.restoreState) window.restoreState();
                }
            }
        });

        window.ensureUserContainer = async (user, name, email) => {
             try {
                 await setDoc(doc(db, 'artifacts', appId, 'users', user.uid), {
                     displayName: name, email: email || null, lastLogin: serverTimestamp(), lastActiveModule: document.title
                 }, { merge: true });
             } catch (e) { console.error(e); }
        }

        window.logFinalScoreToFirestore = async (data) => {
            const user = auth.currentUser;
            if (!user) return;
            try {
                await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'game_scores', window.sessionId), {
                    gameName: document.title, ...data, lastUpdated: serverTimestamp(), user: { uid: user.uid, displayName: window.currentUserName }
                }, { merge: true });
            } catch (e) { console.error(e); }
        }

        window.handleGuestLogin = async () => {
            const name = document.getElementById('user-name-input').value.trim() || "Learner";
            const btn = document.getElementById('btn-guest-login');
            btn.innerText = "Connecting..."; btn.disabled = true;
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                else if (!auth.currentUser) await signInAnonymously(auth);
                
                const user = auth.currentUser;
                await updateProfile(user, { displayName: name });
                await window.ensureUserContainer(user, name);
                window.currentUserName = name;
                
                document.getElementById('header-welcome-text').textContent = `Welcome: ${name}`;
                document.getElementById('login-modal').classList.add('hidden-modal');
                document.getElementById('login-modal').classList.remove('visible-modal');
                window.logFinalScoreToFirestore({ rank: "Session Started", sessionId: window.sessionId });
                if(window.showPage) window.showPage(0);
                if(window.sfx) window.sfx.nav();
            } catch (e) { console.error(e); alert("Login failed."); } 
            finally { btn.innerText = "Start Mission"; btn.disabled = false; }
        };
        
        window.handleGoogleLogin = window.handleGuestLogin; // Fallback for simplicity in sandbox
    </script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 'allgood-primary': '#D34716', 'allgood-secondary': '#357889', 'allgood-dark': '#4C4C4C', 'allgood-light': '#F7F7F7', 'allgood-hover': '#EB8D69', 'allgood-accent': '#2D6473' },
                    fontFamily: { 'heading': ['Georgia', 'serif'], 'body': ['Verdana', 'sans-serif'] },
                },
            },
        }
    </script>
    
    <style>
        /* CHASSIS STYLES */
        body { font-family: Verdana, sans-serif; background-color: #1a1a1a; background-image: linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px); background-size: 20px 20px; background-attachment: fixed; min-height: 100vh; -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; }
        input, textarea { -webkit-user-select: text; user-select: text; }
        h1, h2, h3, h4, h5, h6 { font-family: Georgia, serif; }
        
        .tablet-frame { height: 80vh; width: auto; aspect-ratio: 16/10; max-width: 1100px; max-height: 95vh; background-image: radial-gradient(circle at 0% 0%, rgba(211,71,22,0.35) 0%, transparent 30%), linear-gradient(135deg, #5c5c5c 0%, #d6d6d6 25%, #8a8a8a 50%, #e0e0e0 75%, #5c5c5c 100%); border-radius: 12px; padding: 12px; border: 1px solid #333; position: relative; margin: 20px auto; box-shadow: inset 1px 1px 2px rgba(255,255,255,0.6), 0 30px 60px -12px rgba(0,0,0,0.8); transition: width 0.3s, height 0.3s; }
        .tablet-frame::before { content: ''; position: absolute; top: 10px; left: 10px; right: 10px; bottom: 10px; border-radius: 6px; background: #111; z-index: 0; }
        .screen-container { width: 100%; height: 100%; background-color: #F7F7F7; position: relative; z-index: 1; overflow: hidden; display: flex; flex-direction: column; border-radius: 4px; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); }
        .page::-webkit-scrollbar { width: 14px; }
        .page::-webkit-scrollbar-track { background: #e5e5e5; border-left: 1px solid #d1d5db; }
        .page::-webkit-scrollbar-thumb { background-color: #D34716; border-radius: 7px; border: 3px solid #e5e5e5; }
        .modal-transition { transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out; }
        .hidden-modal { opacity: 0; pointer-events: none; transform: translateY(-10px); }
        .visible-modal { opacity: 1; pointer-events: auto; transform: translateY(0); }
        #flex-progress-bar { height: 4px; width: 100%; background-color: #eee; position: absolute; top: 0; left: 0; }
        #flex-progress-fill { height: 100%; background-color: #D34716; width: 0%; transition: width 0.3s ease; }
        .blueprint-mode { background-color: #0f172a !important; color: #94a3b8 !important; }
        .blueprint-mode .page { background-color: #0f172a !important; }
        .blueprint-mode .bg-white { background-color: #1e293b !important; border-color: #334155 !important; color: #cbd5e1 !important; }
        .blueprint-mode .text-allgood-dark { color: #e2e8f0 !important; }
        @media (max-width: 768px) { html, body { position: fixed; width: 100%; height: 100dvh; overflow: hidden; background-color: #F7F7F7; } .tablet-frame { position: absolute !important; top: 0; left: 0; width: 100% !important; height: 100% !important; margin: 0 !important; padding: 0 !important; border: none !important; border-radius: 0 !important; background: #F7F7F7 !important; aspect-ratio: unset !important; } .tablet-frame::before { display: none !important; } header.navbar-content { padding-top: max(env(safe-area-inset-top), 12px); min-height: 60px; } footer.footer-content { position: absolute; bottom: 0; left: 0; width: 100%; padding-bottom: max(env(safe-area-inset-bottom), 20px); min-height: 80px; z-index: 100; background-color: white; border-top: 1px solid #e5e7eb; } .page { padding-bottom: 120px !important; } }
        .navbar-content { flex: 0 0 60px; z-index: 50; }
        .page { flex: 1 1 auto; overflow-y: auto; padding: 20px; position: relative; display: none; width: 100%; }
        .page.active { display: block; }
        .footer-content { flex: 0 0 60px; z-index: 50; background-color: white; border-top: 1px solid #e5e7eb; position: relative; }

        /* MODULE SPECIFIC STYLES */
        .blur-text { color: transparent; text-shadow: 0 0 8px rgba(0,0,0,0.5); user-select: none; transition: all 1s ease; }
        .blur-text.cleared { color: #4C4C4C; text-shadow: none; }
        .flip-card { background-color: transparent; width: 100%; height: 200px; perspective: 1000px; cursor: pointer; }
        .flip-card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; }
        .flip-card.flipped .flip-card-inner { transform: rotateY(180deg); }
        .flip-card-front, .flip-card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .flip-card-front { background-color: white; border: 1px solid #e5e7eb; }
        .flip-card-back { background-color: #357889; color: white; transform: rotateY(180deg); }
        .fear-card { transition: all 0.3s; cursor: pointer; border: 2px solid transparent; }
        .fear-card.selected { border-color: #D34716; background-color: #fff7ed; transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        
        /* Magic Wand Shimmer */
        .shimmer-card { position: relative; overflow: hidden; }
        .shimmer-card::after { content: ""; position: absolute; top: 0; right: 0; bottom: 0; left: 0; transform: translateX(-100%); background-image: linear-gradient(85deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.4) 50%, rgba(255,255,255,0) 100%); animation: shimmer 2s infinite; pointer-events: none; }
        @keyframes shimmer { 100% { transform: translateX(100%); } }

        /* Tone Dial */
        .dial-container { width: 150px; height: 150px; position: relative; margin: 0 auto; transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .dial-knob { width: 100%; height: 100%; border-radius: 50%; background: radial-gradient(circle at 30% 30%, #4C4C4C, #1a1a1a); box-shadow: 0 10px 20px rgba(0,0,0,0.3); position: relative; border: 4px solid #333; }
        .dial-marker { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); width: 4px; height: 15px; background-color: #D34716; border-radius: 2px; }

        /* Data Chip */
        .data-chip { background-color: #F3F4F6; border: 2px solid #E5E7EB; color: #9CA3AF; transition: all 0.3s; }
        .data-chip.mounted { background-color: #357889; border-color: #357889; color: white; transform: scale(0.95); box-shadow: inset 0 2px 4px rgba(0,0,0,0.2); }
        
        /* Drag Drop */
        .draggable-item { cursor: grab; transition: all 0.2s; user-select: none; }
        .draggable-item.dragging { opacity: 0.5; transform: scale(1.05); }
        .drop-zone { transition: all 0.2s; }
        .drop-zone.drag-over { background-color: #eff6ff; border-color: #357889; transform: scale(1.02); }
    </style>
</head>
<body class="flex flex-col min-h-screen text-allgood-dark font-body overflow-y-auto">

    <main class="flex-grow flex items-center justify-center py-8">
        <div class="tablet-frame">
            <div class="screen-container" id="screen">

                <!-- 1. STARTUP SCREEN -->
                <div id="startup-screen" class="absolute inset-0 z-[300] flex flex-col items-center justify-center cursor-pointer transition-opacity duration-700 ease-in-out bg-gradient-to-br from-allgood-secondary to-gray-900">
                    <div class="group flex flex-col items-center justify-center text-center h-full w-full relative">
                        <div class="flex-grow flex flex-col items-center justify-center px-4">
                            <i data-lucide="shield-alert" class="w-24 h-24 text-white mb-6 drop-shadow-lg"></i>
                            <h2 class="text-xl md:text-2xl font-heading font-bold text-gray-300 mb-1 relative z-10">Allgood Academy</h2>
                            <h1 class="text-4xl md:text-6xl font-heading font-bold text-allgood-primary tracking-tighter relative z-10 drop-shadow-md animate-pulse">Fear Setting</h1>
                            <p class="mt-8 text-white/60 text-xs tracking-[0.4em] uppercase font-bold group-hover:text-white transition-colors">Click to Begin</p>
                        </div>
                    </div>
                </div>

                <!-- 2. HEADER -->
                <header class="bg-allgood-secondary shadow-md navbar-content flex items-center">
                    <div class="w-full px-4 flex items-center justify-between h-full pt-[env(safe-area-inset-top)]">
                        <div class="flex items-center overflow-hidden">
                            <div id="header-welcome-text" class="flex-shrink-0 text-white font-heading font-bold text-lg tracking-tight truncate mr-4">Welcome: Learner</div>
                            <div class="hidden sm:flex items-center bg-black/20 rounded-full px-3 py-1 border border-white/10 shadow-inner">
                                <span class="text-[10px] uppercase tracking-wider text-white/60 mr-2 font-heading font-bold">Page</span>
                                <span id="header-page-indicator" class="text-xs font-bold text-white font-body tabular-nums">1 / 18</span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-1 shrink-0">
                            <button id="home-button" class="text-gray-200 hover:text-white p-2 rounded-full hover:bg-white/10"><i data-lucide="home" class="w-6 h-6"></i></button>
                            <div class="h-6 w-px bg-white/20 mx-1"></div>
                            <button id="blueprint-toggle" class="text-gray-200 hover:text-cyan-300 p-2 rounded-full hover:bg-white/10"><i data-lucide="moon" class="w-5 h-5"></i></button>
                            <button id="menu-toggle" class="text-gray-200 hover:text-white p-2 rounded-full hover:bg-white/10"><i data-lucide="menu" class="w-7 h-7"></i></button>
                        </div>
                    </div>
                </header>

                <!-- MENTOR BAR -->
                <div id="mentor-bar" class="w-full bg-gray-50 border-b border-gray-200 px-6 py-4 flex items-start gap-4 transition-opacity duration-300 hidden shrink-0 z-40">
                    <div class="mt-0.5 shrink-0"><i data-lucide="lightbulb" class="w-5 h-5 text-allgood-primary"></i></div>
                    <div class="flex-1"><p id="mentor-text" class="text-sm font-medium text-gray-700 leading-relaxed font-body"></p></div>
                </div>

                <!-- PAGES CONTAINER -->
                <!-- Page 1: Cover -->
                <div class="page active" id="page-1">
                    <div class="flex flex-col items-center justify-center min-h-full py-10 text-center px-6">
                        <div class="mb-6"><h2 class="text-2xl font-heading font-bold text-allgood-dark">Allgood<span class="text-allgood-primary">Academy</span></h2></div>
                        <h1 class="text-4xl sm:text-5xl font-heading font-bold text-allgood-dark mb-4 leading-tight">Fear Setting:<br><span class="text-allgood-primary">The Antidote</span></h1>
                        <p class="text-lg text-gray-600 mb-8 max-w-md italic">"We suffer more in imagination than in reality." <br>â€” Seneca</p>
                        <p class="text-sm text-allgood-primary font-bold mb-12 animate-pulse">Click Next to begin.</p>
                        
                        <div class="w-full max-w-lg text-left mx-auto">
                            <button class="accordion-toggle w-full bg-white border border-gray-200 p-4 rounded-lg shadow-md flex justify-between items-center hover:bg-gray-50 hover:border-allgood-primary transition-all group">
                                <span class="font-bold text-allgood-dark text-base group-hover:text-allgood-primary transition-colors font-heading">About this Module</span>
                                <i data-lucide="chevron-down" class="accordion-icon w-5 h-5 text-gray-400 transform transition-transform duration-300 group-hover:text-allgood-primary"></i>
                            </button>
                            <div class="accordion-content hidden bg-gray-50 border-x border-b border-gray-200 rounded-b-lg p-5 text-gray-600 shadow-inner text-xs font-body">
                                <p>You aren't stuck because the risk is too high; you're stuck because the risk is undefined. This module will help you legally define your nightmare scenario and calculate the cost of inaction.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Page 2: Biology -->
                <div class="page" id="page-2">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark">The Biology of Panic</h2></section>
                    <div class="relative w-full h-64 bg-gray-200 rounded-xl overflow-hidden mb-6">
                        <div id="fear-slider-bg" class="absolute inset-0 bg-gray-800 transition-colors duration-500"></div>
                        <div class="absolute inset-0 flex items-center justify-center text-white text-center p-4">
                            <h3 id="fear-slider-text" class="text-2xl font-bold">Fear is a STOP Sign.</h3>
                        </div>
                    </div>
                    <div class="px-8">
                        <label class="block text-center text-xs font-bold text-gray-500 mb-2">Slide to Reframe</label>
                        <input type="range" min="0" max="100" value="0" class="w-full h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer accent-allgood-primary" oninput="updateFearSlider(this.value)">
                        <div class="flex justify-between text-xs text-gray-400 mt-2"><span>Myth</span><span>Reality</span></div>
                    </div>
                </div>

                <!-- Page 3: The Fog -->
                <div class="page" id="page-3">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark">The Fog of War</h2></section>
                    <div class="bg-gray-100 p-8 rounded-lg border border-gray-300 text-center cursor-pointer hover:bg-gray-50 transition-colors" onclick="toggleBlur()">
                        <p class="mb-4 text-sm text-gray-500 uppercase font-bold tracking-widest">Tap to Clear the Fog</p>
                        <h3 class="text-3xl font-heading font-bold text-allgood-dark blur-text" id="fog-text">
                            Specific fears<br>are solvable problems.
                        </h3>
                    </div>
                </div>

                <!-- Page 4: The Method -->
                <div class="page" id="page-4">
                    <section class="mb-6 text-center"><h2 class="text-2xl font-heading font-bold text-allgood-dark">The 3-Column Method</h2></section>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="flip-card" onclick="this.classList.toggle('flipped'); sfx.tick()">
                            <div class="flip-card-inner">
                                <div class="flip-card-front"><i data-lucide="pen-tool" class="w-8 h-8 text-allgood-primary mb-2"></i><h3 class="font-bold">DEFINE</h3></div>
                                <div class="flip-card-back"><h3 class="font-bold mb-2">The Nightmare</h3><p class="text-xs">What is the absolute worst that could happen?</p></div>
                            </div>
                        </div>
                        <div class="flip-card" onclick="this.classList.toggle('flipped'); sfx.tick()">
                            <div class="flip-card-inner">
                                <div class="flip-card-front"><i data-lucide="shield" class="w-8 h-8 text-allgood-secondary mb-2"></i><h3 class="font-bold">PREVENT</h3></div>
                                <div class="flip-card-back"><h3 class="font-bold mb-2">The Shield</h3><p class="text-xs">What can I do right now to reduce the odds?</p></div>
                            </div>
                        </div>
                        <div class="flip-card" onclick="this.classList.toggle('flipped'); sfx.tick()">
                            <div class="flip-card-inner">
                                <div class="flip-card-front"><i data-lucide="wrench" class="w-8 h-8 text-green-600 mb-2"></i><h3 class="font-bold">REPAIR</h3></div>
                                <div class="flip-card-back bg-green-600"><h3 class="font-bold mb-2">The Fix</h3><p class="text-xs">If the worst happens, how do I get back to baseline?</p></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Page 5: Selector -->
                <div class="page" id="page-5">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark">Name Your Poison</h2><p class="text-sm text-gray-500">What decision is paralyzing you right now?</p></section>
                    <div class="space-y-4">
                        <div class="fear-card bg-white p-4 rounded-lg shadow-sm border border-gray-200 flex items-center gap-4" onclick="selectFear('Career')">
                            <div class="bg-blue-100 p-3 rounded-full text-blue-600"><i data-lucide="briefcase" class="w-6 h-6"></i></div>
                            <div><h3 class="font-bold text-allgood-dark">The Career Leap</h3><p class="text-xs text-gray-500">Quitting, Starting, Pivoting.</p></div>
                        </div>
                        <div class="fear-card bg-white p-4 rounded-lg shadow-sm border border-gray-200 flex items-center gap-4" onclick="selectFear('Conversation')">
                            <div class="bg-orange-100 p-3 rounded-full text-orange-600"><i data-lucide="message-circle" class="w-6 h-6"></i></div>
                            <div><h3 class="font-bold text-allgood-dark">The Hard Conversation</h3><p class="text-xs text-gray-500">Asking, Confronting, Firing.</p></div>
                        </div>
                        <div class="fear-card bg-white p-4 rounded-lg shadow-sm border border-gray-200 flex items-center gap-4" onclick="selectFear('Finance')">
                            <div class="bg-green-100 p-3 rounded-full text-green-600"><i data-lucide="dollar-sign" class="w-6 h-6"></i></div>
                            <div><h3 class="font-bold text-allgood-dark">The Financial Bet</h3><p class="text-xs text-gray-500">Investing, Buying, Selling.</p></div>
                        </div>
                    </div>
                </div>

                <!-- Page 6: Define -->
                <div class="page" id="page-6">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark">Column 1: Define</h2></section>
                    <div class="relative max-w-md mx-auto mb-6">
                        <div id="fear-weak" class="bg-gray-100 p-8 rounded-lg border-2 border-dashed border-gray-300 text-center">
                            <p class="text-xs uppercase font-bold text-gray-400 mb-4">Vague Fear</p>
                            <h3 class="text-2xl font-mono text-gray-500 mb-6" id="weak-fear-text">"It will be a disaster."</h3>
                            <button onclick="transformNightmare()" class="bg-white border border-gray-300 text-gray-600 px-6 py-2 rounded-full text-sm font-bold shadow-sm hover:bg-gray-50 flex items-center mx-auto"><i data-lucide="wand-2" class="w-4 h-4 mr-2"></i> Specify</button>
                        </div>
                        <div id="fear-strong" class="absolute inset-0 bg-white p-8 rounded-lg border-2 border-allgood-primary shadow-xl text-center opacity-0 pointer-events-none transform scale-95 transition-all duration-700 flex flex-col items-center justify-center shimmer-card">
                            <div class="absolute top-2 right-2"><i data-lucide="check-circle" class="w-5 h-5 text-green-500"></i></div>
                            <p class="text-xs uppercase font-bold text-allgood-primary mb-2">Defined Nightmare</p>
                            <h3 class="text-lg font-bold text-allgood-dark" id="strong-fear-text">...</h3>
                        </div>
                    </div>
                </div>

                <!-- Page 7: Prevent -->
                <div class="page" id="page-7">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark">Column 2: Prevent</h2><p class="text-sm text-gray-500">Activate your defenses.</p></section>
                    <div class="space-y-4" id="defense-list"></div>
                </div>

                <!-- Page 8: Repair -->
                <div class="page" id="page-8">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark">Column 3: Repair</h2><p class="text-sm text-gray-500">Mount your emergency kits.</p></section>
                    <div class="grid grid-cols-2 gap-4" id="repair-chips"></div>
                </div>

                <!-- Page 9: System Check -->
                <div class="page" id="page-9">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark">System Audit</h2></section>
                    <div class="bg-gray-800 p-6 rounded-xl text-white text-center">
                        <div class="grid grid-cols-3 gap-4 mb-8">
                            <div><div class="text-xs text-gray-400 uppercase">Definition</div><div class="h-2 bg-green-500 rounded mt-1"></div></div>
                            <div><div class="text-xs text-gray-400 uppercase">Defense</div><div class="h-2 bg-gray-600 rounded mt-1 transition-all duration-1000" id="gauge-defense"></div></div>
                            <div><div class="text-xs text-gray-400 uppercase">Repair</div><div class="h-2 bg-gray-600 rounded mt-1 transition-all duration-1000" id="gauge-repair"></div></div>
                        </div>
                        <div class="text-4xl font-mono font-bold text-red-500 mb-2 transition-colors duration-500" id="survivability-score">0%</div>
                        <p class="text-xs uppercase tracking-widest text-gray-400">Survivability Rating</p>
                        <button onclick="runSystemCheck()" class="mt-6 w-full bg-allgood-primary hover:bg-allgood-hover text-white font-bold py-3 rounded">Run Audit</button>
                    </div>
                </div>

                <!-- Page 10: Timeline -->
                <div class="page" id="page-10">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark">Cost of Inaction</h2></section>
                    <div class="flex justify-between mb-6 px-4">
                        <button onclick="updateTimeline(6)" class="text-xs font-bold px-3 py-1 rounded bg-gray-200 hover:bg-gray-300">6 Months</button>
                        <button onclick="updateTimeline(12)" class="text-xs font-bold px-3 py-1 rounded bg-gray-200 hover:bg-gray-300">1 Year</button>
                        <button onclick="updateTimeline(36)" class="text-xs font-bold px-3 py-1 rounded bg-gray-200 hover:bg-gray-300">3 Years</button>
                    </div>
                    <div class="bg-white p-6 rounded shadow-inner border border-gray-200 min-h-[150px] flex items-center justify-center text-center">
                        <p id="timeline-text" class="text-lg text-gray-600 italic">Select a timeframe to see the decay.</p>
                    </div>
                </div>

                <!-- Page 11: Emotional Bankruptcy -->
                <div class="page" id="page-11">
                    <section class="mb-4 text-center"><h2 class="text-2xl font-heading font-bold text-allgood-dark">Emotional Cost</h2></section>
                    <div class="dial-container mb-6">
                        <div class="dial-knob" style="transform: rotate(-90deg);" id="emotion-dial">
                            <div class="dial-marker"></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-2 text-center">
                        <button onclick="adjustCostDial(-45, 'Boredom')" class="text-xs bg-gray-100 p-2 rounded">Low</button>
                        <button onclick="adjustCostDial(0, 'Resentment')" class="text-xs bg-orange-100 p-2 rounded">Med</button>
                        <button onclick="adjustCostDial(45, 'Bitterness')" class="text-xs bg-red-100 p-2 rounded">High</button>
                    </div>
                    <p id="emotion-result" class="text-center mt-6 text-xl font-bold h-8 text-gray-400">...</p>
                </div>

                <!-- Page 12: Asymmetry -->
                <div class="page" id="page-12">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark">The Asymmetry</h2></section>
                    <div class="flex items-end justify-center h-48 gap-8 px-4" id="scale-container">
                        <div class="w-1/3 bg-orange-200 h-24 rounded-t-lg flex items-center justify-center text-center p-2 text-xs font-bold text-orange-800 transition-all duration-700" id="scale-action">Temporary Pain<br>(Action)</div>
                        <div class="w-1/3 bg-gray-800 h-24 rounded-t-lg flex items-center justify-center text-center p-2 text-xs font-bold text-white transition-all duration-700" id="scale-inaction">Permanent Regret<br>(Inaction)</div>
                    </div>
                    <button onclick="weighInaction()" class="w-full mt-6 bg-allgood-dark text-white font-bold py-3 rounded">Weigh The Options</button>
                </div>

                <!-- Page 13: Sort -->
                <div class="page" id="page-13">
                    <section class="mb-4 border-b border-gray-200 pb-2"><h2 class="text-xl font-heading font-bold text-allgood-dark">Sort the Signal</h2></section>
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="drop-zone p-4 bg-green-50 rounded border-2 border-dashed border-green-300 min-h-[100px] text-center" data-type="Rational">Rational Risk</div>
                        <div class="drop-zone p-4 bg-red-50 rounded border-2 border-dashed border-red-300 min-h-[100px] text-center" data-type="Irrational">Irrational Panic</div>
                    </div>
                    <div id="sort-items" class="flex flex-wrap gap-2 justify-center">
                        <div class="draggable-item bg-white border border-gray-300 px-3 py-2 rounded text-xs shadow-sm" draggable="true" data-target="Irrational">"Everyone will laugh"</div>
                        <div class="draggable-item bg-white border border-gray-300 px-3 py-2 rounded text-xs shadow-sm" draggable="true" data-target="Rational">"I might lose $1k"</div>
                        <div class="draggable-item bg-white border border-gray-300 px-3 py-2 rounded text-xs shadow-sm" draggable="true" data-target="Irrational">"My life is over"</div>
                        <div class="draggable-item bg-white border border-gray-300 px-3 py-2 rounded text-xs shadow-sm" draggable="true" data-target="Rational">"Resume gap"</div>
                    </div>
                </div>

                <!-- Page 14: Probability -->
                <div class="page" id="page-14">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark">Actual Risk</h2></section>
                    <p class="text-center text-sm text-gray-600 mb-4">On a scale of 1-10, what is the likelihood of total, irreversible ruin?</p>
                    <input type="range" min="1" max="10" value="5" class="w-full h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer accent-allgood-primary mb-4" oninput="document.getElementById('risk-val').innerText = this.value">
                    <div class="text-center text-4xl font-bold text-allgood-primary mb-2" id="risk-val">5</div>
                    <div class="bg-blue-50 p-4 rounded text-sm text-blue-800">
                        <strong>Fact:</strong> For most decisions, the risk of irreversible ruin is less than 2 (10-20%).
                    </div>
                </div>

                <!-- Page 15: Upside -->
                <div class="page" id="page-15">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark">The Upside</h2></section>
                    <div class="bg-gray-100 p-8 rounded-lg text-center cursor-pointer hover:bg-gray-50 transition-colors relative overflow-hidden group" onclick="revealUpside()">
                        <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white to-transparent opacity-0 group-hover:opacity-20 transform -translate-x-full group-hover:animate-shimmer transition-all"></div>
                        <h3 class="text-xl font-bold text-gray-400" id="upside-text">Click to Reveal</h3>
                        <p class="text-sm text-gray-500 mt-2">Even if you fail, what do you gain?</p>
                    </div>
                </div>

                <!-- Page 16: Crisis -->
                <div class="page" id="page-16">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-red-600"><i data-lucide="alert-triangle" class="inline w-6 h-6 mr-2"></i>Crisis Check</h2></section>
                    <p class="mb-4 text-sm text-gray-700">You are about to back out. Panic is setting in. What is your repair protocol?</p>
                    <div class="space-y-3">
                        <button onclick="sfx.error()" class="w-full text-left p-3 border rounded hover:bg-red-50">Freeze and wait.</button>
                        <button onclick="sfx.success(); alert('Correct. Action kills panic.')" class="w-full text-left p-3 border rounded hover:bg-green-50 font-bold text-allgood-primary">Execute Repair Strategy #1.</button>
                        <button onclick="sfx.error()" class="w-full text-left p-3 border rounded hover:bg-red-50">Call a friend to vent.</button>
                    </div>
                </div>

                <!-- Page 17: Contract -->
                <div class="page" id="page-17">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark">The Contract</h2></section>
                    <div class="bg-yellow-50 p-8 rounded shadow-lg border border-yellow-200 max-w-sm mx-auto">
                        <p class="text-sm text-gray-800 mb-6 font-serif leading-relaxed">
                            "I hereby acknowledge that the <strong>Cost of Inaction</strong> is far greater than the risk of failure. I have defined the nightmare, built my defenses, and I am ready to act."
                        </p>
                        <div class="mt-8 border-b-2 border-black w-full relative h-12 cursor-pointer" onclick="signContract()">
                            <span class="absolute bottom-1 left-0 text-xs text-gray-500 uppercase">x Sign Here</span>
                            <div class="font-heading italic text-2xl absolute bottom-2 left-10 opacity-0 transition-opacity duration-1000 text-allgood-primary transform -rotate-3" id="signature-text">Learner</div>
                        </div>
                    </div>
                </div>

                <!-- Page 18: Certification -->
                <div class="page" id="page-18">
                    <div class="flex flex-col items-center justify-start min-h-full py-10 text-center px-6">
                        <h2 class="text-2xl font-heading font-bold text-allgood-dark mb-4">Mission Complete</h2>
                        <div id="badge-container" class="mb-8 transform scale-90 transition-all duration-500 opacity-0"></div>
                        <button id="download-badge-btn" onclick="downloadBadge()" disabled class="w-full max-w-xs bg-gray-300 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all flex items-center justify-center mb-12">
                            <i data-lucide="lock" class="w-5 h-5 mr-2"></i><span>Locked</span>
                        </button>
                    </div>
                </div>

                <!-- 3. FOOTER -->
                <footer class="footer-content flex items-center justify-between px-6">
                    <div id="flex-progress-bar"><div id="flex-progress-fill"></div></div>
                    <button id="back-button" class="text-allgood-primary hover:text-allgood-dark font-bold text-sm flex items-center transition-colors disabled:opacity-30 disabled:cursor-not-allowed font-body"><i data-lucide="chevron-left" class="w-4 h-4 mr-1"></i>Back</button>
                    <div class="text-center hidden sm:block">
                        <a href="https://www.allgoodacademy.com" target="_blank" class="text-gray-400 text-[10px] font-body hover:text-allgood-primary transition-colors no-underline">
                            <span class="font-bold">GoodBlock&trade;</span> powered by <span class="font-bold">Allgood Academy</span>
                        </a>
                    </div>
                    <button id="next-button" class="bg-allgood-primary hover:bg-allgood-hover text-white px-6 py-2 rounded-full text-sm font-bold shadow-md transition-transform transform hover:scale-105 flex items-center disabled:opacity-50 disabled:cursor-not-allowed font-body"><span>Next</span><i data-lucide="chevron-right" class="w-4 h-4 ml-1"></i></button>
                </footer>

                <!-- SYSTEM MODALS -->
                <div id="login-modal" class="absolute inset-0 z-[200] bg-allgood-dark/95 flex items-center justify-center p-6 visible-modal modal-transition backdrop-blur-sm">
                    <div class="bg-white rounded-lg shadow-2xl p-8 max-w-sm w-full text-center border-t-4 border-allgood-primary">
                        <div class="mb-6"><h2 class="text-3xl font-heading font-bold text-allgood-dark">Allgood<span class="text-allgood-primary">Academy</span></h2></div>
                        <h2 class="text-xl font-bold text-allgood-dark mb-2 font-heading">Welcome</h2>
                        <input type="text" id="user-name-input" placeholder="Your Name" class="w-full border border-gray-300 rounded p-3 mb-3 font-body">
                        <button id="btn-guest-login" onclick="window.handleGuestLogin()" class="w-full bg-allgood-primary hover:bg-allgood-hover text-white font-bold py-3 rounded shadow-md font-body uppercase">Start Mission</button>
                    </div>
                </div>
                
                <div id="menu-modal" class="hidden-modal absolute inset-0 z-[100] bg-black/60 flex justify-end modal-transition">
                    <div class="w-72 h-full bg-white shadow-xl flex flex-col border-l border-gray-200">
                        <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50"><span class="font-bold text-allgood-dark font-heading">Menu</span><button onclick="document.getElementById('menu-modal').classList.add('hidden-modal');document.getElementById('menu-modal').classList.remove('visible-modal');"><i data-lucide="x" class="w-6 h-6"></i></button></div>
                        <div class="p-2 overflow-y-auto flex-grow space-y-1 text-sm font-body" id="toc-list"></div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <script>
        // STATE ENGINE
        const totalPages = 18;
        let currentPage = 0;
        const state = {
            fearType: null,
            nightmareDefined: false,
            chipsMounted: 0,
            contractSigned: false,
            score: 0
        };

        const contentMap = {
            'Career': { nightmare: "I end up unemployed and unemployable.", defense: ["Update Resume", "Save 6mo Expenses"], repair: ["Freelance", "Move to LCOL Area"] },
            'Conversation': { nightmare: "They scream, quit, and sue me.", defense: ["Script the Opener", "Consult HR"], repair: ["Apologize", "Document Everything"] },
            'Finance': { nightmare: "I lose the investment and go broke.", defense: ["Diversify", "Set Stop-Loss"], repair: ["Side Hustle", "Cut Expenses"] }
        };

        const narrative = [
            "", // 1
            "Fear is biological, but your brain misinterprets 'uncertainty' as 'tiger'.", // 2
            "Vague fears paralyze. Specific fears are just to-do lists.", // 3
            "Don't just stare at the monster. Dissect it.", // 4
            "Pick the one thing that keeps you awake at 3 AM.", // 5
            "Write it down. The monster shrinks when you name it.", // 6
            "You have more control than you think. Build the shield.", // 7
            "If the shield fails, you still have a medkit. You will survive.", // 8
            "Look at the data. Your nightmare is survivable.", // 9
            "Now, let's look at the hidden cost. The cost of doing nothing.", // 10
            "Inaction isn't safe. It's a slow leak of your soul.", // 11
            "The pain of action is temporary. The regret of inaction is forever.", // 12
            "Sort your thoughts. Panic is noise. Risk is signal.", // 13
            "The odds of total ruin are lower than you think.", // 14
            "Don't forget the upside. Even failure brings growth.", // 15
            "When panic hits, trust your protocol, not your feelings.", // 16
            "Sign the line. Make a promise to your future self.", // 17
            "You are a Stoic Operator. Go do the work." // 18
        ];

        // AUDIO
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx;
        function initAudio() { if (!audioCtx) audioCtx = new AudioContext(); if (audioCtx.state === 'suspended') audioCtx.resume(); }
        function playTone(f,t,d,v=0.1) { try { initAudio(); const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type=t; o.frequency.setValueAtTime(f,audioCtx.currentTime); o.connect(g); g.connect(audioCtx.destination); g.gain.setValueAtTime(0,audioCtx.currentTime); g.gain.linearRampToValueAtTime(v,audioCtx.currentTime+0.01); g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+d); o.start(audioCtx.currentTime); o.stop(audioCtx.currentTime+d); } catch(e){} }
        const sfx = { nav: ()=>playTone(150,'sine',0.1), tick: ()=>playTone(1000,'sine',0.01), success: ()=>playTone(600,'sine',0.2), error: ()=>playTone(100,'sawtooth',0.2) };
        window.sfx = sfx;

        // NAVIGATION
        const pages = document.querySelectorAll('.page');
        const nextBtn = document.getElementById('next-button');
        const backBtn = document.getElementById('back-button');

        window.showPage = function(idx) {
            if (idx < 0 || idx >= totalPages) return;
            pages.forEach(p => p.classList.remove('active'));
            pages[idx].classList.add('active');
            currentPage = idx;
            
            document.getElementById('flex-progress-fill').style.width = `${((idx+1)/totalPages)*100}%`;
            document.getElementById('header-page-indicator').textContent = `${idx+1} / ${totalPages}`;
            
            // Mentor Bar
            const mentor = document.getElementById('mentor-bar');
            if(narrative[idx]) {
                mentor.classList.remove('hidden');
                document.getElementById('mentor-text').innerText = narrative[idx];
            } else { mentor.classList.add('hidden'); }

            // Logic Triggers
            if(idx === 17) window.checkCertification();

            backBtn.disabled = idx === 0;
            backBtn.classList.toggle('opacity-0', idx === 0);
            nextBtn.style.display = (idx === totalPages - 1) ? 'none' : 'flex';
            sfx.nav();
        }

        nextBtn.addEventListener('click', () => showPage(currentPage + 1));
        backBtn.addEventListener('click', () => showPage(currentPage - 1));
        document.getElementById('home-button').addEventListener('click', () => showPage(0));

        // INTERACTION LOGIC
        window.updateFearSlider = (val) => {
            const bg = document.getElementById('fear-slider-bg');
            const txt = document.getElementById('fear-slider-text');
            bg.style.opacity = 1 - (val/100);
            if(val > 80) { txt.innerText = "Fear is a GPS Signal."; bg.style.backgroundColor = "#357889"; bg.style.opacity = 1; }
            else { txt.innerText = "Fear is a STOP Sign."; bg.style.backgroundColor = "#1f2937"; }
        };

        window.toggleBlur = () => {
            document.getElementById('fog-text').classList.add('cleared');
            sfx.success();
        };

        window.selectFear = (type) => {
            state.fearType = type;
            document.querySelectorAll('.fear-card').forEach(c => c.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            
            // Populate future pages
            const data = contentMap[type];
            document.getElementById('defense-list').innerHTML = data.defense.map(d => `<div class="p-3 bg-white border rounded flex items-center"><input type="checkbox" class="mr-3 h-5 w-5 accent-allgood-primary" onclick="sfx.tick()"><span>${d}</span></div>`).join('');
            document.getElementById('repair-chips').innerHTML = data.repair.map(r => `<div class="data-chip p-4 rounded text-center cursor-pointer font-bold text-xs" onclick="mountRepairChip(this)">${r}</div>`).join('');
            
            sfx.success();
        };

        window.transformNightmare = () => {
            if(!state.fearType) { alert("Go back and select a fear type!"); return; }
            document.getElementById('fear-weak').style.display = 'none';
            const strong = document.getElementById('fear-strong');
            strong.classList.remove('opacity-0', 'pointer-events-none', 'scale-95');
            document.getElementById('strong-fear-text').innerText = contentMap[state.fearType].nightmare;
            state.nightmareDefined = true;
            sfx.success();
        };

        window.mountRepairChip = (el) => {
            if(el.classList.contains('mounted')) return;
            el.classList.add('mounted');
            state.chipsMounted++;
            sfx.tick();
        };

        window.runSystemCheck = () => {
            if(state.chipsMounted < 2) { sfx.error(); return; }
            document.getElementById('gauge-defense').classList.replace('bg-gray-600', 'bg-green-500');
            setTimeout(() => document.getElementById('gauge-repair').classList.replace('bg-gray-600', 'bg-green-500'), 500);
            setTimeout(() => {
                document.getElementById('survivability-score').innerText = "100%";
                document.getElementById('survivability-score').classList.replace('text-red-500', 'text-green-500');
                sfx.success();
            }, 1000);
        };

        window.updateTimeline = (mo) => {
            const txt = document.getElementById('timeline-text');
            if(mo === 6) txt.innerText = "6 Months: Frustration sets in. Skills stagnant.";
            if(mo === 12) txt.innerText = "1 Year: Resentment grows. Opportunity cost: $50k+.";
            if(mo === 36) txt.innerText = "3 Years: Bitter regret. 'What if' haunts you daily.";
            sfx.tick();
        };

        window.adjustCostDial = (deg, label) => {
            document.getElementById('emotion-dial').style.transform = `rotate(${deg}deg)`;
            document.getElementById('emotion-result').innerText = label;
            document.getElementById('emotion-result').className = deg > 0 ? "text-center mt-6 text-xl font-bold h-8 text-red-600" : "text-center mt-6 text-xl font-bold h-8 text-gray-600";
            sfx.tick();
        };

        window.weighInaction = () => {
            document.getElementById('scale-action').style.height = "50px"; // Shrink pain
            document.getElementById('scale-inaction').style.height = "150px"; // Grow regret
            sfx.success();
        };

        // DRAG DROP SORT
        document.querySelectorAll('.draggable-item').forEach(d => {
            d.addEventListener('dragstart', (e) => { e.dataTransfer.setData('target', e.target.dataset.target); sfx.tick(); });
        });
        document.querySelectorAll('.drop-zone').forEach(z => {
            z.addEventListener('dragover', (e) => { e.preventDefault(); z.classList.add('drag-over'); });
            z.addEventListener('dragleave', () => z.classList.remove('drag-over'));
            z.addEventListener('drop', (e) => {
                e.preventDefault();
                z.classList.remove('drag-over');
                if(e.dataTransfer.getData('target') === z.dataset.type) {
                    z.innerHTML += `<div class='mt-2 text-xs bg-white p-1 rounded shadow'>Matched</div>`;
                    sfx.success();
                } else sfx.error();
            });
        });

        window.revealUpside = () => {
            document.getElementById('upside-text').innerText = "Skill Acquisition";
            document.getElementById('upside-text').classList.replace('text-gray-400', 'text-allgood-primary');
            sfx.success();
        };

        window.signContract = () => {
            document.getElementById('signature-text').innerText = window.currentUserName;
            document.getElementById('signature-text').classList.remove('opacity-0');
            state.contractSigned = true;
            sfx.success();
            window.checkCertification();
        };

        window.checkCertification = () => {
            if(state.contractSigned && state.nightmareDefined) {
                const btn = document.getElementById('download-badge-btn');
                btn.disabled = false;
                btn.classList.replace('bg-gray-300', 'bg-allgood-primary');
                btn.innerHTML = `<i data-lucide="download" class="w-5 h-5 mr-2"></i><span>Download Badge</span>`;
                
                const badge = document.getElementById('badge-container');
                badge.innerHTML = `<svg viewBox="0 0 400 400" width="200" height="200" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#357889"/><stop offset="100%" stop-color="#1a1a1a"/></linearGradient></defs><circle cx="200" cy="200" r="190" fill="url(#g)" stroke="#D34716" stroke-width="8"/><text x="200" y="180" font-family="Georgia" font-weight="bold" font-size="28" fill="white" text-anchor="middle">STOIC</text><text x="200" y="220" font-family="Georgia" font-weight="bold" font-size="28" fill="white" text-anchor="middle">OPERATOR</text><text x="200" y="300" font-family="Verdana" font-size="14" fill="#ccc" text-anchor="middle">${window.currentUserName.toUpperCase()}</text></svg>`;
                badge.classList.remove('opacity-0', 'scale-90');
                if(window.lucide) window.lucide.createIcons();
            }
        };
        
        window.downloadBadge = () => {
            const svgData = document.getElementById('badge-container').innerHTML;
            const blob = new Blob([svgData], {type: 'image/svg+xml'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'Stoic_Badge.svg';
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        };

        // TOC Init
        const toc = document.getElementById('toc-list');
        ["Cover","Biology","The Fog","Method","Selector","Define","Prevent","Repair","System Check","Timeline","Emotion","Asymmetry","Sort","Risk","Upside","Crisis","Contract","Cert"].forEach((n,i) => {
            toc.innerHTML += `<button class="w-full text-left px-4 py-2 hover:bg-gray-100 text-gray-600 rounded" onclick="showPage(${i});document.getElementById('menu-modal').classList.add('hidden-modal');document.getElementById('menu-modal').classList.remove('visible-modal');">${i+1}. ${n}</button>`;
        });

        // INIT
        document.addEventListener('DOMContentLoaded', () => {
            if(window.lucide) window.lucide.createIcons();
            document.getElementById('startup-screen').addEventListener('click', function() {
                sfx.nav(); this.style.opacity='0'; setTimeout(()=>{this.style.display='none'},700);
            });
            // Accordion
            document.body.addEventListener('click', (e) => {
                const acc = e.target.closest('.accordion-toggle');
                if(acc) {
                    const c = acc.nextElementSibling;
                    c.classList.toggle('hidden');
                    acc.querySelector('.accordion-icon').classList.toggle('rotate-180');
                    sfx.tick();
                }
                if(e.target.closest('#blueprint-toggle')) {
                    document.getElementById('screen').classList.toggle('blueprint-mode');
                    sfx.tick();
                }
                if(e.target.closest('#menu-toggle')) {
                    const m = document.getElementById('menu-modal');
                    m.classList.remove('hidden-modal'); m.classList.add('visible-modal');
                }
            });
        });
    </script>
</body>
</html>
