<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Your Digital Identity - GoodBlock V3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <!-- FIREBASE AND AUTHENTICATION SETUP -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, GoogleAuthProvider, signInWithPopup, updateProfile } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, addDoc, collection, serverTimestamp, getDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
        
        // 1. CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyAf2SO8xovrApl52udUUoR1n9WBnERr_ko",
            authDomain: "allgood-academy.firebaseapp.com",
            projectId: "allgood-academy",
            storageBucket: "allgood-academy.firebasestorage.app",
            messagingSenderId: "978829044870",
            appId: "1:978829044870:web:6c780f64230a77ad0ab507",
            measurementId: "G-EN4M7T3BLQ"
        };
        
        const appId = 'allgood-academy'; 
        
        // 2. INITIALIZE SERVICES
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // 3. GLOBAL STATE
        window.currentUser = null;
        window.currentUserName = "Anonymous";
        window.currentUserEmail = "";
        window.sessionId = "session_" + Date.now() + "_" + Math.floor(Math.random() * 1000);

        // 4. AUTH HANDLER
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("[Auth] User detected:", user.uid);
                window.currentUser = user;
                let finalName = user.displayName || localStorage.getItem('aa_username') || "Agent Learner";
                
                if (finalName === "Agent Learner") {
                    try {
                        const userDoc = await getDoc(doc(db, 'artifacts', appId, 'users', user.uid));
                        if (userDoc.exists()) finalName = userDoc.data().displayName || finalName;
                    } catch(e) { console.log("Profile fetch skipped", e); }
                }

                window.currentUserName = finalName;
                window.currentUserEmail = user.email;
                window.updateUserDisplay(finalName);
                
                const loginModal = document.getElementById('login-modal');
                if (loginModal && !loginModal.classList.contains('hidden-modal')) {
                    loginModal.classList.add('hidden-modal');
                    loginModal.classList.remove('visible-modal');
                    window.logFinalScoreToFirestore({ status: "Session Started", module: "Digital Identity", sessionId: window.sessionId });
                    // Start render
                    if(window.renderStep) window.renderStep();
                }
            } else {
                window.currentUser = null;
                window.updateUserDisplay("Agent Learner");
            }
        });

        // 5. DATABASE LOGGING ENGINE
        window.ensureUserContainer = async (user, name, email, isGuest) => {
             const userRef = doc(db, 'artifacts', appId, 'users', user.uid);
             try {
                 await setDoc(userRef, {
                     displayName: name,
                     email: email || (isGuest ? null : user.email || null),
                     isGuest: isGuest,
                     lastLogin: serverTimestamp(),
                     lastActiveModule: "Digital Identity"
                 }, { merge: true });
             } catch (e) { console.error("[Identity] Failed to create user container:", e); }
        }

        window.logFinalScoreToFirestore = async (scoreData) => {
            const user = auth.currentUser;
            if (!user) return;

            const sessionRef = doc(db, 'artifacts', appId, 'users', user.uid, 'game_scores', window.sessionId);
            
            try {
                await setDoc(sessionRef, {
                    gameName: "Digital Identity",
                    ...scoreData,
                    lastUpdated: serverTimestamp(),
                    user: { uid: user.uid, displayName: window.currentUserName }
                }, { merge: true });
                console.log(`[DB] Session Write Success.`);
            } catch (e) { console.error("[DB] Session Write Failed", e); }
        }

        // 6. LOGIN FUNCTIONS
        window.handleGuestLogin = async () => {
            const nameInput = document.getElementById('user-name-input').value.trim();
            const emailInput = document.getElementById('user-email-input').value.trim();
            const btn = document.getElementById('btn-guest-login');
            btn.innerText = "Connecting..."; btn.disabled = true;

            try {
                let user;
                if (auth.currentUser && auth.currentUser.isAnonymous) user = auth.currentUser;
                else { const result = await signInAnonymously(auth); user = result.user; }
                
                const displayName = nameInput || "Agent Learner";
                await updateProfile(user, { displayName: displayName });
                await window.ensureUserContainer(user, displayName, emailInput, true);
                
                window.currentUserName = displayName;
                window.updateUserDisplay(displayName);
                
                document.getElementById('login-modal').classList.add('hidden-modal');
                document.getElementById('login-modal').classList.remove('visible-modal');
                if(window.sfx) sfx.nav();
                window.renderStep();

            } catch (error) { console.error("Login Failed", error); alert("Connection failed. Please try again."); } 
            finally { btn.innerText = "Start Module"; btn.disabled = false; }
        };

        window.handleGoogleLogin = async () => {
            const provider = new GoogleAuthProvider();
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                const finalName = user.displayName || "Agent";
                await window.ensureUserContainer(user, finalName, user.email, false);
                window.currentUserName = finalName;
                window.updateUserDisplay(finalName);
                document.getElementById('login-modal').classList.add('hidden-modal');
                document.getElementById('login-modal').classList.remove('visible-modal');
                if(window.sfx) sfx.nav();
                window.renderStep();
            } catch (error) { console.error("Google Sign-In Error", error); alert("Google Sign-In failed."); }
        };
    </script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'allgood-primary': '#D34716',
                        'allgood-secondary': '#357889',
                        'allgood-dark': '#4C4C4C',
                        'allgood-light': '#F7F7F7',
                        'allgood-hover': '#EB8D69',
                    },
                    fontFamily: {
                        'heading': ['Georgia', 'serif'],
                        'body': ['Verdana', 'sans-serif'],
                    },
                },
            },
        }
    </script>

    <style>
        /* --- FIXED CHASSIS STYLES (V3 OS) --- */
        body { font-family: Verdana, sans-serif; background-color: #1a1a1a; min-height: 100vh; margin: 0; padding: 0; }
        h1, h2, h3, h4 { font-family: Georgia, serif; }

        .tablet-frame {
            height: 80vh; width: auto; aspect-ratio: 16/10; max-width: 1100px; max-height: 95vh;
            background-image: radial-gradient(circle at 0% 0%, rgba(211, 71, 22, 0.35) 0%, transparent 30%), linear-gradient(135deg, #5c5c5c 0%, #d6d6d6 25%, #8a8a8a 50%, #e0e0e0 75%, #5c5c5c 100%);
            border-radius: 12px; padding: 12px; border: 1px solid #333; position: relative;
            box-shadow: inset 1px 1px 2px rgba(255,255,255,0.6), 0 30px 60px -12px rgba(0,0,0,0.8);
            margin: 20px auto;
            transition: all 0.3s ease;
        }
        .tablet-frame::before {
            content: ''; position: absolute; top: 10px; left: 10px; right: 10px; bottom: 10px;
            border-radius: 6px; background: #111; z-index: 0;
        }
        .screen-container {
            width: 100%; height: 100%; background-color: #F7F7F7; position: relative; z-index: 1;
            overflow: hidden; display: flex; flex-direction: column; border-radius: 4px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }

        .modal-transition { transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out; }
        .hidden-modal { opacity: 0; pointer-events: none; transform: translateY(-10px); }
        .visible-modal { opacity: 1; pointer-events: auto; transform: translateY(0); }

        /* Scrollbars */
        .content-scroll::-webkit-scrollbar { width: 14px; }
        .content-scroll::-webkit-scrollbar-track { background: #e5e5e5; border-left: 1px solid #d1d5db; }
        .content-scroll::-webkit-scrollbar-thumb { background-color: #D34716; border-radius: 7px; border: 3px solid #e5e5e5; }

        /* Progress Bar */
        #flex-progress-bar { height: 4px; width: 100%; background-color: #eee; position: absolute; top: 0; left: 0; }
        #flex-progress-fill { height: 100%; background-color: #D34716; width: 0%; transition: width 0.3s ease; }

        /* --- CONTENT SPECIFIC STYLES (FROM V2) --- */
        .goodblock-card { background-color: #ffffff; border-left: 5px solid #357889; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); margin-bottom: 1rem; }
        .goodblock-card.primary { border-left-color: #D34716; }
        
        .tooltip-container { border-bottom: 2px dashed #357889; color: #357889; font-weight: bold; cursor: pointer; }
        .tooltip-content { display: none; }
        
        /* Comparison Slider */
        .comparison-slider-container { position: relative; height: 250px; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.1); user-select: none; }
        .comparison-before, .comparison-after { position: absolute; top: 0; left: 0; width: 100%; height: 100%; padding: 1rem; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; color: white; }
        .comparison-before { background-color: #dc2626; }
        .comparison-after { background-color: #357889; }
        .comparison-divider { position: absolute; top: 0; bottom: 0; width: 4px; background-color: white; cursor: ew-resize; z-index: 10; }
        .comparison-divider-icon { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; background-color: rgba(0,0,0,0.5); border-radius: 50%; padding: 0.5rem; }

        /* Blueprint Mode Overrides */
        .blueprint-mode { background-color: #0f172a !important; color: #94a3b8 !important; }
        .blueprint-mode .screen-container, .blueprint-mode main { background-color: #0f172a !important; }
        .blueprint-mode .bg-white { background-color: #1e293b !important; border-color: #334155 !important; color: #cbd5e1 !important; }
        .blueprint-mode .text-allgood-dark { color: #e2e8f0 !important; }
        .blueprint-mode .goodblock-card { background-color: #1e293b !important; border-color: #334155 !important; color: #cbd5e1 !important; }

        /* Focus Mode Overrides */
        .tablet-frame.focus-mode { width: 100% !important; height: 100% !important; border: none; border-radius: 0; margin: 0; padding: 0; max-width: none; max-height: none; background: none; box-shadow: none; }
        .tablet-frame.focus-mode::before { display: none; }
        .tablet-frame.focus-mode .screen-container { border-radius: 0; }

        @media (max-width: 768px) {
            .tablet-frame { width: 100% !important; height: 100% !important; border: none; border-radius: 0; margin: 0; padding: 0; background: none; box-shadow: none; }
            .tablet-frame::before { display: none; }
            .screen-container { border-radius: 0; }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen text-allgood-dark font-body overflow-y-auto">

    <main class="flex-grow flex items-center justify-center py-8">
        <div class="tablet-frame">
            <div class="screen-container" id="screen">

                <!-- 1. STARTUP SCREEN -->
                <div id="startup-screen" class="absolute inset-0 z-[300] flex flex-col items-center justify-center cursor-pointer transition-opacity duration-700 ease-in-out bg-slate-900">
                    <div class="group flex flex-col items-center justify-center text-center h-full w-full relative">
                        <div class="flex-grow flex flex-col items-center justify-center px-4">
                            <h2 class="text-xl md:text-3xl font-heading font-bold text-white mb-1 relative z-10">Allgood Academy</h2>
                            <h1 class="text-4xl md:text-6xl font-heading font-bold text-allgood-primary tracking-tighter relative z-10 drop-shadow-md">GoodBlock</h1>
                            <p class="mt-2 text-white/80 relative z-10 font-body text-sm font-semibold">Your Digital Identity</p>
                            <p class="mt-12 text-white/80 text-xs tracking-[0.3em] uppercase font-medium group-hover:text-white transition-colors animate-pulse font-body">Click to Power Up</p>
                        </div>
                    </div>
                </div>

                <!-- 2. LOGIN MODAL -->
                <div id="login-modal" class="absolute inset-0 z-[200] bg-allgood-dark/95 flex items-center justify-center p-6 hidden-modal modal-transition backdrop-blur-sm">
                    <div class="bg-white rounded-lg shadow-2xl p-8 max-w-sm w-full text-center border-t-4 border-allgood-primary">
                        <div class="mb-6"><h2 class="text-3xl font-heading font-bold text-allgood-dark">Allgood<span class="text-allgood-primary">Academy</span></h2></div>
                        <h2 class="text-xl font-bold text-allgood-dark mb-2 font-heading">Welcome</h2>
                        <p class="text-gray-500 text-sm font-body mb-6">Please sign in to start.</p>
                        <input type="text" id="user-name-input" placeholder="Your Name (Optional)" class="w-full border border-gray-300 rounded p-3 mb-3 font-body">
                        <input type="email" id="user-email-input" placeholder="Your Email (Optional)" class="w-full border border-gray-300 rounded p-3 mb-6 font-body">
                        <button id="btn-guest-login" onclick="window.handleGuestLogin()" class="w-full bg-allgood-primary hover:bg-allgood-hover text-white font-bold py-3 rounded shadow-md transition-transform font-body uppercase">Start Module</button>
                        <div class="mt-4 flex items-center justify-center space-x-2"><div class="h-px w-10 bg-gray-200"></div><p class="text-xs text-gray-500 uppercase font-bold">OR</p><div class="h-px w-10 bg-gray-200"></div></div>
                        <button onclick="window.handleGoogleLogin()" class="mt-4 p-2 rounded-full border border-gray-300 shadow-md hover:scale-105 bg-white flex items-center justify-center mx-auto">
                            <i class="fab fa-google text-red-500 text-xl"></i>
                        </button>
                    </div>
                </div>

                <!-- 3. HEADER -->
                <header class="bg-allgood-secondary shadow-md flex-none z-20 h-[60px] flex items-center">
                    <div class="w-full px-4 flex items-center justify-between h-full">
                        <div class="flex items-center overflow-hidden">
                            <div id="header-welcome-text" class="flex-shrink-0 text-white font-heading font-bold text-lg tracking-tight truncate mr-4">Digital Identity</div>
                            <div class="hidden sm:flex items-center bg-black/20 rounded-full px-3 py-1 border border-white/10">
                                <span class="text-[10px] uppercase tracking-wider text-white/60 mr-2 font-heading font-bold">Step</span>
                                <span id="header-page-indicator" class="text-xs font-bold text-white font-body tabular-nums">1 / 15</span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-1 shrink-0">
                            <button id="home-button" class="text-gray-200 hover:text-white p-2 rounded-full hover:bg-white/10" title="Reset"><i data-lucide="refresh-cw" class="w-5 h-5"></i></button>
                            <div class="h-6 w-px bg-white/20 mx-1"></div>
                            <button id="blueprint-toggle" class="text-gray-200 hover:text-cyan-300 p-2 rounded-full hover:bg-white/10"><i data-lucide="scan" class="w-5 h-5"></i></button>
                            <button id="fullscreen-toggle" class="text-gray-200 hover:text-green-300 p-2 rounded-full hover:bg-white/10"><i data-lucide="maximize" class="w-5 h-5"></i></button>
                            <button id="menu-toggle" class="text-gray-200 hover:text-white p-2 rounded-full hover:bg-white/10"><i data-lucide="menu" class="w-6 h-6"></i></button>
                        </div>
                    </div>
                </header>

                <!-- 4. CONTENT AREA (Dynamic) -->
                <div id="content-area" class="flex-grow overflow-y-auto p-6 relative content-scroll bg-allgood-light">
                    <!-- Dynamic Content Injected Here -->
                </div>

                <!-- 5. FOOTER -->
                <footer class="bg-white border-t border-gray-200 flex-none z-20 h-[60px] flex items-center justify-between px-6 relative">
                    <div id="flex-progress-bar"><div id="flex-progress-fill"></div></div>
                    <button id="back-button" class="text-allgood-primary hover:text-allgood-dark font-bold text-sm flex items-center transition-colors disabled:opacity-30 disabled:cursor-not-allowed font-body">
                        <i data-lucide="arrow-left" class="w-4 h-4 mr-1"></i>Back
                    </button>
                    <p class="text-gray-400 text-[10px] hidden sm:block font-body">&copy; Allgood Academy</p>
                    <button id="next-button" class="bg-allgood-primary hover:bg-allgood-hover text-white px-6 py-2 rounded-full text-sm font-bold shadow-md transition-transform transform hover:scale-105 flex items-center disabled:opacity-50 disabled:cursor-not-allowed font-body">
                        <span>Next</span><i data-lucide="arrow-right" class="w-4 h-4 ml-1"></i>
                    </button>
                </footer>

                <!-- Modals -->
                <div id="tooltip-overlay" class="fixed inset-0 bg-black/60 z-[250] flex justify-center items-center hidden" onclick="closeTooltip()">
                    <div class="bg-white rounded-xl p-6 m-4 max-w-xs w-full" onclick="event.stopPropagation()">
                        <h4 id="tooltip-title" class="text-lg font-bold font-heading text-allgood-secondary mb-2">Term</h4>
                        <p id="tooltip-text" class="text-sm text-gray-700">Definition</p>
                    </div>
                </div>

                <div id="menu-modal" class="hidden-modal absolute inset-0 z-[240] bg-black/60 flex justify-end modal-transition">
                    <div class="w-72 h-full bg-white shadow-xl flex flex-col border-l border-gray-200">
                        <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                            <span class="font-bold text-allgood-dark font-heading">Modules</span>
                            <button id="close-menu" class="text-gray-500 hover:text-allgood-primary"><i data-lucide="x" class="w-6 h-6"></i></button>
                        </div>
                        <div class="p-2 overflow-y-auto flex-grow space-y-1 text-sm font-body" id="toc-list"></div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <!-- MAIN LOGIC -->
    <script>
        // --- AUDIO ENGINE ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx;
        function initAudio() { if (!audioCtx) audioCtx = new AudioContext(); if (audioCtx.state === 'suspended') audioCtx.resume(); }
        function playTone(freq, type, duration) {
            initAudio(); const now = audioCtx.currentTime; const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.type = type; osc.frequency.setValueAtTime(freq, now); osc.connect(gain); gain.connect(audioCtx.destination);
            gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.001, now + duration);
            osc.start(now); osc.stop(now + duration);
        }
        const sfx = {
            powerOn: () => { initAudio(); playTone(220, 'triangle', 0.5); },
            nav: () => { initAudio(); playTone(440, 'sine', 0.1); },
            tick: () => { initAudio(); playTone(880, 'sine', 0.05); }
        };
        window.sfx = sfx;

        // --- CONTENT ENGINE ---
        let currentStep = 0;
        let masteryQuizPassed = false;
        
        const goodBlockConfig = { topicName: "Digital Identity", skillName: "Footprint Management" };

        const courseSteps = [
            { type: 'intro', title: 'Welcome', body: `<div class="flex flex-col items-center justify-center text-center h-full"><i data-lucide="fingerprint" class="w-16 h-16 text-allgood-secondary mb-4"></i><h2 class="text-2xl font-bold font-heading text-allgood-dark">Your Digital Identity</h2><p class="mt-4 text-base text-gray-600">Understand the difference between Active and Passive data, and learn to manage your permanent digital record.</p></div>` },
            { type: 'content', title: "What is a Digital Footprint?", body: `<p class="text-gray-700 text-base mb-4">Your digital footprint is the trail of data you leave behind when you use the internet.</p><div class="goodblock-card primary"><p class="text-sm font-semibold text-allgood-primary">Think of it as your <strong>digital brand</strong>. It is often permanent.</p></div>` },
            { type: 'content-tooltip', title: "Active vs. Passive", body: `<p class="mb-4">Two types of data trails:</p><p class="mb-2"><span class="tooltip-container">Active Footprint<span class="tooltip-content">Data you intentionally share (posts, emails).</span></span>: What you choose to share.</p><p><span class="tooltip-container">Passive Footprint<span class="tooltip-content">Data collected automatically (IP address, location).</span></span>: What is collected about you.</p>` },
            { type: 'reveal', title: "The Danger of Passive Data", layers: [{title: "Data Collection", icon: "satellite", content: "Apps track your location 24/7."}, {title: "Data Brokers", icon: "share-2", content: "Companies sell your data profile."}, {title: "The Product", icon: "user", content: "If it's free, YOU are the product."}] },
            { type: 'accordion', title: "Mindset Shift", body: `<div class="space-y-2"><div class="goodblock-card"><h4 class="font-bold text-allgood-primary accordion-trigger cursor-pointer">Old Habit: Convenience</h4><div class="hidden mt-2 text-sm">Clicking 'Agree' without reading.</div></div><div class="goodblock-card primary"><h4 class="font-bold text-allgood-secondary accordion-trigger cursor-pointer">New Habit: Control</h4><div class="hidden mt-2 text-sm">Managing settings and questioning value.</div></div></div>` },
            { type: 'tabs', title: "Myth vs. Reality", tabs: [{label: "Myth", content: "Deleting a post removes it forever."}, {label: "Reality", content: "Screenshots and archives are permanent."}] },
            { type: 'read-more', title: "The Cost of Free", intro: "Social media isn't free.", fullText: "You pay with your data. Every like, scroll, and click builds a profile sold to advertisers." },
            { type: 'slider', title: "Public vs. Private", before: {title: "Public Self", text: "Curated for employers."}, after: {title: "Private Self", text: "Trusted friends only."} },
            { type: 'callout-tiles', title: "The 4 Rules", tiles: [{title: "Pause", content: "Wait 10s before posting."}, {title: "Audit", content: "Google yourself monthly."}, {title: "Settings", content: "Lock down privacy."}, {title: "Security", content: "Use 2FA."}] },
            { type: 'numbered-accordion', title: "Action Plan", steps: [{title: "Audit", content: "Search your name."}, {title: "Lock Down", content: "Set to Friends Only."}, {title: "Strengthen", content: "Use a Password Manager."}] },
            { type: 'quiz-filter', title: "Active or Passive?", questions: [{text: "Posting a photo", ans: "ACTIVE"}, {text: "GPS Tracking", ans: "PASSIVE"}, {text: "Sending Email", ans: "ACTIVE"}] },
            { type: 'carousel', title: "Core Truths", quotes: ["Privacy is a prerequisite to freedom.", "What is public is preserved forever."] },
            { type: 'mastery-quiz', title: "Mastery Challenge", quiz: [
                {q: "What is the key difference?", options: ["Active is text", "Active is intentional"], correct: 1},
                {q: "Who uses your active footprint?", options: ["Employers", "ISPs"], correct: 0},
                {q: "First step of the plan?", options: ["Audit", "Delete"], correct: 0}
            ]},
            { type: 'conclusion', title: "Complete", body: `<div class="text-center"><i data-lucide="award" class="w-16 h-16 text-allgood-primary mx-auto mb-4"></i><h2 class="text-2xl font-bold font-heading">Identity Secured</h2><p class="mt-4">You have a pragmatic plan.</p></div>` },
            { type: 'iframe-embed', title: "Badge", src: "https://docs.google.com/forms/d/e/1FAIpQLSfyZqRFBSxNMcJQD7EPDD6Rrpi77x016ZNGuL6A5Bp0XSagMA/viewform?embedded=true" }
        ];

        // --- RENDERERS ---
        function renderStep() {
            const data = courseSteps[currentStep];
            const container = document.getElementById('content-area');
            const headerTitle = document.getElementById('header-welcome-text');
            
            // Header Update
            headerTitle.textContent = currentStep === 0 ? "Introduction" : `${currentStep}. ${data.title}`;
            document.getElementById('header-page-indicator').textContent = `${currentStep + 1} / ${courseSteps.length}`;
            
            // Progress Bar
            document.getElementById('flex-progress-fill').style.width = `${((currentStep + 1) / courseSteps.length) * 100}%`;

            // Clear Content
            container.innerHTML = "";
            
            // Helper for Title
            const addTitle = () => container.innerHTML += `<h2 class="text-xl font-heading font-bold text-allgood-dark mb-4 border-b pb-2 border-gray-200">${data.title}</h2>`;

            if (data.type === 'intro' || data.type === 'conclusion') {
                container.innerHTML = data.body;
            } else if (data.type === 'content' || data.type === 'content-tooltip') {
                addTitle();
                container.innerHTML += data.body;
                setupTooltips();
            } else if (data.type === 'accordion') {
                addTitle();
                container.innerHTML += data.body;
                setupAccordions();
            } else if (data.type === 'tabs') {
                addTitle();
                const tabHeader = data.tabs.map((t, i) => `<button onclick="switchTab(${i})" class="tab-btn px-4 py-2 text-sm font-bold ${i===0?'text-allgood-primary border-b-2 border-allgood-primary':'text-gray-500'}">${t.label}</button>`).join('');
                const tabContent = data.tabs.map((t, i) => `<div id="tab-${i}" class="${i===0?'block':'hidden'} p-4 bg-white rounded shadow-sm mt-2">${t.content}</div>`).join('');
                container.innerHTML += `<div class="flex space-x-4 border-b border-gray-200">${tabHeader}</div>${tabContent}`;
            } else if (data.type === 'reveal') {
                addTitle();
                container.innerHTML += `<p class="mb-4 text-sm text-gray-600">Click to reveal details.</p>`;
                data.layers.forEach((l, i) => {
                    container.innerHTML += `<div onclick="toggleReveal(${i})" class="bg-white p-3 rounded shadow-sm mb-2 cursor-pointer border border-gray-200 hover:border-allgood-secondary transition-colors"><div class="flex items-center font-bold text-allgood-secondary"><i data-lucide="${l.icon}" class="w-4 h-4 mr-2"></i>${l.title}</div><div id="reveal-${i}" class="hidden mt-2 text-sm text-gray-700 pl-6">${l.content}</div></div>`;
                });
            } else if (data.type === 'slider') {
                addTitle();
                container.innerHTML += `<div class="comparison-slider-container" id="slider-container"><div class="comparison-before" style="clip-path: polygon(0 0, 50% 0, 50% 100%, 0 100%);"><h3 class="font-bold text-xl">${data.before.title}</h3><p class="text-sm">${data.before.text}</p></div><div class="comparison-after" style="clip-path: polygon(50% 0, 100% 0, 100% 100%, 50% 100%);"><h3 class="font-bold text-xl">${data.after.title}</h3><p class="text-sm">${data.after.text}</p></div><div class="comparison-divider" style="left: 50%;"><div class="comparison-divider-icon"><i class="fas fa-arrows-alt-h"></i></div></div></div><p class="text-center text-xs mt-2 text-gray-500">Drag divider to compare.</p>`;
                setupSlider();
            } else if (data.type === 'read-more') {
                addTitle();
                container.innerHTML += `<p class="mb-4 text-sm font-bold">${data.intro}</p><div id="read-more-content" class="h-20 overflow-hidden relative transition-all duration-500"><p class="text-sm text-gray-700">${data.fullText}</p><div class="absolute bottom-0 w-full h-10 bg-gradient-to-t from-allgood-light to-transparent"></div></div><button onclick="toggleReadMore()" class="mt-2 text-xs font-bold text-allgood-primary uppercase">Read More</button>`;
            } else if (data.type === 'callout-tiles') {
                addTitle();
                const tiles = data.tiles.map((t, i) => `<div onclick="this.classList.toggle('flipped')" class="h-32 perspective-1000 cursor-pointer group"><div class="relative w-full h-full transition-transform duration-500 transform-style-3d group-[.flipped]:rotate-y-180 bg-white rounded shadow-sm border border-gray-200"><div class="absolute inset-0 backface-hidden flex flex-col items-center justify-center p-2"><h4 class="font-bold text-allgood-secondary">${t.title}</h4><p class="text-xs text-gray-400 mt-1">Click to Flip</p></div><div class="absolute inset-0 backface-hidden rotate-y-180 bg-allgood-secondary text-white flex items-center justify-center p-2 text-center text-xs rounded">${t.content}</div></div></div>`).join('');
                container.innerHTML += `<div class="grid grid-cols-2 gap-4">${tiles}</div>`;
            } else if (data.type === 'numbered-accordion') {
                addTitle();
                const steps = data.steps.map((s, i) => `<div class="mb-2"><button onclick="toggleNumAcc(${i})" class="w-full text-left p-3 bg-white rounded shadow-sm flex items-center justify-between"><span class="font-bold text-sm"><span class="bg-allgood-primary text-white rounded-full w-6 h-6 inline-flex items-center justify-center text-xs mr-2">${i+1}</span>${s.title}</span><i data-lucide="chevron-down" class="w-4 h-4"></i></button><div id="num-acc-${i}" class="hidden p-3 text-sm text-gray-700 bg-gray-50 border-x border-b border-gray-200 rounded-b">${s.content}</div></div>`).join('');
                container.innerHTML += steps;
            } else if (data.type === 'quiz-filter') {
                addTitle();
                const qs = data.questions.map((q, i) => `<div class="bg-white p-4 rounded shadow-sm mb-4 border border-gray-200"><p class="font-bold text-sm mb-3">${q.text}</p><div class="flex space-x-2"><button onclick="checkFilter(${i}, 'ACTIVE', '${q.ans}')" id="btn-${i}-ACTIVE" class="flex-1 py-2 text-xs font-bold border border-allgood-primary text-allgood-primary rounded hover:bg-allgood-primary hover:text-white transition-colors">ACTIVE</button><button onclick="checkFilter(${i}, 'PASSIVE', '${q.ans}')" id="btn-${i}-PASSIVE" class="flex-1 py-2 text-xs font-bold border border-allgood-secondary text-allgood-secondary rounded hover:bg-allgood-secondary hover:text-white transition-colors">PASSIVE</button></div><p id="feedback-${i}" class="text-xs font-bold mt-2 h-4"></p></div>`).join('');
                container.innerHTML += qs;
            } else if (data.type === 'mastery-quiz') {
                addTitle();
                const quizContent = data.quiz.map((q, i) => `<div class="mb-6"><p class="font-bold text-sm mb-2">${i+1}. ${q.q}</p><div class="space-y-2">${q.options.map((opt, oi) => `<button onclick="checkMastery(${i}, ${oi}, ${q.correct})" class="w-full text-left p-3 text-sm border border-gray-200 rounded hover:bg-gray-50 mastery-opt-${i}" id="m-opt-${i}-${oi}">${String.fromCharCode(65+oi)}. ${opt}</button>`).join('')}</div><p id="m-feed-${i}" class="text-xs font-bold mt-1 hidden"></p></div>`).join('');
                container.innerHTML += `<div id="quiz-container">${quizContent}</div><button id="submit-mastery" onclick="finalizeMastery()" class="w-full bg-allgood-primary text-white font-bold py-3 rounded hidden">Submit & Finish</button>`;
            } else if (data.type === 'iframe-embed') {
                addTitle();
                container.innerHTML += `<iframe src="${data.src}" class="w-full h-96 border-0 rounded shadow-sm"></iframe>`;
            } else if (data.type === 'carousel') {
                 addTitle();
                 container.innerHTML += `<div class="bg-white p-6 rounded shadow-lg text-center"><i data-lucide="quote" class="w-8 h-8 text-allgood-primary mx-auto mb-4"></i><p id="quote-text" class="text-lg font-heading italic text-gray-700">${data.quotes[0]}</p></div><div class="flex justify-center mt-4 space-x-4"><button onclick="cycleQuote(-1)" class="p-2 bg-gray-200 rounded-full"><i data-lucide="arrow-left" class="w-4 h-4"></i></button><button onclick="cycleQuote(1)" class="p-2 bg-gray-200 rounded-full"><i data-lucide="arrow-right" class="w-4 h-4"></i></button></div>`;
                 window.currentQuote = 0;
            }

            lucide.createIcons();
            
            // Nav Button State
            document.getElementById('back-button').disabled = currentStep === 0;
            const nextBtn = document.getElementById('next-button');
            if (currentStep === courseSteps.length - 1) {
                nextBtn.style.display = 'none';
            } else {
                nextBtn.style.display = 'flex';
                // Lock Mastery
                if (data.type === 'mastery-quiz' && !masteryQuizPassed) {
                    nextBtn.disabled = true;
                    nextBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    nextBtn.disabled = false;
                    nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }
        }

        // --- INTERACTION HANDLERS ---
        // Setup Listeners
        document.getElementById('next-button').addEventListener('click', () => { if(currentStep < courseSteps.length -1) { currentStep++; renderStep(); sfx.nav(); }});
        document.getElementById('back-button').addEventListener('click', () => { if(currentStep > 0) { currentStep--; renderStep(); sfx.nav(); }});
        document.getElementById('home-button').addEventListener('click', () => { currentStep = 0; renderStep(); sfx.powerOn(); });
        
        // Tooltips
        function setupTooltips() {
            document.querySelectorAll('.tooltip-container').forEach(el => {
                el.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const content = el.querySelector('.tooltip-content').textContent;
                    const title = el.childNodes[0].textContent;
                    document.getElementById('tooltip-title').textContent = title;
                    document.getElementById('tooltip-text').textContent = content;
                    document.getElementById('tooltip-overlay').classList.remove('hidden');
                    sfx.tick();
                });
            });
        }
        window.closeTooltip = () => document.getElementById('tooltip-overlay').classList.add('hidden');

        // Accordions
        window.setupAccordions = () => {
            document.querySelectorAll('.accordion-trigger').forEach(el => {
                el.addEventListener('click', () => {
                   el.nextElementSibling.classList.toggle('hidden');
                   sfx.tick();
                });
            });
        }
        
        // Tabs
        window.switchTab = (idx) => {
            document.querySelectorAll('[id^="tab-"]').forEach((el, i) => {
                el.classList.toggle('hidden', i !== idx);
            });
            document.querySelectorAll('.tab-btn').forEach((btn, i) => {
                if(i===idx) btn.classList.add('text-allgood-primary', 'border-b-2', 'border-allgood-primary');
                else btn.classList.remove('text-allgood-primary', 'border-b-2', 'border-allgood-primary');
            });
            sfx.tick();
        }

        // Reveal
        window.toggleReveal = (i) => {
            document.getElementById(`reveal-${i}`).classList.toggle('hidden');
            sfx.tick();
        }

        // Slider
        window.setupSlider = () => {
            const container = document.getElementById('slider-container');
            const divider = container.querySelector('.comparison-divider');
            const before = container.querySelector('.comparison-before');
            const after = container.querySelector('.comparison-after');
            
            const move = (e) => {
                const rect = container.getBoundingClientRect();
                let x = (e.clientX || e.touches[0].clientX) - rect.left;
                let percent = (x / rect.width) * 100;
                percent = Math.min(100, Math.max(0, percent));
                divider.style.left = percent + "%";
                before.style.clipPath = `polygon(0 0, ${percent}% 0, ${percent}% 100%, 0 100%)`;
                after.style.clipPath = `polygon(${percent}% 0, 100% 0, 100% 100%, ${percent}% 100%)`;
            }
            container.addEventListener('mousemove', move);
            container.addEventListener('touchmove', move);
        }

        // Read More
        window.toggleReadMore = () => {
            const div = document.getElementById('read-more-content');
            if(div.classList.contains('h-20')) { div.classList.remove('h-20'); div.classList.add('h-auto'); }
            else { div.classList.add('h-20'); div.classList.remove('h-auto'); }
            sfx.tick();
        }

        // Num Accordion
        window.toggleNumAcc = (i) => {
            document.getElementById(`num-acc-${i}`).classList.toggle('hidden');
            sfx.tick();
        }

        // Quiz Filter
        window.checkFilter = (i, choice, correct) => {
            const fb = document.getElementById(`feedback-${i}`);
            if(choice === correct) {
                fb.textContent = "Correct!"; fb.className = "text-xs font-bold mt-2 h-4 text-green-600";
                sfx.tick();
            } else {
                fb.textContent = "Try again."; fb.className = "text-xs font-bold mt-2 h-4 text-red-600";
            }
        }
        
        // Carousel
        window.cycleQuote = (dir) => {
            const quotes = courseSteps[11].quotes;
            window.currentQuote = (window.currentQuote + dir + quotes.length) % quotes.length;
            document.getElementById('quote-text').textContent = quotes[window.currentQuote];
            sfx.tick();
        }

        // Mastery Quiz Logic
        let masteryScore = 0;
        let answeredCount = 0;
        window.checkMastery = (qIdx, optIdx, correctOpt) => {
            // Visual feedback only
            document.querySelectorAll(`.mastery-opt-${qIdx}`).forEach(b => b.classList.add('opacity-50', 'pointer-events-none'));
            const btn = document.getElementById(`m-opt-${qIdx}-${optIdx}`);
            btn.classList.remove('opacity-50');
            const fb = document.getElementById(`m-feed-${qIdx}`);
            fb.classList.remove('hidden');
            
            if(optIdx === correctOpt) {
                btn.classList.add('bg-green-100', 'border-green-500');
                fb.textContent = "Correct"; fb.classList.add('text-green-600');
                masteryScore++;
            } else {
                btn.classList.add('bg-red-100', 'border-red-500');
                fb.textContent = "Incorrect"; fb.classList.add('text-red-600');
            }
            answeredCount++;
            if(answeredCount === 3) document.getElementById('submit-mastery').classList.remove('hidden');
        }

        window.finalizeMastery = () => {
            if (masteryScore >= 2) {
                masteryQuizPassed = true;
                alert(`Passed! Score: ${masteryScore}/3`);
                document.getElementById('next-button').disabled = false;
                document.getElementById('next-button').classList.remove('opacity-50', 'cursor-not-allowed');
                
                // DB LOG
                window.logFinalScoreToFirestore({ 
                    score: masteryScore, 
                    maxScore: 3, 
                    status: "Passed", 
                    module: "Digital Identity", 
                    sessionId: window.sessionId 
                });
                
                if(currentStep < courseSteps.length - 1) { currentStep++; renderStep(); }
            } else {
                alert(`Score: ${masteryScore}/3. Please try again.`);
                answeredCount = 0; masteryScore = 0;
                renderStep(); // Reset
            }
        }
        
        // UI TOGGLES (Blueprint, Fullscreen, Menu)
        document.getElementById('blueprint-toggle').addEventListener('click', () => {
            document.getElementById('screen').classList.toggle('blueprint-mode');
            sfx.tick();
        });
        document.getElementById('fullscreen-toggle').addEventListener('click', () => {
            const frame = document.querySelector('.tablet-frame');
            frame.classList.toggle('focus-mode');
            sfx.tick();
        });
        document.getElementById('menu-toggle').addEventListener('click', () => {
            const modal = document.getElementById('menu-modal');
            modal.classList.remove('hidden-modal'); modal.classList.add('visible-modal');
            const list = document.getElementById('toc-list'); list.innerHTML = '';
            courseSteps.forEach((s, i) => {
                list.innerHTML += `<button onclick="currentStep=${i};renderStep();document.getElementById('menu-modal').classList.add('hidden-modal');document.getElementById('menu-modal').classList.remove('visible-modal');" class="w-full text-left px-4 py-2 hover:bg-gray-100">${i}. ${s.title}</button>`;
            });
        });
        document.getElementById('close-menu').addEventListener('click', () => {
            const modal = document.getElementById('menu-modal');
            modal.classList.add('hidden-modal'); modal.classList.remove('visible-modal');
        });

        // INIT
        document.addEventListener('DOMContentLoaded', () => {
            const startup = document.getElementById('startup-screen');
            startup.addEventListener('click', () => {
                sfx.powerOn();
                startup.style.opacity = '0';
                setTimeout(() => startup.style.display = 'none', 700);
                document.getElementById('login-modal').classList.remove('hidden-modal');
                document.getElementById('login-modal').classList.add('visible-modal');
            });
            lucide.createIcons();
        });

    </script>
</body>
</html>
