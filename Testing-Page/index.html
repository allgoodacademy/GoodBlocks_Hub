<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Allgood Academy: Your Digital Identity</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Font Awesome (Legacy Support for V2 Content) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- FIREBASE AND AUTHENTICATION SETUP -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        // Added 'signOut' to imports
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, GoogleAuthProvider, signInWithPopup, updateProfile, signOut } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, addDoc, collection, serverTimestamp, getDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
        
        // 1. CONFIGURATION (Using Environment or Fallback)
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
             apiKey: "AIzaSyAf2SO8xovrApl52udUUoR1n9WBnERr_ko", // Fallback for preview if env var missing
             authDomain: "allgood-academy.firebaseapp.com",
             projectId: "allgood-academy",
             storageBucket: "allgood-academy.firebasestorage.app",
             messagingSenderId: "978829044870",
             appId: "1:978829044870:web:6c780f64230a77ad0ab507",
             measurementId: "G-EN4M7T3BLQ"
        };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'allgood-academy';
        
        // 2. INITIALIZE SERVICES
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Expose auth for the logout function
        window.auth = auth;

        // 3. GLOBAL STATE
        window.currentUser = null;
        window.currentUserName = "Anonymous";
        window.currentUserEmail = "";
        
        // Session ID
        window.sessionId = "session_" + Date.now() + "_" + Math.floor(Math.random() * 1000);
        console.log("[System] Session ID generated:", window.sessionId);

        // 4. AUTH HANDLER
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("[Auth] User detected:", user.uid);
                window.currentUser = user;
                
                let finalName = user.displayName || localStorage.getItem('aa_username') || "Learner";
                
                window.currentUserName = finalName;
                window.currentUserEmail = user.email;
                
                // Update UI
                if(window.updateUserDisplay) window.updateUserDisplay(finalName);
                
                // Hide login modal if present
                const loginModal = document.getElementById('login-modal');
                if (loginModal && !loginModal.classList.contains('hidden-modal')) {
                    loginModal.classList.add('hidden-modal');
                    loginModal.classList.remove('visible-modal');
                }
            } else {
                console.log("[Auth] No user. Waiting for login.");
                window.currentUser = null;
                // If we are signed out, ensure the login modal is ready to show when power up happens
                const loginModal = document.getElementById('login-modal');
                if(loginModal) {
                    loginModal.classList.remove('hidden-modal');
                    loginModal.classList.add('visible-modal');
                }
            }
        });

        // 5. IDENTITY ENGINE helper
        async function ensureUserContainer(user, name, email, isGuest) {
             const userRef = doc(db, 'artifacts', appId, 'users', user.uid);
             try {
                 await setDoc(userRef, {
                     displayName: name,
                     email: email || (isGuest ? null : user.email || null),
                     isGuest: isGuest,
                     lastLogin: serverTimestamp(),
                     lastActiveModule: "Digital Identity"
                 }, { merge: true });
             } catch (e) { console.error("Identity Error", e); }
        }

        // 6. DB LOGGING
        window.logFinalScoreToFirestore = async (data) => {
            const user = auth.currentUser;
            if (!user) return;
            const sessionRef = doc(db, 'artifacts', appId, 'users', user.uid, 'game_scores', window.sessionId);
            try {
                await setDoc(sessionRef, {
                    gameName: "Your Digital Identity",
                    ...data,
                    lastUpdated: serverTimestamp(),
                    user: { uid: user.uid, displayName: window.currentUserName }
                }, { merge: true });
                console.log("DB Write Success:", data);
            } catch (e) { console.error("DB Log Failed", e); }
        }

        // 7. LOGIN FUNCTIONS
        window.handleGuestLogin = async () => {
            const nameInput = document.getElementById('user-name-input').value.trim();
            const emailInput = document.getElementById('user-email-input').value.trim();
            const btn = document.getElementById('btn-guest-login');
            
            const originalText = btn.innerText;
            btn.innerText = "Connecting...";
            btn.disabled = true;

            try {
                // Auth Check
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                     await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    let user = auth.currentUser;
                    if (!user) {
                        const result = await signInAnonymously(auth);
                        user = result.user;
                    }
                }
                
                const user = auth.currentUser;
                const displayName = nameInput || "Learner";
                await updateProfile(user, { displayName: displayName });
                
                await ensureUserContainer(user, displayName, emailInput, true);
                
                window.currentUserName = displayName;
                localStorage.setItem('aa_username', displayName);
                if(window.updateUserDisplay) window.updateUserDisplay(displayName);
                
                // Hide Modal
                document.getElementById('login-modal').classList.add('hidden-modal');
                document.getElementById('login-modal').classList.remove('visible-modal');
                
                window.showPage(0);
                if(window.sfx && window.sfx.nav) window.sfx.nav();

            } catch (error) {
                console.error("Login Failed", error);
                alert("Connection failed. Please try again.");
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        };

        window.handleGoogleLogin = async () => {
            const provider = new GoogleAuthProvider();
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                const finalName = user.displayName || "Learner";
                
                await ensureUserContainer(user, finalName, user.email, false);
                
                window.currentUserName = finalName;
                localStorage.setItem('aa_username', finalName);
                if(window.updateUserDisplay) window.updateUserDisplay(finalName);
                
                document.getElementById('login-modal').classList.add('hidden-modal');
                document.getElementById('login-modal').classList.remove('visible-modal');
                
                window.showPage(0);
                if(window.sfx && window.sfx.nav) window.sfx.nav();
            } catch (error) {
                console.error("Google Sign-In Error", error);
                console.log("Falling back to Guest Login due to popup restriction");
                window.handleGuestLogin();
            }
        };

        // 8. LOGOUT FUNCTION (NEW)
        window.handleHardReset = async () => {
            if(window.sfx && window.sfx.powerOff) window.sfx.powerOff();
            
            // 1. Sign Out
            try { await signOut(auth); } catch(e) { console.log("Signout error", e); }
            
            // 2. Clear Local Data
            localStorage.removeItem('aa_username');
            window.currentUser = null;
            window.currentUserName = "Learner";
            
            // 3. Reset UI
            if(window.updateUserDisplay) window.updateUserDisplay("Learner");
            
            // 4. Show Login Modal
            const loginModal = document.getElementById('login-modal');
            loginModal.classList.remove('hidden-modal');
            loginModal.classList.add('visible-modal');
            
            // 5. Restore Power Up Screen
            const startup = document.getElementById('startup-screen');
            if(startup) {
                startup.style.display = 'flex';
                // Small timeout to allow display:flex to apply before opacity transition
                setTimeout(() => { startup.style.opacity = '1'; }, 10);
            }
            
            window.showPage(0);
            console.log("[System] Hard Reset Complete");
        };
    </script>
    
    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'allgood-primary': '#D34716',   // Burnt Orange
                        'allgood-secondary': '#357889', // Deep Cyan
                        'allgood-dark': '#4C4C4C',      // Dark Gray
                        'allgood-light': '#F7F7F7',     // Light Gray
                        'allgood-hover': '#EB8D69',     // Light Orange
                        'allgood-accent': '#2D6473',    // Darker Cyan
                    },
                    fontFamily: {
                        'heading': ['Georgia', 'serif'],
                        'body': ['Verdana', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    
    <style>
        /* ==========================================================================
           FIXED CHASSIS MANDATE
           ========================================================================== 
        */
        body {
            font-family: Verdana, sans-serif;
            background-color: #1a1a1a;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
            background-attachment: fixed;
            min-height: 100vh;
            position: relative;
            margin: 0;
            padding: 0;
        }

        h1, h2, h3, h4, h5, h6 { font-family: Georgia, serif; }

        @keyframes pulse-glow {
            0%, 100% { text-shadow: 0 0 10px rgba(211, 71, 22, 0.4); transform: scale(1); }
            50% { text-shadow: 0 0 30px rgba(211, 71, 22, 0.9), 0 0 15px rgba(211, 71, 22, 0.6); transform: scale(1.02); }
        }
        
        .animate-pulse-glow { animation: pulse-glow 2.5s infinite ease-in-out; will-change: transform, text-shadow; }

        .tablet-frame {
            height: 80vh; width: auto; aspect-ratio: 16/10; max-width: 1100px; max-height: 95vh; min-height: 0; min-width: 0;
            background-image: radial-gradient(circle at 0% 0%, rgba(211, 71, 22, 0.35) 0%, transparent 30%), radial-gradient(circle at 100% 100%, rgba(211, 71, 22, 0.35) 0%, transparent 30%), linear-gradient(135deg, #5c5c5c 0%, #d6d6d6 25%, #8a8a8a 50%, #e0e0e0 75%, #5c5c5c 100%);
            border-radius: 12px; padding: 12px; 
            box-shadow: inset 1px 1px 2px rgba(255,255,255, 0.6), inset -1px -1px 2px rgba(0,0,0, 0.8), 0 30px 60px -12px rgba(0, 0, 0, 0.8), 0 0 0 1px #111;
            border: 1px solid #333; position: relative; margin: 20px auto; transition: width 0.3s, height 0.3s, padding 0.3s;
        }

        .tablet-frame::before {
            content: ''; position: absolute; top: 10px; left: 10px; right: 10px; bottom: 10px;
            border-radius: 6px; background: #111; z-index: 0;
        }

        .screen-container {
            width: 100%; height: 100%; background-color: #F7F7F7;
            position: relative; z-index: 1; overflow: hidden;
            display: flex; flex-direction: column; 
            border-radius: 4px; box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }

        .page::-webkit-scrollbar { width: 14px; }
        .page::-webkit-scrollbar-track { background: #e5e5e5; border-left: 1px solid #d1d5db; }
        .page::-webkit-scrollbar-thumb { background-color: #D34716; border-radius: 7px; border: 3px solid #e5e5e5; }
        .page::-webkit-scrollbar-thumb:hover { background-color: #EB8D69; }

        .modal-transition { transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out; }
        .hidden-modal { opacity: 0; pointer-events: none; transform: translateY(-10px); }
        .visible-modal { opacity: 1; pointer-events: auto; transform: translateY(0); }
        
        #flex-progress-bar { height: 4px; width: 100%; background-color: #eee; position: absolute; top: 0; left: 0; }
        #flex-progress-fill { height: 100%; background-color: #D34716; width: 0%; transition: width 0.3s ease; }

        .blueprint-mode { background-color: #0f172a !important; color: #94a3b8 !important; }
        .blueprint-mode .page { background-color: #0f172a !important; }
        .blueprint-mode h1, .blueprint-mode h2, .blueprint-mode h3, .blueprint-mode strong { color: #38bdf8 !important; }
        .blueprint-mode .bg-white { background-color: #1e293b !important; border-color: #334155 !important; color: #cbd5e1 !important; }
        .blueprint-mode .text-allgood-dark { color: #e2e8f0 !important; }
        .blueprint-mode .bg-gray-100, .blueprint-mode .bg-gray-50, .blueprint-mode .bg-blue-50 { background-color: #0f172a !important; border-color: #1e293b !important; }
        .blueprint-mode .accordion-content { background-color: #0f172a !important; border-color: #334155 !important; color: #94a3b8 !important; }
        .blueprint-mode .footer-content { background-color: #1e293b !important; border-top-color: #334155 !important; color: #94a3b8 !important; }
        .blueprint-mode .footer-content a { color: #38bdf8 !important; }
        .blueprint-mode .footer-content #back-button { color: #94a3b8 !important; }
        .blueprint-mode .footer-content #back-button:not(:disabled):hover { color: #38bdf8 !important; }

        .tablet-frame.focus-mode { 
            position: absolute !important; top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important; 
            width: 100% !important; height: 100% !important;
            aspect-ratio: auto !important; max-width: none !important; max-height: none !important; 
            min-height: 0 !important;
            margin: 0 !important; padding: 0 !important; 
            background: #F7F7F7 !important; border: none !important; border-radius: 0 !important; 
            box-shadow: none !important; z-index: 99999 !important;
            background-image: none !important;
        }
        .tablet-frame.focus-mode::before { display: none; }
        .tablet-frame.focus-mode .screen-container { border-radius: 0; box-shadow: none; height: 100%; }
        .tablet-frame.focus-mode .footer-content { padding-bottom: 0; }
        body.is-focused main { padding: 0 !important; }

        @media (max-width: 768px) {
            body { padding: 0 !important; overflow: hidden; }
            main { padding: 0 !important; height: 100vh; }
            .tablet-frame {
                position: absolute !important; inset: 0 !important;
                width: 100% !important; height: 100% !important;
                max-width: none !important; max-height: none !important;
                min-height: 0 !important; aspect-ratio: auto !important;
                margin: 0 !important; padding: 0 !important;
                border: none !important; border-radius: 0 !important;
                background-image: none !important; box-shadow: none !important;
            }
            .tablet-frame::before { display: none; }
            .screen-container { border-radius: 0 !important; box-shadow: none !important; }
            .footer-content { padding-bottom: max(env(safe-area-inset-bottom), 20px); height: auto; }
        }

        .navbar-content { flex: 0 0 60px; z-index: 20; }
        .page { flex: 1 1 auto; overflow-y: auto; padding: 20px; position: relative; display: none; width: 100%; }
        .page.active { display: block; }
        .footer-content { flex: 0 0 60px; z-index: 20; background-color: white; border-top: 1px solid #e5e7eb; position: relative; }
        
        /* Tooltip */
        .tooltip-trigger:hover > .tooltip-popup,
        .tooltip-trigger:focus-within > .tooltip-popup {
            display: block;
        }
        
        /* Comparison Slider */
        .comparison-slider-container { position: relative; height: 300px; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.1); user-select: none; }
        .comparison-before, .comparison-after { position: absolute; top: 0; left: 0; width: 100%; height: 100%; padding: 2rem; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; color: white; }
        .comparison-before { background-color: #D34716; } 
        .comparison-after { background-color: #357889; } 
        .comparison-divider { position: absolute; top: 0; bottom: 0; width: 4px; background-color: white; cursor: col-resize; z-index: 10; left: 50%; }
        .comparison-divider-icon { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; background-color: rgba(0,0,0,0.5); border-radius: 50%; padding: 0.5rem; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }

        /* Tiles */
        .perspective-container { perspective: 1000px; }
        .callout-tile { transition: transform 0.6s; transform-style: preserve-3d; cursor: pointer; position: relative; width: 100%; height: 100%; }
        .callout-tile.flipped { transform: rotateY(180deg); }
        .tile-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 1rem; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .tile-back { transform: rotateY(180deg); background-color: #f3f4f6; border: 2px solid #e5e7eb; }

        /* Quiz Buttons */
        .quiz-btn.selected { ring: 2px solid; transform: scale(0.98); }
        .quiz-btn.correct { background-color: #10B981 !important; border-color: #10B981 !important; color: white !important; }
        .quiz-btn.incorrect { background-color: #EF4444 !important; border-color: #EF4444 !important; color: white !important; }
        
    </style>
</head>
<body class="flex flex-col min-h-screen text-allgood-dark font-body overflow-y-auto">

    <main class="flex-grow flex items-center justify-center py-8">
        <div class="tablet-frame">
            <div class="screen-container" id="screen">

                <!-- FIXED STARTUP SCREEN -->
                <div id="startup-screen" class="absolute inset-0 z-[300] flex flex-col items-center justify-center cursor-pointer transition-opacity duration-700 ease-in-out bg-gradient-to-br from-allgood-secondary to-allgood-accent">
                    <div class="group flex flex-col items-center justify-center text-center h-full w-full relative">
                        <div class="flex-grow flex flex-col items-center justify-center px-4">
                            <div class="relative">
                                <div class="absolute inset-0 bg-white/10 blur-2xl rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                                <h2 class="text-xl md:text-3xl font-heading font-bold text-white mb-1 relative z-10">Your Digital Identity</h2>
                                <h1 class="text-4xl md:text-6xl font-heading font-bold text-allgood-primary tracking-tighter relative z-10 drop-shadow-md animate-pulse-glow">GoodBlock</h1>
                            </div>
                            <p class="mt-12 text-white/80 text-xs tracking-[0.3em] uppercase font-medium group-hover:text-white transition-colors animate-pulse font-body">Click to Power Up</p>
                        </div>
                        <div class="absolute bottom-10 w-full text-center">
                            <p class="text-white/40 text-xs font-body tracking-wide">Powered by the <span class="text-white/60 font-bold">Allgood Academy</span></p>
                        </div>
                    </div>
                </div>

                <!-- FIXED HEADER -->
                <header class="bg-allgood-secondary shadow-md navbar-content flex items-center">
                    <div class="w-full px-4 flex items-center justify-between h-full">
                        <div class="flex items-center overflow-hidden">
                            <div id="header-welcome-text" class="flex-shrink-0 text-white font-heading font-bold text-lg tracking-tight truncate mr-4 select-none">Welcome: Learner</div>
                            <div class="hidden sm:flex items-center bg-black/20 rounded-full px-3 py-1 border border-white/10 shadow-inner backdrop-blur-sm">
                                <span class="text-[10px] uppercase tracking-wider text-white/60 mr-2 font-heading font-bold">Page</span>
                                <span id="header-page-indicator" class="text-xs font-bold text-white font-body tabular-nums">1 / 15</span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-1 shrink-0 relative">
                            <!-- ADDED title tooltip to home button -->
                            <button id="home-button" class="text-gray-200 hover:text-white transition-colors p-2 rounded-full hover:bg-white/10" title="Click to Reset Page | Hold 2s to Logout"><i class="fas fa-home text-lg"></i></button>
                            <div class="h-6 w-px bg-white/20 mx-1"></div>
                            <button id="blueprint-toggle" class="text-gray-200 hover:text-cyan-300 transition-colors p-2 rounded-full hover:bg-white/10"><i class="fas fa-moon"></i></button>
                            <button id="fullscreen-toggle" class="text-gray-200 hover:text-green-300 transition-colors p-2 rounded-full hover:bg-white/10"><i class="fas fa-expand"></i></button>
                            <button id="menu-toggle" class="text-gray-200 hover:text-white transition-colors p-2 rounded-full hover:bg-white/10"><i class="fas fa-bars text-xl"></i></button>
                        </div>
                    </div>
                </header>

                <!-- LOGIN MODAL -->
                <div id="login-modal" class="absolute inset-0 z-[200] bg-allgood-dark/95 flex items-center justify-center p-6 visible-modal modal-transition backdrop-blur-sm">
                    <div class="bg-white rounded-lg shadow-2xl p-8 max-w-sm w-full text-center border-t-4 border-allgood-primary">
                        <div class="mb-6"><h2 class="text-3xl font-heading font-bold text-allgood-dark">Allgood<span class="text-allgood-primary">Academy</span></h2></div>
                        <h2 class="text-xl font-bold text-allgood-dark mb-2 font-heading">Welcome</h2>
                        <div class="flex items-center justify-center gap-2 mb-6 relative">
                            <p class="text-gray-500 text-sm font-body">Please sign in to start.</p>
                            <button id="policy-trigger" class="group relative flex items-center text-allgood-primary hover:text-allgood-hover transition-colors focus:outline-none">
                                <i class="fas fa-question-circle mr-1"></i>
                                <span class="text-xs font-bold underline decoration-dotted underline-offset-2">Why?</span>
                                <div class="absolute top-full left-1/2 transform -translate-x-1/2 mt-3 w-64 p-3 bg-gray-800 text-white text-xs text-left rounded shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible group-focus:opacity-100 group-focus:visible transition-all duration-200 z-50 font-body leading-relaxed border border-gray-700 pointer-events-none">
                                    <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-b-gray-800"></div>
                                    <strong class="block text-allgood-primary mb-1 uppercase tracking-wide text-[10px]">Why do we ask?</strong>
                                    <p class="mb-2 text-gray-300">We use your name to personalize your badge. Performance data is logged in real-time to improve the GoodBlock experience. All personal data is kept confidential and never sold.</p>
                                    <div class="border-t border-gray-700 my-1 pt-1"></div>
                                    <p class="text-gray-300"><strong>Email (Optional):</strong> Enter to join the Allgood Academy community.</p>
                                </div>
                            </button>
                        </div>
                        <input type="text" id="user-name-input" placeholder="Your Name (Optional)" class="w-full border border-gray-300 rounded p-3 mb-3 focus:ring-2 focus:ring-allgood-primary focus:border-transparent outline-none transition-all font-body">
                        <input type="email" id="user-email-input" placeholder="Your Email (Optional)" class="w-full border border-gray-300 rounded p-3 mb-6 focus:ring-2 focus:ring-allgood-primary focus:border-transparent outline-none transition-all font-body">
                        <button id="btn-guest-login" onclick="window.handleGuestLogin()" class="w-full bg-allgood-primary hover:bg-allgood-hover text-white font-bold py-3 rounded shadow-md transition-transform transform hover:scale-[1.02] active:scale-[0.98] font-body uppercase">Start Challenge</button>
                        <div class="mt-4 flex items-center justify-center space-x-2"><div class="h-px w-10 bg-gray-200"></div><p class="text-xs text-gray-500 uppercase font-bold">OR</p><div class="h-px w-10 bg-gray-200"></div></div>
                        <button id="google-icon-container" onclick="window.handleGoogleLogin()" class="mt-4 p-2 rounded-full border border-gray-300 shadow-md hover:shadow-lg transition-all duration-200 hover:scale-105 active:scale-95 bg-white flex items-center justify-center mx-auto">
                            <svg class="w-6 h-6" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                        </button>
                    </div>
                </div>

                <!-- MENU MODAL -->
                <div id="menu-modal" class="hidden-modal absolute inset-0 z-[100] bg-black/60 flex justify-end modal-transition">
                    <div class="w-72 h-full bg-white shadow-xl flex flex-col border-l border-gray-200">
                        <div class="p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                            <span class="font-bold text-allgood-dark font-heading">Course Map</span>
                            <button id="close-menu" class="text-gray-500 hover:text-allgood-primary"><i class="fas fa-times text-xl"></i></button>
                        </div>
                        <div class="p-2 overflow-y-auto flex-grow space-y-1 text-sm font-body" id="toc-list"></div>
                    </div>
                </div>

                <!-- 
                   ==========================================================================
                   CONTENT PAGES (1-15) - 1-TO-1 MAPPING AUDIT
                   ========================================================================== 
                -->

                <!-- Page 1: Welcome (V2 Step 0) -->
                <div class="page active" id="page-1">
                    <div class="flex flex-col items-center justify-center min-h-full py-10 text-center px-6">
                        <img src="https://i.ibb.co/3yvdN59b/Horizontal-Logo.png" alt="Allgood Academy Logo" class="w-48 mb-8 opacity-80">
                        <h2 class="text-2xl font-heading font-bold text-allgood-dark">Welcome to the</h2>
                        <h1 class="text-4xl sm:text-5xl font-heading font-bold text-allgood-primary mb-4 leading-tight">"Your Digital Identity"<br><span class="text-allgood-secondary">GoodBlock</span></h1>
                        <p class="text-lg text-gray-600 mb-8 max-w-md font-bold">Master your online footprint.</p>
                        
                        <!-- NEW ACCORDION -->
                        <div class="w-full max-w-md text-left mb-8">
                            <button class="accordion-toggle w-full bg-white border border-gray-200 p-4 rounded-lg shadow-sm flex justify-between items-center hover:bg-gray-50 hover:border-allgood-primary transition-all group" onclick="toggleAccordion(this)">
                                <span class="font-bold text-allgood-dark text-base group-hover:text-allgood-primary transition-colors font-heading">How to use this GoodBlock</span>
                                <i class="fas fa-chevron-down text-gray-400 transform transition-transform duration-300 group-hover:text-allgood-primary"></i>
                            </button>
                            <div class="accordion-content hidden bg-gray-50 border-x border-b border-gray-200 rounded-b-lg p-5 text-gray-600 shadow-inner text-xs font-body">
                                <p class="mb-4 text-sm text-allgood-dark">This GoodBlock is your interactive workspace. Use the <strong>Control Cluster</strong> in the top right to customize your environment.</p>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div class="flex items-start">
                                        <div class="p-1.5 bg-white rounded border border-gray-300 mr-3 text-allgood-primary w-8 h-8 flex items-center justify-center shrink-0">
                                            <i class="fas fa-home"></i>
                                        </div>
                                        <div>
                                            <strong class="text-allgood-dark block mb-0.5">Home & Reset</strong>
                                            <span class="text-gray-500 leading-snug">Click to return to cover. <strong>Hold for 2s</strong> to hard reset & sign out.</span>
                                        </div>
                                    </div>
                                    <div class="flex items-start">
                                        <div class="p-1.5 bg-white rounded border border-gray-300 mr-3 text-cyan-600 w-8 h-8 flex items-center justify-center shrink-0">
                                            <i class="fas fa-moon"></i>
                                        </div>
                                        <div>
                                            <strong class="text-allgood-dark block mb-0.5">Blueprint Mode</strong>
                                            <span class="text-gray-500 leading-snug">Toggle high-contrast Dark Mode for low-light environments.</span>
                                        </div>
                                    </div>
                                    <div class="flex items-start">
                                        <div class="p-1.5 bg-white rounded border border-gray-300 mr-3 text-green-600 w-8 h-8 flex items-center justify-center shrink-0">
                                            <i class="fas fa-expand"></i>
                                        </div>
                                        <div>
                                            <strong class="text-allgood-dark block mb-0.5">Focus Mode</strong>
                                            <span class="text-gray-500 leading-snug">Maximize workspace. Removes the frame for mobile devices.</span>
                                        </div>
                                    </div>
                                    <div class="flex items-start">
                                        <div class="p-1.5 bg-white rounded border border-gray-300 mr-3 text-gray-600 w-8 h-8 flex items-center justify-center shrink-0">
                                            <i class="fas fa-bars"></i>
                                        </div>
                                        <div>
                                            <strong class="text-allgood-dark block mb-0.5">Table of Contents</strong>
                                            <span class="text-gray-500 leading-snug">Jump directly to any section without losing progress.</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gray-100 p-4 rounded-lg border-l-4 border-allgood-secondary max-w-md w-full text-left">
                            <p class="text-sm font-bold text-allgood-secondary mb-1">Learn how to:</p>
                            <p class="text-sm text-gray-700">Understand Active/Passive Data; Recognize permanence; Create a 4-step management plan.</p>
                        </div>
                    </div>
                </div>

                <!-- Page 2: What is a Footprint? (V2 Step 1) -->
                <div class="page" id="page-2">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark">What is a Digital Footprint?</h2></section>
                    <div class="max-w-2xl mx-auto">
                        <p class="text-gray-700 text-base mb-4">Your digital footprint is the trail of data you leave behind when you use the internet. It includes everything from your social media posts and search history to website cookies and location data tracked by apps.</p>
                        <div class="bg-white border-l-4 border-allgood-primary p-6 rounded shadow-md my-8">
                            <p class="text-sm font-semibold text-allgood-primary">Think of it as your <strong>digital identity</strong>. It's how you appear to the world online, and it's often permanent.</p>
                        </div>
                        <p class="mt-4 text-sm text-gray-700">Understanding this footprint is the first step to managing your online reputation and protecting your privacy.</p>
                    </div>
                </div>

                <!-- Page 3: Core Concepts (V2 Step 2 - POPUP FIX) -->
                <div class="page" id="page-3">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark">Defining the Core Concepts</h2></section>
                    
                    <div class="max-w-2xl mx-auto space-y-4">
                        <p class="text-gray-700 text-base">Your digital footprint is split into two main categories. Understanding both is critical to seeing the full picture of your online identity.</p>
                        
                        <h3 class="text-lg font-semibold mb-3 font-heading text-allgood-secondary">Two Types of Data Trails</h3>
                        
                        <p class="text-sm text-gray-700">
                            The first part is your 
                            <span class="tooltip-trigger relative inline-block cursor-pointer border-b-2 border-dashed border-allgood-secondary text-allgood-secondary font-bold">
                                Active Footprint
                                <span class="tooltip-popup hidden absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-64 p-3 bg-white text-gray-700 text-xs rounded shadow-xl border border-gray-200 z-50 font-normal normal-case">
                                    <span class="absolute bottom-[-6px] left-1/2 transform -translate-x-1/2 w-3 h-3 bg-white border-r border-b border-gray-200 rotate-45"></span>
                                    Data you intentionally and knowingly share online. This includes your social media posts, blog entries, emails you send, or forms you fill out.
                                </span>
                            </span>. 
                            This is the identity you <em>choose</em> to build.
                        </p>
                        
                        <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-allgood-secondary">
                            <p class="font-bold mb-1 text-sm text-allgood-secondary">
                                The second, hidden part is your 
                                <span class="tooltip-trigger relative inline-block cursor-pointer border-b-2 border-dashed border-allgood-secondary text-allgood-secondary font-bold">
                                    Passive Footprint
                                    <span class="tooltip-popup hidden absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-64 p-3 bg-white text-gray-700 text-xs rounded shadow-xl border border-gray-200 z-50 font-normal normal-case">
                                        <span class="absolute bottom-[-6px] left-1/2 transform -translate-x-1/2 w-3 h-3 bg-white border-r border-b border-gray-200 rotate-45"></span>
                                        Data collected without your active input or knowledge. This includes your IP address, browsing history, device information, and location data tracked by apps and websites.
                                    </span>
                                </span>.
                            </p>
                        </div>
                        
                        <p class="mt-4 italic text-xs text-gray-600">Your passive footprint often says more about you than your active one.</p>
                    </div>
                </div>

                <!-- Page 4: Danger of Passive (V2 Step 3 - RESTORED FULL TEXT) -->
                <div class="page" id="page-4">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark">The Danger of the Passive Footprint</h2></section>
                    <p class="mb-6 text-sm text-gray-600">Your 'hidden' footprint is constantly being tracked, analyzed, and sold. Click below to see how this data is used.</p>
                    
                    <div class="space-y-4 max-w-2xl mx-auto">
                        <!-- Reveal 1 -->
                        <div class="border border-gray-200 rounded-lg overflow-hidden">
                            <button class="w-full text-left p-4 bg-gray-50 hover:bg-gray-100 flex justify-between items-center font-bold text-allgood-dark" onclick="toggleReveal(this)">
                                <span><i class="fas fa-satellite-dish mr-2"></i> 1. The Data Collection</span> <i class="fas fa-chevron-down"></i>
                            </button>
                            <div class="hidden p-4 bg-white text-sm text-gray-700 italic">
                                <strong>Scenario:</strong> You use a free weather app. You actively check the forecast (your active footprint). Passively, the app requests your location data, which you grant. It now tracks everywhere you go, 24/7.
                            </div>
                        </div>
                        <!-- Reveal 2 -->
                        <div class="border border-gray-200 rounded-lg overflow-hidden">
                            <button class="w-full text-left p-4 bg-gray-50 hover:bg-gray-100 flex justify-between items-center font-bold text-allgood-dark" onclick="toggleReveal(this)">
                                <span><i class="fas fa-handshake mr-2"></i> 2. The Data Broker</span> <i class="fas fa-chevron-down"></i>
                            </button>
                            <div class="hidden p-4 bg-white text-sm text-gray-700 italic">
                                The weather app company sells your location data stream to a 'data broker.' This broker combines your location data with your browsing history (also purchased) and public records (your name, address).
                            </div>
                        </div>
                        <!-- Reveal 3 -->
                        <div class="border border-gray-200 rounded-lg overflow-hidden">
                            <button class="w-full text-left p-4 bg-gray-50 hover:bg-gray-100 flex justify-between items-center font-bold text-allgood-dark" onclick="toggleReveal(this)">
                                <span><i class="fas fa-brain mr-2"></i> 3. The Core Pragmatic Insight</span> <i class="fas fa-chevron-down"></i>
                            </button>
                            <div class="hidden p-4 bg-white text-sm text-gray-700">
                                <p class="font-bold mb-1 text-sm text-allgood-secondary">You are not the customer; you are the product.</p>
                                <p class="text-xs text-gray-700">This combined profile is sold to advertisers, insurance companies, or even future employers to make decisions about you. Your passive footprint is used to judge your habits, interests, and risks.</p>
                                <p class="mt-3 text-xs text-gray-700 font-semibold">Managing your digital identity means controlling <em>both</em> your active and passive data trails.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Page 5: Before vs After (V2 Step 4) -->
                <div class="page" id="page-5">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark">Before vs. After: The Internal Shift</h2></section>
                    <p class="text-gray-700 mb-4 text-sm">To manage your footprint, you must shift your mindset from being a passive 'user' to a pragmatic 'owner' of your identity.</p>
                    
                    <div class="space-y-4 max-w-2xl mx-auto">
                        <!-- Before -->
                        <div class="bg-white border-l-4 border-allgood-primary p-4 rounded shadow-sm">
                            <button class="w-full flex justify-between text-left" onclick="toggleReveal(this)">
                                <div>
                                    <h4 class="font-bold text-base text-allgood-primary">Focus on Convenience (The Old Habit)</h4>
                                    <p class="text-xs text-gray-600">Using free apps, clicking "Agree" without reading, oversharing.</p>
                                </div>
                                <i class="fas fa-chevron-down text-gray-400 mt-1"></i>
                            </button>
                            <div class="hidden mt-3 pt-3 border-t border-gray-100">
                                <p class="mt-2 font-medium text-xs text-gray-700"><strong>Goal:</strong> I want this app/service right now, for free.</p>
                                <p class="mt-1 font-medium text-xs text-gray-700"><strong>Action:</strong> Clicking "Allow All Cookies" or "Agree" to get to the content faster.</p>
                            </div>
                        </div>
                        
                        <!-- After -->
                        <div class="bg-white border-l-4 border-allgood-secondary p-4 rounded shadow-sm">
                            <button class="w-full flex justify-between text-left" onclick="toggleReveal(this)">
                                <div>
                                    <h4 class="font-bold text-base text-allgood-secondary">Focus on Control (The New Habit)</h4>
                                    <p class="text-xs text-gray-600">Questioning the data exchange, managing settings, sharing intentionally.</p>
                                </div>
                                <i class="fas fa-chevron-down text-gray-400 mt-1"></i>
                            </button>
                            <div class="hidden mt-3 pt-3 border-t border-gray-100">
                                <p class="mt-2 font-medium text-xs text-gray-700"><strong>Goal:</strong> Is the value of this app worth the data I am giving it?</p>
                                <p class="mt-1 font-medium text-xs text-gray-700"><strong>Action:</strong> Denying non-essential cookies, turning off location services for apps that don't need it.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Page 6: Myth vs Reality (V2 Step 5) -->
                <div class="page" id="page-6">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark">Myth vs. Reality</h2></section>
                    <p class="mb-4 text-sm">Your online actions have permanent consequences. Contrast the common myth with the pragmatic reality.</p>
                    
                    <div class="flex space-x-2 mb-4">
                        <button onclick="switchTab('myth')" id="tab-myth" class="flex-1 py-3 font-bold text-center bg-white border-b-2 border-red-600 text-red-600 rounded-t-lg transition-colors">Myth: 'I Can Delete It'</button>
                        <button onclick="switchTab('reality')" id="tab-reality" class="flex-1 py-3 font-bold text-center bg-gray-100 text-gray-600 hover:bg-gray-200 rounded-t-lg transition-colors">Reality: 'It's Permanent'</button>
                    </div>
                    
                    <div id="content-myth" class="bg-red-50 p-8 rounded-b-lg rounded-tr-lg min-h-[200px] flex flex-col items-center justify-center text-center">
                        <i class="fas fa-trash-alt text-4xl text-red-700 mb-4"></i>
                        <h4 class="font-bold text-base text-red-700 font-heading">"If I delete my post, it's gone forever."</h4>
                        <p class="text-sm mt-2 text-gray-700">This is a dangerous myth. Once something is online, it can be screenshotted, saved, and archived by web crawlers (like the Wayback Machine) or other users. Deleting it only removes it from your view.</p>
                    </div>
                    
                    <div id="content-reality" class="hidden bg-green-50 p-8 rounded-b-lg rounded-tl-lg min-h-[200px] flex flex-col items-center justify-center text-center">
                        <i class="fas fa-archive text-4xl text-green-700 mb-4"></i>
                        <h4 class="font-bold text-base text-green-700 font-heading">"Assume everything I post is permanent."</h4>
                        <p class="text-sm mt-2 text-gray-700">This is the correct, pragmatic mindset. Before you post, email, or send, ask yourself: "Would I be okay with this being on a billboard next to my face forever?" If the answer is no, don't post it.</p>
                    </div>
                </div>

                <!-- Page 7: Who Is Watching (V2 Step 6 - RESTORED FULL TEXT) -->
                <div class="page" id="page-7">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark">Who Is Watching Your Footprint?</h2></section>
                    <p class="text-sm text-gray-600 mb-6">Your data is valuable to many different groups. Click to see who is analyzing your profile.</p>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div class="flip-card" onclick="this.classList.toggle('flipped')">
                            <div class="flip-card-inner">
                                <div class="flip-card-front">
                                    <i class="fas fa-bullhorn text-3xl text-allgood-secondary mb-2"></i>
                                    <h3 class="font-bold text-sm">1. Advertisers & Marketers</h3>
                                </div>
                                <div class="flip-card-back bg-allgood-secondary text-white">
                                    <p class="text-xs">This is the most common. They use your passive footprint (browsing, location) to build a profile and sell you products. This is why you see ads for things you <em>just</em> talked about.</p>
                                </div>
                            </div>
                        </div>
                        <div class="flip-card" onclick="this.classList.toggle('flipped')">
                            <div class="flip-card-inner">
                                <div class="flip-card-front">
                                    <i class="fas fa-user-tie text-3xl text-allgood-primary mb-2"></i>
                                    <h3 class="font-bold text-sm">2. Employers & Colleges</h3>
                                </div>
                                <div class="flip-card-back bg-allgood-primary text-white">
                                    <p class="text-xs">This is high-stakes. 70% of employers use social media to screen candidates. Your active footprint (posts, photos, comments) is used to judge your character, professionalism, and alignment with their values.</p>
                                </div>
                            </div>
                        </div>
                        <div class="flip-card" onclick="this.classList.toggle('flipped')">
                            <div class="flip-card-inner">
                                <div class="flip-card-front">
                                    <i class="fas fa-user-secret text-3xl text-gray-600 mb-2"></i>
                                    <h3 class="font-bold text-sm">3. Data Brokers & Bad Actors</h3>
                                </div>
                                <div class="flip-card-back bg-gray-600 text-white">
                                    <p class="text-xs">Data brokers buy and sell your data without your knowledge. Worse, scammers and identity thieves can use your publicly available active data (birthday, hometown, pet's name) to answer security questions and gain access to your accounts.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Page 8: Cost of Free (V2 Step 7 - RESTORED FULL TEXT) -->
                <div class="page" id="page-8">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark">The High Cost of 'Free'</h2></section>
                    
                    <div class="bg-gradient-to-r from-gray-900 to-gray-800 p-8 rounded-xl text-white shadow-xl max-w-2xl mx-auto">
                        <p class="text-sm mb-4">Social media and search engines feel free, but you are paying with a valuable currency: your personal data.</p>
                        
                        <p class="text-sm pb-1">There's a common saying in tech: 'If you're not paying for the product, you <em>are</em> the product.' This is the fundamental business model of the modern internet. Companies like Google and Meta (Facebook/Instagram) provide incredible services 'for free.' They don't charge you money; they charge you in data.</p>
                        
                        <div id="read-more-content" class="hidden text-sm pb-1 mt-2">
                            <p>Your searches, your 'likes,' the time you spend looking at a photo, your locationall of it is collected. This data is used to build an astonishingly accurate profile of your personality, your desires, your fears, and your political beliefs. This profile is then sold to advertisers who want to influence your behavior, whether it's buying a product or thinking a certain way. The 'free' service is just the bait to capture the real product: your attention and your data.</p>
                        </div>
                        
                        <button id="read-more-btn" class="mt-4 text-xs font-bold text-allgood-primary hover:text-white uppercase tracking-wider flex items-center" onclick="toggleReadMore()">
                            Read More <i class="fas fa-chevron-down ml-2"></i>
                        </button>
                    </div>
                </div>

                <!-- Page 9: Public vs Private Slider (V2 Step 8) -->
                <div class="page" id="page-9">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark">Public vs. Private Identity</h2></section>
                    <p class="text-sm text-gray-600 mb-4">Your online identity is a balance. Drag the divider to visualize the difference between what you show and what you protect.</p>
                    
                    <div class="comparison-slider-container" id="slider-container">
                        <div class="comparison-before">
                            <i class="fas fa-eye text-4xl mb-4 text-white/80"></i>
                            <h3 class="font-bold font-heading text-xl mb-2">Public Self</h3>
                            <p class="text-sm">What you post publicly. This is your 'brand.' It should be professional, positive, and curated. This is what employers and strangers see.</p>
                        </div>
                        <div class="comparison-after" id="slider-after">
                            <i class="fas fa-lock text-4xl mb-4 text-white/80"></i>
                            <h3 class="font-bold font-heading text-xl mb-2">Private Self</h3>
                            <p class="text-sm">What you share only with trusted friends or keep to yourself. This includes personal feelings, private jokes, and sensitive information.</p>
                        </div>
                        <div class="comparison-divider" id="slider-divider">
                            <div class="comparison-divider-icon"><i class="fas fa-arrows-alt-h"></i></div>
                        </div>
                    </div>
                </div>

                <!-- Page 10: Four Rules (V2 Step 9) - QUOTES REMOVED -->
                <div class="page" id="page-10">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark">The Four Rules of Ownership</h2></section>
                    <p class="text-sm mb-4">Take control of your digital identity by following these four non-negotiable rules. Click to reveal the <strong>Pragmatic Action</strong> for each rule.</p>
                    
                    <div class="grid grid-cols-2 gap-4 h-[400px]">
                        <!-- Tile 1 -->
                        <div class="perspective-container h-48 w-full">
                            <div class="callout-tile" onclick="this.classList.toggle('flipped')">
                                <div class="tile-face bg-white border-b-4 border-allgood-primary">
                                    <i class="fas fa-pause-circle text-3xl text-allgood-primary mb-2"></i>
                                    <h4 class="font-bold text-sm">1. The Pause</h4>
                                    <p class="text-xs text-gray-500 mt-1">Tap to Reveal</p>
                                </div>
                                <div class="tile-face tile-back">
                                    <p class="text-xs italic text-gray-700 text-center">Action: Before you post, pause for 10 seconds. Ask: 'Is this permanent? Is this public?'</p>
                                    <span class="text-xs mt-2 font-semibold text-allgood-primary">The Key Takeaway</span>
                                </div>
                            </div>
                        </div>
                        <!-- Tile 2 -->
                        <div class="perspective-container h-48 w-full">
                            <div class="callout-tile" onclick="this.classList.toggle('flipped')">
                                <div class="tile-face bg-white border-b-4 border-allgood-secondary">
                                    <i class="fas fa-user-shield text-3xl text-allgood-secondary mb-2"></i>
                                    <h4 class="font-bold text-sm">2. The Audit</h4>
                                    <p class="text-xs text-gray-500 mt-1">Tap to Reveal</p>
                                </div>
                                <div class="tile-face tile-back">
                                    <p class="text-xs italic text-gray-700 text-center">Action: Once a month, Google your own name. See what employers see. Clean up old, unprofessional posts or photos.</p>
                                    <span class="text-xs mt-2 font-semibold text-allgood-secondary">The Key Takeaway</span>
                                </div>
                            </div>
                        </div>
                        <!-- Tile 3 -->
                        <div class="perspective-container h-48 w-full">
                            <div class="callout-tile" onclick="this.classList.toggle('flipped')">
                                <div class="tile-face bg-white border-b-4 border-orange-300">
                                    <i class="fas fa-cog text-3xl text-orange-300 mb-2"></i>
                                    <h4 class="font-bold text-sm">3. The Settings</h4>
                                    <p class="text-xs text-gray-500 mt-1">Tap to Reveal</p>
                                </div>
                                <div class="tile-face tile-back">
                                    <p class="text-xs italic text-gray-700 text-center">Action: Go into your app settings (Facebook, Google, Instagram) and review your privacy and location settings. Turn off everything that isn't essential.</p>
                                    <span class="text-xs mt-2 font-semibold text-orange-300">The Key Takeaway</span>
                                </div>
                            </div>
                        </div>
                        <!-- Tile 4 -->
                        <div class="perspective-container h-48 w-full">
                            <div class="callout-tile" onclick="this.classList.toggle('flipped')">
                                <div class="tile-face bg-white border-b-4 border-gray-600">
                                    <i class="fas fa-key text-3xl text-gray-600 mb-2"></i>
                                    <h4 class="font-bold text-sm">4. The Security</h4>
                                    <p class="text-xs text-gray-500 mt-1">Tap to Reveal</p>
                                </div>
                                <div class="tile-face tile-back">
                                    <p class="text-xs italic text-gray-700 text-center">Action: Use a password manager and enable two-factor authentication (2FA) on all accounts. Don't use personal info (like pet names) in passwords.</p>
                                    <span class="text-xs mt-2 font-semibold text-gray-600">The Key Takeaway</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Page 11: Action Plan (V2 Step 10) -->
                <div class="page" id="page-11">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark">The GoodBlock 4-Step Action Plan</h2></section>
                    <p class="text-sm mb-4">Use this pragmatic checklist to clean up your past and protect your future.</p>
                    
                    <div class="space-y-3">
                        <div class="border border-gray-200 rounded-lg bg-white overflow-hidden">
                            <button class="w-full text-left p-4 flex justify-between items-center font-bold text-allgood-dark hover:bg-gray-50" onclick="toggleReveal(this)">
                                <span>1. Audit Your Public Self</span> <i class="fas fa-chevron-down text-gray-400"></i>
                            </button>
                            <div class="hidden p-4 bg-gray-50 text-sm text-gray-700 border-t">
                                Search your name in 'Incognito Mode.' Review your social media profiles from a stranger's perspective. Remove or privatize any posts, photos, or comments that seem unprofessional or too personal.
                            </div>
                        </div>
                         <div class="border border-gray-200 rounded-lg bg-white overflow-hidden">
                            <button class="w-full text-left p-4 flex justify-between items-center font-bold text-allgood-dark hover:bg-gray-50" onclick="toggleReveal(this)">
                                <span>2. Lock Down Your Settings</span> <i class="fas fa-chevron-down text-gray-400"></i>
                            </button>
                            <div class="hidden p-4 bg-gray-50 text-sm text-gray-700 border-t">
                                Go to the Privacy & Security settings on your main social and search accounts. Set your default audience to 'Friends Only.' Disable location tracking for apps that don't need it (e.g., social media).
                            </div>
                        </div>
                         <div class="border border-gray-200 rounded-lg bg-white overflow-hidden">
                            <button class="w-full text-left p-4 flex justify-between items-center font-bold text-allgood-dark hover:bg-gray-50" onclick="toggleReveal(this)">
                                <span>3. Strengthen Your Security</span> <i class="fas fa-chevron-down text-gray-400"></i>
                            </button>
                            <div class="hidden p-4 bg-gray-50 text-sm text-gray-700 border-t">
                                Install a reputable password manager (like Bitwarden or 1Password). Change your main passwords to be long, random, and unique. Enable Two-Factor Authentication (2FA) everywhere you can.
                            </div>
                        </div>
                         <div class="border border-gray-200 rounded-lg bg-white overflow-hidden">
                            <button class="w-full text-left p-4 flex justify-between items-center font-bold text-allgood-dark hover:bg-gray-50" onclick="toggleReveal(this)">
                                <span>4. Adopt 'The Pause'</span> <i class="fas fa-chevron-down text-gray-400"></i>
                            </button>
                            <div class="hidden p-4 bg-gray-50 text-sm text-gray-700 border-t">
                                Make a conscious habit of pausing before you post. This is the single most important action to protect your future self. 'Is this kind, necessary, and public-safe?'
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Page 12: Knowledge Check (V2 Step 11) -->
                <div class="page" id="page-12">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark">Knowledge Check: The Footprint Filter</h2></section>
                    <p class="text-sm text-gray-600 mb-6">Filter the following items. Are they part of your <strong>Active</strong> footprint (intentional) or <strong>Passive</strong> footprint (automatic)?</p>
                    
                    <div id="filter-quiz-container" class="space-y-4">
                        <!-- Q1 -->
                        <div class="bg-white p-4 rounded border border-gray-200">
                            <p class="font-bold text-sm mb-3">1. Posting a photo on Instagram.</p>
                            <div class="flex space-x-2">
                                <button class="flex-1 py-2 rounded border border-allgood-primary text-allgood-primary hover:bg-allgood-primary hover:text-white transition-colors text-sm font-bold" onclick="checkFilter(this, 'ACTIVE', 'ACTIVE')">ACTIVE</button>
                                <button class="flex-1 py-2 rounded border border-allgood-secondary text-allgood-secondary hover:bg-allgood-secondary hover:text-white transition-colors text-sm font-bold" onclick="checkFilter(this, 'PASSIVE', 'ACTIVE')">PASSIVE</button>
                            </div>
                        </div>
                        <!-- Q2 -->
                        <div class="bg-white p-4 rounded border border-gray-200">
                            <p class="font-bold text-sm mb-3">2. Your phone's IP address being logged by a website.</p>
                            <div class="flex space-x-2">
                                <button class="flex-1 py-2 rounded border border-allgood-primary text-allgood-primary hover:bg-allgood-primary hover:text-white transition-colors text-sm font-bold" onclick="checkFilter(this, 'ACTIVE', 'PASSIVE')">ACTIVE</button>
                                <button class="flex-1 py-2 rounded border border-allgood-secondary text-allgood-secondary hover:bg-allgood-secondary hover:text-white transition-colors text-sm font-bold" onclick="checkFilter(this, 'PASSIVE', 'PASSIVE')">PASSIVE</button>
                            </div>
                        </div>
                         <!-- Q3 -->
                        <div class="bg-white p-4 rounded border border-gray-200">
                            <p class="font-bold text-sm mb-3">3. A website saving 'cookies' on your browser.</p>
                            <div class="flex space-x-2">
                                <button class="flex-1 py-2 rounded border border-allgood-primary text-allgood-primary hover:bg-allgood-primary hover:text-white transition-colors text-sm font-bold" onclick="checkFilter(this, 'ACTIVE', 'PASSIVE')">ACTIVE</button>
                                <button class="flex-1 py-2 rounded border border-allgood-secondary text-allgood-secondary hover:bg-allgood-secondary hover:text-white transition-colors text-sm font-bold" onclick="checkFilter(this, 'PASSIVE', 'PASSIVE')">PASSIVE</button>
                            </div>
                        </div>
                        <!-- Q4 -->
                        <div class="bg-white p-4 rounded border border-gray-200">
                            <p class="font-bold text-sm mb-3">4. Sending an email to your boss.</p>
                            <div class="flex space-x-2">
                                <button class="flex-1 py-2 rounded border border-allgood-primary text-allgood-primary hover:bg-allgood-primary hover:text-white transition-colors text-sm font-bold" onclick="checkFilter(this, 'ACTIVE', 'ACTIVE')">ACTIVE</button>
                                <button class="flex-1 py-2 rounded border border-allgood-secondary text-allgood-secondary hover:bg-allgood-secondary hover:text-white transition-colors text-sm font-bold" onclick="checkFilter(this, 'PASSIVE', 'ACTIVE')">PASSIVE</button>
                            </div>
                        </div>
                        <!-- Q5 -->
                        <div class="bg-white p-4 rounded border border-gray-200">
                            <p class="font-bold text-sm mb-3">5. Your phone tracking your location for a weather app.</p>
                            <div class="flex space-x-2">
                                <button class="flex-1 py-2 rounded border border-allgood-primary text-allgood-primary hover:bg-allgood-primary hover:text-white transition-colors text-sm font-bold" onclick="checkFilter(this, 'ACTIVE', 'PASSIVE')">ACTIVE</button>
                                <button class="flex-1 py-2 rounded border border-allgood-secondary text-allgood-secondary hover:bg-allgood-secondary hover:text-white transition-colors text-sm font-bold" onclick="checkFilter(this, 'PASSIVE', 'PASSIVE')">PASSIVE</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Page 13: Reinforcement (V2 Step 12) -->
                <div class="page" id="page-13">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark">Reinforcement: Identity & Permanence</h2></section>
                    <p class="text-sm mb-4">Your digital footprint is a living record of your life. Cycle through these core truths.</p>
                    
                    <div class="h-64 flex flex-col items-center justify-center relative bg-gray-50 rounded-xl border border-gray-200 p-8 text-center">
                        <i class="fas fa-quote-left text-4xl text-allgood-primary/20 absolute top-4 left-4"></i>
                        <div id="carousel-content">
                            <p class="text-lg font-heading italic text-gray-800 mb-4">"Privacy is not something you're merely entitled to, it's an absolute prerequisite to human freedom."</p>
                            <p class="text-sm font-bold text-allgood-secondary"> Julian Assange</p>
                        </div>
                        
                        <div class="absolute bottom-4 flex space-x-4">
                            <button onclick="rotateQuote(-1)" class="p-2 text-gray-400 hover:text-allgood-primary"><i class="fas fa-chevron-left"></i></button>
                            <button onclick="rotateQuote(1)" class="p-2 text-gray-400 hover:text-allgood-primary"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                </div>

                <!-- Page 14: Mastery Quiz (V2 Step 13) -->
                <div class="page" id="page-14">
                    <section class="mb-6 border-b border-gray-200 pb-4"><h2 class="text-2xl font-heading font-bold text-allgood-dark">Mastery Challenge: The Action Plan</h2></section>
                    <p class="text-sm text-gray-600 mb-6">You've learned the concepts. Now, apply them. You must score <strong>80% (4/5)</strong> to prove mastery and get your badge.</p>
                    
                    <div id="mastery-container" class="max-w-xl mx-auto">
                        <!-- Dynamic Quiz Rendered Here -->
                        <div id="quiz-question-ui" class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                            <p class="text-xs font-bold text-gray-400 uppercase tracking-wide mb-2">Question <span id="q-num">1</span>/5</p>
                            <h3 class="font-bold text-lg mb-4" id="q-text">Loading...</h3>
                            <div class="space-y-2" id="q-options"></div>
                            <p id="q-feedback" class="mt-4 text-sm font-bold min-h-[20px]"></p>
                            <button id="q-next-btn" class="mt-4 bg-allgood-secondary text-white px-4 py-2 rounded text-sm font-bold hidden" onclick="nextMasteryQuestion()">Next Question</button>
                        </div>
                        
                        <div id="quiz-result-ui" class="hidden bg-white p-8 rounded-lg shadow-lg border-t-4 border-allgood-primary text-center">
                            <h3 class="text-2xl font-heading font-bold mb-2">Result</h3>
                            <p id="quiz-score-display" class="text-4xl font-bold text-allgood-primary mb-4">0/5</p>
                            <p id="quiz-msg" class="text-gray-600 mb-6">Loading...</p>
                            <button id="quiz-restart-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded font-bold hover:bg-gray-300 mr-2" onclick="startMasteryQuiz()">Try Again</button>
                            <button id="quiz-continue-btn" class="bg-allgood-primary text-white px-6 py-2 rounded font-bold shadow hover:bg-allgood-hover disabled:opacity-50" onclick="showPage(14)" disabled>Claim Badge</button>
                        </div>
                    </div>
                </div>

                <!-- Page 15: Conclusion & Badge (V2 Step 14) -->
                <div class="page" id="page-15">
                    <div class="flex flex-col items-center justify-start min-h-full py-10 text-center px-6">
                        
                        <!-- UI BADGE CONTAINER (Icon Only) -->
                        <div class="mb-8 transform scale-100 transition-transform flex justify-center" id="badge-ui-container">
                            <!-- This will be populated by updateBadgeStatus with a simple icon card -->
                        </div>

                        <h2 class="text-2xl font-heading font-bold text-allgood-dark mb-2">Mastery Achieved!</h2>
                        <p class="text-sm text-gray-600 mb-8 max-w-xs mx-auto">You've successfully passed the mastery challenge and proven you can distinguish active/passive data and apply the action plan.</p>
                        <p class="text-sm text-gray-600 font-semibold mb-8">You've turned a challenge into a <strong>pragmatic action plan</strong>. You are now the owner of your digital identity.</p>
                        
                        <button id="download-badge-btn" disabled class="w-full max-w-xs bg-gray-300 text-white font-bold py-3 px-6 rounded-lg shadow-none flex items-center justify-center mb-12 cursor-not-allowed group transition-all duration-300">
                            <i class="fas fa-lock mr-2"></i>
                            <span>Download Locked</span>
                        </button>

                        <!-- RATING & FEEDBACK SECTION -->
                        <div id="feedback-container" class="w-full max-w-md bg-white p-6 rounded-lg shadow-md border border-gray-200 mb-8 text-left relative">
                            <h3 class="font-bold text-allgood-dark text-sm uppercase tracking-wide mb-4 text-center">Rate this GoodBlock</h3>
                            <div class="flex justify-center space-x-2 mb-4" id="star-wrapper">
                                <button onclick="window.setRating(1)" class="star-btn focus:outline-none transition-transform hover:scale-110" data-val="1"><i id="star-1" class="fas fa-star text-2xl text-gray-300"></i></button>
                                <button onclick="window.setRating(2)" class="star-btn focus:outline-none transition-transform hover:scale-110" data-val="2"><i id="star-2" class="fas fa-star text-2xl text-gray-300"></i></button>
                                <button onclick="window.setRating(3)" class="star-btn focus:outline-none transition-transform hover:scale-110" data-val="3"><i id="star-3" class="fas fa-star text-2xl text-gray-300"></i></button>
                                <button onclick="window.setRating(4)" class="star-btn focus:outline-none transition-transform hover:scale-110" data-val="4"><i id="star-4" class="fas fa-star text-2xl text-gray-300"></i></button>
                                <button onclick="window.setRating(5)" class="star-btn focus:outline-none transition-transform hover:scale-110" data-val="5"><i id="star-5" class="fas fa-star text-2xl text-gray-300"></i></button>
                            </div>
                            <label class="block text-xs font-bold text-gray-500 mb-2">Your feedback sharpens our tools. What worked? What didn't?</label>
                            <textarea id="feedback-text" rows="3" class="w-full border border-gray-300 rounded p-3 text-sm focus:ring-1 focus:ring-allgood-primary focus:border-allgood-primary outline-none resize-none bg-gray-50" placeholder="Optional: Share your thoughts..."></textarea>
                            <button onclick="window.submitFeedback()" class="w-full mt-4 bg-allgood-dark hover:bg-allgood-primary text-white font-bold py-2 rounded transition-colors text-sm">Send Feedback</button>
                        </div>
                        <div id="feedback-success" class="hidden w-full max-w-md bg-green-50 p-6 rounded-lg shadow-inner border border-green-200 mb-8 text-center">
                            <i data-lucide="check-circle" class="w-12 h-12 text-green-600 mx-auto mb-2"></i>
                            <h3 class="font-bold text-green-800">Feedback Received.</h3>
                            <p class="text-xs text-green-700 mt-1">Thank you for helping us improve.</p>
                        </div>
                        
                        <p class="text-xs text-gray-400">Allgood Academy &copy; 2025</p>
                    </div>
                </div>

                <!-- FIXED FOOTER -->
                <footer class="footer-content flex items-center justify-between px-6">
                    <div id="flex-progress-bar"><div id="flex-progress-fill"></div></div>
                    
                    <button id="back-button" class="text-allgood-primary hover:text-allgood-dark font-bold text-sm flex items-center transition-colors disabled:opacity-30 disabled:cursor-not-allowed font-body">
                        <i class="fas fa-chevron-left mr-1"></i>Back
                    </button>
                    
                    <div class="text-center hidden sm:block">
                        <p class="text-gray-400 text-[10px] font-body">
                            <a href="https://www.allgoodacademy.com/goodblocks" target="_blank" class="font-bold hover:text-allgood-primary transition-colors">GoodBlock&trade;</a> 
                            powered by 
                            <a href="https://www.allgoodacademy.com" target="_blank" class="font-bold hover:text-allgood-primary transition-colors">Allgood Academy</a>
                        </p>
                    </div>

                    <button id="next-button" class="bg-allgood-primary hover:bg-allgood-hover text-white px-6 py-2 rounded-full text-sm font-bold shadow-md transition-transform transform hover:scale-105 flex items-center disabled:opacity-50 disabled:cursor-not-allowed font-body"><span>Next</span><i class="fas fa-chevron-right ml-1"></i></button>
                </footer>

            </div>
        </div>
    </main>

    <!-- LOGIC -->
    <script>
        // --- Global State ---
        const totalPages = 15; 
        let currentPage = 0;
        let userName = "Learner";
        let isMasteryPassed = false; 
        
        // --- Audio Engine (Enhanced) ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx;
        function initAudio() { if (!audioCtx) { audioCtx = new AudioContext(); } if (audioCtx.state === 'suspended') { audioCtx.resume(); } }
        
        function playTone(freq, type, duration, vol=0.1, attack=0.01, decay=0.001) {
            initAudio(); 
            const now = audioCtx.currentTime; 
            const osc = audioCtx.createOscillator(); 
            const gain = audioCtx.createGain();
            osc.type = type; 
            osc.frequency.setValueAtTime(freq, now); 
            osc.connect(gain); 
            gain.connect(audioCtx.destination);
            gain.gain.setValueAtTime(0, now); 
            gain.gain.linearRampToValueAtTime(vol, now + attack); 
            gain.gain.exponentialRampToValueAtTime(decay, now + duration);
            osc.start(now); 
            osc.stop(now + duration);
        }

        const sfx = {
            powerOn: () => { initAudio(); const now = audioCtx.currentTime; const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.connect(gain); gain.connect(audioCtx.destination); osc.type = 'triangle'; osc.frequency.setValueAtTime(110, now); osc.frequency.exponentialRampToValueAtTime(220, now + 0.4); gain.gain.setValueAtTime(0, now); gain.gain.linearRampToValueAtTime(0.4, now + 0.1); gain.gain.linearRampToValueAtTime(0, now + 0.4); osc.start(now); osc.stop(now + 0.4); },
            powerOff: () => { initAudio(); playTone(80, 'triangle', 0.2, 0.5, 0.01, 0.001); },
            nav: () => playTone(150, 'sine', 0.1, 0.1, 0.01, 0.01),
            success: () => { playTone(400, 'sine', 0.1); setTimeout(() => playTone(600, 'sine', 0.2), 100); },
            error: () => playTone(100, 'sawtooth', 0.2, 0.2),
            click: () => playTone(800, 'sine', 0.05),
            tick: () => { initAudio(); playTone(1000, 'sine', 0.01, 0.01); }
        };
        window.sfx = sfx;
        window.initAudio = initAudio;

        // --- Navigation Logic ---
        const pages = document.querySelectorAll('.page');
        const progressBar = document.getElementById('flex-progress-fill');
        const nextBtn = document.getElementById('next-button');
        const backBtn = document.getElementById('back-button');
        const pageIndicator = document.getElementById('header-page-indicator');

        function showPage(idx) {
            if (idx < 0 || idx >= totalPages) return;
            pages.forEach(p => p.classList.remove('active'));
            pages[idx].classList.add('active');
            currentPage = idx;
            progressBar.style.width = `${((idx + 1) / totalPages) * 100}%`;
            if (pageIndicator) pageIndicator.textContent = `${idx + 1} / ${totalPages}`;

            // Check badge status on final page
            if (idx === 14) updateBadgeStatus();

            // Nav State
            backBtn.disabled = idx === 0;
            backBtn.classList.toggle('opacity-0', idx === 0);
            
            if (idx === 14) {
                nextBtn.style.display = 'none';
            } else {
                nextBtn.style.display = 'flex';
            }
            sfx.nav();
        }

        // --- HELPER TO GET SVG STRING (NEW) ---
        function getBadgeSVG(safeName) {
            return `
            <svg width="1200" height="800" viewBox="0 0 1200 800" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="shieldGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#357889" />
                        <stop offset="100%" style="stop-color:#2D6473" />
                    </linearGradient>
                    <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
                        <path d="M 40 0 L 0 0 0 40" fill="none" stroke="#E5E7EB" stroke-width="1"/>
                    </pattern>
                </defs>
                <rect width="100%" height="100%" fill="#F7F7F7"/>
                <rect width="100%" height="100%" fill="url(#grid)"/>
                <rect x="20" y="20" width="1160" height="760" rx="40" ry="40" fill="none" stroke="#D34716" stroke-width="10"/>
                <text x="600" y="120" font-family="Georgia, serif" font-weight="bold" font-size="50" fill="#357889" text-anchor="middle" letter-spacing="2">ALLGOOD ACADEMY</text>
                <text x="600" y="180" font-family="Verdana, sans-serif" font-weight="bold" font-size="60" fill="#4C4C4C" text-anchor="middle" letter-spacing="1">YOUR DIGITAL IDENTITY</text>
                <g transform="translate(600, 400)">
                    <path d="M -120 -100 C -120 -100 120 -100 120 -100 C 120 20 120 80 0 180 C -120 80 -120 20 -120 -100 Z" fill="url(#shieldGrad)" stroke="#357889" stroke-width="5" />
                    <rect x="-50" y="-20" width="100" height="80" rx="10" fill="white"/>
                    <path d="M -35 -20 V -50 A 35 35 0 0 1 35 -50 V -20" fill="none" stroke="white" stroke-width="12" stroke-linecap="round"/>
                    <circle cx="0" cy="20" r="10" fill="#D34716"/>
                </g>
                <text x="600" y="620" font-family="Verdana, sans-serif" font-size="24" fill="#D34716" text-anchor="middle" font-weight="bold" letter-spacing="4">SECURED &amp; VERIFIED</text>
                <line x1="300" y1="660" x2="900" y2="660" stroke="#357889" stroke-width="2"/>
                <text x="600" y="720" font-family="Georgia, serif" font-style="italic" font-size="48" fill="#357889" text-anchor="middle">${safeName}</text>
            </svg>`;
        }

        function updateBadgeStatus() {
            const btn = document.getElementById('download-badge-btn');
            const uiContainer = document.getElementById('badge-ui-container');
            const safeName = (window.currentUserName || "Learner").toUpperCase();
            
            // Render the UI Card (Not the massive SVG)
            if(isMasteryPassed) {
                // UNLOCKED STATE UI
                uiContainer.innerHTML = `
                    <div class="w-64 h-64 bg-white rounded-full flex flex-col items-center justify-center border-8 border-allgood-secondary shadow-lg relative overflow-hidden">
                        <div class="absolute inset-0 bg-allgood-secondary opacity-5"></div>
                        <i data-lucide="shield-check" class="w-24 h-24 text-allgood-primary mb-2 relative z-10"></i>
                        <p class="font-bold text-allgood-secondary text-sm uppercase tracking-widest relative z-10">Verified</p>
                        <p class="text-[10px] text-gray-400 font-bold mt-1 relative z-10">${safeName}</p>
                    </div>
                `;
                lucide.createIcons();

                btn.disabled = false;
                btn.classList.remove('bg-gray-300', 'cursor-not-allowed', 'shadow-none');
                btn.classList.add('bg-allgood-primary', 'hover:bg-allgood-hover', 'shadow-lg');
                btn.innerHTML = '<i class="fas fa-download mr-2"></i><span>Download Badge</span>';
                
                // Pre-generate download blob silently
                prepareDownload(); 
            } else {
                // LOCKED STATE UI
                uiContainer.innerHTML = `
                    <div class="w-64 h-64 bg-gray-100 rounded-full flex flex-col items-center justify-center border-8 border-gray-300 shadow-inner">
                        <i class="fas fa-lock text-6xl text-gray-400 mb-4"></i>
                        <p class="font-bold text-gray-400 uppercase tracking-widest text-sm">Locked</p>
                    </div>
                `;
                
                btn.disabled = true;
                btn.classList.add('bg-gray-300', 'cursor-not-allowed', 'shadow-none');
                btn.classList.remove('bg-allgood-primary', 'hover:bg-allgood-hover', 'shadow-lg');
                btn.innerHTML = '<i class="fas fa-lock mr-2"></i><span>Certification Locked</span>';
            }
        }

        nextBtn.addEventListener('click', () => showPage(currentPage + 1));
        backBtn.addEventListener('click', () => showPage(currentPage - 1));
        
        // --- UPDATED: Home Button Logic (Hold to Hard Reset) ---
        const homeBtn = document.getElementById('home-button');
        let homePressTimer;
        let homeIsHold = false;
        
        const startHomePress = (e) => {
            // Prevent default only on touch to avoid ghost clicks, but careful with mouse
            if(e.type === 'touchstart') e.preventDefault(); 
            homeIsHold = false;
            homePressTimer = setTimeout(() => {
                homeIsHold = true;
                if(window.handleHardReset) window.handleHardReset();
            }, 2000); // 2 seconds hold
        };
        
        const endHomePress = (e) => {
            clearTimeout(homePressTimer);
            if(!homeIsHold) {
                // Normal Click
                showPage(0);
                sfx.nav();
            }
        };

        if(homeBtn) {
            homeBtn.addEventListener('mousedown', startHomePress);
            homeBtn.addEventListener('touchstart', startHomePress);
            homeBtn.addEventListener('mouseup', endHomePress);
            homeBtn.addEventListener('touchend', endHomePress);
            homeBtn.addEventListener('mouseleave', () => clearTimeout(homePressTimer));
        }

        // --- Page 3: Tooltips ---
        window.toggleTooltip = function(id, event) {
            event.stopPropagation(); 
            const allPopups = document.querySelectorAll('.tooltip-popup');
            allPopups.forEach(p => {
                if(p.id !== id) p.classList.add('hidden');
            });
            const el = document.getElementById(id);
            if(el) el.classList.toggle('hidden');
            sfx.click();
        }
        document.addEventListener('click', () => {
            const allPopups = document.querySelectorAll('.tooltip-popup');
            allPopups.forEach(p => p.classList.add('hidden'));
        });

        // --- Page 4, 11: Reveal ---
        window.toggleReveal = function(btn) {
            const content = btn.nextElementSibling;
            const icon = btn.querySelector('i.fa-chevron-down') || btn.querySelector('i.fa-chevron-up');
            content.classList.toggle('hidden');
            if(icon) {
                icon.classList.toggle('fa-chevron-down');
                icon.classList.toggle('fa-chevron-up');
            }
            sfx.click();
        }
        
        // --- Page 1: Accordion ---
        window.toggleAccordion = function(btn) {
            const content = btn.nextElementSibling;
            const icon = btn.querySelector('i');
            content.classList.toggle('hidden');
            if(icon) {
                icon.classList.toggle('rotate-180');
            }
            sfx.click();
        }

        // --- Page 6: Tabs ---
        window.switchTab = function(tab) {
            const mythBtn = document.getElementById('tab-myth');
            const realityBtn = document.getElementById('tab-reality');
            const mythContent = document.getElementById('content-myth');
            const realityContent = document.getElementById('content-reality');

            if (tab === 'myth') {
                mythBtn.classList.add('bg-white', 'border-b-2', 'border-red-600', 'text-red-600'); 
                mythBtn.classList.remove('bg-gray-100', 'text-gray-600', 'hover:bg-gray-200');
                realityBtn.classList.add('bg-gray-100', 'text-gray-600', 'hover:bg-gray-200'); 
                realityBtn.classList.remove('bg-white', 'border-b-2', 'border-green-600', 'text-green-600');
                mythContent.classList.remove('hidden');
                realityContent.classList.add('hidden');
            } else {
                realityBtn.classList.add('bg-white', 'border-b-2', 'border-green-600', 'text-green-600'); 
                realityBtn.classList.remove('bg-gray-100', 'text-gray-600', 'hover:bg-gray-200');
                mythBtn.classList.add('bg-gray-100', 'text-gray-600', 'hover:bg-gray-200'); 
                mythBtn.classList.remove('bg-white', 'border-b-2', 'border-red-600', 'text-red-600');
                realityContent.classList.remove('hidden');
                mythContent.classList.add('hidden');
            }
            sfx.click();
        }

        // --- Page 8: Read More ---
        window.toggleReadMore = function() {
            const content = document.getElementById('read-more-content');
            const btn = document.getElementById('read-more-btn');
            content.classList.toggle('hidden');
            if (content.classList.contains('hidden')) {
                btn.innerHTML = 'Read More <i class="fas fa-chevron-down ml-2"></i>';
            } else {
                btn.innerHTML = 'Show Less <i class="fas fa-chevron-up ml-2"></i>';
            }
            sfx.click();
        }

        // --- Page 9: Slider Logic ---
        const sliderContainer = document.getElementById('slider-container');
        const sliderDivider = document.getElementById('slider-divider');
        const sliderAfter = document.getElementById('slider-after');
        let isDragging = false;

        if(sliderContainer) {
            const updateSlider = (x) => {
                const rect = sliderContainer.getBoundingClientRect();
                let percentage = ((x - rect.left) / rect.width) * 100;
                percentage = Math.max(0, Math.min(100, percentage));
                sliderDivider.style.left = `${percentage}%`;
                sliderAfter.style.clipPath = `polygon(${percentage}% 0, 100% 0, 100% 100%, ${percentage}% 100%)`;
            }
            sliderContainer.addEventListener('mousedown', () => isDragging = true);
            window.addEventListener('mouseup', () => isDragging = false);
            window.addEventListener('mousemove', (e) => { if (isDragging) updateSlider(e.clientX); });
            sliderContainer.addEventListener('touchstart', () => isDragging = true);
            window.addEventListener('touchend', () => isDragging = false);
            window.addEventListener('touchmove', (e) => { if (isDragging) updateSlider(e.touches[0].clientX); });
            setTimeout(() => {
                sliderDivider.style.left = '50%';
                sliderAfter.style.clipPath = 'polygon(50% 0, 100% 0, 100% 100%, 50% 100%)';
            }, 100);
        }

        // --- Page 12: Filter Quiz ---
        window.checkFilter = function(btn, choice, correct) {
            const parent = btn.parentElement;
            const buttons = parent.querySelectorAll('button');
            buttons.forEach(b => b.classList.add('opacity-50', 'cursor-not-allowed'));
            if (choice === correct) {
                btn.classList.remove('opacity-50', 'text-allgood-primary', 'border-allgood-primary', 'text-allgood-secondary', 'border-allgood-secondary');
                btn.classList.add('bg-green-500', 'text-white', 'border-green-500', 'opacity-100');
                btn.textContent = "CORRECT";
                sfx.success();
            } else {
                btn.classList.remove('opacity-50', 'text-allgood-primary', 'border-allgood-primary', 'text-allgood-secondary', 'border-allgood-secondary');
                btn.classList.add('bg-red-500', 'text-white', 'border-red-500', 'opacity-100');
                btn.textContent = "WRONG";
                sfx.error();
            }
        }

        // --- Page 13: Carousel ---
        const quotes = [
            { t: "Privacy is not something you're merely entitled to, it's an absolute prerequisite to human freedom.", a: "Julian Assange" },
            { t: "The Internet is the first thing that humanity has built that humanity doesn't understand.", a: "Eric Schmidt" },
            { t: "What is private is being deleted. What is public is being preserved and made searchable.", a: "Jeff Jarvis" },
            { t: "Your reputation is what people say about you when you're not in the room. On the internet, you're never in the room.", a: "Jeff Bezos" }
        ];
        let qIndex = 0;
        window.rotateQuote = function(dir) {
            qIndex += dir;
            if (qIndex < 0) qIndex = quotes.length - 1;
            if (qIndex >= quotes.length) qIndex = 0;
            const qContent = document.getElementById('carousel-content');
            qContent.style.opacity = 0;
            setTimeout(() => {
                qContent.innerHTML = `<p class="text-lg font-heading italic text-gray-800 mb-4">"${quotes[qIndex].t}"</p><p class="text-sm font-bold text-allgood-secondary"> ${quotes[qIndex].a}</p>`;
                qContent.style.opacity = 1;
            }, 200);
            sfx.click();
        }

        // --- Page 14: Mastery Quiz ---
        const masteryQuestions = [
            { q: "1. What is the most significant difference between an Active and a Passive footprint?", o: ["Active is text, Passive is images.", "Active is intentional sharing; Passive is automatic background collection.", "Active is on social media; Passive is on Google.", "Active is permanent; Passive can be deleted."], a: 1 },
            { q: "2. According to the 'Myth vs. Reality' step, what is the most pragmatic mindset to have *before* posting?", o: ["\"I can delete this later if I change my mind.\"", "\"My friends will find this funny.\"", "\"This post will get a lot of likes.\"", "\"I am okay with this being permanent and public.\""], a: 3 },
            { q: "3. Which group uses your *Active* footprint (e.g., public posts, photos) to make high-stakes judgments about your character?", o: ["Advertisers & Marketers", "Data Brokers & Scammers", "Employers & Colleges", "Your Internet Service Provider (ISP)"], a: 2 },
            { q: "4. What is the *first* step in the 4-Step Action Plan for managing your footprint?", o: ["Strengthen Your Security (e.g., 2FA)", "Adopt 'The Pause'", "Audit Your Public Self (e.g., Google your name)", "Lock Down Your Settings"], a: 2 },
            { q: "5. What is the fundamental 'cost' of using most 'free' social media platforms and search engines?", o: ["Your device's battery life.", "Your personal data and attention.", "Your email address for marketing lists.", "Your time."], a: 1 }
        ];
        let mIndex = 0;
        let mScore = 0;

        window.startMasteryQuiz = function() {
            mIndex = 0; mScore = 0;
            isMasteryPassed = false;
            document.getElementById('quiz-question-ui').classList.remove('hidden');
            document.getElementById('quiz-result-ui').classList.add('hidden');
            renderMasteryQuestion();
        }

        function renderMasteryQuestion() {
            const qData = masteryQuestions[mIndex];
            document.getElementById('q-num').textContent = mIndex + 1;
            // Clean up text here too if needed
            document.getElementById('q-text').innerHTML = qData.q.replace(/\*([^*]+)\*/g, "<em>$1</em>");
            document.getElementById('q-feedback').textContent = "";
            document.getElementById('q-next-btn').classList.add('hidden');
            
            const opsDiv = document.getElementById('q-options');
            opsDiv.innerHTML = "";
            qData.o.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = "quiz-btn w-full text-left p-3 rounded border border-gray-200 hover:bg-gray-50 transition-all";
                btn.innerHTML = `<span class="font-bold mr-2">${String.fromCharCode(65 + i)}.</span> ${opt}`;
                btn.onclick = () => handleMasteryAnswer(i, qData.a, btn);
                opsDiv.appendChild(btn);
            });
        }

        function handleMasteryAnswer(choice, correct, btn) {
            const all = document.querySelectorAll('.quiz-btn');
            all.forEach(b => b.disabled = true);
            
            if (choice === correct) {
                btn.classList.add('correct');
                mScore++;
                document.getElementById('q-feedback').innerHTML = `<i class="fas fa-check mr-2"></i> Correct.`;
                document.getElementById('q-feedback').className = "mt-4 text-sm font-bold text-green-600";
                sfx.success();
            } else {
                btn.classList.add('incorrect');
                all[correct].classList.add('correct');
                document.getElementById('q-feedback').innerHTML = `<i class="fas fa-times mr-2"></i> Incorrect.`;
                document.getElementById('q-feedback').className = "mt-4 text-sm font-bold text-red-600";
                sfx.error();
            }
            document.getElementById('q-next-btn').classList.remove('hidden');
        }

        window.nextMasteryQuestion = function() {
            mIndex++;
            if (mIndex >= masteryQuestions.length) {
                finishMasteryQuiz();
            } else {
                renderMasteryQuestion();
            }
        }

        function finishMasteryQuiz() {
            document.getElementById('quiz-question-ui').classList.add('hidden');
            const resUI = document.getElementById('quiz-result-ui');
            resUI.classList.remove('hidden');
            document.getElementById('quiz-score-display').textContent = `${mScore}/5`;
            
            const pass = mScore >= 4;
            const msg = document.getElementById('quiz-msg');
            const contBtn = document.getElementById('quiz-continue-btn');
            
            if (pass) {
                isMasteryPassed = true; // Unlock badge
                msg.innerHTML = "You've successfully passed the mastery challenge and proven you can distinguish active/passive data and apply the action plan.";
                resUI.classList.add('border-green-500');
                contBtn.disabled = false;
                sfx.success();
                
                // --- DB TRIGGER ---
                // Trigger Database Write IMMEDIATELY upon passing
                const safeName = (window.currentUserName || "Learner").toUpperCase();
                const badgeSVG = getBadgeSVG(safeName);
                
                window.logFinalScoreToFirestore({
                    finalScore: mScore,
                    maxScore: 5,
                    completed: true, // THE SIGNAL
                    badgeSVG: badgeSVG // THE BADGE
                });
                
            } else {
                isMasteryPassed = false;
                msg.innerHTML = "You need 4/5 to pass. Please review and try again.";
                resUI.classList.add('border-red-500');
                contBtn.disabled = true;
                sfx.error();
            }
        }

        // --- NEW: RATING & FEEDBACK FUNCTIONS ---
        window.setRating = function(n) {
            for (let i = 1; i <= 5; i++) {
                const star = document.getElementById(`star-${i}`);
                if (i <= n) { star.classList.remove('text-gray-300'); star.classList.add('text-yellow-400'); } 
                else { star.classList.add('text-gray-300'); star.classList.remove('text-yellow-400'); }
            }
            sfx.tick();
        }
        window.submitFeedback = function() {
            const feedbackText = document.getElementById('feedback-text').value;
            window.logFinalScoreToFirestore({ feedback: feedbackText, rank: "Feedback", sessionId: window.sessionId });
            document.getElementById('feedback-container').classList.add('hidden');
            document.getElementById('feedback-success').classList.remove('hidden');
            sfx.nav(); 
        }

        // --- UNIQUE BADGE GENERATOR (INTERNAL FILE) ---
        window.prepareDownload = function() {
            const safeName = (window.currentUserName || "Learner").toUpperCase();
            document.querySelector('#page-15 h2').textContent = `Congratulations, ${safeName}!`;

            const badgeSVG = getBadgeSVG(safeName);
            
            // Re-render button to "download" action
            const dlBtn = document.getElementById('download-badge-btn');
            dlBtn.onclick = () => {
                const blob = new Blob([badgeSVG], {type: 'image/svg+xml'});
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `Allgood-DigitalIdentity-Badge-${safeName}.svg`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                sfx.nav();
            };
        }

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            startMasteryQuiz(); // Pre-load quiz state
            
            // Menu Logic
            document.getElementById('menu-toggle').addEventListener('click', () => {
                const modal = document.getElementById('menu-modal');
                modal.classList.remove('hidden-modal');
                modal.classList.add('visible-modal');
                sfx.tick();
                
                const toc = document.getElementById('toc-list');
                toc.innerHTML = '';
                const titles = [
                    "Welcome", "Definition", "Core Concepts", "Danger of Passive", "Mindset Shift", "Myth vs Reality", "Who is Watching?", "Cost of Free", "Public vs Private", "Four Rules", "Action Plan", "Knowledge Check", "Reinforcement", "Mastery Quiz", "Conclusion"
                ];
                titles.forEach((t, i) => {
                    const btn = document.createElement('button');
                    btn.className = "w-full text-left px-4 py-2 hover:bg-gray-100 text-gray-700 rounded";
                    btn.textContent = `${i+1}. ${t}`;
                    btn.onclick = () => { showPage(i); modal.classList.add('hidden-modal'); modal.classList.remove('visible-modal'); };
                    toc.appendChild(btn);
                });
            });
            document.getElementById('close-menu').addEventListener('click', () => {
                document.getElementById('menu-modal').classList.add('hidden-modal');
                document.getElementById('menu-modal').classList.remove('visible-modal');
                sfx.tick();
            });

            // Fullscreen & Blueprint
            document.getElementById('blueprint-toggle').addEventListener('click', () => {
                document.getElementById('screen').classList.toggle('blueprint-mode');
                sfx.click();
            });
            document.getElementById('fullscreen-toggle').addEventListener('click', () => {
                document.querySelector('.tablet-frame').classList.toggle('focus-mode');
                sfx.click();
            });
            
            // Startup
            document.getElementById('startup-screen').addEventListener('click', function() {
                if(window.sfx) window.sfx.powerOn();
                this.style.opacity = 0;
                setTimeout(() => this.style.display = 'none', 700);
            });
        });
    </script>
</body>
</html>
