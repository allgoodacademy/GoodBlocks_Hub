<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Allgood Academy Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, updateProfile, signOut } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, addDoc, collection, serverTimestamp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // --- OFFLINE/DEPLOYMENT CHECK ---
        const isOfflineMode = typeof __firebase_config === 'undefined';
        
        let auth, db, appId;

        if (!isOfflineMode) {
            // Initialize Firebase in Canvas Environment
            const firebaseConfig = JSON.parse(__firebase_config);
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            appId = typeof __app_id !== 'undefined' ? __app_id : 'allgood-dashboard';
        } else {
            // Offline Mode Fallback
            console.warn("Firebase configuration not found. Running in Local/Offline Mode.");
            auth = null; // Mark auth service as unavailable
            db = null; // Mark db service as unavailable
        }

        // --- GLOBAL EXPORTS (Fixes ReferenceError) ---
        window.auth = auth; 
        window.db = db;

        // TRACKING STATE
        let launchCount = parseInt(localStorage.getItem('aa_launch_count') || '0');
        let currentLevel = 1;

        window.handleLogin = async (name, email, isGuest) => {
            // 1. LOADING STATE (Instant Feedback)
            const btn = document.getElementById('start-session-btn');
            const originalText = btn.innerText;
            btn.innerText = "Authenticating...";
            btn.disabled = true;
            btn.classList.add('opacity-70', 'cursor-wait');

            // Persist guest status locally immediately
            localStorage.setItem('aa_is_guest', isGuest);
            localStorage.setItem('aa_username', name);

            if (!isOfflineMode) {
                // --- ONLINE MODE (FIREBASE) ---
                try {
                    const userCredential = await signInAnonymously(auth);
                    const user = userCredential.user;
                    await updateProfile(user, { displayName: name });
                    const userRef = doc(db, 'artifacts', appId, 'users', user.uid);
                    
                    await setDoc(userRef, {
                        displayName: name,
                        email: email || '',
                        isGuest: isGuest, // Persist status to DB
                        lastLogin: serverTimestamp(),
                        onboardingComplete: true
                    }, { merge: true });
                } catch (error) {
                    console.error("Login Error:", error);
                    alert("Connection failed. Continuing in Local Mode.");
                }
            }
            
            // --- UI Update (Applies to both modes) ---
            updateUI(name);
            document.getElementById('page-dashboard').classList.add('active');
            document.getElementById('page-dashboard').style.display = 'block'; // Ensure visibility
            closeLoginModal();
            sfx.confirm();

            btn.innerText = originalText;
            btn.disabled = false;
            btn.classList.remove('opacity-70', 'cursor-wait');
        };

        window.handleLogout = async () => {
            // Only sign out of Firebase if available
            if (!isOfflineMode && auth.currentUser) {
                try {
                    await signOut(auth);
                } catch(e) { console.log("Signout error (offline?)", e); }
            }
            
            // 1. Clear Local Data
            localStorage.removeItem('aa_username');
            localStorage.removeItem('aa_is_guest'); 
            localStorage.removeItem('aa_launch_count');
            launchCount = 0; // Reset Stats
            currentLevel = 1;
            
            // 2. FORCE RESET UI STATE
            document.querySelectorAll('.visible-modal').forEach(el => {
                el.classList.remove('visible-modal');
                el.classList.add('hidden-modal');
            });

            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            if(window.switchTab) window.switchTab('goodblocks');

            document.querySelectorAll('.user-name-display').forEach(el => el.textContent = 'Guest');
            if(document.getElementById('user-name-input')) document.getElementById('user-name-input').value = '';
            if(document.getElementById('user-email-input')) document.getElementById('user-email-input').value = '';
            
            updateBadges(); 

            // E. Show Startup Screen (Cover everything)
            const startup = document.getElementById('startup-screen');
            if(startup) {
                startup.style.display = 'flex';
                setTimeout(() => { startup.style.opacity = '1'; }, 10);
            }

            // F. Prep Login Modal (for when they click Startup)
            const loginModal = document.getElementById('login-modal');
            if(loginModal) {
                loginModal.classList.remove('hidden-modal');
                loginModal.classList.add('visible-modal'); 
            }
        }

        window.launchCourse = async (courseName, url) => {
            // IMMEDIATE ACTION
            window.open(url, '_blank');

            sfx.confirm();
            
            // Increment local stats immediately for badge interaction
            launchCount++;
            localStorage.setItem('aa_launch_count', launchCount);
            updateBadges();
            
            // Log asynchronously (Only if Firebase is initialized)
            if (!isOfflineMode && auth.currentUser) {
                addDoc(collection(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'launches'), {
                    courseName: courseName,
                    targetUrl: url,
                    timestamp: serverTimestamp()
                }).catch(e => console.log("Log failed (Firebase). Continuing navigation."));
            }
        };

        window.initDashboard = () => {
            // This function now only handles Firebase initialization and badge state management.
            // The logic to restore a session from localStorage has been REMOVED here
            // to enforce the "Session Required" flow (Power Up screen on every load).
            
            if (!isOfflineMode) {
                // --- ONLINE MODE (FIREBASE) ---
                 onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        const userRef = doc(db, 'artifacts', appId, 'users', user.uid);
                        try {
                            const docSnap = await getDoc(userRef);
                            if (docSnap.exists()) {
                                const data = docSnap.data();
                                if(data.displayName) {
                                    // Restore Guest Status from DB
                                    const isGuest = data.isGuest !== undefined ? data.isGuest : (data.displayName === 'Guest' || data.displayName === 'Learner');
                                    localStorage.setItem('aa_is_guest', isGuest);
                                    
                                    // We still update UI variables, but DON'T hide the startup screen.
                                    updateUI(data.displayName); 
                                    closeLoginModal();
                                }
                            }
                        } catch(e) { console.log("Offline or error fetching user from Firebase.", e); }
                    }
                    updateBadges();
                });
            } else {
                // --- OFFLINE MODE ---
                // Only running badge updates and necessary checks.
                updateBadges();
            }
        };
        
        function updateUI(name) {
            const els = document.querySelectorAll('.user-name-display');
            els.forEach(el => el.textContent = name);
            updateBadges();
        }
        
        function updateBadges() {
            // LOGIC FIX:
            // Reload local state for launch count
            launchCount = parseInt(localStorage.getItem('aa_launch_count') || '0');

            const isGuest = localStorage.getItem('aa_is_guest') === 'true';
            const name = localStorage.getItem('aa_username');
            
            const isGenericName = !name || name === 'Guest' || name === 'Learner';
            
            currentLevel = 1;
            
            // Level 2 requires explicit identity (Not a guest AND has a custom name)
            if (!isGuest && !isGenericName) {
                currentLevel = 2;
            }
            
            if (currentLevel >= 2 && launchCount > 0) currentLevel = 3;
            
            // Update UI
            for(let i=1; i<=3; i++) {
                const badge = document.getElementById(`badge-${i}`);
                if(!badge) continue;
                
                if (i <= currentLevel) {
                    // Unlocked
                    badge.classList.remove('opacity-30', 'grayscale');
                    badge.classList.add('cursor-pointer', 'hover:scale-110');
                    // Remove lock icon if present
                    const lock = badge.querySelector('.lock-icon');
                    if(lock) lock.remove();
                } else {
                    // Locked
                    badge.classList.add('opacity-30', 'grayscale');
                    badge.classList.remove('cursor-pointer', 'hover:scale-110');
                }
            }
            
            // Update Text Label
            const label = document.getElementById('clearance-label');
            const titles = ["Observer", "Agent", "Operator"];
            if(label) label.textContent = `Level ${currentLevel}: ${titles[currentLevel-1]}`;
        }
        
        window.showBadgeInfo = (level) => {
            const titles = ["Observer", "Agent", "Operator"];
            const descs = [
                "You are observing the academy. Sign in to track your progress.",
                "Identity confirmed. You are authorized to access mission files.",
                "Field Operator status confirmed. You have moved from theory to action."
            ];
            const reqs = [
                "None",
                "Sign In with Name/Email",
                "Complete 1 Mission Module"
            ];
            
            const modal = document.getElementById('badge-modal');
            document.getElementById('badge-title').textContent = `Level ${level}: ${titles[level-1]}`;
            document.getElementById('badge-desc').textContent = descs[level-1];
            document.getElementById('badge-req').textContent = `Requirement: ${reqs[level-1]}`;
            
            // Show status
            const statusEl = document.getElementById('badge-status');
            if (level <= currentLevel) {
                statusEl.textContent = "STATUS: UNLOCKED";
                statusEl.className = "text-xs font-bold text-green-600 uppercase tracking-widest";
            } else {
                statusEl.textContent = "STATUS: CLASSIFIED (LOCKED)";
                statusEl.className = "text-xs font-bold text-red-500 uppercase tracking-widest";
            }
            
            modal.classList.remove('hidden-modal');
            modal.classList.add('visible-modal');
            sfx.click();
        }
        
        window.closeBadgeModal = () => {
            const modal = document.getElementById('badge-modal');
            modal.classList.add('hidden-modal');
            modal.classList.remove('visible-modal');
            sfx.click();
        }

        function closeLoginModal() {
            const modal = document.getElementById('login-modal');
            if(modal) {
                modal.classList.add('hidden-modal');
                modal.classList.remove('visible-modal');
            }
        }
    </script>
    
    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'allgood-primary': '#D34716',
                        'allgood-secondary': '#357889',
                        'allgood-dark': '#4C4C4C',
                        'allgood-light': '#F7F7F7',
                        'allgood-hover': '#EB8D69',
                        'allgood-accent': '#2D6473',
                    },
                    fontFamily: {
                        'heading': ['Georgia', 'serif'],
                        'body': ['Verdana', 'sans-serif'],
                    },
                },
            },
        }
    </script>

    <style>
        /* =============================================
        FIXED CHASSIS MANDATE
        =============================================
        */
        body {
            font-family: Verdana, sans-serif;
            background-color: #1a1a1a;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
            background-attachment: fixed;
            min-height: 100vh;
            margin: 0; padding: 0;
            overflow: hidden;
        }

        h1, h2, h3, h4, h5, h6 { font-family: Georgia, serif; }

        @keyframes pulse-glow {
            0%, 100% { text-shadow: 0 0 10px rgba(211, 71, 22, 0.4); transform: scale(1); }
            50% { text-shadow: 0 0 30px rgba(211, 71, 22, 0.9), 0 0 15px rgba(211, 71, 22, 0.6); transform: scale(1.02); }
        }
        .animate-pulse-glow { animation: pulse-glow 2.5s infinite ease-in-out; will-change: transform, text-shadow; }

        .static-neon-glow {
            text-shadow: 0 0 5px rgba(211, 71, 22, 0.2), 0 0 10px rgba(211, 71, 22, 0.4), 0 0 20px rgba(211, 71, 22, 0.6);
        }

        /* --- TABLET FRAME (FIXED CHASSIS - HEIGHT PRIORITY) --- */
        .tablet-frame {
            height: 85vh; 
            /* NEW: Maximum vertical cap to prevent overly tall frames on large screens */
            max-height: 900px; 
            width: auto;
            aspect-ratio: 16/10;
            max-width: 100%;
            /* Removed redundant max-height: 95vh here */
            background-image: 
                radial-gradient(circle at 0% 0%, rgba(211, 71, 22, 0.35) 0%, transparent 30%),
                radial-gradient(circle at 100% 100%, rgba(211, 71, 22, 0.35) 0%, transparent 30%),
                linear-gradient(135deg, #5c5c5c 0%, #d6d6d6 25%, #8a8a8a 50%, #e0e0e0 75%, #5c5c5c 100%);
            border-radius: 24px;
            padding: 12px;
            box-shadow: 
                inset 1px 1px 2px rgba(255,255,255, 0.6),
                inset -1px -1px 2px rgba(0,0,0, 0.8),
                0 30px 60px -12px rgba(0, 0, 0, 0.8),
                0 0 0 1px #111;
            border: 1px solid #333;
            position: relative;
            margin: 20px auto;
            transition: all 0.3s ease;
        }

        .screen-container {
            width: 100%; height: 100%; background-color: #F7F7F7;
            position: relative; z-index: 1; overflow: hidden;
            display: flex; flex-direction: column; 
            border-radius: 4px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }
        
        /* --- MOBILE ADAPTATION --- */
        @media (max-width: 640px) {
            body {
                padding: 0;
                align-items: flex-start;
                background-image: none;
                background-color: #F7F7F7;
            }
            .tablet-frame {
                width: 100vw !important;
                height: 100vh !important;
                max-width: none !important;
                max-height: none !important;
                border-radius: 0 !important;
                border: none !important;
                padding: 0 !important;
                margin: 0 !important;
                box-shadow: none !important;
                background-image: none !important;
                aspect-ratio: auto !important;
            }
            .screen-container {
                border-radius: 0 !important;
                box-shadow: none !important;
            }
            main { padding: 0 !important; }
        }

        /* --- BLUEPRINT MODE (Dark Mode) --- */
        .blueprint-mode .screen-container { background-color: #0f172a; color: #94a3b8; }
        .blueprint-mode .mission-file { background-color: #1e293b; border-color: #334155; }
        .blueprint-mode h1, .blueprint-mode h2, .blueprint-mode h3, .blueprint-mode strong { color: #38bdf8 !important; }
        .blueprint-mode .text-slate-500, .blueprint-mode .text-slate-700 { color: #94a3b8 !important; }
        .blueprint-mode .section-header { border-bottom-color: #334155; }
        .blueprint-mode .bg-white { background-color: #1e293b; border-color: #334155; }
        .blueprint-mode .status-active { border-left-color: #D34716; background-color: #1e293b; }
        .blueprint-mode .tab-btn { background-color: #1e293b; color: #94a3b8; border-color: #334155; }
        .blueprint-mode .tab-btn.active-tab { background-color: #0f172a; color: #38bdf8; border-color: #38bdf8; }

        /* --- SCROLLBARS (PDF STYLE) --- */
        .page::-webkit-scrollbar { width: 14px; }
        .page::-webkit-scrollbar-track { background: #e5e5e5; border-left: 1px solid #d1d5db; }
        .page::-webkit-scrollbar-thumb { background-color: #D34716; border-radius: 7px; border: 3px solid #e5e5e5; }
        .page::-webkit-scrollbar-thumb:hover { background-color: #EB8D69; }

        /* --- MODALS --- */
        .modal-transition { transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out; }
        .hidden-modal { opacity: 0; pointer-events: none; transform: translateY(-10px); }
        .visible-modal { opacity: 1; pointer-events: auto; transform: translateY(0); }

        /* --- LAYOUT --- */
        .navbar-content { flex: 0 0 60px; z-index: 20; background: #357889; border-bottom: 1px solid #2D6473; color: white; }
        .footer-content { flex: 0 0 50px; z-index: 20; background: white; border-top: 1px solid #e2e8f0; }
        .page { flex: 1 1 auto; overflow-y: auto; padding: 24px; position: relative; display: none; width: 100%; background-color: #f1f5f9; }
        .page.active { display: block; }

        /* --- TACTICAL DASHBOARD STYLES --- */
        .mission-file {
            background: white;
            border: 1px solid #e2e8f0;
            border-left-width: 4px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .mission-file:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .status-active { border-left-color: #D34716; }
        .status-ready { border-left-color: #357889; }
        .status-locked { border-left-color: #94a3b8; opacity: 0.7; cursor: not-allowed; }
        
        /* Tab Styling */
        .tab-btn {
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
        }
        .tab-btn:hover { background-color: rgba(255,255,255,0.5); }
        .active-tab {
            background-color: white;
            border-bottom-color: #D34716;
            color: #D34716;
            font-weight: bold;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
        }
        .inactive-tab {
            color: #64748b;
            background-color: transparent;
        }

        /* --- FOCUS MODE (Simulated Fullscreen) --- */
        body.focus-mode {
            background: #F7F7F7; /* Match inner screen color */
            background-image: none;
            padding: 0;
            margin: 0;
            overflow: hidden;
        }

        body.focus-mode .tablet-frame {
            width: 100vw !important;
            height: 100vh !important;
            max-width: none !important;
            max-height: none !important;
            border-radius: 0 !important;
            border: none !important;
            padding: 0 !important;
            margin: 0 !important;
            box-shadow: none !important;
            background-image: none !important;
            aspect-ratio: auto !important;
        }

        body.focus-mode .screen-container {
            border-radius: 0 !important;
            box-shadow: none !important;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen text-allgood-dark font-body">

    <main class="flex-grow flex items-center justify-center py-8">
        <div class="tablet-frame">
            <div class="screen-container" id="screen">

                <!-- 1. STARTUP SCREEN -->
                <div id="startup-screen" class="absolute inset-0 z-[300] flex flex-col items-center justify-center cursor-pointer transition-opacity duration-700 ease-in-out bg-slate-900">
                    <div class="group flex flex-col items-center justify-center text-center h-full w-full relative">
                        <div class="relative">
                            <div class="absolute inset-0 bg-allgood-primary/20 blur-3xl rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                            <h2 class="text-xl md:text-2xl font-heading text-slate-400 mb-2">Welcome to the</h2>
                            <h1 class="text-4xl md:text-6xl font-heading font-bold text-allgood-primary tracking-tighter relative z-10 drop-shadow-md static-neon-glow">Allgood<span class="text-white">Academy</span></h1>
                        </div>
                        <p class="mt-8 text-slate-500 text-xs tracking-[0.3em] uppercase font-medium group-hover:text-white transition-colors animate-pulse font-body">Click to Power Up</p>
                    </div>
                </div>

                <!-- 2. LOGIN MODAL -->
                <div id="login-modal" class="absolute inset-0 z-[200] bg-allgood-dark/95 flex items-center justify-center p-6 hidden-modal modal-transition backdrop-blur-sm">
                    <div class="bg-white rounded-lg shadow-2xl p-8 max-w-sm w-full text-center border-t-4 border-allgood-primary">
                        <div class="mb-6"><h2 class="text-3xl font-heading font-bold text-allgood-dark">Allgood<span class="text-allgood-primary">Academy</span></h2></div>
                        <h2 class="text-xl font-bold text-allgood-dark mb-2 font-heading">Welcome</h2>
                        <div class="flex items-center justify-center gap-2 mb-6 relative">
                            <p class="text-gray-500 text-sm font-body">Please sign in to start.</p>
                            <button class="group relative flex items-center text-allgood-primary hover:text-allgood-hover transition-colors focus:outline-none">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                                <span class="text-xs font-bold underline decoration-dotted underline-offset-2">Why?</span>
                                <div class="absolute top-full left-1/2 transform -translate-x-1/2 mt-3 w-64 p-3 bg-gray-800 text-white text-xs text-left rounded shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50 font-body leading-relaxed border border-gray-700 pointer-events-none">
                                    <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-b-gray-800"></div>
                                    <strong class="block text-allgood-primary mb-1 uppercase tracking-wide text-[10px]">Why do we ask?</strong>
                                    <p class="mb-2 text-gray-300">We use your name to personalize your badge. Performance data is logged in real-time to improve the Academy experience. All personal data is kept confidential and never sold.</p>
                                    <div class="border-t border-gray-700 my-1 pt-1"></div>
                                    <p class="text-gray-300"><strong>Email (Optional):</strong> Enter to join the Allgood Academy community.</p>
                                </div>
                            </button>
                        </div>
                        <input type="text" id="user-name-input" placeholder="Your Name (Optional)" class="w-full border border-gray-300 rounded p-3 mb-3 focus:ring-2 focus:ring-allgood-primary focus:border-transparent outline-none transition-all font-body text-center">
                        <input type="email" id="user-email-input" placeholder="Your Email (Optional)" class="w-full border border-gray-300 rounded p-3 mb-6 focus:ring-2 focus:ring-allgood-primary focus:border-transparent outline-none transition-all font-body text-center">
                        <button id="start-session-btn" class="w-full bg-allgood-primary hover:bg-allgood-hover text-white font-bold py-3 rounded shadow-md transition-transform transform hover:scale-[1.02] active:scale-[0.98] font-body">Enter Dashboard</button>
                    </div>
                </div>

                <!-- 3. TOP NAVBAR -->
                <header class="navbar-content flex items-center justify-between px-6 shadow-md relative z-30">
                    <div class="flex items-center overflow-hidden">
                        <div class="flex-shrink-0 text-white font-heading font-bold text-lg tracking-tight truncate mr-4 select-none">
                            Allgood Academy <span class="opacity-60 text-sm font-normal">| Dashboard</span>
                        </div>
                    </div>
                    <!-- Control Cluster -->
                    <div class="flex items-center space-x-1 shrink-0 relative">
                        <button id="btn-home" class="text-gray-200 hover:text-white transition-colors p-2 rounded-full hover:bg-white/10" title="Home (Hold to Reset)"><i data-lucide="home" class="w-5 h-5"></i></button>
                        <div class="h-6 w-px bg-white/20 mx-1"></div>
                        <button id="btn-blueprint" class="text-gray-200 hover:text-cyan-300 transition-colors p-2 rounded-full hover:bg-white/10" title="Blueprint Mode"><i data-lucide="sun" class="w-5 h-5"></i></button>
                        <button id="btn-fullscreen" class="text-gray-200 hover:text-green-300 transition-colors p-2 rounded-full hover:bg-white/10" title="Fullscreen"><i data-lucide="maximize" class="w-5 h-5"></i></button>
                        <button id="btn-menu" class="text-gray-200 hover:text-white transition-colors p-2 rounded-full hover:bg-white/10" title="Menu"><i data-lucide="menu" class="w-5 h-5"></i></button>
                    </div>
                </header>

                <!-- Sidebar Menu (Hidden by default) -->
                <div id="menu-modal" class="hidden-modal absolute inset-0 z-[100] bg-slate-900/50 flex justify-end modal-transition backdrop-blur-sm">
                    <div class="w-64 h-full bg-white shadow-2xl flex flex-col border-l border-slate-200">
                        <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                            <span class="font-bold text-slate-700 font-heading">System Menu</span>
                            <button id="close-menu" class="text-slate-400 hover:text-red-500 transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
                        </div>
                        <div class="p-3 space-y-1">
                            <button class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-100 text-slate-600 font-bold flex items-center transition-colors" onclick="alert('Dashboard Active')">
                                <i data-lucide="layout-grid" class="w-4 h-4 mr-3 text-allgood-primary"></i>Dashboard
                            </button>
                            <button class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-100 text-slate-600 font-bold flex items-center transition-colors" onclick="alert('Profile Module: Coming Soon')">
                                <i data-lucide="user" class="w-4 h-4 mr-3 text-allgood-secondary"></i>My Profile
                            </button>
                            <div class="border-t border-slate-100 my-2"></div>
                             <button class="w-full text-left px-4 py-3 rounded-lg hover:bg-red-50 text-red-600 font-bold flex items-center transition-colors" onclick="window.handleLogout()">
                                <i data-lucide="log-out" class="w-4 h-4 mr-3"></i>Log Out
                            </button>
                        </div>
                        <div class="mt-auto p-4 bg-slate-50 border-t border-slate-200 text-center">
                            <p class="text-xs text-slate-400">Allgood Academy<br>Pragmatic Action</p>
                        </div>
                    </div>
                </div>

                <!-- 4. DASHBOARD CONTENT (TACTICAL OPS) -->
                <div class="page" id="page-dashboard">
                    
                    <!-- Status Bar -->
                    <div class="flex items-center justify-between bg-white p-4 rounded-lg shadow-sm border border-slate-200 mb-6">
                        <div>
                            <h1 class="text-xl font-heading font-bold text-slate-700">Welcome, <span class="user-name-display text-allgood-primary">Agent</span>.</h1>
                            <!-- NEW: Interactive Badge Row -->
                            <div class="flex items-center mt-2 space-x-3">
                                <div class="text-xs text-slate-500 font-bold uppercase tracking-wide mr-2" id="clearance-label">Level 1: Observer</div>
                                
                                <!-- Badge 1: Observer -->
                                <div id="badge-1" class="w-8 h-8 bg-slate-200 rounded-full flex items-center justify-center text-slate-600 transition-all shadow-sm" onclick="showBadgeInfo(1)">
                                    <i data-lucide="eye" class="w-4 h-4"></i>
                                </div>
                                
                                <!-- Badge 2: Agent (Locked by default) -->
                                <div id="badge-2" class="w-8 h-8 bg-allgood-secondary text-white rounded-full flex items-center justify-center transition-all opacity-30 grayscale shadow-sm relative" onclick="showBadgeInfo(2)">
                                    <i data-lucide="id-card" class="w-4 h-4"></i>
                                    <i data-lucide="lock" class="w-3 h-3 absolute -top-1 -right-1 text-slate-400 bg-white rounded-full p-0.5 lock-icon"></i>
                                </div>
                                
                                <!-- Badge 3: Operator (Locked by default) -->
                                <div id="badge-3" class="w-8 h-8 bg-allgood-primary text-white rounded-full flex items-center justify-center transition-all opacity-30 grayscale shadow-sm relative" onclick="showBadgeInfo(3)">
                                    <i data-lucide="medal" class="w-4 h-4"></i>
                                    <i data-lucide="lock" class="w-3 h-3 absolute -top-1 -right-1 text-slate-400 bg-white rounded-full p-0.5 lock-icon"></i>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-4 text-right">
                            <div>
                                <span class="block text-2xl font-bold text-allgood-secondary leading-none">13</span>
                                <span class="text-[10px] uppercase text-slate-400 font-bold">Modules</span>
                            </div>
                            <div>
                                <span class="block text-2xl font-bold text-emerald-600 leading-none">0</span>
                                <span class="text-[10px] uppercase text-slate-400 font-bold">Completed</span>
                            </div>
                        </div>
                    </div>

                    <!-- TAB NAVIGATION -->
                    <div class="flex space-x-2 mb-6 border-b border-slate-200 px-2 overflow-x-auto">
                        <button id="tab-btn-goodblocks" onclick="switchTab('goodblocks')" class="tab-btn active-tab flex items-center px-4 py-3 rounded-t-lg text-sm">
                            <i data-lucide="box" class="w-4 h-4 mr-2"></i> GoodBlocks
                        </button>
                        <button id="tab-btn-games" onclick="switchTab('games')" class="tab-btn inactive-tab flex items-center px-4 py-3 rounded-t-lg text-sm">
                            <i data-lucide="gamepad-2" class="w-4 h-4 mr-2"></i> Games & Sims
                        </button>
                        <button id="tab-btn-courses" onclick="switchTab('courses')" class="tab-btn inactive-tab flex items-center px-4 py-3 rounded-t-lg text-sm">
                            <i data-lucide="book-open" class="w-4 h-4 mr-2"></i> Courses
                        </button>
                    </div>

                    <!-- TAB 1: GOODBLOCKS -->
                    <div id="tab-goodblocks" class="tab-content grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- 1. Countdown to Keys (Coming Soon) -->
                        <div class="mission-file status-locked p-5 flex items-start gap-4 group opacity-50">
                            <div class="w-16 h-16 bg-slate-50 rounded flex items-center justify-center border border-slate-100 flex-shrink-0">
                                <i data-lucide="key" class="w-8 h-8 text-slate-400"></i>
                            </div>
                            <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-slate-500 text-lg mb-1">Countdown to Keys</h3>
                                    <span class="bg-slate-200 text-slate-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide">Coming Soon</span>
                                </div>
                                <p class="text-xs text-slate-500 mb-3 leading-relaxed"><strong>Action:</strong> Execute the 100-day protocol to secure your first home.</p>
                            </div>
                        </div>

                        <!-- 2. Mastering the Sincere Apology -->
                        <div onclick="window.launchCourse('Mastering the Apology', 'https://www.allgoodacademy.com/goodblocks/mastering-the-sincere-apology')" 
                             class="mission-file status-ready p-5 flex items-start gap-4 group">
                            <div class="w-16 h-16 bg-emerald-50 rounded flex items-center justify-center border border-emerald-100 flex-shrink-0 group-hover:bg-emerald-100 transition-colors">
                                <i data-lucide="heart-handshake" class="w-8 h-8 text-emerald-600"></i>
                            </div>
                            <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-slate-800 text-lg mb-1">Mastering the Apology</h3>
                                    <span class="bg-emerald-100 text-emerald-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide">Ready</span>
                                </div>
                                <p class="text-xs text-slate-500 mb-3 leading-relaxed"><strong>Action:</strong> Deploy the 4-part structure to de-escalate conflict instantly.</p>
                            </div>
                        </div>

                        <!-- 3. Your Digital Identity -->
                        <div onclick="window.launchCourse('Your Digital Identity', 'https://www.allgoodacademy.com/goodblocks/your-digital-identity')" 
                             class="mission-file status-ready p-5 flex items-start gap-4 group">
                            <div class="w-16 h-16 bg-purple-50 rounded flex items-center justify-center border border-purple-100 flex-shrink-0 group-hover:bg-purple-100 transition-colors">
                                <i data-lucide="fingerprint" class="w-8 h-8 text-purple-600"></i>
                            </div>
                            <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-slate-800 text-lg mb-1">Your Digital Identity</h3>
                                    <span class="bg-purple-100 text-purple-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide">Ready</span>
                                </div>
                                <p class="text-xs text-slate-500 mb-3 leading-relaxed"><strong>Action:</strong> Audit your online footprint and secure your personal perimeter.</p>
                            </div>
                        </div>

                        <!-- 4. Digital Asset Defender -->
                        <div onclick="window.launchCourse('Digital Asset Defender', 'https://www.allgoodacademy.com/goodblocks/digital-asset-defender')" 
                             class="mission-file status-ready p-5 flex items-start gap-4 group">
                            <div class="w-16 h-16 bg-blue-50 rounded flex items-center justify-center border border-blue-100 flex-shrink-0 group-hover:bg-blue-100 transition-colors">
                                <i data-lucide="shield-check" class="w-8 h-8 text-blue-600"></i>
                            </div>
                            <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-slate-800 text-lg mb-1">Digital Asset Defender</h3>
                                    <span class="bg-blue-100 text-blue-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide">Ready</span>
                                </div>
                                <p class="text-xs text-slate-500 mb-3 leading-relaxed"><strong>Action:</strong> Secure wealth via wallet protocols and threat avoidance.</p>
                            </div>
                        </div>

                        <!-- 5. Airport Navigator -->
                        <div onclick="window.launchCourse('Airport Navigator', 'https://www.allgoodacademy.com/goodblocks/airport-navigator')" 
                             class="mission-file status-ready p-5 flex items-start gap-4 group">
                            <div class="w-16 h-16 bg-sky-50 rounded flex items-center justify-center border border-sky-100 flex-shrink-0 group-hover:bg-sky-100 transition-colors">
                                <i data-lucide="plane" class="w-8 h-8 text-sky-600"></i>
                            </div>
                            <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-slate-800 text-lg mb-1">Airport Navigator</h3>
                                    <span class="bg-sky-100 text-sky-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide">Ready</span>
                                </div>
                                <p class="text-xs text-slate-500 mb-3 leading-relaxed"><strong>Action:</strong> Master the logistical flow from curb to gate with zero friction.</p>
                            </div>
                        </div>
                    </div>

                    <!-- TAB 2: GAMES & SIMS -->
                    <div id="tab-games" class="tab-content grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
                        <!-- 1. Jolene's Lemonade -->
                        <div onclick="window.launchCourse('Jolene\'s Lemonade', 'https://www.allgoodacademy.com/educational-games/jolenes-lemonade-challenge')" 
                             class="mission-file status-ready p-5 flex items-start gap-4 group">
                            <div class="w-16 h-16 bg-yellow-50 rounded flex items-center justify-center border border-yellow-100 flex-shrink-0 group-hover:bg-yellow-100 transition-colors">
                                <i data-lucide="store" class="w-8 h-8 text-yellow-600"></i>
                            </div>
                            <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-slate-800 text-lg mb-1">Jolene's Lemonade</h3>
                                    <span class="bg-yellow-100 text-yellow-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide">Ready</span>
                                </div>
                                <p class="text-xs text-slate-500 mb-3 leading-relaxed"><strong>Action:</strong> Manage supply, demand, and profit margins in a live market.</p>
                            </div>
                        </div>

                        <!-- 2. Digital Decisions -->
                        <div onclick="window.launchCourse('Digital Decisions', 'https://www.allgoodacademy.com/educational-games/digital-decisions')" 
                             class="mission-file status-active p-5 flex items-start gap-4 group">
                            <div class="w-16 h-16 bg-indigo-50 rounded flex items-center justify-center border border-indigo-100 flex-shrink-0 group-hover:bg-indigo-100 transition-colors">
                                <i data-lucide="smartphone" class="w-8 h-8 text-indigo-600"></i>
                            </div>
                            <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-slate-800 text-lg mb-1">Digital Decisions</h3>
                                    <span class="bg-indigo-100 text-indigo-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide">Active</span>
                                </div>
                                <p class="text-xs text-slate-500 mb-3 leading-relaxed"><strong>Action:</strong> Make high-stakes choices in simulated online conflict scenarios.</p>
                            </div>
                        </div>

                        <!-- 3. Conflict Resolution -->
                        <div onclick="window.launchCourse('Conflict Resolution', 'https://www.allgoodacademy.com/educational-games/conflict-resolution-challenge')" 
                             class="mission-file status-ready p-5 flex items-start gap-4 group">
                            <div class="w-16 h-16 bg-red-50 rounded flex items-center justify-center border border-red-100 flex-shrink-0 group-hover:bg-red-100 transition-colors">
                                <i data-lucide="swords" class="w-8 h-8 text-red-600"></i>
                            </div>
                            <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-slate-800 text-lg mb-1">Conflict Resolution</h3>
                                    <span class="bg-red-100 text-red-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide">Ready</span>
                                </div>
                                <p class="text-xs text-slate-500 mb-3 leading-relaxed"><strong>Action:</strong> Identify triggers and neutralize tension in high-stress interactions.</p>
                            </div>
                        </div>

                        <!-- 4. Purposeful Communicator -->
                        <div onclick="window.launchCourse('Purposeful Communicator', 'https://www.allgoodacademy.com/educational-games/purposeful-communicator-challenge')" 
                             class="mission-file status-ready p-5 flex items-start gap-4 group">
                            <div class="w-16 h-16 bg-teal-50 rounded flex items-center justify-center border border-teal-100 flex-shrink-0 group-hover:bg-teal-100 transition-colors">
                                <i data-lucide="message-circle" class="w-8 h-8 text-teal-600"></i>
                            </div>
                            <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-slate-800 text-lg mb-1">Purposeful Communicator</h3>
                                    <span class="bg-teal-100 text-teal-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide">Ready</span>
                                </div>
                                <p class="text-xs text-slate-500 mb-3 leading-relaxed"><strong>Action:</strong> Select precise language to drive outcomes and build consensus.</p>
                            </div>
                        </div>

                        <!-- 5. Master Your Story -->
                        <div onclick="window.launchCourse('Master Your Story', 'https://www.allgoodacademy.com/educational-games/master-your-story-challenge')" 
                             class="mission-file status-ready p-5 flex items-start gap-4 group">
                            <div class="w-16 h-16 bg-rose-50 rounded flex items-center justify-center border border-rose-100 flex-shrink-0 group-hover:bg-rose-100 transition-colors">
                                <i data-lucide="book-open" class="w-8 h-8 text-rose-600"></i>
                            </div>
                            <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-slate-800 text-lg mb-1">Master Your Story</h3>
                                    <span class="bg-rose-100 text-rose-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide">Ready</span>
                                </div>
                                <p class="text-xs text-slate-500 mb-3 leading-relaxed"><strong>Action:</strong> Craft and deliver a compelling personal narrative for business and life.</p>
                            </div>
                        </div>
                    </div>

                    <!-- TAB 3: COURSES -->
                    <div id="tab-courses" class="tab-content grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
                        <!-- 1. Pragmatic Learning -->
                        <div onclick="window.launchCourse('Pragmatic Learning', 'https://www.allgoodacademy.com/courses/pragmatic-learning-turning-knowledge-into-action')" 
                             class="mission-file status-ready p-5 flex items-start gap-4 group">
                            <div class="w-16 h-16 bg-amber-50 rounded flex items-center justify-center border border-amber-100 flex-shrink-0 group-hover:bg-amber-100 transition-colors">
                                <i data-lucide="brain-circuit" class="w-8 h-8 text-amber-600"></i>
                            </div>
                            <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-slate-800 text-lg mb-1">Pragmatic Learning</h3>
                                    <span class="bg-amber-100 text-amber-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide">Ready</span>
                                </div>
                                <p class="text-xs text-slate-500 mb-3 leading-relaxed"><strong>Action:</strong> Turn passive input into active output. The core philosophy of Allgood Academy.</p>
                            </div>
                        </div>

                        <!-- 2. The Unwritten Rules -->
                        <div onclick="window.launchCourse('The Unwritten Rules', 'https://www.allgoodacademy.com/courses/the-unwritten-rules-navigating-social-emotional-learning')" 
                             class="mission-file status-ready p-5 flex items-start gap-4 group">
                            <div class="w-16 h-16 bg-slate-100 rounded flex items-center justify-center border border-slate-200 flex-shrink-0 group-hover:bg-slate-200 transition-colors">
                                <i data-lucide="scale" class="w-8 h-8 text-slate-600"></i>
                            </div>
                            <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-slate-800 text-lg mb-1">The Unwritten Rules</h3>
                                    <span class="bg-slate-200 text-slate-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide">Ready</span>
                                </div>
                                <p class="text-xs text-slate-500 mb-3 leading-relaxed"><strong>Action:</strong> Decode the hidden social contracts that govern professional environments.</p>
                            </div>
                        </div>

                        <!-- 3. The AI Co-Pilot -->
                        <div onclick="window.launchCourse('The AI Co-Pilot', 'https://www.allgoodacademy.com/courses/the-ai-co-pilot-a-15-minute-microlearning-course')" 
                             class="mission-file status-ready p-5 flex items-start gap-4 group">
                            <div class="w-16 h-16 bg-cyan-50 rounded flex items-center justify-center border border-cyan-100 flex-shrink-0 group-hover:bg-cyan-100 transition-colors">
                                <i data-lucide="bot" class="w-8 h-8 text-cyan-600"></i>
                            </div>
                            <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-slate-800 text-lg mb-1">The AI Co-Pilot</h3>
                                    <span class="bg-cyan-100 text-cyan-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide">Ready</span>
                                </div>
                                <p class="text-xs text-slate-500 mb-3 leading-relaxed"><strong>Action:</strong> Integrate AI into your workflow in 15 minutes.</p>
                            </div>
                        </div>
                    </div>

                    <!-- FOOTER OS SIGNATURE (Inside Scroll) -->
                    <div class="mt-12 mb-6 text-center">
                        <p class="text-[10px] text-slate-400 font-mono tracking-widest uppercase opacity-60">
                            Allgood OS <span class="mx-2"></span> GoodBlock
                        </p>
                    </div>

                <!-- BADGE DETAIL MODAL -->
                <div id="badge-modal" class="hidden-modal absolute inset-0 z-[250] bg-allgood-dark/90 flex items-center justify-center p-6 modal-transition backdrop-blur-sm" onclick="closeBadgeModal()">
                    <div class="bg-white rounded-lg shadow-2xl p-6 max-w-sm w-full text-center border-t-4 border-allgood-primary relative" onclick="event.stopPropagation()">
                        <button onclick="closeBadgeModal()" class="absolute top-2 right-2 text-gray-400 hover:text-red-500"><i data-lucide="x" class="w-5 h-5"></i></button>
                        
                        <div class="mb-4">
                            <h3 id="badge-title" class="text-2xl font-heading font-bold text-allgood-dark">Level Name</h3>
                            <p id="badge-status" class="text-xs font-bold uppercase tracking-widest mt-1">STATUS</p>
                        </div>
                        
                        <p id="badge-desc" class="text-gray-600 text-sm mb-4 leading-relaxed">Description goes here.</p>
                        
                        <div class="bg-slate-50 p-3 rounded border border-slate-200 text-xs text-slate-500 font-bold">
                            <span id="badge-req">Requirement: ...</span>
                        </div>
                        
                        <button onclick="closeBadgeModal()" class="mt-6 w-full bg-allgood-secondary hover:bg-allgood-accent text-white font-bold py-2 rounded text-sm shadow-md transition-colors">
                            Continue Mission
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <script>
        // --- AUDIO ENGINE ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx;

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new AudioContext();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume().catch(e => console.error("Audio resume failed:", e));
            }
        }

        // Updated Helper with Envelope Control (Attack/Decay)
        function playTone(freq, type, duration, vol = 0.1, attack = 0.01, decay = 0.001) {
            initAudio();
            const now = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();

            osc.type = type;
            osc.frequency.setValueAtTime(freq, now);
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(vol, now + attack);
            gain.gain.exponentialRampToValueAtTime(decay, now + duration);

            osc.start(now);
            osc.stop(now + duration);
        }

        const sfx = {
            powerOn: () => {
                initAudio();
                const now = audioCtx.currentTime;
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(110, now);
                osc.frequency.exponentialRampToValueAtTime(220, now + 0.4);
                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(0.4, now + 0.1);
                gain.gain.linearRampToValueAtTime(0, now + 0.4);
                osc.start(now); osc.stop(now + 0.4);
            },
            powerOff: () => {
                initAudio();
                playTone(80, 'triangle', 0.2, 0.5, 0.01, 0.001);
            },
            nav: () => {
                initAudio();
                playTone(150, 'sine', 0.1, 0.1, 0.01, 0.01);
            },
            tick: () => {
                initAudio();
                playTone(1000, 'sine', 0.01, 0.01);
            },
            click: () => {
                initAudio();
                playTone(1000, 'sine', 0.01, 0.01);
            },
            confirm: () => {
                initAudio();
                playTone(150, 'sine', 0.1, 0.1, 0.01, 0.01); 
            }
        };

        // --- TAB LOGIC ---
        window.switchTab = (tabName) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            
            const target = document.getElementById('tab-' + tabName);
            if(target) target.classList.remove('hidden');
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active-tab');
                btn.classList.add('inactive-tab');
            });
            
            const activeBtn = document.getElementById('tab-btn-' + tabName);
            if(activeBtn) {
                activeBtn.classList.remove('inactive-tab');
                activeBtn.classList.add('active-tab');
            }
            
            sfx.nav(); 
        };

        window.initDashboard = () => {
            // This function now only handles Firebase initialization and badge state management.
            // The logic to restore a session from localStorage has been REMOVED here
            // to enforce the "Session Required" flow (Power Up screen on every load).
            
            if (!isOfflineMode) {
                // --- ONLINE MODE (FIREBASE) ---
                 onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        const userRef = doc(db, 'artifacts', appId, 'users', user.uid);
                        try {
                            const docSnap = await getDoc(userRef);
                            if (docSnap.exists()) {
                                const data = docSnap.data();
                                if(data.displayName) {
                                    // Restore Guest Status from DB
                                    const isGuest = data.isGuest !== undefined ? data.isGuest : (data.displayName === 'Guest' || data.displayName === 'Learner');
                                    localStorage.setItem('aa_is_guest', isGuest);
                                    
                                    // We still update UI variables, but DON'T hide the startup screen.
                                    updateUI(data.displayName); 
                                    closeLoginModal();
                                }
                            }
                        } catch(e) { console.log("Offline or error fetching user from Firebase.", e); }
                    }
                    updateBadges();
                });
            } else {
                // --- OFFLINE MODE ---
                // Only running badge updates and necessary checks.
                updateBadges();
            }
        };


        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();

            // 1. Startup Logic
            const startupScreen = document.getElementById('startup-screen');
            const loginModal = document.getElementById('login-modal');
            const dashboard = document.getElementById('page-dashboard');

            // Initialize App
            if(window.initDashboard) window.initDashboard();
            
            // --- FIX: ENFORCE SESSION REQUIRED ---
            // We ignore localStorage and force the UI state to start with the Power Up screen.
            if (startupScreen) {
                startupScreen.style.display = 'flex';
                startupScreen.style.opacity = '1';
            }
            if (dashboard) dashboard.classList.remove('active');
            
            // Warm up audio context on interaction
            if (startupScreen) {
                const warmUp = () => initAudio();
                startupScreen.addEventListener('mousedown', warmUp, { once: true });
                startupScreen.addEventListener('touchstart', warmUp, { once: true });
                
                startupScreen.addEventListener('click', () => {
                    sfx.powerOn(); 
                    startupScreen.style.opacity = '0';
                    setTimeout(() => { 
                        startupScreen.style.display = 'none';
                        
                        // Check local storage for name: if found, we skip login and show dashboard
                        const storedName = localStorage.getItem('aa_username');
                        
                        if (storedName) {
                            // User has local data saved from a previous session, show dashboard immediately.
                            updateUI(storedName);
                            dashboard.classList.add('active');
                            // CRITICAL FIX: Ensure display property is set to overcome CSS 'display: none' in .page
                            dashboard.style.display = 'block'; 
                        } else if (loginModal) {
                            // No local data, must show login modal.
                             loginModal.classList.remove('hidden-modal');
                             loginModal.classList.add('visible-modal');
                        }
                    }, 700);
                });
            }

            // 2. Login Logic
            document.getElementById('start-session-btn').addEventListener('click', () => {
                const input = document.getElementById('user-name-input');
                const emailInput = document.getElementById('user-email-input');
                
                let rawName = input.value.trim();
                let rawEmail = emailInput.value.trim();
                
                // Logic: If BOTH are empty, they are a Guest (Level 1)
                // If EITHER has content, they are an Agent (Level 2)
                const isGuest = (!rawName && !rawEmail);
                
                let finalName = rawName || "Guest";
                
                if(window.handleLogin) {
                    window.handleLogin(finalName, rawEmail, isGuest);
                }
            });

            // 3. Navbar Control Cluster Logic
            const homeBtn = document.getElementById('btn-home');
            let homePressTimer;
            let homeIsHold = false;

            const startHomePress = (e) => {
                e.preventDefault(); 
                homeIsHold = false;
                homePressTimer = setTimeout(() => {
                    homeIsHold = true;
                    if(window.handleLogout) {
                        sfx.powerOff(); 
                        window.handleLogout();
                    }
                }, 2000);
            };

            const endHomePress = (e) => {
                clearTimeout(homePressTimer);
                if(!homeIsHold) {
                    sfx.tick(); 
                    document.getElementById('page-dashboard').scrollTop = 0;
                }
            };

            homeBtn.addEventListener('mousedown', startHomePress);
            homeBtn.addEventListener('touchstart', startHomePress);
            homeBtn.addEventListener('mouseup', endHomePress);
            homeBtn.addEventListener('touchend', endHomePress);
            homeBtn.addEventListener('mouseleave', () => clearTimeout(homePressTimer));

            document.getElementById('btn-blueprint').addEventListener('click', () => {
                document.body.classList.toggle('blueprint-mode');
                sfx.tick();
            });

            const toggleFullscreen = () => {
                try {
                    if (!document.fullscreenElement && !document.webkitFullscreenElement) {
                        if (document.documentElement.requestFullscreen) {
                            document.documentElement.requestFullscreen();
                        } else if (document.documentElement.webkitRequestFullscreen) {
                            document.documentElement.webkitRequestFullscreen();
                        }
                    } else {
                        if (document.exitFullscreen) {
                            document.exitFullscreen();
                        } else if (document.webkitExitFullscreen) {
                            document.webkitExitFullscreen();
                        }
                    }
                } catch(e) {
                    console.warn("Fullscreen blocked by permissions policy");
                    alert("Fullscreen mode unavailable in this view.");
                }
                sfx.tick();
            };
            document.getElementById('btn-fullscreen').addEventListener('click', toggleFullscreen);

            const menuModal = document.getElementById('menu-modal');
            document.getElementById('btn-menu').addEventListener('click', () => {
                menuModal.classList.remove('hidden-modal');
                menuModal.classList.add('visible-modal');
                sfx.tick();
            });

            document.getElementById('close-menu').addEventListener('click', () => {
                menuModal.classList.add('hidden-modal');
                menuModal.classList.remove('visible-modal');
                sfx.tick();
            });
        });
    </script>
</body>
</html>
