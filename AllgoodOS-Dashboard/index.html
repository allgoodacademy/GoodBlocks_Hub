<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Allgood Academy Dashboard</title>
    <!-- ADDED: Favicon for professional branding -->
    <link rel="icon" type="image/png" href="/favicon.png">

    <!-- ADDED: Google Analytics (GA4) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-EN4M7T3BLQ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-EN4M7T3BLQ');
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, updateProfile, signOut, GoogleAuthProvider, signInWithPopup, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, addDoc, collection, serverTimestamp, onSnapshot, query, where } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('Debug');
        
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyAf2SO8xovrApl52udUUoR1n9WBnERr_ko",
            authDomain: "allgood-academy.firebaseapp.com",
            projectId: "allgood-academy",
            storageBucket: "allgood-academy.firebasestorage.app",
            messagingSenderId: "978829044870",
            appId: "1:978829044870:web:6c780f64230a77ad0ab507",
            measurementId: "G-EN4M7T3BLQ"
        };
        
        const appId = 'allgood-academy'; 
        
        let auth, db;

        const app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);

        (async function initAuth() {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                try {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } catch (e) {
                    console.warn("Auth token failed, falling back", e);
                }
            }
        })();

        window.auth = auth; 
        window.db = db;

        let launchCount = parseInt(localStorage.getItem('aa_launch_count') || '0');
        let unsubscribeLaunches = null;
        let unsubscribeDecisions = null;
        
        window.allModuleElements = {};
        // GLOBAL REGISTRY FOR LIVE SVG ASSETS
        window.userEarnedBadges = {};

        async function writeUserDataToFirestore(user, name, email, isGuest) {
             const userRef = doc(db, 'artifacts', appId, 'users', user.uid);
             
             if (isGuest && user.displayName !== name) {
                await updateProfile(user, { displayName: name });
             }

             await setDoc(userRef, {
                 displayName: name,
                 email: email || (isGuest ? null : user.email || null),
                 isGuest: isGuest,
                 lastLogin: serverTimestamp(),
                 onboardingComplete: true
             }, { merge: true });

             localStorage.setItem('aa_is_guest', isGuest);
             localStorage.setItem('aa_username', name);
             localStorage.setItem('aa_uid', user.uid);
             
             window.updateUI(name); 
             document.getElementById('page-dashboard').classList.add('active');
             document.getElementById('page-dashboard').style.display = 'block'; 
             
             // Show navbar
             document.querySelector('.navbar-content').classList.remove('opacity-0');
             
             closeLoginModal();
             
             window.startLaunchListener(user.uid);
             window.startDecisionsStatusListener(user.uid);
        }

        window.handleGuestLogin = async () => {
            sfx.click();
            const btn = document.getElementById('btn-guest-login');
            
            const nameInput = document.getElementById('user-name-input').value.trim();
            const emailInput = document.getElementById('user-email-input').value.trim();

            const finalName = nameInput || "Guest";
            const finalEmail = emailInput || null;
            const isGuest = true;
            
            btn.innerText = "Connecting...";
            btn.disabled = true;
            btn.classList.add('opacity-70', 'cursor-wait');

            try {
                const userCredential = await signInAnonymously(auth);
                const user = userCredential.user;
                await writeUserDataToFirestore(user, finalName, finalEmail, isGuest);
            } catch (error) {
                console.error("Anonymous Login Error:", error);
                showStatusMessage("Connection failed. Check network or rules.", 'error'); 
            } finally {
                btn.innerText = "Enter Dashboard"; 
                btn.disabled = false;
                btn.classList.remove('opacity-70', 'cursor-wait');
            }
        };

        window.handleGoogleLogin = async () => {
            sfx.click();
            const btnContainer = document.getElementById('google-icon-container');
            btnContainer.classList.add('opacity-50', 'cursor-wait');
            
            const provider = new GoogleAuthProvider();
            const isGuest = false;

            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                const finalName = user.displayName || 'Agent';
                const finalEmail = user.email || null;
                await writeUserDataToFirestore(user, finalName, finalEmail, isGuest);
            } catch (error) {
                console.error("Google Sign-In Error:", error);
                let message = "Sign-in failed. Please try again.";
                if (error.code === 'auth/popup-closed-by-user') {
                    message = "Sign-in canceled. Please try again.";
                }
                showStatusMessage(message, 'error');
            } finally {
                btnContainer.classList.remove('opacity-50', 'cursor-wait');
            }
        };

        window.launchCourse = async (courseName, url, element) => {
            if (!auth.currentUser) {
                const loginModal = document.getElementById('login-modal');
                if (loginModal) {
                    loginModal.classList.remove('hidden-modal');
                    loginModal.classList.add('visible-modal');
                    showStatusMessage("Please sign in to launch modules.", 'info');
                }
                return;
            }

            let finalUrl = url;
            try {
                const urlObj = new URL(url);
                urlObj.searchParams.append('dashboard_uid', auth.currentUser.uid);
                finalUrl = urlObj.toString();
            } catch (e) { console.log("URL append failed", e); }

            // Option 1: Instant Execution
            sfx.confirm();

            // ADDED: Track module launch in GA4
            if (typeof gtag === 'function') {
                gtag('event', 'launch_module', { 'module_name': courseName });
            }

            window.open(finalUrl, '_blank');
            
            if (auth.currentUser) {
                addDoc(collection(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'launches'), {
                    courseName: courseName,
                    targetUrl: url,
                    timestamp: serverTimestamp()
                }).catch(e => console.log("Log failed (Firebase). Continuing navigation."));

                if (element) {
                    const badge = element.querySelector('span.rounded'); 
                    if (badge) {
                        if (badge.id === 'ddc-status-badge') return; 

                        badge.textContent = "LAUNCHED";
                        badge.className = "bg-blue-100 text-blue-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide transition-all duration-500 animate-pulse";
                        setTimeout(() => badge.classList.remove('animate-pulse'), 2000);
                    }
                }
            }
        };

        window.openMessageModal = () => {
            const menu = document.getElementById('menu-modal');
            if(menu) { menu.classList.add('hidden-modal'); menu.classList.remove('visible-modal'); }
            
            const modal = document.getElementById('message-modal');
            modal.classList.remove('hidden-modal');
            modal.classList.add('visible-modal');
            sfx.click();
            setTimeout(() => document.getElementById('message-input').focus(), 100);
        }

        window.closeMessageModal = () => {
            const modal = document.getElementById('message-modal');
            modal.classList.add('hidden-modal');
            modal.classList.remove('visible-modal');
            sfx.click();
        }

        window.submitMessage = async () => {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            const btn = document.getElementById('btn-send-message');
            
            if (!text) return;
            
            const user = auth.currentUser;
            if (!user) {
                const originalText = btn.innerHTML;
                btn.classList.remove('bg-allgood-primary', 'hover:bg-allgood-hover');
                btn.classList.add('bg-red-600', 'hover:bg-red-700');
                btn.textContent = "Please Sign In First";
                sfx.powerOff();
                
                setTimeout(() => {
                    btn.classList.add('bg-allgood-primary', 'hover:bg-allgood-hover');
                    btn.classList.remove('bg-red-600', 'hover:bg-red-700');
                    btn.innerHTML = originalText;
                    lucide.createIcons();
                }, 2000);
                return;
            }

            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.textContent = "Sending...";

            try {
                const targetCollection = collection(db, 'artifacts', appId, 'users', user.uid, 'feedback_inbox');
                
                await addDoc(targetCollection, {
                    senderName: user.displayName || "Guest Agent",
                    senderEmail: user.email || "Anonymous",
                    message: text,
                    timestamp: serverTimestamp(),
                    isGuest: user.isAnonymous
                });
                
                sfx.confirm();
                input.value = "";
                
                btn.classList.remove('bg-allgood-primary', 'hover:bg-allgood-hover');
                btn.classList.add('bg-emerald-600', 'hover:bg-emerald-700');
                btn.innerHTML = `<i data-lucide="check" class="w-3 h-3"></i> Transmission Sent`;
                lucide.createIcons();

                setTimeout(() => {
                    closeMessageModal();
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.classList.add('bg-allgood-primary', 'hover:bg-allgood-hover');
                        btn.classList.remove('bg-emerald-600', 'hover:bg-emerald-700');
                        btn.innerHTML = originalText;
                        lucide.createIcons();
                    }, 500);
                }, 1500);

            } catch (e) {
                console.error("Message failed", e);
                btn.classList.remove('bg-allgood-primary', 'hover:bg-allgood-hover');
                btn.classList.add('bg-red-600', 'hover:bg-red-700');
                btn.textContent = "Transmission Failed";
                sfx.powerOff();

                setTimeout(() => {
                    btn.disabled = false;
                    btn.classList.add('bg-allgood-primary', 'hover:bg-allgood-hover');
                    btn.classList.remove('bg-red-600', 'hover:bg-red-700');
                    btn.innerHTML = originalText;
                    lucide.createIcons();
                }, 3000);
            }
        }

        window.handleLogout = async () => {
            sfx.powerOff();
            localStorage.removeItem('aa_username');
            localStorage.removeItem('aa_is_guest'); 
            localStorage.removeItem('aa_launch_count');
            localStorage.removeItem('aa_uid');
            localStorage.removeItem('aa_ddc_complete');
            localStorage.removeItem('aa_jlc_complete');
            localStorage.removeItem('aa_identity_complete');
            localStorage.removeItem('aa_defense_complete');

            launchCount = 0; 
            
            if (auth.currentUser) {
                try { await signOut(auth); } catch(e) { console.log("Signout error", e); }
            }
            
            if (unsubscribeLaunches) {
                unsubscribeLaunches();
                unsubscribeLaunches = null;
            }

            if (unsubscribeDecisions) { 
                unsubscribeDecisions();
                unsubscribeDecisions = null;
            }
            
            // Reset badges
            document.querySelectorAll('.mission-file span.rounded').forEach(badge => {
                if (badge.textContent === "LAUNCHED") {
                    badge.textContent = "Ready";
                    const parent = badge.closest('.mission-file');
                    if (parent.classList.contains('status-active')) {
                         badge.className = "bg-indigo-100 text-indigo-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide";
                         badge.textContent = "Active";
                    } else if (parent.classList.contains('status-ready')) {
                         badge.className = "bg-gray-100 text-gray-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide"; 
                         badge.textContent = "Ready";
                    }
                }
            });

            const ddcBadge = document.getElementById('ddc-status-badge');
            if(ddcBadge) {
                ddcBadge.textContent = "Active";
                ddcBadge.className = "bg-indigo-100 text-indigo-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide";
            }
            
            window.initModuleElements();

            document.querySelectorAll('.visible-modal').forEach(el => {
                el.classList.remove('visible-modal');
                el.classList.add('hidden-modal');
            });

            const dashboard = document.getElementById('page-dashboard');
            if (dashboard) {
                dashboard.classList.remove('active');
                dashboard.style.display = 'none';
            }
            
            // Hide Navbar
            document.querySelector('.navbar-content').classList.add('opacity-0');
            
            // Hide Admin Panel if open
            const adminPanel = document.getElementById('page-admin');
            if(adminPanel) {
                adminPanel.classList.remove('active');
                adminPanel.style.display = 'none';
            }
            
            window.updateUI('Agent'); 
            window.updateBadges(); 

            const startup = document.getElementById('startup-screen');
            if(startup) {
                document.getElementById('startup-message').textContent = "CLICK TO POWER UP";
                startup.style.display = 'flex';
                setTimeout(() => { startup.style.opacity = '1'; }, 10);
            }
        };

        // --- MOVED PROFILE FUNCTIONS TO MODULE SCOPE TO FIX REFERENCE ERROR ---
        
        window.openProfileModal = () => {
            // Close menu if open
            const menu = document.getElementById('menu-modal');
            if (menu) {
                menu.classList.add('hidden-modal');
                menu.classList.remove('visible-modal');
            }

            const modal = document.getElementById('profile-modal');
            modal.classList.remove('hidden-modal');
            modal.classList.add('visible-modal');
            if(window.sfx) window.sfx.click();

            // Populate Data
            const user = auth.currentUser;
            const storedName = localStorage.getItem('aa_username') || "Guest Agent";
            const storedUID = localStorage.getItem('aa_uid') || "N/A";
            const launches = localStorage.getItem('aa_launch_count') || "0";
            
            // Name
            const nameDisplay = document.getElementById('profile-name-display');
            const nameInput = document.getElementById('profile-name-input');
            if(nameDisplay) nameDisplay.textContent = storedName;
            if(nameInput) nameInput.value = storedName;
            
            // Stats
            const statLaunches = document.getElementById('profile-stat-launches');
            if(statLaunches) statLaunches.textContent = launches;
            
            // Badges & Rank Calculation
            let badgeCount = 1; // Observer
            if (user && !user.isAnonymous) badgeCount++;
            if (parseInt(launches) > 0) badgeCount++;
            if (localStorage.getItem('aa_ddc_complete') === 'true') badgeCount++;
            if (localStorage.getItem('aa_jlc_complete') === 'true') badgeCount++;
            if (localStorage.getItem('aa_identity_complete') === 'true') badgeCount++;
            if (localStorage.getItem('aa_defense_complete') === 'true') badgeCount++;

            const statBadges = document.getElementById('profile-stat-badges');
            if(statBadges) statBadges.textContent = badgeCount;

            // Rank Title Logic
            let rankTitle = "OBSERVER";
            if (badgeCount >= 2) rankTitle = "RECRUIT";
            if (badgeCount >= 3) rankTitle = "FIELD AGENT";
            if (badgeCount >= 5) rankTitle = "SPECIAL OPERATIVE";
            if (badgeCount >= 7) rankTitle = "ELITE GUARDIAN";
            
            const rankDisplay = document.getElementById('profile-rank-display');
            if(rankDisplay) rankDisplay.textContent = rankTitle;

            // ID & Meta
            const idDisplay = document.getElementById('profile-id-display');
            if(idDisplay) idDisplay.textContent = storedUID.substring(0, 8).toUpperCase() + "...";
            
            const dateDisplay = document.getElementById('profile-join-date');
            if (dateDisplay) {
                if (user && user.metadata && user.metadata.creationTime) {
                    const date = new Date(user.metadata.creationTime);
                    dateDisplay.textContent = date.toLocaleDateString();
                } else {
                    dateDisplay.textContent = new Date().toLocaleDateString();
                }
            }
        }

        window.closeProfileModal = () => {
            const modal = document.getElementById('profile-modal');
            modal.classList.add('hidden-modal');
            modal.classList.remove('visible-modal');
            // Reset Edit Mode
            window.toggleProfileEdit(false);
            if(window.sfx) window.sfx.click();
        }

        window.toggleProfileEdit = (isEditing) => {
            const viewMode = document.getElementById('profile-view-name');
            const editMode = document.getElementById('profile-edit-name');
            
            if (isEditing) {
                viewMode.classList.add('hidden');
                editMode.classList.remove('hidden');
                const input = document.getElementById('profile-name-input');
                if(input) input.focus();
            } else {
                viewMode.classList.remove('hidden');
                editMode.classList.add('hidden');
            }
        }

        window.saveProfileIdentity = async () => {
            const input = document.getElementById('profile-name-input');
            const newName = input.value.trim();
            
            if (!newName) return; 
            
            if(window.sfx) window.sfx.confirm();
            
            // 1. Update UI immediately
            const nameDisplay = document.getElementById('profile-name-display');
            if(nameDisplay) nameDisplay.textContent = newName;
            localStorage.setItem('aa_username', newName);
            window.updateUI(newName); 
            
            // 2. Update Firebase (NOW HAS ACCESS TO IMPORTS)
            const user = auth.currentUser;
            if (user) {
                try {
                    await updateProfile(user, { displayName: newName });
                    await setDoc(doc(db, 'artifacts', appId, 'users', user.uid), {
                        displayName: newName
                    }, { merge: true });
                } catch (e) {
                    console.error("Failed to save identity to cloud", e);
                }
            }
            
            window.toggleProfileEdit(false);
        }

        window.initModuleElements = function() {
            window.allModuleElements = {};
            const cards = document.querySelectorAll('.mission-file');
            cards.forEach(card => {
                const onclickAttr = card.getAttribute('onclick');
                if (onclickAttr && onclickAttr.includes('launchCourse')) {
                    const match = onclickAttr.match(/'([^']+)'/);
                    if (match && match[1]) {
                        const courseName = match[1];
                        const badge = card.querySelector('span.rounded');
                        if (badge) {
                            window.allModuleElements[courseName] = badge;
                        }
                    }
                }
            });
        }

        window.startLaunchListener = function(uid) {
            if (unsubscribeLaunches) unsubscribeLaunches();
            
            if (Object.keys(window.allModuleElements).length === 0) {
                window.initModuleElements();
            }

            const launchesCollectionRef = collection(db, 'artifacts', appId, 'users', uid, 'launches');
            unsubscribeLaunches = onSnapshot(launchesCollectionRef, (snapshot) => {
                const totalLaunches = snapshot.size;
                launchCount = totalLaunches; 
                localStorage.setItem('aa_launch_count', launchCount); 
                window.updateBadges();

                const statElement = document.getElementById('stat-total-launches');
                if (statElement) statElement.textContent = totalLaunches;
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const courseName = data.courseName;
                    const badgeElement = window.allModuleElements[courseName];
                    
                    if (badgeElement) {
                        if (badgeElement.id === 'ddc-status-badge') return;
                        
                        // FIX: Do not overwrite if already completed
                        if (badgeElement.textContent === "MISSION COMPLETE" || badgeElement.textContent === "CERTIFIED") return;

                        if (badgeElement.textContent !== "LAUNCHED") {
                            badgeElement.textContent = "LAUNCHED";
                            badgeElement.className = "bg-blue-100 text-blue-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide transition-all duration-500";
                        }
                    }
                });

            }, (error) => {
                console.error("Error listening to launches:", error);
            });
        }

        // Universal Status Listener (Handles DDC + JLC + All Content Blocks)
        window.startModuleStatusListener = function(uid) {
            if (unsubscribeDecisions) unsubscribeDecisions();
            
            const scoresRef = collection(db, 'artifacts', appId, 'users', uid, 'game_scores');
            
            unsubscribeDecisions = onSnapshot(scoresRef, (snapshot) => {
                let maxDDCScore = -1;
                let hasDDCAttempt = false;
                let isJLCComplete = false;
                
                // Set to track which modules are done in this snapshot
                const completedModules = new Set();
                
                // Reset user badges cache on update
                window.userEarnedBadges = {};

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const gameName = data.gameName;

                    // 1. Digital Decisions Logic (Score based)
                    if (gameName === "Digital Decisions Challenge" && typeof data.finalScore === 'number') {
                        hasDDCAttempt = true;
                        if (data.finalScore > maxDDCScore) maxDDCScore = data.finalScore;
                        
                        // Check for SVG Asset
                        if (data.badgeSVG) {
                            window.userEarnedBadges['cyber'] = data.badgeSVG;
                        }
                    }

                    // 2. Jolene's Lemonade Logic (Explicit completion flag OR Score Safety Net)
                    if (gameName === "Jolene's Lemonade" || gameName === "Jolenes Lemonade Challenge") {
                         if (data.complete === true || (typeof data.finalScore === 'number' && data.finalScore >= 800)) {
                             isJLCComplete = true;
                         }
                         
                         // Check for SVG Asset
                         if (data.badgeSVG) {
                             window.userEarnedBadges['entrepreneur'] = data.badgeSVG;
                         }
                    }

                    // 3. Generic Completion Logic (Boolean based)
                    if (data.completed === true && gameName) {
                        completedModules.add(gameName);

                        // FIX: Normalization for "The AI Co-Pilot"
                        // Database stores "AI Co-Pilot", but UI expects "The AI Co-Pilot"
                        if (gameName === "AI Co-Pilot") {
                            completedModules.add("The AI Co-Pilot");
                        }
                        
                        // FIX: Normalization for "Conflict Resolution"
                        if (gameName === "Conflict Resolution Challenge") {
                            completedModules.add("Conflict Resolution");
                        }
                        
                        // 3a. Identity Guardian Asset Logic
                        if (gameName === "Your Digital Identity" && data.badgeSVG) {
                            window.userEarnedBadges['identity'] = data.badgeSVG;
                        }

                        // 3b. Digital Asset Defense Logic (NEW)
                        if (gameName === "Digital Asset Defense" && data.badgeSVG) {
                            window.userEarnedBadges['defense'] = data.badgeSVG;
                        }
                        
                        // Future proofing: Generic badge storage logic could go here
                        if (data.badgeSVG && gameName === "Airport Navigator") {
                             window.userEarnedBadges['operator'] = data.badgeSVG; // Example mapping
                        }
                    }
                });

                // Update Local Storage for Badges
                if (hasDDCAttempt && maxDDCScore >= 80) localStorage.setItem('aa_ddc_complete', 'true');
                else localStorage.removeItem('aa_ddc_complete');
                
                // Store JLC Status
                if (isJLCComplete) localStorage.setItem('aa_jlc_complete', 'true');
                else localStorage.removeItem('aa_jlc_complete');
                
                // Store Identity Status
                if (completedModules.has("Your Digital Identity")) localStorage.setItem('aa_identity_complete', 'true');
                else localStorage.removeItem('aa_identity_complete');

                // Store Defense Status (NEW)
                if (completedModules.has("Digital Asset Defense")) localStorage.setItem('aa_defense_complete', 'true');
                else localStorage.removeItem('aa_defense_complete');
                
                // Check specifically for Airport Navigator for the specialized badge slot
                if (completedModules.has("Airport Navigator")) localStorage.setItem('aa_airport_complete', 'true');
                else localStorage.removeItem('aa_airport_complete');
                
                window.updateBadges();

                // UPDATE UI: Digital Decisions (Special Case)
                const ddcBadge = document.getElementById('ddc-status-badge');
                if (ddcBadge) {
                    if (maxDDCScore >= 80) { 
                        ddcBadge.textContent = "MISSION COMPLETE";
                        ddcBadge.className = "bg-emerald-100 text-emerald-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide transition-all duration-500 shadow-sm border border-emerald-200";
                    } else if (hasDDCAttempt) {
                        ddcBadge.textContent = "RETAKE REQUIRED";
                        ddcBadge.className = "bg-amber-100 text-amber-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide transition-all duration-500 shadow-sm border border-amber-200 animate-pulse";
                    }
                }

                // UPDATE UI: All Other Content Blocks
                for (const [courseName, badgeElement] of Object.entries(window.allModuleElements)) {
                    if (courseName === "Digital Decisions") continue; // Skip DDC

                    // Check JLC specifically (Key matches the SAFE NAME 'Jolenes Lemonade')
                    if ((courseName === "Jolenes Lemonade" || courseName === "Jolene's Lemonade") && isJLCComplete) {
                         if (badgeElement.textContent !== "MISSION COMPLETE") {
                            badgeElement.textContent = "MISSION COMPLETE";
                            badgeElement.className = "bg-emerald-100 text-emerald-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide transition-all duration-500 shadow-sm border border-emerald-200";
                        }
                        continue;
                    }

                    if (completedModules.has(courseName)) {
                        // Mark as Complete
                        if (badgeElement.textContent !== "MISSION COMPLETE") {
                            badgeElement.textContent = "MISSION COMPLETE";
                            badgeElement.className = "bg-emerald-100 text-emerald-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide transition-all duration-500 shadow-sm border border-emerald-200";
                        }
                    } else if (badgeElement.textContent === "MISSION COMPLETE") {
                        // Fallback: If it was complete but database says no (e.g. reset), revert to Ready
                        // Note: startLaunchListener will bump it back to 'LAUNCHED' if applicable
                        badgeElement.textContent = "Ready";
                        badgeElement.className = "bg-sky-100 text-sky-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide";
                    }
                }

            }, (error) => {
                console.log("Status listener silent fail:", error);
            });
        }

        // Backwards compatibility alias
        window.startDecisionsStatusListener = window.startModuleStatusListener;

        window.updateUI = function(name) { 
            const els = document.querySelectorAll('.user-name-display');
            els.forEach(el => el.textContent = name);
            window.updateBadges();
        }
        
        window.updateBadges = function() { 
            // Logic for Badge Count
            let badgeCount = 1; // 1. Observer (Always unlocked)
            
            const isGuest = localStorage.getItem('aa_is_guest') === 'true';
            const name = localStorage.getItem('aa_username');
            const isGenericName = !name || name === 'Guest' || name === 'Learner';
            const isLoggedIn = !isGuest && name && !isGenericName;
            
            if (isLoggedIn) badgeCount++; // 2. Academy Agent
            
            launchCount = parseInt(localStorage.getItem('aa_launch_count') || '0');
            if (launchCount > 0) badgeCount++; // 3. Academy Operator
            
            const ddcComplete = localStorage.getItem('aa_ddc_complete') === 'true';
            if (ddcComplete) badgeCount++; // 4. Cyber Agent

            const jlcComplete = localStorage.getItem('aa_jlc_complete') === 'true';
            if (jlcComplete) badgeCount++; // 5. Certified Entrepreneur

            const identityComplete = localStorage.getItem('aa_identity_complete') === 'true';
            if (identityComplete) badgeCount++; // 6. Identity Guardian

            const defenseComplete = localStorage.getItem('aa_defense_complete') === 'true';
            if (defenseComplete) badgeCount++; // 7. Asset Defender

            // Update Header Display
            const badgeCountEl = document.getElementById('badge-count-display');
            if(badgeCountEl) badgeCountEl.textContent = `BADGES: ${badgeCount}`;
            
            // Update Modal UI (if open or pre-render)
            // Badge 2 (Agent)
            updateBadgeSlot('badge-slot-2', isLoggedIn);
            // Badge 3 (Operator)
            updateBadgeSlot('badge-slot-3', launchCount > 0);
            // Badge 4 (Cyber)
            updateBadgeSlot('badge-slot-4', ddcComplete);
            // Badge 5 (Entrepreneur - JLC)
            updateBadgeSlot('badge-slot-5', jlcComplete);
            // Badge 6 (Identity Guardian)
            updateBadgeSlot('badge-slot-6', identityComplete);
            // Badge 7 (Asset Defender)
            updateBadgeSlot('badge-slot-7', defenseComplete);

            const launchStat = document.getElementById('stat-total-launches');
            if (launchStat) launchStat.textContent = launchCount;
        }

        function updateBadgeSlot(id, unlocked) {
            const container = document.getElementById(id);
            if(!container) return;
            
            const token = container.querySelector('.badge-token');
            const icon = container.querySelector('.badge-content');
            const lock = container.querySelector('.badge-lock');
            const label = container.querySelector('span:not(.badge-content)'); // Select label, avoid emoji
            
            // Set data-unlocked attribute on the CONTAINER for click handler logic
            container.dataset.unlocked = unlocked ? "true" : "false";
            
            if(unlocked) {
                // Update Token Visuals
                if(token) token.className = "badge-token token-unlocked group-hover:scale-105";
                if(lock) lock.style.display = 'none';
                
                // Icon Colors
                if (icon && !icon.classList.contains('emoji-badge')) {
                    icon.classList.remove('text-slate-500');
                    icon.classList.add('text-allgood-primary');
                } else if (icon) {
                    icon.classList.remove('grayscale');
                }

                // Label Text Color
                if(label) label.className = "text-[10px] font-bold text-allgood-dark uppercase tracking-wide group-hover:text-allgood-primary";
                
            } else {
                // Reset to Locked
                if(token) token.className = "badge-token token-locked group-hover:scale-105";
                if(lock) lock.style.display = 'block';
                
                if (icon && !icon.classList.contains('emoji-badge')) {
                    icon.classList.remove('text-allgood-primary');
                    icon.classList.add('text-slate-500');
                } else if (icon) {
                    icon.classList.add('grayscale');
                }
                
                if(label) label.className = "text-[10px] font-bold text-slate-400 uppercase tracking-wide";
            }
        }
        
        window.showBadgeDetails = (type, element) => {
            // Update Visual Selection
            document.querySelectorAll('.badge-token').forEach(el => {
                el.classList.remove('token-selected');
            });
            if(element) {
                const token = element.querySelector('.badge-token');
                if(token) token.classList.add('token-selected');
            }

            // Data Content
            const detailsPane = document.getElementById('badge-details-pane');
            const detailsTitle = document.getElementById('badge-details-title');
            const detailsStatus = document.getElementById('badge-details-status');
            const detailsDesc = document.getElementById('badge-details-desc');
            const iconContainer = document.getElementById('detail-icon-container');
            const actionBtn = document.getElementById('btn-badge-action');
            const actionText = document.getElementById('badge-action-text');
            const subtext = document.getElementById('badge-action-subtext');
            const statusDot = document.getElementById('detail-status-indicator');
            
            // Unlocked Check
            const isUnlocked = element && element.dataset.unlocked === "true";
            // Fallback for Observer which is always true but might not have ID update logic yet
            const finalUnlocked = type === 'observer' ? true : isUnlocked;

            let title = "";
            let desc = "";
            let largeIconHtml = `<i data-lucide="help-circle" class="w-10 h-10 text-slate-400"></i>`;

            switch(type) {
                case 'observer': 
                    title = "Observer Badge";
                    desc = "Granted to all personnel observing Academy operations. No clearance required.";
                    largeIconHtml = `<i data-lucide="eye" class="w-12 h-12 text-allgood-primary"></i>`;
                    break;
                case 'agent': 
                    title = "Academy Agent";
                    desc = "Granted upon verified identity confirmation (SSO Login). Allows persistent progress tracking.";
                    largeIconHtml = `<i data-lucide="id-card" class="w-12 h-12 ${finalUnlocked ? 'text-allgood-primary' : 'text-slate-400'}"></i>`;
                    break;
                case 'operator': 
                    title = "Academy Operator";
                    desc = "Granted after successful initialization of first mission module. Demonstrates field readiness.";
                    largeIconHtml = `<i data-lucide="zap" class="w-12 h-12 ${finalUnlocked ? 'text-allgood-primary' : 'text-slate-400'}"></i>`;
                    break;
                case 'cyber': 
                    title = "Cyber Agent";
                    desc = "Awarded for demonstrating superior judgment in the Digital Decisions Challenge (Score > 80%).";
                    largeIconHtml = `<i data-lucide="shield-check" class="w-12 h-12 ${finalUnlocked ? 'text-allgood-primary' : 'text-slate-400'}"></i>`;
                    break;
                case 'entrepreneur': // NEW CASE
                    title = "Certified Entrepreneur";
                    desc = "Awarded for achieving $800+ profit in Jolene's Lemonade Challenge. Demonstrates business acumen.";
                    largeIconHtml = `<span class="text-5xl ${finalUnlocked ? '' : 'grayscale opacity-50'}">üçã</span>`;
                    break;
                case 'identity': // NEW CASE 6
                    title = "Identity Guardian";
                    desc = "Awarded for completing 'Your Digital Identity'. Signifies mastery of personal perimeter security.";
                    largeIconHtml = `<i data-lucide="fingerprint" class="w-12 h-12 ${finalUnlocked ? 'text-allgood-primary' : 'text-slate-400'}"></i>`;
                    break;
                case 'defense': // NEW CASE 7
                    title = "Asset Defender";
                    desc = "Awarded for completing 'Digital Asset Defense'. Demonstrates mastery of wallet security protocols.";
                    largeIconHtml = `<i data-lucide="shield" class="w-12 h-12 ${finalUnlocked ? 'text-allgood-primary' : 'text-slate-400'}"></i>`;
                    break;
                case 'classified': 
                    title = "Classified Asset";
                    desc = "This certification slot is reserved for future operations. Clearance unavailable at this time.";
                    break;
            }
            
            detailsTitle.textContent = title;
            detailsDesc.textContent = desc;
            iconContainer.innerHTML = largeIconHtml;
            lucide.createIcons();

            // LOGIC CHECK FOR ASSET
            const svgUrl = window.userEarnedBadges && window.userEarnedBadges[type];

            if (finalUnlocked) {
                // UNLOCKED STATE
                detailsStatus.textContent = "STATUS: VERIFIED";
                detailsStatus.className = "text-xs font-bold uppercase tracking-widest text-emerald-600";
                statusDot.className = "w-2 h-2 rounded-full bg-emerald-500 animate-pulse";
                iconContainer.className = "w-24 h-24 mx-auto mb-6 rounded-full bg-orange-50 border-4 border-orange-100 flex items-center justify-center shadow-md scale-110 transition-all duration-300";

                if (svgUrl) {
                    // ASSET AVAILABLE
                    actionBtn.disabled = false;
                    actionBtn.className = "w-full bg-allgood-secondary hover:bg-allgood-accent text-white font-bold py-4 rounded shadow-md transition-all uppercase text-xs flex items-center justify-center gap-2 transform active:scale-95";
                    actionText.textContent = "Download Badge";
                    actionBtn.onclick = () => window.viewOrDownloadBadge(type);
                    
                    subtext.style.opacity = "1";
                    subtext.textContent = "Secure asset available for retrieval.";
                } else {
                    // ASSET PENDING
                    actionBtn.disabled = true;
                    actionBtn.className = "w-full bg-slate-200 text-slate-400 font-bold py-4 rounded shadow-none transition-all uppercase text-xs flex items-center justify-center gap-2 cursor-not-allowed";
                    actionText.textContent = "Digital Asset Pending";
                    actionBtn.onclick = null;
                    
                    subtext.style.opacity = "1";
                    subtext.textContent = "No downloadable asset found.";
                }
            } else {
                // LOCKED STATE
                detailsStatus.textContent = "STATUS: LOCKED";
                detailsStatus.className = "text-xs font-bold uppercase tracking-widest text-red-500";
                statusDot.className = "w-2 h-2 rounded-full bg-red-500";
                iconContainer.className = "w-24 h-24 mx-auto mb-6 rounded-full bg-slate-100 border-4 border-slate-200 flex items-center justify-center grayscale opacity-70 transition-all duration-300";

                // Disable Button
                actionBtn.disabled = true;
                actionBtn.className = "w-full bg-slate-200 text-slate-400 font-bold py-4 rounded shadow-none transition-all uppercase text-xs flex items-center justify-center gap-2 cursor-not-allowed";
                actionText.textContent = "Asset Locked";
                actionBtn.onclick = null;
                
                subtext.style.opacity = "0";
            }
            
            sfx.click();
        }
        
        window.viewOrDownloadBadge = (type) => {
            sfx.confirm();
            
            const btn = document.getElementById('btn-badge-action');
            const originalText = document.getElementById('badge-action-text').textContent;
            // Rename variable for clarity: it might be a URL or Content
            const assetData = window.userEarnedBadges[type];
            
            if(!assetData) {
                console.error("No asset data found for", type);
                return;
            }

            btn.disabled = true;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Retrieving...`;
            lucide.createIcons();
            
            setTimeout(() => {
                // Success state
                btn.innerHTML = `<i data-lucide="check" class="w-4 h-4"></i> Asset Retrieved`;
                lucide.createIcons();
                
                // DETECT: Is this a raw SVG string or a URL?
                // Robust check: look for svg tags anywhere, incase of leading chars/quotes
                if (typeof assetData === 'string' && assetData.includes('<svg') && assetData.includes('</svg>')) {
                    
                    // Cleanup: If the string is accidentally wrapped in quotes from data entry, strip them
                    let content = assetData.trim();
                    if (content.startsWith('"') && content.endsWith('"')) {
                        content = content.slice(1, -1);
                    }

                    // It is raw code. Convert to a downloadable file blob.
                    const blob = new Blob([content], { type: 'image/svg+xml' });
                    const url = URL.createObjectURL(blob);
                    
                    // Create invisible link to force download
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `AllgoodAcademy_${type}_Badge.svg`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } else {
                    // It is a standard URL. Open normally.
                    window.open(assetData, '_blank');
                }
                
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = `<i data-lucide="download" class="w-4 h-4"></i> <span id="badge-action-text">${originalText}</span>`;
                    lucide.createIcons();
                }, 2000);
            }, 1000);
        }
        
        window.openBadgeCollection = () => {
            window.updateBadges(); // Ensure state is fresh
            const menu = document.getElementById('menu-modal');
            if (menu) {
                menu.classList.add('hidden-modal');
                menu.classList.remove('visible-modal');
            }
            const modal = document.getElementById('badge-collection-modal');
            modal.classList.remove('hidden-modal');
            modal.classList.add('visible-modal');
            
            // Auto-select first badge on open for better UX
            setTimeout(() => {
                const firstBadge = document.querySelector('.group.cursor-pointer');
                if(firstBadge) window.showBadgeDetails('observer', firstBadge);
            }, 100);
            
            sfx.click();
        }
        
        window.closeBadgeCollection = () => {
            const modal = document.getElementById('badge-collection-modal');
            modal.classList.add('hidden-modal');
            modal.classList.remove('visible-modal');
            sfx.click();
        }

        window.openAboutModal = () => {
            const menu = document.getElementById('menu-modal');
            if (menu) {
                menu.classList.add('hidden-modal');
                menu.classList.remove('visible-modal');
            }

            const modal = document.getElementById('about-modal');
            modal.classList.remove('hidden-modal');
            modal.classList.add('visible-modal');
            sfx.click();
        }

        window.closeAboutModal = () => {
            const modal = document.getElementById('about-modal');
            modal.classList.add('hidden-modal');
            modal.classList.remove('visible-modal');
            sfx.click();
        }

        function closeLoginModal() {
            const modal = document.getElementById('login-modal');
            if(modal) {
                modal.classList.add('hidden-modal');
                modal.classList.remove('visible-modal');
            }
        }
        
        function showStatusMessage(message, type = 'info') {
            const modal = document.getElementById('status-modal');
            const content = document.getElementById('status-content');
            const icon = document.getElementById('status-icon');
            const classes = {
                'info': { bg: 'bg-blue-100', text: 'text-blue-800', icon: 'info' },
                'error': { bg: 'bg-red-100', text: 'text-red-800', icon: 'alert-triangle' }
            };

            const style = classes[type] || classes['info'];
            modal.querySelector('.modal-content-base').className = `modal-content-base rounded-lg shadow-2xl p-6 max-w-sm w-full text-center border-t-4 ${style.bg} relative`;
            content.textContent = message;
            content.className = `text-sm font-body ${style.text}`;
            icon.setAttribute('data-lucide', style.icon);
            lucide.createIcons();

            modal.classList.remove('hidden-modal');
            modal.classList.add('visible-modal');
            setTimeout(() => {
                modal.classList.add('hidden-modal');
                modal.classList.remove('visible-modal');
            }, 3000);
        }
        
        window.restoreSessionState = function() {
            const storedName = localStorage.getItem('aa_username');
            const storedUID = localStorage.getItem('aa_uid');
            const dashboard = document.getElementById('page-dashboard');

            if (storedName && storedUID) {
                window.updateUI(storedName);
                if (dashboard) {
                    dashboard.classList.add('active');
                    dashboard.style.display = 'block'; 
                }
                // Show Navbar
                document.querySelector('.navbar-content').classList.remove('opacity-0');
                
                window.startLaunchListener(storedUID);
                window.startDecisionsStatusListener(storedUID); 
                return true; 
            }
            return false; 
        }

        window.initDashboard = function() { 
            window.initModuleElements();
            
            onAuthStateChanged(auth, async (user) => {
                const dashboard = document.getElementById('page-dashboard');
                if (user) {
                    if (dashboard.style.display === 'block') {
                        window.startLaunchListener(user.uid);
                        window.startDecisionsStatusListener(user.uid); 
                        return;
                    }
                    
                    const userRef = doc(db, 'artifacts', appId, 'users', user.uid);
                    const docSnap = await getDoc(userRef);

                    let displayName = user.displayName || 'Agent';
                    let isGuest = true; 

                    if (docSnap.exists()) {
                        const userData = docSnap.data();
                        displayName = userData.displayName || user.displayName || 'Agent';
                        isGuest = userData.isGuest || false;
                    }

                    localStorage.setItem('aa_username', displayName);
                    localStorage.setItem('aa_uid', user.uid);
                    localStorage.setItem('aa_is_guest', isGuest);

                    window.updateUI(displayName);
                    dashboard.classList.add('active');
                    dashboard.style.display = 'block'; 
                    
                    // Show Navbar
                    document.querySelector('.navbar-content').classList.remove('opacity-0');
                    
                    closeLoginModal(); 
                    window.startLaunchListener(user.uid);
                    window.startDecisionsStatusListener(user.uid); 
                } else {
                    if (dashboard.style.display === 'block') {
                         window.handleLogout(); 
                    }
                }
            });
        }

        // --- NEW ADMIN FUNCTIONS ---
        window.openAdminLogin = () => {
            const menu = document.getElementById('menu-modal');
            if (menu) {
                menu.classList.add('hidden-modal');
                menu.classList.remove('visible-modal');
            }
            const modal = document.getElementById('admin-login-modal');
            modal.classList.remove('hidden-modal');
            modal.classList.add('visible-modal');
            sfx.click();
            setTimeout(() => document.getElementById('admin-password-input').focus(), 100);
        };

        window.closeAdminLogin = () => {
            const modal = document.getElementById('admin-login-modal');
            modal.classList.add('hidden-modal');
            modal.classList.remove('visible-modal');
            sfx.click();
        };

        window.handleAdminAuth = async (bypass = false) => {
            sfx.click();
            const input = document.getElementById('admin-password-input');
            const val = input.value.trim();
            const btn = document.getElementById('btn-admin-submit');
            
            // Bypass Logic (Opt-out)
            if (bypass) {
                window.openAdminDashboard();
                return;
            }

            // Simple validation check for email format
            if (val.includes('@') && val.length > 5) {
                // Log email if we had a backend for it, for now just allow entry
                // Could save to Firestore 'leads' collection here if needed later
                window.openAdminDashboard();
                input.value = ""; // Clear input
            } else {
                // Error feedback
                btn.classList.add('bg-red-600');
                btn.textContent = "INVALID FORMAT";
                sfx.powerOff();
                setTimeout(() => {
                    btn.classList.remove('bg-red-600');
                    btn.textContent = "AUTHENTICATE";
                }, 1500);
            }
        };

        window.openAdminDashboard = () => {
            sfx.confirm();
            window.closeAdminLogin();
            
            // Hide standard dashboard
            document.getElementById('page-dashboard').style.display = 'none';
            
            // Show Admin Dashboard
            const adminPage = document.getElementById('page-admin');
            adminPage.style.display = 'block';
            adminPage.classList.add('active');
        };

        window.closeAdminDashboard = () => {
            sfx.nav();
            const adminPage = document.getElementById('page-admin');
            adminPage.style.display = 'none';
            adminPage.classList.remove('active');
            
            // Restore standard dashboard
            document.getElementById('page-dashboard').style.display = 'block';
        };

        const startupScreen = document.getElementById('startup-screen');
        if(startupScreen) {
            startupScreen.addEventListener('click', () => {
                if(window.sfx && window.sfx.powerOn) {
                    window.sfx.powerOn(); 
                } else if (window.initAudio) {
                    window.initAudio();
                }
                
                startupScreen.style.opacity = '0';
                
                const storedUID = localStorage.getItem('aa_uid');
                const storedName = localStorage.getItem('aa_username');
                
                if (storedName && storedUID) {
                    window.restoreSessionState();
                    window.initDashboard(); 
                } else {
                    const loginModal = document.getElementById('login-modal');
                    if (loginModal) {
                        loginModal.classList.remove('hidden-modal');
                        loginModal.classList.add('visible-modal');
                    }
                }
                
                setTimeout(() => { startupScreen.style.display = 'none'; }, 700);
            });
        }
    </script>
    
    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'allgood-primary': '#D34716',
                        'allgood-secondary': '#357889',
                        'allgood-dark': '#4C4C4C',
                        'allgood-light': '#F7F7F7',
                        'allgood-hover': '#EB8D69',
                        'allgood-accent': '#2D6473',
                    },
                    fontFamily: {
                        'heading': ['Georgia', 'serif'],
                        'body': ['Verdana', 'sans-serif'],
                    },
                },
            },
        }
    </script>

    <style>
        /* =============================================
           FIXED CHASSIS MANDATE: Industrial Design
           ============================================= 
        */
        body {
            font-family: Verdana, sans-serif;
            background-color: #1a1a1a;
            /* Industrial grid pattern - FIXED */
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
            background-attachment: fixed;
            min-height: 100vh;
            position: relative;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        h1, h2, h3, h4, h5, h6 { font-family: Georgia, serif; }

        /* Neon Glow Effects */
        .static-neon-glow {
            text-shadow: 
                0 0 5px rgba(211, 71, 22, 0.2),
                0 0 10px rgba(211, 71, 22, 0.4),
                0 0 20px rgba(211, 71, 22, 0.6);
        }

        @keyframes pulse-glow {
            0%, 100% { text-shadow: 0 0 10px rgba(211, 71, 22, 0.4); transform: scale(1); }
            50% { text-shadow: 0 0 30px rgba(211, 71, 22, 0.9), 0 0 15px rgba(211, 71, 22, 0.6); transform: scale(1.02); }
        }
        .animate-pulse-glow { animation: pulse-glow 2.5s infinite ease-in-out; will-change: transform, text-shadow; }

        @keyframes pulse-glow-badge {
            0%, 100% { box-shadow: 0 0 0px rgba(211, 71, 22, 0.0); }
            50% { box-shadow: 0 0 12px rgba(211, 71, 22, 0.7); }
        }
        .animate-pulse-glow-badge { animation: pulse-glow-badge 3s infinite ease-in-out; }

        .shadow-badge-locked { box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.5), 0 1px 1px rgba(255, 255, 255, 0.2); }
        .shadow-badge-active { box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2), 0 0 1px #FFF; }

        /* --- TABLET FRAME (FIXED CHASSIS MANDATE) --- */
        .tablet-frame {
            height: 80vh;
            width: auto;
            aspect-ratio: 16/10;
            max-width: 1100px;
            max-height: 95vh;
            min-height: 0;
            min-width: 0;
            /* Brushed Aluminum & Depth Gradients - FIXED */
            background-image: 
                radial-gradient(circle at 0% 0%, rgba(211, 71, 22, 0.35) 0%, transparent 30%),
                radial-gradient(circle at 100% 100%, rgba(211, 71, 22, 0.35) 0%, transparent 30%),
                linear-gradient(135deg, #5c5c5c 0%, #d6d6d6 25%, #8a8a8a 50%, #e0e0e0 75%, #5c5c5c 100%);
            border-radius: 12px;
            padding: 12px; 
            box-shadow: 
                inset 1px 1px 2px rgba(255,255,255, 0.6), 
                inset -1px -1px 2px rgba(0,0,0, 0.8), 
                0 30px 60px -12px rgba(0, 0, 0, 0.8), 
                0 0 0 1px #111;
            border: 1px solid #333;
            position: relative;
            margin: 20px auto;
            transition: width 0.3s, height 0.3s, padding 0.3s;
        }

        .tablet-frame::before {
            content: ''; position: absolute; top: 10px; left: 10px; right: 10px; bottom: 10px;
            border-radius: 6px; background: #111; z-index: 0;
        }

        /* --- SCREEN CONTAINER: EXECUTIVE OS INTERFACE --- */
        .screen-container {
            width: 100%; height: 100%;
            /* NEW: Executive Glass Gradient (Software Layer) */
            background-image: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            position: relative; z-index: 1; overflow: hidden;
            display: flex; flex-direction: column; 
            border-radius: 4px; box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }
        
        /* --- MISSION CARD (GLASSMORPHISM) --- */
        .mission-file {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-left-width: 4px;
            border-radius: 6px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .mission-file:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
        }

        /* Status colors */
        .status-active { border-left-color: #D34716; } /* Burnt Orange */
        .status-ready { border-left-color: #357889; } /* Deep Cyan */
        .status-locked { border-left-color: #757575; opacity: 0.7; cursor: not-allowed; }
        
        /* COMMAND RAIL TABS (UPDATED) */
        .tab-btn {
            color: #64748b; /* Text Secondary */
            border: none;
        }
        .tab-btn:hover {
            background-color: rgba(255,255,255,0.5);
            color: #357889; /* Brand Secondary */
        }
        .active-tab {
            background-color: #D34716 !important; /* Brand Primary */
            color: white !important;
            box-shadow: 0 4px 6px -1px rgba(211, 71, 22, 0.3), 0 2px 4px -1px rgba(211, 71, 22, 0.1);
            transform: translateY(-1px);
        }

        /* Custom image container for headshot */
        .headshot-container {
            width: 64px;
            height: 64px;
            overflow: hidden;
            border-radius: 6px;
            border: 1px solid rgba(0,0,0,0.1);
            flex-shrink: 0;
        }
        .headshot-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }


        @media (max-width: 640px) {
            body {
                padding: 0;
                align-items: flex-start;
                background-image: none;
                background-color: #f8fafc;
            }
            .tablet-frame {
                width: 100vw !important;
                height: 100vh !important;
                max-width: none !important;
                max-height: none !important;
                border-radius: 0 !important;
                border: none !important;
                padding: 0 !important;
                margin: 0 !important;
                box-shadow: none !important;
                background-image: none !important;
                aspect-ratio: auto !important;
            }
            .tablet-frame::before { display: none; }
            .screen-container {
                border-radius: 0 !important;
                box-shadow: none !important;
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }
            main { padding: 0 !important; }
        }

        /* --- BLUEPRINT MODE --- */
        .blueprint-mode .screen-container { background: #0f172a; color: #94a3b8; }
        .blueprint-mode .mission-file { background-color: #1e293b; border-color: #334155; opacity: 1; backdrop-filter: none; }
        .blueprint-mode h1, .blueprint-mode h2, .blueprint-mode h3, .blueprint-mode strong { color: #38bdf8 !important; }

        /* --- FOCUS MODE --- */
        .focus-mode .tablet-frame {
            position: absolute !important; top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important; 
            width: 100% !important; height: 100% !important;
            aspect-ratio: auto !important; max-width: none !important; max-height: none !important; 
            min-height: 0 !important;
            margin: 0 !important; padding: 0 !important; 
            background: #f8fafc !important; border: none !important; border-radius: 0 !important; 
            box-shadow: none !important; z-index: 99999 !important;
            background-image: none !important;
        }
        .focus-mode .tablet-frame::before { display: none; }
        .focus-mode .screen-container { border-radius: 0; box-shadow: none; height: 100%; }

        /* --- SCROLLBARS --- */
        .page::-webkit-scrollbar { width: 10px; }
        .page::-webkit-scrollbar-track { background: transparent; }
        .page::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 5px; border: 2px solid #f8fafc; }
        .page::-webkit-scrollbar-thumb:hover { background-color: #94a3b8; }

        /* --- MODALS --- */
        .modal-transition { transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out; }
        .hidden-modal { opacity: 0; pointer-events: none; transform: translateY(-10px); }
        .visible-modal { opacity: 1; pointer-events: auto; transform: translateY(0); }

        /* --- LAYOUT - HEADER (GLASS) --- */
        /* Updated Navbar for Executive Glass Look */
        .navbar-content { flex: 0 0 60px; z-index: 30; background: rgba(53, 120, 137, 0.85); backdrop-filter: blur(5px); border-bottom: 1px solid rgba(255,255,255,0.1); color: white; transition: opacity 0.3s; position: relative; }
        .footer-content { flex: 0 0 50px; z-index: 20; background: white; border-top: 1px solid #e2e8f0; }
        .page { flex: 1 1 auto; overflow-y: auto; padding: 24px; position: relative; display: none; width: 100%; background: transparent; }
        .page.active { display: block; }
        
        .modal-content-base { background: white; }
        
        .tooltip-container { position: relative; display: inline-block; }
        .tooltip-text {
            visibility: hidden; width: 250px; background-color: #4C4C4C; color: #fff;
            text-align: left; border-radius: 6px; padding: 10px; position: absolute; z-index: 10;
            bottom: 125%; left: 50%; margin-left: -125px; opacity: 0; transition: opacity 0.3s; font-size: 0.75rem;
        }
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }
        .tooltip-text::after {
            content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px;
            border-width: 5px; border-style: solid; border-color: #4C4C4C transparent transparent transparent;
        }

        /* --- BADGE MODAL GRID --- */
        .badge-grid-item {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            transition: all 0.2s;
            position: relative;
            background: #f8fafc;
        }
        .badge-grid-item:hover {
            transform: scale(1.05);
        }

        /* NEW: Emoji Badge Styling */
        .emoji-badge {
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1));
            line-height: 1;
            display: block;
        }

        /* --- NEW: BADGE TOKEN STYLES (MINTED LOOK) --- */
        .badge-token {
            aspect-ratio: 1;
            border-radius: 50%; /* Circular Token */
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 4px 6px -1px rgba(0, 0, 0, 0.1), 
                0 2px 4px -1px rgba(0, 0, 0, 0.06),
                inset 0 1px 1px rgba(255, 255, 255, 0.6); /* Rim Highlight */
        }
        
        .badge-token:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 
                0 10px 15px -3px rgba(0, 0, 0, 0.1), 
                0 4px 6px -2px rgba(0, 0, 0, 0.05),
                inset 0 1px 1px rgba(255, 255, 255, 0.6);
            z-index: 10;
        }

        /* LOCKED STATE: Industrial Zinc */
        .token-locked {
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
            border: 4px solid #cbd5e1;
        }
        .token-locked .badge-content {
            opacity: 0.4;
            filter: grayscale(100%);
        }

        /* UNLOCKED STATE: Allgood Bronze/Gold */
        .token-unlocked {
            background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%); /* Warm Orange-ish base */
            border: 4px solid #fed7aa; /* Orange-200 ring */
            box-shadow: 
                0 4px 6px rgba(211, 71, 22, 0.15),
                inset 0 2px 4px rgba(255, 255, 255, 0.9);
        }

        /* ENGRAVED ICON EFFECT */
        .badge-content {
            font-size: 1.5rem;
            filter: drop-shadow(0 1px 1px rgba(255,255,255,0.8));
        }
        
        /* SELECTION RING */
        .token-selected {
            box-shadow: 0 0 0 4px #D34716 !important; /* Allgood Primary Ring */
        }

        /* MODAL LAYOUT OVERRIDES */
        .executive-split-modal {
            max-height: 85vh;
            height: 480px; /* REDUCED HEIGHT */
            display: flex;
            flex-direction: column;
        }
        
        @media (min-width: 768px) {
            .executive-split-modal {
                flex-direction: row;
            }
            .modal-left-pane {
                width: 60%;
                border-right: 1px solid #e2e8f0;
            }
            .modal-right-pane {
                width: 40%;
            }
        }
        
        /* Utility */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 3px; }

    </style>
</head>
<body class="flex flex-col min-h-screen text-allgood-dark font-body">

    <main class="flex-grow flex items-center justify-center py-8">
        <div class="tablet-frame">
            <div class="screen-container" id="screen">

                <!-- 1. STARTUP SCREEN -->
                <div id="startup-screen" class="absolute inset-0 z-[5000] flex flex-col items-center justify-center cursor-pointer transition-opacity duration-700 ease-in-out bg-slate-900">
                    <div class="group flex flex-col items-center justify-center text-center h-full w-full relative">
                        <div class="relative">
                            <div class="absolute inset-0 bg-allgood-primary/20 blur-3xl rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                            <h2 class="text-xl md:text-2xl font-heading text-slate-400 mb-2 uppercase">WELCOME TO THE</h2>
                            <h1 class="text-4xl md:text-6xl font-heading font-bold text-allgood-primary tracking-tighter relative z-10 drop-shadow-md static-neon-glow uppercase">ALLGOOD<span class="text-white">ACADEMY</span></h1>
                        </div>
                        <p id="startup-message" class="mt-8 text-slate-500 text-xs tracking-[0.3em] uppercase font-medium group-hover:text-white transition-colors animate-pulse font-body">CLICK TO POWER UP</p>
                    </div>
                </div>

                <!-- 2. LOGIN MODAL -->
                <div id="login-modal" class="absolute inset-0 z-[4000] bg-allgood-dark/95 flex items-center justify-center p-6 hidden-modal modal-transition backdrop-blur-sm">
                    <div class="bg-white rounded-lg shadow-2xl p-8 max-w-sm w-full text-center border-t-4 border-allgood-primary">
                        <div class="mb-6"><h2 class="text-3xl font-heading font-bold text-allgood-dark">Allgood<span class="text-allgood-primary">Academy</span></h2></div>
                        <h2 class="text-xl font-bold text-allgood-dark mb-2 font-heading">Welcome</h2>
                        
                        <div class="flex items-center justify-center gap-2 mb-6 relative">
                            <p class="text-gray-500 text-sm font-body">Please sign in to start.</p>
                            <button id="policy-trigger" class="group relative flex items-center text-allgood-primary hover:text-allgood-hover transition-colors focus:outline-none">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                                <span class="text-xs font-bold underline decoration-dotted underline-offset-2">Why?</span>
                                
                                <div class="absolute top-full left-1/2 transform -translate-x-1/2 mt-3 w-64 p-3 bg-gray-800 text-white text-xs text-left rounded shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible group-focus:opacity-100 group-focus:visible transition-all duration-200 z-50 font-body leading-relaxed border border-gray-700 pointer-events-none">
                                    <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-b-gray-800"></div>
                                    <strong class="block text-allgood-primary mb-1 uppercase tracking-wide text-[10px]">Why do we ask?</strong>
                                    <p class="mb-2 text-gray-300">We use your name to personalize your badge. Performance data is logged in real-time to improve the GoodBlock experience. All personal data is kept confidential and never sold.</p>
                                    <div class="border-t border-gray-700 my-1 pt-1"></div>
                                    <p class="text-gray-300"><strong>Email (Optional):</strong> Enter to join the Allgood Academy community.</p>
                                </div>
                            </button>
                        </div>

                        <input type="text" id="user-name-input" placeholder="Your Name (Optional)" class="w-full border border-gray-300 rounded p-3 mb-3 focus:ring-2 focus:ring-allgood-primary focus:border-transparent outline-none transition-all font-body">
                        <input type="email" id="user-email-input" placeholder="Your Email (Optional)" class="w-full border border-gray-300 rounded p-3 mb-6 focus:ring-2 focus:ring-allgood-primary focus:border-transparent outline-none transition-all font-body">
                        
                        <button id="btn-guest-login" onclick="window.handleGuestLogin()" class="w-full bg-allgood-primary hover:bg-allgood-hover text-white font-bold py-3 rounded shadow-md transition-transform transform hover:scale-[1.02] active:scale-[0.98] font-body uppercase">
                            Enter Dashboard
                        </button>

                        <div class="mt-4 flex items-center justify-center space-x-2">
                             <div class="h-px w-10 bg-gray-200"></div>
                             <p class="text-xs text-gray-500 uppercase font-bold">OR</p>
                             <div class="h-px w-10 bg-gray-200"></div>
                        </div>

                        <button id="google-icon-container" onclick="window.handleGoogleLogin()" 
                                class="mt-4 p-2 rounded-full border border-gray-300 shadow-md hover:shadow-lg transition-all duration-200 hover:scale-105 active:scale-95 bg-white flex items-center justify-center mx-auto">
                            <svg class="w-6 h-6" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                                <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                                <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                                <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- 2.5 STATUS MODAL -->
                <div id="status-modal" class="hidden-modal absolute top-16 right-4 z-[500] flex items-center justify-center p-4 modal-transition pointer-events-none">
                    <div class="bg-white rounded-lg shadow-xl p-4 max-w-xs w-full text-left border-l-4 border-blue-500 flex items-center space-x-3 modal-content-base">
                        <i id="status-icon" data-lucide="info" class="w-5 h-5 text-blue-500 flex-shrink-0"></i>
                        <p id="status-content" class="text-sm font-body text-blue-800"></p>
                    </div>
                </div>

                <!-- 2.7 ADMIN LOGIN MODAL (NEW - PROFESSIONAL) -->
                <div id="admin-login-modal" class="hidden-modal absolute inset-0 z-[260] bg-slate-900/50 flex items-center justify-center p-6 modal-transition backdrop-blur-sm" onclick="window.closeAdminLogin()">
                    <div class="bg-white rounded-lg shadow-2xl p-8 max-w-sm w-full text-center border-t-4 border-allgood-secondary relative" onclick="event.stopPropagation()">
                        <button onclick="window.closeAdminLogin()" class="absolute top-2 right-2 text-gray-400 hover:text-red-500 transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>

                        <div class="mb-6 mt-2">
                            <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                <i data-lucide="lock" class="w-6 h-6 text-allgood-secondary"></i>
                            </div>
                            <h2 class="text-xl font-heading font-bold text-allgood-dark">Administrator Access</h2>
                            <p class="text-xs text-gray-500 mt-1">Please verify your credentials.</p>
                        </div>
                        
                        <div class="text-left mb-4">
                            <label class="block text-xs font-bold text-gray-600 mb-2 uppercase tracking-wide">Admin Password</label>
                            <input type="password" id="admin-password-input" class="w-full border border-gray-300 rounded p-3 text-gray-800 focus:ring-2 focus:ring-allgood-secondary focus:border-transparent outline-none transition-all font-body" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        </div>
                        
                        <button id="btn-admin-submit" onclick="window.handleAdminAuth()" class="w-full bg-allgood-secondary hover:bg-allgood-accent text-white font-bold py-3 rounded shadow-md transition-all font-body uppercase tracking-wide mb-3">
                            Sign In
                        </button>
                        
                        <button onclick="window.handleAdminAuth(true)" class="text-xs text-gray-400 hover:text-allgood-primary underline underline-offset-4 decoration-dotted font-body">
                            Enter Preview Mode (Guest)
                        </button>
                    </div>
                </div>

                <!-- 3. TOP NAVBAR (GLASS) -->
                <header class="navbar-content flex items-center justify-between px-6 shadow-md relative z-30 opacity-0">
                    <div class="flex items-center overflow-hidden">
                        <div class="flex-shrink-0 text-white font-heading font-bold text-lg tracking-tight truncate mr-4 select-none uppercase">
                            ALLGOOD ACADEMY <span class="opacity-60 text-sm font-normal">| DASHBOARD</span>
                        </div>
                    </div>
                    <!-- Control Cluster -->
                    <div class="flex items-center space-x-1 shrink-0 relative">
                        <button id="btn-home" class="text-gray-200 hover:text-white transition-colors p-2 rounded-full hover:bg-white/10" title="Home (Hold to Reset)">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
                        </button>
                        <div class="h-6 w-px bg-white/20 mx-1"></div>
                        <button id="btn-blueprint" class="text-gray-200 hover:text-cyan-300 transition-colors p-2 rounded-full hover:bg-white/10" title="Blueprint Mode">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                        </button>
                        <!-- ADDED: hidden on mobile, visible on small screens and up (sm:block) -->
                        <button id="btn-fullscreen" class="hidden sm:block text-gray-200 hover:text-green-300 transition-colors p-2 rounded-full hover:bg-white/10" title="Focus Mode">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" /></svg>
                        </button>
                        <button id="btn-message" class="text-gray-200 hover:text-allgood-primary transition-colors p-2 rounded-full hover:bg-white/10" title="Direct Message HQ" onclick="window.openMessageModal()">
                            <i data-lucide="message-square" class="w-5 h-5"></i>
                        </button>
                        <button id="btn-menu" class="text-gray-200 hover:text-white transition-colors p-2 rounded-full hover:bg-white/10" title="Menu">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                        </button>
                    </div>
                </header>

                <!-- Sidebar Menu -->
                <div id="menu-modal" class="hidden-modal absolute inset-0 z-[100] bg-slate-900/50 flex justify-end modal-transition backdrop-blur-sm">
                    <div class="w-64 h-full bg-white shadow-2xl flex flex-col border-l border-slate-200">
                        <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                            <span class="font-bold text-slate-700 font-heading uppercase">System Menu</span>
                            <button id="close-menu" class="text-slate-400 hover:text-red-500 transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
                        </div>
                        <div class="p-3 space-y-1">
                            <button class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-100 text-slate-600 font-bold flex items-center transition-colors uppercase" onclick="showStatusMessage('Dashboard Active', 'info')">
                                <i data-lucide="layout-grid" class="w-4 h-4 mr-3 text-allgood-primary"></i>Dashboard
                            </button>
                            <!-- UPDATED: Connected to new Profile Modal -->
                            <button class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-100 text-slate-600 font-bold flex items-center transition-colors uppercase" onclick="window.openProfileModal()">
                                <i data-lucide="user" class="w-4 h-4 mr-3 text-allgood-secondary"></i>My Profile
                            </button>
                            <!-- ADMIN ENTRY -->
                            <button class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-100 text-slate-600 font-bold flex items-center transition-colors uppercase" onclick="window.openAdminLogin()">
                                <i data-lucide="lock" class="w-4 h-4 mr-3 text-allgood-secondary"></i>Admin Console
                            </button>
                            <button class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-100 text-slate-600 font-bold flex items-center transition-colors uppercase" onclick="window.openAboutModal()">
                                <i data-lucide="info" class="w-4 h-4 mr-3 text-slate-500"></i>About Us
                            </button>
                            <div class="border-t border-slate-100 my-2"></div>
                             <button class="w-full text-left px-4 py-3 rounded-lg hover:bg-red-50 text-red-600 font-bold flex items-center transition-colors uppercase" onclick="window.handleLogout()">
                                <i data-lucide="log-out" class="w-4 h-4 mr-3"></i>Log Out
                            </button>
                        </div>
                        <div class="mt-auto p-4 bg-slate-50 border-t border-slate-200 text-center">
                            <p class="text-xs text-slate-500 font-body">Allgood Academy &copy; 2025</p>
                        </div>
                    </div>
                </div>

                <!-- 4. DASHBOARD CONTENT -->
                <div class="page" id="page-dashboard">
                    
                    <!-- Status Bar (Refactored for Mobile Stacking) -->
                    <div class="flex flex-col md:flex-row items-center justify-between bg-white/60 backdrop-blur-md p-4 rounded-lg shadow-sm border border-white/50 mb-6 text-allgood-dark text-center md:text-left">
                        <div class="mb-4 md:mb-0 w-full md:w-auto">
                            <h1 class="text-xl font-heading font-bold text-slate-700 uppercase">Welcome, <span class="user-name-display text-allgood-primary">Agent</span>.</h1>
                            <!-- BADGE COLLECTION BUTTON -->
                            <div class="mt-2 flex items-center justify-center md:justify-start">
                                <button onclick="window.openBadgeCollection()" class="bg-white border border-gray-300 rounded-full px-4 py-1.5 text-xs font-bold text-slate-600 shadow-sm hover:shadow-md hover:text-allgood-primary transition-all flex items-center gap-2 group">
                                    <i data-lucide="layout-grid" class="w-3 h-3 group-hover:scale-110 transition-transform"></i>
                                    <span id="badge-count-display">BADGES: 1</span>
                                    <span class="text-[10px] uppercase text-gray-400 font-normal">| VIEW COLLECTION</span>
                                </button>
                            </div>
                        </div>
                        <div class="flex gap-6 md:gap-4 text-center md:text-right w-full md:w-auto justify-center md:justify-end">
                            <div>
                                <span class="block text-2xl font-bold text-allgood-secondary leading-none">12</span>
                                <span class="text-[10px] uppercase text-slate-400 font-bold">MODULES</span>
                            </div>
                            <div>
                                <span class="block text-2xl font-bold text-emerald-600 leading-none" id="stat-total-launches">0</span>
                                <span class="text-[10px] uppercase text-slate-400 font-bold">LAUNCHED</span>
                            </div>
                        </div>
                    </div>

                    <!-- TAB NAVIGATION: COMMAND RAIL (Mobile Optimized) -->
                    <div class="bg-white/40 backdrop-blur-md p-1.5 rounded-xl border border-white/60 shadow-sm flex space-x-2 mb-6 mx-auto max-w-3xl">
                        <button id="tab-btn-goodblocks" onclick="switchTab('goodblocks')" 
                            class="tab-btn active-tab flex-1 flex items-center justify-center px-4 py-3 rounded-lg text-xs sm:text-sm font-bold tracking-wide uppercase transition-all duration-300 ease-out">
                            <i data-lucide="box" class="w-5 h-5 sm:w-4 sm:h-4 sm:mr-2"></i> 
                            <span class="hidden sm:inline">GoodBlocks</span>
                        </button>
                        <button id="tab-btn-games" onclick="switchTab('games')" 
                            class="tab-btn inactive-tab flex-1 flex items-center justify-center px-4 py-3 rounded-lg text-xs sm:text-sm font-bold tracking-wide uppercase transition-all duration-300 ease-out">
                            <i data-lucide="gamepad-2" class="w-5 h-5 sm:w-4 sm:h-4 sm:mr-2"></i> 
                            <span class="hidden sm:inline">Games & Sims</span>
                        </button>
                        <button id="tab-btn-courses" onclick="switchTab('courses')" 
                            class="tab-btn inactive-tab flex-1 flex items-center justify-center px-4 py-3 rounded-lg text-xs sm:text-sm font-bold tracking-wide uppercase transition-all duration-300 ease-out">
                            <i data-lucide="graduation-cap" class="w-5 h-5 sm:w-4 sm:h-4 sm:mr-2"></i> 
                            <span class="hidden sm:inline">Jodi's Schoolhouse</span>
                        </button>
                    </div>

                    <!-- TAB 1: GOODBLOCKS -->
                    <div id="tab-goodblocks" class="tab-content grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div onclick="window.launchCourse('Airport Navigator', 'https://www.allgoodacademy.com/goodblocks/airport-navigator', this)" 
                             class="mission-file status-ready p-5 flex items-start gap-4 group">
                            <!-- CHANGED: Rounded-full, shadow-sm, Emoji -->
                            <div class="w-16 h-16 bg-sky-50 rounded-full flex items-center justify-center border border-sky-100 flex-shrink-0 group-hover:bg-sky-100 transition-colors shadow-sm">
                                <span class="text-3xl emoji-badge">üõ´</span>
                            </div>
                            <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-slate-800 text-lg mb-1 uppercase">Airport Navigator</h3>
                                    <span class="bg-sky-100 text-sky-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide">Ready</span>
                                </div>
                                <p class="text-xs text-slate-500 mb-3 leading-relaxed"><strong>Action:</strong> Master the logistical flow from curb to gate with zero friction.</p>
                            </div>
                        </div>
                        
                        <!-- UPDATED CARD: JONATHAN HURTADO'S COUNTDOWN TO KEYS -->
                        <div class="mission-file status-locked p-5 flex items-start gap-4 group opacity-70">
                            <div class="headshot-container flex-shrink-0 bg-slate-100">
                                <!-- Headshot Image Replacement -->
                                <img src="https://github.com/allgoodacademy/ImageAndAssets/blob/main/J.Hurtado_HeadShot.jpg?raw=true" 
                                     alt="Jonathan Hurtado's Headshot"
                                     onerror="this.onerror=null; this.src='https://placehold.co/64x64/334155/f8fafc?text=JH'" 
                                     class="rounded object-cover w-full h-full">
                            </div>
                            <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-slate-500 text-lg mb-1 uppercase">Jonathan Hurtado's Countdown to Keys</h3>
                                    <span class="bg-slate-200 text-slate-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide">Coming Soon</span>
                                </div>
                                <p class="text-xs text-slate-500 mb-3 leading-relaxed"><strong>Action:</strong> Execute the 100-day protocol to secure your first home.</p>
                            </div>
                        </div>
                        <!-- END UPDATED CARD -->

                        <div onclick="window.launchCourse('Digital Asset Defense', 'https://www.allgoodacademy.com/goodblocks/digital-asset-defense', this)" 
                             class="mission-file status-ready p-5 flex items-start gap-4 group">
                             <!-- CHANGED: Rounded-full, shadow-sm, Emoji -->
                            <div class="w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center border border-blue-100 flex-shrink-0 group-hover:bg-blue-100 transition-colors shadow-sm">
                                <span class="text-3xl emoji-badge">üõ°Ô∏è</span>
                            </div>
                            <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-slate-800 text-lg mb-1 uppercase">Digital Asset Defense</h3>
                                    <span class="bg-blue-100 text-blue-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide">Ready</span>
                                </div>
                                <p class="text-xs text-slate-500 mb-3 leading-relaxed"><strong>Action:</strong> Secure wealth via wallet protocols and threat avoidance.</p>
                            </div>
                        </div>

                        <!-- MOVED: The AI Co-Pilot (Kept Robot Emoji) -->
                        <div onclick="window.launchCourse('The AI Co-Pilot', 'https://www.allgoodacademy.com/goodblocks/aico-pilot', this)" 
                             class="mission-file status-ready p-5 flex items-start gap-4 group">
                            <div class="w-16 h-16 bg-cyan-50 rounded-full flex items-center justify-center border border-cyan-100 flex-shrink-0 group-hover:bg-cyan-100 transition-colors shadow-sm">
                                <span class="text-3xl emoji-badge">ü§ñ</span>
                            </div>
                            <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-slate-800 text-lg mb-1 uppercase">The AI Co-Pilot</h3>
                                    <span class="bg-cyan-100 text-cyan-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide">Ready</span>
                                </div>
                                <p class="text-xs text-slate-500 mb-3 leading-relaxed"><strong>Action:</strong> Integrate AI into your workflow in 15 minutes.</p>
                            </div>
                        </div>

                        <div onclick="window.launchCourse('Your Digital Identity', 'https://www.allgoodacademy.com/goodblocks/your-digital-identity', this)" 
                             class="mission-file status-ready p-5 flex items-start gap-4 group">
                             <!-- CHANGED: Rounded-full, shadow-sm, Emoji -->
                            <div class="w-16 h-16 bg-purple-50 rounded-full flex items-center justify-center border border-purple-100 flex-shrink-0 group-hover:bg-purple-100 transition-colors shadow-sm">
                                <span class="text-3xl emoji-badge">üß¨</span>
                            </div>
                            <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-slate-800 text-lg mb-1 uppercase">Your Digital Identity</h3>
                                    <span class="bg-purple-100 text-purple-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide">Ready</span>
                                </div>
                                <p class="text-xs text-slate-500 mb-3 leading-relaxed"><strong>Action:</strong> Audit your online footprint and secure your personal perimeter.</p>
                            </div>
                        </div>
                    </div>

                    <!-- TAB 2: GAMES & SIMS -->
                    <div id="tab-games" class="tab-content grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
                        <!-- UPDATED ONCLICK URL AND ID (REMOVED APOSTROPHE FOR SAFE PARSING) -->
                        <div onclick="window.launchCourse('Jolenes Lemonade', 'https://www.allgoodacademy.com/educational-games/jolenes-lemonade-challenge', this)" 
                             class="mission-file status-ready p-5 flex items-start gap-4 group">
                             <!-- CHANGED: Rounded-full, shadow-sm, Emoji -->
                            <div class="w-16 h-16 bg-yellow-50 rounded-full flex items-center justify-center border border-yellow-100 flex-shrink-0 group-hover:bg-yellow-100 transition-colors shadow-sm">
                                <span class="text-3xl emoji-badge">üçã</span>
                            </div>
                            <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-slate-800 text-lg mb-1 uppercase">Jolene's Lemonade</h3>
                                    <span class="bg-yellow-100 text-yellow-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide">Ready</span>
                                </div>
                                <p class="text-xs text-slate-500 mb-3 leading-relaxed"><strong>Action:</strong> Manage supply, demand, and profit margins in a live market.</p>
                            </div>
                        </div>
                        <div onclick="window.launchCourse('Digital Decisions', 'https://www.allgoodacademy.com/educational-games/digital-decisions', this)" 
                             class="mission-file status-active p-5 flex items-start gap-4 group">
                             <!-- CHANGED: Rounded-full, shadow-sm, Emoji -->
                            <div class="w-16 h-16 bg-indigo-50 rounded-full flex items-center justify-center border border-indigo-100 flex-shrink-0 group-hover:bg-indigo-100 transition-colors shadow-sm">
                                <span class="text-3xl emoji-badge">‚öñÔ∏è</span>
                            </div>
                            <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-slate-800 text-lg mb-1 uppercase">Digital Decisions</h3>
                                    <span id="ddc-status-badge" class="bg-indigo-100 text-indigo-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide">Active</span>
                                </div>
                                <p class="text-xs text-slate-500 mb-3 leading-relaxed"><strong>Action:</strong> Make high-stakes choices in simulated online conflict scenarios.</p>
                            </div>
                        </div>
                        <div onclick="window.launchCourse('Conflict Resolution', 'https://www.allgoodacademy.com/educational-games/conflict-resolution-challenge', this)" 
                             class="mission-file status-ready p-5 flex items-start gap-4 group">
                             <!-- CHANGED: Rounded-full, shadow-sm, Emoji -->
                            <div class="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center border border-red-100 flex-shrink-0 group-hover:bg-red-100 transition-colors shadow-sm">
                                <span class="text-3xl emoji-badge">üå§Ô∏è</span>
                            </div>
                            <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-slate-800 text-lg mb-1 uppercase">Conflict Resolution</h3>
                                    <span class="bg-red-100 text-red-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide">Ready</span>
                                </div>
                                <p class="text-xs text-slate-500 mb-3 leading-relaxed"><strong>Action:</strong> Identify triggers and neutralize tension in high-stress interactions.</p>
                            </div>
                        </div>
                        <div onclick="window.launchCourse('Purposeful Communicator', 'https://www.allgoodacademy.com/educational-games/purposeful-communicator-challenge', this)" 
                             class="mission-file status-ready p-5 flex items-start gap-4 group">
                             <!-- CHANGED: Rounded-full, shadow-sm, Emoji -->
                            <div class="w-16 h-16 bg-teal-50 rounded-full flex items-center justify-center border border-teal-100 flex-shrink-0 group-hover:bg-teal-100 transition-colors shadow-sm">
                                <span class="text-3xl emoji-badge">üéôÔ∏è</span>
                            </div>
                            <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-slate-800 text-lg mb-1 uppercase">Purposeful Communicator</h3>
                                    <span class="bg-teal-100 text-teal-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide">Ready</span>
                                </div>
                                <p class="text-xs text-slate-500 mb-3 leading-relaxed"><strong>Action:</strong> Select precise language to drive outcomes and build consensus.</p>
                            </div>
                        </div>
                        <div onclick="window.launchCourse('Master Your Story', 'https://www.allgoodacademy.com/educational-games/master-your-story-challenge', this)" 
                             class="mission-file status-ready p-5 flex items-start gap-4 group">
                             <!-- CHANGED: Rounded-full, shadow-sm, Emoji -->
                            <div class="w-16 h-16 bg-rose-50 rounded-full flex items-center justify-center border border-rose-100 flex-shrink-0 group-hover:bg-rose-100 transition-colors shadow-sm">
                                <span class="text-3xl emoji-badge">üìñ</span>
                            </div>
                            <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-slate-800 text-lg mb-1 uppercase">Master Your Story</h3>
                                    <span class="bg-rose-100 text-rose-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide">Ready</span>
                                </div>
                                <p class="text-xs text-slate-500 mb-3 leading-relaxed"><strong>Action:</strong> Craft and deliver a compelling personal narrative for business and life.</p>
                            </div>
                        </div>
                    </div>

                    <!-- TAB 3: SCHOOLHOUSE (FORMERLY COURSES) -->
                    <div id="tab-courses" class="tab-content grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
                         <!-- Placeholder 1 -->
                        <div class="mission-file status-locked p-5 flex items-start gap-4 group opacity-70">
                            <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center border border-slate-200 flex-shrink-0">
                                <span class="text-3xl grayscale opacity-50">üõ†Ô∏è</span>
                            </div>
                            <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-slate-500 text-lg mb-1 uppercase">Pragmatic Learning</h3>
                                    <span class="bg-slate-200 text-slate-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide">Coming Soon</span>
                                </div>
                                <p class="text-xs text-slate-500 mb-3 leading-relaxed"><strong>Status:</strong> Curriculum currently under development for the new schoolhouse architecture.</p>
                            </div>
                        </div>

                        <!-- Placeholder 2 -->
                        <div class="mission-file status-locked p-5 flex items-start gap-4 group opacity-70">
                             <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center border border-slate-200 flex-shrink-0">
                                <span class="text-3xl grayscale opacity-50">üß≠</span>
                            </div>
                            <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-slate-500 text-lg mb-1 uppercase">The Unwritten Rules</h3>
                                    <span class="bg-slate-200 text-slate-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide">Coming Soon</span>
                                </div>
                                <p class="text-xs text-slate-500 mb-3 leading-relaxed"><strong>Status:</strong> Curriculum currently under development for the new schoolhouse architecture.</p>
                            </div>
                        </div>
                    </div>

                    <div class="mt-12 mb-6 text-center">
                        <p class="text-[10px] text-slate-400 font-mono tracking-widest uppercase opacity-80">
                            ALLGOOD OS <span class="mx-2">‚Ä¢</span> GOODBLOCK‚Ñ¢
                        </p>
                    </div>

                <!-- BADGE COLLECTION MODAL (UPDATED - OPTION 1 EXECUTIVE SPLIT) -->
                <div id="badge-collection-modal" class="hidden-modal absolute inset-0 z-[250] bg-allgood-dark/80 flex items-center justify-center p-4 modal-transition backdrop-blur-sm" onclick="closeBadgeCollection()">
                    
                    <!-- Main Container -->
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl executive-split-modal overflow-hidden border-t-4 border-allgood-primary relative" onclick="event.stopPropagation()">
                        
                        <!-- CLOSE BUTTON (Absolute) -->
                        <button onclick="closeBadgeCollection()" class="absolute top-4 right-4 z-50 text-gray-400 hover:text-red-500 bg-white/50 rounded-full p-1 transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>

                        <!-- LEFT PANE: THE VAULT (Grid) -->
                        <div class="modal-left-pane bg-slate-50 flex flex-col h-3/5 md:h-full overflow-hidden">
                            <div class="p-6 border-b border-gray-200 bg-white sticky top-0 z-10">
                                <h3 class="text-xl font-heading font-bold text-allgood-dark uppercase tracking-tight">Badge Dossier</h3>
                                <p class="text-[10px] text-gray-400 uppercase tracking-widest font-bold mt-1">Select an asset to inspect</p>
                            </div>
                            
                            <div class="p-6 overflow-y-auto custom-scrollbar">
                                <div class="grid grid-cols-3 sm:grid-cols-4 gap-6">
                                    <!-- 1. Observer Badge -->
                                    <div class="flex flex-col items-center gap-2 group cursor-pointer" onclick="showBadgeDetails('observer', this)">
                                        <div class="badge-token token-unlocked group-hover:scale-105" data-unlocked="true">
                                            <i data-lucide="eye" class="badge-content w-8 h-8 text-allgood-primary"></i>
                                        </div>
                                        <span class="text-[10px] font-bold text-slate-500 uppercase tracking-wide group-hover:text-allgood-primary">Observer</span>
                                    </div>
                                    
                                    <!-- 2. Academy Agent -->
                                    <div id="badge-slot-2" class="flex flex-col items-center gap-2 group cursor-pointer" onclick="showBadgeDetails('agent', this)">
                                        <div class="badge-token token-locked group-hover:scale-105">
                                            <i data-lucide="id-card" class="badge-content w-8 h-8 text-slate-500"></i>
                                            <div class="badge-lock absolute -top-1 -right-1 bg-slate-400 text-white rounded-full p-1"><i data-lucide="lock" class="w-3 h-3"></i></div>
                                        </div>
                                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wide">Agent</span>
                                    </div>

                                    <!-- 3. Academy Operator -->
                                    <div id="badge-slot-3" class="flex flex-col items-center gap-2 group cursor-pointer" onclick="showBadgeDetails('operator', this)">
                                        <div class="badge-token token-locked group-hover:scale-105">
                                            <i data-lucide="zap" class="badge-content w-8 h-8 text-slate-500"></i>
                                            <div class="badge-lock absolute -top-1 -right-1 bg-slate-400 text-white rounded-full p-1"><i data-lucide="lock" class="w-3 h-3"></i></div>
                                        </div>
                                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wide">Operator</span>
                                    </div>

                                    <!-- 4. Cyber Agent -->
                                    <div id="badge-slot-4" class="flex flex-col items-center gap-2 group cursor-pointer" onclick="showBadgeDetails('cyber', this)">
                                        <div class="badge-token token-locked group-hover:scale-105">
                                            <i data-lucide="shield-check" class="badge-content w-8 h-8 text-slate-500"></i>
                                            <div class="badge-lock absolute -top-1 -right-1 bg-slate-400 text-white rounded-full p-1"><i data-lucide="lock" class="w-3 h-3"></i></div>
                                        </div>
                                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wide">Cyber</span>
                                    </div>

                                    <!-- 5. Certified Entrepreneur -->
                                    <div id="badge-slot-5" class="flex flex-col items-center gap-2 group cursor-pointer" onclick="showBadgeDetails('entrepreneur', this)">
                                        <div class="badge-token token-locked group-hover:scale-105">
                                            <span class="text-2xl badge-content">üçã</span>
                                            <div class="badge-lock absolute -top-1 -right-1 bg-slate-400 text-white rounded-full p-1"><i data-lucide="lock" class="w-3 h-3"></i></div>
                                        </div>
                                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wide">Founder</span>
                                    </div>

                                    <!-- 6. Identity Guardian -->
                                    <div id="badge-slot-6" class="flex flex-col items-center gap-2 group cursor-pointer" onclick="showBadgeDetails('identity', this)">
                                        <div class="badge-token token-locked group-hover:scale-105">
                                            <i data-lucide="fingerprint" class="badge-content w-8 h-8 text-slate-500"></i>
                                            <div class="badge-lock absolute -top-1 -right-1 bg-slate-400 text-white rounded-full p-1"><i data-lucide="lock" class="w-3 h-3"></i></div>
                                        </div>
                                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wide">Guardian</span>
                                    </div>

                                    <!-- 7. Asset Defender (NEW) -->
                                    <div id="badge-slot-7" class="flex flex-col items-center gap-2 group cursor-pointer" onclick="showBadgeDetails('defense', this)">
                                        <div class="badge-token token-locked group-hover:scale-105">
                                            <i data-lucide="shield" class="badge-content w-8 h-8 text-slate-500"></i>
                                            <div class="badge-lock absolute -top-1 -right-1 bg-slate-400 text-white rounded-full p-1"><i data-lucide="lock" class="w-3 h-3"></i></div>
                                        </div>
                                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wide">Defender</span>
                                    </div>

                                    <!-- EXPANDED CAPACITY: 9 CLASSIFIED SLOTS (Completes 4x4 Grid) -->
                                    <div class="flex flex-col items-center gap-2 group cursor-pointer opacity-50 hover:opacity-80 transition-opacity" onclick="showBadgeDetails('classified', this)">
                                        <div class="badge-token token-locked border-dashed border-slate-300">
                                            <i data-lucide="lock" class="badge-content w-6 h-6 text-slate-300"></i>
                                        </div>
                                        <span class="text-[10px] font-bold text-slate-300 uppercase tracking-wide">Classified</span>
                                    </div>
                                    
                                    <div class="flex flex-col items-center gap-2 group cursor-pointer opacity-50 hover:opacity-80 transition-opacity" onclick="showBadgeDetails('classified', this)">
                                        <div class="badge-token token-locked border-dashed border-slate-300">
                                            <i data-lucide="lock" class="badge-content w-6 h-6 text-slate-300"></i>
                                        </div>
                                        <span class="text-[10px] font-bold text-slate-300 uppercase tracking-wide">Classified</span>
                                    </div>

                                    <div class="flex flex-col items-center gap-2 group cursor-pointer opacity-50 hover:opacity-80 transition-opacity" onclick="showBadgeDetails('classified', this)">
                                        <div class="badge-token token-locked border-dashed border-slate-300">
                                            <i data-lucide="lock" class="badge-content w-6 h-6 text-slate-300"></i>
                                        </div>
                                        <span class="text-[10px] font-bold text-slate-300 uppercase tracking-wide">Classified</span>
                                    </div>

                                    <div class="flex flex-col items-center gap-2 group cursor-pointer opacity-50 hover:opacity-80 transition-opacity" onclick="showBadgeDetails('classified', this)">
                                        <div class="badge-token token-locked border-dashed border-slate-300">
                                            <i data-lucide="lock" class="badge-content w-6 h-6 text-slate-300"></i>
                                        </div>
                                        <span class="text-[10px] font-bold text-slate-300 uppercase tracking-wide">Classified</span>
                                    </div>

                                    <div class="flex flex-col items-center gap-2 group cursor-pointer opacity-50 hover:opacity-80 transition-opacity" onclick="showBadgeDetails('classified', this)">
                                        <div class="badge-token token-locked border-dashed border-slate-300">
                                            <i data-lucide="lock" class="badge-content w-6 h-6 text-slate-300"></i>
                                        </div>
                                        <span class="text-[10px] font-bold text-slate-300 uppercase tracking-wide">Classified</span>
                                    </div>

                                    <div class="flex flex-col items-center gap-2 group cursor-pointer opacity-50 hover:opacity-80 transition-opacity" onclick="showBadgeDetails('classified', this)">
                                        <div class="badge-token token-locked border-dashed border-slate-300">
                                            <i data-lucide="lock" class="badge-content w-6 h-6 text-slate-300"></i>
                                        </div>
                                        <span class="text-[10px] font-bold text-slate-300 uppercase tracking-wide">Classified</span>
                                    </div>

                                    <div class="flex flex-col items-center gap-2 group cursor-pointer opacity-50 hover:opacity-80 transition-opacity" onclick="showBadgeDetails('classified', this)">
                                        <div class="badge-token token-locked border-dashed border-slate-300">
                                            <i data-lucide="lock" class="badge-content w-6 h-6 text-slate-300"></i>
                                        </div>
                                        <span class="text-[10px] font-bold text-slate-300 uppercase tracking-wide">Classified</span>
                                    </div>
                                    
                                    <div class="flex flex-col items-center gap-2 group cursor-pointer opacity-50 hover:opacity-80 transition-opacity" onclick="showBadgeDetails('classified', this)">
                                        <div class="badge-token token-locked border-dashed border-slate-300">
                                            <i data-lucide="lock" class="badge-content w-6 h-6 text-slate-300"></i>
                                        </div>
                                        <span class="text-[10px] font-bold text-slate-300 uppercase tracking-wide">Classified</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- RIGHT PANE: INSPECTOR (Sticky Details) -->
                        <div class="modal-right-pane bg-white flex flex-col h-2/5 md:h-full relative z-20 shadow-[0_-4px_10px_rgba(0,0,0,0.1)] md:shadow-none">
                            <div class="flex-grow flex flex-col justify-center p-8 text-center" id="badge-details-pane">
                                
                                <!-- Dynamic Icon Display (Large) -->
                                <div id="detail-icon-container" class="w-24 h-24 mx-auto mb-6 rounded-full bg-slate-50 border-4 border-slate-100 flex items-center justify-center shadow-inner transition-all duration-300">
                                    <i data-lucide="scan-line" class="w-10 h-10 text-slate-300"></i>
                                </div>

                                <h4 id="badge-details-title" class="text-2xl font-heading font-bold text-allgood-dark mb-2">Select Asset</h4>
                                
                                <div class="inline-flex items-center justify-center gap-2 mb-6">
                                    <div id="detail-status-indicator" class="w-2 h-2 rounded-full bg-slate-300"></div>
                                    <p id="badge-details-status" class="text-xs font-bold uppercase tracking-widest text-slate-400">Waiting for input...</p>
                                </div>

                                <p id="badge-details-desc" class="text-sm text-slate-500 leading-relaxed max-w-xs mx-auto">Select a badge from the vault to view classification, acquisition date, and download options.</p>
                            </div>

                            <!-- Action Footer -->
                            <div class="p-6 border-t border-gray-100 bg-slate-50 mt-auto">
                                <button id="btn-badge-action" disabled class="w-full bg-slate-200 text-slate-400 font-bold py-4 rounded shadow-sm transition-all uppercase text-xs flex items-center justify-center gap-2 cursor-not-allowed">
                                    <i data-lucide="lock" class="w-4 h-4"></i>
                                    <span id="badge-action-text">Asset Locked</span>
                                </button>
                                <p id="badge-action-subtext" class="text-[10px] text-center text-slate-400 mt-2 h-4 opacity-0 transition-opacity">Asset verified in secure storage.</p>
                            </div>
                        </div>

                    </div>
                </div>

                </div> <!-- End Dashboard Page -->

                <!-- 5. NEW ADMIN PAGE (TASK FORCE MODE) -->
                <div class="page" id="page-admin" style="display:none;">
                    
                    <!-- BETA BANNER -->
                    <div class="bg-indigo-600 text-white px-4 py-3 rounded-lg shadow-md mb-6 flex items-start md:items-center justify-between gap-4 border border-indigo-500">
                        <div class="flex items-center gap-3">
                            <i data-lucide="flask-conical" class="w-5 h-5 flex-shrink-0 text-indigo-200"></i>
                            <p class="text-xs md:text-sm font-bold leading-tight">
                                <span class="opacity-75 uppercase tracking-wider text-[10px] block md:inline mb-1 md:mb-0 md:mr-2">System Notice:</span>
                                COMING SOON: This functionality is in development. <a href="#" onclick="window.openMessageModal(); return false;" class="underline decoration-dotted underline-offset-2 hover:text-indigo-200">Send us a message</a> using the chat feature if you're interested in getting this for free as a beta participant.
                            </p>
                        </div>
                        <button onclick="this.parentElement.style.display='none'" class="text-indigo-300 hover:text-white transition-colors"><i data-lucide="x" class="w-4 h-4"></i></button>
                    </div>
                    
                    <!-- ADMIN TOP BAR -->
                    <div class="flex items-center justify-between mb-8">
                        <div>
                            <div class="flex items-center gap-3">
                                <h1 class="text-2xl font-heading font-bold text-allgood-dark uppercase">Task Force Command</h1>
                                <span class="bg-emerald-100 text-emerald-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide border border-emerald-200">Plan Active</span>
                            </div>
                            <p class="text-xs text-slate-500 font-bold uppercase tracking-widest mt-1">Reporting Hub: <span class="text-allgood-secondary">4th Period Science Class</span></p>
                        </div>
                        <div class="flex items-center gap-2">
                             <button onclick="window.closeAdminDashboard()" class="text-slate-500 hover:text-allgood-primary px-4 py-2 text-xs font-bold uppercase transition-all flex items-center gap-2">
                                <i data-lucide="log-out" class="w-4 h-4"></i> Return to OS
                            </button>
                        </div>
                    </div>

                    <!-- STATS ROW -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                        <!-- Stat 1 -->
                        <div class="bg-white/60 backdrop-blur-md p-4 rounded-xl border border-white/60 shadow-sm flex items-center justify-between group hover:bg-white/80 transition-all">
                            <div>
                                <span class="text-[10px] uppercase text-slate-400 font-bold tracking-wider">Total Agents</span>
                                <span class="block text-3xl font-heading font-bold text-slate-700">24</span>
                            </div>
                            <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-600">
                                <i data-lucide="users" class="w-5 h-5"></i>
                            </div>
                        </div>
                        <!-- Stat 2 -->
                        <div class="bg-white/60 backdrop-blur-md p-4 rounded-xl border border-white/60 shadow-sm flex items-center justify-between group hover:bg-white/80 transition-all">
                            <div>
                                <span class="text-[10px] uppercase text-slate-400 font-bold tracking-wider">Completion Rate</span>
                                <span class="block text-3xl font-heading font-bold text-emerald-600">78%</span>
                            </div>
                            <div class="w-10 h-10 rounded-full bg-emerald-50 flex items-center justify-center text-emerald-600">
                                <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
                            </div>
                        </div>
                        <!-- Stat 3 -->
                        <div class="bg-white/60 backdrop-blur-md p-4 rounded-xl border border-white/60 shadow-sm flex items-center justify-between group hover:bg-white/80 transition-all cursor-pointer">
                            <div>
                                <span class="text-[10px] uppercase text-slate-400 font-bold tracking-wider">Invite Link</span>
                                <span class="block text-sm font-bold text-allgood-secondary mt-1 underline decoration-dotted">allgood.ac/tf/8821</span>
                            </div>
                            <div class="w-10 h-10 rounded-full bg-orange-50 flex items-center justify-center text-allgood-primary">
                                <i data-lucide="copy" class="w-5 h-5"></i>
                            </div>
                        </div>
                    </div>

                    <!-- ROSTER TABLE (GLASS) -->
                    <div class="bg-white/80 backdrop-blur-md rounded-xl shadow-sm border border-white/60 overflow-hidden flex flex-col h-[60vh]">
                        <!-- Toolbar -->
                        <div class="p-4 border-b border-gray-100 flex items-center justify-between bg-white/50">
                            <h3 class="font-bold text-slate-700 uppercase text-sm tracking-wide flex items-center gap-2">
                                <i data-lucide="list" class="w-4 h-4 text-slate-400"></i> Agent Roster
                            </h3>
                            <div class="flex gap-2">
                                <button class="px-3 py-1.5 rounded bg-white border border-gray-200 text-[10px] font-bold uppercase text-slate-500 hover:text-allgood-secondary hover:border-allgood-secondary transition-colors">
                                    Export CSV
                                </button>
                                <button class="px-3 py-1.5 rounded bg-allgood-primary text-white text-[10px] font-bold uppercase hover:bg-allgood-hover transition-colors shadow-sm flex items-center gap-1">
                                    <i data-lucide="plus" class="w-3 h-3"></i> Add Agent
                                </button>
                            </div>
                        </div>

                        <!-- Table Headers -->
                        <div class="grid grid-cols-12 gap-4 px-6 py-3 bg-slate-50/50 border-b border-gray-100 text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                            <div class="col-span-4">Agent Name</div>
                            <div class="col-span-2">Status</div>
                            <div class="col-span-2 text-center">Badges</div>
                            <div class="col-span-2 text-center">Last Active</div>
                            <div class="col-span-2 text-right">Actions</div>
                        </div>

                        <!-- Table Body (Scrollable) -->
                        <div class="overflow-y-auto custom-scrollbar flex-grow p-2 space-y-1">
                            
                            <!-- Row 1 -->
                            <div class="grid grid-cols-12 gap-4 px-4 py-3 items-center rounded-lg hover:bg-white hover:shadow-sm transition-all group cursor-pointer border border-transparent hover:border-gray-100">
                                <div class="col-span-4 flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold text-xs">JD</div>
                                    <div>
                                        <p class="text-xs font-bold text-slate-700">John Doe</p>
                                        <p class="text-[10px] text-slate-400">john.doe@example.com</p>
                                    </div>
                                </div>
                                <div class="col-span-2">
                                    <span class="bg-emerald-100 text-emerald-700 text-[9px] font-bold px-2 py-0.5 rounded-full uppercase tracking-wide">Active</span>
                                </div>
                                <div class="col-span-2 flex justify-center -space-x-2">
                                    <div class="w-6 h-6 rounded-full bg-white border border-gray-200 flex items-center justify-center z-30" title="Cyber Agent"><i data-lucide="shield" class="w-3 h-3 text-allgood-primary"></i></div>
                                    <div class="w-6 h-6 rounded-full bg-white border border-gray-200 flex items-center justify-center z-20" title="Operator"><i data-lucide="zap" class="w-3 h-3 text-yellow-500"></i></div>
                                    <div class="w-6 h-6 rounded-full bg-white border border-gray-200 flex items-center justify-center z-10 text-[9px] font-bold text-slate-400">+2</div>
                                </div>
                                <div class="col-span-2 text-center text-[10px] text-slate-500 font-mono">
                                    2h ago
                                </div>
                                <div class="col-span-2 flex justify-end">
                                    <button class="text-slate-300 hover:text-allgood-secondary transition-colors"><i data-lucide="more-horizontal" class="w-4 h-4"></i></button>
                                </div>
                            </div>

                            <!-- Row 2 -->
                            <div class="grid grid-cols-12 gap-4 px-4 py-3 items-center rounded-lg hover:bg-white hover:shadow-sm transition-all group cursor-pointer border border-transparent hover:border-gray-100">
                                <div class="col-span-4 flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-full bg-pink-100 text-pink-600 flex items-center justify-center font-bold text-xs">AS</div>
                                    <div>
                                        <p class="text-xs font-bold text-slate-700">Alice Smith</p>
                                        <p class="text-[10px] text-slate-400">alice.s@example.com</p>
                                    </div>
                                </div>
                                <div class="col-span-2">
                                    <span class="bg-amber-100 text-amber-700 text-[9px] font-bold px-2 py-0.5 rounded-full uppercase tracking-wide">Idle</span>
                                </div>
                                <div class="col-span-2 flex justify-center -space-x-2">
                                    <div class="w-6 h-6 rounded-full bg-white border border-gray-200 flex items-center justify-center z-30"><i data-lucide="eye" class="w-3 h-3 text-slate-400"></i></div>
                                </div>
                                <div class="col-span-2 text-center text-[10px] text-slate-500 font-mono">
                                    3d ago
                                </div>
                                <div class="col-span-2 flex justify-end">
                                    <button class="text-slate-300 hover:text-allgood-secondary transition-colors"><i data-lucide="more-horizontal" class="w-4 h-4"></i></button>
                                </div>
                            </div>

                            <!-- Row 3 -->
                            <div class="grid grid-cols-12 gap-4 px-4 py-3 items-center rounded-lg hover:bg-white hover:shadow-sm transition-all group cursor-pointer border border-transparent hover:border-gray-100">
                                <div class="col-span-4 flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-full bg-cyan-100 text-cyan-600 flex items-center justify-center font-bold text-xs">MJ</div>
                                    <div>
                                        <p class="text-xs font-bold text-slate-700">Marcus Jones</p>
                                        <p class="text-[10px] text-slate-400">mjones@example.com</p>
                                    </div>
                                </div>
                                <div class="col-span-2">
                                    <span class="bg-emerald-100 text-emerald-700 text-[9px] font-bold px-2 py-0.5 rounded-full uppercase tracking-wide">Active</span>
                                </div>
                                <div class="col-span-2 flex justify-center -space-x-2">
                                    <div class="w-6 h-6 rounded-full bg-white border border-gray-200 flex items-center justify-center z-30"><i data-lucide="shield" class="w-3 h-3 text-allgood-primary"></i></div>
                                    <div class="w-6 h-6 rounded-full bg-white border border-gray-200 flex items-center justify-center z-20"><i data-lucide="zap" class="w-3 h-3 text-yellow-500"></i></div>
                                </div>
                                <div class="col-span-2 text-center text-[10px] text-slate-500 font-mono">
                                    12m ago
                                </div>
                                <div class="col-span-2 flex justify-end">
                                    <button class="text-slate-300 hover:text-allgood-secondary transition-colors"><i data-lucide="more-horizontal" class="w-4 h-4"></i></button>
                                </div>
                            </div>

                             <!-- Row 4 -->
                             <div class="grid grid-cols-12 gap-4 px-4 py-3 items-center rounded-lg hover:bg-white hover:shadow-sm transition-all group cursor-pointer border border-transparent hover:border-gray-100">
                                <div class="col-span-4 flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center font-bold text-xs">SK</div>
                                    <div>
                                        <p class="text-xs font-bold text-slate-700">Sarah Kim</p>
                                        <p class="text-[10px] text-slate-400">skim@example.com</p>
                                    </div>
                                </div>
                                <div class="col-span-2">
                                    <span class="bg-red-100 text-red-700 text-[9px] font-bold px-2 py-0.5 rounded-full uppercase tracking-wide">Behind</span>
                                </div>
                                <div class="col-span-2 flex justify-center -space-x-2">
                                     <div class="w-6 h-6 rounded-full bg-white border border-gray-200 flex items-center justify-center z-30 text-[9px] text-slate-300">0</div>
                                </div>
                                <div class="col-span-2 text-center text-[10px] text-slate-500 font-mono">
                                    5d ago
                                </div>
                                <div class="col-span-2 flex justify-end">
                                    <button class="text-slate-300 hover:text-allgood-secondary transition-colors"><i data-lucide="more-horizontal" class="w-4 h-4"></i></button>
                                </div>
                            </div>

                        </div>
                    </div>

                </div>

            </div>

            <!-- ABOUT US MODAL -->
            <div id="about-modal" class="hidden-modal absolute inset-0 z-[250] bg-allgood-dark/90 flex items-center justify-center p-6 modal-transition backdrop-blur-sm" onclick="closeAboutModal()">
                <div class="bg-white rounded-lg shadow-2xl p-6 max-w-sm w-full text-center border-t-4 border-allgood-primary relative" onclick="event.stopPropagation()">
                    <button onclick="closeAboutModal()" class="absolute top-2 right-2 text-gray-400 hover:text-red-500 transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
                    
                    <div class="mb-6">
                        <h3 class="text-2xl font-heading font-bold text-allgood-dark uppercase tracking-tight">Academy Protocol</h3>
                        <p class="text-[10px] text-gray-400 uppercase tracking-widest font-bold mt-1">Mission Directive</p>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="bg-gray-50 border-l-4 border-allgood-secondary p-4 rounded shadow-sm text-left hover:bg-white hover:shadow-md transition-all group">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="p-2 bg-white rounded-full text-allgood-secondary shadow-sm group-hover:scale-110 transition-transform">
                                    <i data-lucide="flask-conical" class="w-5 h-5"></i>
                                </div>
                                <h4 class="font-bold text-allgood-dark text-sm uppercase tracking-wide">The Lab</h4>
                            </div>
                            <p class="text-gray-600 text-xs leading-relaxed font-body">Allgood Academy is a mission-driven learning hub. We use <span class="font-bold text-allgood-secondary">advanced instructional design</span> principles trusted by top corporations to create immersive, high-impact training.</p>
                        </div>
                        
                        <div class="bg-gray-50 border-l-4 border-allgood-primary p-4 rounded shadow-sm text-left hover:bg-white hover:shadow-md transition-all group">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="p-2 bg-white rounded-full text-allgood-primary shadow-sm group-hover:scale-110 transition-transform">
                                    <i data-lucide="zap" class="w-5 h-5"></i>
                                </div>
                                <h4 class="font-bold text-allgood-dark text-sm uppercase tracking-wide">The Result</h4>
                            </div>
                            <p class="text-gray-600 text-xs leading-relaxed font-body">We don't just teach; we transform. Our goal is a complete <span class="font-bold text-allgood-primary">mindset shift</span> that moves learners from passive consumption to pragmatic, real-world execution.</p>
                        </div>
                    </div>
                    
                    <button onclick="closeAboutModal()" class="mt-6 w-full bg-allgood-dark hover:bg-black text-white font-bold py-3 rounded text-xs shadow-md transition-all transform active:scale-95 uppercase tracking-wide flex items-center justify-center gap-2">
                        <i data-lucide="power-off" class="w-3 h-3"></i> Close Protocol
                    </button>
                </div>
            </div>

            <!-- NEW: PROFILE MODAL (Dossier + Identity Editor + Mission Log) -->
            <div id="profile-modal" class="hidden-modal absolute inset-0 z-[260] bg-allgood-dark/90 flex items-center justify-center p-4 modal-transition backdrop-blur-sm" onclick="window.closeProfileModal()">
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden border-t-4 border-allgood-secondary relative flex flex-col md:flex-row" onclick="event.stopPropagation()">
                    
                    <!-- Close Button -->
                    <button onclick="window.closeProfileModal()" class="absolute top-2 right-2 text-gray-400 hover:text-red-500 z-50 p-2"><i data-lucide="x" class="w-5 h-5"></i></button>

                    <!-- Left: ID Card Visual -->
                    <div class="w-full md:w-2/5 bg-slate-50 border-b md:border-b-0 md:border-r border-gray-200 p-6 flex flex-col items-center text-center">
                        <div class="w-24 h-24 rounded-full bg-white border-4 border-white shadow-md mb-4 overflow-hidden relative group">
                            <div class="absolute inset-0 bg-allgood-secondary/10 flex items-center justify-center">
                                <i data-lucide="user" class="w-10 h-10 text-allgood-secondary"></i>
                            </div>
                        </div>
                        
                        <!-- VIEW MODE: NAME -->
                        <div id="profile-view-name" class="w-full">
                            <h3 class="text-xl font-heading font-bold text-slate-800" id="profile-name-display">Agent Name</h3>
                            <button onclick="window.toggleProfileEdit(true)" class="text-[10px] uppercase font-bold text-allgood-primary hover:text-allgood-hover underline decoration-dotted mt-1">Edit Identity</button>
                        </div>

                        <!-- EDIT MODE: NAME -->
                        <div id="profile-edit-name" class="w-full hidden">
                            <input type="text" id="profile-name-input" class="w-full text-center border border-allgood-secondary rounded p-1 text-sm font-bold mb-2 focus:outline-none focus:ring-2 focus:ring-allgood-secondary/50" placeholder="Enter Alias">
                            <div class="flex gap-2 justify-center">
                                <button onclick="window.saveProfileIdentity()" class="bg-allgood-secondary text-white px-3 py-1 rounded text-[10px] font-bold uppercase hover:bg-allgood-accent">Save</button>
                                <button onclick="window.toggleProfileEdit(false)" class="bg-gray-200 text-gray-500 px-3 py-1 rounded text-[10px] font-bold uppercase hover:bg-gray-300">Cancel</button>
                            </div>
                        </div>

                        <div class="mt-6 w-full">
                            <div class="bg-white border border-gray-200 rounded p-3 shadow-sm">
                                <p class="text-[9px] text-gray-400 uppercase tracking-widest font-bold mb-1">Clearance Rank</p>
                                <p class="text-sm font-bold text-allgood-secondary" id="profile-rank-display">FIELD AGENT</p>
                            </div>
                        </div>
                    </div>

                    <!-- Right: Mission Log & Stats -->
                    <div class="w-full md:w-3/5 p-6 bg-white">
                        <div class="mb-6">
                            <h3 class="text-lg font-heading font-bold text-slate-700 uppercase tracking-tight flex items-center gap-2">
                                <i data-lucide="clipboard-list" class="w-4 h-4 text-slate-400"></i> Service Record
                            </h3>
                            <div class="h-px w-full bg-gray-100 mt-2"></div>
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div class="p-3 bg-slate-50 rounded border border-slate-100">
                                <span class="block text-2xl font-bold text-slate-700" id="profile-stat-launches">0</span>
                                <span class="text-[9px] text-slate-400 uppercase font-bold tracking-wider">Missions Launched</span>
                            </div>
                            <div class="p-3 bg-slate-50 rounded border border-slate-100">
                                <span class="block text-2xl font-bold text-slate-700" id="profile-stat-badges">0</span>
                                <span class="text-[9px] text-slate-400 uppercase font-bold tracking-wider">Badges Earned</span>
                            </div>
                        </div>

                        <div class="space-y-3">
                            <div class="flex justify-between items-center text-xs border-b border-gray-50 pb-2">
                                <span class="text-slate-500 font-bold uppercase">Agent ID</span>
                                <span class="font-mono text-slate-400 select-all" id="profile-id-display">UNKNOWN</span>
                            </div>
                            <div class="flex justify-between items-center text-xs border-b border-gray-50 pb-2">
                                <span class="text-slate-500 font-bold uppercase">Account Status</span>
                                <span class="text-emerald-600 font-bold bg-emerald-50 px-2 py-0.5 rounded-full uppercase text-[10px]">Active</span>
                            </div>
                             <div class="flex justify-between items-center text-xs pb-2">
                                <span class="text-slate-500 font-bold uppercase">Join Date</span>
                                <span class="font-mono text-slate-400" id="profile-join-date">--/--/----</span>
                            </div>
                        </div>

                        <div class="mt-8 pt-4 border-t border-gray-100 text-center md:text-right">
                             <button onclick="window.closeProfileModal()" class="text-xs font-bold text-slate-400 hover:text-allgood-primary transition-colors uppercase tracking-wide">
                                Close Dossier
                            </button>
                        </div>
                    </div>

                </div>
            </div>

            <!-- MESSAGE MODAL -->
            <div id="message-modal" class="hidden-modal absolute inset-0 z-[250] bg-allgood-dark/90 flex items-center justify-center p-6 modal-transition backdrop-blur-sm" onclick="closeMessageModal()">
                <div class="bg-white rounded-lg shadow-2xl p-6 max-w-sm w-full text-center border-t-4 border-allgood-primary relative" onclick="event.stopPropagation()">
                    <button onclick="closeMessageModal()" class="absolute top-2 right-2 text-gray-400 hover:text-red-500 transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
                    
                    <div class="mb-4">
                        <div class="w-12 h-12 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-3">
                            <i data-lucide="message-circle" class="w-6 h-6 text-allgood-primary"></i>
                        </div>
                        <h3 class="text-xl font-heading font-bold text-allgood-dark uppercase">Direct Line</h3>
                        <p class="text-[10px] text-gray-400 uppercase tracking-widest font-bold mt-1">To: Allgood Academy HQ</p>
                    </div>
                    
                    <div class="text-left mb-4">
                        <p class="text-xs text-gray-500 italic mb-2">This is a one-way secure transmission. Use this channel to send feedback, topic requests, or field reports.</p>
                        <textarea id="message-input" rows="4" class="w-full border border-gray-300 rounded p-3 text-sm focus:ring-1 focus:ring-allgood-primary focus:border-allgood-primary outline-none resize-none bg-gray-50 font-body placeholder-gray-400" placeholder="Type your message here..."></textarea>
                    </div>
                    
                    <button id="btn-send-message" onclick="window.submitMessage()" class="w-full bg-allgood-primary hover:bg-allgood-hover text-white font-bold py-3 rounded text-xs shadow-md transition-all transform active:scale-95 uppercase tracking-wide flex items-center justify-center gap-2">
                        <i data-lucide="send" class="w-3 h-3"></i> Send Transmission
                    </button>
                </div>
            </div>

        </div>
    </main>

    <script>
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx;

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new AudioContext();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume().catch(e => console.error("Audio resume failed:", e));
            }
        }

        function playTone(freq, type, duration, vol = 0.1, attack = 0.01, decay = 0.001) {
            initAudio();
            const now = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();

            osc.type = type;
            osc.frequency.setValueAtTime(freq, now);
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(vol, now + attack);
            gain.gain.exponentialRampToValueAtTime(decay, now + duration);

            osc.start(now);
            osc.stop(now + duration);
        }

        const sfx = {
            tick: () => {
                initAudio();
                playTone(1000, 'sine', 0.01, 0.01);
            },
            click: () => {
                initAudio();
                playTone(1000, 'sine', 0.01, 0.01);
            },
            confirm: () => {
                initAudio();
                playTone(150, 'sine', 0.1, 0.1, 0.01, 0.01);
            },
            powerOn: () => {
                initAudio();
                const now = audioCtx.currentTime;
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                
                osc.type = 'triangle'; 
                osc.frequency.setValueAtTime(110, now);
                osc.frequency.exponentialRampToValueAtTime(220, now + 0.4);
                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(0.4, now + 0.1);
                gain.gain.linearRampToValueAtTime(0, now + 0.4);
                osc.start(now); osc.stop(now + 0.4);
            },
            powerOff: () => {
                initAudio();
                playTone(80, 'triangle', 0.2, 0.5, 0.01, 0.001);
            },
            nav: () => {
                initAudio();
                playTone(200, 'sine', 0.08, 0.1, 0.01, 0.01);
            },
        };

        window.sfx = sfx;
        window.initAudio = initAudio;

        window.switchTab = (tabName) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            const target = document.getElementById('tab-' + tabName);
            if(target) target.classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active-tab');
                btn.classList.add('inactive-tab');
            });
            const activeBtn = document.getElementById('tab-btn-' + tabName);
            if(activeBtn) {
                activeBtn.classList.remove('inactive-tab');
                activeBtn.classList.add('active-tab');
            }
            sfx.nav(); 
        };

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            
            const homeBtn = document.getElementById('btn-home');
            let homePressTimer;
            let homeIsHold = false;
            const startHomePress = (e) => {
                e.preventDefault(); 
                homeIsHold = false;
                homePressTimer = setTimeout(() => {
                    homeIsHold = true;
                    if(window.handleLogout) { sfx.powerOff(); window.handleLogout(); }
                }, 2000);
            };
            const endHomePress = (e) => {
                clearTimeout(homePressTimer);
                if(!homeIsHold) { sfx.tick(); document.getElementById('page-dashboard').scrollTop = 0; }
            };

            if(homeBtn) {
                homeBtn.addEventListener('mousedown', startHomePress);
                homeBtn.addEventListener('touchstart', startHomePress);
                homeBtn.addEventListener('mouseup', endHomePress);
                homeBtn.addEventListener('touchend', endHomePress);
                homeBtn.addEventListener('mouseleave', () => clearTimeout(homePressTimer));
            }

            const btnBlueprint = document.getElementById('btn-blueprint');
            if(btnBlueprint) {
                 btnBlueprint.addEventListener('click', () => {
                    document.body.classList.toggle('blueprint-mode');
                    sfx.tick();
                });
            }

            const fullscreenBtn = document.getElementById('btn-fullscreen');
            if(fullscreenBtn) {
                fullscreenBtn.addEventListener('click', () => {
                    const body = document.body;
                    if (body.classList.contains('focus-mode')) {
                        body.classList.remove('focus-mode');
                        fullscreenBtn.classList.remove('text-green-300', 'bg-white/10');
                    } else {
                        body.classList.add('focus-mode');
                        fullscreenBtn.classList.add('text-green-300', 'bg-white/10');
                    }
                    lucide.createIcons();
                    sfx.tick();
                });
            }

            const menuModal = document.getElementById('menu-modal');
            const btnMenu = document.getElementById('btn-menu');
            if(btnMenu && menuModal) {
                 btnMenu.addEventListener('click', () => {
                    menuModal.classList.remove('hidden-modal');
                    menuModal.classList.add('visible-modal');
                    sfx.tick();
                });
            }

            const closeMenu = document.getElementById('close-menu');
            if(closeMenu && menuModal) {
                closeMenu.addEventListener('click', () => {
                    menuModal.classList.add('hidden-modal');
                    menuModal.classList.remove('visible-modal');
                    sfx.tick();
                });
            }
            
            // Startup Screen Listener
            const startupScreen = document.getElementById('startup-screen');
            if(startupScreen) {
                startupScreen.addEventListener('click', () => {
                    if(window.sfx && window.sfx.powerOn) {
                        window.sfx.powerOn(); 
                    } else if (window.initAudio) {
                        window.initAudio();
                    }
                    
                    startupScreen.style.opacity = '0';
                    
                    const storedUID = localStorage.getItem('aa_uid');
                    const storedName = localStorage.getItem('aa_username');
                    
                    if (storedName && storedUID) {
                        window.restoreSessionState();
                        window.initDashboard(); 
                    } else {
                        const loginModal = document.getElementById('login-modal');
                        if (loginModal) {
                            loginModal.classList.remove('hidden-modal');
                            loginModal.classList.add('visible-modal');
                        }
                    }
                    
                    setTimeout(() => { startupScreen.style.display = 'none'; }, 700);
                });
            }
        });

        window.openAboutModal = () => {
            const menu = document.getElementById('menu-modal');
            if (menu) {
                menu.classList.add('hidden-modal');
                menu.classList.remove('visible-modal');
            }

            const modal = document.getElementById('about-modal');
            modal.classList.remove('hidden-modal');
            modal.classList.add('visible-modal');
            sfx.click();
        }

        window.closeAboutModal = () => {
            const modal = document.getElementById('about-modal');
            modal.classList.add('hidden-modal');
            modal.classList.remove('visible-modal');
            sfx.click();
        }

        /* REMOVED: Profile Functions from here to avoid ReferenceError */

    </script>
</body>
</html>
