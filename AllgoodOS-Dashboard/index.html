<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Allgood Academy Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, updateProfile, signOut, GoogleAuthProvider, signInWithPopup } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, addDoc, collection, serverTimestamp, onSnapshot, query, where } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase logging level for debugging
        setLogLevel('Debug');
        
        // --- HARDCODED FIREBASE CONFIGURATION (For GitHub Pages/Google Sites deployment) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAf2SO8xovrApl52udUUoR1n9WBnERr_ko",
            authDomain: "allgood-academy.firebaseapp.com",
            projectId: "allgood-academy",
            storageBucket: "allgood-academy.firebasestorage.app",
            messagingSenderId: "978829044870",
            appId: "1:978829044870:web:6c780f64230a77ad0ab507",
            measurementId: "G-EN4M7T3BLQ"
        };
        
        let auth, db, appId;

        // --- FIREBASE INITIALIZATION ---
        const app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        appId = 'allgood-academy'; // Hardcoded from firebaseConfig.projectId

        // --- GLOBAL EXPORTS (Fixes ReferenceError) ---
        window.auth = auth; 
        window.db = db;

        // TRACKING STATE
        let launchCount = parseInt(localStorage.getItem('aa_launch_count') || '0');
        let currentLevel = 1;
        let unsubscribeLaunches = null;

        // --- UTILITY: Writes essential user data to Firestore ---
        async function writeUserDataToFirestore(user, name, email, isGuest) {
             const userRef = doc(db, 'artifacts', appId, 'users', user.uid);
             
             // Update Firebase Auth profile display name for anonymous users if provided
             if (isGuest && user.displayName !== name) {
                await updateProfile(user, { displayName: name });
             }

             // Write to Firestore
             await setDoc(userRef, {
                 displayName: name,
                 email: email || (isGuest ? null : user.email || null),
                 isGuest: isGuest,
                 lastLogin: serverTimestamp(),
                 onboardingComplete: true
             }, { merge: true });

             // Persist local state
             localStorage.setItem('aa_is_guest', isGuest);
             localStorage.setItem('aa_username', name);
             localStorage.setItem('aa_uid', user.uid);
             
             // UI/State Update
             window.updateUI(name); // Now globally callable
             document.getElementById('page-dashboard').classList.add('active');
             document.getElementById('page-dashboard').style.display = 'block'; 
             closeLoginModal();
             sfx.powerOn(); // <-- PowerOn sound added here for successful login
             window.startLaunchListener(user.uid); // Now globally callable
        }

        // --- AUTH: Guest Sign-In (Anonymous) ---
        // This is now the universal button handler, capable of anonymous login with optional details.
        window.handleGuestLogin = async () => {
            sfx.click();
            const btn = document.getElementById('btn-guest-login');
            
            // Read optional inputs
            const nameInput = document.getElementById('user-name-input').value.trim();
            const emailInput = document.getElementById('user-email-input').value.trim();

            const finalName = nameInput || "Guest";
            const finalEmail = emailInput || null;
            const isGuest = true;
            
            // 1. LOADING STATE
            btn.innerText = "Connecting...";
            btn.disabled = true;
            btn.classList.add('opacity-70', 'cursor-wait');

            // --- FIREBASE AUTH ---
            try {
                const userCredential = await signInAnonymously(auth);
                const user = userCredential.user;
                
                // Write data
                await writeUserDataToFirestore(user, finalName, finalEmail, isGuest);
                
            } catch (error) {
                console.error("Anonymous Login Error:", error);
                showStatusMessage("Connection failed. Check network or rules.", 'error'); 
            } finally {
                // 5. RESET BUTTON (if error occurs before navigation)
                btn.innerText = "Enter Dashboard"; // Restored original text
                btn.disabled = false;
                btn.classList.remove('opacity-70', 'cursor-wait');
            }
        };

        // --- AUTH: Google Sign-In (Persistent) ---
        window.handleGoogleLogin = async () => {
            sfx.click();
            const btnContainer = document.getElementById('google-icon-container');
            
            // 1. LOADING STATE (Using the icon container for feedback)
            btnContainer.classList.add('opacity-50', 'cursor-wait');
            
            const provider = new GoogleAuthProvider();
            const isGuest = false;

            try {
                // 2. SIGN IN POPUP
                const result = await signInWithPopup(auth, provider);
                const user = result.user;

                const finalName = user.displayName || 'Agent';
                const finalEmail = user.email || null;

                // 3. WRITE DATA (Persistent user with name/email)
                await writeUserDataToFirestore(user, finalName, finalEmail, isGuest);
                
            } catch (error) {
                console.error("Google Sign-In Error:", error);
                
                let message = "Sign-in failed. Please try again.";
                if (error.code === 'auth/popup-closed-by-user') {
                    message = "Sign-in canceled. Please try again.";
                }
                showStatusMessage(message, 'error');
            } finally {
                 // 6. RESET BUTTON 
                btnContainer.classList.remove('opacity-50', 'cursor-wait');
            }
        };

        window.handleLogout = async () => {
            sfx.powerOff();
            // 1. Clear Local Data
            localStorage.removeItem('aa_username');
            localStorage.removeItem('aa_is_guest'); 
            localStorage.removeItem('aa_launch_count');
            localStorage.removeItem('aa_uid');

            launchCount = 0; // Reset Stats
            currentLevel = 1;
            
            // 2. Sign out of Firebase
            if (auth.currentUser) {
                try {
                    await signOut(auth);
                } catch(e) { console.log("Signout error (offline?)", e); }
            }
            
            // 3. Stop Launch Listener
            if (unsubscribeLaunches) {
                unsubscribeLaunches();
                unsubscribeLaunches = null;
            }
            
            // 4. FORCE RESET UI STATE
            document.querySelectorAll('.visible-modal').forEach(el => {
                el.classList.remove('visible-modal');
                el.classList.add('hidden-modal');
            });

            const dashboard = document.getElementById('page-dashboard');
            if (dashboard) {
                dashboard.classList.remove('active');
                dashboard.style.display = 'none';
            }
            
            window.updateUI('Agent'); // Reset display name on UI
            window.updateBadges(); 

            // E. Show Startup Screen (Cover everything)
            const startup = document.getElementById('startup-screen');
            if(startup) {
                startup.style.display = 'flex';
                setTimeout(() => { startup.style.opacity = '1'; }, 10);
            }
        };

        // --- FIRESTORE LISTENERS ---
        window.startLaunchListener = function(uid) { // Globally accessible function
            if (unsubscribeLaunches) {
                unsubscribeLaunches(); // Clean up previous listener
            }
            
            const launchesCollectionRef = collection(db, 'artifacts', appId, 'users', uid, 'launches');
            // Using onSnapshot for real-time updates
            unsubscribeLaunches = onSnapshot(launchesCollectionRef, (snapshot) => {
                const totalLaunches = snapshot.size;
                launchCount = totalLaunches; // Sync local state with DB count
                localStorage.setItem('aa_launch_count', launchCount); // Persist
                window.updateBadges();

                // Update launch count display
                const statElement = document.getElementById('stat-total-launches');
                if (statElement) {
                    statElement.textContent = totalLaunches;
                }
            }, (error) => {
                console.error("Error listening to launches:", error);
            });
        }
        
        window.launchCourse = async (courseName, url) => {
            // IMMEDIATE ACTION
            window.open(url, '_blank');

            sfx.confirm();
            
            // Log asynchronously (Only if Firebase is initialized)
            if (auth.currentUser) {
                addDoc(collection(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'launches'), {
                    courseName: courseName,
                    targetUrl: url,
                    timestamp: serverTimestamp()
                }).catch(e => console.log("Log failed (Firebase). Continuing navigation."));
            }
        };

        // --- UI/BADGE LOGIC ---
        window.updateUI = function(name) { // Globally accessible function
            const els = document.querySelectorAll('.user-name-display');
            els.forEach(el => el.textContent = name);
            window.updateBadges();
        }
        
        window.updateBadges = function() { // Globally accessible function
            // LOGIC FIX:
            launchCount = parseInt(localStorage.getItem('aa_launch_count') || '0');

            const isGuest = localStorage.getItem('aa_is_guest') === 'true';
            const name = localStorage.getItem('aa_username');
            
            const isGenericName = !name || name === 'Guest' || name === 'Learner';
            
            currentLevel = 1;
            
            // Level 2 (Agent) requires persistent identity
            if (!isGuest && name && !isGenericName) {
                currentLevel = 2;
            }
            
            // Level 3 (Operator) requires Agent status + Action (1 Launch)
            if (currentLevel >= 2 && launchCount >= 1) {
                currentLevel = 3; 
            } else if (currentLevel >= 2) {
                currentLevel = 2; // Ensure Google users who haven't launched stay at 2
            }
            
            // Update UI
            for(let i=1; i<=3; i++) {
                const badge = document.getElementById(`badge-${i}`);
                if(!badge) continue;
                
                if (i <= currentLevel) {
                    badge.classList.remove('opacity-30', 'grayscale');
                    if (i === 3) {
                         badge.classList.add('animate-pulse-glow-badge');
                    } else {
                        badge.classList.remove('animate-pulse-glow-badge');
                    }
                    badge.classList.add('cursor-pointer', 'hover:scale-110', 'shadow-badge-active');
                    badge.classList.remove('shadow-badge-locked');

                    const lock = badge.querySelector('.lock-icon');
                    if(lock) lock.style.display = 'none';
                } else {
                    // Locked
                    badge.classList.add('opacity-30', 'grayscale', 'shadow-badge-locked');
                    badge.classList.remove('cursor-pointer', 'hover:scale-110', 'shadow-badge-active', 'animate-pulse-glow-badge');
                    
                    const lock = badge.querySelector('.lock-icon');
                    if(lock) lock.style.display = 'block';
                }
            }
            
            // Update Text Label
            const label = document.getElementById('clearance-label');
            const titles = ["OBSERVER", "AGENT", "OPERATOR"];
            if(label) label.textContent = `LEVEL ${currentLevel}: ${titles[currentLevel-1]}`;

            // Update stat display in profile card
            const launchStat = document.getElementById('stat-total-launches');
             if (launchStat) {
                launchStat.textContent = launchCount;
            }
        }
        
        window.showBadgeInfo = (level) => {
            const titles = ["Observer", "Agent", "Operator"];
            const descs = [
                "You are observing the academy. Sign in to track your progress.",
                "Identity confirmed. You are authorized to access mission files. This requires persistent sign-in.",
                "Field Operator status confirmed. You have moved from theory to action."
            ];
            const reqs = [
                "None (Guest/Anonymous Access)",
                "Sign In with Persistent Identity (Google or SSO)",
                "Agent Status + Complete 1 Mission Module"
            ];
            
            const modal = document.getElementById('badge-modal');
            document.getElementById('badge-title').textContent = `Level ${level}: ${titles[level-1]}`;
            document.getElementById('badge-desc').textContent = descs[level-1];
            document.getElementById('badge-req').textContent = `Requirement: ${reqs[level-1]}`;
            
            // Show status
            const statusEl = document.getElementById('badge-status');
            if (level <= currentLevel) {
                statusEl.textContent = "STATUS: UNLOCKED";
                statusEl.className = "text-xs font-bold text-green-600 uppercase tracking-widest";
            } else {
                statusEl.textContent = "STATUS: CLASSIFIED (LOCKED)";
                statusEl.className = "text-xs font-bold text-red-500 uppercase tracking-widest";
            }
            
            modal.classList.remove('hidden-modal');
            modal.classList.add('visible-modal');
            sfx.click();
        }
        
        window.closeBadgeModal = () => {
            const modal = document.getElementById('badge-modal');
            modal.classList.add('hidden-modal');
            modal.classList.remove('visible-modal');
            sfx.click();
        }

        function closeLoginModal() {
            const modal = document.getElementById('login-modal');
            if(modal) {
                modal.classList.add('hidden-modal');
                modal.classList.remove('visible-modal');
            }
        }
        
        // Custom Message Box (Replaces alert())
        function showStatusMessage(message, type = 'info') {
            const modal = document.getElementById('status-modal');
            const content = document.getElementById('status-content');
            const icon = document.getElementById('status-icon');
            const classes = {
                'info': { bg: 'bg-blue-100', text: 'text-blue-800', icon: 'info' },
                'error': { bg: 'bg-red-100', text: 'text-red-800', icon: 'alert-triangle' }
            };

            const style = classes[type] || classes['info'];
            
            modal.querySelector('.modal-content-base').className = `modal-content-base rounded-lg shadow-2xl p-6 max-w-sm w-full text-center border-t-4 ${style.bg} relative`;

            content.textContent = message;
            content.className = `text-sm font-body ${style.text}`;
            icon.setAttribute('data-lucide', style.icon);
            lucide.createIcons();

            modal.classList.remove('hidden-modal');
            modal.classList.add('visible-modal');
            
            setTimeout(() => {
                modal.classList.add('hidden-modal');
                modal.classList.remove('visible-modal');
            }, 3000);
        }
        
        /**
         * Central function to restore session state from local storage and start listeners.
         * This runs on page load and when the user clicks "Power Up" with existing data.
         */
        window.restoreSessionState = function() { // Globally accessible function
            const storedName = localStorage.getItem('aa_username');
            const storedUID = localStorage.getItem('aa_uid');
            const dashboard = document.getElementById('page-dashboard');

            if (storedName && storedUID) {
                // 1. Update UI (Name, Badge display)
                window.updateUI(storedName);
                
                // 2. Ensure Dashboard is Visible
                if (dashboard) {
                    dashboard.classList.add('active');
                    dashboard.style.display = 'block'; 
                }

                // 3. Start Listeners immediately using stored UID
                window.startLaunchListener(storedUID);

                return true; // State restored
            }
            return false; // No state to restore
        }

        // --- CORE DASHBOARD INITIALIZATION AND AUTH CHECK (Requirement 2) ---
        window.initDashboard = function() { // Globally accessible function
            onAuthStateChanged(auth, async (user) => {
                const dashboard = document.getElementById('page-dashboard');
                
                if (user) {
                    // User is signed in (either persistent or anonymous via cookie)
                    
                    // 1. Check if the dashboard is already active (i.e., restored via localStorage check)
                    if (dashboard.style.display === 'block') {
                        // State already active, just ensure listeners are running
                        window.startLaunchListener(user.uid);
                        return;
                    }

                    // 2. State is not active, but user is logged into Firebase. 
                    // This happens on refresh if no localStorage data exists, or for new persistent users.
                    
                    const userRef = doc(db, 'artifacts', appId, 'users', user.uid);
                    const docSnap = await getDoc(userRef);

                    let displayName = user.displayName || 'Agent';
                    let isGuest = true; // Default assumption for safety

                    if (docSnap.exists()) {
                        const userData = docSnap.data();
                        displayName = userData.displayName || user.displayName || 'Agent';
                        isGuest = userData.isGuest || false;
                    }

                    // 3. Apply state and store locally
                    localStorage.setItem('aa_username', displayName);
                    localStorage.setItem('aa_uid', user.uid);
                    localStorage.setItem('aa_is_guest', isGuest);

                    // 4. Update UI and start listeners
                    window.updateUI(displayName);
                    dashboard.classList.add('active');
                    dashboard.style.display = 'block'; 
                    window.startLaunchListener(user.uid);

                } else {
                    // User is signed out (expected state before login)
                    // If dashboard is visible (which shouldn't happen), hide it.
                    if (dashboard.style.display === 'block') {
                         window.handleLogout(); // Force logout/reset state
                    }
                }
            });
        }
        
    </script>
    
    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'allgood-primary': '#D34716',
                        'allgood-secondary': '#357889',
                        'allgood-dark': '#4C4C4C',
                        'allgood-light': '#F7F7F7',
                        'allgood-hover': '#EB8D69',
                        'allgood-accent': '#2D6473',
                    },
                    fontFamily: {
                        'heading': ['Georgia', 'serif'],
                        'body': ['Verdana', 'sans-serif'],
                    },
                },
            },
        }
    </script>

    <style>
        /* =============================================
        INDUSTRIAL PREMIUM FUSION STYLES
        =============================================
        */

        /* Base Body/Frame Styling (Carhartt rugged base) */
        body {
            font-family: Verdana, sans-serif;
            background-color: #1a1a1a;
            /* Industrial grid pattern */
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
            background-attachment: fixed;
            min-height: 100vh;
            margin: 0; padding: 0;
            overflow: hidden;
        }

        h1, h2, h3, h4, h5, h6 { font-family: Georgia, serif; }

        /* Neon Glow Effect (for Cadillac style) */
        @keyframes pulse-glow {
            0%, 100% { text-shadow: 0 0 10px rgba(211, 71, 22, 0.4); transform: scale(1); }
            50% { text-shadow: 0 0 30px rgba(211, 71, 22, 0.9), 0 0 15px rgba(211, 71, 22, 0.6); transform: scale(1.02); }
        }
        .animate-pulse-glow { animation: pulse-glow 2.5s infinite ease-in-out; will-change: transform, text-shadow; }

        .static-neon-glow {
            text-shadow: 0 0 5px rgba(211, 71, 22, 0.2), 0 0 10px rgba(211, 71, 22, 0.4), 0 0 20px rgba(211, 71, 22, 0.6);
        }

        /* Badge Pulse Glow (more subtle) */
        @keyframes pulse-glow-badge {
            0%, 100% { box-shadow: 0 0 0px rgba(211, 71, 22, 0.0); }
            50% { box-shadow: 0 0 12px rgba(211, 71, 22, 0.7); }
        }
        .animate-pulse-glow-badge { animation: pulse-glow-badge 3s infinite ease-in-out; }

        /* Badge Embossed/Metallic Shadows */
        .shadow-badge-locked { box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.5), 0 1px 1px rgba(255, 255, 255, 0.2); }
        .shadow-badge-active { box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2), 0 0 1px #FFF; }
        
        /* --- TABLET FRAME (FIXED CHASSIS - RUGGED LOOK) --- */
        .tablet-frame {
            height: 85vh; 
            max-height: 900px; 
            width: auto;
            aspect-ratio: 16/10;
            max-width: 100%;
            /* Reworked metallic/rugged border */
            background-image: linear-gradient(135deg, #757575 0%, #a3a3a3 50%, #757575 100%);
            border-radius: 24px;
            padding: 12px;
            box-shadow: 
                inset 0 0 4px rgba(255,255,255, 0.8), /* Inner highlight */
                0 40px 80px -15px rgba(0, 0, 0, 0.9), /* Large drop shadow */
                0 0 0 1px #111;
            border: 2px solid #555;
            position: relative;
            margin: 20px auto;
            transition: all 0.3s ease;
        }

        .screen-container {
            width: 100%; height: 100%; background-color: #F7F7F7; /* allgood-light */
            position: relative; z-index: 1; overflow: hidden;
            display: flex; flex-direction: column; 
            border-radius: 8px; /* Slightly more rounded interior */
            box-shadow: inset 0 0 15px rgba(0,0,0,0.4); /* Deeper inset shadow */
        }
        
        /* --- MISSION CARD (EMBOSSED LOOK) --- */
        .mission-file {
            background: white;
            border: 1px solid #d1d5db; /* Neutral border */
            border-left-width: 4px;
            border-radius: 6px;
            /* Embossed/Durable Shadow */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.8);
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        /* Copper Glow on Hover */
        .mission-file::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            opacity: 0;
            border-radius: 6px;
            box-shadow: 0 0 10px #EB8D69, inset 0 0 5px #EB8D69; /* Hover accent */
            transition: opacity 0.2s ease;
            pointer-events: none;
            z-index: 5;
        }
        .mission-file:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        .mission-file:hover::after {
            opacity: 0.5;
        }

        /* Status colors */
        .status-active { border-left-color: #D34716; } /* Burnt Orange */
        .status-ready { border-left-color: #357889; } /* Deep Cyan */
        .status-locked { border-left-color: #757575; opacity: 0.7; cursor: not-allowed; }
        
        /* Tab Styling - Reworked for tactical feel */
        .tab-btn {
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
            font-weight: 500;
        }
        .active-tab {
            background-color: white;
            border-bottom-color: #D34716;
            color: #D34716;
            font-weight: bold;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
        }
        /* End of Style Refinements */

        /* --- MOBILE ADAPTATION --- */
        @media (max-width: 640px) {
            body {
                padding: 0;
                align-items: flex-start;
                background-image: none;
                background-color: #F7F7F7;
            }
            .tablet-frame {
                width: 100vw !important;
                height: 100vh !important;
                max-width: none !important;
                max-height: none !important;
                border-radius: 0 !important;
                border: none !important;
                padding: 0 !important;
                margin: 0 !important;
                box-shadow: none !important;
                background-image: none !important;
                aspect-ratio: auto !important;
            }
            .screen-container {
                border-radius: 0 !important;
                box-shadow: none !important;
            }
            main { padding: 0 !important; }
        }

        /* --- BLUEPRINT MODE (Dark Mode) --- */
        .blueprint-mode .screen-container { background-color: #0f172a; color: #94a3b8; }
        .blueprint-mode .mission-file { background-color: #1e293b; border-color: #334155; }
        .blueprint-mode h1, .blueprint-mode h2, .blueprint-mode h3, .blueprint-mode strong { color: #38bdf8 !important; }
        .blueprint-mode .text-slate-500, .blueprint-mode .text-slate-700 { color: #94a3b8 !important; }
        .blueprint-mode .section-header { border-bottom-color: #334155; }
        .blueprint-mode .bg-white { background-color: #1e293b; border-color: #334155; }
        .blueprint-mode .status-active { border-left-color: #D34716; background-color: #1e293b; }
        .blueprint-mode .tab-btn { background-color: #1e293b; color: #94a3b8; border-color: #334155; }
        .blueprint-mode .tab-btn.active-tab { background-color: #0f172a; color: #38bdf8; border-color: #38bdf8; }
        .blueprint-mode .mission-file:hover::after { opacity: 0.1; }

        /* --- FOCUS MODE (Simulated Fullscreen / Fill Iframe) --- */
        .focus-mode .tablet-frame {
            height: 100vh; 
            max-height: none; 
            width: 100vw;
            max-width: none;
            aspect-ratio: auto;
            margin: 0;
            padding: 0;
            border-radius: 0;
            box-shadow: none;
            border: none;
            background-image: none;
            background-color: #F7F7F7;
        }
        .focus-mode .screen-container {
            border-radius: 0;
            box-shadow: none;
        }

        /* --- SCROLLBARS (PDF STYLE) --- */
        .page::-webkit-scrollbar { width: 14px; }
        .page::-webkit-scrollbar-track { background: #e5e5e5; border-left: 1px solid #d1d5db; }
        .page::-webkit-scrollbar-thumb { background-color: #D34716; border-radius: 7px; border: 3px solid #e5e5e5; }
        .page::-webkit-scrollbar-thumb:hover { background-color: #EB8D69; }

        /* --- MODALS --- */
        .modal-transition { transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out; }
        .hidden-modal { opacity: 0; pointer-events: none; transform: translateY(-10px); }
        .visible-modal { opacity: 1; pointer-events: auto; transform: translateY(0); }

        /* --- LAYOUT --- */
        .navbar-content { flex: 0 0 60px; z-index: 20; background: #357889; border-bottom: 2px solid #2D6473; color: white; }
        .footer-content { flex: 0 0 50px; z-index: 20; background: white; border-top: 1px solid #e2e8f0; }
        .page { flex: 1 1 auto; overflow-y: auto; padding: 24px; position: relative; display: none; width: 100%; background-color: #F7F7F7; }
        .page.active { display: block; }
        
        .modal-content-base { background: white; } /* For status modal styling */
        
        /* Tooltip styling */
        .tooltip-container {
            position: relative;
            display: inline-block;
        }
        .tooltip-text {
            visibility: hidden;
            width: 250px;
            background-color: #4C4C4C;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 10;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.75rem;
        }
        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #4C4C4C transparent transparent transparent;
        }

    </style>
</head>
<body class="flex flex-col min-h-screen text-allgood-dark font-body">

    <main class="flex-grow flex items-center justify-center py-8">
        <div class="tablet-frame">
            <div class="screen-container" id="screen">

                <!-- 1. STARTUP SCREEN -->
                <div id="startup-screen" class="absolute inset-0 z-[300] flex flex-col items-center justify-center cursor-pointer transition-opacity duration-700 ease-in-out bg-slate-900">
                    <div class="group flex flex-col items-center justify-center text-center h-full w-full relative">
                        <div class="relative">
                            <div class="absolute inset-0 bg-allgood-primary/20 blur-3xl rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                            <h2 class="text-xl md:text-2xl font-heading text-slate-400 mb-2 uppercase">WELCOME TO THE</h2>
                            <h1 class="text-4xl md:text-6xl font-heading font-bold text-allgood-primary tracking-tighter relative z-10 drop-shadow-md static-neon-glow uppercase">ALLGOOD<span class="text-white">ACADEMY</span></h1>
                        </div>
                        <p id="startup-message" class="mt-8 text-slate-500 text-xs tracking-[0.3em] uppercase font-medium group-hover:text-white transition-colors animate-pulse font-body">CLICK TO POWER UP</p>
                    </div>
                </div>

                <!-- 2. LOGIN MODAL (RESTORED ORIGINAL LAYOUT) -->
                <div id="login-modal" class="absolute inset-0 z-[200] bg-allgood-dark/95 flex items-center justify-center p-6 hidden-modal modal-transition backdrop-blur-sm">
                    <div class="bg-white rounded-lg shadow-2xl p-8 max-w-sm w-full text-center border-t-4 border-allgood-primary">
                        <div class="mb-6"><h2 class="text-3xl font-heading font-bold text-allgood-dark uppercase">ALLGOOD<span class="text-allgood-primary">ACADEMY</span></h2></div>
                        <h2 class="text-xl font-bold text-allgood-dark mb-6 font-heading uppercase">Please Sign in to start</h2>

                        <div class="space-y-4 mb-6">
                            <!-- Name Input -->
                            <div class="relative">
                                <input type="text" id="user-name-input" placeholder="YOUR NAME (Optional)" class="w-full p-3 rounded border border-gray-300 focus:ring-allgood-primary focus:border-allgood-primary text-allgood-dark font-body text-lg">
                            </div>
                            
                            <!-- Email Input -->
                            <div class="relative">
                                <input type="email" id="user-email-input" placeholder="YOUR EMAIL (Optional)" class="w-full p-3 rounded border border-gray-300 focus:ring-allgood-primary focus:border-allgood-primary text-allgood-dark font-body text-lg">
                                
                                <!-- "Why?" Tooltip -->
                                <div class="tooltip-container absolute right-3 top-1/2 transform -translate-y-1/2 cursor-pointer p-1">
                                    <i data-lucide="help-circle" class="w-4 h-4 text-allgood-secondary"></i>
                                    <div class="tooltip-text">
                                        Providing your name helps us personalize your dashboard. Email is optional and allows for progress recovery.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 2.1 MAIN ACTION BUTTON (Guest/Anonymous) -->
                        <button id="btn-guest-login" onclick="window.handleGuestLogin()"
                                class="w-full bg-allgood-primary hover:bg-allgood-hover text-white font-bold py-3 rounded shadow-md transition-transform transform hover:scale-[1.01] active:scale-[0.99] font-body uppercase">
                            Enter Dashboard
                        </button>
                        
                        <!-- 2.2 SECONDARY ACTION (Google Icon) -->
                        <div class="mt-4 flex items-center justify-center space-x-2">
                             <div class="h-px w-10 bg-gray-200"></div>
                             <p class="text-xs text-gray-500 uppercase font-bold">OR</p>
                             <div class="h-px w-10 bg-gray-200"></div>
                        </div>

                        <button id="google-icon-container" onclick="window.handleGoogleLogin()" 
                                class="mt-4 p-2 rounded-full border border-gray-300 shadow-md hover:shadow-lg transition-all duration-200 hover:scale-105 active:scale-95 bg-white">
                            <!-- Google Icon SVG (Standard Look) -->
                            <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 11.02 21.84 10.05 21.53 9.15H12V14.85H19.53C19.16 16.59 18.23 18.15 17.07 19.34L17.06 19.36L20.24 22.54C21.73 20.8 22.75 18.52 22.95 16.03H12V14.85C12 14.85 12 14.85 12 14.85C12 14.85 12 14.85 12 14.85V14.85Z" fill="#EA4335"/>
                                <path d="M12 22C14.61 22 16.92 21.04 18.73 19.34L17.07 19.36C15.93 20.47 14.07 21.19 12 21.19C7.39 21.19 3.59 17.89 2.21 13.56L5.6 10.92C6.46 12.98 8.1 14.73 10 15.65V18.15H12V22Z" fill="#34A853"/>
                                <path d="M2.21 13.56L5.6 10.92C5.37 9.8 5.25 8.65 5.25 7.5C5.25 6.35 5.37 5.2 5.6 4.08L2.21 1.44C1.19 3.48 0.5 5.75 0.5 8.16C0.5 10.57 1.19 12.84 2.21 14.88V13.56Z" fill="#FBBC05"/>
                                <path d="M12 2.81C14.33 2.81 16.33 3.65 17.83 5.09L20.67 2.25C18.66 0.84 15.82 0 12 0C7.39 0 3.59 3.3 2.21 7.63L5.6 10.27C6.46 8.21 8.1 6.46 10 5.54V2.81H12Z" fill="#4285F4"/>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- 2.5 STATUS MESSAGE MODAL (Non-blocking replacement for alert()) -->
                <div id="status-modal" class="hidden-modal fixed top-4 right-4 z-[500] flex items-center justify-center p-4 modal-transition pointer-events-none">
                    <div class="bg-white rounded-lg shadow-xl p-4 max-w-xs w-full text-left border-l-4 border-blue-500 flex items-center space-x-3 modal-content-base">
                        <i id="status-icon" data-lucide="info" class="w-5 h-5 text-blue-500 flex-shrink-0"></i>
                        <p id="status-content" class="text-sm font-body text-blue-800"></p>
                    </div>
                </div>


                <!-- 3. TOP NAVBAR -->
                <header class="navbar-content flex items-center justify-between px-6 shadow-md relative z-30">
                    <div class="flex items-center overflow-hidden">
                        <div class="flex-shrink-0 text-white font-heading font-bold text-lg tracking-tight truncate mr-4 select-none uppercase">
                            ALLGOOD ACADEMY <span class="opacity-60 text-sm font-normal">| DASHBOARD</span>
                        </div>
                    </div>
                    <!-- Control Cluster -->
                    <div class="flex items-center space-x-1 shrink-0 relative">
                        <!-- Redesigned Controls for Premium Utility -->
                        <button id="btn-home" class="text-gray-200 hover:text-white transition-colors p-2 rounded-full hover:bg-white/10" title="Home (Hold to Reset)"><i data-lucide="home" class="w-5 h-5"></i></button>
                        <div class="h-6 w-px bg-white/20 mx-1"></div>
                        <button id="btn-blueprint" class="text-gray-200 hover:text-cyan-300 transition-colors p-2 rounded-full hover:bg-white/10" title="Blueprint Mode"><i data-lucide="sun" class="w-5 h-5"></i></button>
                        <button id="btn-fullscreen" class="text-gray-200 hover:text-green-300 transition-colors p-2 rounded-full hover:bg-white/10" title="Focus Mode">
                            <i id="fullscreen-icon" data-lucide="maximize" class="w-5 h-5"></i>
                        </button>
                        <button id="btn-menu" class="text-gray-200 hover:text-white transition-colors p-2 rounded-full hover:bg-white/10" title="Menu"><i data-lucide="menu" class="w-5 h-5"></i></button>
                    </div>
                </header>

                <!-- Sidebar Menu (Hidden by default) -->
                <div id="menu-modal" class="hidden-modal absolute inset-0 z-[100] bg-slate-900/50 flex justify-end modal-transition backdrop-blur-sm">
                    <div class="w-64 h-full bg-white shadow-2xl flex flex-col border-l border-slate-200">
                        <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                            <span class="font-bold text-slate-700 font-heading uppercase">System Menu</span>
                            <button id="close-menu" class="text-slate-400 hover:text-red-500 transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
                        </div>
                        <div class="p-3 space-y-1">
                            <button class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-100 text-slate-600 font-bold flex items-center transition-colors uppercase" onclick="showStatusMessage('Dashboard Active', 'info')">
                                <i data-lucide="layout-grid" class="w-4 h-4 mr-3 text-allgood-primary"></i>Dashboard
                            </button>
                            <button class="w-full text-left px-4 py-3 rounded-lg hover:bg-slate-100 text-slate-600 font-bold flex items-center transition-colors uppercase" onclick="showStatusMessage('Profile Module: Coming Soon', 'info')">
                                <i data-lucide="user" class="w-4 h-4 mr-3 text-allgood-secondary"></i>My Profile
                            </button>
                            <div class="border-t border-slate-100 my-2"></div>
                             <button class="w-full text-left px-4 py-3 rounded-lg hover:bg-red-50 text-red-600 font-bold flex items-center transition-colors uppercase" onclick="window.handleLogout()">
                                <i data-lucide="log-out" class="w-4 h-4 mr-3"></i>Log Out
                            </button>
                        </div>
                        <div class="mt-auto p-4 bg-slate-50 border-t border-slate-200 text-center">
                            <p class="text-xs text-slate-400 uppercase">Allgood Academy<br>Pragmatic Action</p>
                        </div>
                    </div>
                </div>

                <!-- 4. DASHBOARD CONTENT (TACTICAL OPS) -->
                <div class="page" id="page-dashboard">
                    
                    <!-- Status Bar -->
                    <div class="flex items-center justify-between bg-white p-4 rounded-lg shadow-md border border-slate-200 mb-6">
                        <div>
                            <h1 class="text-xl font-heading font-bold text-slate-700 uppercase">Welcome, <span class="user-name-display text-allgood-primary">Agent</span>.</h1>
                            <!-- NEW: Interactive Badge Row -->
                            <div class="flex items-center mt-2 space-x-3">
                                <div class="text-xs text-slate-500 font-bold uppercase tracking-wide mr-2" id="clearance-label">LEVEL 1: OBSERVER</div>
                                
                                <!-- Badge 1: Observer (Slate/Copper Look) -->
                                <div id="badge-1" class="w-8 h-8 bg-slate-200 rounded-full flex items-center justify-center text-slate-600 transition-all shadow-sm" onclick="showBadgeInfo(1)">
                                    <i data-lucide="eye" class="w-4 h-4"></i>
                                </div>
                                
                                <!-- Badge 2: Agent (Cyan/Silver Look) -->
                                <div id="badge-2" class="w-8 h-8 bg-allgood-secondary text-white rounded-full flex items-center justify-center transition-all opacity-30 grayscale shadow-badge-locked relative" onclick="showBadgeInfo(2)">
                                    <i data-lucide="id-card" class="w-4 h-4"></i>
                                    <i data-lucide="lock" class="w-3 h-3 absolute -top-1 -right-1 text-slate-400 bg-white rounded-full p-0.5 lock-icon"></i>
                                </div>
                                
                                <!-- Badge 3: Operator (Burnt Orange/Gold Look) -->
                                <div id="badge-3" class="w-8 h-8 bg-allgood-primary text-white rounded-full flex items-center justify-center transition-all opacity-30 grayscale shadow-badge-locked relative" onclick="showBadgeInfo(3)">
                                    <i data-lucide="medal" class="w-4 h-4"></i>
                                    <i data-lucide="lock" class="w-3 h-3 absolute -top-1 -right-1 text-slate-400 bg-white rounded-full p-0.5 lock-icon"></i>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-4 text-right">
                            <div>
                                <span class="block text-2xl font-bold text-allgood-secondary leading-none">13</span>
                                <span class="text-[10px] uppercase text-slate-400 font-bold">MODULES</span>
                            </div>
                            <div>
                                <span class="block text-2xl font-bold text-emerald-600 leading-none" id="stat-total-launches">0</span>
                                <span class="text-[10px] uppercase text-slate-400 font-bold">LAUNCHED</span>
                            </div>
                        </div>
                    </div>

                    <!-- TAB NAVIGATION -->
                    <div class="flex space-x-2 mb-6 border-b border-slate-200 px-2 overflow-x-auto">
                        <button id="tab-btn-goodblocks" onclick="switchTab('goodblocks')" class="tab-btn active-tab flex items-center px-4 py-3 rounded-t-lg text-sm uppercase">
                            <i data-lucide="box" class="w-4 h-4 mr-2"></i> GOODBLOCKS
                        </button>
                        <button id="tab-btn-games" onclick="switchTab('games')" class="tab-btn inactive-tab flex items-center px-4 py-3 rounded-t-lg text-sm uppercase">
                            <i data-lucide="gamepad-2" class="w-4 h-4 mr-2"></i> GAMES & SIMS
                        </button>
                        <button id="tab-btn-courses" onclick="switchTab('courses')" class="tab-btn inactive-tab flex items-center px-4 py-3 rounded-t-lg text-sm uppercase">
                            <i data-lucide="book-open" class="w-4 h-4 mr-2"></i> COURSES
                        </button>
                    </div>

                    <!-- TAB 1: GOODBLOCKS -->
                    <div id="tab-goodblocks" class="tab-content grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- 1. Countdown to Keys (Coming Soon) -->
                        <div class="mission-file status-locked p-5 flex items-start gap-4 group opacity-50">
                            <div class="w-16 h-16 bg-slate-50 rounded flex items-center justify-center border border-slate-100 flex-shrink-0">
                                <i data-lucide="key" class="w-8 h-8 text-slate-400"></i>
                            </div>
                            <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-slate-500 text-lg mb-1 uppercase">Countdown to Keys</h3>
                                    <span class="bg-slate-200 text-slate-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide">Coming Soon</span>
                                </div>
                                <p class="text-xs text-slate-500 mb-3 leading-relaxed"><strong>Action:</strong> Execute the 100-day protocol to secure your first home.</p>
                            </div>
                        </div>

                        <!-- 2. Mastering the Sincere Apology -->
                        <div onclick="window.launchCourse('Mastering the Apology', 'https://www.allgoodacademy.com/goodblocks/mastering-the-sincere-apology')" 
                             class="mission-file status-ready p-5 flex items-start gap-4 group">
                            <div class="w-16 h-16 bg-emerald-50 rounded flex items-center justify-center border border-emerald-100 flex-shrink-0 group-hover:bg-emerald-100 transition-colors">
                                <i data-lucide="heart-handshake" class="w-8 h-8 text-emerald-600"></i>
                            </div>
                            <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-slate-800 text-lg mb-1 uppercase">Mastering the Apology</h3>
                                    <span class="bg-emerald-100 text-emerald-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide">Ready</span>
                                </div>
                                <p class="text-xs text-slate-500 mb-3 leading-relaxed"><strong>Action:</strong> Deploy the 4-part structure to de-escalate conflict instantly.</p>
                            </div>
                        </div>

                        <!-- 3. Your Digital Identity -->
                        <div onclick="window.launchCourse('Your Digital Identity', 'https://www.allgoodacademy.com/goodblocks/your-digital-identity')" 
                             class="mission-file status-ready p-5 flex items-start gap-4 group">
                            <div class="w-16 h-16 bg-purple-50 rounded flex items-center justify-center border border-purple-100 flex-shrink-0 group-hover:bg-purple-100 transition-colors">
                                <i data-lucide="fingerprint" class="w-8 h-8 text-purple-600"></i>
                            </div>
                            <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-slate-800 text-lg mb-1 uppercase">Your Digital Identity</h3>
                                    <span class="bg-purple-100 text-purple-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide">Ready</span>
                                </div>
                                <p class="text-xs text-slate-500 mb-3 leading-relaxed"><strong>Action:</strong> Audit your online footprint and secure your personal perimeter.</p>
                            </div>
                        </div>

                        <!-- 4. Digital Asset Defense -->
                        <div onclick="window.launchCourse('Digital Asset Defense', 'https://www.allgoodacademy.com/goodblocks/digital-asset-defense')" 
                             class="mission-file status-ready p-5 flex items-start gap-4 group">
                            <div class="w-16 h-16 bg-blue-50 rounded flex items-center justify-center border border-blue-100 flex-shrink-0 group-hover:bg-blue-100 transition-colors">
                                <i data-lucide="shield-check" class="w-8 h-8 text-blue-600"></i>
                            </div>
                            <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-slate-800 text-lg mb-1 uppercase">Digital Asset Defense</h3>
                                    <span class="bg-blue-100 text-blue-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide">Ready</span>
                                </div>
                                <p class="text-xs text-slate-500 mb-3 leading-relaxed"><strong>Action:</strong> Secure wealth via wallet protocols and threat avoidance.</p>
                            </div>
                        </div>

                        <!-- 5. Airport Navigator -->
                        <div onclick="window.launchCourse('Airport Navigator', 'https://www.allgoodacademy.com/goodblocks/airport-navigator')" 
                             class="mission-file status-ready p-5 flex items-start gap-4 group">
                            <div class="w-16 h-16 bg-sky-50 rounded flex items-center justify-center border border-sky-100 flex-shrink-0 group-hover:bg-sky-100 transition-colors">
                                <i data-lucide="plane" class="w-8 h-8 text-sky-600"></i>
                            </div>
                            <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-slate-800 text-lg mb-1 uppercase">Airport Navigator</h3>
                                    <span class="bg-sky-100 text-sky-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide">Ready</span>
                                </div>
                                <p class="text-xs text-slate-500 mb-3 leading-relaxed"><strong>Action:</strong> Master the logistical flow from curb to gate with zero friction.</p>
                            </div>
                        </div>
                    </div>

                    <!-- TAB 2: GAMES & SIMS -->
                    <div id="tab-games" class="tab-content grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
                        <!-- 1. Jolene's Lemonade -->
                        <div onclick="window.launchCourse('Jolene\'s Lemonade', 'https://www.allgoodacademy.com/educational-games/jolenes-lemonade-challenge')" 
                             class="mission-file status-ready p-5 flex items-start gap-4 group">
                            <div class="w-16 h-16 bg-yellow-50 rounded flex items-center justify-center border border-yellow-100 flex-shrink-0 group-hover:bg-yellow-100 transition-colors">
                                <i data-lucide="store" class="w-8 h-8 text-yellow-600"></i>
                            </div>
                            <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-slate-800 text-lg mb-1 uppercase">Jolene's Lemonade</h3>
                                    <span class="bg-yellow-100 text-yellow-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide">Ready</span>
                                </div>
                                <p class="text-xs text-slate-500 mb-3 leading-relaxed"><strong>Action:</strong> Manage supply, demand, and profit margins in a live market.</p>
                            </div>
                        </div>

                        <!-- 2. Digital Decisions -->
                        <div onclick="window.launchCourse('Digital Decisions', 'https://www.allgoodacademy.com/educational-games/digital-decisions')" 
                             class="mission-file status-active p-5 flex items-start gap-4 group">
                            <div class="w-16 h-16 bg-indigo-50 rounded flex items-center justify-center border border-indigo-100 flex-shrink-0 group-hover:bg-indigo-100 transition-colors">
                                <i data-lucide="smartphone" class="w-8 h-8 text-indigo-600"></i>
                            </div>
                            <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-slate-800 text-lg mb-1 uppercase">Digital Decisions</h3>
                                    <span class="bg-indigo-100 text-indigo-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide">Active</span>
                                </div>
                                <p class="text-xs text-slate-500 mb-3 leading-relaxed"><strong>Action:</strong> Make high-stakes choices in simulated online conflict scenarios.</p>
                            </div>
                        </div>

                        <!-- 3. Conflict Resolution -->
                        <div onclick="window.launchCourse('Conflict Resolution', 'https://www.allgoodacademy.com/educational-games/conflict-resolution-challenge')" 
                             class="mission-file status-ready p-5 flex items-start gap-4 group">
                            <div class="w-16 h-16 bg-red-50 rounded flex items-center justify-center border border-red-100 flex-shrink-0 group-hover:bg-red-100 transition-colors">
                                <i data-lucide="swords" class="w-8 h-8 text-red-600"></i>
                            </div>
                            <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-slate-800 text-lg mb-1 uppercase">Conflict Resolution</h3>
                                    <span class="bg-red-100 text-red-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide">Ready</span>
                                </div>
                                <p class="text-xs text-slate-500 mb-3 leading-relaxed"><strong>Action:</strong> Identify triggers and neutralize tension in high-stress interactions.</p>
                            </div>
                        </div>

                        <!-- 4. Purposeful Communicator -->
                        <div onclick="window.launchCourse('Purposeful Communicator', 'https://www.allgoodacademy.com/educational-games/purposeful-communicator-challenge')" 
                             class="mission-file status-ready p-5 flex items-start gap-4 group">
                            <div class="w-16 h-16 bg-teal-50 rounded flex items-center justify-center border border-teal-100 flex-shrink-0 group-hover:bg-teal-100 transition-colors">
                                <i data-lucide="message-circle" class="w-8 h-8 text-teal-600"></i>
                            </div>
                            <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-slate-800 text-lg mb-1 uppercase">Purposeful Communicator</h3>
                                    <span class="bg-teal-100 text-teal-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide">Ready</span>
                                </div>
                                <p class="text-xs text-slate-500 mb-3 leading-relaxed"><strong>Action:</strong> Select precise language to drive outcomes and build consensus.</p>
                            </div>
                        </div>

                        <!-- 5. Master Your Story -->
                        <div onclick="window.launchCourse('Master Your Story', 'https://www.allgoodacademy.com/educational-games/master-your-story-challenge')" 
                             class="mission-file status-ready p-5 flex items-start gap-4 group">
                            <div class="w-16 h-16 bg-rose-50 rounded flex items-center justify-center border border-rose-100 flex-shrink-0 group-hover:bg-rose-100 transition-colors">
                                <i data-lucide="book-open" class="w-8 h-8 text-rose-600"></i>
                            </div>
                            <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-slate-800 text-lg mb-1 uppercase">Master Your Story</h3>
                                    <span class="bg-rose-100 text-rose-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide">Ready</span>
                                </div>
                                <p class="text-xs text-slate-500 mb-3 leading-relaxed"><strong>Action:</strong> Craft and deliver a compelling personal narrative for business and life.</p>
                            </div>
                        </div>
                    </div>

                    <!-- TAB 3: COURSES -->
                    <div id="tab-courses" class="tab-content grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
                        <!-- 1. Pragmatic Learning -->
                        <div onclick="window.launchCourse('Pragmatic Learning', 'https://www.allgoodacademy.com/courses/pragmatic-learning-turning-knowledge-into-action')" 
                             class="mission-file status-ready p-5 flex items-start gap-4 group">
                            <div class="w-16 h-16 bg-amber-50 rounded flex items-center justify-center border border-amber-100 flex-shrink-0 group-hover:bg-amber-100 transition-colors">
                                <i data-lucide="brain-circuit" class="w-8 h-8 text-amber-600"></i>
                            </div>
                            <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-slate-800 text-lg mb-1 uppercase">Pragmatic Learning</h3>
                                    <span class="bg-amber-100 text-amber-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide">Ready</span>
                                </div>
                                <p class="text-xs text-slate-500 mb-3 leading-relaxed"><strong>Action:</strong> Turn passive input into active output. The core philosophy of Allgood Academy.</p>
                            </div>
                        </div>

                        <!-- 2. The Unwritten Rules -->
                        <div onclick="window.launchCourse('The Unwritten Rules', 'https://www.allgoodacademy.com/courses/the-unwritten-rules-navigating-social-emotional-learning')" 
                             class="mission-file status-ready p-5 flex items-start gap-4 group">
                            <div class="w-16 h-16 bg-slate-100 rounded flex items-center justify-center border border-slate-200 flex-shrink-0 group-hover:bg-slate-200 transition-colors">
                                <i data-lucide="scale" class="w-8 h-8 text-slate-600"></i>
                            </div>
                            <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-slate-800 text-lg mb-1 uppercase">The Unwritten Rules</h3>
                                    <span class="bg-slate-200 text-slate-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide">Ready</span>
                                </div>
                                <p class="text-xs text-slate-500 mb-3 leading-relaxed"><strong>Action:</strong> Decode the hidden social contracts that govern professional environments.</p>
                            </div>
                        </div>

                        <!-- 3. The AI Co-Pilot -->
                        <div onclick="window.launchCourse('The AI Co-Pilot', 'https://www.allgoodacademy.com/courses/the-ai-co-pilot-a-15-minute-microlearning-course')" 
                             class="mission-file status-ready p-5 flex items-start gap-4 group">
                            <div class="w-16 h-16 bg-cyan-50 rounded flex items-center justify-center border border-cyan-100 flex-shrink-0 group-hover:bg-cyan-100 transition-colors">
                                <i data-lucide="bot" class="w-8 h-8 text-cyan-600"></i>
                            </div>
                            <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-slate-800 text-lg mb-1 uppercase">The AI Co-Pilot</h3>
                                    <span class="bg-cyan-100 text-cyan-700 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide">Ready</span>
                                </div>
                                <p class="text-xs text-slate-500 mb-3 leading-relaxed"><strong>Action:</strong> Integrate AI into your workflow in 15 minutes.</p>
                            </div>
                        </div>
                    </div>

                    <!-- FOOTER OS SIGNATURE (Inside Scroll) -->
                    <div class="mt-12 mb-6 text-center">
                        <p class="text-[10px] text-slate-400 font-mono tracking-widest uppercase opacity-60">
                            ALLGOOD OS <span class="mx-2"></span> GOODBLOCK
                        </p>
                    </div>

                <!-- BADGE DETAIL MODAL -->
                <div id="badge-modal" class="hidden-modal absolute inset-0 z-[250] bg-allgood-dark/90 flex items-center justify-center p-6 modal-transition backdrop-blur-sm" onclick="closeBadgeModal()">
                    <div class="bg-white rounded-lg shadow-2xl p-6 max-w-sm w-full text-center border-t-4 border-allgood-primary relative" onclick="event.stopPropagation()">
                        <button onclick="closeBadgeModal()" class="absolute top-2 right-2 text-gray-400 hover:text-red-500"><i data-lucide="x" class="w-5 h-5"></i></button>
                        
                        <div class="mb-4">
                            <h3 id="badge-title" class="text-2xl font-heading font-bold text-allgood-dark uppercase">Level Name</h3>
                            <p id="badge-status" class="text-xs font-bold uppercase tracking-widest mt-1">STATUS</p>
                        </div>
                        
                        <p id="badge-desc" class="text-gray-600 text-sm mb-4 leading-relaxed">Description goes here.</p>
                        
                        <div class="bg-slate-50 p-3 rounded border border-slate-200 text-xs text-slate-500 font-bold">
                            <span id="badge-req">Requirement: ...</span>
                        </div>
                        
                        <button onclick="closeBadgeModal()" class="mt-6 w-full bg-allgood-secondary hover:bg-allgood-accent text-white font-bold py-2 rounded text-sm shadow-md transition-colors uppercase">
                            Continue Mission
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <script>
        // --- AUDIO ENGINE ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx;

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new AudioContext();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume().catch(e => console.error("Audio resume failed:", e));
            }
        }

        // Updated Helper with Envelope Control (Attack/Decay)
        function playTone(freq, type, duration, vol = 0.1, attack = 0.01, decay = 0.001) {
            initAudio();
            const now = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();

            osc.type = type;
            osc.frequency.setValueAtTime(freq, now);
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(vol, now + attack);
            gain.gain.exponentialRampToValueAtTime(decay, now + duration);

            osc.start(now);
            osc.stop(now + duration);
        }

        const sfx = {
            // RESTORED: Simple sine tone for button clicks/ticks
            tick: () => {
                initAudio();
                playTone(1000, 'sine', 0.01, 0.01);
            },
            click: () => {
                initAudio();
                playTone(1000, 'sine', 0.01, 0.01);
            },
            // Metallic ping for confirmation (Cadillac)
            confirm: () => {
                initAudio();
                playTone(150, 'sine', 0.1, 0.1, 0.01, 0.01);
            },
            // RESTORED: Original power up sweep (clean sine)
            powerOn: () => {
                initAudio();
                const now = audioCtx.currentTime;
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.type = 'sine'; // RESTORED TO SINE
                osc.frequency.setValueAtTime(110, now);
                osc.frequency.exponentialRampToValueAtTime(220, now + 0.4);
                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(0.4, now + 0.1);
                gain.gain.linearRampToValueAtTime(0, now + 0.4);
                osc.start(now); osc.stop(now + 0.4);
            },
            // RESTORED: Original power off fade (triangle)
            powerOff: () => {
                initAudio();
                playTone(80, 'triangle', 0.2, 0.5, 0.01, 0.001);
            },
            nav: () => {
                initAudio();
                playTone(200, 'sine', 0.08, 0.1, 0.01, 0.01);
            },
        };

        // --- TAB LOGIC ---
        window.switchTab = (tabName) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            
            const target = document.getElementById('tab-' + tabName);
            if(target) target.classList.remove('hidden');
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active-tab');
                btn.classList.add('inactive-tab');
            });
            
            const activeBtn = document.getElementById('tab-btn-' + tabName);
            if(activeBtn) {
                activeBtn.classList.remove('inactive-tab');
                activeBtn.classList.add('active-tab');
            }
            
            sfx.nav(); 
        };

        // --- FULLSCREEN / FOCUS MODE LOGIC ---

        // FIX: Added window.onload listener for automatic state restoration (Requirement 4)
        window.onload = () => {
            // Restore state automatically after all DOM elements and scripts are loaded
            // This is crucial for handling browser reloads that maintain session cookies.
            window.restoreSessionState(); // Use global call
            window.initDashboard(); // Also run the Firebase check (Requirement 3)
        };

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();

            // 1. Startup Logic
            const startupScreen = document.getElementById('startup-screen');
            const loginModal = document.getElementById('login-modal');
            const dashboard = document.getElementById('page-dashboard');
            const fullscreenBtn = document.getElementById('btn-fullscreen');

            // --- UI Setup on DOM Load ---
            if (startupScreen) {
                // Ensure startup screen is the default initial state
                startupScreen.style.display = 'flex';
                startupScreen.style.opacity = '1';
            }
            if (dashboard) dashboard.style.display = 'none';

            // Update startup message if session data exists
            const storedName = localStorage.getItem('aa_username');
            if (storedName) {
                document.getElementById('startup-message').textContent = `Ready for Operation, ${storedName}.`;
            }

            
            // Warm up audio context on interaction
            if (startupScreen) {
                const warmUp = () => initAudio();
                startupScreen.addEventListener('mousedown', warmUp, { once: true });
                startupScreen.addEventListener('touchstart', warmUp, { once: true });
                
                startupScreen.addEventListener('click', () => {
                    sfx.click(); 
                    startupScreen.style.opacity = '0';
                    
                    // --- Power Up Logic (Requirement 3) ---
                    const storedUID = localStorage.getItem('aa_uid');
                    
                    if (storedName && storedUID) {
                        // User has local data saved: Restore state immediately
                        window.restoreSessionState();
                        sfx.powerOn(); 
                        window.initDashboard(); // Re-check Auth state and listen (Requirement 4)
                    } else if (loginModal) {
                        // No local data, must show login modal.
                        loginModal.classList.remove('hidden-modal');
                        loginModal.classList.add('visible-modal');
                    }
                    
                    setTimeout(() => { 
                        startupScreen.style.display = 'none';
                    }, 700);
                });
            }

            // 2. Login Logic - Event Listeners
            // The functions are defined in the module script block above and use the onclick attribute in HTML.
            
            // 3. Navbar Control Cluster Logic
            const homeBtn = document.getElementById('btn-home');
            let homePressTimer;
            let homeIsHold = false;

            const startHomePress = (e) => {
                e.preventDefault(); 
                homeIsHold = false;
                homePressTimer = setTimeout(() => {
                    homeIsHold = true;
                    if(window.handleLogout) {
                        sfx.powerOff(); 
                        window.handleLogout();
                    }
                }, 2000);
            };

            const endHomePress = (e) => {
                clearTimeout(homePressTimer);
                if(!homeIsHold) {
                    sfx.tick(); 
                    document.getElementById('page-dashboard').scrollTop = 0;
                }
            };

            homeBtn.addEventListener('mousedown', startHomePress);
            homeBtn.addEventListener('touchstart', startHomePress);
            homeBtn.addEventListener('mouseup', endHomePress);
            homeBtn.addEventListener('touchend', endHomePress);
            homeBtn.addEventListener('mouseleave', () => clearTimeout(homePressTimer));

            document.getElementById('btn-blueprint').addEventListener('click', () => {
                document.body.classList.toggle('blueprint-mode');
                sfx.tick();
            });

            // --- NEW FOCUS MODE TOGGLE (CSS-based) ---
            if(fullscreenBtn) {
                fullscreenBtn.addEventListener('click', () => {
                    const body = document.body;
                    const icon = document.getElementById('fullscreen-icon');
                    
                    if (body.classList.contains('focus-mode')) {
                        // Exit Focus Mode
                        body.classList.remove('focus-mode');
                        icon.setAttribute('data-lucide', 'maximize');
                    } else {
                        // Enter Focus Mode
                        body.classList.add('focus-mode');
                        icon.setAttribute('data-lucide', 'minimize');
                    }
                    lucide.createIcons();
                    sfx.tick();
                });
            }

            const menuModal = document.getElementById('menu-modal');
            document.getElementById('btn-menu').addEventListener('click', () => {
                menuModal.classList.remove('hidden-modal');
                menuModal.classList.add('visible-modal');
                sfx.tick();
            });

            document.getElementById('close-menu').addEventListener('click', () => {
                menuModal.classList.add('hidden-modal');
                menuModal.classList.remove('visible-modal');
                sfx.tick();
            });
        });

        // --- AUTH STATE PERSISTENCE (Requirement 2 & 3) ---
        window.initDashboard = function() { // Globally accessible function
            onAuthStateChanged(auth, async (user) => {
                const dashboard = document.getElementById('page-dashboard');
                
                if (user) {
                    // User is signed in (either persistent or anonymous via cookie)
                    
                    // 1. Check if the dashboard is already active (i.e., restored via localStorage check)
                    if (dashboard.style.display === 'block') {
                        // State already active (from localStorage check), just ensure listeners are running
                        window.startLaunchListener(user.uid);
                        return;
                    }

                    // 2. State is not active, but user is logged into Firebase. 
                    // This happens on refresh if no localStorage data exists, or for new persistent users.
                    
                    const userRef = doc(db, 'artifacts', appId, 'users', user.uid);
                    const docSnap = await getDoc(userRef);

                    let displayName = user.displayName || 'Agent';
                    let isGuest = true; // Default assumption for safety

                    if (docSnap.exists()) {
                        const userData = docSnap.data();
                        displayName = userData.displayName || user.displayName || 'Agent';
                        isGuest = userData.isGuest || false;
                    }

                    // 3. Apply state and store locally
                    localStorage.setItem('aa_username', displayName);
                    localStorage.setItem('aa_uid', user.uid);
                    localStorage.setItem('aa_is_guest', isGuest);

                    // 4. Update UI and start listeners
                    window.updateUI(displayName);
                    dashboard.classList.add('active');
                    dashboard.style.display = 'block'; 
                    window.startLaunchListener(user.uid);

                } else {
                    // User is signed out (expected state before login)
                    // If dashboard is visible (which shouldn't happen), hide it.
                    if (dashboard.style.display === 'block') {
                         window.handleLogout(); // Force logout/reset state
                    }
                }
            });
        }
    </script>
</body>
</html>
